
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>ZPark-Ztream: Driving Spark distributed stream with Scalaz-Stream - Mandubian Blog</title>
  <meta name="author" content="Pascal Voitot">

  
  <meta name="description" content="ZPark-Ztream: Driving Spark Distributed Stream With Scalaz-Stream
    
    
      
        








  


Feb 13th, 2014 &hellip;">
  <meta name="keywords" content="scala,play framework,spark,scalaz-stream,stream,map/reduce,realtime,discretization,continue">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.mandubian.com/2014/02/13/zpark">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/d3d.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }

    article {
      margin-bottom: 50px;
      border-top: #DDD solid 20px;
    }
 
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mandubian Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10417377-11']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Mandubian Blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:www.mandubian.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      
<article class="hentry span9" role="article">

  
  <header class="page-header">
    
      <h1 class="entry-title">ZPark-Ztream: Driving Spark Distributed Stream With Scalaz-Stream</h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-13T18:18:00+01:00" pubdate data-updated="true">Feb 13<span>th</span>, 2014</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p>Today I&#8217;m going to write about a Proof of Concept I&#8217;ve been working on those last weeks: I wanted to <strong>use scalaz-stream as a driver of Spark distributed data processing</strong>.
This is simply an idea and I don&#8217;t even know whether it is viable or stupid. But the idea is interesting!</p></blockquote>

<h2>Introduction</h2>

<p>2 of my preferred topics those last months are :</p>

<ul>
<li>Realtime streaming</li>
<li>Realtime clustered data processing (in-memory &amp; fault-tolerant)</li>
</ul>


<p>2 tools have kept running through my head those last months:</p>

<ul>
<li><p><a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> for realtime/continuous streaming using pure functional concepts: I find it very interesting conceptually speaking &amp; very powerful, specially the deterministic &amp; non-deterministic demuxtiplexers provided out-of-the-box (Tee &amp; Wye).</p></li>
<li><p><a href="https://spark.incubator.apache.org/">Spark</a> for fast/fault-tolerant in-memory, resilient &amp; clustered data processing.</p></li>
</ul>


<p>I won&#8217;t speak much about Scalaz-Stream because I wrote a few articles about it.</p>

<br/>


<h4>Let&#8217;s focus on Spark.</h4>

<p>Spark provides tooling for cluster processing of huge datasets in the same <em>batch mode</em> way as Hadoop, the very well known <em>map/reduce</em> infrastructure. But at the difference of Hadoop which is exclusively relying on HDFS cluster file systems when distributing data through the cluster, Spark tries to cache data in memory as much as possible so that latency of access is reduced as much as possible. Hadoop can scale a lot but is known to be slow in the context of a single node.</p>

<p>Spark is aimed at scaling as much as Hadoop but running faster on each node using in-memory caching. Fault-tolerance &amp; data resilience is managed by Spark too using persistence &amp; redundancy based on any nice storage like HDFS or files or whatever you can plug on Spark. So Spark is meant to be a super fast in-memory, fault-tolerant batch processing engine.</p>

<br/>


<h4>RDD Resilient Distributed Dataset</h4>

<p>The basic concept of Spark is <em>Resilient Distributed Dataset</em> aka <code>RDD</code> which is a read-only, <strong>immutable</strong> data structure representing a collection of objects or dataset that can be distributed across a set of nodes in a cluster to perform map/reduce style algorithms.</p>

<p>The dataset represented by this <code>RDD</code> is partitioned i.e. cut into slices called <em>partitions</em> that can be distributed across the cluster of nodes.</p>

<p><code>Resilient</code> means these data can be rebuilt in case of fault on a node or data loss. To perform this, the dataset is replicated/persisted across nodes in memory or in distributed file system such as HDFS.</p>

<p>So the idea of RDD is to provide a seamless structure to manage clustered datasets with very simple API in &#8220;monadic&#8221;-style :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">sc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkContext</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;local[4]&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Simple App&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;YOUR_SPARK_HOME&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="nc">List</span><span class="o">(</span><span class="s">&quot;target/scala-2.10/simple-project_2.10-1.0.jar&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">logData</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="n">logFile</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="n">cache</span><span class="o">().</span><span class="n">filter</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)).</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span> <span class="o">+</span> <span class="s">&quot;foo&quot;</span> <span class="o">).</span><span class="n">count</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Depending on your <code>SparkContext</code> configuration, Spark takes in charge of distributing behind the curtain your data to the cluster nodes to perform the required processing in a fully distributed way.</p>

<blockquote><p>One thing to keep in mind is that Spark distributes data to remote nodes but it also distributes the code/closures remotely. So it means your code has to be serializable which is not the case of scalaz-stream in its current implementation.</p></blockquote>

<br/>


<h4>Just a word on Spark code</h4>

<p>As usual, before using Spark in any big project, I&#8217;ve been diving in its code to know whether I can trust this project. I must say I know Spark&#8217;s code better than its API ;)</p>

<p>I find Spark Scala implementation quite clean with explicit choices of design made clearly in the purpose of performance. The need to provide a compatible Java/Python API and to distribute code across clustered nodes involves a few restrictions in terms of implementation choices. Anyway, I won&#8217;t criticize much because I wouldn&#8217;t have written it better and those people clearly know what they do!</p>

<br/>


<h2>Spark Streaming</h2>

<p>So Spark is very good to perform fast clustered batch data processing. Yet, what if your dataset is built progressively, continuously, in realtime?</p>

<p>On top of the core module, Spark provides an extension called <a href="https://spark.incubator.apache.org/docs/latest/streaming-programming-guide.html">Spark Streaming</a> aiming at manipulating live streams of data using the power of Spark.</p>

<p>Spark Streaming can ingest different continuous data feeds like Kafka, Flume, Twitter, ZeroMQ or TCP socket and perform high-level operations on it such as map/reduce/groupby/window/&#8230;</p>

<br/>


<h3>DStream</h3>

<p>The core data structure behind Spark Streams is <code>DStream</code> for <strong>Discretized Stream</strong> (and not <em>distributed</em>).</p>

<p><code>Discretized</code> means it gets a continuous stream of data and makes it discrete by slicing it across time and wrapping those sliced data into the famous <code>RDD</code> described above.</p>

<p>A <code>DStream</code> is just a temporal data partitioner that can distribute data slices across the cluster of nodes to perform some data processing using Spark capabilities.</p>

<p>Here is the illustration in official Spark Stream documentation:</p>

<p><img src="https://spark.incubator.apache.org/docs/latest/img/streaming-dstream.png" alt="streaming-dstream" /></p>

<p><code>DStream</code> also tries to leverage Spark automated persistence/caching/fault-tolerance to the domain of live streaming.</p>

<p><code>DStream</code> is cool but it&#8217;s completely based on temporal aspects. Imagine you want to slice the stream depending on other criteria, with <code>DStream</code>, it would be quite hard because the whole API is based on time. Moreover, using DStream, you can discretize a dataflow but you can&#8217;t go in the other way and make it continuous again (in my knowledge). This is something that would be cool, isn&#8217;t it?</p>

<p>If you want to know more about DStream discretization mechanism, have a look at the official <a href="https://spark.incubator.apache.org/docs/latest/streaming-programming-guide.html">doc</a>.</p>

<br/>


<blockquote><p>As usual, I&#8217;m trying to investigate the edge-cases of concepts I like. In general, this is where I can test the core design of the project and determine whether it&#8217;s worth investigating in my every-day life.</p></blockquote>

<br/>


<h2>Driving Spark Streams with Scalaz-Stream</h2>

<p>I&#8217;ve been thinking about scalaz-stream concepts quite a lot and scalaz-stream is very good at manipulating continuous streams of data. Moreover, it can very easily partition a continuous stream regrouping data into chunks based on any criteria you can imagine.</p>

<p>Scalaz-stream represents a data processing algorithm as a static state machine that you can run when you want. This is the same idea behind map/reduce Spark API: you build your chain of map/filter/window and finally reduce it. <em>Reducing a spark data processing is like running a scalaz-stream machine.</em></p>

<blockquote><p>So my idea was the following:</p>

<ul>
<li>build a continuous stream of data based on scalaz-stream <code>Process[F, O]</code></li>
<li>discretize the stream <code>Process[F, O] =&gt; Process[F, RDD[O]]</code></li>
<li>implement count/reduce/reduceBy/groupBy for <code>Process[F, RDD[O]]</code></li>
<li>provide a <code>continuize</code> method to do <code>Process[F, RDD[O]] =&gt; Process[F, O]</code></li>
</ul>
</blockquote>

<p>So I&#8217;ve been hacking between Scalaz-stream <code>Process[F, O]</code> &amp; Spark <code>RDD[O]</code> and here is the resulting API that I&#8217;ve called <code>ZPark-ZStream</code> (ZzzzzzPark-Zzzzztream).</p>

<p>Let&#8217;s play a bit with my little alpha API.</p>

<br/>


<h3>Discretization by simple slicing</h3>

<p>Let&#8217;s start with a very simple example.</p>

<p>Take a simple finite process containing integers:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="mi">6L</span><span class="o">,</span> <span class="mi">6L</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I want to slice this stream of integer by slices of 4 elements.</p>

<p>First we have to create the classic Spark Streaming context and make it implicit (needed by my API).</p>

<p><em>Please remark that I could plug existing StreamingContext on my code without any problem.</em></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">clusterUrl</span> <span class="k">=</span> <span class="s">&quot;local[4]&quot;</span>
</span><span class='line'><span class="k">implicit</span> <span class="n">ssc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingContext</span><span class="o">(</span><span class="n">clusterUrl</span><span class="o">,</span> <span class="s">&quot;SparkSerial&quot;</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then let&#8217;s parallelize the previous process :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">prdd</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="k">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'><span class="c1">// type is just there to show what scalac will infer</span>
</span><span class='line'><span class="c1">// Just to remind that Task is the Future equivalent in Scalaz</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok folks, now, we have a discretized stream of <code>Long</code> that can be distributed across a Spark cluster.</p>

<p><code>DStream</code> provides <code>count</code> API which count elements on each <code>RDD</code> in the stream.</p>

<p>Let&#8217;s do the same with my API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">pcount</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">prdd</span><span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>What happens here? The `count operation on each RDD in the stream is distributed across the cluster in a map/reduce-style and results are gathered.</p>

<p>Ok that&#8217;s cool but you still have a discretized stream <code>Process[Task, RDD[Int]]</code> and that&#8217;s not practical to use to see what&#8217;s inside it. So now we are going to <code>re-continuize</code> it and make it a <code>Process[Task, Int]</code> again.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">pfinal</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">pcount</span><span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Easy isn&#8217;t it?</p>

<p>All together :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217; print the result in the console</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">stdOutLines</span><span class="o">[</span><span class="kt">I</span><span class="o">]</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">.</span><span class="n">constant</span><span class="o">{</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">I</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Task</span><span class="o">.</span><span class="n">delay</span> <span class="o">{</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot; ----&gt; [${System.nanoTime}] *** $s&quot;</span><span class="o">)</span> <span class="o">}}</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'><span class="c1">// 1 run for the process &amp; 1 run for the Task</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418478569989000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">4</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418478593226000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Oh yes that works: in each slice of 4 elements, we actually have 4 elements! Reassuring ;)</p></blockquote>

<p>Let&#8217;s do the same with <code>countByValue</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDDByValue</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'><span class="c1">// 1 run for the process &amp; 1 run for the Task</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552751011000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552751176000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552770527000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552770640000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see that 4 comes before 3. This is due to the fact the 2nd slice of 4 elements (3,3,4,4) is converted into a RDD which is then partitioned and distributed across the cluster to perform the map/reduce count operation. So the order of return might be different at the end.</p>

<p>An example of map/reduce ?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">mapRDD</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">reduceRDD</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418619885745000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">10</span> <span class="o">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418619905817000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">18</span> <span class="o">(</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="mi">5</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that:</p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">p</span> <span class="n">mapRDD</span> <span class="n">f</span> <span class="o">===</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">rdd</span> <span class="k">=&gt;</span> <span class="n">rdd</span> <span class="n">map</span> <span class="n">f</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Discretization by time slicing</h3>

<p>Now we could try to slice according to time in the same idea as <code>DStream</code></p>

<p>First of all, let&#8217;s define a continuous stream of positive integers:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">naturals</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">go</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">i</span><span class="o">)){</span> <span class="n">i</span> <span class="k">=&gt;</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">++</span> <span class="n">go</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">go</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, I want integers to be emitted at a given tick for example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="n">duration</span><span class="k">:</span> <span class="kt">Duration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">naturals</span> <span class="n">zipWith</span> <span class="nc">Process</span><span class="o">.</span><span class="n">awakeEvery</span><span class="o">(</span><span class="n">duration</span><span class="o">)){</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">i</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, let&#8217;s discretize the continuous stream with <strong>ZPark-Ztream</strong> API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The stream is sliced in slice of 500ms and all elements emitted during these 500ms are gathered in a Spark <code>RDD</code>.</p>

<p>On this stream of <code>RDD, we can apply</code>countRDD` as before and finally re-continuize it. All together we obtain:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5000</span><span class="o">)</span>  <span class="c1">// takes only 5000 because an infinite stream is hard to log in an article</span>
</span><span class='line'>  <span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395213389954000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">47</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395213705505000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">28</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395214191637000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">47</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395214688724000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">48</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395215189453000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">45</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395215697655000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">48</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395240677357000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395241175632000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395241674446000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395242175416000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395242675183000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395243177056000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395243676848000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395244175938000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395244676315000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395245175042000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395245677394000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Approximatively we have 50 elements per slice which looks like what we expected.</p>

<p><em>Please note that there is a short period of warmup where values are less homogenous.</em></p>

<br/>


<h3>Discretization by time slicing keeping track of time</h3>

<p><code>DStream</code> keeps track of all created RDD slices of data (following Spark philosophy to cache as much as possible) and allows to do operation of windowing to redistribute RDD.</p>

<p>With ZPark API, you can write the same as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">500</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">discretizeKeepTime</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">windowRDD</span><span class="o">(</span><span class="mi">1000</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="n">rdd</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="n">rdd</span><span class="o">.</span><span class="n">count</span><span class="o">())</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397573066484000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397571981061000</span><span class="o">,</span><span class="mi">68</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397574069315000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397572981063000</span><span class="o">,</span><span class="mi">85</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397575058895000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397573981072000</span><span class="o">,</span><span class="mi">87</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397576059640000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397574981078000</span><span class="o">,</span><span class="mi">89</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397577069518000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397575981086000</span><span class="o">,</span><span class="mi">89</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397577538941000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397576981095000</span><span class="o">,</span><span class="mi">82</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>We can see here that final interval haven&#8217;t 100 elements as we could expect.
This is still a mystery to me and I must investigate a bit more to know where this differences comes from. I have a few ideas but need to validate.</p>

<p>Anyway, globally we get 500 elements meaning we haven&#8217;t lost anything.</p></blockquote>

<br/>


<h3>Mixing scalaz-stream IO &amp; Spark streaming</h3>

<p>Playing with naturals is funny but let&#8217;s work with a real source of data like a file.</p>

<p>It could be anything pluggable on scalaz-stream like kafka/flume/whatever as <code>DStream</code> provides&#8230;</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">io</span><span class="o">.</span><span class="n">linesR</span><span class="o">(</span><span class="s">&quot;testdata/fahrenheit.txt&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">trim</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">&quot;//&quot;</span><span class="o">))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">toDouble</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">mapRDD</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="mi">1L</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">groupByKey</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="n">mapRDD</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529009755000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">18.0</span><span class="o">,</span><span class="mi">23</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010064000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">19.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010301000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">78.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010501000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">55.3</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010700000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">66.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010892000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">64.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Infusing tee with RDD Processes</h3>

<p>Is it possible to combine RDD Processes using scalaz-stream ?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p0</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">50</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">p1</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">50</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'> <span class="o">(</span><span class="n">p0</span> <span class="n">zipWith</span> <span class="n">p1</span><span class="o">){</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>   <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="nc">UnionRDD</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">))</span>
</span><span class='line'> <span class="o">}.</span><span class="n">countRDDByValue</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464151650000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464151819000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464230343000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464230528000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464477775000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464477921000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">5</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464478034000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">6</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464478143000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464726860000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">8</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464727039000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">7</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975370000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">9</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975511000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975620000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">11</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412465224087000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">12</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412465224227000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">13</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="n">etc</span><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that I drive Spark RDD stream with Scalaz-Stream always remains on the driver node and is never sent to a remote node as map/reduce closures are in Spark. So Scalaz-stream is used a stream driver in this case. Moreover, Scalaz Process isn&#8217;t serializable in its current implementation so it wouldn&#8217;t be possible as is.</p></blockquote>

<br/>


<br/>


<h2>What about persistence &amp; fault tolerance?</h2>

<p>After discretizing a process, you can persist each RDD :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">p</span><span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">mapRDD</span> <span class="o">{</span><span class="err"> </span><span class="k">_</span><span class="o">.</span><span class="n">persist</span><span class="o">()</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok but <code>DStream</code> does much more trying to keep in-memory every RDD that is generated and potentially persist it across the cluster. This makes things stateful &amp; mutable which is not the approach of pure functional API like scalaz-stream. So, I need to think a bit more about this persistence topic which is huge.</p>

<p>Anyway I believe I&#8217;m currently investigating another way of manipulating distributed streams than <code>DStream</code>.</p>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Spark is quite amazing and easy to use with respect to the complexity of the subject.</p>

<p>I was also surprised to be able to use it with scalaz-stream so easily.</p>

<p>I hope you liked the idea and I encourage you to think about it and if you find it cool, please tell it! And if you find it stupid, please tell it too: this is still a pure experiment ;)</p>

<p>Have a look at the code on <a href="https://github.com/mandubian/zpark-ztream">Github</a>.</p>

<p>Have distributed &amp; resilient yet continuous fun!</p>

<br/>


<br/>


<br/>


<br/>



</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Pascal Voitot</span></span>

      








  


<time datetime="2014-02-13T18:18:00+01:00" pubdate data-updated="true">Feb 13<span>th</span>, 2014</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/continue/'>continue</a>, <a class='category' href='/blog/categories/discretization/'>discretization</a>, <a class='category' href='/blog/categories/map-reduce/'>map/reduce</a>, <a class='category' href='/blog/categories/play-framework/'>play framework</a>, <a class='category' href='/blog/categories/realtime/'>realtime</a>, <a class='category' href='/blog/categories/scala/'>scala</a>, <a class='category' href='/blog/categories/scalaz-stream/'>scalaz-stream</a>, <a class='category' href='/blog/categories/spark/'>spark</a>, <a class='category' href='/blog/categories/stream/'>stream</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.mandubian.com/2014/02/13/zpark/" data-via="mandubian" data-counturl="http://www.mandubian.com/2014/02/13/zpark/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    
    <section>
      <h1>Comments</h1>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
    
    <ul class="pager">
      
      <li class="previous"><a class="basic-alignment left"
        href="/2014/01/31/play-rules-shapeless/" title="Previous Post:
        New Play 2.3 Validation API : breaking the 22 limits with Shapeless">&laquo; New Play 2.3 Validation API : breaking the 22 limits with Shapeless</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
      <li class="next"><a class="basic-alignment right" href="/2014/03/08/zpark-ml-nio-1/"
        title="Next Post: ZPark-Ztream II (Part 1/3): Fancy Spark Streamed Machine-Learning & new Scalaz-Stream NIO API">ZPark-Ztream II (Part 1/3): Fancy Spark Streamed Machine-Learning & new Scalaz-Stream NIO API
        &raquo;</a></li>
      
    </ul>
  </footer>
</article>

<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/2014/03/08/zpark-ml-nio-1/">ZPark-Ztream II (Part 1/3): Fancy Spark Streamed Machine-Learning & new Scalaz-Stream NIO API</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/13/zpark/">ZPark-Ztream: Driving Spark distributed stream with Scalaz-Stream</a>
      </li>
    
      <li class="post">
        <a href="/2014/01/31/play-rules-shapeless/">New Play 2.3 Validation API : breaking the 22 limits with Shapeless</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/22/play-actor-room/">Play 2.2 Actor Room: websocket (&more) room manager only with actors</a>
      </li>
    
      <li class="post">
        <a href="/2013/08/21/playztream/">Scalaz-Stream Plug'n'Play2 Iteratee/WS + Recursive streaming</a>
      </li>
    
  </ul>
</section>


<section class="well">
  <ul id="gh_repos" data-user="mandubian" data-count="5" data-skip="true" class="nav">
	<li class="nav-header">On GitHub</li>
    <li class="loading">Status updating...</li>
  </ul>
  
  <a class="github-follow" href="https://github.com/mandubian">Follow @mandubian</a>
  
</section>



<section class="well">
  <ul id="tweets" class="nav" data-user="mandubian" data-count="4" data-replies="false">
    <li class="loading">Status updating...</li>
  </ul>
  
    <a href="http://twitter.com/mandubian" class="twitter-follow-button" data-show-count="false">Follow @mandubian</a>
  
</section>










  
</aside>


    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2014 - Pascal Voitot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mandubian';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.mandubian.com/2014/02/13/zpark/';
        var disqus_url = 'http://www.mandubian.com/2014/02/13/zpark/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
