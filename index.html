
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mandubian Blog</title>
  <meta name="author" content="Pascal Voitot">

  
  <meta name="description" content="ZPark-Ztream II (Part 3/3): Fancy Spark Streamed Machine-Learning & New Scalaz-Stream NIO API &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.mandubian.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/d3d.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }

    article {
      margin-bottom: 50px;
      border-top: #DDD solid 20px;
    }
 
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mandubian Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10417377-11']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Mandubian Blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:www.mandubian.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/03/10/zpark-ml-nio-3/">ZPark-Ztream II (Part 3/3): Fancy Spark Streamed Machine-Learning & New Scalaz-Stream NIO API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-10T19:19:00+01:00" pubdate data-updated="true">Mar 10<span>th</span>, 2014</time>
        
         | <a href="/2014/03/10/zpark-ml-nio-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Synopsis</h2>

<p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p><a href="/2014-02-13-zpark">Zpark-Zstream I article</a> was a PoC trying to use <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> instead of DStream with <a href="https://spark.incubator.apache.org/">Spark-Streaming</a>. I had deliberately decided not to deal with fault-tolerance &amp; stream graph persistence to keep simple but without it, it was quite useless for real application&#8230;</p></blockquote>

<div class="well">
<p>Here is a tryptic of articles trying to do something <i>concrete</i> with <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> and <a href="https://spark.incubator.apache.org/">Spark</a>.</p>
<p>So, what do I want? I wantttttttt <i>a shrewburyyyyyy</i> and to do the following:</p>
<ol>
<li>Plug Scalaz-Stream Process[Task, T] on Spark DStream[T] (Part 1)</li>
<li>Build DStream using brand new Scalaz-Stream NIO API (client/server) (Part 2)</li>
<li><b>Train Spark-ML <i>recommendation-like</i> model using NIO client/server (Part 3)</b></li>
<li><b>Stream data from multiple NIO clients to the previous trained ML model mixing all together (Part 3)</b></li>
</ol>
</div>


<h1>[Part 3/3] Fancy Spark Machine Learning with NIO client/server &amp; DStream&#8230;</h1>

<br/>


<blockquote><p>Let&#8217;s remind that I&#8217;m not an expert in ML but more a student. So if I tell or do stupid ML things, be indulgent ;)</p></blockquote>

<p>Here is what I propose:</p>

<ul>
<li><p>Train a collaborative filtering rating model for a recommendation system (as explained in Spark doc <a href="https://spark.incubator.apache.org/docs/0.9.0/mllib-guide.html#collaborative-filtering-1">there</a>) using a first NIO server and a client as presented in part 2.</p></li>
<li><p>When model is trained, create a second server that will accept client connections to receive data.</p></li>
<li><p>Stream/merge all received data into one single stream, dstreamize it and perform streamed predictions using previous model.</p></li>
</ul>


<h2>Train collaborative filtering model</h2>

<h3>Training client</h3>

<p>As explained in Spark doc about collaborative filtering, we first need some data to train the model. I want to send those data using a NIO client.</p>

<p>Here is a function doing this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING CLIENT</span>
</span><span class='line'><span class="k">def</span> <span class="n">trainingClient</span><span class="o">(</span><span class="n">addr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// naturally you could provide much more data</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">basicTrainingData</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="c1">// user ID, item ID, Rating</span>
</span><span class='line'>    <span class="s">&quot;1,1,5.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;1,2,1.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;1,3,5.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;1,4,1.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;2,4,1.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;2,2,5.0&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">trainingProcess</span> <span class="k">=</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">emitAll</span><span class="o">(</span><span class="n">basicTrainingData</span> <span class="n">map</span> <span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">((</span><span class="n">s</span><span class="o">+</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">getBytes</span><span class="o">)))</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// sendAndCheckSize is a special client sending all data emitted </span>
</span><span class='line'>  <span class="c1">// by the process and verifying the server received all data </span>
</span><span class='line'>  <span class="c1">// by acknowledging all data size</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="nc">NioClient</span><span class="o">.</span><span class="n">sendAndCheckSize</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">trainingProcess</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">client</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Training server</h3>

<p>Now we need the training NIO server waiting for the training client to connect and piping the received data to the model.</p>

<p>Here is a useful function to help creating a server as described in previous article part:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">server</span><span class="o">(</span><span class="n">addr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">],</span> <span class="nc">Signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">stop</span> <span class="k">=</span> <span class="n">async</span><span class="o">.</span><span class="n">signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'>  <span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// this is a server that is controlled by a stop signal</span>
</span><span class='line'>  <span class="c1">// and that acknowledges all received data by their size</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">server</span> <span class="k">=</span>
</span><span class='line'>    <span class="o">(</span> <span class="n">stop</span><span class="o">.</span><span class="n">discrete</span> <span class="n">wye</span> <span class="nc">NioServer</span><span class="o">.</span><span class="n">ackSize</span><span class="o">(</span><span class="n">addr</span><span class="o">)</span> <span class="o">)(</span><span class="n">wye</span><span class="o">.</span><span class="n">interrupt</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// returns a stream of received data &amp; a signal to stop server</span>
</span><span class='line'>  <span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="n">stop</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can create the training server with it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">trainingAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11100</span><span class="o">)</span>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServer</span><span class="o">,</span> <span class="n">trainingStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>trainingServer</code> is a <code>Process[Task, Bytes]</code> streaming the training data received from training client. We are going to train the rating model with them.</p>

<br/>


<h3>Training model</h3>

<p>To train a model, we can use the following API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// the rating with user ID, product ID &amp; rating</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Rating</span><span class="o">(</span><span class="k">val</span> <span class="n">user</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="k">val</span> <span class="n">product</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="k">val</span> <span class="n">rating</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A RDD of ratings</span>
</span><span class='line'><span class="k">val</span> <span class="n">ratings</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">Rating</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// train the model with it</span>
</span><span class='line'><span class="k">val</span> <span class="n">model</span><span class="k">:</span> <span class="kt">MatrixFactorizationModel</span> <span class="o">=</span> <span class="nc">ALS</span><span class="o">.</span><span class="n">train</span><span class="o">(</span><span class="n">ratings</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mf">0.01</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Building <code>RDD[Rating]</code> from server stream</h3>

<p>Imagine that we have a continuous flow of training data that can be very long.</p>

<p>We want to train the model with just a slice of this flow. To do this, we can:</p>

<ul>
<li><code>dstreamize</code> the server output stream</li>
<li>run the dstream for some time</li>
<li>retrieve the <code>RDD</code>s received during this time</li>
<li>union all of those <code>RDD</code>s</li>
<li>push them to the model</li>
</ul>


<p>Here is the whole code with previous client:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">trainingAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11100</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServer</span><span class="o">,</span> <span class="n">trainingStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING CLIENT</span>
</span><span class='line'><span class="k">val</span> <span class="n">tclient</span> <span class="k">=</span> <span class="n">trainingClient</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// DStreamize server received data</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServerSink</span><span class="o">,</span> <span class="n">trainingDstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span>
</span><span class='line'>  <span class="n">trainingServer</span>
</span><span class='line'>      <span class="c1">// converts bytes to String (doesn&#39;t care about encoding, it shall be UTF8)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span>  <span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="c1">// rechunk received strings based on a separator \n </span>
</span><span class='line'>      <span class="c1">// to keep only triplets: &quot;USER_ID,PROD_ID,RATING&quot;</span>
</span><span class='line'>      <span class="o">.</span><span class="n">pipe</span> <span class="o">(</span><span class="nc">NioUtils</span><span class="o">.</span><span class="n">rechunk</span> <span class="o">{</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">toVector</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">,</span> <span class="n">ssc</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// Prepare dstream output </span>
</span><span class='line'><span class="c1">// (here we print to know what has been received)</span>
</span><span class='line'><span class="n">trainingDstream</span><span class="o">.</span><span class="n">print</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// RUN</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Note the time before</span>
</span><span class='line'><span class="k">val</span> <span class="n">before</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Time</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start SSC</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch server</span>
</span><span class='line'><span class="n">trainingServerSink</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Sleeps a bit to let server listen</span>
</span><span class='line'><span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launches client and awaits until it ends</span>
</span><span class='line'><span class="n">tclient</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Stop server</span>
</span><span class='line'><span class="n">trainingStop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Note the time after</span>
</span><span class='line'><span class="k">val</span> <span class="n">after</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Time</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// retrieves all dstreamized RDD during this period</span>
</span><span class='line'><span class="k">val</span> <span class="n">rdds</span> <span class="k">=</span> <span class="n">trainingDstream</span><span class="o">.</span><span class="n">slice</span><span class="o">(</span>
</span><span class='line'>  <span class="n">before</span><span class="o">.</span><span class="n">floor</span><span class="o">(</span><span class="nc">Milliseconds</span><span class="o">(</span><span class="mi">1000</span><span class="o">)),</span> <span class="n">after</span><span class="o">.</span><span class="n">floor</span><span class="o">(</span><span class="nc">Milliseconds</span><span class="o">(</span><span class="mi">1000</span><span class="o">))</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// unions them (this operation can be expensive)</span>
</span><span class='line'><span class="k">val</span> <span class="n">union</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UnionRDD</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">,</span> <span class="n">rdds</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// converts &quot;USER_ID,PROD_ID,RATING&quot; triplets into Ratings</span>
</span><span class='line'><span class="k">val</span> <span class="n">ratings</span> <span class="k">=</span> <span class="n">union</span> <span class="n">map</span> <span class="o">{</span> <span class="n">e</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">item</span><span class="o">,</span> <span class="n">rate</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Rating</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">rate</span><span class="o">.</span><span class="n">toDouble</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// finally train the model with it</span>
</span><span class='line'><span class="k">val</span> <span class="n">model</span> <span class="k">=</span> <span class="nc">ALS</span><span class="o">.</span><span class="n">train</span><span class="o">(</span><span class="n">ratings</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mf">0.01</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Predict</span>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="s">&quot;Prediction(1,3)=&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// Stop SSC</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Run it</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079621000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">2</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079622000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079623000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079624000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079625000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Prediction</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span><span class="k">=</span><span class="mf">4.94897842056338</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Fantastic, we have trained our model in a very fancy way, haven&#8217;t we?</p>

<p>Personally, I find it interesting that we can take advantage of both APIs&#8230;</p></blockquote>

<br/>


<br/>


<h2>Predict Ratings</h2>

<p>Now that we have a trained model, we can create a new server to receive data from clients for rating prediction.</p>

<br/>


<h3>Prediction client</h3>

<p>Firstly, let&#8217;s generate some random data to send for prediction.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// PREDICTION CLIENT</span>
</span><span class='line'><span class="k">def</span> <span class="n">predictionClient</span><span class="o">(</span><span class="n">addr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// PREDICTION DATA</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">rndData</span> <span class="k">=</span>
</span><span class='line'>    <span class="c1">// userID</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="n">abs</span><span class="o">(</span><span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="n">toString</span> <span class="o">+</span>
</span><span class='line'>    <span class="c1">// productID</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="n">abs</span><span class="o">(</span><span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="n">toString</span> <span class="o">+</span>
</span><span class='line'>    <span class="s">&quot;\n&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">rndDataProcess</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">{</span> <span class="n">rndData</span> <span class="o">}).</span><span class="n">repeat</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// a 1000 elements process emitting every 10ms</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">predictDataProcess</span> <span class="k">=</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">Process</span><span class="o">.</span><span class="n">awakeEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span> <span class="n">zipWith</span> <span class="n">rndDataProcess</span><span class="o">){</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">getBytes</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="nc">NioClient</span><span class="o">.</span><span class="n">sendAndCheckSize</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">predictDataProcess</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">client</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Prediction server</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">predictAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11101</span><span class="o">)</span>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// PREDICTION SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">predictServer</span><span class="o">,</span> <span class="n">predictStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">predictAddr</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Prediction Stream</h3>

<p><code>predictServer</code> is the stream of data to predict. Let&#8217;s stream it to the model by <code>dstreamizing</code> it and transforming all built <code>RDD</code>s by passing them through model</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// DStreamize server</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">predictServerSink</span><span class="o">,</span> <span class="n">predictDstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span>
</span><span class='line'>  <span class="n">predictServer</span>
</span><span class='line'>      <span class="c1">// converts bytes to String (doesn&#39;t care about encoding, it shall be UTF8)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span>  <span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="c1">// rechunk received strings based on a separator \n</span>
</span><span class='line'>      <span class="o">.</span><span class="n">pipe</span> <span class="o">(</span><span class="nc">NioUtils</span><span class="o">.</span><span class="n">rechunk</span> <span class="o">{</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">toVector</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">,</span> <span class="n">ssc</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// pipe dstreamed RDD to prediction model</span>
</span><span class='line'><span class="c1">// and print result</span>
</span><span class='line'><span class="n">predictDstream</span> <span class="n">map</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// converts to integers required by the model (USER_ID, PRODUCT_ID)</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">item</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class='line'><span class="o">}}</span> <span class="n">transform</span> <span class="o">{</span> <span class="n">rdd</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// prediction happens here</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="n">rdd</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span> <span class="n">print</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Running all in same <code>StreamingContext</code></h3>

<p>I&#8217;ve discovered a problem here because the recommendation model is built in a <code>StreamingContext</code> and uses <code>RDD</code>s built in it. So you must use the same <code>StreamingContext</code> for prediction. So I must build my training dstreamized client/server &amp; prediction dstreamized client/server in the same context and thus I must schedule both things before starting this context.</p>

<p>Yet the prediction model is built from training data received after starting the context so it&#8217;s not known before&#8230; So it&#8217;s very painful and I decided to be nasty and consider the model as a variable that will be set later. For this, I used a horrible <code>SyncVar</code> to set the prediction model when it&#8217;s ready&#8230; <em>Sorry about that but I need to study more about this issue to see if I can find better solutions because I&#8217;m not satisfied about it at all&#8230;</em></p>

<p>So here is the whole training/predicting painful code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">trainingAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11100</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TRAINING SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServer</span><span class="o">,</span> <span class="n">trainingStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TRAINING CLIENT</span>
</span><span class='line'><span class="k">val</span> <span class="n">tclient</span> <span class="k">=</span> <span class="n">trainingClient</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// DStreamize server</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServerSink</span><span class="o">,</span> <span class="n">trainingDstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span>
</span><span class='line'>  <span class="n">trainingServer</span>
</span><span class='line'>      <span class="c1">// converts bytes to String (doesn&#39;t care about encoding, it shall be UTF8)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span>  <span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="c1">// rechunk received strings based on a separator \n</span>
</span><span class='line'>      <span class="o">.</span><span class="n">pipe</span> <span class="o">(</span><span class="nc">NioUtils</span><span class="o">.</span><span class="n">rechunk</span> <span class="o">{</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">toVector</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">,</span> <span class="n">ssc</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// THE HORRIBLE SYNCVAR CLUDGE (could have used atomic but not better IMHO)</span>
</span><span class='line'><span class="k">var</span> <span class="n">model</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SyncVar</span><span class="o">[</span><span class="kt">org.apache.spark.mllib.recommendation.MatrixFactorizationModel</span><span class="o">]</span>
</span><span class='line'><span class="c1">// THE HORRIBLE SYNCVAR CLUDGE (could have used atomic but not better IMHO)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// PREDICTING</span>
</span><span class='line'><span class="k">val</span> <span class="n">predictAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11101</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// PREDICTION SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">predictServer</span><span class="o">,</span> <span class="n">predictStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">predictAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// PREDICTION CLIENT</span>
</span><span class='line'><span class="k">val</span> <span class="n">pClient</span> <span class="k">=</span> <span class="n">predictionClient</span><span class="o">(</span><span class="n">predictAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// DStreamize server</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">predictServerSink</span><span class="o">,</span> <span class="n">predictDstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span>
</span><span class='line'>  <span class="n">predictServer</span>
</span><span class='line'>      <span class="c1">// converts bytes to String (doesn&#39;t care about encoding, it shall be UTF8)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span>  <span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="c1">// rechunk received strings based on a separator \n</span>
</span><span class='line'>      <span class="o">.</span><span class="n">pipe</span> <span class="o">(</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">rechunk</span> <span class="o">{</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">toVector</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">,</span> <span class="n">ssc</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Piping received data to the model</span>
</span><span class='line'><span class="n">predictDstream</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">item</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}.</span><span class="n">transform</span> <span class="o">{</span> <span class="n">rdd</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// USE THE HORRIBLE SYNCVAR</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="n">rdd</span><span class="o">)</span>
</span><span class='line'><span class="o">}.</span><span class="n">print</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// RUN ALL</span>
</span><span class='line'><span class="k">val</span> <span class="n">before</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Time</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start SSC</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch training server</span>
</span><span class='line'><span class="n">trainingServerSink</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Sleeps a bit to let server listen</span>
</span><span class='line'><span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch training client</span>
</span><span class='line'><span class="n">tclient</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Await SSC termination a bit</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">awaitTermination</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'><span class="c1">// Stop training server</span>
</span><span class='line'><span class="n">trainingStop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'><span class="k">val</span> <span class="n">after</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Time</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">rdds</span> <span class="k">=</span> <span class="n">trainingDstream</span><span class="o">.</span><span class="n">slice</span><span class="o">(</span><span class="n">before</span><span class="o">.</span><span class="n">floor</span><span class="o">(</span><span class="nc">Milliseconds</span><span class="o">(</span><span class="mi">1000</span><span class="o">)),</span> <span class="n">after</span><span class="o">.</span><span class="n">floor</span><span class="o">(</span><span class="nc">Milliseconds</span><span class="o">(</span><span class="mi">1000</span><span class="o">)))</span>
</span><span class='line'><span class="k">val</span> <span class="n">union</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UnionRDD</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">,</span> <span class="n">rdds</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">ratings</span> <span class="k">=</span> <span class="n">union</span> <span class="n">map</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">item</span><span class="o">,</span> <span class="n">rate</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Rating</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">rate</span><span class="o">.</span><span class="n">toDouble</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// SET THE HORRIBLE SYNCVAR</span>
</span><span class='line'><span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="nc">ALS</span><span class="o">.</span><span class="n">train</span><span class="o">(</span><span class="n">ratings</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mf">0.01</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="s">&quot;**** Model Trained -&gt; Prediction(1,3)=&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch prediction server</span>
</span><span class='line'><span class="n">predictServerSink</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Sleeps a bit to let server listen</span>
</span><span class='line'><span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch prediction client</span>
</span><span class='line'><span class="n">pClient</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Await SSC termination a bit</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">awaitTermination</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'><span class="c1">// Stop server</span>
</span><span class='line'><span class="n">predictStop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Run it&#8230;</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395144379000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">2</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'>
</span><span class='line'><span class="o">****</span> <span class="nc">Model</span> <span class="nc">Trained</span> <span class="o">-&gt;</span> <span class="nc">Prediction</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span><span class="k">=</span><span class="mf">4.919459410565401</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395144384000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="o">----------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395144385000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">1.631952450379809</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395144386000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">0.40813133837755494</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">0.40813133837755494</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h2>Final conclusion</h2>

<p>3 long articles to end in training a poor recommendation system with 2 clients/servers&#8230; A bit bloated isn&#8217;t it? :)</p>

<p>Anyway, I hope I printed in your brain a few ideas, concepts about spark &amp; scalaz-stream and if I&#8217;ve reached this target, it&#8217;s already enough!</p>

<p>Yet, I&#8217;m not satisfied about a few things:</p>

<ul>
<li>Training a model and using it in the same <code>StreamingContext</code> is still clumsy and I must say that calling <code>model.predict</code> from a <code>map</code> function in a <code>DStream</code> might not be so good in a cluster environment. I haven&#8217;t been digging this code enough to have a clear mind on it.</li>
<li>I tried using multiple clients for prediction (like 100 in parallel) and it works quite well but I have encountered problems ending both my clients/servers and the streaming context and I often end into having zombies SBT process that I can&#8217;t kill until reboot (some threads remain RUNNING while other AWAITS and sockets aren&#8217;t released&#8230; resources issues&#8230;). Closing cleanly all of these tools creating threads &amp; more after intensive work isn&#8217;t yet good.</li>
</ul>


<p><strong>But, I&#8217;m satisfied globally:</strong></p>

<ul>
<li><strong>Piping a scalaz-stream <code>Process</code> into a spark <code>DStream</code> works quite well and might be interesting after all.</strong></li>
<li><strong>The new scalaz-stream NIO API considering clients &amp; servers as pure streams of data gave me so many ideas that my free-time has suddenly been frightened and went away.</strong></li>
</ul>


<br/>


<br/>


<blockquote><p><a href="/2014/03/09/zpark-ml-nio-2/">GO TO PART2</a> &lt;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</p></blockquote>

<p>Have a look at the code on <a href="https://github.com/mandubian/zpark-ztream">Github</a>.</p>

<p>Have distributed &amp; resilient yet continuous fun!</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/03/09/zpark-ml-nio-2/">ZPark-Ztream II (Part 2/3): Fancy Spark Streamed Machine-Learning & New Scalaz-Stream NIO API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-09T19:19:00+01:00" pubdate data-updated="true">Mar 9<span>th</span>, 2014</time>
        
         | <a href="/2014/03/09/zpark-ml-nio-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Synopsis</h2>

<p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p><a href="/2014-02-13-zpark">Zpark-Zstream I article</a> was a PoC trying to use <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> instead of DStream with <a href="https://spark.incubator.apache.org/">Spark-Streaming</a>. I had deliberately decided not to deal with fault-tolerance &amp; stream graph persistence to keep simple but without it, it was quite useless for real application&#8230;</p></blockquote>

<div class="well">
<p>Here is a tryptic of articles trying to do something <i>concrete</i> with <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> and <a href="https://spark.incubator.apache.org/">Spark</a>.</p>
<p>So, what do I want? I wantttttttt <i>a shrewburyyyyyy</i> and to do the following:</p>
<ol>
<li>Plug Scalaz-Stream Process[Task, T] on Spark DStream[T] (Part 1)</li>
<li><b>Build DStream using brand new Scalaz-Stream NIO API (client/server) (Part 2)</b></li>
<li>Train Spark-ML <i>recommendation-like</i> model using NIO client/server (Part 3)</li>
<li>Stream data from multiple NIO clients to the previous trained ML model mixing all together (Part 3)</li>
</ol>
</div>




<br/>


<h1>[Part 2/3] From Scalaz-Stream NIO client &amp; server to Spark DStream</h1>

<h2>Scalaz-Stream NIO Client</h2>

<h3>What is a client?</h3>

<ul>
<li>Something sending some data <code>W</code> <em>(for Write)</em> to a server</li>
<li>Something reading some data <code>I</code> <em>(for Input)</em> from a server</li>
</ul>


<br/>


<h3>Client seen as <code>Process</code></h3>

<p>A client could be represented as:</p>

<ul>
<li>a <code>Process[Task, I]</code> for input channel (receiving from server)</li>
<li>a <code>Process[Task, W]</code> for output channel (sending to server)</li>
</ul>


<p>In scalaz-stream, recently a new structure has been added :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">](</span><span class="n">read</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">],</span> <span class="n">write</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Precisely what we need!</p>

<p>Now, let&#8217;s consider that we work in NIO mode with everything non-blocking, asynchronous etc&#8230;</p>

<p>In this context, a client can be seen as something generating <em>soon or later one (or more)</em> <code>Exchange[I, W]</code> i.e :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Client</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]</span> <span class="o">===</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>In the case of a pure TCP client, <code>I</code> and <code>W</code> are often <code>Bytes</code>.</p></blockquote>

<h3>Creating a client</h3>

<p>Scalaz-Stream now provides a helper to create a TCP binary NIO client:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// the address of the server to connect to</span>
</span><span class='line'><span class="k">val</span> <span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">&quot;xxx.yyy.zzz.ttt&quot;</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create a client</span>
</span><span class='line'><span class="k">val</span> <span class="n">client</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]]</span> <span class="k">=</span> <span class="n">nio</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">client</span> <span class="n">map</span> <span class="o">{</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">Exchange</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// read data sent by server in ex.read</span>
</span><span class='line'>  <span class="o">???</span>
</span><span class='line'>  <span class="c1">// write data to the server with ex.write</span>
</span><span class='line'>  <span class="o">???</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Plug your own data source on <code>Exchange</code></h3>

<p>To plug your own data source to write to server, Scalaz-Stream provides 1 more API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">](</span><span class="n">read</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">],</span> <span class="n">write</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Runs supplied Process of `W` values by sending them to remote system.</span>
</span><span class='line'><span class="cm">   * Any replies from remote system are received as `I` values of the resulting process.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">p</span><span class="k">:</span><span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>,<span class="kt">W</span><span class="o">])</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>,<span class="kt">I</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the W are sent to the server and we retrieve only the received data</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this API, we can write data to the client and output received data.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// some data to be sent by client</span>
</span><span class='line'><span class="k">val</span> <span class="n">data</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// send data and retrieve only responses received by client</span>
</span><span class='line'><span class="k">val</span> <span class="n">output</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">]</span> <span class="k">=</span> <span class="n">client</span> <span class="n">flatMap</span> <span class="o">{</span> <span class="n">ex</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">ex</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">receivedData</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="n">output</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yet, in general, we need to:</p>

<ul>
<li>send custom data to the server</li>
<li>expect its response</li>
<li>do some business logic</li>
<li>send more data</li>
<li>etc&#8230;</li>
</ul>


<p>So we need to be able to gather in the same piece of code received &amp; emitted data.</p>

<br/>


<h3>Managing client/server business logic with <code>Wye</code></h3>

<p>Scalaz-stream can help us with the following API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">](</span><span class="n">read</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">],</span> <span class="n">write</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Transform this Exchange to another Exchange where queueing, and transformation of this `I` and `W`</span>
</span><span class='line'><span class="cm">   * is controlled by supplied WyeW.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">wye</span><span class="o">(</span><span class="n">w</span><span class="k">:</span> <span class="kt">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">])</span><span class="k">:</span> <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I2</span>, <span class="kt">W2</span><span class="o">]</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// It transforms the original Exchange[I, W] into a Exchange[I2, W2]</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Whoaaaaa complex isn&#8217;t it? Actually not so much&#8230;</p></blockquote>

<p><code>Wye</code> is a fantastic tool that can:</p>

<ul>
<li>read from a left and/or right branch (in a non-deterministic way: left or right or left+right),</li>
<li>perform computation on left/right received data,</li>
<li>emit data in output.</li>
</ul>


<p>I love ASCII art schema:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="nc">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">I2</span>, <span class="kt">W</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">I</span><span class="o">(</span><span class="n">left</span><span class="o">)</span>       <span class="n">I2</span><span class="o">(</span><span class="n">right</span><span class="o">)</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'><span class="o">|</span>    <span class="nc">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">I2</span>, <span class="kt">W</span><span class="o">]</span>    <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>              <span class="n">v</span>
</span><span class='line'>              <span class="n">W</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>\/</code> is ScalaZ disjunction also called `Either in the Scala world.</p>

<p>So <code>Wye[Task, I, W2, W \/ I2]</code> can be seen as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="nc">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">I</span>       <span class="n">W2</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'><span class="o">|</span> <span class="nc">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span> <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="n">W</span>       <span class="n">I2</span>
</span></code></pre></td></tr></table></div></figure>


<h4>So what does this <code>Exchange.wye</code> API do?</h4>

<ul>
<li>It plugs the original <code>Exchange.write: Sink[Task, W]</code> to the <code>W</code> output of the <code>Wye[Task, I, W2, W \/ I2]</code> for sending data to the server.</li>
<li>It plugs the <code>Exchange.read: Process[Task, I]</code> receiving data from server to the left input of the <code>Wye[Task, I, W2, W]</code>.</li>
<li>The right intput <code>W2</code> branch provides a plug for an external source of data in the shape of <code>Process[Task, W2]</code>.</li>
<li>The right output <code>I2</code> can be used to pipe data from the client to an external local process (like streaming out data received from the server).</li>
<li>Finally it returns an <code>Exchange[I2, W2]</code>.</li>
</ul>


<p>In a summary:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="o">(</span><span class="n">ex</span><span class="k">:</span><span class="kt">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]).</span><span class="n">wye</span><span class="o">(</span> <span class="n">w</span><span class="k">:</span><span class="kt">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ex</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>          <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>
</span><span class='line'>          <span class="n">I</span>       <span class="n">W2</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'> <span class="o">-----------------------------</span>
</span><span class='line'><span class="o">|</span> <span class="n">w</span><span class="k">:</span><span class="kt">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span> <span class="o">|</span>
</span><span class='line'> <span class="o">-----------------------------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="n">W</span>       <span class="n">I2</span>
</span><span class='line'>          <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>
</span><span class='line'>      <span class="n">ex</span><span class="o">.</span><span class="n">write</span>
</span><span class='line'>
</span><span class='line'><span class="o">======&gt;</span> <span class="nc">Returns</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I2</span>, <span class="kt">W2</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>As a conclusion, <code>Exchange.wye</code> <em>combines</em> the original <code>Exchange[I, W]</code> with your custom <code>Wye[Task, I, W2, W \/ I2]</code> which <strong>represents the business logic of data exchange between client &amp; server</strong> and finally returns a <code>Exchange[I2, W2]</code> on which you can plug your own data source and retrieve output data.</p></blockquote>

<br/>


<h4>Implement the client with <code>wye/run</code></h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// The source of data to send to server</span>
</span><span class='line'><span class="k">val</span> <span class="n">data2Send</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The logic of your exchange between client &amp; server</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientWye</span><span class="k">:</span> <span class="kt">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span> <span class="kt">\/</span> <span class="kt">Bytes</span><span class="o">])</span><span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="c1">// Scary, there are so many Bytes</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">clientReceived</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// client connects to the server &amp; returns Exchange</span>
</span><span class='line'>  <span class="n">ex</span>   <span class="k">&lt;-</span> <span class="n">nio</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Exchange is customized with clientWye</span>
</span><span class='line'>  <span class="c1">// Data are injected in it with run</span>
</span><span class='line'>  <span class="n">output</span> <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">wye</span><span class="o">(</span><span class="n">clientWye</span><span class="o">).</span><span class="n">run</span><span class="o">(</span><span class="n">data2Send</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">output</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h4>Implement simple client/server business logic?</h4>

<blockquote><p>Please note, I simply reuse the basic <code>echo</code> example provided in scalaz-stream ;)</p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">clientEcho</span><span class="o">(</span><span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">,</span> <span class="n">data</span><span class="k">:</span> <span class="kt">Bytes</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the custom Wye managing business logic</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">echoLogic</span><span class="k">:</span> <span class="kt">Wye</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Byte</span> <span class="kt">\/</span> <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">go</span><span class="o">(</span><span class="n">collected</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">WyeW</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// Create a Wye that can receive on both sides</span>
</span><span class='line'>      <span class="n">receiveBoth</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Receive on left == receive from server</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">ReceiveL</span><span class="o">(</span><span class="n">rcvd</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="c1">// `emitO` outputs on `I2` branch and then...</span>
</span><span class='line'>          <span class="n">emitO</span><span class="o">(</span><span class="n">rcvd</span><span class="o">)</span> <span class="n">fby</span>
</span><span class='line'>            <span class="c1">// if we have received everything sent, halt</span>
</span><span class='line'>            <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="n">collected</span> <span class="o">+</span> <span class="n">rcvd</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="o">)</span> <span class="n">halt</span>
</span><span class='line'>            <span class="c1">// else go on collecting</span>
</span><span class='line'>            <span class="k">else</span> <span class="n">go</span><span class="o">(</span><span class="n">collected</span> <span class="o">+</span> <span class="n">rcvd</span><span class="o">.</span><span class="n">size</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Receive on right == receive on `W2` branch == your external data source</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">ReceiveR</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="c1">// `emitW` outputs on `W` branch == sending to server</span>
</span><span class='line'>          <span class="c1">// and loops</span>
</span><span class='line'>          <span class="n">emitW</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="n">fby</span> <span class="n">go</span><span class="o">(</span><span class="n">collected</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// When server closes</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">HaltL</span><span class="o">(</span><span class="n">rsn</span><span class="o">)</span>     <span class="k">=&gt;</span> <span class="nc">Halt</span><span class="o">(</span><span class="n">rsn</span><span class="o">)</span>
</span><span class='line'>        <span class="c1">// When client closes, we go on collecting echoes</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">HaltR</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>       <span class="k">=&gt;</span> <span class="n">go</span><span class="o">(</span><span class="n">collected</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Init</span>
</span><span class='line'>    <span class="n">go</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Finally wiring all...</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ex</span>   <span class="k">&lt;-</span> <span class="n">nio</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>    <span class="n">rslt</span> <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">wye</span><span class="o">(</span><span class="n">echoSent</span><span class="o">).</span><span class="n">run</span><span class="o">(</span><span class="n">emit</span><span class="o">(</span><span class="n">data</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">yield</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">rslt</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>This might seem hard to catch to some people because of scalaz-stream notations and wye <code>Left/Right/Both</code> or <code>wye.emitO/emitW</code>. But actually, you&#8217;ll get used to it quite quickly as soon as you understand <code>wye</code>. Keep in mind that this code uses low-level scalaz-stream API without anything else and it remains pretty simple and straighforward.</p></blockquote>

<br/>


<h4>Run the client for its output</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// create a client that sends 1024 random bytes</span>
</span><span class='line'><span class="k">val</span> <span class="n">dataArray</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">.</span><span class="n">fill</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="mi">1024</span><span class="o">)(</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextBytes</span><span class="o">(</span><span class="n">dataArray</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientOutput</span> <span class="k">=</span> <span class="n">clientEcho</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">dataArray</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// consumes all received data... (it should contain dataArray)</span>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">clientOutput</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="s">&quot;Client received:&quot;</span><span class="o">+</span><span class="n">result</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would give something like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Client</span> <span class="n">received</span><span class="k">:</span><span class="kt">Vector</span><span class="o">(</span><span class="kt">Bytes1:</span> <span class="kt">pos</span><span class="o">=</span><span class="err">0</span><span class="o">,</span> <span class="n">length</span><span class="k">=</span><span class="mi">1024</span><span class="o">,</span> <span class="n">src</span><span class="k">:</span> <span class="o">(</span><span class="kt">-</span><span class="err">12</span><span class="o">,</span><span class="err">28</span><span class="o">,</span><span class="mi">55</span><span class="o">,-</span><span class="mi">124</span><span class="o">,</span><span class="mi">3</span><span class="o">,-</span><span class="mi">54</span><span class="o">,-</span><span class="mi">53</span><span class="o">,</span><span class="mi">66</span><span class="o">,-</span><span class="mi">115</span><span class="o">,</span><span class="mf">17.</span><span class="o">..)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<blockquote><p>Now, you know about scalaz-stream clients, what about servers???</p></blockquote>

<br/>


<br/>


<h2>Scalaz-stream NIO Server</h2>

<p>Let&#8217;s start again :D</p>

<h3>What is a server?</h3>

<ul>
<li>Something listening for client(s) connection</li>
<li>When there is a client connected, the server can :

<ul>
<li>Receive data <code>I</code> <em>(for Input)</em> from the client</li>
<li>Send data <code>W</code> <em>(for Write)</em> to the client</li>
</ul>
</li>
<li>A server can manage multiple clients in parallel</li>
</ul>


<br/>


<h3>Server seen as <code>Process</code></h3>

<p>Remember that a client was defined above as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Client</span> <span class="o">===</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our NIO, non-blocking, streaming world, a server can be considered as a stream of clients right?</p>

<p>So finally, we can model a server as :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Server</span> <span class="o">===</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Client</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]]</span>
</span><span class='line'>       <span class="o">===</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]]]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Whoooohoooo, a server is just a stream of streams!!!!</p></blockquote>

<br/>


<h3>Writing a server</h3>

<p>Scalaz-Stream now provides a helper to create a TCP binary NIO server:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// the address of the server</span>
</span><span class='line'><span class="k">val</span> <span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">&quot;xxx.yyy.zzz.ttt&quot;</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create a server</span>
</span><span class='line'><span class="k">val</span> <span class="n">server</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]]]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">nio</span><span class="o">.</span><span class="n">server</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="n">map</span> <span class="o">{</span> <span class="n">client</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// for each client</span>
</span><span class='line'>  <span class="n">client</span> <span class="n">flatMap</span> <span class="o">{</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">Exchange</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="c1">// read data sent by client in ex.read</span>
</span><span class='line'>    <span class="o">???</span>
</span><span class='line'>    <span class="c1">// write data to the client with ex.write</span>
</span><span class='line'>    <span class="o">???</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Don&#8217;t you find that quite elegant? ;)</p></blockquote>

<br/>


<h3>Managing client/server interaction business logic</h3>

<p>There we simply re-use the <code>Exchange</code> described above so you can use exactly the same API than the ones for client. Here is another API that can be useful:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">type</span> <span class="kt">Writes1</span><span class="o">[</span><span class="kt">W</span>, <span class="kt">I</span>, <span class="kt">I2</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">](</span><span class="n">read</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">],</span> <span class="n">write</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Transforms this exchange to another exchange, that for every received `I` will consult supplied Writer1</span>
</span><span class='line'><span class="cm">   * and eventually transforms `I` to `I2` or to `W` that is sent to remote system.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">readThrough</span><span class="o">[</span><span class="kt">I2</span><span class="o">](</span><span class="n">w</span><span class="k">:</span> <span class="kt">Writer1</span><span class="o">[</span><span class="kt">W</span>, <span class="kt">I</span>, <span class="kt">I2</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Strategy</span> <span class="o">=</span> <span class="nc">Strategy</span><span class="o">.</span><span class="nc">DefaultStrategy</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I2</span>,<span class="kt">W</span><span class="o">]</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A small schema?</span>
</span><span class='line'>            <span class="n">ex</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>              <span class="n">v</span>
</span><span class='line'>              <span class="n">I</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'><span class="o">|</span>    <span class="nc">Writer1</span><span class="o">[</span><span class="kt">W</span>, <span class="kt">I</span>, <span class="kt">I2</span><span class="o">]</span>      <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="n">W</span>       <span class="n">I2</span>
</span><span class='line'>          <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>
</span><span class='line'>       <span class="n">ex</span><span class="o">.</span><span class="n">write</span>
</span><span class='line'>
</span><span class='line'><span class="o">======&gt;</span> <span class="nc">Returns</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I2</span>, <span class="kt">W</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this API, you can compute some business logic on the received data from client.</p>

<p>Let&#8217;s write the echo server corresponding to the previous client (<em>you can find this sample in scalaz-stream too</em>):</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">serverEcho</span><span class="o">(</span><span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// This is a Writer1 that echoes everything it receives to the client and emits it locally</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">echoAll</span><span class="k">:</span> <span class="kt">Writer1</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">receive1</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span> <span class="kt">\/</span> <span class="kt">Bytes</span><span class="o">]</span> <span class="o">{</span> <span class="n">i</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="c1">// echoes on left, emits on right and then loop (fby = followed by)</span>
</span><span class='line'>      <span class="n">emitSeq</span><span class="o">(</span> <span class="nc">Seq</span><span class="o">(\/-(</span><span class="n">i</span><span class="o">),</span> <span class="o">-\/(</span><span class="n">i</span><span class="o">))</span> <span class="o">)</span> <span class="n">fby</span> <span class="n">echoAll</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The server that echoes everything</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">receivedData</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">client</span> <span class="k">&lt;-</span> <span class="n">nio</span><span class="o">.</span><span class="n">server</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>      <span class="n">rcv</span>    <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">readThrough</span><span class="o">(</span><span class="n">echoAll</span><span class="o">).</span><span class="n">run</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">yield</span> <span class="n">rcv</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">receivedData</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>receivedData</code> is <code>Process[Task, Process[Task, Bytes]]</code> which is not so practical: we would prefer to gather all data received by clients in 1 single <code>Process[Task, Bytes]</code> to stream it to another module.</p>

<p>Scalaz-Stream has the solution again:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">object</span> <span class="n">merge</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Merges non-deterministically processes that are output of the `source` process.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">mergeN</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">source</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">A</span><span class="o">]])</span>
</span><span class='line'>    <span class="o">(</span><span class="k">implicit</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Strategy</span> <span class="o">=</span> <span class="nc">Strategy</span><span class="o">.</span><span class="nc">DefaultStrategy</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note the Strategy which corresponds to the way Tasks will be executed and that can be compared to Scala <code>ExecutionContext</code>.</p></blockquote>

<p>Fantastic, let&#8217;s plug it on our server:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// The server that echoes everything</span>
</span><span class='line'><span class="k">def</span> <span class="n">serverEcho</span><span class="o">(</span><span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// This is a Writer1 that echoes everything it receives to the client and emits it locally</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">echoAll</span><span class="k">:</span> <span class="kt">Writer1</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">receive1</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span> <span class="kt">\/</span> <span class="kt">Bytes</span><span class="o">]</span> <span class="o">{</span> <span class="n">i</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="c1">// echoes on left, emits on right and then loop (fby = followed by)</span>
</span><span class='line'>      <span class="n">emitSeq</span><span class="o">(</span> <span class="nc">Seq</span><span class="o">(\/-(</span><span class="n">i</span><span class="o">),</span> <span class="o">-\/(</span><span class="n">i</span><span class="o">))</span> <span class="o">)</span> <span class="n">fby</span> <span class="n">echoAll</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The server that echoes everything</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">receivedData</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">client</span> <span class="k">&lt;-</span> <span class="n">nio</span><span class="o">.</span><span class="n">server</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>      <span class="n">rcv</span>    <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">readThrough</span><span class="o">(</span><span class="n">echoAll</span><span class="o">).</span><span class="n">run</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">yield</span> <span class="n">rcv</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Merges all client streams</span>
</span><span class='line'>  <span class="n">merge</span><span class="o">.</span><span class="n">mergeN</span><span class="o">(</span><span class="n">receivedData</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Finally, we have a server and a client!!!!!</p>

<p>Let&#8217;s plug them all together</p></blockquote>

<h2>Run a server</h2>

<p>First of all, we need to create a server that can be stopped when required.</p>

<p>Let&#8217;s do in the scalaz-stream way using:</p>

<ul>
<li><code>wye.interrupt</code> :</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Let through the right branch as long as the left branch is `false`,</span>
</span><span class='line'><span class="cm">   * listening asynchronously for the left branch to become `true`.</span>
</span><span class='line'><span class="cm">   * This halts as soon as the right branch halts.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">interrupt</span><span class="o">[</span><span class="kt">I</span><span class="o">]</span><span class="k">:</span> <span class="kt">Wye</span><span class="o">[</span><span class="kt">Boolean</span>, <span class="kt">I</span>, <span class="kt">I</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>async.signal</code> which is a value that can be changed asynchronously based on 2 APIs:</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Sets the value of this `Signal`. </span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">set</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Returns the discrete version of this signal, updated only when `value`</span>
</span><span class='line'><span class="cm">   * is changed ...</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">discrete</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">A</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without lots of imagination, we can use a <code>Signal[Boolean].discrete</code> to obtain a <code>Process[Task, Boolean]</code> and wye it with previous server process using <code>wye.interrupt</code>. Then, to stop server, you just have to call:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">signal</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the full code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// local bind address</span>
</span><span class='line'><span class="k">val</span> <span class="n">addr</span> <span class="k">=</span> <span class="n">localAddress</span><span class="o">(</span><span class="mi">12345</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The stop signal initialized to false</span>
</span><span class='line'><span class="k">val</span> <span class="n">stop</span> <span class="k">=</span> <span class="n">async</span><span class="o">.</span><span class="n">signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the server controlled by the previous signal</span>
</span><span class='line'><span class="k">val</span> <span class="n">stoppableServer</span> <span class="k">=</span> <span class="o">(</span><span class="n">stop</span><span class="o">.</span><span class="n">discrete</span> <span class="n">wye</span> <span class="n">echoServer</span><span class="o">(</span><span class="n">addr</span><span class="o">))(</span><span class="n">wye</span><span class="o">.</span><span class="n">interrupt</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run server in async without taking care of output data</span>
</span><span class='line'><span class="n">stopServer</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">())</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// DO OTHER THINGS</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stop server</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Run server &amp; client in the same code</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// local bind address</span>
</span><span class='line'><span class="k">val</span> <span class="n">addr</span> <span class="k">=</span> <span class="n">localAddress</span><span class="o">(</span><span class="mi">12345</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// the stop signal initialized to false</span>
</span><span class='line'><span class="k">val</span> <span class="n">stop</span> <span class="k">=</span> <span class="n">async</span><span class="o">.</span><span class="n">signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the server controlled by the previous signal</span>
</span><span class='line'><span class="k">val</span> <span class="n">stoppableServer</span> <span class="k">=</span> <span class="o">(</span><span class="n">stop</span><span class="o">.</span><span class="n">discrete</span> <span class="n">wye</span> <span class="n">serverEcho</span><span class="o">(</span><span class="n">addr</span><span class="o">))(</span><span class="n">wye</span><span class="o">.</span><span class="n">interrupt</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run server in async without taking care of output data</span>
</span><span class='line'><span class="n">stoppableServer</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">())</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create a client that sends 1024 random bytes</span>
</span><span class='line'><span class="k">val</span> <span class="n">dataArray</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">.</span><span class="n">fill</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="mi">1024</span><span class="o">)(</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextBytes</span><span class="o">(</span><span class="n">dataArray</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientOutput</span> <span class="k">=</span> <span class="n">clientEcho</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">dataArray</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Consume all received data in a blocking way...</span>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">clientOutput</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stop server</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Naturally you rarely run the client &amp; server in the same code but this is funny to see our easily you can do that with scalaz-stream as you just manipulate <code>Process</code> run on provided <code>Strategy</code></p></blockquote>

<br/>


<blockquote><p>Finally, we can go back to our subject: <strong>feeding a <code>DStream</code> using a scalaz-stream NIO client/server</strong></p></blockquote>

<h2>Pipe server output to DStream</h2>

<p><code>clientEcho/serverEcho</code> are simple samples but not very useful.</p>

<p>Now we are going to use a custom client/server I&#8217;ve written for this article:</p>

<ul>
<li><code>NioClient.sendAndCheckSize</code> is a client streaming all emitted data of a <code>Process[Task, Bytes]</code> to the server and checking that the global size has been ack&#8217;ed by server.</li>
<li><code>NioServer.ackSize</code> is a server acknowledging all received packets by their size (as a 4-bytes Int)</li>
</ul>


<p>Now let&#8217;s write a client/server dstreamizing data to Spark:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// First create a streaming context</span>
</span><span class='line'><span class="k">val</span> <span class="n">ssc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingContext</span><span class="o">(</span><span class="n">clusterUrl</span><span class="o">,</span> <span class="s">&quot;SparkStreamStuff&quot;</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Local bind address</span>
</span><span class='line'><span class="k">val</span> <span class="n">addr</span> <span class="k">=</span> <span class="n">localAddress</span><span class="o">(</span><span class="mi">12345</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The stop signal initialized to false</span>
</span><span class='line'><span class="k">val</span> <span class="n">stop</span> <span class="k">=</span> <span class="n">async</span><span class="o">.</span><span class="n">signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the server controlled by the previous signal</span>
</span><span class='line'><span class="k">val</span> <span class="n">stoppableServer</span> <span class="k">=</span> <span class="o">(</span><span class="n">stop</span><span class="o">.</span><span class="n">discrete</span> <span class="n">wye</span> <span class="nc">NioServer</span><span class="o">.</span><span class="n">ackSize</span><span class="o">(</span><span class="n">addr</span><span class="o">))(</span><span class="n">wye</span><span class="o">.</span><span class="n">interrupt</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create a client that sends a natural integer every 50ms as a string (until reaching 100)</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientData</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">50</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="n">toString</span><span class="o">.</span><span class="n">getBytes</span><span class="o">))</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientOutput</span> <span class="k">=</span> <span class="nc">NioClient</span><span class="o">.</span><span class="n">sendAndCheckSize</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">clientData</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Dstreamize the server into the streaming context</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">dstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span><span class="n">stoppableServer</span><span class="o">,</span> <span class="n">ssc</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Prepare dstream output</span>
</span><span class='line'><span class="n">dstream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">).</span><span class="n">print</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start the streaming context</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run the server just for its effects</span>
</span><span class='line'><span class="n">consumer</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run the client in a blocking way</span>
</span><span class='line'><span class="n">clientOutput</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Await SSC termination a bit</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">awaitTermination</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stop server</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stop the streaming context</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>When run, it prints :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395049304000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395049305000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">0</span>
</span><span class='line'><span class="mi">1</span>
</span><span class='line'><span class="mi">2</span>
</span><span class='line'><span class="mi">3</span>
</span><span class='line'><span class="mi">4</span>
</span><span class='line'><span class="mi">5</span>
</span><span class='line'><span class="mi">6</span>
</span><span class='line'><span class="mi">7</span>
</span><span class='line'><span class="mi">8</span>
</span><span class='line'><span class="mi">9</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395049306000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">20</span>
</span><span class='line'><span class="mi">21</span>
</span><span class='line'><span class="mi">22</span>
</span><span class='line'><span class="mi">23</span>
</span><span class='line'><span class="mi">24</span>
</span><span class='line'><span class="mi">25</span>
</span><span class='line'><span class="mi">26</span>
</span><span class='line'><span class="mi">27</span>
</span><span class='line'><span class="mi">28</span>
</span><span class='line'><span class="mi">29</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Until 100&#8230;</p>

<br/>


<br/>


<h2>Part2&#8217;s conclusion</h2>

<p>I spent this second part of my tryptic mainly explaining a few concepts of the new scalaz-stream brand new NIO API. With it, a client becomes just a stream of exchanges <code>Process[Task, Exchange[I, W]]</code> and a server becomes a stream of stream of exchanges <code>Process[Task, Process[Task, Exchange[I, W]]]</code>.</p>

<p>As soon as you manipulate <code>Process</code>, you can then use the <code>dstreamize</code> API exposed in <a href="/2014/03/08/zpark-ml-nio-1/">Part 1</a> to pipe streamed data into Spark.</p>

<p><strong>Let&#8217;s go to <a href="/2014/03/10/zpark-ml-nio-3/">Part 3</a> now in which we&#8217;re going to do some fancy Machine Learning training with these new tools.</strong></p>

<br/>


<br/>


<blockquote><p><a href="/2014/03/08/zpark-ml-nio-1/">GO TO PART1</a> &lt; &#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;> <a href="/2014/03/10/zpark-ml-nio-3/">GO TO PART3</a></p></blockquote>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/03/08/zpark-ml-nio-1/">ZPark-Ztream II (Part 1/3): Fancy Spark Streamed Machine-Learning & New Scalaz-Stream NIO API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-08T19:19:00+01:00" pubdate data-updated="true">Mar 8<span>th</span>, 2014</time>
        
         | <a href="/2014/03/08/zpark-ml-nio-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><br/>


<h2>Synopsis</h2>

<p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p><a href="/2014/02/13/zpark/">Zpark-Zstream I article</a> was a PoC trying to use <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> instead of DStream with <a href="https://spark.incubator.apache.org/">Spark-Streaming</a>. I had deliberately decided not to deal with fault-tolerance &amp; stream graph persistence to keep simple but without it, it was quite useless for real application&#8230;</p></blockquote>

<div class="well">
<p>Here is a tryptic of articles trying to do something <i>concrete</i> with <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> and <a href="https://spark.incubator.apache.org/">Spark</a>.</p>
<p>So, what do I want? I wantttttttt <i>a shrewburyyyyyy</i> and to do the following:</p>
<ol>
<li><b>Plug Scalaz-Stream Process[Task, T] on Spark DStream[T] (Part 1)</b></li>
<li>Build DStream using brand new Scalaz-Stream NIO API (client/server) (Part 2)</li>
<li>Train Spark-ML <i>recommendation-like</i> model using NIO client/server (Part 3)</li>
<li>Stream data from multiple NIO clients to the previous trained ML model mixing all together (Part 3)</li>
</ol>
</div>


<h1>[Part 1/3] From Scalaz-Stream Process to Spark DStream</h1>

<br/>


<br/>


<h2>Reminders on Process[Task, T]</h2>

<p>Scalaz-stream <code>Process[Task, T]</code> is a stream of <code>T</code> elements that can interleave some <code>Task</code>s (representing an external something doing somewhat). <code>Process[Task, T]</code> is built as a state machine that you need to run to process all <code>Task</code> effects and emit a stream of <code>T</code>. This can manage both continuous or discrete, finite or infinite streams.</p>

<blockquote><p>I restricted to <code>Task</code> for the purpose of this article but it can be any <code>F[_]</code>.</p></blockquote>

<br/>


<h2>Reminders on DStream[T]</h2>

<p>Spark <code>DStream[T]</code> is a stream of <code>RDD[T]</code> built by discretizing a continuous stream of <code>T</code>. <code>RDD[T]</code> is a <em>resilient distributed dataset</em> which is the ground data-structure behind Spark for distributing in-memory batch/map/reduce operations to a cluster of nodes with fault-tolerance &amp; persistence.</p>

<p>In a summary, <code>DStream</code> <em>slices</em> a continuous stream of <code>T</code> by windows of time and gathers all <code>T</code>s in the same window into one <code>RDD[T]</code>. So it discretizes the continuous stream into a stream of <code>RDD[T]</code>. Once built, those <code>RDD[T]</code>s are distributed to Spark cluster. Spark allows to perform transform/union/map/reduce/&#8230; operations on <code>RDD[T]</code>s. Therefore <code>DStream[T]</code> takes advantage if the same operations.</p>

<p>Spark-Streaming also persists all operations &amp; relations between <code>DStream</code>s in a graph. Thus, in case of fault in a remote node while performing operations on <code>DStream</code>s, the whole transformation can be replayed (<em>it also means streamed data are also persisted</em>).</p>

<p>Finally, the resulting <code>DStream</code> obtained after map/reduce operations can be <em>output</em> to a file, a console, a DB etc&#8230;</p>

<blockquote><p>Please note that <code>DStream[T]</code> is built with respect to a <code>StreamingContext</code> which manages its distribution in Spark cluster and all operations performed on it. Moreover, <code>DStream</code> map/reduce operations &amp; output must be scheduled before starting the <code>StreamingContext</code>. It could be somewhat compared to a state machine that you build statically and run later.</p></blockquote>

<br/>


<h2>From Process[Task, T] to RDD[T]</h2>

<blockquote><p>You may ask why not simply build a <code>RDD[T]</code> from a <code>Process[Task, T]</code> ?</p></blockquote>

<p>Yes sure we can do it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Initialize Spark Context</span>
</span><span class='line'><span class="k">implicit</span> <span class="n">scc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkContext</span><span class="o">(...)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Build a process</span>
</span><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run the process using `runLog` to aggregate all results</span>
</span><span class='line'><span class="c1">// and build a RDD using spark context parallelization</span>
</span><span class='line'><span class="k">val</span> <span class="n">rdd</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works but what if this <code>Process[Task, T]</code> emits huge quantity of data or is infinite?
You&#8217;ll end in a <code>OutOfMemoryException</code>&#8230;</p>

<p>So yes you can do it but it&#8217;s not so interesting. <code>DStream</code> seems more natural since it can manage stream of data as long as it can discretize it over time.</p>

<br/>


<br/>


<h2>From Process[Task, T] to DStream[T]</h2>

<br/>


<h3>Pull from <code>Process[Task, T]</code>, Push to <code>DStream[T]</code> with <code>LocalInputDStream</code></h3>

<p>To build a <code>DStream[T]</code> from a <code>Process[Task, T]</code>, the idea is to:</p>

<ul>
<li>Consume/pull the <code>T</code> emitted by <code>Process[Task, O]</code>,</li>
<li>Gather emitted <code>T</code> during a window of time &amp; generate a <code>RDD[T]</code> with them,</li>
<li>Inject <code>RDD[T]</code> into the <code>DStream[T]</code>,</li>
<li>Go to next window of time&#8230;</li>
</ul>


<p>Spark-Streaming library provides different helpers to create <code>DStream</code> from different sources of data like files (local/HDFS), from sockets&#8230;</p>

<p>The helper that seemed the most appropriate is the <code>NetworkInputDStream</code>:</p>

<ul>
<li>It provides a <code>NetworkReceiver</code> based on a Akka actor to which we can push streamed data.</li>
<li><code>NetworkReceiver</code> gathers streamed data over windows of time and builds a <code>BlockRDD[T]</code> for each window.</li>
<li>Each <code>BlockRDD[T]</code> is registered to the global Spark <code>BlockManager</code> (responsible for data persistence).</li>
<li><code>BlockRDD[T]</code> is injected into the <code>DStream[T]</code>.</li>
</ul>


<p>So basically, <code>NetworkInputDStream</code> builds a stream of <code>BlockRDD[T]</code>.
It&#8217;s important to note that <code>NetworkReceiver</code> is also meant to be sent to remote workers so that data can be gathered on several nodes at the same time.</p>

<p>But in my case, the data source <code>Process[Task, T]</code> run on the Spark driver node (at least for now) so instead of <code>NetworkInputDStream</code>, a <code>LocalInputDStream</code> would be better. It would provide a <code>LocalReceiver</code> based on an actor to which we can push the data emitted by the process in an async way.</p>

<blockquote><p><code>LocalInputDStream</code> doesn&#8217;t exist in Spark-Streaming library (or I haven&#8217;t looked well) so I&#8217;ve implemented it as I needed. It does exactly the same as <code>NetworkInputDStream</code> without the remoting aspect. The current code is <a href="https://github.com/mandubian/zpark-ztream/blob/master/src/main/scala/LocalInputDStream.scala">there</a>&#8230;</p></blockquote>

<br/>


<h3><code>Process</code> vs <code>DStream</code> ?</h3>

<p>There is a common point between <code>DStream</code> and <code>Process</code>: both are built as state machines that are passive until run.</p>

<ul>
<li><p>In the case of <code>Process</code>, it is run by playing all the <code>Task</code> effects while gathering emitted values or without taking care of them, in blocking or non-blocking mode etc&#8230;</p></li>
<li><p>In the case of <code>DStream</code>, it is built and registered in the context of a <code>SparkStreamingContext</code>. Then you must also declare some outputs for the <code>DStream</code> like a simple print, an <code>HDFS</code> file output, etc&#8230; Finally you start the <code>SparkStreamingContext</code> which manages everything for you until you stop it.</p></li>
</ul>


<p>So if we want to adapt a <code>Process[Task, T]</code> to a <code>DStream[T]</code>, we must perform 4 steps  (<em>on the Spark driver node</em>):</p>

<ul>
<li>build a <code>DStream[T]</code> using <code>LocalInputDStream[T]</code> providing a <code>Receiver</code> in which we&#8217;ll be able to push asynchronously <code>T</code>.</li>
<li>build a custom scalaz-stream <code>Sink[Task, T, Unit]</code> in charge of consuming all emitted data from <code>Process[Task, T]</code> and pushing them using previous <code>Receiver</code>.</li>
<li>pipe the <code>Process[Task, T]</code> to this <code>Sink[Task, T, Unit]</code> &amp; when <code>Process[Task, T]</code> has halted, stop previous <code>DStream[T]</code>: the result of this pipe operation is a <code>Process[Task, Unit]</code> which is a pure effectful process responsible for pushing <code>T</code> into the dstream without emitting anything.</li>
<li>return previous <code>DStream[T]</code> and effectful consumer <code>Process[Task, Unit]</code>.</li>
</ul>


<h3><code>dstreamize</code> implementation</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">dstreamize</span><span class="o">[</span><span class="kt">T</span> <span class="kt">:</span> <span class="kt">ClassTag</span><span class="o">](</span>
</span><span class='line'>  <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">T</span><span class="o">],</span>
</span><span class='line'>  <span class="n">ssc</span><span class="k">:</span> <span class="kt">StreamingContext</span><span class="o">,</span>
</span><span class='line'>  <span class="n">storageLevel</span><span class="k">:</span> <span class="kt">StorageLevel</span> <span class="o">=</span> <span class="nc">StorageLevel</span><span class="o">.</span><span class="nc">MEMORY_AND_DISK_SER_2</span>
</span><span class='line'><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Unit</span><span class="o">],</span> <span class="nc">ZparkInputDStream</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Build a custom LocalInputDStream</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">dstream</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ZparkInputDStream</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">ssc</span><span class="o">,</span> <span class="n">storageLevel</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Build a Sink pushing into dstream receiver</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sink</span> <span class="k">=</span> <span class="n">receiver2Sink</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">dstream</span><span class="o">.</span><span class="n">receiver</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">ZparkReceiver</span><span class="o">[</span><span class="kt">T</span><span class="o">]])</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Finally pipe the process to the sink and when finished, closes the dstream</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">consumer</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="o">(</span><span class="n">p</span> <span class="n">to</span> <span class="n">sink</span><span class="o">)</span>
</span><span class='line'>    <span class="c1">// when finished, it closes the dstream</span>
</span><span class='line'>    <span class="o">.</span><span class="n">append</span> <span class="o">(</span> <span class="n">eval</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">{</span> <span class="n">dstream</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span> <span class="o">})</span> <span class="o">)</span>
</span><span class='line'>    <span class="c1">// when error, it closes the dstream</span>
</span><span class='line'>    <span class="o">.</span><span class="n">handle</span> <span class="o">{</span> <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span>
</span><span class='line'>      <span class="n">println</span><span class="o">(</span><span class="s">&quot;Stopping on error &quot;</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">)</span>
</span><span class='line'>      <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="o">()</span>
</span><span class='line'>      <span class="n">eval</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">{</span> <span class="n">dstream</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span> <span class="o">})</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Return the effectful consumer sink and the DStream</span>
</span><span class='line'>  <span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">dstream</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please remark that this builds a <code>Process[Task, Unit]</code> and a <code>DStream[T]</code> but nothing has happened yet in terms of data consumption &amp; streaming. Both need to be run now.</p></blockquote>

<h3>Use it&#8230;</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// First create a streaming context</span>
</span><span class='line'><span class="k">val</span> <span class="n">ssc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingContext</span><span class="o">(</span><span class="n">clusterUrl</span><span class="o">,</span> <span class="s">&quot;SparkStreamStuff&quot;</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create a data source sample as a process generating a natural every 50ms </span>
</span><span class='line'><span class="c1">// (take 1000 elements)</span>
</span><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">50</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Dstreamize the process in the streaming context</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">dstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">ssc</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Prepare the dstream operations (count) &amp; output (print)</span>
</span><span class='line'><span class="n">dstream</span><span class="o">.</span><span class="n">count</span><span class="o">().</span><span class="n">print</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start the streaming context</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run the consumer for its effects (consuming p and pushing into dstream)</span>
</span><span class='line'><span class="c1">// Note this is blocking but it could be runAsync too</span>
</span><span class='line'><span class="n">consumer</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// await termination of stream with a timeout</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">awaitTermination</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stops the streaming context</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that you have to:</p>

<ul>
<li>schedule your dstream operations/output before starting the streaming context.</li>
<li>start the streaming context before running the consumer.</li>
</ul>
</blockquote>

<h3>Run it&#8230;</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="mi">14</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">11</span> <span class="mi">11</span><span class="k">:</span><span class="err">32</span><span class="kt">:</span><span class="err">09</span> <span class="kt">WARN</span> <span class="kt">util.Utils:</span> <span class="kt">Your</span> <span class="kt">hostname</span><span class="o">,</span> <span class="n">localhost</span><span class="o">.</span><span class="n">paris</span><span class="o">.</span><span class="n">zenexity</span><span class="o">.</span><span class="n">com</span> <span class="n">resolves</span> <span class="n">to</span> <span class="n">a</span> <span class="n">loopback</span> <span class="n">address</span><span class="k">:</span> <span class="err">127</span><span class="kt">.</span><span class="err">0</span><span class="kt">.</span><span class="err">0</span><span class="kt">.</span><span class="err">1</span><span class="o">;</span> <span class="n">using</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">24.228</span> <span class="n">instead</span> <span class="o">(</span><span class="n">on</span> <span class="n">interface</span> <span class="n">en0</span><span class="o">)</span>
</span><span class='line'><span class="mi">14</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">11</span> <span class="mi">11</span><span class="k">:</span><span class="err">32</span><span class="kt">:</span><span class="err">09</span> <span class="kt">WARN</span> <span class="kt">util.Utils:</span> <span class="kt">Set</span> <span class="kt">SPARK_LOCAL_IP</span> <span class="kt">if</span> <span class="kt">you</span> <span class="kt">need</span> <span class="kt">to</span> <span class="kt">bind</span> <span class="kt">to</span> <span class="kt">another</span> <span class="kt">address</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1394533933000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1394533934000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">14</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1394533935000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">20</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1394533936000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">20</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Ok cool, we can see a warmup phase at beginning and then windows of 1 sec counting 20 elements which is great since one element every 50ms gives 20 elements in 1sec.</p></blockquote>

<br/>


<br/>


<h2>Part 1&#8217;s conclusion</h2>

<p>Now we can pipe a <code>Process[Task, T]</code> into a <code>DStream[T]</code>.</p>

<p>Please not that as we run the <code>Process[Task, T]</code> on the Spark driver node, if this node fails, there is no real way to restore lost data. Yet, <code>LocalInputDStream</code> relies on <code>DStreamGraph</code> &amp; <code>BlockRDD</code>s which persist all DStream relations &amp; all received blocks. Moreover, <code>DStream</code> has exactly the same problem with respect to driver node for now.</p>

<p>That was fun but what can we do with that?</p>

<p><strong>In <a href="/2014/03/09/zpark-ml-nio-2/">part2</a>, I propose to have more fun and stream data to <code>DStream</code> using the brand new Scalaz-Stream NIO API to create cool NIO client/server streams&#8230;</strong></p>

<br/>


<br/>


<blockquote><p>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-> <a href="/2014/03/09/zpark-ml-nio-2/">GO TO PART2</a></p></blockquote>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/02/13/zpark/">ZPark-Ztream: Driving Spark Distributed Stream With Scalaz-Stream</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-13T18:18:00+01:00" pubdate data-updated="true">Feb 13<span>th</span>, 2014</time>
        
         | <a href="/2014/02/13/zpark/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p>Today I&#8217;m going to write about a Proof of Concept I&#8217;ve been working on those last weeks: I wanted to <strong>use scalaz-stream as a driver of Spark distributed data processing</strong>.
This is simply an idea and I don&#8217;t even know whether it is viable or stupid. But the idea is interesting!</p></blockquote>

<h2>Introduction</h2>

<p>2 of my preferred topics those last months are :</p>

<ul>
<li>Realtime streaming</li>
<li>Realtime clustered data processing (in-memory &amp; fault-tolerant)</li>
</ul>


<p>2 tools have kept running through my head those last months:</p>

<ul>
<li><p><a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> for realtime/continuous streaming using pure functional concepts: I find it very interesting conceptually speaking &amp; very powerful, specially the deterministic &amp; non-deterministic demuxtiplexers provided out-of-the-box (Tee &amp; Wye).</p></li>
<li><p><a href="https://spark.incubator.apache.org/">Spark</a> for fast/fault-tolerant in-memory, resilient &amp; clustered data processing.</p></li>
</ul>


<p>I won&#8217;t speak much about Scalaz-Stream because I wrote a few articles about it.</p>

<br/>


<h4>Let&#8217;s focus on Spark.</h4>

<p>Spark provides tooling for cluster processing of huge datasets in the same <em>batch mode</em> way as Hadoop, the very well known <em>map/reduce</em> infrastructure. But at the difference of Hadoop which is exclusively relying on HDFS cluster file systems when distributing data through the cluster, Spark tries to cache data in memory as much as possible so that latency of access is reduced as much as possible. Hadoop can scale a lot but is known to be slow in the context of a single node.</p>

<p>Spark is aimed at scaling as much as Hadoop but running faster on each node using in-memory caching. Fault-tolerance &amp; data resilience is managed by Spark too using persistence &amp; redundancy based on any nice storage like HDFS or files or whatever you can plug on Spark. So Spark is meant to be a super fast in-memory, fault-tolerant batch processing engine.</p>

<br/>


<h4>RDD Resilient Distributed Dataset</h4>

<p>The basic concept of Spark is <em>Resilient Distributed Dataset</em> aka <code>RDD</code> which is a read-only, <strong>immutable</strong> data structure representing a collection of objects or dataset that can be distributed across a set of nodes in a cluster to perform map/reduce style algorithms.</p>

<p>The dataset represented by this <code>RDD</code> is partitioned i.e. cut into slices called <em>partitions</em> that can be distributed across the cluster of nodes.</p>

<p><code>Resilient</code> means these data can be rebuilt in case of fault on a node or data loss. To perform this, the dataset is replicated/persisted across nodes in memory or in distributed file system such as HDFS.</p>

<p>So the idea of RDD is to provide a seamless structure to manage clustered datasets with very simple API in &#8220;monadic&#8221;-style :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">sc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkContext</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;local[4]&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Simple App&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;YOUR_SPARK_HOME&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="nc">List</span><span class="o">(</span><span class="s">&quot;target/scala-2.10/simple-project_2.10-1.0.jar&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">logData</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="n">logFile</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="n">cache</span><span class="o">().</span><span class="n">filter</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)).</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span> <span class="o">+</span> <span class="s">&quot;foo&quot;</span> <span class="o">).</span><span class="n">count</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Depending on your <code>SparkContext</code> configuration, Spark takes in charge of distributing behind the curtain your data to the cluster nodes to perform the required processing in a fully distributed way.</p>

<blockquote><p>One thing to keep in mind is that Spark distributes data to remote nodes but it also distributes the code/closures remotely. So it means your code has to be serializable which is not the case of scalaz-stream in its current implementation.</p></blockquote>

<br/>


<h4>Just a word on Spark code</h4>

<p>As usual, before using Spark in any big project, I&#8217;ve been diving in its code to know whether I can trust this project. I must say I know Spark&#8217;s code better than its API ;)</p>

<p>I find Spark Scala implementation quite clean with explicit choices of design made clearly in the purpose of performance. The need to provide a compatible Java/Python API and to distribute code across clustered nodes involves a few restrictions in terms of implementation choices. Anyway, I won&#8217;t criticize much because I wouldn&#8217;t have written it better and those people clearly know what they do!</p>

<br/>


<h2>Spark Streaming</h2>

<p>So Spark is very good to perform fast clustered batch data processing. Yet, what if your dataset is built progressively, continuously, in realtime?</p>

<p>On top of the core module, Spark provides an extension called <a href="https://spark.incubator.apache.org/docs/latest/streaming-programming-guide.html">Spark Streaming</a> aiming at manipulating live streams of data using the power of Spark.</p>

<p>Spark Streaming can ingest different continuous data feeds like Kafka, Flume, Twitter, ZeroMQ or TCP socket and perform high-level operations on it such as map/reduce/groupby/window/&#8230;</p>

<br/>


<h3>DStream</h3>

<p>The core data structure behind Spark Streams is <code>DStream</code> for <strong>Discretized Stream</strong> (and not <em>distributed</em>).</p>

<p><code>Discretized</code> means it gets a continuous stream of data and makes it discrete by slicing it across time and wrapping those sliced data into the famous <code>RDD</code> described above.</p>

<p>A <code>DStream</code> is just a temporal data partitioner that can distribute data slices across the cluster of nodes to perform some data processing using Spark capabilities.</p>

<p>Here is the illustration in official Spark Stream documentation:</p>

<p><img src="https://spark.incubator.apache.org/docs/latest/img/streaming-dstream.png" alt="streaming-dstream" /></p>

<p><code>DStream</code> also tries to leverage Spark automated persistence/caching/fault-tolerance to the domain of live streaming.</p>

<p><code>DStream</code> is cool but it&#8217;s completely based on temporal aspects. Imagine you want to slice the stream depending on other criteria, with <code>DStream</code>, it would be quite hard because the whole API is based on time. Moreover, using DStream, you can discretize a dataflow but you can&#8217;t go in the other way and make it continuous again (in my knowledge). This is something that would be cool, isn&#8217;t it?</p>

<p>If you want to know more about DStream discretization mechanism, have a look at the official <a href="https://spark.incubator.apache.org/docs/latest/streaming-programming-guide.html">doc</a>.</p>

<br/>


<blockquote><p>As usual, I&#8217;m trying to investigate the edge-cases of concepts I like. In general, this is where I can test the core design of the project and determine whether it&#8217;s worth investigating in my every-day life.</p></blockquote>

<br/>


<h2>Driving Spark Streams with Scalaz-Stream</h2>

<p>I&#8217;ve been thinking about scalaz-stream concepts quite a lot and scalaz-stream is very good at manipulating continuous streams of data. Moreover, it can very easily partition a continuous stream regrouping data into chunks based on any criteria you can imagine.</p>

<p>Scalaz-stream represents a data processing algorithm as a static state machine that you can run when you want. This is the same idea behind map/reduce Spark API: you build your chain of map/filter/window and finally reduce it. <em>Reducing a spark data processing is like running a scalaz-stream machine.</em></p>

<blockquote><p>So my idea was the following:</p>

<ul>
<li>build a continuous stream of data based on scalaz-stream <code>Process[F, O]</code></li>
<li>discretize the stream <code>Process[F, O] =&gt; Process[F, RDD[O]]</code></li>
<li>implement count/reduce/reduceBy/groupBy for <code>Process[F, RDD[O]]</code></li>
<li>provide a <code>continuize</code> method to do <code>Process[F, RDD[O]] =&gt; Process[F, O]</code></li>
</ul>
</blockquote>

<p>So I&#8217;ve been hacking between Scalaz-stream <code>Process[F, O]</code> &amp; Spark <code>RDD[O]</code> and here is the resulting API that I&#8217;ve called <code>ZPark-ZStream</code> (ZzzzzzPark-Zzzzztream).</p>

<p>Let&#8217;s play a bit with my little alpha API.</p>

<br/>


<h3>Discretization by simple slicing</h3>

<p>Let&#8217;s start with a very simple example.</p>

<p>Take a simple finite process containing integers:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="mi">6L</span><span class="o">,</span> <span class="mi">6L</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I want to slice this stream of integer by slices of 4 elements.</p>

<p>First we have to create the classic Spark Streaming context and make it implicit (needed by my API).</p>

<p><em>Please remark that I could plug existing StreamingContext on my code without any problem.</em></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">clusterUrl</span> <span class="k">=</span> <span class="s">&quot;local[4]&quot;</span>
</span><span class='line'><span class="k">implicit</span> <span class="n">ssc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingContext</span><span class="o">(</span><span class="n">clusterUrl</span><span class="o">,</span> <span class="s">&quot;SparkSerial&quot;</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then let&#8217;s parallelize the previous process :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">prdd</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="k">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'><span class="c1">// type is just there to show what scalac will infer</span>
</span><span class='line'><span class="c1">// Just to remind that Task is the Future equivalent in Scalaz</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok folks, now, we have a discretized stream of <code>Long</code> that can be distributed across a Spark cluster.</p>

<p><code>DStream</code> provides <code>count</code> API which count elements on each <code>RDD</code> in the stream.</p>

<p>Let&#8217;s do the same with my API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">pcount</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">prdd</span><span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>What happens here? The `count operation on each RDD in the stream is distributed across the cluster in a map/reduce-style and results are gathered.</p>

<p>Ok that&#8217;s cool but you still have a discretized stream <code>Process[Task, RDD[Int]]</code> and that&#8217;s not practical to use to see what&#8217;s inside it. So now we are going to <code>re-continuize</code> it and make it a <code>Process[Task, Int]</code> again.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">pfinal</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">pcount</span><span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Easy isn&#8217;t it?</p>

<p>All together :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217; print the result in the console</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">stdOutLines</span><span class="o">[</span><span class="kt">I</span><span class="o">]</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">.</span><span class="n">constant</span><span class="o">{</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">I</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Task</span><span class="o">.</span><span class="n">delay</span> <span class="o">{</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot; ----&gt; [${System.nanoTime}] *** $s&quot;</span><span class="o">)</span> <span class="o">}}</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'><span class="c1">// 1 run for the process &amp; 1 run for the Task</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418478569989000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">4</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418478593226000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Oh yes that works: in each slice of 4 elements, we actually have 4 elements! Reassuring ;)</p></blockquote>

<p>Let&#8217;s do the same with <code>countByValue</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDDByValue</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'><span class="c1">// 1 run for the process &amp; 1 run for the Task</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552751011000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552751176000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552770527000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552770640000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see that 4 comes before 3. This is due to the fact the 2nd slice of 4 elements (3,3,4,4) is converted into a RDD which is then partitioned and distributed across the cluster to perform the map/reduce count operation. So the order of return might be different at the end.</p>

<p>An example of map/reduce ?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">mapRDD</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">reduceRDD</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418619885745000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">10</span> <span class="o">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418619905817000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">18</span> <span class="o">(</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="mi">5</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that:</p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">p</span> <span class="n">mapRDD</span> <span class="n">f</span> <span class="o">===</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">rdd</span> <span class="k">=&gt;</span> <span class="n">rdd</span> <span class="n">map</span> <span class="n">f</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Discretization by time slicing</h3>

<p>Now we could try to slice according to time in the same idea as <code>DStream</code></p>

<p>First of all, let&#8217;s define a continuous stream of positive integers:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">naturals</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">go</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">i</span><span class="o">)){</span> <span class="n">i</span> <span class="k">=&gt;</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">++</span> <span class="n">go</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">go</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, I want integers to be emitted at a given tick for example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="n">duration</span><span class="k">:</span> <span class="kt">Duration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">naturals</span> <span class="n">zipWith</span> <span class="nc">Process</span><span class="o">.</span><span class="n">awakeEvery</span><span class="o">(</span><span class="n">duration</span><span class="o">)){</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">i</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, let&#8217;s discretize the continuous stream with <strong>ZPark-Ztream</strong> API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The stream is sliced in slice of 500ms and all elements emitted during these 500ms are gathered in a Spark <code>RDD</code>.</p>

<p>On this stream of <code>RDD, we can apply</code>countRDD` as before and finally re-continuize it. All together we obtain:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5000</span><span class="o">)</span>  <span class="c1">// takes only 5000 because an infinite stream is hard to log in an article</span>
</span><span class='line'>  <span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395213389954000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">47</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395213705505000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">28</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395214191637000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">47</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395214688724000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">48</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395215189453000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">45</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395215697655000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">48</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395240677357000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395241175632000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395241674446000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395242175416000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395242675183000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395243177056000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395243676848000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395244175938000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395244676315000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395245175042000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395245677394000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Approximatively we have 50 elements per slice which looks like what we expected.</p>

<p><em>Please note that there is a short period of warmup where values are less homogenous.</em></p>

<br/>


<h3>Discretization by time slicing keeping track of time</h3>

<p><code>DStream</code> keeps track of all created RDD slices of data (following Spark philosophy to cache as much as possible) and allows to do operation of windowing to redistribute RDD.</p>

<p>With ZPark API, you can write the same as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">500</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">discretizeKeepTime</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">windowRDD</span><span class="o">(</span><span class="mi">1000</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="n">rdd</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="n">rdd</span><span class="o">.</span><span class="n">count</span><span class="o">())</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397573066484000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397571981061000</span><span class="o">,</span><span class="mi">68</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397574069315000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397572981063000</span><span class="o">,</span><span class="mi">85</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397575058895000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397573981072000</span><span class="o">,</span><span class="mi">87</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397576059640000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397574981078000</span><span class="o">,</span><span class="mi">89</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397577069518000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397575981086000</span><span class="o">,</span><span class="mi">89</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397577538941000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397576981095000</span><span class="o">,</span><span class="mi">82</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>We can see here that final interval haven&#8217;t 100 elements as we could expect.
This is still a mystery to me and I must investigate a bit more to know where this differences comes from. I have a few ideas but need to validate.</p>

<p>Anyway, globally we get 500 elements meaning we haven&#8217;t lost anything.</p></blockquote>

<br/>


<h3>Mixing scalaz-stream IO &amp; Spark streaming</h3>

<p>Playing with naturals is funny but let&#8217;s work with a real source of data like a file.</p>

<p>It could be anything pluggable on scalaz-stream like kafka/flume/whatever as <code>DStream</code> provides&#8230;</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">io</span><span class="o">.</span><span class="n">linesR</span><span class="o">(</span><span class="s">&quot;testdata/fahrenheit.txt&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">trim</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">&quot;//&quot;</span><span class="o">))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">toDouble</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">mapRDD</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="mi">1L</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">groupByKey</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="n">mapRDD</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529009755000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">18.0</span><span class="o">,</span><span class="mi">23</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010064000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">19.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010301000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">78.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010501000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">55.3</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010700000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">66.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010892000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">64.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Infusing tee with RDD Processes</h3>

<p>Is it possible to combine RDD Processes using scalaz-stream ?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p0</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">50</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">p1</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">50</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'> <span class="o">(</span><span class="n">p0</span> <span class="n">zipWith</span> <span class="n">p1</span><span class="o">){</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>   <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="nc">UnionRDD</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">))</span>
</span><span class='line'> <span class="o">}.</span><span class="n">countRDDByValue</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464151650000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464151819000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464230343000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464230528000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464477775000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464477921000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">5</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464478034000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">6</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464478143000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464726860000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">8</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464727039000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">7</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975370000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">9</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975511000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975620000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">11</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412465224087000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">12</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412465224227000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">13</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="n">etc</span><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that I drive Spark RDD stream with Scalaz-Stream always remains on the driver node and is never sent to a remote node as map/reduce closures are in Spark. So Scalaz-stream is used a stream driver in this case. Moreover, Scalaz Process isn&#8217;t serializable in its current implementation so it wouldn&#8217;t be possible as is.</p></blockquote>

<br/>


<br/>


<h2>What about persistence &amp; fault tolerance?</h2>

<p>After discretizing a process, you can persist each RDD :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">p</span><span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">mapRDD</span> <span class="o">{</span><span class="err"></span><span class="k">_</span><span class="o">.</span><span class="n">persist</span><span class="o">()</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok but <code>DStream</code> does much more trying to keep in-memory every RDD that is generated and potentially persist it across the cluster. This makes things stateful &amp; mutable which is not the approach of pure functional API like scalaz-stream. So, I need to think a bit more about this persistence topic which is huge.</p>

<p>Anyway I believe I&#8217;m currently investigating another way of manipulating distributed streams than <code>DStream</code>.</p>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Spark is quite amazing and easy to use with respect to the complexity of the subject.</p>

<p>I was also surprised to be able to use it with scalaz-stream so easily.</p>

<p>I hope you liked the idea and I encourage you to think about it and if you find it cool, please tell it! And if you find it stupid, please tell it too: this is still a pure experiment ;)</p>

<p>Have a look at the code on <a href="https://github.com/mandubian/zpark-ztream">Github</a>.</p>

<p>Have distributed &amp; resilient yet continuous fun!</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/01/31/play-rules-shapeless/">New Play 2.3 Validation API : Breaking the 22 Limits With Shapeless</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-01-31T08:08:00+01:00" pubdate data-updated="true">Jan 31<span>st</span>, 2014</time>
        
         | <a href="/2014/01/31/play-rules-shapeless/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/shapeless-rules">Github</a></p>

<p>After 5 months studying theories deeper &amp; deeper on my free-time and preparing 3 talks for <a href="http://www.scala.io">scala.io</a> &amp; <a href="http://www.ping-conf.com">ping-conf</a> with my friend <a href="http://www.twitter.com/skaalf">Julien Tournay aka @skaalf</a>, I&#8217;m back blogging and I&#8217;ve got a few more ideas of articles to come&#8230;</p>

<blockquote><p>If you&#8217;re interested in those talks, you can find pingconf videos here:</p>

<ul>
<li><a href="http://www.ustream.tv/recorded/42778238">Entropic history &amp; Play2.3 new validation API</a></li>
<li><a href="http://www.ustream.tv/recorded/42802705">Play2, scalaz-stream &amp; SciFi</a></li>
</ul>
</blockquote>

<p>Let&#8217;s go back to our today&#8217;s subject : <strong>Incoming Play2.3/Scala generic validation API &amp; more</strong>.</p>

<p><a href="http://www.twitter.com/skaalf">Julien Tournay aka @skaalf</a> has been working a lot for a few months developing this new API and has just published an article previewing <a href="http://jto.github.io/articles/play_new_validation_api/">Play 2.3 generic validation API</a>.</p>

<p>This new API is just the logical extension of play2/Scala Json API (that I&#8217;ve been working &amp; promoting those 2 last years) pushing its principles far further by allowing validation on any data types.</p>

<p>This new API is a real step further as it will progressively propose a common API for all validations in Play2/Scala (Form/Json/XML/&#8230;). It proposes an even more robust design relying on very strong theoretical ground making it very reliable &amp; typesafe.</p>

<p>Julien has written his <a href="http://jto.github.io/articles/play_new_validation_api/">article</a> presenting the new API basics and he also found time to write great documentation for this new validation API. I must confess Json API doc was quite messy but I&#8217;ve never found freetime (and courage) to do better. So I&#8217;m not going to spend time on basic features of this new API and I&#8217;m going to target advanced features to open your minds about the power of this new API.</p>

<blockquote><p>Let&#8217;s have fun with this new APi &amp; <a href="https://github.com/milessabin/shapeless">Shapeless</a>, this fantastic tool for higher-rank polymorphism &amp; type-safety!</p></blockquote>

<br/>


<h2>Warm-up with Higher-kind Zipping of Rules</h2>

<p>A really cool &amp; new feature of Play2.3 generic validation API is its ability to compose validation Rules in chains like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">rule1</span><span class="k">:</span> <span class="kt">Rule</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="k">val</span> <span class="n">rule2</span><span class="k">:</span> <span class="kt">Rule</span><span class="o">[</span><span class="kt">B</span>, <span class="kt">C</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">rule3</span><span class="k">:</span> <span class="kt">Rule</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">C</span><span class="o">]</span> <span class="k">=</span> <span class="n">rule1</span> <span class="n">compose</span> <span class="n">rule2</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>In Play2.1 Json API, you couldn&#8217;t do that (you could only map on Reads).</em></p>

<p>Moreover, with new validation API, as in Json API, you can use macros to create basic validators from case-classes.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">FooBar</span><span class="o">(</span><span class="n">foo</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">bar</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">foo2</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">rule</span> <span class="k">=</span> <span class="nc">Rule</span><span class="o">.</span><span class="n">gen</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">FooBar</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** Action to validate Json:</span>
</span><span class='line'><span class="cm">  * { foo: &quot;toto&quot;, bar: 5, foo2: 2 }</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">def</span> <span class="n">action</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">(</span><span class="n">parse</span><span class="o">.</span><span class="n">json</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">rule</span><span class="o">.</span><span class="n">validate</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">foobar</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="n">foobar</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span> <span class="n">recoverTotal</span> <span class="o">{</span> <span class="n">errors</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">BadRequest</span><span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Great but sometimes not enough as you would like to add custom validations on your class.
For example, you want to verify :</p>

<ul>
<li><code>foo</code> isn&#8217;t empty</li>
<li><code>bar</code> is >5</li>
<li><code>foo2</code> is &lt;10</li>
</ul>


<p>For that you can&#8217;t use the macro and must write your caseclass Rule yourself.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">FooBar</span><span class="o">(</span><span class="n">foo</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">bar</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">foo2</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.data.mapping.json.Rules</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Rules._</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">rule</span> <span class="k">=</span> <span class="nc">From</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span> <span class="o">{</span> <span class="nc">__</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="o">(</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;foo&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">notEmpty</span><span class="o">)</span> <span class="o">~</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;bar&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="n">min</span><span class="o">(</span><span class="mi">5</span><span class="o">))</span> <span class="o">~</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;foo2&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Long</span><span class="o">](</span><span class="n">max</span><span class="o">(</span><span class="mi">10</span><span class="o">))</span>
</span><span class='line'>  <span class="o">)(</span><span class="nc">FooBar</span><span class="o">.</span><span class="n">apply</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Please note the new <code>From[JsValue]</code>: if it were Xml, it would be <code>From[Xml]</code>, genericity requires some more info.</em></p>

<p>Ok that&#8217;s not too hard but sometimes you would like to use first the macro and after those primary type validations, you want to refine with custom validations. Something like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Rule</span><span class="o">.</span><span class="n">gen</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">FooBar</span><span class="o">]</span> <span class="o">+?+?+</span> <span class="o">(</span> <span class="o">(</span><span class="n">notEmpty</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span> <span class="o">+:</span> <span class="o">(</span><span class="n">min</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">])</span> <span class="o">+:</span> <span class="o">(</span><span class="n">min</span><span class="o">(</span><span class="mi">10L</span><span class="o">)</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">Long</span><span class="o">])</span> <span class="o">)</span>
</span><span class='line'><span class="c1">// +?+?+ is a non-existing operator meaning &quot;compose&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you may know, you can&#8217;t do use this <code>+:</code> from Scala <code>Sequence[T]</code> as this list of Rules is typed heterogenously and <code>Rule[I, O]</code> is invariant.</p>

<p>So we are going to use Shapeless heterogenous Hlist for that:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">customRules</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">notEmpty</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="n">min</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">])</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="n">min</span><span class="o">(</span><span class="mi">10L</span><span class="o">)</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">Long</span><span class="o">])</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'><span class="c1">// customRules is inferred Rule[String, String]) :: Rule[Int, Int] :: Rule[Long,Long]</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h4>How to compose <code>Rule[JsValue, FooBar]</code> with <code>Rule[String, String]) :: Rule[Int, Int] :: Rule[Long,Long]</code> ?</h4>

<br/>


<p>We need to convert <code>Rule[JsValue, FooBar]</code> to something like <code>Rule[JsValue, T &lt;: HList]</code>.</p>

<p>Based on Shapeless <code>Generic[T]</code>, we can provide a nice little new conversion API <code>.hlisted</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">rule</span><span class="k">:</span> <span class="kt">Rule</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Int</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Rule</span><span class="o">.</span><span class="n">gen</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">FooBar</span><span class="o">].</span><span class="n">hlisted</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Generic[T]</code> is able to convert any caseclass from Scala from/to Shapeless HList (&amp; CoProduct).</p>

<p>So we can validate a case class with the macro and get a <code>Rule[JsValue, T &lt;: HList]</code> from it.</p>

<br/>


<br/>


<h4>How to compose <code>Rule[JsValue, String :: Int :: Long :: HNil]</code> with <code>Rule[String, String]) :: Rule[Int, Int] :: Rule[Long,Long]</code>?</h4>

<br/>


<p>Again, using Shapeless Polymorphic and HList RightFolder, we can implement a function :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Rule</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span> <span class="o">::</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">Long</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">Rule</span><span class="o">[</span><span class="kt">String</span> <span class="kt">::</span> <span class="kt">Int</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">HNil</span>, <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Int</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>This looks like some higher-kind zip function, let&#8217;s call it <code>HZIP</code>.</p></blockquote>

<br/>


<br/>


<h4>Now, we can compose them&#8230;</h4>

<br/>




<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">ruleZip</span> <span class="k">=</span> <span class="nc">Rule</span><span class="o">.</span><span class="n">gen</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">FooBar</span><span class="o">].</span><span class="n">hlisted</span> <span class="n">compose</span> <span class="n">hzip</span><span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="n">notEmpty</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">])</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="n">min</span><span class="o">(</span><span class="mi">5</span><span class="o">)</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">])</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="n">min</span><span class="o">(</span><span class="mi">10L</span><span class="o">)</span><span class="k">:</span><span class="kt">Rule</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">Long</span><span class="o">])</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Finally, let&#8217;s wire all together in a Play action:</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">hzipper</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">(</span><span class="n">parse</span><span class="o">.</span><span class="n">json</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">ruleZip</span><span class="o">.</span><span class="n">validate</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">foobar</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="n">foobar</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span> <span class="n">recoverTotal</span> <span class="o">{</span> <span class="n">errors</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">BadRequest</span><span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// OK case</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s">&quot;foo&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;bar&quot;</span> <span class="k">:</span> <span class="err">5</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo2&quot;</span> <span class="k">:</span> <span class="err">5</span>
</span><span class='line'><span class="o">}</span> <span class="k">=&gt;</span> <span class="n">toto</span> <span class="o">::</span> <span class="mi">5</span> <span class="o">::</span> <span class="mi">8</span> <span class="o">::</span> <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// KO case</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s">&quot;foo&quot;</span> <span class="k">:</span> <span class="err">&quot;&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;bar&quot;</span> <span class="k">:</span> <span class="err">2</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo2&quot;</span> <span class="k">:</span> <span class="err">12</span>
</span><span class='line'><span class="o">}</span> <span class="k">=&gt;</span> <span class="nc">Failure</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span>
</span><span class='line'>  <span class="o">([</span><span class="err">0</span><span class="o">],</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">max</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="mi">10</span><span class="o">)))),</span>
</span><span class='line'>  <span class="o">([</span><span class="err">1</span><span class="o">],</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">min</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="mi">5</span><span class="o">)))),</span>
</span><span class='line'>  <span class="o">([</span><span class="err">2</span><span class="o">],</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">required</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">())))</span>
</span><span class='line'><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>As you can see, the problem in this approach is that we lose the path of Json.
Anyway, this can give you a few ideas!
Now let&#8217;s do something really useful&#8230;</p></blockquote>

<br/>


<br/>


<h2>Higher-kind Fold of Rules to break the 22 limits</h2>

<p>As in Play2.1 Json API, the new validation API provides an applicative builder which allows the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">(</span><span class="nc">Rule</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">A</span><span class="o">]</span> <span class="o">~</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">~</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">C</span><span class="o">]).</span><span class="n">tupled</span> <span class="k">=&gt;</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">I</span>, <span class="o">(</span><span class="kt">A</span>, <span class="kt">B</span>, <span class="kt">C</span><span class="o">)]</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="nc">Rule</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">A</span><span class="o">]</span> <span class="o">~</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">~</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">C</span><span class="o">])(</span><span class="nc">MyClass</span><span class="o">.</span><span class="n">apply</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">MyClass</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>But, in Play2.1 Json API and also in new validation API, all functional combinators are limited by the famous Scala 22 limits.</p>

<p>In Scala, you <strong>CAN&#8217;T</strong> write :</p>

<ul>
<li>a case-class with >22 fields</li>
<li>a <code>Tuple23</code></li>
</ul>


<p><strong>So you can&#8217;t do <code>Rule[JsValue, A] ~ Rule[JsValue, B] ~ ...</code> more than 22 times.</strong></p>

<p>Nevertheless, sometimes you receive huge JSON with much more than 22 fields in it. Then you have to build more complex models like case-classes embedding case-classes&#8230; Shameful, isn&#8217;t it&#8230;</p>

<p>Let&#8217;s be shameless with Shapeless HList which enables to have unlimited heterogenously typed lists!</p>

<p>So, with HList, we can write :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">bigRule</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo1&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo2&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo3&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo4&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo5&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo6&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo7&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo8&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo9&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo10&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo11&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo12&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo13&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo14&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo15&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo16&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo17&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo18&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo19&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo20&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo21&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo22&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo23&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo25&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo26&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo27&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo28&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo29&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo30&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo31&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo32&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo33&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo34&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo35&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo36&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo37&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo38&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo39&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo40&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo41&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo42&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo43&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo44&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo45&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo46&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo47&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo48&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo49&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo50&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">JsNull.</span><span class="k">type</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// inferred as Rule[JsValue, String] :: Rule[JsValue, String] :: ... :: Rule[JsValue, List[Long]] :: HNil</span>
</span></code></pre></td></tr></table></div></figure>


<p>That&#8217;s cool but we want the <code>::</code> operator to have the same <code>applicative builder behavior as the</code>~/and` operator:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Rule</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">String</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">Long</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Rule</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">Float</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="nc">Rule</span><span class="o">[</span><span class="kt">JsValue</span>, <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">Float</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>This looks like a higher-kind fold so let&#8217;s call that <code>HFOLD</code>.</p></blockquote>

<p>We can build this <code>hfold</code> using Shapeless polymorphic functions &amp; RighFolder.</p>

<p><em>In a next article, I may write about coding such shapeless feature. Meanwhile, you&#8217;ll have to discover the code on <a href="https://github.com/mandubian/shapeless-rules">Github</a> as it&#8217;s a bit hairy but very interesting ;)</em></p>

<p>Gathering everything, we obtain the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/* Rules Folding */</span>
</span><span class='line'><span class="k">val</span> <span class="n">ruleFold</span> <span class="k">=</span> <span class="nc">From</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]{</span> <span class="nc">__</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">hfold</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo1&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo2&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo3&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo4&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo5&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo6&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo7&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo8&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo9&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo10&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo11&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo12&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo13&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo14&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo15&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo16&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo17&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo18&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo19&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo20&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo21&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo22&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo23&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo25&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo26&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo27&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo28&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo29&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo30&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo31&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo32&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo33&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo34&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo35&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo36&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo37&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo38&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo39&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo40&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo41&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo42&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo43&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo44&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo45&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo46&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo47&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo48&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo49&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="o">::</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span>  <span class="o">\</span> <span class="s">&quot;foo50&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">JsNull.</span><span class="k">type</span><span class="o">]</span> <span class="o">::</span>
</span><span class='line'>    <span class="nc">HNil</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s write a play action using this rule:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
<span class='line-number'>106</span>
<span class='line-number'>107</span>
<span class='line-number'>108</span>
<span class='line-number'>109</span>
<span class='line-number'>110</span>
<span class='line-number'>111</span>
<span class='line-number'>112</span>
<span class='line-number'>113</span>
<span class='line-number'>114</span>
<span class='line-number'>115</span>
<span class='line-number'>116</span>
<span class='line-number'>117</span>
<span class='line-number'>118</span>
<span class='line-number'>119</span>
<span class='line-number'>120</span>
<span class='line-number'>121</span>
<span class='line-number'>122</span>
<span class='line-number'>123</span>
<span class='line-number'>124</span>
<span class='line-number'>125</span>
<span class='line-number'>126</span>
<span class='line-number'>127</span>
<span class='line-number'>128</span>
<span class='line-number'>129</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">hfolder</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">(</span><span class="n">parse</span><span class="o">.</span><span class="n">json</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">ruleFold</span><span class="o">.</span><span class="n">validate</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">hl</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="n">hl</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span> <span class="n">recoverTotal</span> <span class="o">{</span> <span class="n">errors</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">BadRequest</span><span class="o">(</span><span class="n">errors</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// OK</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s">&quot;foo1&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto1</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo2&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto2</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo3&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto3</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo4&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto4</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo5&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto5</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo6&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto6</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo7&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto7</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo8&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto8</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo9&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto9</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo10&quot;</span> <span class="k">:</span> <span class="err">10</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo11&quot;</span> <span class="k">:</span> <span class="err">11</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo12&quot;</span> <span class="k">:</span> <span class="err">12</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo13&quot;</span> <span class="k">:</span> <span class="err">13</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo14&quot;</span> <span class="k">:</span> <span class="err">14</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo15&quot;</span> <span class="k">:</span> <span class="err">15</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo16&quot;</span> <span class="k">:</span> <span class="err">16</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo17&quot;</span> <span class="k">:</span> <span class="err">17</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo18&quot;</span> <span class="k">:</span> <span class="err">18</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo19&quot;</span> <span class="k">:</span> <span class="err">19</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo20&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo21&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo22&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo23&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo24&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo25&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo26&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo27&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo28&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo29&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo30&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo31&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">1</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo32&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">2</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo33&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">3</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo34&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">4</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo35&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">5</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo36&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">6</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo37&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">7</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo38&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">8</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo39&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">9</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo40&quot;</span> <span class="k">:</span> <span class="err">[1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo41&quot;</span> <span class="k">:</span> <span class="err">[11</span><span class="o">,</span><span class="mi">21</span><span class="o">,</span><span class="mi">31</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo42&quot;</span> <span class="k">:</span> <span class="err">[12</span><span class="o">,</span><span class="mi">22</span><span class="o">,</span><span class="mi">32</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo43&quot;</span> <span class="k">:</span> <span class="err">[13</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">33</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo44&quot;</span> <span class="k">:</span> <span class="err">[14</span><span class="o">,</span><span class="mi">24</span><span class="o">,</span><span class="mi">34</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo45&quot;</span> <span class="k">:</span> <span class="err">[15</span><span class="o">,</span><span class="mi">25</span><span class="o">,</span><span class="mi">35</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo46&quot;</span> <span class="k">:</span> <span class="err">[16</span><span class="o">,</span><span class="mi">26</span><span class="o">,</span><span class="mi">36</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo47&quot;</span> <span class="k">:</span> <span class="err">[17</span><span class="o">,</span><span class="mi">27</span><span class="o">,</span><span class="mi">37</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo48&quot;</span> <span class="k">:</span> <span class="err">[18</span><span class="o">,</span><span class="mi">28</span><span class="o">,</span><span class="mi">38</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo49&quot;</span> <span class="k">:</span> <span class="err">[19</span><span class="o">,</span><span class="mi">29</span><span class="o">,</span><span class="mi">39</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo50&quot;</span> <span class="k">:</span> <span class="kt">null</span>
</span><span class='line'><span class="o">}</span> <span class="k">=&gt;</span> <span class="n">toto1</span> <span class="o">::</span> <span class="n">toto2</span> <span class="o">::</span> <span class="n">toto3</span> <span class="o">::</span> <span class="n">toto4</span> <span class="o">::</span> <span class="n">toto5</span> <span class="o">::</span> <span class="n">toto6</span> <span class="o">::</span> <span class="n">toto7</span> <span class="o">::</span> <span class="n">toto8</span> <span class="o">::</span> <span class="n">toto9</span> <span class="o">::</span>
</span><span class='line'>  <span class="mi">10</span> <span class="o">::</span> <span class="mi">11</span> <span class="o">::</span> <span class="mi">12</span> <span class="o">::</span> <span class="mi">13</span> <span class="o">::</span> <span class="mi">14</span> <span class="o">::</span> <span class="mi">15</span> <span class="o">::</span> <span class="mi">16</span> <span class="o">::</span> <span class="mi">17</span> <span class="o">::</span> <span class="mi">18</span> <span class="o">::</span> <span class="mi">19</span> <span class="o">::</span>
</span><span class='line'>  <span class="kc">true</span> <span class="o">::</span> <span class="kc">false</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="kc">false</span> <span class="o">::</span> <span class="kc">false</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="kc">false</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="kc">false</span> <span class="o">::</span>
</span><span class='line'>  <span class="mf">3.0</span> <span class="o">::</span> <span class="mf">3.1</span> <span class="o">::</span> <span class="mf">3.2</span> <span class="o">::</span> <span class="mf">3.3</span> <span class="o">::</span> <span class="mf">3.4</span> <span class="o">::</span> <span class="mf">3.5</span> <span class="o">::</span> <span class="mf">3.6</span> <span class="o">::</span> <span class="mf">3.7</span> <span class="o">::</span> <span class="mf">3.8</span> <span class="o">::</span> <span class="mf">3.9</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span> <span class="o">::</span> <span class="nc">List</span><span class="o">(</span><span class="mi">11</span><span class="o">,</span> <span class="mi">21</span><span class="o">,</span> <span class="mi">31</span><span class="o">)</span> <span class="o">::</span> <span class="nc">List</span><span class="o">(</span><span class="mi">12</span><span class="o">,</span> <span class="mi">22</span><span class="o">,</span> <span class="mi">32</span><span class="o">)</span> <span class="o">::</span> <span class="nc">List</span><span class="o">(</span><span class="mi">13</span><span class="o">,</span> <span class="mi">23</span><span class="o">,</span> <span class="mi">33</span><span class="o">)</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">List</span><span class="o">(</span><span class="mi">14</span><span class="o">,</span> <span class="mi">24</span><span class="o">,</span> <span class="mi">34</span><span class="o">)</span> <span class="o">::</span> <span class="nc">List</span><span class="o">(</span><span class="mi">15</span><span class="o">,</span> <span class="mi">25</span><span class="o">,</span> <span class="mi">35</span><span class="o">)</span> <span class="o">::</span> <span class="nc">List</span><span class="o">(</span><span class="mi">16</span><span class="o">,</span> <span class="mi">26</span><span class="o">,</span> <span class="mi">36</span><span class="o">)</span> <span class="o">::</span> <span class="nc">List</span><span class="o">(</span><span class="mi">17</span><span class="o">,</span> <span class="mi">27</span><span class="o">,</span> <span class="mi">37</span><span class="o">)</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">List</span><span class="o">(</span><span class="mi">18</span><span class="o">,</span> <span class="mi">28</span><span class="o">,</span> <span class="mi">38</span><span class="o">)</span> <span class="o">::</span> <span class="nc">List</span><span class="o">(</span><span class="mi">19</span><span class="o">,</span> <span class="mi">29</span><span class="o">,</span> <span class="mi">39</span><span class="o">)</span> <span class="o">::</span> <span class="kc">null</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// KO</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s">&quot;foo1&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto1</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo2&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto2</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo3&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto3</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo4&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto4</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo5&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto5</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo6&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto6</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo7&quot;</span> <span class="k">:</span> <span class="err">50</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo8&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto8</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo9&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto9</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo10&quot;</span> <span class="k">:</span> <span class="err">10</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo11&quot;</span> <span class="k">:</span> <span class="err">11</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo12&quot;</span> <span class="k">:</span> <span class="err">12</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo13&quot;</span> <span class="k">:</span> <span class="err">13</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo14&quot;</span> <span class="k">:</span> <span class="err">14</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo15&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo16&quot;</span> <span class="k">:</span> <span class="err">16</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo17&quot;</span> <span class="k">:</span> <span class="err">17</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo18&quot;</span> <span class="k">:</span> <span class="err">18</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo19&quot;</span> <span class="k">:</span> <span class="err">19</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo20&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo21&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo22&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo23&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo24&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo25&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo26&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo27&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">chboing</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo28&quot;</span> <span class="k">:</span> <span class="kt">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo29&quot;</span> <span class="k">:</span> <span class="kt">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo30&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo31&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">1</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo32&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">2</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo33&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">3</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo34&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">4</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo35&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">5</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo36&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">6</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo37&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">7</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo38&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">8</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo39&quot;</span> <span class="k">:</span> <span class="err">3</span><span class="kt">.</span><span class="err">9</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo40&quot;</span> <span class="k">:</span> <span class="err">[1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo41&quot;</span> <span class="k">:</span> <span class="err">[11</span><span class="o">,</span><span class="mi">21</span><span class="o">,</span><span class="mi">31</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo42&quot;</span> <span class="k">:</span> <span class="err">[12</span><span class="o">,</span><span class="mi">22</span><span class="o">,</span><span class="mi">32</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo43&quot;</span> <span class="k">:</span> <span class="err">[13</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">33</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo44&quot;</span> <span class="k">:</span> <span class="err">[14</span><span class="o">,</span><span class="mi">24</span><span class="o">,</span><span class="mi">34</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo45&quot;</span> <span class="k">:</span> <span class="err">[15</span><span class="o">,</span><span class="mi">25</span><span class="o">,</span><span class="mi">35</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo46&quot;</span> <span class="k">:</span> <span class="err">[16</span><span class="o">,</span><span class="mi">26</span><span class="o">,</span><span class="s">&quot;blabla&quot;</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo47&quot;</span> <span class="k">:</span> <span class="err">[17</span><span class="o">,</span><span class="mi">27</span><span class="o">,</span><span class="mi">37</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo48&quot;</span> <span class="k">:</span> <span class="err">[18</span><span class="o">,</span><span class="mi">28</span><span class="o">,</span><span class="mi">38</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo49&quot;</span> <span class="k">:</span> <span class="err">[19</span><span class="o">,</span><span class="mi">29</span><span class="o">,</span><span class="mi">39</span><span class="err">]</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;foo50&quot;</span> <span class="k">:</span> <span class="err">&quot;</span><span class="kt">toto</span><span class="err">&quot;</span>
</span><span class='line'><span class="o">}</span> <span class="k">=&gt;</span> <span class="nc">Failure</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span>
</span><span class='line'>  <span class="o">(/</span><span class="n">foo50</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">invalid</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="kc">null</span><span class="o">)))),</span>
</span><span class='line'>  <span class="o">(/</span><span class="n">foo46</span><span class="o">[</span><span class="err">2</span><span class="o">],</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">number</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="nc">Long</span><span class="o">)))),</span>
</span><span class='line'>  <span class="o">(/</span><span class="n">foo27</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">invalid</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="nc">Boolean</span><span class="o">)))),</span>
</span><span class='line'>  <span class="o">(/</span><span class="n">foo15</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">number</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="nc">Int</span><span class="o">)))),</span>
</span><span class='line'>  <span class="o">(/</span><span class="n">foo7</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="n">invalid</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="nc">String</span><span class="o">))</span>
</span><span class='line'><span class="o">))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Awesome&#8230; now, nobody can say 22 limits is still a problem ;)</p>

<p>Have a look at the code on <a href="https://github.com/mandubian/shapeless-rules">Github</a>.</p>

<p>Have fun x 50!</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/09/22/play-actor-room/">Play 2.2 Actor Room: Websocket (&more) Room Manager Only With Actors</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-22T17:17:00+02:00" pubdate data-updated="true">Sep 22<span>nd</span>, 2013</time>
        
         | <a href="/2013/09/22/play-actor-room/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The code &amp; sample apps can be found on Github <a href="https://github.com/mandubian/play-actor-room">here</a></p>

<br/>




<div class="well">
<b>Actor-Room</b> makes it easy to:

<ul>
  <li>create any group of connected entities (people or not) (chatroom, forum, broadcast pivot&#8230;).</li>
  <li>manage connections, disconnections, broadcast, targetted message through actor and nothing else.</li>
</ul>

For now, members can be:
<ul>
  <li>websocket endpoints through actors without taking care of Iteratees/Enumerators&#8230;</li>
  <li>Bots to simulate members</li>
</ul>
</div>




<br/>


<h2>Reminders on websockets in Play</h2>

<p>Here is the function Play provides to create a websocket:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">async</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span>
</span><span class='line'>  <span class="n">f</span><span class="k">:</span> <span class="kt">RequestHeader</span> <span class="o">=&gt;</span> <span class="nc">Future</span><span class="o">[(</span><span class="kt">Iteratee</span><span class="o">[</span><span class="kt">A</span>, <span class="k">_</span><span class="o">]</span>, <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">A</span><span class="o">])]</span>
</span><span class='line'><span class="o">)(</span><span class="k">implicit</span> <span class="n">frameFormatter</span><span class="k">:</span> <span class="kt">FrameFormatter</span><span class="o">[</span><span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">WebSocket</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>A websocket is a persistent bi-directional channel of communication (in/out) and is created with:</p>

<ul>
<li>an <code>Iteratee[A, _]</code> to manage all frames received by the websocket endpoint</li>
<li>an <code>Enumerator[A]</code> to send messages through the websocket</li>
<li>an implicit <code>FrameFormatter[A]</code> to parse frame content to type <code>A</code> (Play provides default FrameFormatter for String or JsValue)</li>
</ul>


<p>Here is how you traditionally create a websocket endpoint in Play:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">MyController</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">connect</span> <span class="k">=</span> <span class="nc">Websocket</span><span class="o">.</span><span class="n">async</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]{</span> <span class="n">rh</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// the iteratee to manage received messages</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">iteratee</span> <span class="k">=</span> <span class="nc">Iteratee</span><span class="o">.</span><span class="n">foreach</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span> <span class="n">js</span> <span class="k">=&gt;</span> <span class="o">...)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// the enumerator to be able to send messages</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">enumerator</span> <span class="k">=</span> <span class="c1">// generally a PushEnumerator</span>
</span><span class='line'>        <span class="o">(</span><span class="n">iteratee</span><span class="o">,</span> <span class="n">enumerator</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Generally, the <code>Enumerator[A]</code> is created using <code>Concurrent.broadcast[A]</code> and <code>Concurrent.unicast[A]</code> which are very powerful tools but not so easy to understand exactly (the edge-cases of connection close, errors are always tricky).</p>

<p>You often want to:</p>

<ul>
<li>manage multiple client connections at the same time</li>
<li>parse messages received from websockets,</li>
<li>do something with the message payload</li>
<li>send messages to a given client</li>
<li>broadcast messages to all connected members</li>
<li>create bots to be able to simulate fake connected members</li>
<li>etc&#8230;</li>
</ul>


<p>To do that in Play non-blocking/async architecture, you often end developing an Actor topology managing all events/messages on top of the previous <code>Iteratee/Enumerator</code>.</p>

<p>The <code>Iteratee/Enumerator</code> is quite generic but always not so easy to write.</p>

<p>The actor topology is quite generic because there are administration messages that are almost always the same:</p>

<ul>
<li>Connection/Forbidden/Disconnection</li>
<li>Broadcast/Send</li>
</ul>


<br/>


<blockquote><p><strong>Actor Room</strong> is a helper managing all of this for you.
So you can just focus on message management using actors and nothing else. It provides all default behaviors and all behaviors can be overriden if needed. It exposes only actors and nothing else.</p></blockquote>

<br/>


<p><em>The code is based on the chatroom sample (and a cool sample by Julien Tournay) from Play Framework pushed far further and in a more generic way.</em></p>

<br/>


<br/>


<h2>What is Actor Room?</h2>

<p>An actor room manages a group of connected members which are supervised by a supervisor</p>

<h3>Member = 2 actors (receiver/sender)</h3>

<p>Each member is represented by 2 actors (1 receiver &amp; 1 sender):</p>

<ul>
<li><p><strong>You MUST create at least a Receiver Actor because it&#8217;s your job to manage your own message format</strong></p></li>
<li><p>The Sender Actor has a default implementation but you can override it.</p></li>
</ul>


<br/>


<h3>Supervisor = 1 actor</h3>

<p>All actors are managed by 1 supervisor which have two roles:</p>

<ul>
<li><p>Creates/supervises all receiver/sender actors</p></li>
<li><p>Manages administration messages (routing, forwarding, broadcasting etc&#8230;)</p></li>
</ul>


<br/>


<br/>


<h1>Code sample step by step</h1>

<h2>Create the Actor Room</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// default constructor</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">room</span> <span class="k">=</span> <span class="nc">Room</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// constructor with custom supervisor</span>
</span><span class='line'>  <span class="c1">// custom supervisor are described later</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">room</span> <span class="k">=</span> <span class="nc">Room</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="n">classOf</span><span class="o">[</span><span class="kt">CustomSupervisor</span><span class="o">]))</span>
</span></code></pre></td></tr></table></div></figure>


<p>The room creates the Supervisor actor for you and delegates the creation of receiver/sender actors to it.</p>

<p>If you want to broadcast a message or target a precise member, you should use the supervisor.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">room</span><span class="o">.</span><span class="n">supervisor</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="s">&quot;fromId&quot;</span><span class="o">,</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;bar&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="n">room</span><span class="o">.</span><span class="n">supervisor</span> <span class="o">!</span> <span class="nc">Send</span><span class="o">(</span><span class="s">&quot;fromId&quot;</span><span class="o">,</span> <span class="s">&quot;toId&quot;</span><span class="o">,</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;bar&quot;</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>You can manage several rooms in the same project.</p></blockquote>

<br/>


<h2>Create the mandatory Receiver Actor</h2>

<p>There is only one message to manage:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Message received and parsed to type A</span>
</span><span class='line'><span class="cm">  * @param from the ID of the sender</span>
</span><span class='line'><span class="cm">  * @param payload the content of the message</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Received</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">from</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">payload</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Message</span>
</span></code></pre></td></tr></table></div></figure>


<p>If your websocket frames contain Json, then it should be <code>Received[JsValue]</code>.</p>

<p>You just have to create a simple actor:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Create an actor to receive messages from websocket</span>
</span><span class='line'><span class="k">class</span> <span class="nc">Receiver</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Received(fromId, js) is the only Message to manage in receiver</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Received</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">js</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="o">(</span><span class="n">js</span> <span class="o">\</span> <span class="s">&quot;msg&quot;</span><span class="o">).</span><span class="n">asOpt</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="n">play</span><span class="o">.</span><span class="nc">Logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;couldn&#39;t msg in websocket event&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="n">play</span><span class="o">.</span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;received $s&quot;</span><span class="o">)</span>
</span><span class='line'>          <span class="c1">// broadcast message to all connected members</span>
</span><span class='line'>          <span class="n">context</span><span class="o">.</span><span class="n">parent</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;msg&quot;</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">))</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note the Receiver Actor is supervised by the <code>Supervisor</code> actor. So, within the Receiver Actor, <code>context.parent</code> is the <code>Supervisor</code> and you can use it to send/broadcast message as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">context</span><span class="o">.</span><span class="n">parent</span> <span class="o">!</span> <span class="nc">Send</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">toId</span><span class="o">,</span> <span class="n">mymessage</span><span class="o">)</span>
</span><span class='line'><span class="n">context</span><span class="o">.</span><span class="n">parent</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="n">fromId</span><span class="o">,</span> <span class="n">mymessage</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The 2 messages</span>
</span><span class='line'><span class="cm">/** Sends a message from a member to another member */</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span>   <span class="nc">Send</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">from</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">payload</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Message</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** Broadcasts a message from a member */</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span>   <span class="nc">Broadcast</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">from</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">payload</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Message</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Create your Json websocket endpoint</h2>

<p>Please note that each member is identified by a string that you define yourself.</p>

<p>import org.mandubian.actorroom._</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">Receiver</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Application</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">room</span> <span class="k">=</span> <span class="nc">Room</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/** websocket requires :</span>
</span><span class='line'><span class="cm">    * - the type of the Receiver actor</span>
</span><span class='line'><span class="cm">    * - the type of the payload</span>
</span><span class='line'><span class="cm">    */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">connect</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">room</span><span class="o">.</span><span class="n">websocket</span><span class="o">[</span><span class="kt">Receiver</span>, <span class="kt">JsValue</span><span class="o">](</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// or</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">connect</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">room</span><span class="o">.</span><span class="n">websocket</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span><span class="n">id</span><span class="o">,</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">Receiver</span><span class="o">])</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>All together</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">akka.actor._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.mvc._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Implicits</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.Play.current</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.concurrent.Execution.Implicits._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">org.mandubian.actorroom._</span>
</span><span class='line'>
</span><span class='line'><span class="k">class</span> <span class="nc">Receiver</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Received</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">js</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="o">(</span><span class="n">js</span> <span class="o">\</span> <span class="s">&quot;msg&quot;</span><span class="o">).</span><span class="n">asOpt</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="n">play</span><span class="o">.</span><span class="nc">Logger</span><span class="o">.</span><span class="n">error</span><span class="o">(</span><span class="s">&quot;couldn&#39;t msg in websocket event&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="n">play</span><span class="o">.</span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;received $s&quot;</span><span class="o">)</span>
</span><span class='line'>          <span class="n">context</span><span class="o">.</span><span class="n">parent</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;msg&quot;</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">))</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Application</span> <span class="k">extends</span> <span class="nc">Controller</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">room</span> <span class="k">=</span> <span class="nc">Room</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">websocket</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">room</span><span class="o">.</span><span class="n">websocket</span><span class="o">[</span><span class="kt">Receiver</span>, <span class="kt">JsValue</span><span class="o">](</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h1>Extend default behaviors</h1>

<h2>Override the administration message format</h2>

<p><code>AdminMsgFormatter</code> typeclass is used by ActorRoom to format administration messages (Connected, Disconnected and Error) by default.</p>

<p><code>AdminMsgFormatter[JsValue]</code> and <code>AdminMsgFormatter[String]</code> are provided by default.</p>

<p>You can override the format as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// put this implicit in the same scope where you create your websocket endpoint</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">msgFormatter</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">AdminMsgFormatter</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]{</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">connected</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;kind&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;connected&quot;</span><span class="o">,</span> <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">disconnected</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;kind&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;disconnected&quot;</span><span class="o">,</span> <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">error</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">msg</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;kind&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;error&quot;</span><span class="o">,</span> <span class="s">&quot;id&quot;</span> <span class="o">-&gt;</span> <span class="n">id</span><span class="o">,</span> <span class="s">&quot;msg&quot;</span> <span class="o">-&gt;</span> <span class="n">msg</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// then this msgFormatter will be used for all administration messages  </span>
</span><span class='line'><span class="k">def</span> <span class="n">websocket</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">room</span><span class="o">.</span><span class="n">websocket</span><span class="o">[</span><span class="kt">Receiver</span>, <span class="kt">JsValue</span><span class="o">](</span><span class="n">id</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Override the Sender Actor</h2>

<p>You just have to create a new actor as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">MyCustomSender</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">Send</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span>        <span class="k">=&gt;</span> <span class="c1">// message send from a member to another one</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="n">b</span><span class="k">:</span> <span class="kt">Broadcast</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span>   <span class="k">=&gt;</span> <span class="c1">// message broadcast by a member</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Connected</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>           <span class="k">=&gt;</span> <span class="c1">// member &quot;id&quot; has connected</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Disconnected</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>        <span class="k">=&gt;</span> <span class="c1">// member &quot;id&quot; has disconnected</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Init</span><span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">receiverActor</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="c1">// Message sent when sender actor is initialized by ActorRoom</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you must initialize your websocket with it</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">connect</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="n">room</span><span class="o">.</span><span class="n">websocket</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span><span class="k">_</span> <span class="k">=&gt;</span> <span class="n">id</span><span class="o">,</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">Receiver</span><span class="o">],</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">MyCustomSender</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can override the following messages:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// public sender messages</span>
</span><span class='line'><span class="cm">/** Sender actor is initialized by Supervisor */</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span>   <span class="nc">Init</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">receiverActor</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** Sends a message from a member to another member */</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span>   <span class="nc">Send</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">from</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">to</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">payload</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Message</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** Broadcasts a message from a member */</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span>   <span class="nc">Broadcast</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">from</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">payload</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Message</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** member with ID has connected */</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span>   <span class="nc">Connected</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Message</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** member with ID has disconnected */</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span>   <span class="nc">Disconnected</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Message</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Override the Supervisor Actor</h2>

<p>Please note <code>Supervisor</code> is an actor which manages a internal state containing all members:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">var</span> <span class="n">members</span> <span class="k">=</span> <span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Member</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can override the default Supervisor as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">class</span> <span class="nc">CustomSupervisor</span> <span class="k">extends</span> <span class="nc">Supervisor</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">customBroadcast</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">js</span><span class="k">:</span> <span class="kt">JsObject</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// adds members to all messages</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">ids</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;members&quot;</span> <span class="o">-&gt;</span> <span class="n">members</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">_1</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">members</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span>
</span><span class='line'>          <span class="k">case</span> <span class="o">(</span><span class="n">id</span><span class="o">,</span> <span class="n">member</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>            <span class="n">member</span><span class="o">.</span><span class="n">sender</span> <span class="o">!</span> <span class="nc">Broadcast</span><span class="o">(</span><span class="n">from</span><span class="o">,</span> <span class="n">js</span> <span class="o">++</span> <span class="n">ids</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>          <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">override</span> <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="n">customBroadcast</span> <span class="n">orElse</span> <span class="k">super</span><span class="o">.</span><span class="n">receive</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Create a bot to simulate member</h2>

<p>A bot is a fake member that you can use to communicate with other members. It&#8217;s identified by an ID as any member.</p>

<p>You create a bot with these API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Member</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="k">val</span> <span class="n">receiver</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="k">val</span> <span class="n">sender</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Message</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">bot</span><span class="o">[</span><span class="kt">Payload</span><span class="o">](</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>    <span class="o">(</span><span class="k">implicit</span> <span class="n">msgFormatter</span><span class="k">:</span> <span class="kt">AdminMsgFormatter</span><span class="o">[</span><span class="kt">Payload</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Member</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">bot</span><span class="o">[</span><span class="kt">Payload</span><span class="o">](</span>
</span><span class='line'>    <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>    <span class="n">senderProps</span><span class="k">:</span> <span class="kt">Props</span>
</span><span class='line'>  <span class="o">)(</span><span class="k">implicit</span> <span class="n">msgFormatter</span><span class="k">:</span> <span class="kt">AdminMsgFormatter</span><span class="o">[</span><span class="kt">Payload</span><span class="o">])</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Member</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">bot</span><span class="o">[</span><span class="kt">Payload</span><span class="o">](</span>
</span><span class='line'>    <span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>    <span class="n">receiverProps</span><span class="k">:</span> <span class="kt">Props</span><span class="o">,</span>
</span><span class='line'>    <span class="n">senderProps</span><span class="k">:</span> <span class="kt">Props</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Member</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then with returned <code>Member</code>, you can simulate messages:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">room</span> <span class="k">=</span> <span class="nc">Room</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">bot</span> <span class="k">=</span> <span class="n">room</span><span class="o">.</span><span class="n">bot</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span><span class="s">&quot;robot&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// simulate a received message</span>
</span><span class='line'><span class="n">bot</span><span class="o">.</span><span class="n">receiver</span> <span class="o">!</span> <span class="nc">Received</span><span class="o">(</span><span class="n">bod</span><span class="o">.</span><span class="n">id</span><span class="o">,</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;bar&quot;</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Naturally, you can override the Bot Sender Actor</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** The default actor sender for Bots */</span>
</span><span class='line'><span class="k">class</span> <span class="nc">BotSender</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">s</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="n">play</span><span class="o">.</span><span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;Bot should have sent ${s}&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">bot</span> <span class="k">=</span> <span class="n">room</span><span class="o">.</span><span class="n">bot</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span><span class="s">&quot;robot&quot;</span><span class="o">,</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">BotSender</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>So what else???
Everything you can override and everything that I didn&#8217;t implement yet&#8230;</p>

<p>On <a href="https://github.com/mandubian/play-actor-room/tree/master/samples">github project</a>, you will find 2 samples:</p>

<ul>
<li><code>simplest</code> which is a very simple working sample.</li>
<li><code>websocket-chat</code> which is just the Play Framework ChatRoom sample rewritten with <code>ActorRoom</code>.</li>
</ul>


<p>Have fun!</p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/08/21/playztream/">Scalaz-Stream Plug&#8217;n&#8217;Play2 Iteratee/WS + Recursive Streaming</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-21T23:23:00+02:00" pubdate data-updated="true">Aug 21<span>st</span>, 2013</time>
        
         | <a href="/2013/08/21/playztream/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The code for all autosources &amp; sample apps can be found on Github <a href="https://github.com/mandubian/playzstream">here</a></p>

<blockquote><p>The aim of this article is to show how <a href="https://github.com/scalaz/scalaz-stream">scalaz-stream</a> could be plugged on existing Play Iteratee/Enumerator and used in your web projects. I also wanted to evaluate in depth the power of <a href="https://github.com/scalaz/scalaz-stream">scalaz-stream</a> <em>Processes</em> by trying to write a recursive streaming action: I mean a web endpoint streaming data and re-injecting its own streamed data in itself.</p></blockquote>

<br/>


<blockquote><p>If you want to see now how scalaz-stream is used with Play, go to <a href="#plug-n-play">this paragraph</a> directly.</p></blockquote>

<br/>


<h2>Why Scalaz-Stream when you have Play Iteratees?</h2>

<br/>


<h3>Play Iteratees are powerful &amp; cool but&#8230;</h3>

<p>I&#8217;m a fan of everything dealing with data streaming and realtime management in backends. I&#8217;ve worked a lot on <a href="http://www.playframework.org">Play Framework</a> and naturally I&#8217;ve been using the cornerstone behind Play&#8217;s reactive nature: <em>Play Iteratees</em>.</p>

<p><em>Iteratees</em> (with its counterparts, <em>Enumerators</em> and <em>Enumeratees</em>) are great to <strong>manipulate/transform linear streams of data chunks</strong> in a very <strong>reactive</strong> (non-blocking &amp; asynchronous) and purely <strong>functional</strong> way:</p>

<ul>
<li><strong>Enumerators</strong> identifies the <strong>data producer</strong> that can generate finite/infinite/procedural data streams.</li>
<li><strong>Iteratee</strong> is simply a <strong>data folder built as a state machine</strong> based on 3 states (Continue, Done, Error) which consumes data from Enumerator to compute a final result.</li>
<li><strong>Enumeratee</strong> is a kind of <strong>transducer</strong> able to adapt an Enumerator producing some type of data to an Iteratee that expects other type of data. Enumeratee can be used as both a pipe transformer and adapter.</li>
</ul>


<p>Iteratee is really powerful but I must say I&#8217;ve always found them quite picky to use, practically speaking. In Play, they are used in their best use-case and they were created for that exactly. <strong>I&#8217;ve been using Iteratees for more than one year now but I still don&#8217;t feel fluent with them</strong>. Each time I use them, I must spend some time to know how I could write what I need. It&#8217;s not because they are purely functional (piping an Enumerator into an Enumeratee into an Iteratee is quite trivial) but there is something that my brain doesn&#8217;t want to catch.</p>

<blockquote><p>If you want more details about my experience with Iteratees, go to <a href="#iteratee-details">this paragraph</a></p></blockquote>

<p>That&#8217;s why <strong>I wanted to work with other functional streaming tools to see if they suffer the same kind of usability toughness</strong> or can bring something more natural to me. There are lots of other competitors on the field such as <strong>pipes</strong>, <strong>conduits</strong> and <strong>machines</strong>. As I don&#8217;t have physical time to study all of them in depth, I&#8217;ve chosen the one that appealed me the most i.e. Machines.</p>

<blockquote><p>I&#8217;m not yet a Haskell coder even if I can mumble it so I preferred to evaluate the concept with <a href="https://github.com/scalaz/scalaz-stream">scalaz-stream</a>, a Scala implementation trying to bring machines to <em>normal</em> coders focusing on the aspect of IO streaming.</p></blockquote>

<br/>


<br/>


<h2>Scratching the concepts of Machine / Process ?</h2>

<blockquote><p>I&#8217;m not going to judge if Machines are better or not than Iteratees, this is not my aim. I&#8217;m just experimenting the concept in an objective way.</p></blockquote>

<p>I won&#8217;t explain the concept of Machines in depth because it&#8217;s huge and I don&#8217;t think I have the theoretical background to do it right now. So, let&#8217;s focus on very basic ideas at first:</p>

<ul>
<li><em>Machine</em> is a very generic concept that represents <strong>a data processing mechanism with potential multiple inputs, an output and monadic effects</strong> (typically Future input chunks, side-effects while transforming, delayed output&#8230;)</li>
<li>To simplify, let say a machine is <strong>a bit like a mechano that you construct by plugging together other more generic machines</strong> (such as source, transducer, sink, tee, wye) as simply as pipes.</li>
<li>Building a machine also means <strong>planning all the steps you will go through when managing streamed data but it doesn&#8217;t do anything until you run it</strong> (no side-effect, no resource consumption). You can re-run a machine as many times as you want.</li>
<li>A machine is a <strong>state machine</strong> (Emit/Await/Halt) as Iteratee but it manages error in a more explicit way IMHO (fallback/error)</li>
</ul>


<p>In <a href="https://github.com/scalaz/scalaz-stream">scalaz-stream</a>, you don&#8217;t manipulate machines which are too abstract for real-life use-cases but you manipulate simpler concepts:</p>

<ul>
<li><code>Process[M, O]</code> is a restricted machine outputting a stream of <code>O</code>. It can be a source if the monadic effect gets input from I/O or generates procedural data, or a sink if you don&#8217;t care about the output. <em>Please note that it doesn&#8217;t infer the type of potential input at all</em>.</li>
<li><code>Wye[L, R, O]</code> is a machine that takes 2 inputs (left <code>L</code> / right <code>R</code>) and outputs chunks of type <code>O</code> (you can read from left or right or wait for both before ouputting)</li>
<li><code>Tee[L, R, O]</code> is a Wye that can only read alternatively from left or from right but not from both at the same time.</li>
<li><code>Process1[I, O]</code> can be seen as a transducer which accepts inputs of type <code>I</code> and outputs chunks of type <code>O</code> (a bit like Enumeratee)</li>
<li><code>Channel[M, I, O]</code> is an effectul channel that accepts input of type <code>I</code> and use it in a monadic effect <code>M</code> to produce potential <code>O</code></li>
</ul>


<br/>


<h3>What I find attractive in Machines?</h3>

<ul>
<li>Machines is <strong>producer/consumer/transducer in the same place</strong> and Machines can consume/fold as Iteratee, transform as Enumeratee and emit as Enumerator at the same time and it opens lots of possibilities (even if 3 concepts in one could make it more complicated too).</li>
<li>I feel like <strong>playing with legos as you plug machines on machines</strong> and this is quite funny actually.</li>
<li>Machines manages <strong>monadic effects in its design</strong> and doesn&#8217;t infer the type of effect so you can use it with I/O, Future and whatever you can imagine that is monadic&#8230;</li>
<li>Machines provide out-of-the-box <strong>Tee/Wye to compose streams</strong>, interleave, zip them as you want without writing crazy code.</li>
<li>The early code samples I&#8217;ve seen were quite easy to read (even the implementation is not so complex). Have a look at the <code>StartHere</code> sample provided by scalaz-stream:</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">property</span><span class="o">(</span><span class="s">&quot;simple file I/O&quot;</span><span class="o">)</span> <span class="k">=</span> <span class="n">secure</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">converter</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>      <span class="n">io</span><span class="o">.</span><span class="n">linesR</span><span class="o">(</span><span class="s">&quot;testdata/fahrenheit.txt&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">trim</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">&quot;//&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">fahrenheitToCelsius</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="n">toDouble</span><span class="o">).</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">pipe</span><span class="o">(</span><span class="n">process1</span><span class="o">.</span><span class="n">utf8Encode</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="n">io</span><span class="o">.</span><span class="n">fileChunkW</span><span class="o">(</span><span class="s">&quot;testdata/celsius.txt&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">converter</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>    <span class="kc">true</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>But don&#8217;t think everything is so simple, machines is a complex concept with lots of theory behind it which is quite abstract. what I find very interesting is that <strong>it&#8217;s possible to vulgarize this very abstract concept with simpler concepts such as Process, Source, Sink, Tee, Wye&#8230; that you can catch quite easily</strong> as these are concepts you already manipulated when you were playing in your bathtub when you were child (or even now).</p></blockquote>

<br/>


<br/>


<h2><a name="plug-n-play">Scalaz-stream Plug&#8217;n&#8217;Play  Iteratee/Enumerator</a></h2>

<p>After these considerations, I wanted to experiment scalaz-stream with Play streaming capabilities in order to see how it behaves in a context I know.</p>

<p>Here is what I decided to study:</p>

<ul>
<li><strong>Stream data out of a controller action using a scalaz-stream <code>Process</code></strong></li>
<li><strong>Call an AsyncWebService &amp; consume the response as a stream of <code>Array[Byte]</code> using a scalaz-stream <code>Process</code></strong></li>
</ul>


<p>Here is existing Play API :</p>

<ul>
<li>Action provides <code>Ok.stream(Enumerator)</code></li>
<li>WS call consuming response as a stream of data <code>WS.get(r: ResponseHeader =&gt; Iteratee)</code></li>
</ul>


<br/>


<blockquote><p>As you can see, these API depends on Iteratee/Enumerator. As I didn&#8217;t want to hack Play too much as a beginning, I decided to try &amp; plug scalaz-stream on Play Iteratee (if possible).</p></blockquote>

<h3>Building <code>Enumerator[O]</code> from <code>Process[Task, O]</code></h3>

<p>The idea is to take a scalaz-stream Source[O] (<code>Process[M,O]</code>) and wrap it into an <code>Enumerator[O]</code> so that it can be used in Play controller actions.</p>

<p>An Enumerator is a data producer which can generate those data using monadic <code>Future</code> effects (Play Iteratee is tightly linked to <code>Future</code>).</p>

<p><code>Process[Task, O]</code> is a machine outputting a stream of <code>O</code> so it&#8217;s logically the right candidate to be adapted with a <code>Enumerator[O]</code>. <em>Let&#8217;s remind&#8217; <code>Task</code> is just a scalaz <code>Future[Either[Throwable,A]]</code> with a few helpers and it&#8217;s used in scalaz-stream</em>.</p>

<p>So I&#8217;ve implemented (at least tried) an <code>Enumerator[O]</code> that accepts a <code>Process[Task, O]</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">enumerator</span><span class="o">[</span><span class="kt">O</span><span class="o">](</span><span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">O</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">Enumerator</span><span class="o">[</span><span class="kt">O</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>      <span class="c1">// look the code in github project</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The implementation just synchronizes the states of the <code>Iteratee[O, A]</code> consuming the <code>Enumerator</code> with the states of <code>Process[Task, O]</code> emitting data chunks of <code>O</code>. It&#8217;s quite simple actually.</p></blockquote>

<br/>


<br/>


<h3>Building <code>Process1[I, O]</code> from <code>Iteratee[I, O]</code></h3>

<p>The idea is to drive an Iteratee from a scalaz-stream Process so that it can consume an Enumerator and be used in Play WS.</p>

<p>An <code>Iteratee[I, O]</code> accepts inputs of type <code>I</code> (<em>and nothing else</em>) and will fold the input stream into a single result of type <code>O</code>.</p>

<p>A <code>Process1[I, O]</code> accepts inputs of type <code>I</code> and emits chunks of type <code>O</code> but not necessarily one single output chunk. So it&#8217;s a good candidate for our use-case but we need to choose which emitted chunk will be the result of the <code>Iteratee[I, O]</code>. here, totally arbitrarily, I&#8217;ve chosen to take the first emit as the result (<em>but the last would be as good if not better</em>).</p>

<p>So I implemented the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">iterateeFirstEmit</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">O</span><span class="o">](</span><span class="n">p</span><span class="k">:</span> <span class="kt">Process.Process1</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">O</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">O</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="c1">// look the code in github project</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The implementation is really raw for experimentation as it goes through the states of the <code>Process1[I,O]</code> and generates the corresponding states of <code>Iteratee[I,O]</code> until first emitted value. Nothing more nothing less&#8230;</p></blockquote>

<br/>


<br/>


<h2>A few basic action samples</h2>

<blockquote><p>Everything done in those samples could be done with Iteratee/Enumeratee more or less simply. The subject is not there!</p></blockquote>

<br/>


<h3>Sample 1 : Generates a stream from a Simple Emitter Process</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">sample1</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">process</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emitAll</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">)).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">process</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample1&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mi">1234</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Sample 2 : Generates a stream from a continuous emitter</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** A process generating an infinite stream of natural numbers */</span>
</span><span class='line'><span class="k">val</span> <span class="n">numerals</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">unfold</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">}.</span><span class="n">repeat</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// we limit the number of outputs but you don&#39;t have it can stream forever...</span>
</span><span class='line'><span class="k">def</span> <span class="n">sample2</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">numerals</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">40</span><span class="o">)))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample2&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">9</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="mi">12</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">14</span><span class="o">,</span><span class="mi">15</span><span class="o">,</span><span class="mi">16</span><span class="o">,</span><span class="mi">17</span><span class="o">,</span><span class="mi">18</span><span class="o">,</span><span class="mi">19</span><span class="o">,</span><span class="mi">20</span><span class="o">,</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Sample 3 : Generates a stream whose output frequency is controlled by a tee with numeral generator on left and ticker on right</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** ticks constant every delay milliseconds */</span>
</span><span class='line'><span class="k">def</span> <span class="n">ticker</span><span class="o">(</span><span class="n">constant</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">delay</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span>
</span><span class='line'>  <span class="n">scalaFuture2scalazTask</span><span class="o">(</span><span class="n">delayedNumber</span><span class="o">(</span><span class="n">constant</span><span class="o">,</span> <span class="n">delay</span><span class="o">))</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">).</span><span class="n">repeat</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sample3</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span>
</span><span class='line'>    <span class="c1">// creates a Tee outputting only numerals but consuming ticker // to have the delayed effect</span>
</span><span class='line'>    <span class="o">(</span><span class="n">numerals</span> <span class="n">tee</span> <span class="n">ticker</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">))(</span><span class="n">processes</span><span class="o">.</span><span class="n">zipWith</span><span class="o">((</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note :</p>

<ul>
<li><code>scalaFuture2scalazTask</code> is just a helper to convert a <code>Future</code> into <code>Task</code></li>
<li><code>ticker</code>is quite simple to understand: it awaits <code>Task[Int] and emits this</code>Int and repeats it again&#8230;</li>
<li><code>processes.zipWith((a,b) =&gt; a)</code> is a tee (2 inputs left/right) that outputs only left data but consumes right also to have the delay effect.</li>
<li><code>.map(_.toString)</code> simply converts into something writeable by <code>Ok.stream</code></li>
<li><code>.intersperse(",")</code> which simply add `&#8221;,&#8221; between each element</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample3&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mf">1.</span><span class="o">..</span> <span class="c1">// to simulate the progressive apparition of numbers on screen</span>
</span><span class='line'><span class="mi">1</span><span class="o">,...</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mf">2.</span><span class="o">..</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">9</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="mi">12</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">14</span><span class="o">,</span><span class="mi">15</span><span class="o">,</span><span class="mi">16</span><span class="o">,</span><span class="mi">17</span><span class="o">,</span><span class="mi">18</span><span class="o">,</span><span class="mi">19</span><span class="o">,</span><span class="mi">20</span><span class="o">,</span><span class="mi">21</span><span class="o">,</span><span class="mi">22</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">24</span><span class="o">,</span><span class="mi">25</span><span class="o">,</span><span class="mi">26</span><span class="o">,</span><span class="mi">27</span><span class="o">,</span><span class="mi">28</span><span class="o">,</span><span class="mi">29</span><span class="o">,</span><span class="mi">30</span><span class="o">,</span><span class="mi">31</span><span class="o">,</span><span class="mi">32</span><span class="o">,</span><span class="mi">33</span><span class="o">,</span><span class="mi">34</span><span class="o">,</span><span class="mi">35</span><span class="o">,</span><span class="mi">36</span><span class="o">,</span><span class="mi">37</span><span class="o">,</span><span class="mi">38</span><span class="o">,</span><span class="mi">39</span><span class="o">,</span><span class="mi">40</span><span class="o">,</span><span class="mi">41</span><span class="o">,</span><span class="mi">42</span><span class="o">,</span><span class="mi">43</span><span class="o">,</span><span class="mi">44</span><span class="o">,</span><span class="mi">45</span><span class="o">,</span><span class="mi">46</span><span class="o">,</span><span class="mi">47</span><span class="o">,</span><span class="mi">48</span><span class="o">,</span><span class="mi">49</span><span class="o">,</span><span class="mi">50</span><span class="o">,</span><span class="mi">51</span><span class="o">,</span><span class="mi">52</span><span class="o">,</span><span class="mi">53</span><span class="o">,</span><span class="mi">54</span><span class="o">,</span><span class="mi">55</span><span class="o">,</span><span class="mi">56</span><span class="o">,</span><span class="mi">57</span><span class="o">,</span><span class="mi">58</span><span class="o">,</span><span class="mi">59</span><span class="o">,</span><span class="mi">60</span><span class="o">,</span><span class="mi">61</span><span class="o">,</span><span class="mi">62</span><span class="o">,</span><span class="mi">63</span><span class="o">,</span><span class="mi">64</span><span class="o">,</span><span class="mi">65</span><span class="o">,</span><span class="mi">66</span><span class="o">,</span><span class="mi">67</span><span class="o">,</span><span class="mi">68</span><span class="o">,</span><span class="mi">69</span><span class="o">,</span><span class="mi">70</span><span class="o">,</span><span class="mi">71</span><span class="o">,</span><span class="mi">72</span><span class="o">,</span><span class="mi">73</span><span class="o">,</span><span class="mi">74</span><span class="o">,</span><span class="mi">75</span><span class="o">,</span><span class="mi">76</span><span class="o">,</span><span class="mi">77</span><span class="o">,</span><span class="mi">78</span><span class="o">,</span><span class="mi">79</span><span class="o">,</span><span class="mi">80</span><span class="o">,</span><span class="mi">81</span><span class="o">,</span><span class="mi">82</span><span class="o">,</span><span class="mi">83</span><span class="o">,</span><span class="mi">84</span><span class="o">,</span><span class="mi">85</span><span class="o">,</span><span class="mi">86</span><span class="o">,</span><span class="mi">87</span><span class="o">,</span><span class="mi">88</span><span class="o">,</span><span class="mi">89</span><span class="o">,</span><span class="mi">90</span><span class="o">,</span><span class="mi">91</span><span class="o">,</span><span class="mi">92</span><span class="o">,</span><span class="mi">93</span><span class="o">,</span><span class="mi">94</span><span class="o">,</span><span class="mi">95</span><span class="o">,</span><span class="mi">96</span><span class="o">,</span><span class="mi">97</span><span class="o">,</span><span class="mi">98</span><span class="o">,</span><span class="mi">99</span><span class="o">,</span><span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Sample 4 : Generates a stream using side-effect to control output frequency</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Async generates this Int after delay*/</span>
</span><span class='line'><span class="k">def</span> <span class="n">delayedNumber</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">delay</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">Promise</span><span class="o">.</span><span class="n">timeout</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">delay</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** Creates a process generating an infinite stream natural numbers</span>
</span><span class='line'><span class="cm">  * every `delay milliseconds</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">def</span> <span class="n">delayedNumerals</span><span class="o">(</span><span class="n">delay</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">step</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="n">then</span><span class="o">(</span>
</span><span class='line'>      <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span><span class="n">scalaFuture2scalazTask</span><span class="o">(</span><span class="n">delayedNumber</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">delay</span><span class="o">)))(</span><span class="n">step</span><span class="o">)</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span><span class="n">scalaFuture2scalazTask</span><span class="o">(</span><span class="n">delayedNumber</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">delay</span><span class="o">)))(</span><span class="n">step</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sample4</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">delayedNumerals</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note:</p>

<ul>
<li><code>delayedNumber</code> uses an Akka scheduler to trigger our value after timeout</li>
<li><code>delayedNumerals</code> shows a simple recursive `Process[Task, Int] construction which shouldn&#8217;t be too hard to understand</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample4&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mf">0.</span><span class="o">..</span> <span class="c1">// to simulate the progressive apparition of numbers every 100ms</span>
</span><span class='line'><span class="mi">0</span><span class="o">,...</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mf">1.</span><span class="o">..</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,...</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">2.</span><span class="o">..</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">9</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="mi">12</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">14</span><span class="o">,</span><span class="mi">15</span><span class="o">,</span><span class="mi">16</span><span class="o">,</span><span class="mi">17</span><span class="o">,</span><span class="mi">18</span><span class="o">,</span><span class="mi">19</span><span class="o">,</span><span class="mi">20</span><span class="o">,</span><span class="mi">21</span><span class="o">,</span><span class="mi">22</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">24</span><span class="o">,</span><span class="mi">25</span><span class="o">,</span><span class="mi">26</span><span class="o">,</span><span class="mi">27</span><span class="o">,</span><span class="mi">28</span><span class="o">,</span><span class="mi">29</span><span class="o">,</span><span class="mi">30</span><span class="o">,</span><span class="mi">31</span><span class="o">,</span><span class="mi">32</span><span class="o">,</span><span class="mi">33</span><span class="o">,</span><span class="mi">34</span><span class="o">,</span><span class="mi">35</span><span class="o">,</span><span class="mi">36</span><span class="o">,</span><span class="mi">37</span><span class="o">,</span><span class="mi">38</span><span class="o">,</span><span class="mi">39</span><span class="o">,</span><span class="mi">40</span><span class="o">,</span><span class="mi">41</span><span class="o">,</span><span class="mi">42</span><span class="o">,</span><span class="mi">43</span><span class="o">,</span><span class="mi">44</span><span class="o">,</span><span class="mi">45</span><span class="o">,</span><span class="mi">46</span><span class="o">,</span><span class="mi">47</span><span class="o">,</span><span class="mi">48</span><span class="o">,</span><span class="mi">49</span><span class="o">,</span><span class="mi">50</span><span class="o">,</span><span class="mi">51</span><span class="o">,</span><span class="mi">52</span><span class="o">,</span><span class="mi">53</span><span class="o">,</span><span class="mi">54</span><span class="o">,</span><span class="mi">55</span><span class="o">,</span><span class="mi">56</span><span class="o">,</span><span class="mi">57</span><span class="o">,</span><span class="mi">58</span><span class="o">,</span><span class="mi">59</span><span class="o">,</span><span class="mi">60</span><span class="o">,</span><span class="mi">61</span><span class="o">,</span><span class="mi">62</span><span class="o">,</span><span class="mi">63</span><span class="o">,</span><span class="mi">64</span><span class="o">,</span><span class="mi">65</span><span class="o">,</span><span class="mi">66</span><span class="o">,</span><span class="mi">67</span><span class="o">,</span><span class="mi">68</span><span class="o">,</span><span class="mi">69</span><span class="o">,</span><span class="mi">70</span><span class="o">,</span><span class="mi">71</span><span class="o">,</span><span class="mi">72</span><span class="o">,</span><span class="mi">73</span><span class="o">,</span><span class="mi">74</span><span class="o">,</span><span class="mi">75</span><span class="o">,</span><span class="mi">76</span><span class="o">,</span><span class="mi">77</span><span class="o">,</span><span class="mi">78</span><span class="o">,</span><span class="mi">79</span><span class="o">,</span><span class="mi">80</span><span class="o">,</span><span class="mi">81</span><span class="o">,</span><span class="mi">82</span><span class="o">,</span><span class="mi">83</span><span class="o">,</span><span class="mi">84</span><span class="o">,</span><span class="mi">85</span><span class="o">,</span><span class="mi">86</span><span class="o">,</span><span class="mi">87</span><span class="o">,</span><span class="mi">88</span><span class="o">,</span><span class="mi">89</span><span class="o">,</span><span class="mi">90</span><span class="o">,</span><span class="mi">91</span><span class="o">,</span><span class="mi">92</span><span class="o">,</span><span class="mi">93</span><span class="o">,</span><span class="mi">94</span><span class="o">,</span><span class="mi">95</span><span class="o">,</span><span class="mi">96</span><span class="o">,</span><span class="mi">97</span><span class="o">,</span><span class="mi">98</span><span class="o">,</span><span class="mi">99</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Sample 5 : Generates a stream by consuming completely another stream</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// a process folding all Array[Byte] into a big String</span>
</span><span class='line'><span class="k">val</span> <span class="n">reader</span><span class="k">:</span> <span class="kt">Process.Process1</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">processes</span><span class="o">.</span><span class="n">fold1</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span> <span class="o">++</span> <span class="n">b</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">arr</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">arr</span><span class="o">)</span> <span class="o">}</span> <span class="o">|&gt;</span> <span class="n">processes</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sample5</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// the WS call with response consumer by previous Process1[Array[Byte], String] driving the Iteratee[Array[Byte], String]</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">maybeValues</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="nc">WS</span><span class="o">.</span><span class="n">url</span><span class="o">(</span><span class="n">routes</span><span class="o">.</span><span class="nc">Application</span><span class="o">.</span><span class="n">sample2</span><span class="o">().</span><span class="n">absoluteURL</span><span class="o">())</span>
</span><span class='line'>      <span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">rh</span> <span class="k">=&gt;</span> <span class="n">iterateeFirstEmit</span><span class="o">(</span><span class="n">reader</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">run</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span>
</span><span class='line'>    <span class="c1">// wraps the received String in a Process</span>
</span><span class='line'>    <span class="c1">// re-splits it to remove &quot;,&quot;</span>
</span><span class='line'>    <span class="c1">// emits all chunks</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">wrap</span><span class="o">(</span><span class="n">scalaFuture2scalazTask</span><span class="o">(</span><span class="n">maybeValues</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">flatMap</span><span class="o">{</span> <span class="n">values</span> <span class="k">=&gt;</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emitAll</span><span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">))</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note:</p>

<ul>
<li><code>reader</code> is a <code>Process1[Array[Byte], String] that folds all received</code>Array[Byte]<code>into a</code>String`</li>
<li><code>iterateeFirstEmit(reader)</code> simulates an <code>Iteratee[Array[Byte], String]</code> driven by the <code>reader</code> process that will fold all chunks of data received from WS call to <code>routes.Application.sample2()</code></li>
<li><code>.get(rh =&gt; iterateeFirstEmit(reader))</code> will return a <code>Future[Iteratee[Array[Byte], String]</code> that is run in <code>.flatMap(_.run)</code> to return a <code>Future[String]</code></li>
<li><code>Process.wrap(scalaFuture2scalazTask(maybeValues))</code> is a trick to wrap the folded <code>Future[String]</code> into a <code>Process[Task, String]</code></li>
<li><code>Process.emitAll(values.split(","))</code> splits the resulting string again and emits all chunks outside (stupid, just for demo)</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample5&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mi">1234567891011121314151617181920</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<blockquote><p>Still there? Let&#8217;s dive deeper and be sharper!</p></blockquote>

<br/>


<h2>Building recursive streaming action consuming itself</h2>

<br/>


<h3>Hacking WS to consume &amp; re-emit WS in realtime</h3>

<p><code>WS.executeStream(r: ResponseHeader =&gt; Iteratee[Array[Byte], A])</code> is cool API because you can build an iteratee from the ResponseHeader and then the iteratee will consume received `Array[Byte] chunks in a reactive way and will fold them. The problem is that until the iteratee has finished, you won&#8217;t have any result.</p>

<p>But I&#8217;d like to be able to receive chunks of data in realtime and re-emit them immediately so that I can inject them in realtime data flow processing. WS API doesn&#8217;t allow this so I decided to hack it a bit. I&#8217;ve written <code>WSZ</code> which provides the API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">getRealTime</span><span class="o">()</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]</span>
</span><span class='line'><span class="c1">// based on</span>
</span><span class='line'><span class="k">private</span><span class="o">[</span><span class="kt">libs</span><span class="o">]</span> <span class="k">def</span> <span class="n">realtimeStream</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This API outputs a realtime Stream of <code>Array[Byte]</code> whose flow is controlled by promises (<code>Future</code>) being redeemed in AsyncHttpClient <code>AsyncHandler</code>. <em>I didn&#8217;t care about ResponseHeaders for this experimentation but it should be taken account in a more serious impl.</em></p>

<p>I obtain a <code>Process[Future, Array[Byte]]</code> streaming received chunks in realtime and I can then take advantage of the power of machines to manipulate the data chunks as I want.</p>

<br/>


<h3>Sample 6 : Generates a stream by forwarding/refolding another stream in realtime</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** A Process1 splitting input strings using splitter and re-grouping chunks */</span>
</span><span class='line'><span class="k">def</span> <span class="n">splitFold</span><span class="o">(</span><span class="n">splitter</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process.Process1</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// the recursive splitter / refolder</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">go</span><span class="o">(</span><span class="n">rest</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="n">str</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process.Process1</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">splitted</span> <span class="k">=</span> <span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="n">splitter</span><span class="o">)</span>
</span><span class='line'>    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;&quot;&quot;$str - ${splitted.mkString(&quot;,&quot;)} --&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">(</span><span class="n">splitted</span><span class="o">.</span><span class="n">length</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">0</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// string == splitter</span>
</span><span class='line'>        <span class="c1">// emit rest</span>
</span><span class='line'>        <span class="c1">// loop</span>
</span><span class='line'>        <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">rest</span><span class="o">).</span><span class="n">then</span><span class="o">(</span> <span class="nc">Process</span><span class="o">.</span><span class="n">await1</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">(</span><span class="n">go</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// splitter not found in string </span>
</span><span class='line'>        <span class="c1">// so waiting for next string</span>
</span><span class='line'>        <span class="c1">// loop by adding current str to rest</span>
</span><span class='line'>        <span class="c1">// but if we reach end of input, then we emit (rest+str) for last element</span>
</span><span class='line'>        <span class="nc">Process</span><span class="o">.</span><span class="n">await1</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">(</span><span class="n">go</span><span class="o">(</span><span class="n">rest</span> <span class="o">+</span> <span class="n">str</span><span class="o">)).</span><span class="n">orElse</span><span class="o">(</span><span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">rest</span><span class="o">+</span><span class="n">str</span><span class="o">))</span>
</span><span class='line'>      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// splitter found</span>
</span><span class='line'>        <span class="c1">// emit rest + splitted.head</span>
</span><span class='line'>        <span class="c1">// emit all splitted elements but last</span>
</span><span class='line'>        <span class="c1">// loops with rest = splitted last element</span>
</span><span class='line'>        <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">rest</span> <span class="o">+</span> <span class="n">splitted</span><span class="o">.</span><span class="n">head</span><span class="o">)</span>
</span><span class='line'>               <span class="o">.</span><span class="n">then</span><span class="o">(</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emitAll</span><span class="o">(</span><span class="n">splitted</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">init</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>               <span class="o">.</span><span class="n">then</span><span class="o">(</span> <span class="nc">Process</span><span class="o">.</span><span class="n">await1</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">(</span><span class="n">go</span><span class="o">(</span><span class="n">splitted</span><span class="o">.</span><span class="n">last</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>    <span class="o">})</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="c1">// await1 simply means &quot;await an input string and emits it&quot;</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">.</span><span class="n">await1</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">(</span><span class="n">go</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sample6</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="nc">WSZ</span><span class="o">.</span><span class="n">url</span><span class="o">(</span><span class="n">routes</span><span class="o">.</span><span class="nc">Application</span><span class="o">.</span><span class="n">sample4</span><span class="o">().</span><span class="n">absoluteURL</span><span class="o">()).</span><span class="n">getRealTime</span><span class="o">.</span><span class="n">translate</span><span class="o">(</span><span class="nc">Task2FutureNT</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="n">splitFold</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note:</p>

<ul>
<li><code>def splitFold(splitter: String): Process.Process1[String, String]</code> is just a demo that coding a Process transducer isn&#8217;t so crazy&#8230; Look at comments in code</li>
<li><code>.translate(Task2FutureNF)</code> converts the <code>Process[Future, Array[Byte]]</code> to <code>Process[Task, Array[Byte]]</code> using Scalaz Natural Transformation.</li>
<li><code>p |&gt; splitFold(",")</code> means &#8220;pipe output of process <code>p</code> to input of <code>splitFold</code>&#8221;.</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample6&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mf">0.</span><span class="o">..</span>
</span><span class='line'><span class="mf">01.</span><span class="o">..</span>
</span><span class='line'><span class="mf">012.</span><span class="o">..</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="mi">01234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<blockquote><p>Let&#8217;s finish our trip with a bit of puzzle and mystery.</p></blockquote>

<br/>


<h3>THE FINAL MYSTERY: recursive stream generating Fibonacci series</h3>

<p>As soon as my first experimentations of scalaz-stream with Play were operational, I&#8217;ve imagined an interesting case:</p>

<blockquote><p>Is it possible to build an action generating a stream of data fed by itself: a kind of recursive stream.</p></blockquote>

<p>With Iteratee, it&#8217;s not really possible since it can&#8217;t emit data before finishing iteration. It would certainly be possible with an Enumeratee but the API doesn&#8217;t exist and I find it much more obvious with scalaz-stream API!</p>

<p>The mystery isn&#8217;t in the answer to my question: YES it is possible!</p>

<p>The idea is simple:</p>

<ul>
<li>Create a simple action</li>
<li>Create a first process emitting a few initialization data</li>
<li>Create a second process which consumes the WS calling my own action and re-emits the received chunks in realtime</li>
<li>Append first process output and second process output</li>
<li>Stream global output as a result of the action which will back-propagated along time to the action itself&#8230;</li>
</ul>


<p>Naturally, if it consumes its own data, it will recall itself again and again and again until you reach the connections or opened file descriptors limit. As a consequence, you must limit the depth of recursion.</p>

<p>I performed different experiences to show this use-case by zipping the stream with itself, adding elements with themselves etc&#8230;
And after a few tries, I implemented the following code quite fortuitously :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** @param curDepth the current recursion depth</span>
</span><span class='line'><span class="cm">  * @param maxDepth the max recursion depth</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">def</span> <span class="n">sample7</span><span class="o">(</span><span class="n">curDepth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">maxDepth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// initializes serie with 2 first numerals output with a delay of 100ms</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">init</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">delayedNumerals</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Creates output Process</span>
</span><span class='line'>  <span class="c1">// If didn&#39;t reach maxDepth, creates a process consuming my own action</span>
</span><span class='line'>  <span class="c1">// If reach maxDepth, just emit 0</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">outputProcess</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">curDepth</span> <span class="o">&lt;</span> <span class="n">maxDepth</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// calling my own action and streaming chunks using getRealTime</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">val</span> <span class="n">myself</span> <span class="k">=</span> <span class="nc">WSZ</span><span class="o">.</span><span class="n">url</span><span class="o">(</span>
</span><span class='line'>        <span class="n">routes</span><span class="o">.</span><span class="nc">Application</span><span class="o">.</span><span class="n">sample7</span><span class="o">(</span><span class="n">curDepth</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">maxDepth</span><span class="o">).</span><span class="n">absoluteURL</span><span class="o">()</span>
</span><span class='line'>      <span class="o">).</span><span class="n">getRealTime</span><span class="o">.</span><span class="n">translate</span><span class="o">(</span><span class="nc">Task2FutureNT</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class='line'>      <span class="c1">// splitFold isn&#39;t useful, just for demo</span>
</span><span class='line'>      <span class="o">|&gt;</span> <span class="n">splitFold</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// THE IMPORTANT PART BEGIN</span>
</span><span class='line'>      <span class="c1">// appends `init` output with `myself` output</span>
</span><span class='line'>      <span class="c1">// pipe it through a helper provided scalaz-stream `processes.sum[Long]`</span>
</span><span class='line'>      <span class="c1">// which sums elements and emits partial sums</span>
</span><span class='line'>      <span class="o">((</span><span class="n">init</span> <span class="n">append</span> <span class="n">myself</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toLong</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">processes</span><span class="o">.</span><span class="n">sum</span><span class="o">[</span><span class="kt">Long</span><span class="o">])</span>
</span><span class='line'>      <span class="c1">// THE IMPORTANT PART END</span>
</span><span class='line'>      <span class="c1">// just for output format</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">outputProcess</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Launch it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">curl</span> <span class="s">&quot;localhost:10000/sample7?curDepth=0&amp;maxDepth=10&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">21</span><span class="o">,</span><span class="mi">34</span><span class="o">,</span><span class="mi">55</span><span class="o">,</span><span class="mi">89</span><span class="o">,</span><span class="mi">144</span><span class="o">,</span><span class="mi">233</span><span class="o">,</span><span class="mi">377</span><span class="o">,</span><span class="mi">610</span><span class="o">,</span><span class="mi">987</span><span class="o">,</span><span class="mi">1597</span><span class="o">,</span><span class="mi">2584</span><span class="o">,</span><span class="mi">4181</span><span class="o">,</span><span class="mi">6765</span>
</span></code></pre></td></tr></table></div></figure>


<p>WTF??? This is Fibonacci series?</p>

<p>Just to remind you about it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">e</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="k">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">e</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="k">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">e</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=</span> <span class="n">e</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">e</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Here is the mystery!!!</p>

<p>How does it work???</p>

<p>I won&#8217;t tell the answer to this puzzling side-effect and let you think about it and discover why it works XD</p></blockquote>

<p>But this sample shows exactly what I wanted: <strong>Yes, it&#8217;s possible to feed an action with its own feed! Victory!</strong></p>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Ok all of that was really funky but is it useful in real projects? I don&#8217;t really know yet but it provides a great proof of the very reactive character of scalaz-stream and Play too!</p>

<p>I tend to like scalaz-stream and I feel more comfortable, more natural using Process than Iteratee right now&#8230; Maybe this is just an impression so I&#8217;ll keep cautious about my conclusions for now&#8230;</p>

<p>All of this code is just experimental so be aware about it. If you like it and see that it could be useful, tell me so that we create a real library from it!</p>

<p>Have Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,
Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,
Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,!</p>

<br/>


<br/>


<h2>PostScriptum</h2>

<h3><a name="iteratee-details">A few more details about Iteratees</a></h3>

<p>Here are a few things that bother me when I use Play Iteratee (you don&#8217;t have to agree, this is very subjective):</p>

<ul>
<li>Enumeratees are really powerful (maybe the most powerful part of the API) but they can be tricky: for ex, defining a new Enumeratee from scratch isn&#8217;t easy at first sight due to the signature of the Enumeratee itself, Enumeratee composes differently on left (with Enumerators) and on right (with Iteratees) and it can be strange at beginning&#8230;</li>
<li>Enumerators are not defined (when not using helpers) in terms of the data they produce but with respect to the way an Iteratee will consume the data they will produce. You must somewhat reverse your way of thinking which is not so natural.</li>
<li>Iteratees are great to produce one result by folding a stream of data but if you want to consume/cut/aggregate/re-emit the chunks, the code you write based on Iteratee/Enumeratee quickly becomes complex, hard to re-read and edge cases (error, end of stream) are hard to treat.</li>
<li>When you want to manipulate multiple streams together, zip/interleave them, you must write very complex code too.</li>
<li>End of iteration and Error management with Iteratees isn&#8217;t really clear IMHO and when you begin to compose Iteratees together, it becomes hard to know what will happen&#8230;</li>
<li>If you want to manipulate a stream with side-effecting, you can do it with Enumeratees but it&#8217;s not so obvious&#8230;</li>
</ul>


<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/07/11/play-autosource-datomisca/">Play AutoSource & Datomisca: Proofing the Concept on Datomic, a Schema DB</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-11T18:18:00+02:00" pubdate data-updated="true">Jul 11<span>th</span>, 2013</time>
        
         | <a href="/2013/07/11/play-autosource-datomisca/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Now you should use play-autosource 2.0 correcting a few issues &amp; introducing ActionBuilder from play2.2</h4>

<p>The code for all autosources &amp; sample apps can be found on Github <a href="https://github.com/mandubian/play-autosource/tree/master/datomisca">here</a></p>

<div class="well">
  <h3>Brand New Autosources</h3>
  Play AutoSource now have 2 more implementations : 
  <ul>
    <li><b><a href="http://www.datomic.com">Datomic</a> based on <a href="http://pellucidanalytics.github.io/datomisca/">Datomisca</a></b>, the Scala API I developed with Daniel James (<a href="https://twitter.com/dwhjames">@dwhjames</a>) sponsored by Pellucid Analytics & Zenexity which is presented in this article</li>
    <li><b><a href="http://www.couchbase.com/">CouchBase</a></b> contributed by Mathieu Ancelin <a href="https://twitter.com/TrevorReznik">@TrevorReznik</a></li>
    <li><b><a href="http://www.typesafe.com/slick">Slick/JDBC</a></b> based on <a href="https://github.com/freekh/play-slick">Play2-Slick</a> contributed by <a href="https://github.com/rcavalcanti">Renato Cavalcanti</a> and <a href="https://github.com/loicdescotte">Loic Descotte</a></li>
  </ul>
</div>


<blockquote><p>One month ago, I&#8217;ve demo&#8217;ed the concept of Autosource for Play2/Scala with ReactiveMongo in <a href="http://mandubian.com/2013/06/11/play-autosource/">this article</a>. ReactiveMongo was the perfect target for this idea because it accepts Json structures almost natively for both documents manipulation and queries.</p>

<p>But how does the concept behave when applied on a DB for which data are constrained by a schema and for which queries aren&#8217;t Json.</p></blockquote>

<br/>


<h2>Using Datomisca-Autosource in your Play project</h2>

<p>Add following lines to your <code>project/Build.scala</code></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">mandubianRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;Mandubian repository snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/snapshots/&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Mandubian repository releases&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/releases/&quot;</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">appDependencies</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">main</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="nc">Project</span><span class="o">(</span><span class="n">appName</span><span class="o">,</span> <span class="n">appVersion</span><span class="o">,</span> <span class="n">appDependencies</span><span class="o">).</span><span class="n">settings</span><span class="o">(</span>
</span><span class='line'>  <span class="n">resolvers</span> <span class="o">++=</span> <span class="n">mandubianRepo</span><span class="o">,</span>
</span><span class='line'>  <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;play-autosource&quot;</span>   <span class="o">%%</span> <span class="s">&quot;datomisca&quot;</span>       <span class="o">%</span> <span class="s">&quot;1.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Create your Model + Schema</h2>

<p>With ReactiveMongo Autosource, you could create a pure blob Autosource using <code>JsObject</code> without any supplementary information. But with Datomic, it&#8217;s not possible because Datomic forces to use a schema for your data.</p>

<p>We could create a schema and manipulate <code>JsObject</code> directly with Datomic and some Json validators. But I&#8217;m going to focus on the static models because this is the way people traditionally interact with a Schema-constrained DB.</p>

<p>Let&#8217;s create our model and schema.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// The Model (with characters pointing on Datomic named entities)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">characters</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">DRef</span><span class="o">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The Schema written with Datomisca</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Person</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// Namespaces</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">person</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;person&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">characters</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;person.characters&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Attributes</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span>       <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span><span class="o">,</span>       <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">)</span> <span class="o">.</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Person&#39;s name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">age</span>        <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span><span class="o">,</span>        <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span>   <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">)</span> <span class="o">.</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Person&#39;s age&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">characters</span> <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;characters&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span>    <span class="nc">Cardinality</span><span class="o">.</span><span class="n">many</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Person&#39;s characterS&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Characters named entities</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">violent</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;violent&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">weak</span>    <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;weak&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">clever</span>  <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;clever&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">dumb</span>    <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;dumb&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">stupid</span>  <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;stupid&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Schema</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">schema</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">,</span> <span class="n">characters</span><span class="o">,</span>
</span><span class='line'>    <span class="n">violent</span><span class="o">,</span> <span class="n">weak</span><span class="o">,</span> <span class="n">clever</span><span class="o">,</span> <span class="n">dumb</span><span class="o">,</span> <span class="n">stupid</span>
</span><span class='line'>  <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Create Datomisca Autosource</h2>

<p>Now that we have our schema, let&#8217;s write the autosource.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.autosource.datomisca._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.modules.datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Implicits._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.Play.current</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">models._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Person._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">DatomiscaAutoSourceController</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// gets the Datomic URI from application.conf</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="nc">DatomicPlugin</span><span class="o">.</span><span class="n">uri</span><span class="o">(</span><span class="s">&quot;mem&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ugly DB initialization ONLY for test purpose</span>
</span><span class='line'>  <span class="nc">Datomic</span><span class="o">.</span><span class="n">createDatabase</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Datomic connection is required</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'>  <span class="c1">// Datomic partition in which you store your entities</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">val</span> <span class="n">partition</span> <span class="k">=</span> <span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// more than ugly schema provisioning, ONLY for test purpose</span>
</span><span class='line'>  <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="n">schema</span><span class="o">),</span>
</span><span class='line'>    <span class="nc">Duration</span><span class="o">(</span><span class="s">&quot;10 seconds&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Implementing Json <-> Person <-> Datomic transformers</h2>

<p>If you compile previous code, you should have following error:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">could</span> <span class="n">not</span> <span class="n">find</span> <span class="k">implicit</span> <span class="n">value</span> <span class="k">for</span> <span class="n">parameter</span> <span class="n">datomicReader</span><span class="k">:</span> <span class="kt">datomisca.EntityReader</span><span class="o">[</span><span class="kt">models.Person</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually, Datomisca Autosource requires 4 elements to work:</p>

<ul>
<li><code>Json.Format[Person]</code> to convert <code>Person</code> instances from/to Json (network interface)</li>
<li><code>EntityReader[Person]</code> to convert <code>Person</code> instances from Datomic entities (Datomic interface)</li>
<li><code>PartialAddEntityWriter[Person]</code> to convert <code>Person</code> instances to Datomic entities (Datomic interface)</li>
<li><code>Reads[PartialAddEntity]</code> to convert Json to <code>PartialAddEntity</code> which is actually a simple map of fields/values to partially update an existing entity (one single field for ex).</li>
</ul>


<p>It might seem more complicated than in ReactiveMongo but there is nothing different. The autosource converts <code>Person</code> from/to Json and then converts <code>Person</code> from/to Datomic structure ie <code>PartialAddEntity</code>. In ReactiveMongo, the only difference is that it understands Json so well that static model becomes unnecessary sometimes ;)&#8230;</p>

<p>Let&#8217;s define those elements in <code>Person</code> companion object.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">Person</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="c1">// Classic Play2 Json Reads/Writes</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">personFormat</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">format</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Partial entity update : Json to PartialAddEntity Reads</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">partialUpdate</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">PartialAddEntity</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>    <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;name</span><span class="o">).</span><span class="n">read</span><span class="o">(</span><span class="n">readAttr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">))</span> <span class="n">orElse</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">PartialAddEntity</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)))</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;age</span><span class="o">)</span> <span class="o">.</span><span class="n">read</span><span class="o">(</span><span class="n">readAttr</span><span class="o">[</span><span class="kt">Long</span><span class="o">](</span><span class="nc">Person</span><span class="o">.</span><span class="n">age</span><span class="o">))</span> <span class="n">orElse</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">PartialAddEntity</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)))</span>  <span class="n">and</span>
</span><span class='line'>    <span class="c1">// need to specify type because a ref/many can be a list of dref or entities so need to tell it explicitly</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;characters</span><span class="o">).</span><span class="n">read</span><span class="o">(</span> <span class="n">readAttr</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">DRef</span><span class="o">]](</span><span class="nc">Person</span><span class="o">.</span><span class="n">characters</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>    <span class="n">reduce</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Entity Reads (looks like Json combinators but it&#39;s Datomisca combinators)</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">entity2Person</span><span class="k">:</span> <span class="kt">EntityReader</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>    <span class="n">name</span>      <span class="o">.</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>   <span class="n">and</span>
</span><span class='line'>    <span class="n">age</span>       <span class="o">.</span><span class="n">read</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>     <span class="n">and</span>
</span><span class='line'>    <span class="n">characters</span><span class="o">.</span><span class="n">read</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">DRef</span><span class="o">]]</span>
</span><span class='line'>  <span class="o">)(</span><span class="nc">Person</span><span class="o">.</span><span class="n">apply</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Entity Writes (looks like Json combinators but it&#39;s Datomisca combinators)</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">person2Entity</span><span class="k">:</span> <span class="kt">PartialAddEntityWriter</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>    <span class="n">name</span>      <span class="o">.</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>   <span class="n">and</span>
</span><span class='line'>    <span class="n">age</span>       <span class="o">.</span><span class="n">write</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>     <span class="n">and</span>
</span><span class='line'>    <span class="n">characters</span><span class="o">.</span><span class="n">write</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">DRef</span><span class="o">]]</span>
</span><span class='line'>  <span class="o">)(</span><span class="nc">DatomicMapping</span><span class="o">.</span><span class="n">unlift</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we have everything to work except a few configurations.</p>

<h3>Add AutoSource routes at beginning <code>conf/routes</code></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-&gt;</span>      <span class="o">/</span><span class="n">person</span>                     <span class="n">controllers</span><span class="o">.</span><span class="nc">Persons</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Create <code>conf/play.plugins</code> to initialize Datomisca Plugin</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="mi">400</span><span class="k">:</span><span class="kt">play.modules.datomisca.DatomicPlugin</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Append to <code>conf/application.conf</code> to initialize MongoDB connection</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">datomisca</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">mem</span><span class="o">=</span><span class="s">&quot;datomic:mem://mem&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Insert your first 2 persons with Curl</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">25</span><span class="o">,</span> <span class="s">&quot;characters&quot;</span><span class="k">:</span> <span class="err">[&quot;</span><span class="kt">person.characters/stupid</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;person.characters/violent&quot;</span><span class="err">]</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/persons</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">21</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">17592186045423</span><span class="o">}</span> <span class="kt">-&gt;</span> <span class="kt">oh</span> <span class="kt">a</span> <span class="kt">Datomic</span> <span class="kt">ID</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">43</span><span class="o">,</span> <span class="s">&quot;characters&quot;</span><span class="k">:</span> <span class="err">[&quot;</span><span class="kt">person.characters/clever</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;person.characters/weak&quot;</span><span class="err">]</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/persons</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">21</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">17592186045425</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Querying is the biggest difference in Datomic</h3>

<p>In Datomic, you can&#8217;t do a <code>getAll</code> without providing a Datomic Query.</p>

<p>But what is a Datomic query? It&#8217;s inspired by <code>Datalog</code> which uses predicates to express the constraints on the searched entities. You can combine predicates together.</p>

<p>With Datomisca Autosource, you can directly send datalog queries in the query parameter <code>q</code> for GET or in body for POST with one restriction: your query can&#8217;t accept input parameters and must return only the entity ID. For ex:</p>

<p><code>[ :find ?e :where [ ?e :person/name "john"] ] --&gt; OK</code></p>

<p><code>[ :find ?e ?name :where [ ?e :person/name ?name] ] --&gt; KO</code></p>

<p>Let&#8217;s use it by finding all persons.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:text/plain&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">[</span><span class="kt">:find</span> <span class="kt">?e</span> <span class="kt">:where</span> <span class="o">[</span><span class="kt">?e</span> <span class="kt">:person/name</span><span class="o">]]</span><span class="sc">&#39; &#39;</span><span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/persons/find</span><span class="err">&#39;</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">231</span>
</span><span class='line'>
</span><span class='line'><span class="err">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span> <span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span> <span class="err">25</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;characters&quot;</span><span class="k">:</span> <span class="err">[</span>
</span><span class='line'>            <span class="err">&quot;</span><span class="kt">:person.characters/violent</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>            <span class="s">&quot;:person.characters/stupid&quot;</span>
</span><span class='line'>        <span class="err">]</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;id&quot;</span><span class="k">:</span> <span class="err">17592186045423</span>
</span><span class='line'>    <span class="o">},</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s">&quot;name&quot;</span><span class="k">:</span> <span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;age&quot;</span><span class="k">:</span> <span class="err">43</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;characters&quot;</span><span class="k">:</span> <span class="err">[</span>
</span><span class='line'>            <span class="err">&quot;</span><span class="kt">:person.characters/clever</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>            <span class="s">&quot;:person.characters/weak&quot;</span>
</span><span class='line'>        <span class="err">]</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;id&quot;</span><span class="k">:</span> <span class="err">17592186045425</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="err">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note the use of POST here instead of GET because Curl doesn&#8217;t like <code>[]</code> in URL even using <code>-g</code> option</p></blockquote>

<p>Now you can use all other routes provided by Autosource</p>

<h2>Autosource Standard Routes</h2>

<h3>Get / Find / Stream</h3>

<ul>
<li>GET /persons?&#8230;    -> Find by query</li>
<li>GET /persons/ID     -> Find by ID</li>
<li>GET /persons/stream -> Find by query &amp; stream result by page</li>
</ul>


<h3>Insert / Batch / Find</h3>

<ul>
<li>POST /persons + BODY -> Insert</li>
<li>POST /persons/find + BODY -> find by query (when query is too complex to be in a GET)</li>
<li>POST /persons/batch  + BODY -> batch insert (multiple)</li>
</ul>


<h3>Update / batch</h3>

<ul>
<li>PUT  /persons/ID   + BODY  -> Update by ID</li>
<li>PUT  /persons/ID/partial   + BODY  -> Update partially by ID</li>
<li>PUT  /persons/batch   -> batch update (multiple)</li>
</ul>


<h3>Delete / Batch</h3>

<ul>
<li>DELETE /persons/ID    -> delete by ID</li>
<li>DELETE /persons/batch + BODY -> batch delete (multiple)</li>
</ul>


<br/>


<br/>


<h2>Conclusion</h2>

<p>Play-Autosource&#8217;s ambition was to be DB agnostic (as much as possible) and showing that the concept can be applied to schemaless DB (ReactiveMongo &amp; CouchDB) and schema DB (Datomic) is a good sign it can work. Naturally, there are a few more elements to provide for Datomic than in ReactiveMongo but it&#8217;s useful anyway.</p>

<p>Thank to <a href="https://twitter.com/TrevorReznik">@TrevorReznik</a> for his contribution of CouchBase Autosource.</p>

<p>I hope to see soon one for Slick and a few more ;)</p>

<p>Have Autofun!</p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/07/04/json-interpolation-pattern-matching/">Play2 Json Interpolation & Pattern Matching</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-04T08:08:00+02:00" pubdate data-updated="true">Jul 4<span>th</span>, 2013</time>
        
         | <a href="/2013/07/04/json-interpolation-pattern-matching/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>EXPERIMENTAL / DRAFT</h4>

<br/>




<div class="well">
<p>Do you remember <code>JsPath</code> pattern matching presented in <a href="http://mandubian.com/2013/05/01/jspath-pattern-matching/">this article</a> ?</p>
<p>Let&#8217;s now go further with something that you should enjoy even more: <b>Json Interpolation &amp; Pattern Matching</b>.</p>

<p>I&#8217;ve had the idea of these features for some time in my mind but let&#8217;s render unto Caesar what is Caesar&#8217;s : <a href="http://rapture.io/jsonSupport">Rapture.io</a> proved that it could be done quite easily and I must say I <del>stole</del> got inspired by a few implementation details from them! (<i>specially the @inline implicit conversion for string interpolation class which is required due to a ValueClass limitation that should be removed in further Scala versions</i>)
</div>


<p>First of all, code samples as usual&#8230;</p>

<h2>Create JsValue using String interpolation</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;foo&quot; : &quot;bar&quot;, &quot;foo2&quot; : 123 }&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span> <span class="o">==</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;bar&quot;</span><span class="o">,</span> <span class="s">&quot;foo2&quot;</span> <span class="o">-&gt;</span> <span class="mi">123</span><span class="o">)</span>
</span><span class='line'><span class="n">res1</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;[ 1, true, &quot;foo&quot;, 345.234]&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">[</span><span class="err">1</span>,<span class="kt">true</span>,<span class="err">&quot;</span><span class="kt">foo</span><span class="err">&quot;</span>,<span class="err">345</span><span class="kt">.</span><span class="err">234</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span> <span class="o">==</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="mf">345.234</span><span class="o">)</span>
</span><span class='line'><span class="n">res2</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yes, pure Json in a string&#8230;</p>

<p>How does it work? Using <a href="http://docs.scala-lang.org/overviews/core/string-interpolation.html">String interpolation</a> introduced in Scala 2.10.0 and Jackson for the parsing&#8230;</p>

<p>In String interpolation, you can also put Scala variables directly in the interpolated string. You can do the same in Json interpolation.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">alpha</span> <span class="k">=</span> <span class="s">&quot;foo&quot;</span>
</span><span class='line'><span class="n">alpha</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">foo</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">beta</span> <span class="k">=</span> <span class="mi">123L</span>
</span><span class='line'><span class="n">beta</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">123</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;alpha&quot; : &quot;$alpha&quot;, &quot;beta&quot; : $beta}&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;alpha&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">foo</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;beta&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">gamma</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'><span class="n">gamma</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsArray</span> <span class="o">=</span> <span class="o">[</span><span class="err">1</span>,<span class="err">2</span>,<span class="err">3</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">delta</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;key1&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;value1&quot;</span><span class="o">,</span> <span class="s">&quot;key2&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;value2&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">delta</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsObject</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">value1</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">value2</span><span class="err">&quot;</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">     |         {</span>
</span><span class='line'><span class="s">     |           &quot;alpha&quot; : &quot;$alpha&quot;,</span>
</span><span class='line'><span class="s">     |           &quot;beta&quot; : $beta,</span>
</span><span class='line'><span class="s">     |           &quot;gamma&quot; : $gamma,</span>
</span><span class='line'><span class="s">     |           &quot;delta&quot; : $delta,</span>
</span><span class='line'><span class="s">     |           &quot;eta&quot; : {</span>
</span><span class='line'><span class="s">     |             &quot;foo&quot; : &quot;bar&quot;,</span>
</span><span class='line'><span class="s">     |             &quot;foo2&quot; : [ &quot;bar21&quot;, 123, true, null ]</span>
</span><span class='line'><span class="s">     |           }</span>
</span><span class='line'><span class="s">     |         }</span>
</span><span class='line'><span class="s">     |       &quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;alpha&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">foo</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;beta&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;gamma&quot;</span><span class="k">:</span><span class="err">[1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="err">]</span><span class="o">,</span><span class="s">&quot;delta&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key1</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value1</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key2</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value2</span><span class="err">&quot;</span><span class="o">},</span><span class="s">&quot;eta&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">foo</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">foo2</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[</span><span class="err">&quot;</span><span class="kt">bar21</span><span class="err">&quot;</span>,<span class="err">123</span>,<span class="kt">true</span>,<span class="kt">null</span><span class="o">]}}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Please note that string variables must be put between <code>"..."</code> because without it the parser will complain.</em></p>

<p>Ok, so now it&#8217;s really trivial to write Json, isn&#8217;t it?</p>

<p>String interpolation just replaces the string you write in your code by some Scala code concatenating pieces of strings with variables as you would write yourself. Kind-of: <code>s"toto ${v1} tata" =&gt; "toto + v1 + " tata" + ...</code></p>

<p>But at compile-time, it doesn&#8217;t compile your String into Json: the Json parsing is done at runtime with string interpolation. So using Json interpolation doesn&#8217;t provide you with compile-time type safety and parsing for now.</p>

<blockquote><p>In the future, I may replace String interpolation by a real Macro which will also parse the string at compile-time. Meanwhile, if you want to rely on type-safety, go on using <code>Json.obj / Json.arr</code> API.</p></blockquote>

<br/>


<h2>Json pattern matching</h2>

<p>What is one of the first feature that you discover when learning Scala and that makes you say immediately: &#8220;Whoaa Cool feature&#8221;? <strong>Pattern Matching</strong>.</p>

<p>You can write:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">opt</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">opt</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">toto</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">opt</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">&quot;not empty option:$s&quot;</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">None</span>    <span class="k">=&gt;</span> <span class="s">&quot;empty option&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res2</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">not</span> <span class="n">empty</span> <span class="n">option</span><span class="k">:</span><span class="kt">toto</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// or direct variable assignement using pattern matching</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="nc">Some</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="k">=</span> <span class="n">opt</span>
</span><span class='line'><span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">toto</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why not doing this with Json?</p>

<p>And&#8230;. Here it is with Json pattern matching!!!</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;bar&quot;</span><span class="o">,</span> <span class="s">&quot;foo2&quot;</span> <span class="o">-&gt;</span> <span class="mi">123L</span><span class="o">)</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsObject</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;foo&quot; : $a, &quot;foo2&quot; : $b }&quot;&quot;&quot;</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">)</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res5</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[(</span><span class="kt">play.api.libs.json.JsValue</span>, <span class="kt">play.api.libs.json.JsValue</span><span class="o">)]</span> <span class="k">=</span>
</span><span class='line'><span class="nc">Some</span><span class="o">((</span><span class="s">&quot;bar&quot;</span><span class="o">,</span><span class="mi">123</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;foo&quot; : $a, &quot;foo2&quot; : $b}&quot;&quot;&quot;</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot; { &quot;foo&quot; : &quot;bar&quot;, &quot;foo2&quot; : 123 }&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">a</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="s">&quot;bar&quot;</span>
</span><span class='line'><span class="n">b</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="mi">123</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">json</span><span class="s">&quot;[ $v1, 2, $v2, 4 ]&quot;</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">)</span>
</span><span class='line'><span class="n">v1</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">v2</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Magical?</p>

<p>Not at all&#8230; Just <code>unapplySeq</code> using the tool that enables this kind of Json manipulation as trees: <code>JsZipper</code>&#8230;</p>

<blockquote><p>The more I use JsZippers, the more I find fields where I can use them ;)</p></blockquote>

<br/>


<h2>More complex Json pattern matching</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{</span>
</span><span class='line'><span class="s">    &quot;key1&quot; : &quot;value1&quot;,</span>
</span><span class='line'><span class="s">    &quot;key2&quot; : [</span>
</span><span class='line'><span class="s">      &quot;alpha&quot;,</span>
</span><span class='line'><span class="s">      { &quot;foo&quot; : &quot;bar&quot;,</span>
</span><span class='line'><span class="s">        &quot;foo2&quot; : {</span>
</span><span class='line'><span class="s">          &quot;key21&quot; : &quot;value21&quot;,</span>
</span><span class='line'><span class="s">          &quot;key22&quot; : [ &quot;value221&quot;, 123, false ]</span>
</span><span class='line'><span class="s">        }</span>
</span><span class='line'><span class="s">      },</span>
</span><span class='line'><span class="s">      true,</span>
</span><span class='line'><span class="s">      123.45</span>
</span><span class='line'><span class="s">    ]</span>
</span><span class='line'><span class="s">  }&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">value1</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">alpha</span><span class="err">&quot;</span><span class="o">,{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key21</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value21</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key22</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[</span><span class="err">&quot;</span><span class="kt">value221</span><span class="err">&quot;</span>,<span class="err">123</span>,<span class="kt">false</span><span class="o">]}},</span><span class="kc">true</span><span class="o">,</span><span class="mf">123.45</span><span class="err">]</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;key1&quot; : $v1, &quot;key2&quot; : [&quot;alpha&quot;, $v2, true, $v3] }&quot;&quot;&quot;</span> <span class="k">=</span> <span class="n">js</span>
</span><span class='line'><span class="n">v1</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="s">&quot;value1&quot;</span>
</span><span class='line'><span class="n">v2</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key21</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value21</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key22</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[</span><span class="err">&quot;</span><span class="kt">value221</span><span class="err">&quot;</span>,<span class="err">123</span>,<span class="kt">false</span><span class="o">]}}</span>
</span><span class='line'><span class="n">v3</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="mf">123.45</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{</span>
</span><span class='line'><span class="s">      &quot;key1&quot; : &quot;value1&quot;,</span>
</span><span class='line'><span class="s">      &quot;key2&quot; : [&quot;alpha&quot;, $v1, true, $v2]</span>
</span><span class='line'><span class="s">    }&quot;&quot;&quot;</span>   <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="n">res9</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[(</span><span class="kt">play.api.libs.json.JsValue</span>, <span class="kt">play.api.libs.json.JsValue</span><span class="o">)]</span> <span class="k">=</span>
</span><span class='line'><span class="nc">Some</span><span class="o">(({</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key21</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value21</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key22</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[</span><span class="err">&quot;</span><span class="kt">value221</span><span class="err">&quot;</span>,<span class="err">123</span>,<span class="kt">false</span><span class="o">]}},</span><span class="mf">123.45</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A non matching example maybe ? ;)</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span>  <span class="n">js</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{</span>
</span><span class='line'><span class="s">      &quot;key1&quot; : &quot;value1&quot;,</span>
</span><span class='line'><span class="s">      &quot;key2&quot; : [&quot;alpha&quot;, $v1, false, $v2]</span>
</span><span class='line'><span class="s">    }&quot;&quot;&quot;</span>   <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="n">res10</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[(</span><span class="kt">play.api.libs.json.JsValue</span>, <span class="kt">play.api.libs.json.JsValue</span><span class="o">)]</span> <span class="k">=</span> <span class="nc">None</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you like that, please tell it so that I know whether it&#8217;s worth pushing it to Play Framework!</p>

<br/>


<h2>Using these features right now in a Scala/SBT project</h2>

<p>These features are part of my experimental project JsZipper presented in <a href="http://mandubian.com/2013/05/01/JsZipper/">this article</a>.</p>

<p>To use it, add following lines to your SBT <code>Build.scala</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">ApplicationBuild</span> <span class="k">extends</span> <span class="nc">Build</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">mandubianRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;Mandubian repository snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/snapshots/&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;Mandubian repository releases&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/releases/&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">main</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="nc">Project</span><span class="o">(</span><span class="n">appName</span><span class="o">,</span> <span class="n">appVersion</span><span class="o">,</span> <span class="n">appDependencies</span><span class="o">).</span><span class="n">settings</span><span class="o">(</span>
</span><span class='line'>    <span class="n">resolvers</span> <span class="o">++=</span> <span class="n">mandubianRepo</span><span class="o">,</span>
</span><span class='line'>    <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>      <span class="s">&quot;play-json-zipper&quot;</span>  <span class="o">%%</span> <span class="s">&quot;play-json-zipper&quot;</span>    <span class="o">%</span> <span class="s">&quot;0.1-SNAPSHOT&quot;</span><span class="o">,</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In your Scala code, import following packages</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">syntax._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.functional.syntax._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.extensions._</span>
</span></code></pre></td></tr></table></div></figure>


<p>PatternMatch your fun!</p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/06/11/play-autosource/">Play AutoSource : 2&#8217;30 Kickstart Full REST & CRUD Datasource in Play App (Demo&#8217;ed With ReactiveMongo + AngularJS)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-11T18:18:00+02:00" pubdate data-updated="true">Jun 11<span>th</span>, 2013</time>
        
         | <a href="/2013/06/11/play-autosource/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>Now you should use play-autosource 2.0 correcting a few issues &amp; introducing ActionBuilder from play2.2</h4>

<p>The module code and sample app can be found on Github <a href="https://github.com/mandubian/play-autosource">here</a></p>

<br/>


<p>Here we go:</p>

<h3>0&#8217; : Create App</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">play2</span> <span class="k">new</span> <span class="n">auto</span><span class="o">-</span><span class="n">persons</span>
</span><span class='line'>       <span class="k">_</span>            <span class="k">_</span>
</span><span class='line'> <span class="k">_</span> <span class="nc">__</span> <span class="o">|</span> <span class="o">|</span> <span class="nc">__</span> <span class="k">_</span> <span class="k">_</span>  <span class="k">_</span><span class="o">|</span> <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="-Symbol">&#39;_</span> <span class="o">\|</span> <span class="o">|/</span> <span class="k">_</span><span class="err">&#39;</span> <span class="o">|</span> <span class="o">||</span> <span class="o">|</span><span class="k">_</span><span class="o">|</span>
</span><span class='line'><span class="o">|</span>  <span class="nc">__/|</span><span class="k">_</span><span class="o">|\</span><span class="nc">____|\__</span> <span class="o">(</span><span class="k">_</span><span class="o">)</span>
</span><span class='line'><span class="o">|</span><span class="k">_</span><span class="o">|</span>            <span class="o">|</span><span class="nc">__</span><span class="o">/</span>
</span><span class='line'>
</span><span class='line'><span class="n">play</span><span class="o">!</span> <span class="mf">2.1</span><span class="o">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">using</span> <span class="nc">Java</span> <span class="mf">1.7</span><span class="o">.</span><span class="mi">0</span><span class="n">_21</span> <span class="n">and</span> <span class="nc">Scala</span> <span class="mf">2.10</span><span class="o">.</span><span class="mi">0</span><span class="o">),</span> <span class="n">http</span><span class="o">://</span><span class="n">www</span><span class="o">.</span><span class="n">playframework</span><span class="o">.</span><span class="n">org</span>
</span><span class='line'>
</span><span class='line'><span class="nc">The</span> <span class="k">new</span> <span class="n">application</span> <span class="n">will</span> <span class="n">be</span> <span class="n">created</span> <span class="n">in</span> <span class="o">/</span><span class="nc">Users</span><span class="o">/</span><span class="n">pvo</span><span class="o">/</span><span class="n">zenexity</span><span class="o">/</span><span class="n">workspaces</span><span class="o">/</span><span class="n">workspace_mandubian</span><span class="o">/</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span>
</span><span class='line'>
</span><span class='line'><span class="nc">What</span> <span class="n">is</span> <span class="n">the</span> <span class="n">application</span> <span class="n">name</span><span class="o">?</span> <span class="o">[</span><span class="kt">auto-persons</span><span class="o">]</span>
</span><span class='line'><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Which</span> <span class="n">template</span> <span class="k">do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="k">this</span> <span class="k">new</span> <span class="n">application</span><span class="o">?</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">1</span>             <span class="o">-</span> <span class="nc">Create</span> <span class="n">a</span> <span class="n">simple</span> <span class="nc">Scala</span> <span class="n">application</span>
</span><span class='line'>  <span class="mi">2</span>             <span class="o">-</span> <span class="nc">Create</span> <span class="n">a</span> <span class="n">simple</span> <span class="nc">Java</span> <span class="n">application</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="mi">1</span>
</span><span class='line'><span class="nc">OK</span><span class="o">,</span> <span class="n">application</span> <span class="n">auto</span><span class="o">-</span><span class="n">persons</span> <span class="n">is</span> <span class="n">created</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Have</span> <span class="n">fun</span><span class="o">!</span>
</span></code></pre></td></tr></table></div></figure>


<h3>10&#8217; : edit project/Build.scala, add <code>play-autosource:reactivemongo</code> dependency</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">mandubianRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;Mandubian repository snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/snapshots/&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Mandubian repository releases&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/releases/&quot;</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">appDependencies</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">main</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="nc">Project</span><span class="o">(</span><span class="n">appName</span><span class="o">,</span> <span class="n">appVersion</span><span class="o">,</span> <span class="n">appDependencies</span><span class="o">).</span><span class="n">settings</span><span class="o">(</span>
</span><span class='line'>  <span class="n">resolvers</span> <span class="o">++=</span> <span class="n">mandubianRepo</span><span class="o">,</span>
</span><span class='line'>  <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;play-autosource&quot;</span>   <span class="o">%%</span> <span class="s">&quot;reactivemongo&quot;</span>       <span class="o">%</span> <span class="s">&quot;1.0-SNAPSHOT&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;org.specs2&quot;</span>        <span class="o">%%</span> <span class="s">&quot;specs2&quot;</span>              <span class="o">%</span> <span class="s">&quot;1.13&quot;</span>        <span class="o">%</span> <span class="s">&quot;test&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;junit&quot;</span>              <span class="o">%</span> <span class="s">&quot;junit&quot;</span>               <span class="o">%</span> <span class="s">&quot;4.8&quot;</span>         <span class="o">%</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>30&#8217; : Create new ReactiveMongo AutoSource Controller in app/Person.scala</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">controllers</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.mvc._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// BORING IMPORTS</span>
</span><span class='line'><span class="c1">// Json</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.functional.syntax._</span>
</span><span class='line'><span class="c1">// Reactive JSONCollection</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.modules.reactivemongo.json.collection.JSONCollection</span>
</span><span class='line'><span class="c1">// Autosource</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.autosource.reactivemongo._</span>
</span><span class='line'><span class="c1">// AutoSource is Async so imports Scala Future implicits</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.Play.current</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// &gt;&gt;&gt; THE IMPORTANT PART &lt;&lt;&lt;</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">ReactiveMongoAutoSourceController</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>50&#8217; : Add AutoSource routes at beginning <code>conf/routes</code></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-&gt;</span>      <span class="o">/</span><span class="n">person</span>                     <span class="n">controllers</span><span class="o">.</span><span class="nc">Persons</span>
</span></code></pre></td></tr></table></div></figure>


<h3>60&#8217; : Create <code>conf/play.plugins</code> to initialize ReactiveMongo Plugin</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="mi">400</span><span class="k">:</span><span class="kt">play.modules.reactivemongo.ReactiveMongoPlugin</span>
</span></code></pre></td></tr></table></div></figure>


<h3>70&#8217; : Append to <code>conf/application.conf</code> to initialize MongoDB connection</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">mongodb</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span><span class="s">&quot;mongodb://localhost:27017/persons&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>80&#8217; : Launch application</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">play2</span> <span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Loading</span> <span class="n">project</span> <span class="n">definition</span> <span class="n">from</span> <span class="o">/.../</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">/</span><span class="n">project</span>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Set</span> <span class="n">current</span> <span class="n">project</span> <span class="n">to</span> <span class="n">auto</span><span class="o">-</span><span class="n">persons</span> <span class="o">(</span><span class="n">in</span> <span class="n">build</span> <span class="n">file</span><span class="o">:/.../</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">/)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Updating</span> <span class="o">{</span><span class="n">file</span><span class="o">:/.../</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">/}</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">...</span>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Done</span> <span class="n">updating</span><span class="o">.</span>
</span><span class='line'><span class="o">---</span> <span class="o">(</span><span class="nc">Running</span> <span class="n">the</span> <span class="n">application</span> <span class="n">from</span> <span class="nc">SBT</span><span class="o">,</span> <span class="n">auto</span><span class="o">-</span><span class="n">reloading</span> <span class="n">is</span> <span class="n">enabled</span><span class="o">)</span> <span class="o">---</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="n">play</span> <span class="o">-</span> <span class="nc">Listening</span> <span class="k">for</span> <span class="nc">HTTP</span> <span class="n">on</span> <span class="o">/</span><span class="mi">0</span><span class="k">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">9000</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="kt">Server</span> <span class="kt">started</span><span class="o">,</span> <span class="kt">use</span> <span class="kt">Ctrl+D</span> <span class="kt">to</span> <span class="kt">stop</span> <span class="kt">and</span> <span class="kt">go</span> <span class="kt">back</span> <span class="kt">to</span> <span class="kt">the</span> <span class="kt">console...</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Compiling</span> <span class="mi">5</span> <span class="nc">Scala</span> <span class="n">sources</span> <span class="n">and</span> <span class="mi">1</span> <span class="nc">Java</span> <span class="n">source</span> <span class="n">to</span> <span class="o">/.../</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">scala</span><span class="o">-</span><span class="mf">2.10</span><span class="o">/</span><span class="n">classes</span><span class="o">...</span>
</span><span class='line'><span class="o">[</span><span class="kt">warn</span><span class="o">]</span> <span class="n">there</span> <span class="n">were</span> <span class="mi">2</span> <span class="n">feature</span> <span class="n">warnings</span><span class="o">;</span> <span class="n">re</span><span class="o">-</span><span class="n">run</span> <span class="k">with</span> <span class="o">-</span><span class="n">feature</span> <span class="k">for</span> <span class="n">details</span>
</span><span class='line'><span class="o">[</span><span class="kt">warn</span><span class="o">]</span> <span class="n">one</span> <span class="n">warning</span> <span class="n">found</span>
</span><span class='line'><span class="o">[</span><span class="kt">success</span><span class="o">]</span> <span class="nc">Compiled</span> <span class="n">in</span> <span class="mi">6</span><span class="n">s</span>
</span></code></pre></td></tr></table></div></figure>


<h3>100&#8217; : Insert your first 2 persons with Curl</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">25</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">33</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;51</span><span class="kt">b868ef31d4002c0bac8ba4</span><span class="err">&quot;</span><span class="o">}</span> <span class="kt">-&gt;</span> <span class="kt">oh</span> <span class="kt">a</span> <span class="kt">BSONObjectId</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">43</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">33</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;51</span><span class="kt">b868fa31d4002c0bac8ba5</span><span class="err">&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>110&#8217; : Get all persons</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">118</span>
</span><span class='line'>
</span><span class='line'><span class="err">[</span>
</span><span class='line'>  <span class="o">{</span><span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">25</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;id&quot;</span><span class="k">:</span><span class="err">&quot;51</span><span class="kt">b868ef31d4002c0bac8ba4</span><span class="err">&quot;</span><span class="o">},</span>
</span><span class='line'>  <span class="o">{</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">43</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;id&quot;</span><span class="k">:</span><span class="err">&quot;51</span><span class="kt">b868fa31d4002c0bac8ba5</span><span class="err">&quot;</span><span class="o">}</span>
</span><span class='line'><span class="err">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>115&#8217; : Delete one person</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">DELETE</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/</span><span class="err">51</span><span class="kt">b868ef31d4002c0bac8ba4</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">33</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;51</span><span class="kt">b868ef31d4002c0bac8ba4</span><span class="err">&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>120&#8217; : Verify person was deleted</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">GET</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/</span><span class="err">51</span><span class="kt">b868ef31d4002c0bac8ba4</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">404</span> <span class="nc">Not</span> <span class="nc">Found</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">text/plain</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">37</span>
</span><span class='line'>
</span><span class='line'><span class="kt">ID</span> <span class="err">51</span><span class="kt">b868ef31d4002c0bac8ba4</span> <span class="kt">not</span> <span class="kt">found</span>
</span></code></pre></td></tr></table></div></figure>


<h3>125&#8217; : Update person</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">PUT</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">35</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/</span><span class="err">51</span><span class="kt">b868fa31d4002c0bac8ba5</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">33</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;51</span><span class="kt">b868fa31d4002c0bac8ba5</span><span class="err">&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>130&#8217; : Batch insert 2 persons (johnny &amp; tom) with more properties</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">[{</span> <span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">johnny</span><span class="err">&quot;</span>, <span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">15</span>, <span class="err">&quot;</span><span class="kt">address</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">city</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">Paris</span><span class="err">&quot;</span>, <span class="err">&quot;</span><span class="kt">street</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">rue</span> <span class="kt">quincampoix</span><span class="err">&quot;</span><span class="o">}</span> <span class="o">}</span>,<span class="o">{</span> <span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">tom</span><span class="err">&quot;</span>, <span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">3</span>, <span class="err">&quot;</span><span class="kt">address</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">city</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">Trifouilly</span><span class="err">&quot;</span>, <span class="err">&quot;</span><span class="kt">street</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">rue</span> <span class="kt">des</span> <span class="kt">accidents</span> <span class="kt">de</span> <span class="kt">poucettes</span><span class="err">&quot;</span><span class="o">}</span> <span class="o">}]</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/batch</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">8</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">nb</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">2</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>135&#8217; : Get all persons whose name begins by &#8220;john&#8221;</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">$regex</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">^john</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/find</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">175</span>
</span><span class='line'>
</span><span class='line'><span class="err">[</span>
</span><span class='line'>  <span class="o">{</span><span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">35</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;id&quot;</span><span class="k">:</span><span class="err">&quot;51</span><span class="kt">b868fa31d4002c0bac8ba5</span><span class="err">&quot;</span><span class="o">},</span>
</span><span class='line'>  <span class="o">{</span><span class="s">&quot;id&quot;</span><span class="k">:</span><span class="err">&quot;51</span><span class="kt">b86a1931d400bc01ac8ba8</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">johnny</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">15</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;address&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">city</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">Paris</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">street</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">rue</span> <span class="kt">quincampoix</span><span class="err">&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="err">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>140&#8217; : Delete all persons</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">DELETE</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/batch</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">text/plain</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">7</span>
</span><span class='line'>
</span><span class='line'><span class="kt">deleted</span>
</span></code></pre></td></tr></table></div></figure>


<h3>145&#8217; : Take 5&#8217; rest</h3>

<br/>


<h3>150&#8217; : Done</h3>

<br/>


<br/>


<h2>So what was demonstrated here?</h2>

<p>With Play-Autosource, in a few lines, you obtain :</p>

<ul>
<li><strong>A backed abstract datasource (here implemented for <a href="http://www.reactivemongo.org">ReactiveMongo</a> but it could be implemented for other DBs)</strong></li>
<li><strong>All CRUD operations are exposed as pure REST services</strong></li>
<li><strong>The datasource is typesafe (here <code>JsObject</code> but we&#8217;ll show later that we can use any type)</strong></li>
</ul>


<p>It can be useful to kickstart any application in which you&#8217;re going to work iteratively on our data models in direct interaction with front-end.</p>

<p>It could also be useful to Frontend developers who need to bootstrap frontend code with Play Framework application backend. With <em>Autosource</em>, they don&#8217;t have to care about modelizing strictly a datasource on server-side and can dig into their client-side code quite quickly.</p>

<br/>


<br/>


<h2>Adding constraints &amp; validation</h2>

<blockquote><p>Now you tell me: &#8220;Hey that&#8217;s stupid, you store directly <code>JsObject</code> but my data are structured and must be validated before inserting them&#8221;</p></blockquote>

<p>Yes you&#8217;re right so let&#8217;s add some type constraints on our data:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">ReactiveMongoAutoSourceController</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// we validate the received Json as JsObject because the autosource type is JsObject</span>
</span><span class='line'>  <span class="c1">// and we add classic validations on types</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">val</span> <span class="n">reader</span> <span class="k">=</span> <span class="nc">__</span><span class="o">.</span><span class="n">read</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="n">keepAnd</span> <span class="o">(</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;age&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="nc">Reads</span><span class="o">.</span><span class="n">min</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="n">keepAnd</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">max</span><span class="o">(</span><span class="mi">117</span><span class="o">))</span>
</span><span class='line'>  <span class="o">).</span><span class="n">tupled</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Try it now:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;nameXXX&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">25</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">400</span> <span class="nc">Bad</span> <span class="nc">Request</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">62</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">obj.name</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[{</span><span class="err">&quot;</span><span class="kt">msg</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">validate.error.missing-path</span><span class="err">&quot;</span>,<span class="err">&quot;</span><span class="kt">args</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[]}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can add progressively constraints on your data in a few lines. With <code>AutoSource</code>, you don&#8217;t need to determine immediately the exact shape of your models and you can work with <code>JsObject</code> directly as long as you need. Sometimes, you&#8217;ll even discover that you don&#8217;t even need a structured model and <code>JsObject</code> will be enough. (<em>but I also advise to design a bit things before implementing ;)</em>)</p>

<blockquote><p>Keep in mind that our sample is based on an implementation for <em>ReactiveMongo</em> so using Json is natural. For other DB, other data structure might be more idiomatic&#8230;</p></blockquote>

<br/>


<br/>


<h2>Use typesafe models</h2>

<blockquote><p>Now you tell me: &#8220;Funny but but but <code>JsObject</code> is evil because it&#8217;s not strict enough. I&#8217;m a OO developer (maybe abused by ORM gurus when I was young) and my models are case-classes&#8230;&#8221;</p></blockquote>

<p>Yes you&#8217;re right, sometimes, you need more business logic or you want to separate concerns very strictly and your model will be shaped as case-classes.</p>

<p>So let&#8217;s replace our nice little <code>JsObject</code> by a more serious <code>case class</code>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// the model</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Person</span><span class="o">{</span>
</span><span class='line'>  <span class="c1">// the famous Json Macro which generates at compile-time a Reads[Person] in a one-liner</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">fmt</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">format</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The autosource... shorter than before</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">ReactiveMongoAutoSourceController</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note that I removed the validations I had introduced before because there are not useful anymore: using Json macros, I created an implicit <code>Format[Person]</code> which is used implicitly by AutoSource.</p>

<blockquote><p>So, now you can see why I consider AutoSource as a <em>typesafe datasource</em>.</p></blockquote>

<br/>


<br/>


<h2>Let&#8217;s be front-sexy with AngularJS</h2>

<p>You all know that <a href="http://www.angularjs.org/">AngularJS</a> is the new kid on the block and that you must use it if you want to be sexy nowadays.</p>

<p>I&#8217;m already sexy so I must be able to use it without understanding anything to it and that&#8217;s exactly what I&#8217;ve done: in 30mn without knowing anything about Angular (but a few concepts), I wrote a dumb CRUD front page plugged on my wonderful <code>AutoSource</code>.</p>

<br/>


<h3>Client DS in app/assets/javascripts/persons.js</h3>

<p>This is the most important part of this sample: we need to call our CRUD autosource endpoints from angularJS.</p>

<p>We are going to use <em>Angular resources</em> for it even if it&#8217;s not really the best feature of AngularJS. Anyway, in a few lines, it works pretty well in my raw case.</p>

<p><em>(thanks to Paul Dijou for reviewing this code because I repeat I don&#8217;t know angularJS at all and I wrote this in 20mn without trying to understand anything :D)</em></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span>
</span><span class='line'>  <span class="c1">// injects ngResource</span>
</span><span class='line'>  <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ngResource&quot;</span><span class="p">])</span>
</span><span class='line'>  <span class="c1">// creates the Person factory backed by our autosource</span>
</span><span class='line'>  <span class="c1">// Please remark the url person/:id which will use transparently our CRUD AutoSource endpoints</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;Person&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;$resource&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$resource</span><span class="p">){</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">$resource</span><span class="p">(</span><span class="s1">&#39;person/:id&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;@id&quot;</span> <span class="p">});</span>
</span><span class='line'>  <span class="p">}])</span>
</span><span class='line'>  <span class="c1">// creates a controller</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s2">&quot;PersonCtrl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;$scope&quot;</span><span class="p">,</span> <span class="s2">&quot;Person&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">Person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">createForm</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// retrieves all persons</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// creates a person using createForm and refreshes list</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">createForm</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">createForm</span><span class="p">.</span><span class="nx">age</span><span class="p">});</span>
</span><span class='line'>      <span class="nx">person</span><span class="p">.</span><span class="nx">$save</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">createForm</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// removes a person and refreshes list</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">person</span><span class="p">.</span><span class="nx">$remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// updates a person and refreshes list</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">person</span><span class="p">.</span><span class="nx">$save</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CRUD UI in index.scala.html</h3>

<p>Now let&#8217;s create our CRUD UI page using angular directives. We need to be able to:</p>

<ul>
<li>list persons</li>
<li>update/delete each person</li>
<li>create new persons</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>@(message: String)
</span><span class='line'>
</span><span class='line'>@main(&quot;Welcome to Play 2.1&quot;) {
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">ng-controller=</span><span class="s">&quot;PersonCtrl&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="c">&lt;!-- create form --&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>name:<span class="nt">&lt;/label&gt;&lt;input</span> <span class="na">ng-model=</span><span class="s">&quot;createForm.name&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;age&quot;</span><span class="nt">&gt;</span>age:<span class="nt">&lt;/label&gt;&lt;input</span> <span class="na">ng-model=</span><span class="s">&quot;createForm.age&quot;</span> <span class="na">type=</span><span class="s">&quot;number&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;button</span> <span class="na">ng-click=</span><span class="s">&quot;create()&quot;</span><span class="nt">&gt;</span>Create new person<span class="nt">&lt;/button&gt;</span>
</span><span class='line'>      <span class="nt">&lt;hr/&gt;</span>
</span><span class='line'>      <span class="c">&lt;!-- List of persons with update/delete buttons --&gt;</span>
</span><span class='line'>      <span class="nt">&lt;table&gt;</span>
</span><span class='line'>      <span class="nt">&lt;thead&gt;&lt;th&gt;</span>name<span class="nt">&lt;/th&gt;&lt;th&gt;</span>age<span class="nt">&lt;/th&gt;&lt;td&gt;</span>actions<span class="nt">&lt;/td&gt;&lt;/thead&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tbody</span> <span class="na">ng-repeat=</span><span class="s">&quot;person in persons&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">ng-model=</span><span class="s">&quot;person.name&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;number&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;person.age&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;button</span> <span class="na">ng-click=</span><span class="s">&quot;update(person)&quot;</span><span class="nt">&gt;</span>Update<span class="nt">&lt;/button&gt;&lt;button</span> <span class="na">ng-click=</span><span class="s">&quot;remove(person)&quot;</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/button&gt;&lt;/td&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h3>Import Angular in main.scala.html</h3>

<p>We need to import angularjs in our application and create angular application using <code>ng-app</code></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>@(title: String)(content: Html)
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- please note the directive ng-app to initialize angular app--&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">ng-app=</span><span class="s">&quot;app&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>        <span class="nt">&lt;title&gt;</span>@title<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="na">href=</span><span class="s">&quot;@routes.Assets.at(&quot;</span><span class="na">stylesheets</span><span class="err">/</span><span class="na">main</span><span class="err">.</span><span class="na">css</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;shortcut icon&quot;</span> <span class="na">type=</span><span class="s">&quot;image/png&quot;</span> <span class="na">href=</span><span class="s">&quot;@routes.Assets.at(&quot;</span><span class="na">images</span><span class="err">/</span><span class="na">favicon</span><span class="err">.</span><span class="na">png</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;@routes.Assets.at(&quot;</span><span class="na">javascripts</span><span class="err">/</span><span class="na">jquery-1</span><span class="err">.</span><span class="na">9</span><span class="err">.</span><span class="na">0</span><span class="err">.</span><span class="na">min</span><span class="err">.</span><span class="na">js</span><span class="err">&quot;)&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular-resource.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;@routes.Assets.at(&quot;</span><span class="na">javascripts</span><span class="err">/</span><span class="na">person</span><span class="err">.</span><span class="na">js</span><span class="err">&quot;)&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>        @content
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>What else??? Oh yes Security&#8230;</h2>

<blockquote><p>I know what you think: &#8220;Uhuh, the poor guy who exposes his DB directly on the network and who is able to delete everything without any security&#8221;</p></blockquote>

<p>Once again, you&#8217;re right. <em>(yes I know I love flattery)</em></p>

<p>Autosource is by default not secured in any way and actually I don&#8217;t really care about security because this is your job to secure your exposed APIs and there are so many ways to secure services that I prefer to let you choose the one you want.</p>

<p>Anyway, I&#8217;m a nice boy and I&#8217;m going to show you how you could secure the <code>DELETE</code> endpoint using the authentication action composition sample given in <a href="http://www.playframework.com/documentation/2.1.1/ScalaActionsComposition">Play Framework documentation</a>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// FAKE USER class to simulate a user extracted from DB.</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'><span class="k">object</span> <span class="nc">User</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">ReactiveMongoAutoSourceController</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// The action composite directly copied for PlayFramework doc</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">Authenticated</span><span class="o">(</span><span class="n">action</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=&gt;</span> <span class="nc">EssentialAction</span><span class="o">)</span><span class="k">:</span> <span class="kt">EssentialAction</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Let&#39;s define a helper function to retrieve a User</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">getUser</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">RequestHeader</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">).</span><span class="n">flatMap</span><span class="o">(</span><span class="n">u</span> <span class="k">=&gt;</span> <span class="nc">User</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">u</span><span class="o">))</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Now let&#39;s define the new Action</span>
</span><span class='line'>    <span class="nc">EssentialAction</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="n">getUser</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">u</span> <span class="k">=&gt;</span> <span class="n">action</span><span class="o">(</span><span class="n">u</span><span class="o">)(</span><span class="n">request</span><span class="o">)).</span><span class="n">getOrElse</span> <span class="o">{</span>
</span><span class='line'>        <span class="nc">Done</span><span class="o">(</span><span class="nc">Unauthorized</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// &gt;&gt;&gt; IMPORTANT PART &lt;&lt;&lt;</span>
</span><span class='line'>  <span class="c1">// We simply override the delete action</span>
</span><span class='line'>  <span class="c1">// If authenticated, we call the original action</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">delete</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">BSONObjectID</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Authenticated</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">super</span><span class="o">.</span><span class="n">delete</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">index</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="n">views</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="o">(</span><span class="s">&quot;ok&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the login action which log any user</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">login</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="s">&quot;logged in&quot;</span><span class="o">).</span><span class="n">withSession</span><span class="o">(</span><span class="s">&quot;user&quot;</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the logout action which log out any user</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">logout</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="s">&quot;logged out&quot;</span><span class="o">).</span><span class="n">withNewSession</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing to complicated here.
If you need to add headers in your responses and params to querystring, it&#8217;s easy to wrap autosource actions. Please refer to Play Framework doc for more info&#8230;</p>

<blockquote><p>I won&#8217;t try it here, the article is already too long but it should work&#8230;</p></blockquote>

<br/>


<br/>


<h2>Play-Autosource is DB agnostic</h2>

<p><code>Play-Autosource</code> Core is independent of the DB and provides Reactive (Async/Nonblocking) APIs to fulfill PlayFramework requirements.</p>

<p>Naturally this 1st implementation uses <a href="http://www.reactivemongo.org">ReactiveMongo</a> which is one of the best sample of DB reactive driver. MongoDB fits very well in this concept too because document records are really compliant to JSON datasources.</p>

<p>But other implementations for other DB can be done and I count on you people to contribute them.</p>

<blockquote><p>DB implementation contributions are welcome (Play-Autosource is just <em>Apache2 licensed</em>) and AutoSource API are subject to evolutions if they appear to be erroneous.</p></blockquote>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Play-Autosource provides a very fast &amp; lightweight way to create a REST CRUD typesafe datasource in your Play/Scala application. You can begin with blob data such as <code>JsObject</code> and then elaborate the model of your data progressively by adding constraints or types to it.</p>

<p>There would be many more things to say about <code>Play/Autosource</code>:</p>

<ul>
<li>you can also override writers to change output format</li>
<li>you have some alpha streaming API also</li>
<li>etc&#8230;</li>
</ul>


<p>There are also lots of features to improve/add because it&#8217;s still a very draft module.</p>

<p>If you like it and have ideas, don&#8217;t hesitate to discuss, to contribute, to improve etc&#8230;</p>

<p><code>curl -X POST -d "{ "coding" : "Have fun"} http://localhost:9000/developer</code></p>

<p>PS: Thanks to James Roper for his <a href="http://jazzy.id.au/default/2013/05/08/advanced_routing_in_play_framework.html">article about advanced routing in Play Framework which I copied shamefully XD</a></p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li class="previous"><a href="/blog/page/2/">&larr; Older</a></li>
    
    <li><a href="/blog/archives">Blog Archives</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/2014/03/10/zpark-ml-nio-3/">ZPark-Ztream II (Part 3/3): Fancy Spark Streamed Machine-Learning & new Scalaz-Stream NIO API</a>
      </li>
    
      <li class="post">
        <a href="/2014/03/09/zpark-ml-nio-2/">ZPark-Ztream II (Part 2/3): Fancy Spark Streamed Machine-Learning & new Scalaz-Stream NIO API</a>
      </li>
    
      <li class="post">
        <a href="/2014/03/08/zpark-ml-nio-1/">ZPark-Ztream II (Part 1/3): Fancy Spark Streamed Machine-Learning & new Scalaz-Stream NIO API</a>
      </li>
    
      <li class="post">
        <a href="/2014/02/13/zpark/">ZPark-Ztream: Driving Spark distributed stream with Scalaz-Stream</a>
      </li>
    
      <li class="post">
        <a href="/2014/01/31/play-rules-shapeless/">New Play 2.3 Validation API : breaking the 22 limits with Shapeless</a>
      </li>
    
  </ul>
</section>


<section class="well">
  <ul id="tweets" class="nav" data-user="mandubian" data-count="4" data-replies="false">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
    <a href="http://twitter.com/mandubian" class="twitter-follow-button" data-show-count="false">Follow @mandubian</a>
  
</section>



<section class="well">
  <ul id="gh_repos" data-user="mandubian" data-count="5" data-skip="true" class="nav">
	<li class="nav-header">On GitHub</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a class="github-follow" href="https://github.com/mandubian">Follow @mandubian</a>
  
</section>










  
</aside>

    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2014 - Pascal Voitot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mandubian';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
