
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mandubian Blog</title>
  <meta name="author" content="Pascal Voitot">

  
  <meta name="description" content="ShapelessStream, When Akka-Stream Meets Shapeless Coproduct at Compile-time &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://mandubian.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/d3d.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }

    article {
      margin-bottom: 50px;
      border-top: #DDD solid 20px;
    }
 
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mandubian Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10417377-11']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Mandubian Blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:mandubian.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2015/05/05/shapelessstream/">ShapelessStream, When Akka-Stream Meets Shapeless Coproduct at Compile-time</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-05-05T23:23:00+02:00" pubdate data-updated="true">May 5<span>th</span>, 2015</time>
        
         | <a href="/2015/05/05/shapelessstream/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>You might have seen on my twitter that my current company <a href="http://www.mfglabs.com">MFG Labs</a> has opensourced the library <a href="http://mfglabs.github.io/akka-stream-extensions/">Akka-Stream Extensions</a>. We have developed it with <a href="http://twitter.com/altamborrino">Alexandre Tamborrino</a> and <a href="http://twitter.com/dmnpignaud">Damien Pignaud</a> for our recent production projects based on <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0-RC2/scala.html">Typesafe Akka-Stream</a>.</p>

<blockquote><p>In this article, I won&#8217;t explain all the reasons that motivated our choice of Akka-Stream at MFG Labs and the road towards our library <a href="https://mfglabs.github.com/akka-stream-extensions">Akka-Stream Extensions</a>. Here, I&#8217;ll focus on one precise aspect of our choice: <code>types</code>&#8230; And I&#8217;ll tell you about a specific extension I&#8217;ve created for this project: <code>ShapelessStream</code>.</p></blockquote>

<p>The code is <a href="https://github.com/MfgLabs/akka-stream-extensions/tree/master/extensions/shapeless/src">there on github</a></p>

<br/>


<br/>


<h2>Akka-Stream loves Types</h2>

<p>As you may know, I&#8217;m a <code>Type</code> lover. Types are proofs and proofs are types. Proofs are what you want in your code to ensure <em>in a robust &amp; reliable way</em> that it does what it pretends <em>with the support of the compiler</em>.</p>

<p><strong>First of all, let&#8217;s remind that typesafety is a very interesting feature of Akka-Stream.</strong></p>

<p>Akka-Stream most basic primitive <code>Flow[A, B]</code> represents a <code>data-flow</code> that accepts elements of type <code>A</code> and will return elements of type <code>B</code>. You can&#8217;t pass a <code>C</code> to it and you are sure that this flow won&#8217;t return any <code>C</code> for example.</p>

<p>At MFG Labs, we have inherited some Scala legacy code mostly based on Akka actors which provide a very good way to handle failures but which are not typesafe at all (till Akka Typed) and not composable. Developers using Akka tend to scatter the business logic in the code and it can become hard to maintain. It has appeared that in many cases where Akka was used to transform data in a flow, call external services, Akka-Stream would be a very good way to replace those actors:</p>

<ul>
<li>better type-safety,</li>
<li>fluent &amp; composable code with great builder DSL</li>
<li>same Akka failure management</li>
<li>buffer, parallel computing, backpressure out-of-the-box</li>
</ul>


<blockquote><p>Yes, it&#8217;s quite weird to say it but Akka-Stream helped us correct most problems that had been introduced using Akka (rightly or wrongly).</p></blockquote>

<br/>


<br/>


<h2>Multi-type flows</h2>

<p>Ok, Akka-Stream promotes <code>Types</code> as first citizen in your data flows. That&#8217;s cool!
But it appears that you often need to handle multiple types in the same input channel:</p>

<p><img src="/images/mandubian/flow_11.png" /></p>

<p>When you control completely the types in input, you can represent input types by a classic ADT:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">A</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">A1</span><span class="o">(...)</span> <span class="k">extends</span> <span class="n">A</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">A2</span><span class="o">(...)</span> <span class="k">extends</span> <span class="n">A</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">A3</span><span class="o">(...)</span> <span class="k">extends</span> <span class="n">A</span>
</span></code></pre></td></tr></table></div></figure>


<p>&#8230; And manage it in <code>Flow[A, B]</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Flow</span><span class="o">[</span><span class="kt">A</span><span class="o">].</span><span class="n">map</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">A1</span><span class="o">(...)</span> <span class="k">=&gt;</span> <span class="c1">// some B</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">A2</span><span class="o">(...)</span> <span class="k">=&gt;</span> <span class="c1">// some B</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">A3</span><span class="o">(...)</span> <span class="k">=&gt;</span> <span class="c1">// some B</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nice but you need to wrap all input types in an ADT and this involves some boring code that can even be different for every custom flow.</p>

<p>Going further, in general, you don&#8217;t want to do that, you want to dispatch every element to a different flow according to its type:</p>

<p><img src="/images/mandubian/flow_22.png" /></p>

<p>&#8230; and merge all results of all flows in one single channel&#8230;</p>

<p>&#8230; and every flow has its own behavior in terms of parallelism, bufferization, data generation and back-pressure&#8230;</p>

<p>In Akka-Stream, if you wanted to build a flow corresponding to the previous schema, you would have to use:</p>

<ul>
<li>a <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0-RC2/scala/stream-customize.html">FlexiRoute</a> for the input dispatcher</li>
<li>a <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0-RC2/scala/stream-customize.html">FlexiMerge</a> for the output merger.</li>
</ul>


<p>Have a look at the doc and see that it requires quite a bunch of lines to write one of those. It&#8217;s really powerful but quite tedious to implement and not so typesafe after all. Moreover, you certainly would have to write one <code>FlexiRoute</code> and one <code>FlexiMerge</code> per use-case as the number of inputs types and return types depend on your context.</p>

<br/>


<br/>


<h2>Miles Sabin to the rescue</h2>

<p>In my latest project, this <code>dispatcher/flows/merger</code> pattern was required in multiple places and as I&#8217;m lazy, I wanted something more elegant &amp; typesafe if possible to build this kind of flow graphs.</p>

<p>Thinking in terms of pure types and from an external point of view, we can see the previous <code>dispatcher/flows/merger</code> flow graph in pseudo-code as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Flow</span><span class="o">[</span>
</span><span class='line'>  <span class="kt">Input</span> <span class="kt">=</span> <span class="kt">A1</span> <span class="kt">or</span> <span class="kt">A2</span> <span class="kt">or</span> <span class="kt">A3</span>, <span class="kt">//</span> <span class="kt">in</span> <span class="kt">input</span> <span class="kt">it</span> <span class="kt">accepts</span> <span class="kt">A1</span> <span class="kt">or</span> <span class="kt">A2</span> <span class="kt">or</span> <span class="kt">A3</span>
</span><span class='line'>  <span class="kt">Ouput</span> <span class="kt">=</span> <span class="kt">B1</span> <span class="kt">or</span> <span class="kt">B2</span> <span class="kt">or</span> <span class="kt">B3</span>  <span class="kt">//</span> <span class="kt">in</span> <span class="kt">output</span> <span class="kt">it</span> <span class="kt">generates</span> <span class="kt">B1</span> <span class="kt">or</span> <span class="kt">B2</span> <span class="kt">or</span> <span class="kt">B3</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>And to build the full flow graph, we need to provide a list of flows for all pairs of input/output types corresponding to our graph branches:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Flow</span><span class="o">[</span><span class="kt">A1</span>, <span class="kt">B1</span><span class="o">]</span> <span class="n">and</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">A2</span>, <span class="kt">B2</span><span class="o">]</span> <span class="n">and</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">A3</span>, <span class="kt">B3</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>In <a href="https://github.com/milessabin/shapeless">Shapeless</a>, there are 2 very very very useful structures:</p>

<ul>
<li><code>Coproduct</code> is a generalization of the well known <code>Either</code>. You have <code>A or B</code> in <code>Either[A, B]</code>. With <code>Coproduct</code>, you can have more than 2 alternatives <code>A or B or C or D</code>. So, for our previous external view of flow graph, using <code>Coproduct</code>, it could be written as:</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Flow</span><span class="o">[</span>
</span><span class='line'>  <span class="kt">A1</span> <span class="kt">:+:</span> <span class="kt">A2</span> <span class="kt">:+:</span> <span class="kt">A3</span> <span class="kt">:+:</span> <span class="kt">CNil</span>,
</span><span class='line'>  <span class="kt">B1</span> <span class="kt">:+:</span> <span class="kt">B2</span> <span class="kt">:+:</span> <span class="kt">B3</span> <span class="kt">:+:</span> <span class="kt">CNil</span>
</span><span class='line'><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>HList</code> allows to build heterogenous <code>List</code> of elements keeping &amp; tracking all types at compile time. For our previous list of flows, it would fit quite well as we want to match all input/output types of all flows. It would give:</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Flow</span><span class="o">[</span><span class="kt">A1</span>, <span class="kt">B1</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">A2</span>, <span class="kt">B2</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">A3</span>, <span class="kt">B3</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, from an external point of view, the process of building our <code>dispatcher/flows/merger</code> flow graph looks like a <code>Function taking a</code>Hlist of flows<code>in input and returning the built</code>Flow of Coproducts`:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Flow</span><span class="o">[</span><span class="kt">A1</span>, <span class="kt">B1</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">A2</span>, <span class="kt">B2</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">A3</span>, <span class="kt">B3</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="nc">Flow</span><span class="o">[</span><span class="kt">A1</span> <span class="kt">:+:</span> <span class="kt">A2</span> <span class="kt">:+:</span> <span class="kt">A3</span> <span class="kt">:+:</span> <span class="kt">CNil</span>, <span class="kt">B1</span> <span class="kt">:+:</span> <span class="kt">B2</span> <span class="kt">:+:</span> <span class="kt">B3</span> <span class="kt">:+:</span> <span class="kt">CNil</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s write it in terms of Shapeless Scala code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm"> * Builds at compile-time a fully typed-controlled flow that transforms a HList of Flows to a Flow of the Coproduct of inputs to Coproduct of outputs.</span>
</span><span class='line'><span class="cm"> *</span>
</span><span class='line'><span class="cm"> * @param a Hlist of flows Flow[A1, B1] :: FLow[A2, B2] :: ... :: Flow[An, Bn] :: HNil</span>
</span><span class='line'><span class="cm"> * @return the flow of the Coproduct of inputs and the Coproduct of outputs Flow[A1 :+: A2 :+: ... :+: An :+: CNil, B1 :+: B2 :+: ... +: Bn :+: CNil, Unit]</span>
</span><span class='line'><span class="cm"> */</span>
</span><span class='line'><span class="k">def</span> <span class="n">coproductFlow</span><span class="o">[</span><span class="kt">HL</span> <span class="k">&lt;:</span> <span class="kt">HList</span>, <span class="kt">CIn</span> <span class="k">&lt;:</span> <span class="kt">Coproduct</span>, <span class="kt">COut</span> <span class="k">&lt;:</span> <span class="kt">Coproduct</span><span class="o">](</span>
</span><span class='line'>  <span class="n">flows</span><span class="k">:</span> <span class="kt">HL</span>
</span><span class='line'><span class="o">)</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">COut</span>, <span class="kt">Unit</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Fantastic !!!</p>

<blockquote><p>Now the question is how can we build <strong>at compile-time</strong> this <code>Flow[CIn, COut, Unit]</code> from an <code>HList</code> of <code>Flows</code> and be sure that the compiler checks all links are correctly typed and all types are managed by the provided flows?</p></blockquote>

<br/>


<br/>


<h2>Akka-Stream Graph Mutable builders</h2>

<p>An important concept in Akka-Stream is the separation of concerns between:</p>

<ul>
<li>constructing/describing a data-flow</li>
<li>materializing with live resources (like actor system)</li>
<li>running the data-flow by plugging live sources/sinks on it (like web, file, hdfs, queues etc&#8230;).</li>
</ul>


<blockquote><p>For the curious, you find the same idea in scalaz-stream but in a FP-purer way as scalaz-stream directly relies on <code>Free</code> concepts that formalize this idea quite directly.</p></blockquote>

<p>Akka-Stream has taken a more custom way to respond to these requirements. To build complex data flows, it provides a very nice DSL described <a href="http://doc.akka.io/docs/akka-stream-and-http-experimental/1.0-RC2/scala/stream-graphs.html">here</a>. This DSL is based on the idea of a mutable structure used while building your graph until you decide to fix it definitely into an immutable structure.</p>

<p>An example from the doc:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">g</span> <span class="k">=</span> <span class="nc">FlowGraph</span><span class="o">.</span><span class="n">closed</span><span class="o">()</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">builder</span><span class="k">:</span> <span class="kt">FlowGraph.Builder</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">import</span> <span class="nn">FlowGraph.Implicits._</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">in</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">out</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">ignore</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">bcast</span> <span class="k">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">Broadcast</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="mi">2</span><span class="o">))</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">merge</span> <span class="k">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">Merge</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="mi">2</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">f1</span><span class="o">,</span> <span class="n">f2</span><span class="o">,</span> <span class="n">f3</span><span class="o">,</span> <span class="n">f4</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">map</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">10</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">in</span> <span class="o">~&gt;</span> <span class="n">f1</span> <span class="o">~&gt;</span> <span class="n">bcast</span> <span class="o">~&gt;</span> <span class="n">f2</span> <span class="o">~&gt;</span> <span class="n">merge</span> <span class="o">~&gt;</span> <span class="n">f3</span> <span class="o">~&gt;</span> <span class="n">out</span>
</span><span class='line'>              <span class="n">bcast</span> <span class="o">~&gt;</span> <span class="n">f4</span> <span class="o">~&gt;</span> <span class="n">merge</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>builder</code> is the mutable structure used to build the flow graph using the DSL inside the <code>{...}</code> block.</p>

<p>The value <code>g</code> is the immutable structure resulting from the builder that will later be materialized and run using live resources.</p>

<p>Please remark that once built, <code>g</code> value can reused and materialized/run several times, it is just the description of your flow graph.</p>

<blockquote><p>This idea of mutable builders is really interesting in general: mutability in the small can help a lot to make your building block efficient and easy to write/read without endangering immutability in the large.</p></blockquote>

<br/>


<br/>


<h2>Hacking mutable builders with Shapeless</h2>

<blockquote><p>My intuition was to <em>hack</em> these mutable Akka-Stream builders using Shapeless type-dependent mechanics to build a Flow of Coproducts from an HList of Flows&#8230;</p></blockquote>

<p>Let&#8217;s show the real signature of <code>coproductFlow</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">coproductFlow</span><span class="o">[</span><span class="kt">HL</span> <span class="k">&lt;:</span> <span class="kt">HList</span>, <span class="kt">CIn</span> <span class="k">&lt;:</span> <span class="kt">Coproduct</span>, <span class="kt">COut</span> <span class="k">&lt;:</span> <span class="kt">Coproduct</span>, <span class="kt">CInOutlets</span> <span class="k">&lt;:</span> <span class="kt">HList</span>, <span class="kt">COutInlets</span> <span class="k">&lt;:</span> <span class="kt">HList</span><span class="o">](</span>
</span><span class='line'>  <span class="n">flows</span><span class="k">:</span> <span class="kt">HL</span>
</span><span class='line'><span class="o">)(</span>
</span><span class='line'>  <span class="k">implicit</span>
</span><span class='line'>    <span class="n">flowTypes</span><span class="k">:</span> <span class="kt">FlowTypes.Aux</span><span class="o">[</span><span class="kt">HL</span>, <span class="kt">CIn</span>, <span class="kt">COut</span><span class="o">],</span>
</span><span class='line'>    <span class="n">obuild</span><span class="k">:</span> <span class="kt">OutletBuilder.Aux</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">CInOutlets</span><span class="o">],</span>
</span><span class='line'>    <span class="n">ibuild</span><span class="k">:</span> <span class="kt">InletBuilder.Aux</span><span class="o">[</span><span class="kt">COut</span>, <span class="kt">COut</span>, <span class="kt">COutInlets</span><span class="o">],</span>
</span><span class='line'>    <span class="n">otrav</span><span class="k">:</span> <span class="kt">ToTraversable.Aux</span><span class="o">[</span><span class="kt">CInOutlets</span>, <span class="kt">List</span>, <span class="kt">Outlet</span><span class="o">[</span><span class="k">_</span><span class="o">]],</span>
</span><span class='line'>    <span class="n">itrav</span><span class="k">:</span> <span class="kt">ToTraversable.Aux</span><span class="o">[</span><span class="kt">COutInlets</span>, <span class="kt">List</span>, <span class="kt">Inlet</span><span class="o">[</span><span class="kt">COut</span><span class="o">]],</span>
</span><span class='line'>    <span class="n">selOutletValue</span><span class="k">:</span> <span class="kt">SelectOutletValue.Aux</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">CInOutlets</span><span class="o">],</span>
</span><span class='line'>    <span class="n">flowBuilder</span><span class="k">:</span> <span class="kt">FlowBuilderC.Aux</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">COut</span>, <span class="kt">CInOutlets</span>, <span class="kt">HL</span>, <span class="kt">COutInlets</span><span class="o">]</span>
</span><span class='line'><span class="o">)</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">COut</span>, <span class="kt">Unit</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Frightening!!!!!!!</p>

<p>No, don&#8217;t be, it&#8217;s just the transcription in types of the requirements to build the full flow.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">coproductFlow</span><span class="o">[</span><span class="kt">HL</span> <span class="k">&lt;:</span> <span class="kt">HList</span>, <span class="kt">CIn</span> <span class="k">&lt;:</span> <span class="kt">Coproduct</span>, <span class="kt">COut</span> <span class="k">&lt;:</span> <span class="kt">Coproduct</span>, <span class="kt">CInOutlets</span> <span class="k">&lt;:</span> <span class="kt">HList</span>, <span class="kt">COutInlets</span> <span class="k">&lt;:</span> <span class="kt">HList</span><span class="o">](</span>
</span><span class='line'>  <span class="n">flows</span><span class="k">:</span> <span class="kt">HL</span>
</span><span class='line'><span class="o">)(</span>
</span><span class='line'>  <span class="k">implicit</span>
</span><span class='line'>    <span class="c1">// 1 - Introspects HList of Flows to extract</span>
</span><span class='line'>    <span class="c1">//      * all input types in CIn Coproduct</span>
</span><span class='line'>    <span class="c1">//      * all output types in COut Coproduct</span>
</span><span class='line'>    <span class="n">flowTypes</span><span class="k">:</span> <span class="kt">FlowTypes.Aux</span><span class="o">[</span><span class="kt">HL</span>, <span class="kt">CIn</span>, <span class="kt">COut</span><span class="o">],</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 2 - Builds all Akka-Stream outlets branching the FlexiRoute</span>
</span><span class='line'>    <span class="c1">//     outlets to the right Flow inlet in the HList</span>
</span><span class='line'>    <span class="n">obuild</span><span class="k">:</span> <span class="kt">OutletBuilder.Aux</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">CInOutlets</span><span class="o">],</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 3 - Builds all Akka-Stream inlets branching the outlets of each Flow</span>
</span><span class='line'>    <span class="c1">//     in the HList to the right inlet of FlexiMerge</span>
</span><span class='line'>    <span class="n">ibuild</span><span class="k">:</span> <span class="kt">InletBuilder.Aux</span><span class="o">[</span><span class="kt">COut</span>, <span class="kt">COut</span>, <span class="kt">COutInlets</span><span class="o">],</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 4 - Technical structures to be able to traverse</span>
</span><span class='line'>    <span class="c1">//     and select all those previously built thingies</span>
</span><span class='line'>    <span class="n">otrav</span><span class="k">:</span> <span class="kt">ToTraversable.Aux</span><span class="o">[</span><span class="kt">CInOutlets</span>, <span class="kt">List</span>, <span class="kt">Outlet</span><span class="o">[</span><span class="k">_</span><span class="o">]],</span>
</span><span class='line'>    <span class="n">itrav</span><span class="k">:</span> <span class="kt">ToTraversable.Aux</span><span class="o">[</span><span class="kt">COutInlets</span>, <span class="kt">List</span>, <span class="kt">Inlet</span><span class="o">[</span><span class="kt">COut</span><span class="o">]],</span>
</span><span class='line'>    <span class="n">selOutletValue</span><span class="k">:</span> <span class="kt">SelectOutletValue.Aux</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">CInOutlets</span><span class="o">],</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// 5 - The AkkaStream mutable Builder that:</span>
</span><span class='line'>    <span class="c1">//      * builds the input FlexiRoute with the right output types</span>
</span><span class='line'>    <span class="c1">//      * plugs all FlexiRoute outlets to the right flow inlet</span>
</span><span class='line'>    <span class="c1">//      * builds the output FlexiMerge with the right input types</span>
</span><span class='line'>    <span class="c1">//      * plugs all flow outlets to the right inlet of FlexiMerge</span>
</span><span class='line'>    <span class="n">flowBuilder</span><span class="k">:</span> <span class="kt">FlowBuilderC.Aux</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">COut</span>, <span class="kt">CInOutlets</span>, <span class="kt">HL</span>, <span class="kt">COutInlets</span><span class="o">]</span>
</span><span class='line'><span class="o">)</span><span class="k">:</span> <span class="kt">Flow</span><span class="o">[</span><span class="kt">CIn</span>, <span class="kt">COut</span>, <span class="kt">Unit</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The Scala code might seem a bit ugly to a few of you. That&#8217;s not false but keep in mind what we have done: mixing shapeless-style recursive implicit typeclass inference with the versatility of Akka-Stream mutable builders&#8230; And we were able to build our complex flow graph, to check all types and to plug all together <strong>at compile-time</strong>&#8230;</p></blockquote>

<br/>


<br/>


<h2>Sample</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// 1 - Create a type alias for your coproduct</span>
</span><span class='line'><span class="k">type</span> <span class="kt">C</span> <span class="o">=</span> <span class="nc">Int</span> <span class="o">:+:</span> <span class="nc">String</span> <span class="o">:+:</span> <span class="nc">Boolean</span> <span class="o">:+:</span> <span class="nc">CNil</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The sink to consume all output data</span>
</span><span class='line'><span class="k">val</span> <span class="n">sink</span> <span class="k">=</span> <span class="nc">Sink</span><span class="o">.</span><span class="n">fold</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">C</span><span class="o">]</span>, <span class="kt">C</span><span class="o">](</span><span class="nc">Seq</span><span class="o">())(</span><span class="k">_</span> <span class="o">:+</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2 - a sample source wrapping incoming data in the Coproduct</span>
</span><span class='line'><span class="k">val</span> <span class="n">f</span> <span class="k">=</span> <span class="nc">FlowGraph</span><span class="o">.</span><span class="n">closed</span><span class="o">(</span><span class="n">sink</span><span class="o">)</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">builder</span> <span class="k">=&gt;</span> <span class="n">sink</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">import</span> <span class="nn">FlowGraph.Implicits._</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="nc">Source</span><span class="o">(()</span> <span class="k">=&gt;</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="mi">1</span><span class="o">),</span>
</span><span class='line'>    <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="s">&quot;foo&quot;</span><span class="o">),</span>
</span><span class='line'>    <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="mi">2</span><span class="o">),</span>
</span><span class='line'>    <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="kc">false</span><span class="o">),</span>
</span><span class='line'>    <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="s">&quot;bar&quot;</span><span class="o">),</span>
</span><span class='line'>    <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="mi">3</span><span class="o">),</span>
</span><span class='line'>    <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'>  <span class="o">).</span><span class="n">toIterator</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 3 - our typed flows</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">flowInt</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Int</span><span class="o">].</span><span class="n">map</span><span class="o">{</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;i:&quot;</span><span class="o">+</span><span class="n">i</span><span class="o">);</span> <span class="n">i</span><span class="o">}</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">flowString</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">map</span><span class="o">{</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;s:&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">);</span> <span class="n">s</span><span class="o">}</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">flowBool</span> <span class="k">=</span> <span class="nc">Flow</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">].</span><span class="n">map</span><span class="o">{</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">&quot;s:&quot;</span><span class="o">+</span><span class="n">s</span><span class="o">);</span> <span class="n">s</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// &gt;&gt;&gt;&gt;&gt;&gt; THE IMPORTANT THING</span>
</span><span class='line'><span class="c1">// 4 - build the coproductFlow in a 1-liner</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">fr</span> <span class="k">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">ShapelessStream</span><span class="o">.</span><span class="n">coproductFlow</span><span class="o">(</span><span class="n">flowInt</span> <span class="o">::</span> <span class="n">flowString</span> <span class="o">::</span> <span class="n">flowBool</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">))</span>
</span><span class='line'><span class="c1">// &lt;&lt;&lt;&lt;&lt;&lt; THE IMPORTANT THING</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 5 - plug everything together using akkastream DSL</span>
</span><span class='line'>  <span class="n">s</span> <span class="o">~&gt;</span> <span class="n">fr</span><span class="o">.</span><span class="n">inlet</span>
</span><span class='line'>       <span class="n">fr</span><span class="o">.</span><span class="n">outlet</span> <span class="o">~&gt;</span> <span class="n">sink</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 6 - run it</span>
</span><span class='line'><span class="n">f</span><span class="o">.</span><span class="n">run</span><span class="o">().</span><span class="n">futureValue</span><span class="o">.</span><span class="n">toSet</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span><span class="nc">Set</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="mi">1</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="s">&quot;foo&quot;</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="mi">2</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="kc">false</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="s">&quot;bar&quot;</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="mi">3</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">Coproduct</span><span class="o">[</span><span class="kt">C</span><span class="o">](</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>FYI, Shapeless Coproduct provides a lot of useful operations on Coproducts such as unifying all types or merging Coproducts together.</p></blockquote>

<br/>


<br/>


<h2>Some compile errors now ?</h2>

<p>Imagine you forget to manage one type of the Coproduct in the HList of flows:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 4 - build the coproductFlow in a 1-liner</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">fr</span> <span class="k">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">ShapelessStream</span><span class="o">.</span><span class="n">coproductFlow</span><span class="o">(</span><span class="n">flowInt</span> <span class="o">::</span> <span class="n">flowString</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="o">..</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you compile, it will produce this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">ShapelessExtensionsSpec</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">97</span><span class="kt">:</span> <span class="kt">overloaded</span> <span class="kt">method</span> <span class="kt">value</span> <span class="kt">~&gt;</span> <span class="kt">with</span> <span class="kt">alternatives:</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.SinkShape</span><span class="o">[</span><span class="kt">C</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.Graph</span><span class="o">[</span><span class="kt">akka.stream.SinkShape</span><span class="o">[</span><span class="kt">C</span><span class="o">]</span>, <span class="k">_</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">Out</span><span class="o">](</span><span class="n">flow</span><span class="k">:</span> <span class="kt">akka.stream.FlowShape</span><span class="o">[</span><span class="kt">C</span>,<span class="kt">Out</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">scaladsl</span><span class="o">.</span><span class="nc">FlowGraph</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="nc">PortOps</span><span class="o">[</span><span class="kt">Out</span>,<span class="kt">Unit</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">Out</span><span class="o">](</span><span class="n">junction</span><span class="k">:</span> <span class="kt">akka.stream.UniformFanOutShape</span><span class="o">[</span><span class="kt">C</span>,<span class="kt">Out</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">scaladsl</span><span class="o">.</span><span class="nc">FlowGraph</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="nc">PortOps</span><span class="o">[</span><span class="kt">Out</span>,<span class="kt">Unit</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">Out</span><span class="o">](</span><span class="n">junction</span><span class="k">:</span> <span class="kt">akka.stream.UniformFanInShape</span><span class="o">[</span><span class="kt">C</span>,<span class="kt">Out</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">scaladsl</span><span class="o">.</span><span class="nc">FlowGraph</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="nc">PortOps</span><span class="o">[</span><span class="kt">Out</span>,<span class="kt">Unit</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">Out</span><span class="o">](</span><span class="n">via</span><span class="k">:</span> <span class="kt">akka.stream.Graph</span><span class="o">[</span><span class="kt">akka.stream.FlowShape</span><span class="o">[</span><span class="kt">C</span>,<span class="kt">Out</span><span class="o">]</span>,<span class="kt">Any</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">scaladsl</span><span class="o">.</span><span class="nc">FlowGraph</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="nc">PortOps</span><span class="o">[</span><span class="kt">Out</span>,<span class="kt">Unit</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.Inlet</span><span class="o">[</span><span class="kt">C</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>  <span class="n">cannot</span> <span class="n">be</span> <span class="n">applied</span> <span class="n">to</span> <span class="o">(</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="nc">Inlet</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.CIn</span><span class="o">]]])</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>       <span class="n">s</span> <span class="o">~&gt;</span> <span class="n">fr</span><span class="o">.</span><span class="n">inlet</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>         <span class="o">^</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span> <span class="o">/</span><span class="nc">Users</span><span class="o">/</span><span class="n">pvo</span><span class="o">/</span><span class="n">workspaces</span><span class="o">/</span><span class="n">mfg</span><span class="o">/</span><span class="n">akka</span><span class="o">-</span><span class="n">stream</span><span class="o">-</span><span class="n">extensions</span><span class="o">/</span><span class="n">extensions</span><span class="o">/</span><span class="n">shapeless</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">scala</span><span class="o">/</span><span class="nc">ShapelessExtensionsSpec</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">98</span><span class="kt">:</span> <span class="kt">overloaded</span> <span class="kt">method</span> <span class="kt">value</span> <span class="kt">~&gt;</span> <span class="kt">with</span> <span class="kt">alternatives:</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.SinkShape</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.Graph</span><span class="o">[</span><span class="kt">akka.stream.SinkShape</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]]</span>, <span class="k">_</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">Out</span><span class="o">](</span><span class="n">flow</span><span class="k">:</span> <span class="kt">akka.stream.FlowShape</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]</span>,<span class="kt">Out</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">scaladsl</span><span class="o">.</span><span class="nc">FlowGraph</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="nc">PortOps</span><span class="o">[</span><span class="kt">Out</span>,<span class="kt">Unit</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">Out</span><span class="o">](</span><span class="n">junction</span><span class="k">:</span> <span class="kt">akka.stream.UniformFanOutShape</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]</span>,<span class="kt">Out</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">scaladsl</span><span class="o">.</span><span class="nc">FlowGraph</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="nc">PortOps</span><span class="o">[</span><span class="kt">Out</span>,<span class="kt">Unit</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">Out</span><span class="o">](</span><span class="n">junction</span><span class="k">:</span> <span class="kt">akka.stream.UniformFanInShape</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]</span>,<span class="kt">Out</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">scaladsl</span><span class="o">.</span><span class="nc">FlowGraph</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="nc">PortOps</span><span class="o">[</span><span class="kt">Out</span>,<span class="kt">Unit</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">Out</span><span class="o">](</span><span class="n">via</span><span class="k">:</span> <span class="kt">akka.stream.Graph</span><span class="o">[</span><span class="kt">akka.stream.FlowShape</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]</span>,<span class="kt">Out</span><span class="o">]</span>,<span class="kt">Any</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="n">scaladsl</span><span class="o">.</span><span class="nc">FlowGraph</span><span class="o">.</span><span class="nc">Implicits</span><span class="o">.</span><span class="nc">PortOps</span><span class="o">[</span><span class="kt">Out</span>,<span class="kt">Unit</span><span class="o">]</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.Inlet</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>  <span class="n">cannot</span> <span class="n">be</span> <span class="n">applied</span> <span class="n">to</span> <span class="o">(</span><span class="n">sink</span><span class="o">.</span><span class="nc">Shape</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>            <span class="n">fr</span><span class="o">.</span><span class="n">outlet</span> <span class="o">~&gt;</span> <span class="n">sink</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>                      <span class="o">^</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>OUCHHHH</strong>, this is a mix of the worst error of Akka-Stream and the kind of errors you get with Shapeless :)</p>

<blockquote><p>Don&#8217;t panic, breathe deep and just tell yourself that in this case, it just means that your types do not fit well</p></blockquote>

<p>In general, the first line and the last lines are the important ones.</p>

<h4>For input:</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">ShapelessExtensionsSpec</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">97</span><span class="kt">:</span> <span class="kt">overloaded</span> <span class="kt">method</span> <span class="kt">value</span> <span class="kt">~&gt;</span> <span class="kt">with</span> <span class="kt">alternatives:</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.SinkShape</span><span class="o">[</span><span class="kt">C</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>  <span class="n">cannot</span> <span class="n">be</span> <span class="n">applied</span> <span class="n">to</span> <span class="o">(</span><span class="n">akka</span><span class="o">.</span><span class="n">stream</span><span class="o">.</span><span class="nc">Inlet</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.CIn</span><span class="o">]]])</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>       <span class="n">s</span> <span class="o">~&gt;</span> <span class="n">fr</span><span class="o">.</span><span class="n">inlet</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>         <span class="o">^</span>
</span></code></pre></td></tr></table></div></figure>


<p>It just means you try to plug a <code>C == Int :+: String :+: Bool :+: CNil</code> to a <code>Int :+: String :+: CNil</code> and the compiler is angry against you!!</p>

<h4>For output:</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">ShapelessExtensionsSpec</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">98</span><span class="kt">:</span> <span class="kt">overloaded</span> <span class="kt">method</span> <span class="kt">value</span> <span class="kt">~&gt;</span> <span class="kt">with</span> <span class="kt">alternatives:</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.SinkShape</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span> <span class="o">&lt;</span><span class="n">and</span><span class="o">&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">(</span><span class="n">to</span><span class="k">:</span> <span class="kt">akka.stream.Inlet</span><span class="o">[</span><span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.:+:</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">com.mfglabs.stream.extensions.shapeless.FlowTypes.last.COut</span><span class="o">]]])(</span><span class="k">implicit</span> <span class="n">b</span><span class="k">:</span> <span class="kt">akka.stream.scaladsl.FlowGraph.Builder</span><span class="o">[</span><span class="k">_</span><span class="o">])</span><span class="nc">Unit</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>  <span class="n">cannot</span> <span class="n">be</span> <span class="n">applied</span> <span class="n">to</span> <span class="o">(</span><span class="n">sink</span><span class="o">.</span><span class="nc">Shape</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>            <span class="n">fr</span><span class="o">.</span><span class="n">outlet</span> <span class="o">~&gt;</span> <span class="n">sink</span>
</span></code></pre></td></tr></table></div></figure>


<p>It just means you try to plug a <code>Int :+: String :+: CNil</code> to a <code>C == Int :+: String :+: Bool :+: CNil</code> and the compiler is 2X-angry against you!!!</p>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Mixing the power of Shapeless compile-time type dependent structures and Akka-Stream mutable builders, we are able to build at compile-time a complex <code>dispatcher/flows/merger</code> flow graph that checks all types and all flows correspond to each other and plugs all together in a 1-liner&#8230;</p>

<p>This code is the first iteration on this principle but it appeared to be so efficient and I trusted the mechanism so much (nothing happens at runtime but just at compile-time) that I&#8217;ve put that in production two weeks ago. <strong>It runs like a charm.</strong></p>

<p>Finally, there are a few specificities/limitations to know:</p>

<ul>
<li><p>Wrapping input data into the <code>Coproduct</code> is still the boring part with some pattern matching potentially. But this is like Json/Xml validation, you need to validate only the data you expect. Yet I expect to reduce the work soon by providing a Scala macro that will generate this part for you as it&#8217;s just mechanical&#8230;</p></li>
<li><p>Wrapping everything in <code>Coproduct</code> could have some impact on performance if what you expect is pure performance but in my use-cases IO are so much more impacting that this is not a problem&#8230;</p></li>
<li><p><code>coproductFlow</code> is built with a custom FlexiRoute with <code>DemandFromAll</code> condition &amp; FlexiMerge using <code>ReadAny</code> condition. This implies :</p>

<ul>
<li><p>the order is NOT guaranteed due to the nature of used FlexiRoute &amp; FlexiMerge and potentially to the flows you provide in your HList (each branch flow has its own parallelism/buffer/backpressure behavior and is not necessarily a 1-to-1 flow).</p></li>
<li><p>the slowest branch will slow down all other branches (as with a broadcast). <em>To manage these issues, you can add buffers in your branch flows to allow other branches to go on pulling input data</em></p></li>
</ul>
</li>
</ul>


<p>The future?</p>

<ul>
<li><p>A macro generating the Coproduct wrapping flow</p></li>
<li><p>Some other flows based on Shapeless</p></li>
</ul>


<p>Have more backpressured and typed fun&#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2015/04/09/freer/">FreeR - Hybrid Free Monads for Reduced Quadratic Complexity/Observability & Map-Fusion Optimization in Scala</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2015-04-09T23:23:00+02:00" pubdate data-updated="true">Apr 9<span>th</span>, 2015</time>
        
         | <a href="/2015/04/09/freer/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>Draft FreeR code is on <a href="https://github.com/mandubian/cats/blob/feature/freer/free/src/main/scala/cats/free/FreeR.scala">Github</a></p></blockquote>

<br/>


<h2>Introduction</h2>

<p>I&#8217;ve recently pushed some <code>Free</code> code &amp; doc to the cool project <a href="https://github.com/non/cats/">cats</a> and I had a few more ideas in my head on optimizing <code>Free</code> and never took time to make them concrete. I&#8217;ve just found this time during my holidays&#8230;</p>

<p><code>Free Monad</code> is often used to represent embedded DSL in functional programming languages like Haskell or Scala. One generally represents his grammar with a simple <code>Functor</code> ADT representing the available operations. Then, from within your programming language, <code>Free Monad</code> provides the facilities to:</p>

<ul>
<li>build in a monadic &amp; stack-safe way a static program composed of a sequence of operations,</li>
<li>compile this program,</li>
<li>run it.</li>
</ul>


<blockquote><p>To know more about the way to use <code>Free</code> and some more specific theory, please refer to <a href="https://github.com/non/cats/blob/master/docs/src/main/tut/freemonad.md">recent draft doc I&#8217;ve pushed on cats</a></p></blockquote>

<p>The well-known classic representation in Scala is the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Free</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'><span class="nc">case</span> <span class="k">class</span> <span class="nc">Pure</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Free</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Suspend</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Free</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">Free</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">A</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that <code>F[_]</code> should be a Functor to take advantage of <code>Free</code> construction.</p></blockquote>

<p>Building a program can then just be a classic sequence of monadic <code>bind/flatMap</code> on <code>Free[S[_], _]</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">for</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">a</span> <span class="k">&lt;-</span> <span class="n">doA</span><span class="o">(...)</span>
</span><span class='line'>  <span class="n">b</span> <span class="k">&lt;-</span> <span class="n">doB</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="o">...)</span>
</span><span class='line'>  <span class="n">c</span> <span class="k">&lt;-</span> <span class="n">doC</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="o">...)</span>
</span><span class='line'><span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">c</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This actually constructs a recursive structure looking like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Suspend</span><span class="o">(</span><span class="n">F</span><span class="o">(</span><span class="nc">Suspend</span><span class="o">(</span><span class="n">F</span><span class="o">(</span><span class="nc">Suspend</span><span class="o">(</span><span class="n">F</span><span class="o">(....(</span><span class="nc">Pure</span><span class="o">(</span><span class="n">a</span><span class="o">))))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>It can be seen as a left-associated sequence of operations and as any left-associated structure, appending an element to it has a quadratic complexity. So the more you <code>flatMap</code>, the longer (in n²) it will take to drill down the structure.</p>

<p>So if you try such code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">gen</span><span class="o">[</span><span class="kt">I</span><span class="o">](</span><span class="n">i</span><span class="k">:</span> <span class="kt">I</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trampoline</span><span class="o">[</span><span class="kt">I</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Trampoline</span><span class="o">.</span><span class="n">suspend</span><span class="o">(</span><span class="nc">Trampoline</span><span class="o">.</span><span class="n">done</span><span class="o">(</span><span class="n">i</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//(a flatMap (b flatMap (c flatMap (...))))</span>
</span><span class='line'><span class="k">def</span> <span class="n">lftBind</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">gen</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="n">S</span><span class="o">[</span><span class="kt">Int</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">M</span><span class="k">:</span> <span class="kt">Monad</span><span class="o">[</span><span class="kt">S</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">n</span><span class="o">).</span><span class="n">foldLeft</span><span class="o">(</span><span class="n">gen</span><span class="o">(</span><span class="mi">0</span><span class="o">)){</span> <span class="k">case</span> <span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">acc</span> <span class="n">flatMap</span> <span class="o">{</span> <span class="n">a</span> <span class="k">=&gt;</span> <span class="n">gen</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">}</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You will see that it has a quadratic curve in terms of execution time when you increase <code>n</code>.</p>

<blockquote><p>First weakness of classic <code>Free</code> is its left-associativity that induces a quadratic complexity when flatMapping</p></blockquote>

<br/>


<br/>


<h2>Solving left-associated quadratic complexity</h2>

<p>To solve it, the immediate idea is to make <code>Free</code> right-associative instead of left associative (This idea was proposed by Kiselyov &amp; al. in a paper and called <em>Continuation-Passing-Style</em> or also Codensity construction)</p>

<p>This is already done in current <code>scalaz/cats.Free</code> by adding a new element to the <code>Free</code> ADT:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Call a subroutine and continue with the given function. */</span>
</span><span class='line'><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">Gosub</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">B</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Free</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">B</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">type</span> <span class="kt">C</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">a</span><span class="k">:</span> <span class="o">()</span> <span class="o">=&gt;</span> <span class="nc">Free</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">C</span><span class="o">]</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">f</span><span class="k">:</span> <span class="kt">C</span> <span class="o">=&gt;</span> <span class="nc">Free</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">B</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you test the same previous code, it has a linear behavior when <code>n</code> increases.</p>

<br/>


<br/>


<h2>Quadratic observability</h2>

<p>In this great paper <a href="http://homepages.cwi.nl/~ploeg/papers/zseq.pdf">Reflection Without Remorse</a>, Atze van der Ploeg &amp; Oleg Kiselyov show that <code>classic Free</code> are subject to another tricky quadratic behavior when, within your sequence of operations, one need to observe the current internal state of <code>Free</code>.</p>

<p>Observing the state requires to drill down the recursive Free structure explicitly and go up and again down then up and again and again. As explained in the paper, this case is quite tricky because it&#8217;s very hard to see that it will happen. The deeper is the structure, the longer it takes to observe current state. It&#8217;s important to note that right-association doesn&#8217;t help in this case and that complexity is once again in <em>O(n²)</em>.</p>

<blockquote><p>The second weakness of <code>Free</code> is its quadratic complexity when observing internal state.</p></blockquote>

<p>To solve it, in <a href="http://homepages.cwi.nl/~ploeg/papers/zseq.pdf">Reflection Without Remorse</a>, they propose a very interesting approach by changing the representation of <code>Free</code> and take advantage of its sequential nature.</p>

<p>A <code>Free</code> becomes the association of 2 elements:</p>

<ul>
<li>a <code>FreeView</code> representing current internal state of the <code>Free</code></li>
<li>a sequence of <code>bind/flatMap</code> functions stored in an efficient data structure that can prepent/append in <em>O(1)</em>.</li>
</ul>


<blockquote><p>For the data structure, they propose to use a type-aligned dequeue to keep track of all types.</p></blockquote>

<p>I have tried to implement this structure using a typed-aligned FingerTree in Scala. The code is <a href="https://github.com/mandubian/freez/blob/master/src/main/scala/view/DequeFreeComp.scala">here</a>. The result is pretty interesting but not much efficient: it has a linear behavior for left-association &amp; observability but&#8230;</p>

<ul>
<li>for lower values of <code>n</code>, <code>FingerTree</code> costs far too much to build</li>
<li>memory cost is so high that it triggers the JVM GC far too soon and limitates a lot what you can do</li>
<li>allocated memory locality isn&#8217;t good and requires huge amounts of memory jumps.</li>
<li>type-alignment makes code quite ugly (yes Scala type inference isn&#8217;t as powerful as Haskell in this case and laziness of Haskell helps a lot for FingerTree)</li>
</ul>


<blockquote><p>As a conclusion, the idea is really nice on paper but in practice, we need to find something that costs less than this type-aligned dequeue (even if my FingerTree code is really raw, too strict and not optimized at all).</p></blockquote>

<br/>


<br/>


<h2>FreeR hybrid structure</h2>

<p>I wanted to improve <code>Free</code> behavior and decided to create a new version of it called <code>FreeR</code> thinking in terms of efficient Scala&#8230;</p>

<p>I really liked the idea of representing a <code>Free</code> as a pure sequence of operations with a view of current internal state.</p>

<p>To gain in efficiency, I decided to choose another efficient append/prepend data structure, optimized and very well known: <code>Vector</code> providing:</p>

<ul>
<li>append/prepend in <em>O(1)</em> (in average),</li>
<li>random access in constant time,</li>
<li>quite good locality.</li>
</ul>


<p>Then, I&#8217;ve decided to relax a lot type alignment and manipulate <code>Any</code> values internally and cast/reify to the right types when required.</p>

<blockquote><p>BTW, I plagiarized some code written by Alois Cochard for his new IO model in <a href="https://github.com/scalaz/scalaz/blob/series/8.0.x/io/src/main/scala/IO.scala">Scalaz/8.0 branch</a>&#8230; Alois is a great dev &amp; had made concrete the idea I had in my head so why rewrite them differently? uh ;)</p></blockquote>

<p>I also decided to reify the 2 kinds of operations:</p>

<ul>
<li>Bind for <code>flatMap/bind</code> calls</li>
<li><code>Map</code> for <code>map</code> calls</li>
</ul>


<p>So a <code>Free</code> becomes:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// to mitigate the shock of Any in the code</span>
</span><span class='line'><span class="c1">// and provide helpers for casting/reifying</span>
</span><span class='line'><span class="k">type</span> <span class="kt">Val</span> <span class="o">=</span> <span class="nc">Any</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">FreeR</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">](</span>
</span><span class='line'>  <span class="n">head</span><span class="k">:</span> <span class="kt">FreeView</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">Val</span><span class="o">],</span>
</span><span class='line'>  <span class="n">ops</span><span class="k">:</span> <span class="kt">Ops</span> <span class="o">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span>
</span><span class='line'><span class="o">)</span> <span class="k">extends</span> <span class="nc">FreeR</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">A</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>with <code>FreeView</code> as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// The view of Free internal state can be of 2 types:</span>
</span><span class='line'><span class="k">sealed</span> <span class="k">abstract</span> <span class="k">class</span> <span class="nc">FreeView</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="nc">object</span> <span class="nc">FreeView</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// Pure value</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">class</span> <span class="nc">Pure</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">FreeView</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Impure computation determined by the Functor S</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">class</span> <span class="nc">Impure</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">S</span><span class="o">[</span><span class="kt">FreeR</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">A</span><span class="o">]])</span> <span class="k">extends</span> <span class="nc">FreeView</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>and <code>Ops</code> are:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Op</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Op</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">class</span> <span class="nc">Map</span><span class="o">(</span><span class="n">f</span><span class="k">:</span> <span class="kt">Val</span> <span class="o">=&gt;</span> <span class="nc">Val</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Op</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">class</span> <span class="nc">Bind</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">f</span><span class="k">:</span> <span class="kt">Val</span> <span class="o">=&gt;</span> <span class="nc">FreeR</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">Val</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">Op</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>FYI This code is less than 300 lines so nothing really horrible except a few ugly casts ;)</p></blockquote>

<br/>


<br/>


<h3>Left Association</h3>

<p>The code used for testing can be found <a href="https://github.com/mandubian/cats/blob/feature/freer/tests/src/test/scala/cats/tests/FreeRTests.scala#L34-L36">here</a></p>

<br/>


<p><img src="/images/mandubian/left_assoc.jpg"/></p>

<br/>


<blockquote><p><code>FreeR</code> behavior is linear even for millions of <code>flatMap</code> (until the GC triggers naturally) whereas classic <code>Free</code> has clearly quadratic curve.</p></blockquote>

<br/>


<br/>


<h3>Observability</h3>

<p>The code used for testing can be found <a href="https://github.com/mandubian/cats/blob/feature/freer/tests/src/test/scala/cats/tests/FreeRTests.scala#L98-L136">here</a></p>

<p><img src="/images/mandubian/iteratee.jpg"/></p>

<blockquote><p><code>FreeR</code> behavior is quite linear even for millions of <code>flatMap</code> (until the GC triggers naturally) whereas classic <code>Free</code> has clearly quadratic curve.</p></blockquote>

<br/>


<br/>


<h3>Right association complexity</h3>

<p>I finally tried to check the behavior of my new <code>FreeR</code> when using <code>flatMap</code> in a right associated way like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// (... flatMap (_ =&gt; c flatMap (_ =&gt; b flatMap (_ =&gt; a))))</span>
</span><span class='line'><span class="k">def</span> <span class="n">rgtBind</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">gen</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="n">S</span><span class="o">[</span><span class="kt">Int</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">M</span><span class="k">:</span> <span class="kt">Monad</span><span class="o">[</span><span class="kt">S</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">n</span><span class="o">).</span><span class="n">foldLeft</span><span class="o">(</span><span class="n">gen</span><span class="o">(</span><span class="n">n</span><span class="o">)){</span> <span class="k">case</span> <span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">gen</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="n">i</span><span class="o">)</span> <span class="n">flatMap</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">acc</span> <span class="o">}</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is not so frequent code but anyway, <code>Free</code> should be efficient for left &amp; right associated code.</p>

<p>Using <code>FreeR</code> as described previously, I&#8217;ve discovered that it wasn&#8217;t efficient in right association when increasing <code>n</code> because it allocates recursively a lot of Vector with one element and it becomes slower and slower apparently (I&#8217;m not even sure of the real cause of it).</p>

<p>I&#8217;ve refined my representation by distinguishing 3 kinds of <code>Free</code> in my ADT:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// No op</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">FreeR0</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">](</span><span class="n">head</span><span class="k">:</span> <span class="kt">FreeView</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">Val</span><span class="o">])</span> <span class="k">extends</span> <span class="nc">FreeR</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// One single op (typically the right association case)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">FreeR1</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">](</span><span class="n">head</span><span class="k">:</span> <span class="kt">FreeView</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">Val</span><span class="o">],</span> <span class="n">op</span><span class="k">:</span> <span class="kt">Op</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">FreeR</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Multiple ops</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">FreeRs</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="k">_</span><span class="o">]</span>, <span class="kt">A</span><span class="o">](</span><span class="n">head</span><span class="k">:</span> <span class="kt">FreeView</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">Val</span><span class="o">],</span> <span class="n">ops</span><span class="k">:</span> <span class="kt">Ops</span> <span class="o">=</span> <span class="nc">Vector</span><span class="o">.</span><span class="n">empty</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">FreeR</span><span class="o">[</span><span class="kt">S</span>, <span class="kt">A</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this optimization, here is the performance in right association:</p>

<p><img src="/images/mandubian/right_assoc.jpg"/></p>

<p>It is quite comparable to classic <code>Free</code> for <code>n</code> under 1 million but it becomes quite bad when <code>n</code> becomes big. Yet, it remains for more efficient than previous representation with just <code>Vector</code>.</p>

<blockquote><p>I need to work more on this issue (apparently GC is triggered too early) to see if more optimizations for right association can be found&#8230;</p></blockquote>

<br/>


<br/>


<h3>Cherry on the cake: map-fusion optimization</h3>

<p>Imagine doing a lot of <code>map</code> operations on a <code>Free</code> like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">mapalot</span><span class="o">(</span><span class="n">n</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Trampoline</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="n">n</span><span class="o">).</span><span class="n">foldLeft</span><span class="o">(</span><span class="nc">Trampoline</span><span class="o">.</span><span class="n">done</span><span class="o">(</span><span class="mi">0L</span><span class="o">)){</span> <span class="k">case</span> <span class="o">(</span><span class="n">acc</span><span class="o">,</span> <span class="n">i</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">acc</span> <span class="n">map</span> <span class="o">{</span> <span class="n">a</span> <span class="k">=&gt;</span> <span class="n">a</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">}</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you think just a bit, you will clearly see that:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">a</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">f</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">g</span><span class="o">)</span> <span class="o">==</span> <span class="n">a</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">g</span> <span class="n">compose</span> <span class="n">f</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is called <code>map-fusion</code> and as you may have deduced already, my decision to reify explicitly <code>Bind</code> and <code>Map</code> operations was made in this purpose.</p>

<p>If I can know there are several <code>Map</code> operations in a row, I can <code>fusion</code> them in one single <code>Map</code> by just calling <code>mapFusion</code> on a <code>Free</code> to optimize it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">free</span> <span class="k">=</span> <span class="nc">FreeRTools</span><span class="o">.</span><span class="n">mapalot</span><span class="o">(</span><span class="n">x</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// optimized free</span>
</span><span class='line'><span class="k">val</span> <span class="n">freeOpt</span> <span class="k">=</span> <span class="n">free</span><span class="o">.</span><span class="n">mapFusion</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// run the trampoline</span>
</span><span class='line'><span class="n">freeOpt</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the difference in performance between <code>FreeR</code> and <code>FreeR.mapFusion</code>:</p>

<p><img src="/images/mandubian/map_fusion.jpg"/></p>

<p>As you can see, <code>mapFusion</code> can be very interesting in some cases.</p>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Finally, I have created a new representation of <code>Free</code> using:</p>

<ul>
<li>type-relaxed version of <em>Reflection w/o Remorse</em></li>
<li>sequence of operations managed by Scala <code>Vector</code></li>
<li>reification of <code>Bind</code> &amp; <code>Map</code> operations</li>
<li>differenciation of None/Single/Multiple operations cases</li>
<li>Map Fusion optimization</li>
</ul>


<p>It allows to have a <code>Free</code> with:</p>

<ul>
<li>Linear behavior in Left-Assocation, Observability,</li>
<li>Stack-safety is sill ensured,</li>
<li>Right-Association should be optimized because it still has a too high cost for bigger <code>n</code> (yet it is far more acceptable than other alternatives),</li>
<li>Map Fusion can provide an interesting optimization when using multiple consecutive <code>Map</code> operations,</li>
<li>For small <code>n</code>, the cost is a bit higher than basic <code>Free</code> but quite low and acceptable.</li>
</ul>


<p>It is really interesting as it makes <code>Free</code> more and more usable in real-life problems without having to rewrite the code bootstrapped with <code>Free</code> in a more optimized way. I personally find it quite promising!</p>

<blockquote><p>Please remark that this code has been written for the great project <a href="https://github.com/non/cats/">cats</a> that will soon be a viable &amp; efficient alternative for functional structures in Scala.</p></blockquote>

<p>The full code is <a href="https://github.com/mandubian/cats/blob/feature/freer/free/src/main/scala/cats/free/FreeR.scala">there</a>.</p>

<p>Don&#8217;t hesitate to test, find bugs, contribute, give remarks, ideas&#8230;</p>

<p>Have fun in FreeR world&#8230;</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/12/21/scaledn/">Scaledn: Promote EDN as a Far Better Alternative to Json in Scala</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-12-21T23:23:00+01:00" pubdate data-updated="true">Dec 21<span>st</span>, 2014</time>
        
         | <a href="/2014/12/21/scaledn/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>SCALEDN, <a href="https://github.com/edn-format/edn">EDN</a> Scala API</h1>

<p><a href="https://github.com/mandubian/scaledn">Scaledn</a> is a Scala <a href="https://github.com/edn-format/edn">EDN</a> parser (runtime &amp; compile-time)/serializer/validator based on :</p>

<ul>
<li><a href="https://github.com/sirthias/parboiled2">Parboiled2</a>,</li>
<li><a href="https://github.com/milessabin/shapeless">Shapeless</a>,</li>
<li><a href="https://github.com/jto/validation">Generic Validation</a></li>
<li>Scala Macros</li>
</ul>


<blockquote><p>It works only in Scala 2.11.x</p></blockquote>

<p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/scaledn">Github</a></p>

<br/>


<h2>Why EDN?&#8230;</h2>

<blockquote><p>Because Json is not so good &amp; quite limitating</p></blockquote>

<p><strong>EDN is described as an <em>extensible data notation</em></strong> specified (not really standardized) <a href="https://github.com/edn-format/edn">there</a>. Clojure &amp; Datalog used in Datomic are supersets of EDN.</p>

<p>EDN allows much more things than Json while <strong>keeping the same simplicity</strong>.</p>

<p>Here are the main points making EDN great to represent &amp; exchange Data.</p>

<br/>


<h3>EDN manages number types far better than Json</h3>

<p>For Json, all numbers (floating or integer, exponential or not) are all considered in the same way so numbers can only be mapped to the biggest number format: <code>BigDecimal</code>. It is really bad in terms of semantics and performance.</p>

<p>In EDN, numbers can be :</p>

<ul>
<li>64bits integer aka <code>Long</code> in Scala: <code>12345</code></li>
<li>64bits floating point numbers &amp; exponentials aka <code>Double</code> in Scala: <code>123.45e-9</code></li>
<li>Natural Integers aka <code>BigInt</code> in Scala: <code>1234567891234N</code></li>
<li>Exact Floating Number aka <code>BigDecimal</code> in Scala: <code>123.4578972345M</code></li>
</ul>


<br/>


<h3>EDN knows much more about collections</h3>

<p>Collections in Json are just:</p>

<ul>
<li>lists of heterogenous json values</li>
<li>maps of key strings and json values.</li>
</ul>


<p>In EDN, you can have:</p>

<ul>
<li>heterogenous lists</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">(</span><span class="mi">1</span> <span class="kc">true</span> <span class="err">&quot;</span><span class="n">toto</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>heterogenous vectors/arrays</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">[</span><span class="err">1</span> <span class="kt">true</span> <span class="err">&quot;</span><span class="kt">toto</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>heterogenous sets</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">#{</span><span class="mi">1</span> <span class="kc">true</span> <span class="err">&quot;</span><span class="n">toto</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>heterogenous maps with heterogenous keys &amp; values</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">{</span><span class="mi">1</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span> <span class="s">&quot;foo&quot;</span> <span class="mi">2</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>EDN accepts characters &amp; unicode</h3>

<p>Json doesn&#8217;t know about characters outside strings.</p>

<p>EDN can manage chars:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// simple char</span>
</span><span class='line'><span class="o">\</span><span class="n">c</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// special chars</span>
</span><span class='line'><span class="o">\</span><span class="n">newline</span>
</span><span class='line'><span class="o">\</span><span class="k">return</span>
</span><span class='line'><span class="o">\</span><span class="n">space</span>
</span><span class='line'><span class="o">\</span><span class="n">tag</span>
</span><span class='line'><span class="o">\\</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// unicode</span>
</span><span class='line'><span class="o">\</span><span class="n">u0308</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>EDN accepts comments &amp; discarded values</h3>

<p>There are special syntaxes:</p>

<ul>
<li>comments are lines starting with <code>;</code></li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">;</span> <span class="k">this</span> <span class="n">is</span> <span class="n">a</span> <span class="n">comment</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li>values starting with <code>#_</code> are parsed but discarded</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="s">&quot;toto&quot;</span> <span class="mi">3</span> <span class="k">#</span><span class="nc">_discarded</span> <span class="mf">1.234</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>EDN knows about symbols &amp; keywords</h3>

<p>These are notions that don&#8217;t exist in Json.</p>

<p>Symbols can reference anything external or internal that you want to identify. A <code>Symbol</code> can have a namespace such as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">foo</span><span class="o">.</span><span class="n">foo2</span><span class="o">/</span><span class="n">bar</span>
</span></code></pre></td></tr></table></div></figure>


<p>Keywords are unique identifiers or enumerated values that can be reused in your data structure. A <code>Keyword</code> is just a symbol preceded by a <code>:</code> such as</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">:</span><span class="kt">foo.foo2/bar</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>EDN is extensible using tags</h3>

<p>EDN is an extensible format using tags starting with <code>#</code> such as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">#</span><span class="n">foo</span><span class="o">/</span><span class="n">bar</span> <span class="n">value</span>
</span></code></pre></td></tr></table></div></figure>


<p>When parsing EDN format, the parser should provide tag handlers that can be applied when a tag is discovered. In this way, you can extend default format with your own formats.</p>

<p>EDN specifies 2 tag handlers by default:</p>

<ul>
<li><code>#inst "1985-04-12T23:20:50.52Z"</code> for RFC-3339 instants</li>
<li><code>#uuid "f81d4fae-7dec-11d0-a765-00a0c91e6bf6"</code> for UUID</li>
</ul>


<br/>


<h3>EDN has no root node &amp; can be streamed</h3>

<p>Json is defined to have a root <code>map</code> node: <code>{ key : value }</code> or <code>[ ... ]</code>.</p>

<p>Json can&#8217;t accept single values outside of this. So Json isn&#8217;t really meant to be streamed as you need to find closing tags to finish parsing a value.</p>

<p>EDN doesn&#8217;t require this and can consist in multiple heterogenous values:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="mi">1</span> <span class="mf">123.45</span> <span class="s">&quot;toto&quot;</span> <span class="kc">true</span> <span class="n">nil</span> <span class="o">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As a consequence, EDN can be used to stream your data structures.</p>

<br/>


<h3>Conclusion: EDN should be preferred to Json</h3>

<p>All of these points make EDN a far better &amp; stricter &amp; more evolutive notation to represent data structures than Json. It can be used in the same way as Json but could make a far better RPC string format than Json.</p>

<p>I still wonder why Json has become the de-facto standard except for the reason that the <em>not so serious</em> Javascript language parses it natively and because people were so sick about XML that they would have accepted anything changing their daily life.</p>

<p>But JS could also parse EDN without any problem and all more robust &amp; typed backend languages would earn a lot from using EDN instead of JSON for their interfaces.</p>

<p>EDN could be used in REST API &amp; also for streaming API.
That&#8217;s exactly why, I wanted to provide a complete Scala API for EDN to test this idea a bit further.</p>

<br/>


<br/>


<h2>Scaledn insight</h2>

<br/>


<h3>Runtime Parsing</h3>

<p>Scaledn can be used to parse the EDN string or arrays of chars received by your API.</p>

<p>All types described in EDN format are isomorphic to Scala types so I&#8217;ve decided to skip the complete AST wrapping those types and directly parse to Scala types.</p>

<ul>
<li><code>"foobar"</code> is parsed to <code>String</code></li>
<li><code>123</code> is parsed to <code>Long</code></li>
<li><code>(1 2 3)</code> is parsed to <code>List[Long]</code></li>
<li><code>(1 "toto" 3)</code> is parsed to <code>List[Any]</code></li>
<li><code>{"toto" 1 "tata" 2}</code> is parsed to <code>Map[String, Long]</code></li>
<li><code>{1 "toto" 2 "tata"}</code> is parsed to <code>Map[Long, String]</code></li>
<li><code>{1 "toto" true 3}</code> is parsed to <code>Map[Any, Any]</code></li>
<li>etc&#8230;</li>
</ul>


<p>The parser (based on <a href="https://github.com/sirthias/parboiled2">Parboiled2</a>) provides 2 main functions:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">parser._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// parses only the first EDN value discovered in the String input</span>
</span><span class='line'><span class="k">def</span> <span class="n">parseEDN</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">ParserInput</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">EDN</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// parses all EDN values discovered in the String input</span>
</span><span class='line'><span class="k">def</span> <span class="n">parseEDNs</span><span class="o">(</span><span class="n">in</span><span class="k">:</span> <span class="kt">ParserInput</span><span class="o">)</span><span class="k">:</span> <span class="kt">Try</span><span class="o">[</span><span class="kt">Seq</span><span class="o">[</span><span class="kt">EDN</span><span class="o">]]</span> <span class="k">=</span> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you look in common package, you&#8217;ll see that <code>EDN</code> is just an alias for <code>Any</code> ;)</p>

<p>Here is how you can use it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">parser._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Single Value</span>
</span><span class='line'><span class="n">parseEDN</span><span class="o">(</span><span class="s">&quot;&quot;&quot;{1 &quot;foo&quot;, &quot;bar&quot; 1.234M, :foo/bar [1,2,3]} #_foo/bar :bar/foo&quot;&quot;&quot;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">Success</span><span class="o">(</span><span class="n">t</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">\/-(</span><span class="n">t</span><span class="o">)</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">Failure</span><span class="o">(</span><span class="n">f</span> <span class="k">:</span> <span class="kt">org.parboiled2.ParseError</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">-\/(</span><span class="n">parser</span><span class="o">.</span><span class="n">formatError</span><span class="o">(</span><span class="n">f</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Multiple Value</span>
</span><span class='line'><span class="n">parseEDNs</span><span class="o">(</span><span class="s">&quot;&quot;&quot;{1 &quot;foo&quot;, &quot;bar&quot; 1.234M, :foo/bar [1,2,3]} :bar/foo&quot;&quot;&quot;</span><span class="o">).</span><span class="n">success</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="n">be</span> <span class="o">(</span>
</span><span class='line'>  <span class="nc">Vector</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">Map</span><span class="o">(</span>
</span><span class='line'>      <span class="mi">1L</span> <span class="o">-&gt;</span> <span class="s">&quot;foo&quot;</span><span class="o">,</span>
</span><span class='line'>      <span class="s">&quot;bar&quot;</span> <span class="o">-&gt;</span> <span class="nc">BigDecimal</span><span class="o">(</span><span class="s">&quot;1.234&quot;</span><span class="o">),</span>
</span><span class='line'>      <span class="nc">EDNKeyword</span><span class="o">(</span><span class="nc">EDNSymbol</span><span class="o">(</span><span class="s">&quot;foo/bar&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">)))</span> <span class="o">-&gt;</span> <span class="nc">Vector</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'>    <span class="o">),</span>
</span><span class='line'>    <span class="nc">EDNKeyword</span><span class="o">(</span><span class="nc">EDNSymbol</span><span class="o">(</span><span class="s">&quot;bar/foo&quot;</span><span class="o">,</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;bar&quot;</span><span class="o">)))</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Some people will think <code>Any</code> is a bit too large and I agree but it&#8217;s quite practical to use. Moreover, using validation explained a bit later, you can parse your EDN and then map it to a stronger typed scala structure and then <code>Any</code> disappears.</p></blockquote>

<br/>


<h2>Compile-time parsing with Macros</h2>

<p>When you use static EDN structures in your Scala code, you can write them in their string format and <em>scaledn</em> can parse them at compile-time using Scala macros and thus prevent a lot of errors you can encounter in dynamic languages.</p>

<p>The macro mechanism is based on quasiquotes &amp; whitebox macro contexts which allow to infer types of your parsed EDN structures at compile-time. For example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="k">val</span> <span class="n">s</span><span class="k">:</span><span class="kt">Long</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;\&quot;toto\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>  <span class="n">found</span>   <span class="k">:</span> <span class="kt">String</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">toto</span><span class="err">&quot;</span><span class="o">)</span>
</span><span class='line'><span class="err">[</span><span class="kt">error</span><span class="err">]</span>  <span class="kt">required:</span> <span class="kt">Long</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>     <span class="k">val</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;\&quot;toto\&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Whooohooo magic :)</p>

<br/>


<h3>Classic Scala types</h3>

<p>Here is how you can use it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">macros._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// All types are just for info and can be omitted below, the macro infers them quite well</span>
</span><span class='line'><span class="k">val</span> <span class="n">e</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;\&quot;toto\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">bt</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;true&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">bf</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;false&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">l</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;123&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">d</span><span class="k">:</span> <span class="kt">Double</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;123.456&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">bi</span><span class="k">:</span> <span class="kt">BigInt</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;123M&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">bd</span><span class="k">:</span> <span class="kt">BigDecimal</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;123.456N&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">s</span><span class="k">:</span> <span class="kt">EDNSymbol</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;foo/bar&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">kw</span><span class="k">:</span> <span class="kt">EDNKeyword</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;:foo/bar&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Homogenous collection inferred as Vecto[String]</span>
</span><span class='line'><span class="k">val</span> <span class="n">vector</span><span class="k">:</span> <span class="kt">Vector</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[&quot;tata&quot; &quot;toto&quot; &quot;tutu&quot;]&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// multiple heterogenous values inferred as Seq[Any]</span>
</span><span class='line'><span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="nc">EDNs</span><span class="o">(</span><span class="s">&quot;&quot;&quot;(1 2 3) &quot;toto&quot; [true false] :foo/bar&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'><span class="c1">// note the small s at the end of EDN to inform the macro there are several values</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Shapeless heterogenous collections</h3>

<p>EDN allows to manipulate heterogenous collections. In Scala, when one thinks <em>heterogenous collection</em>, one thinks <a href="https://github.com/milessabin/shapeless">Shapeless</a>. Scaledn macros can parse &amp; map your EDN stringified structures to Scala strongly typed structures.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">macros._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">shapeless.</span><span class="o">{</span><span class="nc">HNil</span><span class="o">,</span> <span class="o">::}</span>
</span><span class='line'><span class="k">import</span> <span class="nn">shapeless.record._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">shapeless.syntax.singleton._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Heterogenous list</span>
</span><span class='line'><span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="nc">EDNH</span><span class="o">(</span><span class="s">&quot;&quot;&quot;(1 &quot;toto&quot; true)&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">s</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span><span class="mi">1L</span> <span class="o">::</span> <span class="s">&quot;toto&quot;</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Heterogenous Map/Record</span>
</span><span class='line'><span class="k">val</span> <span class="n">s3</span> <span class="k">=</span> <span class="nc">EDNH</span><span class="o">(</span><span class="s">&quot;&quot;&quot;{1 &quot;toto&quot; true 1.234 &quot;foo&quot; (1 2 3)}&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">s3</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span>
</span><span class='line'>  <span class="mi">1L</span> <span class="o">-&gt;&gt;</span> <span class="s">&quot;toto&quot;</span> <span class="o">::</span>
</span><span class='line'>  <span class="kc">true</span> <span class="o">-&gt;&gt;</span> <span class="mf">1.234</span> <span class="o">::</span>
</span><span class='line'>  <span class="s">&quot;foo&quot;</span> <span class="o">-&gt;&gt;</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">)</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>please note the <code>H</code> in <code>EDNH</code> for heterogenous</p>

<p>I must say using these macros, it might be even simpler to write Shapeless hlists or records than using scala API ;)</p></blockquote>

<br/>


<h3>Macro API</h3>

<p>Scaledn provides different macros depending on the depth of introspection you require in your collection with respect to heterogeneity.</p>

<p>Have a look directly at <a href="https://github.com/mandubian/scaledn/blob/master/macros/src/main/scala/macros.scala">Macro API</a></p>

<br/>


<h3>Mixing macro with Scala string interpolation</h3>

<p>Following ideas implemented by Daniel James in <a href="http://pellucidanalytics.github.io/datomisca/">Datomisca</a>, scaledn proposes to use String interpolation mixed with parsing macro such as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">macros._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">shapeless.</span><span class="o">{</span><span class="nc">HNil</span><span class="o">,</span> <span class="o">::}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">l</span> <span class="k">=</span> <span class="mi">123L</span>
</span><span class='line'><span class="k">val</span> <span class="n">s</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">r</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;$l&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">r1</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Any</span><span class="o">]</span> <span class="k">=</span> <span class="nc">EDN</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;($l $s)&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">r2</span><span class="k">:</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span> <span class="k">=</span> <span class="nc">EDNH</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;($l $s)&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing to add, macros are cool sometimes :)</p>

<br/>


<br/>


<h2>Runtime validation of EDN to Scala</h2>

<p>When writing REST or external API, the received data can never be trusted before being validated. So, you generally try to validate what is received and map it to a strong-typed structures. For example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// parse the received string input</span>
</span><span class='line'><span class="n">parseEDN</span><span class="o">(</span><span class="s">&quot;&quot;&quot;{ 1 &quot;toto&quot; 2 &quot;tata&quot; 3 &quot;tutu&quot; }&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'><span class="c1">// then validate it to a Scala type</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">validate</span><span class="o">[</span><span class="kt">Map</span><span class="o">[</span><span class="kt">Long</span>, <span class="kt">String</span><span class="o">]])</span>
</span><span class='line'>  <span class="o">.</span><span class="n">success</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="n">be</span> <span class="o">(</span>
</span><span class='line'>    <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="nc">Success</span><span class="o">(</span><span class="nc">Map</span><span class="o">(</span>
</span><span class='line'>      <span class="mi">1L</span> <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span>
</span><span class='line'>      <span class="mi">2L</span> <span class="o">-&gt;</span> <span class="s">&quot;tata&quot;</span><span class="o">,</span>
</span><span class='line'>      <span class="mi">3L</span> <span class="o">-&gt;</span> <span class="s">&quot;tutu&quot;</span>
</span><span class='line'>    <span class="o">))</span>
</span><span class='line'>  <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The validation API is the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">validate._</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">validate</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">edn</span><span class="k">:</span> <span class="kt">EDN</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">r</span><span class="k">:</span> <span class="kt">RuleLike</span><span class="o">[</span><span class="kt">EDN</span>, <span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Validation</span><span class="o">[</span><span class="kt">EDN</span>, <span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="n">r</span><span class="o">.</span><span class="n">validate</span><span class="o">(</span><span class="n">edn</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Scaledn validation is based on <a href="https://github.com/jto/validation">Generic Validation API</a> developed by my <a href="http://www.mfglabs.com">MFGLabs</a>&#8217;s colleague &amp; friend <a href="https://github.com/jto">Julien Tournay</a>. This API was developed for Play Framework &amp; Typesafe last year to generalize Json validation API to all data formats. But it will never be integrated in Play as Typesafe considers it to be too pure Scala &amp; pure FP-oriented. Yet, we use this API in production at <a href="http://www.mfglabs.com">MFGLabs</a> and maintain/extend it ourselves.</p>

<p>As explained before, Scaledn parser parses EDN values directly to Scala types as they are bijective so validation is often just a runtime cast and not very interesting in general.</p>

<p>What&#8217;s much more interesting is to validate to Shapeless HList, Records and even more interesting to CaseClasses &amp; Tuples based on Shapeless fantastic auto-generated Generic macros.</p>

<p>Let&#8217;s take a few examples to show the power of this feature:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">validate._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.data.mapping._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">shapeless.</span><span class="o">{</span><span class="nc">HNil</span><span class="o">,</span> <span class="o">::}</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">CP</span><span class="o">(</span><span class="n">cp</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Address</span><span class="o">(</span><span class="n">street</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">cp</span><span class="k">:</span> <span class="kt">CP</span><span class="o">)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">addr</span><span class="k">:</span> <span class="kt">Address</span><span class="o">)</span>
</span><span class='line'><span class="c1">// Remark that NO implicits must be declared on our case classes</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// HLISTS</span>
</span><span class='line'><span class="n">parseEDN</span><span class="o">(</span><span class="s">&quot;&quot;&quot;(1 &quot;toto&quot; true nil)&quot;&quot;&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">(</span>
</span><span class='line'>  <span class="n">validate</span><span class="o">[</span><span class="kt">Long</span> <span class="kt">::</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Boolean</span> <span class="kt">::</span> <span class="kt">EDNNil.</span><span class="k">type</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">]</span>
</span><span class='line'><span class="o">).</span><span class="n">success</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="n">be</span> <span class="o">(</span>
</span><span class='line'>  <span class="nc">Success</span><span class="o">(</span><span class="mi">1L</span> <span class="o">::</span> <span class="s">&quot;toto&quot;</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="nc">EDNNil</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TUPLES</span>
</span><span class='line'><span class="n">parseEDN</span><span class="o">(</span><span class="s">&quot;&quot;&quot;(&quot;toto&quot; 34 {&quot;street&quot; &quot;chboing&quot;, &quot;cp&quot; {&quot;cp&quot; 75009}})&quot;&quot;&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">(</span>
</span><span class='line'>  <span class="n">validate</span><span class="o">[</span><span class="kt">Tuple3</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">Int</span>, <span class="kt">Address</span><span class="o">]]</span>
</span><span class='line'><span class="o">).</span><span class="n">success</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="n">be</span> <span class="o">(</span>
</span><span class='line'>  <span class="nc">Success</span><span class="o">((</span><span class="s">&quot;toto&quot;</span><span class="o">,</span> <span class="mi">34</span><span class="o">,</span> <span class="nc">Address</span><span class="o">(</span><span class="s">&quot;chboing&quot;</span><span class="o">,</span> <span class="nc">CP</span><span class="o">(</span><span class="mi">75009</span><span class="o">))))</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// CASECLASSES</span>
</span><span class='line'><span class="n">parseEDN</span><span class="o">(</span><span class="s">&quot;&quot;&quot;(&quot;toto&quot; 34 (&quot;chboing&quot; (75009)))&quot;&quot;&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">(</span>
</span><span class='line'>  <span class="n">validate</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
</span><span class='line'><span class="o">).</span><span class="n">success</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="n">be</span> <span class="o">(</span>
</span><span class='line'>  <span class="nc">Success</span><span class="o">(</span><span class="nc">Person</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">,</span> <span class="mi">34</span><span class="o">,</span> <span class="nc">Address</span><span class="o">(</span><span class="s">&quot;chboing&quot;</span><span class="o">,</span> <span class="nc">CP</span><span class="o">(</span><span class="mi">75009</span><span class="o">))))</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">parseEDN</span><span class="o">(</span><span class="s">&quot;&quot;&quot;{&quot;name&quot; &quot;toto&quot;, &quot;age&quot; 34, &quot;addr&quot; {&quot;street&quot; &quot;chboing&quot;, &quot;cp&quot; {&quot;cp&quot; 75009}}}&quot;&quot;&quot;</span><span class="o">).</span><span class="n">map</span><span class="o">(</span>
</span><span class='line'>  <span class="n">validate</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
</span><span class='line'><span class="o">).</span><span class="n">success</span><span class="o">.</span><span class="n">value</span> <span class="n">should</span> <span class="n">be</span> <span class="o">(</span>
</span><span class='line'>  <span class="nc">Success</span><span class="o">(</span><span class="nc">Person</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">,</span> <span class="mi">34</span><span class="o">,</span> <span class="nc">Address</span><span class="o">(</span><span class="s">&quot;chboing&quot;</span><span class="o">,</span> <span class="nc">CP</span><span class="o">(</span><span class="mi">75009</span><span class="o">))))</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>I think here you can see the power of this validation feature without writing any boilerplate&#8230;</p></blockquote>

<br/>


<br/>


<h2>Serializing Scala to EDN</h2>

<p>Using <a href="https://github.com/jto/validation">Generic Validation API</a>, you can also write scala structures to any other data format.</p>

<p>Scaledn provides serialization from scala structures to EDN Strings. For example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">write._</span>
</span><span class='line'>
</span><span class='line'><span class="n">toEDNString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">)</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span><span class="s">&quot;\&quot;toto\&quot;&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">toEDNString</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span><span class="s">&quot;&quot;&quot;(1 2 3)&quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The write API is the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">write._</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">toEDNString</span><span class="o">[</span><span class="kt">I</span><span class="o">](</span><span class="n">i</span><span class="k">:</span> <span class="kt">I</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">w</span><span class="k">:</span> <span class="kt">WriteLike</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">w</span><span class="o">.</span><span class="n">writes</span><span class="o">(</span><span class="n">i</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Once again, what&#8217;s more interesting is using shapeless &amp; caseclasses &amp; tuples.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scaledn._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">write._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">shapeless.</span><span class="o">{</span><span class="nc">HNil</span><span class="o">,</span> <span class="o">::}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// HLIST</span>
</span><span class='line'><span class="n">toEDNString</span><span class="o">(</span><span class="mi">1</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">)</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span><span class="s">&quot;&quot;&quot;(1 true (1 2 3))&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TUPLE</span>
</span><span class='line'><span class="n">toEDNString</span><span class="o">((</span><span class="mi">23</span><span class="o">,</span> <span class="kc">true</span><span class="o">))</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span><span class="s">&quot;&quot;&quot;(23 true)&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// CASE CLASS</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Address</span><span class="o">(</span><span class="n">street</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">cp</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">addr</span><span class="k">:</span> <span class="kt">Address</span><span class="o">)</span>
</span><span class='line'><span class="c1">// Remark that NO implicits must be declared on our case classes</span>
</span><span class='line'>
</span><span class='line'><span class="n">toEDNString</span><span class="o">(</span><span class="nc">Person</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">,</span> <span class="mi">34</span><span class="o">,</span> <span class="nc">Address</span><span class="o">(</span><span class="s">&quot;chboing&quot;</span><span class="o">,</span> <span class="mi">75009</span><span class="o">)))</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;&quot;&quot;{&quot;name&quot; &quot;toto&quot;, &quot;age&quot; 34, &quot;addr&quot; {&quot;street&quot; &quot;chboing&quot;, &quot;cp&quot; 75009}}&quot;&quot;&quot;</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>TODO</h2>

<p>This project is a first draft so it requires a bit more work.</p>

<p>Here are a few points to work on:</p>

<ul>
<li>patch remaining glitches/bugs</li>
<li>write more tests for all cases</li>
<li>study streamed parser asap</li>
<li>write sample apps</li>
</ul>


<p>Don&#8217;t hesitate to test, find bugs, contribute, give remarks, ideas&#8230;</p>

<p>Have fun in EDN world&#8230;</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/07/30/hfunctor/">Shapeless HFunctor for Heterogenous Structures (& Others)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-30T08:08:00+02:00" pubdate data-updated="true">Jul 30<span>th</span>, 2014</time>
        
         | <a href="/2014/07/30/hfunctor/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>Not an article, just some reflections on this idea&#8230;</p></blockquote>

<p>You know what is a functor?</p>

<ul>
<li><p>2 categories <code>C</code> &amp; <code>D</code>, simplifying a category as:</p>

<ul>
<li>a set of objects with some arrows/morphisms/functions between objects: <code>f: x -&gt; y</code></li>
<li>those morphisms are associative <code>h . (g . f) = (h . g) .f</code> where <code>.</code> is the composition <code>(g . f)(x) = g(f(x))</code>)</li>
<li>for each object there is an identity morphism <code>id(x) = x -&gt; x</code></li>
</ul>
</li>
<li><p>a functor <code>F</code> associates :</p>

<ul>
<li>each object <code>x</code> of <code>C</code> with an object of <code>F(x)</code> of <code>D</code>.</li>
<li>each morphism <code>f: x -&gt; y</code> of <code>C</code> with an element <code>F(f): F(x) -&gt; F(y)</code> of <code>D</code> such that:

<ul>
<li><code>F(id(x)) = id(F(x))</code></li>
<li><code>F(g . f) = F(g) . F(f)</code></li>
</ul>
</li>
</ul>
</li>
</ul>


<blockquote><p>A Functor is a mapping (an homomorphism) between categories that conserves the <em>structure</em> of the category (the morphisms, the relation between objects) whatever the kind of objects those categories contain.</p></blockquote>

<p>In scalaz, here is the definition of a Functor:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Functor</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]]</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">////</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/** Lift `f` into `F` and apply to `F[A]`. */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">map</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">fa</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="n">B</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see the famous <code>map</code> function that you can find in many structures in Scala : <code>List[_]</code>, <code>Option[_]</code>, <code>Map[_, _]</code>, <code>Future[_]</code>, etc&#8230;</p>

<p>Why? Because all these structures are <code>Functors</code> between the categories of Scala types&#8230;</p>

<blockquote><p>Math is everywhere in programming &amp; programming is Math so don&#8217;t try to avoid it ;)</p></blockquote>

<p>So you can write a <code>Functor[List]</code> or <code>Functor[Option]</code> as those structures are monoids.</p>

<p>Now let&#8217;s consider <code>HList</code> the heterogenous List provided by Miles Sabin&#8217;s fantastic <a href="https://github.com/milessabin/shapeless/wiki/Feature-overview:-shapeless-2.0.0#heterogenous-lists">Shapeless</a>. <code>HList</code> looks like a nice Functor.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">(</span><span class="mi">1</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span> <span class="n">map</span> <span class="o">(</span>
</span><span class='line'>   <span class="o">(</span><span class="n">i</span><span class="k">:</span><span class="kt">Int</span><span class="o">)</span>     <span class="k">=&gt;</span> <span class="n">i</span><span class="o">.</span><span class="n">toString</span> <span class="o">,</span>
</span><span class='line'>   <span class="o">(</span><span class="n">b</span><span class="k">:</span><span class="kt">Boolean</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">b</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="s">&quot;1&quot;</span> <span class="o">::</span> <span class="s">&quot;true&quot;</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok, it&#8217;s a bit more complex as this functor requires not one function but several for each element type constituting the <code>HList</code>, a kind of polymorphic function. Hopefully, Shapeless provides exactly a structure to represent this: <a href="https://github.com/milessabin/shapeless/wiki/Feature-overview:-shapeless-2.0.0#polymorphic-function-values">Poly</a></p>

<p>What about writing a functor for <code>HList</code>?</p>

<p>Scalaz Functor isn&#8217;t very helpful (ok I just copy the HMonoid text &amp; tweak it ;)):</p>

<p>To be able to write a <code>Functor of HList</code>, we need something else based on multiple different types&#8230;</p>

<p>I spent a few hours having fun on this idea with Shapeless and tried to implement a Functor for heterogenous structures like <code>HList</code>, <code>Sized</code> and even not heterogenous structures.</p>

<p><strong>Here are the working <a href="https://github.com/mandubian/injective/blob/shapeless-ext/src/test/scala/ShapelessSpec.scala#L101">samples</a>.</strong></p>

<p><strong> Here is the <a href="https://github.com/mandubian/injective/blob/shapeless-ext/src/main/scala/ShapelessExt.scala#L21">code</a> based on <em>pseudo-dependent</em> types as shapeless.</strong></p>

<p>The signature of the <code>HFunctor</code> as a <code>map</code> function as expected:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">HFunctor</span><span class="o">[</span><span class="kt">HA</span>, <span class="kt">F</span> <span class="k">&lt;:</span> <span class="kt">Poly</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="kt">Real</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">trait</span> <span class="nc">HMapper</span><span class="o">[</span><span class="kt">P</span> <span class="k">&lt;:</span> <span class="kt">Poly</span>, <span class="kt">In</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">DepFn1</span><span class="o">[</span><span class="kt">In</span><span class="o">]</span> <span class="o">{</span> <span class="k">type</span> <span class="kt">Out</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">hmapper</span><span class="k">:</span> <span class="kt">HMapper</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">HA</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">map</span><span class="o">(</span><span class="n">ha</span><span class="k">:</span> <span class="kt">HA</span><span class="o">)(</span><span class="n">f</span><span class="k">:</span> <span class="kt">F</span><span class="o">)</span><span class="k">:</span> <span class="kt">hmapper.Out</span> <span class="o">=</span> <span class="n">hmapper</span><span class="o">(</span><span class="n">ha</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is just a sandbox to open discussion on this idea so I won&#8217;t explain more and let the curious ones think about it&#8230;</p>

<p>Have F(un)!</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/07/29/hmonoid/">Shapeless HMonoid for Heterogenous Structures (& Others)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-07-29T23:23:00+02:00" pubdate data-updated="true">Jul 29<span>th</span>, 2014</time>
        
         | <a href="/2014/07/29/hmonoid/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>Not an article, just some reflections on this idea&#8230;</p></blockquote>

<p>You know what is a monoid?</p>

<ul>
<li>a binary operation taking 2 elements and giving another element <code>e x e -&gt; e</code> (aka a <strong>SemiGroup</strong>)</li>
<li>a Identity <code>id</code> element <code>id . e = e . id = e</code> (also called <strong>zero element</strong>)</li>
</ul>


<p>(and some associativity)</p>

<p>In scalaz, here is the definition:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Monoid</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">Semigroup</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span> <span class="o">{</span> <span class="n">self</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">////</span>
</span><span class='line'>  <span class="cm">/** The identity element for `append`. */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">zero</span><span class="k">:</span> <span class="kt">F</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">append</span><span class="o">(</span><span class="n">f1</span><span class="k">:</span> <span class="kt">F</span><span class="o">,</span> <span class="n">f2</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">F</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see the <code>zero</code> &amp; the <code>SemiGroup.append</code> operations, right?</p>

<p>So you can write a <code>Monoid[Int]</code> or <code>Monoid[List[A]]</code> as those structures are monoids.</p>

<p>Now let&#8217;s consider <code>HList</code> the heterogenous List provided by Miles Sabin&#8217;s fantastic <a href="https://github.com/milessabin/shapeless/wiki/Feature-overview:-shapeless-2.0.0#heterogenous-lists">Shapeless</a>. <code>HList</code> looks like a nice monoid.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">(</span><span class="mi">1</span> <span class="o">::</span> <span class="s">&quot;toto&quot;</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span> <span class="o">++</span> <span class="o">(</span><span class="kc">true</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="mi">1</span> <span class="o">::</span> <span class="s">&quot;toto&quot;</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What about writing a monoid for <code>HList</code>?</p>

<p>Scalaz monoid isn&#8217;t very helpful because our monoid operations would look like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">zero</span><span class="k">:</span> <span class="kt">HNil.type</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">append</span><span class="o">(</span><span class="n">f1</span><span class="k">:</span> <span class="kt">H1</span> <span class="k">&lt;:</span> <span class="kt">HList</span><span class="o">,</span> <span class="n">f2</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">H2</span> <span class="k">&lt;:</span> <span class="nc">HList</span><span class="o">)</span><span class="k">:</span> <span class="kt">H3</span> <span class="k">&lt;:</span> <span class="kt">HList</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, to be able to write a <code>Monoid of HList</code>, we need something else based on multiple different types&#8230;</p>

<p>I spent a few hours having fun on this idea with Shapeless and tried to implement a Monoid for heterogenous structures like <code>HList</code>, <code>Nat</code>, <code>Sized</code> and even not heterogenous structures.</p>

<p><strong>Here are the working <a href="https://github.com/mandubian/injective/blob/shapeless-ext/src/test/scala/ShapelessSpec.scala#L23">samples</a>.</strong></p>

<p><strong> Here is the <a href="https://github.com/mandubian/injective/blob/shapeless-ext/src/main/scala/ShapelessExt.scala#L35">code</a> based on <em>pseudo-dependent</em> types as shapeless.</strong></p>

<p>The signature of the <code>HMonoid</code> shows the <code>zero</code> and the <code>Semigroup</code> as expected:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">HMonoid</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span> <span class="nc">extends</span> <span class="nc">HZero</span> <span class="k">with</span> <span class="nc">HSemiGroup</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This is just a sandbox to open discussion on this idea so I won&#8217;t explain more and let the curious ones think about it&#8230;</p>

<p>Have Monoids of Fun!</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/06/11/daemonad/">Summon Daemonad to Macro-snoop Into Monad Stacks</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-06-11T23:23:00+02:00" pubdate data-updated="true">Jun 11<span>th</span>, 2014</time>
        
         | <a href="/2014/06/11/daemonad/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/daemonad">Github</a></p>

<blockquote><p>Forget the buzz title, this project is still very draft but it&#8217;s time to expel it out of my R&amp;D sandbox as imperfect as it might be&#8230; Before I lose my sanity while wandering in Scala macro hygiene ;)</p></blockquote>

<h2>What?</h2>

<p><code>Daemonad</code> is a nasty Scala macro that aims at:</p>

<ul>
<li>marking where you manipulate monads or stacks of monads</li>
<li>compile-checking monadic behavior &amp; implicit monad instances</li>
<li>allowing to <code>snoop</code> monad values deep into (some) monad stacks in the same way as <code>ScalaAsync</code> i.e. in a pseudo-imperative way.</li>
</ul>


<blockquote><p>This project is NOT yet stable, NOT very robust so use it at your own risks but we can discuss about it&#8230;</p></blockquote>

<p>Here is what you can write right now.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span>
</span><span class='line'>  <span class="n">monadic</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Option</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="nc">Future</span> <span class="o">(</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">9</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">snoop2</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">)</span> <span class="n">snoop1</span><span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">+</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">else</span> <span class="n">c</span>
</span><span class='line'>  <span class="o">},</span> <span class="n">duration</span><span class="o">.</span><span class="nc">Duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="mi">17</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Motivations</h2>

<h3>1 - Experiment writing a very ugly Scala macro</h3>

<p>I wanted to write a huge &amp; complex Scala macro that would move pieces of code, create more code, types etc&#8230;</p>

<p>I wanted to know the difficulties that it implies.</p>

<p>I felt reckless, courageous!</p>

<p>Nothing could stop me!!!!</p>

<blockquote><p>Result: I was quite insane and I will certainly write a post-mortem article about it to show the horrible difficulties I&#8217;ve encountered. My advice: let people like hit their head against the wall and wait for improved hygienic macros that should come progressively before writing big macros ;)</p></blockquote>

<h3>2 - Investigate ScalaAsync generalization to all monads + (some) monad stacks</h3>

<p>I had investigated <a href="https://github.com/scala/async">ScalaAsync</a> code and thought it would be possible to generalize it to all kinds of monads and go further by managing monad stacks.</p>

<blockquote><p>Result : Simple monads are easy to manage (as seen also in <a href="https://github.com/aztek/scala-workflow">scala-workflow</a> which I discovered very recently) and some monad stacks can be managed with Scalaz monad transformers.</p>

<p>But don&#8217;t think you can use all kinds of monad transformers: the limits of Scala compiler with type-lambdas in macros and my very own limits blocked me from going as far as I expected.</p>

<p>So for now, it can manage Future/Option/List stacks &amp; also Either \/ using type aliases.</p></blockquote>

<br/>


<h3>3 - Explicitly Mark monadic blocks</h3>

<p>There are 2 ways of seeing monads:</p>

<h4>You don&#8217;t need or you don&#8217;t want to know what is a monad&#8230;</h4>

<p><strong>&#8230; And yet you use it everyday/everywhere.</strong></p>

<p>This is what most of us (and it&#8217;s so shameful) do using those cool <code>map/flatMap</code> functions provided by Scala libraries that allow to access the values inside <code>Future</code>, <code>List</code>, <code>Option</code> in a <em>protected</em> way etc&#8230;
That&#8217;s enough for you need in your everyday life, right?</p>

<br/>


<h4>You want to know or you know what is a monad &#8230;</h4>

<p><strong>&#8230; and you want to use them on purpose.</strong></p>

<p>This is what <em>hippy developers</em> do in advanced Scala using Scalaz or even crazier in pure FP languages like Haskell.</p>

<blockquote><p>Guess what I prefer?</p></blockquote>

<p>Here is the kind of code I&#8217;d like to write :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// I write my datastructure without any map/flatMap function</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Toto</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Hey I proved Toto was a monad (yes believe me)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Let&#39;s bring this concept into my scope</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">object</span> <span class="nc">TotoMonad</span> <span class="k">extends</span> <span class="nc">Monad</span><span class="o">[</span><span class="kt">Toto</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">bind</span><span class="o">[</span><span class="kt">A</span>, <span class="kt">B</span><span class="o">](</span><span class="n">fa</span><span class="k">:</span> <span class="kt">Toto</span><span class="o">[</span><span class="kt">A</span><span class="o">])(</span><span class="n">f</span><span class="k">:</span> <span class="kt">A</span> <span class="o">=&gt;</span> <span class="nc">Toto</span><span class="o">[</span><span class="kt">B</span><span class="o">])</span><span class="k">:</span> <span class="kt">Toto</span><span class="o">[</span><span class="kt">B</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">f</span><span class="o">(</span><span class="n">fa</span><span class="o">.</span><span class="n">a</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">point</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">a</span><span class="k">:</span> <span class="o">=&gt;</span> <span class="n">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Toto</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Toto</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="c1">// I create my toto</span>
</span><span class='line'><span class="k">val</span> <span class="n">toto</span> <span class="k">=</span> <span class="nc">Toto</span><span class="o">(</span><span class="s">&quot;this is toto&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Suddenly I decide that I must use this monadic behavior of toto</span>
</span><span class='line'><span class="n">monadic</span><span class="o">[</span><span class="kt">Toto</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="o">&lt;</span><span class="n">snoop_value_inside_monad</span><span class="o">&gt;(</span><span class="n">toto</span><span class="o">)</span> <span class="c1">// outside the monadic block, you shall not do that</span>
</span><span class='line'>  <span class="n">do_something_with_value</span><span class="o">(</span><span class="n">a</span><span class="o">)</span>
</span><span class='line'>  <span class="c1">// The compiler takes care that my structure is used in a pure monadic way</span>
</span><span class='line'>  <span class="c1">// and returns a monad Toto of the right type</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Ok I speak about pure functional programming and then about snooping the value out of the monad. This might seem a bit useless or even stupid compared to using directly Monad facilities. I agree and I still wonder about the sanity of this project but I&#8217;m stubborn and I try to finish what I start ;)</p></blockquote>

<br/>


<h2>Back to code Sample</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span>
</span><span class='line'>  <span class="n">monadic</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Option</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="nc">Future</span> <span class="o">(</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">9</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">7</span><span class="o">)</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">snoop2</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">)</span> <span class="n">snoop1</span><span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">+</span> <span class="mi">10</span>
</span><span class='line'>    <span class="k">else</span> <span class="n">c</span>
</span><span class='line'>  <span class="o">},</span> <span class="n">duration</span><span class="o">.</span><span class="nc">Duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="mi">17</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>What does it do ?</p>

<ul>
<li><code>monadic</code> marks the monadic block</li>
<li><code>monadic[Future, Option]</code> declares that you manipulate a stack <code>Future[Option]</code> (and no other)</li>
<li><code>snoopX</code> means that you want to snoop the monad value at X-th level (1, 2, 3, 4 and no more for now)</li>
<li>the macro checks for implicit instances of monads (here <code>List</code>, <code>Option</code>, <code>Future</code>) and monad transformers (here <code>OptionT</code> &amp; <code>ListT</code>) for this stack</li>
<li>the macro translates this code into crazy embedded <code>Monad.bind/point/lift/run</code>&#8230;</li>
<li><code>snoop2</code> is used in first position: if you have used <code>snoop1</code>, the macro would have rejected your monadic block. It&#8217;s logical, when you use <code>flatMap</code>, you always start with the deeper stack of monad and I chose not to change the order of your code as I find this macro is already far too intrusive :)</li>
</ul>


<blockquote><p>I&#8217;m sure you don&#8217;t want to see the code you would have to write for this, this is quite long and boring.</p>

<p>Let just say that this code is generated by a Scala macro for you.</p>

<p>The current generated code isn&#8217;t optimized at all and quite redundant but this is for next iterations.</p></blockquote>

<br/>


<h2>What is working ?</h2>

<ul>
<li>stacks with List/Option/Either up to depth 4</li>
<li>custom Monads</li>
<li>a few preliminary checkings that prevent you from writing stupid code but not so much</li>
<li>if/then/else &amp; case/match in some cases</li>
</ul>


<br/>


<h2>What isn&#8217;t working ?</h2>

<ul>
<li>monadic block assigned to a val not explicitly typed.</li>
<li>many things or edge-cases with mixed monad depth and if/match.</li>
<li>can&#8217;t use advanced monad transformers like StateT or WriterT in monadic block because Scala compiler doesn&#8217;t allow what I expected with type lambdas. <em>This needs to be studied further.</em></li>
</ul>


<h2>A very stupid example to finish with 4-depth stack</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">it</span> <span class="n">should</span> <span class="s">&quot;&quot;&quot;snoop4 on stupid stack&quot;&quot;&quot;</span> <span class="n">in</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">type</span> <span class="kt">S</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">({</span> <span class="k">type</span> <span class="kt">l</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">\/[</span><span class="kt">String</span>, <span class="kt">T</span><span class="o">]</span> <span class="o">})</span><span class="k">#</span><span class="n">l</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>    <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span>
</span><span class='line'>      <span class="n">monadic</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">S</span>, <span class="kt">List</span>, <span class="kt">Option</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">a</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">S</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]]]</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">(\/-(</span><span class="nc">List</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">10</span><span class="o">))))</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">b</span><span class="k">:</span> <span class="kt">S</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]]</span> <span class="k">=</span> <span class="o">\/-(</span><span class="nc">List</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">2</span><span class="o">)))</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">c</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">4</span><span class="o">))</span>
</span><span class='line'>        <span class="k">val</span> <span class="n">d</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'>        <span class="o">(</span><span class="n">snoop4</span><span class="o">(</span><span class="n">a</span><span class="o">)</span> <span class="o">+</span> <span class="n">snoop3</span><span class="o">(</span><span class="n">b</span><span class="o">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">snoop2</span><span class="o">(</span><span class="n">c</span><span class="o">))</span> <span class="o">/</span> <span class="n">snoop1</span><span class="o">(</span><span class="n">d</span><span class="o">)</span>
</span><span class='line'>      <span class="o">},</span> <span class="n">duration</span><span class="o">.</span><span class="nc">Duration</span><span class="o">(</span><span class="s">&quot;1 second&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">)</span> <span class="n">should</span> <span class="n">equal</span> <span class="o">(\/-(</span><span class="nc">List</span><span class="o">(</span><span class="nc">Some</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">1</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">3</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">2</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">4</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">4</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">5</span><span class="o">),</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">5</span><span class="o">))))</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that:</p>

<ul>
<li>you have to use a type alias to Scalaz \/ to one parametric type.</li>
<li>you have to help a bit the compiler about type alias S or it will infer \/[A, B] which is not what we want for the monad. This might seem tedious but I&#8217;ll study if I can go around this.</li>
<li>look at the result: you have a 2 elements list and at the end, you have a 8 elements list: WHAT???? No it&#8217;s normal, this is the result <code>flatmap</code> between first and second and third list. 2*2*2 = 8&#8230; nothing strange but it can be surprising at first glance ;)</li>
</ul>


<br/>


<h2>TODO</h2>

<ul>
<li>refactor all code because it&#8217;s ugly, not robust and redundant!!!</li>
<li>rely on <code>MonadTrans[F[_], _]</code> instead of hardcoding monad transformers as now.</li>
<li>accept custom <code>MonadTrans</code> provided in the user code.</li>
<li>steal some inspiration from <a href="https://github.com/aztek/scala-workflow">scala-workflow</a> because I find this code cool.</li>
</ul>


<br/>


<h2>Special Thanks</h2>

<ul>
<li>Eugene Burmako (@xeno_by) for helping me each time I was lost in macros</li>
<li>Jason Zaugg (@retronym) for Scala Async and splicer</li>
<li>Daniel James (@dwhjames) for the <code>snoop</code> name</li>
<li>Thibaut Duplessis (@ornicar) for the monad stack idea</li>
</ul>


<p>Have a look at the code on <a href="https://github.com/mandubian/daemonad">Github</a>.</p>

<p>Have snoop22(macrofun)!</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/03/10/zpark-ml-nio-3/">ZPark-Ztream II (Part 3/3): Fancy Spark Streamed Machine-Learning & New Scalaz-Stream NIO API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-10T19:19:00+01:00" pubdate data-updated="true">Mar 10<span>th</span>, 2014</time>
        
         | <a href="/2014/03/10/zpark-ml-nio-3/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Synopsis</h2>

<p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p><a href="/2014-02-13-zpark">Zpark-Zstream I article</a> was a PoC trying to use <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> instead of DStream with <a href="https://spark.incubator.apache.org/">Spark-Streaming</a>. I had deliberately decided not to deal with fault-tolerance &amp; stream graph persistence to keep simple but without it, it was quite useless for real application&#8230;</p></blockquote>

<div class="well">
<p>Here is a tryptic of articles trying to do something <i>concrete</i> with <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> and <a href="https://spark.incubator.apache.org/">Spark</a>.</p>
<p>So, what do I want? I wantttttttt <i>a shrewburyyyyyy</i> and to do the following:</p>
<ol>
<li>Plug Scalaz-Stream Process[Task, T] on Spark DStream[T] (Part 1)</li>
<li>Build DStream using brand new Scalaz-Stream NIO API (client/server) (Part 2)</li>
<li><b>Train Spark-ML <i>recommendation-like</i> model using NIO client/server (Part 3)</b></li>
<li><b>Stream data from multiple NIO clients to the previous trained ML model mixing all together (Part 3)</b></li>
</ol>
</div>


<h1>[Part 3/3] Fancy Spark Machine Learning with NIO client/server &amp; DStream&#8230;</h1>

<br/>


<blockquote><p>Let&#8217;s remind that I&#8217;m not an expert in ML but more a student. So if I tell or do stupid ML things, be indulgent ;)</p></blockquote>

<p>Here is what I propose:</p>

<ul>
<li><p>Train a collaborative filtering rating model for a recommendation system (as explained in Spark doc <a href="https://spark.incubator.apache.org/docs/0.9.0/mllib-guide.html#collaborative-filtering-1">there</a>) using a first NIO server and a client as presented in part 2.</p></li>
<li><p>When model is trained, create a second server that will accept client connections to receive data.</p></li>
<li><p>Stream/merge all received data into one single stream, dstreamize it and perform streamed predictions using previous model.</p></li>
</ul>


<h2>Train collaborative filtering model</h2>

<h3>Training client</h3>

<p>As explained in Spark doc about collaborative filtering, we first need some data to train the model. I want to send those data using a NIO client.</p>

<p>Here is a function doing this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING CLIENT</span>
</span><span class='line'><span class="k">def</span> <span class="n">trainingClient</span><span class="o">(</span><span class="n">addr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// naturally you could provide much more data</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">basicTrainingData</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="c1">// user ID, item ID, Rating</span>
</span><span class='line'>    <span class="s">&quot;1,1,5.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;1,2,1.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;1,3,5.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;1,4,1.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;2,4,1.0&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;2,2,5.0&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">trainingProcess</span> <span class="k">=</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">emitAll</span><span class="o">(</span><span class="n">basicTrainingData</span> <span class="n">map</span> <span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">((</span><span class="n">s</span><span class="o">+</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">getBytes</span><span class="o">)))</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// sendAndCheckSize is a special client sending all data emitted </span>
</span><span class='line'>  <span class="c1">// by the process and verifying the server received all data </span>
</span><span class='line'>  <span class="c1">// by acknowledging all data size</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="nc">NioClient</span><span class="o">.</span><span class="n">sendAndCheckSize</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">trainingProcess</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">client</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Training server</h3>

<p>Now we need the training NIO server waiting for the training client to connect and piping the received data to the model.</p>

<p>Here is a useful function to help creating a server as described in previous article part:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">server</span><span class="o">(</span><span class="n">addr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">],</span> <span class="nc">Signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">stop</span> <span class="k">=</span> <span class="n">async</span><span class="o">.</span><span class="n">signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'>  <span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// this is a server that is controlled by a stop signal</span>
</span><span class='line'>  <span class="c1">// and that acknowledges all received data by their size</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">server</span> <span class="k">=</span>
</span><span class='line'>    <span class="o">(</span> <span class="n">stop</span><span class="o">.</span><span class="n">discrete</span> <span class="n">wye</span> <span class="nc">NioServer</span><span class="o">.</span><span class="n">ackSize</span><span class="o">(</span><span class="n">addr</span><span class="o">)</span> <span class="o">)(</span><span class="n">wye</span><span class="o">.</span><span class="n">interrupt</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// returns a stream of received data &amp; a signal to stop server</span>
</span><span class='line'>  <span class="o">(</span><span class="n">server</span><span class="o">,</span> <span class="n">stop</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>We can create the training server with it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">trainingAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11100</span><span class="o">)</span>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServer</span><span class="o">,</span> <span class="n">trainingStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>trainingServer</code> is a <code>Process[Task, Bytes]</code> streaming the training data received from training client. We are going to train the rating model with them.</p>

<br/>


<h3>Training model</h3>

<p>To train a model, we can use the following API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// the rating with user ID, product ID &amp; rating</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Rating</span><span class="o">(</span><span class="k">val</span> <span class="n">user</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="k">val</span> <span class="n">product</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="k">val</span> <span class="n">rating</span><span class="k">:</span> <span class="kt">Double</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A RDD of ratings</span>
</span><span class='line'><span class="k">val</span> <span class="n">ratings</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">Rating</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// train the model with it</span>
</span><span class='line'><span class="k">val</span> <span class="n">model</span><span class="k">:</span> <span class="kt">MatrixFactorizationModel</span> <span class="o">=</span> <span class="nc">ALS</span><span class="o">.</span><span class="n">train</span><span class="o">(</span><span class="n">ratings</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mf">0.01</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Building <code>RDD[Rating]</code> from server stream</h3>

<p>Imagine that we have a continuous flow of training data that can be very long.</p>

<p>We want to train the model with just a slice of this flow. To do this, we can:</p>

<ul>
<li><code>dstreamize</code> the server output stream</li>
<li>run the dstream for some time</li>
<li>retrieve the <code>RDD</code>s received during this time</li>
<li>union all of those <code>RDD</code>s</li>
<li>push them to the model</li>
</ul>


<p>Here is the whole code with previous client:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">trainingAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11100</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServer</span><span class="o">,</span> <span class="n">trainingStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING CLIENT</span>
</span><span class='line'><span class="k">val</span> <span class="n">tclient</span> <span class="k">=</span> <span class="n">trainingClient</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// DStreamize server received data</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServerSink</span><span class="o">,</span> <span class="n">trainingDstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span>
</span><span class='line'>  <span class="n">trainingServer</span>
</span><span class='line'>      <span class="c1">// converts bytes to String (doesn&#39;t care about encoding, it shall be UTF8)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span>  <span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="c1">// rechunk received strings based on a separator \n </span>
</span><span class='line'>      <span class="c1">// to keep only triplets: &quot;USER_ID,PROD_ID,RATING&quot;</span>
</span><span class='line'>      <span class="o">.</span><span class="n">pipe</span> <span class="o">(</span><span class="nc">NioUtils</span><span class="o">.</span><span class="n">rechunk</span> <span class="o">{</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">toVector</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">,</span> <span class="n">ssc</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// Prepare dstream output </span>
</span><span class='line'><span class="c1">// (here we print to know what has been received)</span>
</span><span class='line'><span class="n">trainingDstream</span><span class="o">.</span><span class="n">print</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// RUN</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Note the time before</span>
</span><span class='line'><span class="k">val</span> <span class="n">before</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Time</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start SSC</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch server</span>
</span><span class='line'><span class="n">trainingServerSink</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Sleeps a bit to let server listen</span>
</span><span class='line'><span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launches client and awaits until it ends</span>
</span><span class='line'><span class="n">tclient</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Stop server</span>
</span><span class='line'><span class="n">trainingStop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Note the time after</span>
</span><span class='line'><span class="k">val</span> <span class="n">after</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Time</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// retrieves all dstreamized RDD during this period</span>
</span><span class='line'><span class="k">val</span> <span class="n">rdds</span> <span class="k">=</span> <span class="n">trainingDstream</span><span class="o">.</span><span class="n">slice</span><span class="o">(</span>
</span><span class='line'>  <span class="n">before</span><span class="o">.</span><span class="n">floor</span><span class="o">(</span><span class="nc">Milliseconds</span><span class="o">(</span><span class="mi">1000</span><span class="o">)),</span> <span class="n">after</span><span class="o">.</span><span class="n">floor</span><span class="o">(</span><span class="nc">Milliseconds</span><span class="o">(</span><span class="mi">1000</span><span class="o">))</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// unions them (this operation can be expensive)</span>
</span><span class='line'><span class="k">val</span> <span class="n">union</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UnionRDD</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">,</span> <span class="n">rdds</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// converts &quot;USER_ID,PROD_ID,RATING&quot; triplets into Ratings</span>
</span><span class='line'><span class="k">val</span> <span class="n">ratings</span> <span class="k">=</span> <span class="n">union</span> <span class="n">map</span> <span class="o">{</span> <span class="n">e</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">e</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">item</span><span class="o">,</span> <span class="n">rate</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Rating</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">rate</span><span class="o">.</span><span class="n">toDouble</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// finally train the model with it</span>
</span><span class='line'><span class="k">val</span> <span class="n">model</span> <span class="k">=</span> <span class="nc">ALS</span><span class="o">.</span><span class="n">train</span><span class="o">(</span><span class="n">ratings</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mf">0.01</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Predict</span>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="s">&quot;Prediction(1,3)=&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// Stop SSC</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Run it</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079621000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">2</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079622000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079623000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079624000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395079625000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Prediction</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span><span class="k">=</span><span class="mf">4.94897842056338</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Fantastic, we have trained our model in a very fancy way, haven&#8217;t we?</p>

<p>Personally, I find it interesting that we can take advantage of both APIs&#8230;</p></blockquote>

<br/>


<br/>


<h2>Predict Ratings</h2>

<p>Now that we have a trained model, we can create a new server to receive data from clients for rating prediction.</p>

<br/>


<h3>Prediction client</h3>

<p>Firstly, let&#8217;s generate some random data to send for prediction.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// PREDICTION CLIENT</span>
</span><span class='line'><span class="k">def</span> <span class="n">predictionClient</span><span class="o">(</span><span class="n">addr</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// PREDICTION DATA</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">rndData</span> <span class="k">=</span>
</span><span class='line'>    <span class="c1">// userID</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="n">abs</span><span class="o">(</span><span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="n">toString</span> <span class="o">+</span>
</span><span class='line'>    <span class="c1">// productID</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">Math</span><span class="o">.</span><span class="n">abs</span><span class="o">(</span><span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">)</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="o">).</span><span class="n">toString</span> <span class="o">+</span>
</span><span class='line'>    <span class="s">&quot;\n&quot;</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">rndDataProcess</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">{</span> <span class="n">rndData</span> <span class="o">}).</span><span class="n">repeat</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// a 1000 elements process emitting every 10ms</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">predictDataProcess</span> <span class="k">=</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">Process</span><span class="o">.</span><span class="n">awakeEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span> <span class="n">zipWith</span> <span class="n">rndDataProcess</span><span class="o">){</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">getBytes</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>      <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">client</span> <span class="k">=</span> <span class="nc">NioClient</span><span class="o">.</span><span class="n">sendAndCheckSize</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">predictDataProcess</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">client</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Prediction server</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">predictAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11101</span><span class="o">)</span>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// PREDICTION SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">predictServer</span><span class="o">,</span> <span class="n">predictStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">predictAddr</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Prediction Stream</h3>

<p><code>predictServer</code> is the stream of data to predict. Let&#8217;s stream it to the model by <code>dstreamizing</code> it and transforming all built <code>RDD</code>s by passing them through model</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// DStreamize server</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">predictServerSink</span><span class="o">,</span> <span class="n">predictDstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span>
</span><span class='line'>  <span class="n">predictServer</span>
</span><span class='line'>      <span class="c1">// converts bytes to String (doesn&#39;t care about encoding, it shall be UTF8)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span>  <span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="c1">// rechunk received strings based on a separator \n</span>
</span><span class='line'>      <span class="o">.</span><span class="n">pipe</span> <span class="o">(</span><span class="nc">NioUtils</span><span class="o">.</span><span class="n">rechunk</span> <span class="o">{</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">toVector</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">,</span> <span class="n">ssc</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// pipe dstreamed RDD to prediction model</span>
</span><span class='line'><span class="c1">// and print result</span>
</span><span class='line'><span class="n">predictDstream</span> <span class="n">map</span> <span class="o">{</span> <span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// converts to integers required by the model (USER_ID, PRODUCT_ID)</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">item</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class='line'><span class="o">}}</span> <span class="n">transform</span> <span class="o">{</span> <span class="n">rdd</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// prediction happens here</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="n">rdd</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span> <span class="n">print</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Running all in same <code>StreamingContext</code></h3>

<p>I&#8217;ve discovered a problem here because the recommendation model is built in a <code>StreamingContext</code> and uses <code>RDD</code>s built in it. So you must use the same <code>StreamingContext</code> for prediction. So I must build my training dstreamized client/server &amp; prediction dstreamized client/server in the same context and thus I must schedule both things before starting this context.</p>

<p>Yet the prediction model is built from training data received after starting the context so it&#8217;s not known before&#8230; So it&#8217;s very painful and I decided to be nasty and consider the model as a variable that will be set later. For this, I used a horrible <code>SyncVar</code> to set the prediction model when it&#8217;s ready&#8230; <em>Sorry about that but I need to study more about this issue to see if I can find better solutions because I&#8217;m not satisfied about it at all&#8230;</em></p>

<p>So here is the whole training/predicting painful code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
<span class='line-number'>70</span>
<span class='line-number'>71</span>
<span class='line-number'>72</span>
<span class='line-number'>73</span>
<span class='line-number'>74</span>
<span class='line-number'>75</span>
<span class='line-number'>76</span>
<span class='line-number'>77</span>
<span class='line-number'>78</span>
<span class='line-number'>79</span>
<span class='line-number'>80</span>
<span class='line-number'>81</span>
<span class='line-number'>82</span>
<span class='line-number'>83</span>
<span class='line-number'>84</span>
<span class='line-number'>85</span>
<span class='line-number'>86</span>
<span class='line-number'>87</span>
<span class='line-number'>88</span>
<span class='line-number'>89</span>
<span class='line-number'>90</span>
<span class='line-number'>91</span>
<span class='line-number'>92</span>
<span class='line-number'>93</span>
<span class='line-number'>94</span>
<span class='line-number'>95</span>
<span class='line-number'>96</span>
<span class='line-number'>97</span>
<span class='line-number'>98</span>
<span class='line-number'>99</span>
<span class='line-number'>100</span>
<span class='line-number'>101</span>
<span class='line-number'>102</span>
<span class='line-number'>103</span>
<span class='line-number'>104</span>
<span class='line-number'>105</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// TRAINING</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">trainingAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11100</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TRAINING SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServer</span><span class="o">,</span> <span class="n">trainingStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// TRAINING CLIENT</span>
</span><span class='line'><span class="k">val</span> <span class="n">tclient</span> <span class="k">=</span> <span class="n">trainingClient</span><span class="o">(</span><span class="n">trainingAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// DStreamize server</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">trainingServerSink</span><span class="o">,</span> <span class="n">trainingDstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span>
</span><span class='line'>  <span class="n">trainingServer</span>
</span><span class='line'>      <span class="c1">// converts bytes to String (doesn&#39;t care about encoding, it shall be UTF8)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span>  <span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="c1">// rechunk received strings based on a separator \n</span>
</span><span class='line'>      <span class="o">.</span><span class="n">pipe</span> <span class="o">(</span><span class="nc">NioUtils</span><span class="o">.</span><span class="n">rechunk</span> <span class="o">{</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">toVector</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">,</span> <span class="n">ssc</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// THE HORRIBLE SYNCVAR CLUDGE (could have used atomic but not better IMHO)</span>
</span><span class='line'><span class="k">var</span> <span class="n">model</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SyncVar</span><span class="o">[</span><span class="kt">org.apache.spark.mllib.recommendation.MatrixFactorizationModel</span><span class="o">]</span>
</span><span class='line'><span class="c1">// THE HORRIBLE SYNCVAR CLUDGE (could have used atomic but not better IMHO)</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// PREDICTING</span>
</span><span class='line'><span class="k">val</span> <span class="n">predictAddr</span> <span class="k">=</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">localAddress</span><span class="o">(</span><span class="mi">11101</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// PREDICTION SERVER</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">predictServer</span><span class="o">,</span> <span class="n">predictStop</span><span class="o">)</span> <span class="k">=</span> <span class="n">server</span><span class="o">(</span><span class="n">predictAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// PREDICTION CLIENT</span>
</span><span class='line'><span class="k">val</span> <span class="n">pClient</span> <span class="k">=</span> <span class="n">predictionClient</span><span class="o">(</span><span class="n">predictAddr</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// DStreamize server</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">predictServerSink</span><span class="o">,</span> <span class="n">predictDstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span>
</span><span class='line'>  <span class="n">predictServer</span>
</span><span class='line'>      <span class="c1">// converts bytes to String (doesn&#39;t care about encoding, it shall be UTF8)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span>  <span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="c1">// rechunk received strings based on a separator \n</span>
</span><span class='line'>      <span class="o">.</span><span class="n">pipe</span> <span class="o">(</span> <span class="nc">NioUtils</span><span class="o">.</span><span class="n">rechunk</span> <span class="o">{</span> <span class="n">s</span><span class="k">:</span><span class="kt">String</span> <span class="o">=&gt;</span> <span class="o">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">).</span><span class="n">toVector</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="n">last</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">,</span> <span class="n">ssc</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Piping received data to the model</span>
</span><span class='line'><span class="n">predictDstream</span><span class="o">.</span><span class="n">map</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">item</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">toInt</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}.</span><span class="n">transform</span> <span class="o">{</span> <span class="n">rdd</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// USE THE HORRIBLE SYNCVAR</span>
</span><span class='line'>  <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="n">rdd</span><span class="o">)</span>
</span><span class='line'><span class="o">}.</span><span class="n">print</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// RUN ALL</span>
</span><span class='line'><span class="k">val</span> <span class="n">before</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Time</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start SSC</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch training server</span>
</span><span class='line'><span class="n">trainingServerSink</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Sleeps a bit to let server listen</span>
</span><span class='line'><span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch training client</span>
</span><span class='line'><span class="n">tclient</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Await SSC termination a bit</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">awaitTermination</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'><span class="c1">// Stop training server</span>
</span><span class='line'><span class="n">trainingStop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'><span class="k">val</span> <span class="n">after</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Time</span><span class="o">(</span><span class="nc">System</span><span class="o">.</span><span class="n">currentTimeMillis</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">rdds</span> <span class="k">=</span> <span class="n">trainingDstream</span><span class="o">.</span><span class="n">slice</span><span class="o">(</span><span class="n">before</span><span class="o">.</span><span class="n">floor</span><span class="o">(</span><span class="nc">Milliseconds</span><span class="o">(</span><span class="mi">1000</span><span class="o">)),</span> <span class="n">after</span><span class="o">.</span><span class="n">floor</span><span class="o">(</span><span class="nc">Milliseconds</span><span class="o">(</span><span class="mi">1000</span><span class="o">)))</span>
</span><span class='line'><span class="k">val</span> <span class="n">union</span><span class="k">:</span> <span class="kt">RDD</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">UnionRDD</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">,</span> <span class="n">rdds</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">ratings</span> <span class="k">=</span> <span class="n">union</span> <span class="n">map</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">_</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="sc">&#39;,&#39;</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Array</span><span class="o">(</span><span class="n">user</span><span class="o">,</span> <span class="n">item</span><span class="o">,</span> <span class="n">rate</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Rating</span><span class="o">(</span><span class="n">user</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">item</span><span class="o">.</span><span class="n">toInt</span><span class="o">,</span> <span class="n">rate</span><span class="o">.</span><span class="n">toDouble</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// SET THE HORRIBLE SYNCVAR</span>
</span><span class='line'><span class="n">model</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="nc">ALS</span><span class="o">.</span><span class="n">train</span><span class="o">(</span><span class="n">ratings</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mf">0.01</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="s">&quot;**** Model Trained -&gt; Prediction(1,3)=&quot;</span> <span class="o">+</span> <span class="n">model</span><span class="o">.</span><span class="n">get</span><span class="o">.</span><span class="n">predict</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch prediction server</span>
</span><span class='line'><span class="n">predictServerSink</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Sleeps a bit to let server listen</span>
</span><span class='line'><span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">300</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Launch prediction client</span>
</span><span class='line'><span class="n">pClient</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Await SSC termination a bit</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">awaitTermination</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'><span class="c1">// Stop server</span>
</span><span class='line'><span class="n">predictStop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">).</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Run it&#8230;</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395144379000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">2</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">1.0</span>
</span><span class='line'><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">5.0</span>
</span><span class='line'>
</span><span class='line'><span class="o">****</span> <span class="nc">Model</span> <span class="nc">Trained</span> <span class="o">-&gt;</span> <span class="nc">Prediction</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">)</span><span class="k">=</span><span class="mf">4.919459410565401</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395144384000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="o">----------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395144385000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mf">1.631952450379809</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395144386000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mf">4.919459410565401</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">0.40813133837755494</span><span class="o">)</span>
</span><span class='line'><span class="nc">Rating</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mf">0.40813133837755494</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h2>Final conclusion</h2>

<p>3 long articles to end in training a poor recommendation system with 2 clients/servers&#8230; A bit bloated isn&#8217;t it? :)</p>

<p>Anyway, I hope I printed in your brain a few ideas, concepts about spark &amp; scalaz-stream and if I&#8217;ve reached this target, it&#8217;s already enough!</p>

<p>Yet, I&#8217;m not satisfied about a few things:</p>

<ul>
<li>Training a model and using it in the same <code>StreamingContext</code> is still clumsy and I must say that calling <code>model.predict</code> from a <code>map</code> function in a <code>DStream</code> might not be so good in a cluster environment. I haven&#8217;t been digging this code enough to have a clear mind on it.</li>
<li>I tried using multiple clients for prediction (like 100 in parallel) and it works quite well but I have encountered problems ending both my clients/servers and the streaming context and I often end into having zombies SBT process that I can&#8217;t kill until reboot (some threads remain RUNNING while other AWAITS and sockets aren&#8217;t released&#8230; resources issues&#8230;). Closing cleanly all of these tools creating threads &amp; more after intensive work isn&#8217;t yet good.</li>
</ul>


<p><strong>But, I&#8217;m satisfied globally:</strong></p>

<ul>
<li><strong>Piping a scalaz-stream <code>Process</code> into a spark <code>DStream</code> works quite well and might be interesting after all.</strong></li>
<li><strong>The new scalaz-stream NIO API considering clients &amp; servers as pure streams of data gave me so many ideas that my free-time has suddenly been frightened and went away.</strong></li>
</ul>


<br/>


<br/>


<blockquote><p><a href="/2014/03/09/zpark-ml-nio-2/">GO TO PART2</a> &lt;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-</p></blockquote>

<p>Have a look at the code on <a href="https://github.com/mandubian/zpark-ztream">Github</a>.</p>

<p>Have distributed &amp; resilient yet continuous fun!</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/03/09/zpark-ml-nio-2/">ZPark-Ztream II (Part 2/3): Fancy Spark Streamed Machine-Learning & New Scalaz-Stream NIO API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-09T19:19:00+01:00" pubdate data-updated="true">Mar 9<span>th</span>, 2014</time>
        
         | <a href="/2014/03/09/zpark-ml-nio-2/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h2>Synopsis</h2>

<p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p><a href="/2014-02-13-zpark">Zpark-Zstream I article</a> was a PoC trying to use <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> instead of DStream with <a href="https://spark.incubator.apache.org/">Spark-Streaming</a>. I had deliberately decided not to deal with fault-tolerance &amp; stream graph persistence to keep simple but without it, it was quite useless for real application&#8230;</p></blockquote>

<div class="well">
<p>Here is a tryptic of articles trying to do something <i>concrete</i> with <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> and <a href="https://spark.incubator.apache.org/">Spark</a>.</p>
<p>So, what do I want? I wantttttttt <i>a shrewburyyyyyy</i> and to do the following:</p>
<ol>
<li>Plug Scalaz-Stream Process[Task, T] on Spark DStream[T] (Part 1)</li>
<li><b>Build DStream using brand new Scalaz-Stream NIO API (client/server) (Part 2)</b></li>
<li>Train Spark-ML <i>recommendation-like</i> model using NIO client/server (Part 3)</li>
<li>Stream data from multiple NIO clients to the previous trained ML model mixing all together (Part 3)</li>
</ol>
</div>




<br/>


<h1>[Part 2/3] From Scalaz-Stream NIO client &amp; server to Spark DStream</h1>

<h2>Scalaz-Stream NIO Client</h2>

<h3>What is a client?</h3>

<ul>
<li>Something sending some data <code>W</code> <em>(for Write)</em> to a server</li>
<li>Something reading some data <code>I</code> <em>(for Input)</em> from a server</li>
</ul>


<br/>


<h3>Client seen as <code>Process</code></h3>

<p>A client could be represented as:</p>

<ul>
<li>a <code>Process[Task, I]</code> for input channel (receiving from server)</li>
<li>a <code>Process[Task, W]</code> for output channel (sending to server)</li>
</ul>


<p>In scalaz-stream, recently a new structure has been added :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">final</span> <span class="k">case</span> <span class="k">class</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">](</span><span class="n">read</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">],</span> <span class="n">write</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>Precisely what we need!</p>

<p>Now, let&#8217;s consider that we work in NIO mode with everything non-blocking, asynchronous etc&#8230;</p>

<p>In this context, a client can be seen as something generating <em>soon or later one (or more)</em> <code>Exchange[I, W]</code> i.e :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Client</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]</span> <span class="o">===</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>In the case of a pure TCP client, <code>I</code> and <code>W</code> are often <code>Bytes</code>.</p></blockquote>

<h3>Creating a client</h3>

<p>Scalaz-Stream now provides a helper to create a TCP binary NIO client:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// the address of the server to connect to</span>
</span><span class='line'><span class="k">val</span> <span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">&quot;xxx.yyy.zzz.ttt&quot;</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create a client</span>
</span><span class='line'><span class="k">val</span> <span class="n">client</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]]</span> <span class="k">=</span> <span class="n">nio</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">client</span> <span class="n">map</span> <span class="o">{</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">Exchange</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// read data sent by server in ex.read</span>
</span><span class='line'>  <span class="o">???</span>
</span><span class='line'>  <span class="c1">// write data to the server with ex.write</span>
</span><span class='line'>  <span class="o">???</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Plug your own data source on <code>Exchange</code></h3>

<p>To plug your own data source to write to server, Scalaz-Stream provides 1 more API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">](</span><span class="n">read</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">],</span> <span class="n">write</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Runs supplied Process of `W` values by sending them to remote system.</span>
</span><span class='line'><span class="cm">   * Any replies from remote system are received as `I` values of the resulting process.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">run</span><span class="o">(</span><span class="n">p</span><span class="k">:</span><span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>,<span class="kt">W</span><span class="o">])</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>,<span class="kt">I</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the W are sent to the server and we retrieve only the received data</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this API, we can write data to the client and output received data.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// some data to be sent by client</span>
</span><span class='line'><span class="k">val</span> <span class="n">data</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// send data and retrieve only responses received by client</span>
</span><span class='line'><span class="k">val</span> <span class="n">output</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">]</span> <span class="k">=</span> <span class="n">client</span> <span class="n">flatMap</span> <span class="o">{</span> <span class="n">ex</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">ex</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">data</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">receivedData</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="n">output</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yet, in general, we need to:</p>

<ul>
<li>send custom data to the server</li>
<li>expect its response</li>
<li>do some business logic</li>
<li>send more data</li>
<li>etc&#8230;</li>
</ul>


<p>So we need to be able to gather in the same piece of code received &amp; emitted data.</p>

<br/>


<h3>Managing client/server business logic with <code>Wye</code></h3>

<p>Scalaz-stream can help us with the following API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">](</span><span class="n">read</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">],</span> <span class="n">write</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Transform this Exchange to another Exchange where queueing, and transformation of this `I` and `W`</span>
</span><span class='line'><span class="cm">   * is controlled by supplied WyeW.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">wye</span><span class="o">(</span><span class="n">w</span><span class="k">:</span> <span class="kt">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">])</span><span class="k">:</span> <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I2</span>, <span class="kt">W2</span><span class="o">]</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// It transforms the original Exchange[I, W] into a Exchange[I2, W2]</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Whoaaaaa complex isn&#8217;t it? Actually not so much&#8230;</p></blockquote>

<p><code>Wye</code> is a fantastic tool that can:</p>

<ul>
<li>read from a left and/or right branch (in a non-deterministic way: left or right or left+right),</li>
<li>perform computation on left/right received data,</li>
<li>emit data in output.</li>
</ul>


<p>I love ASCII art schema:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="nc">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">I2</span>, <span class="kt">W</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">I</span><span class="o">(</span><span class="n">left</span><span class="o">)</span>       <span class="n">I2</span><span class="o">(</span><span class="n">right</span><span class="o">)</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'><span class="o">|</span>    <span class="nc">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">I2</span>, <span class="kt">W</span><span class="o">]</span>    <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>              <span class="n">v</span>
</span><span class='line'>              <span class="n">W</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>\/</code> is ScalaZ disjunction also called `Either in the Scala world.</p>

<p>So <code>Wye[Task, I, W2, W \/ I2]</code> can be seen as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="nc">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>          <span class="n">I</span>       <span class="n">W2</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'><span class="o">|</span> <span class="nc">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span> <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="n">W</span>       <span class="n">I2</span>
</span></code></pre></td></tr></table></div></figure>


<h4>So what does this <code>Exchange.wye</code> API do?</h4>

<ul>
<li>It plugs the original <code>Exchange.write: Sink[Task, W]</code> to the <code>W</code> output of the <code>Wye[Task, I, W2, W \/ I2]</code> for sending data to the server.</li>
<li>It plugs the <code>Exchange.read: Process[Task, I]</code> receiving data from server to the left input of the <code>Wye[Task, I, W2, W]</code>.</li>
<li>The right intput <code>W2</code> branch provides a plug for an external source of data in the shape of <code>Process[Task, W2]</code>.</li>
<li>The right output <code>I2</code> can be used to pipe data from the client to an external local process (like streaming out data received from the server).</li>
<li>Finally it returns an <code>Exchange[I2, W2]</code>.</li>
</ul>


<p>In a summary:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="o">(</span><span class="n">ex</span><span class="k">:</span><span class="kt">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]).</span><span class="n">wye</span><span class="o">(</span> <span class="n">w</span><span class="k">:</span><span class="kt">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="n">ex</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>          <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>
</span><span class='line'>          <span class="n">I</span>       <span class="n">W2</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'> <span class="o">-----------------------------</span>
</span><span class='line'><span class="o">|</span> <span class="n">w</span><span class="k">:</span><span class="kt">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span>, <span class="kt">W2</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span> <span class="o">|</span>
</span><span class='line'> <span class="o">-----------------------------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="n">W</span>       <span class="n">I2</span>
</span><span class='line'>          <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>
</span><span class='line'>      <span class="n">ex</span><span class="o">.</span><span class="n">write</span>
</span><span class='line'>
</span><span class='line'><span class="o">======&gt;</span> <span class="nc">Returns</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I2</span>, <span class="kt">W2</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>As a conclusion, <code>Exchange.wye</code> <em>combines</em> the original <code>Exchange[I, W]</code> with your custom <code>Wye[Task, I, W2, W \/ I2]</code> which <strong>represents the business logic of data exchange between client &amp; server</strong> and finally returns a <code>Exchange[I2, W2]</code> on which you can plug your own data source and retrieve output data.</p></blockquote>

<br/>


<h4>Implement the client with <code>wye/run</code></h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// The source of data to send to server</span>
</span><span class='line'><span class="k">val</span> <span class="n">data2Send</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The logic of your exchange between client &amp; server</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientWye</span><span class="k">:</span> <span class="kt">Wye</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span> <span class="kt">\/</span> <span class="kt">Bytes</span><span class="o">])</span><span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="c1">// Scary, there are so many Bytes</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">clientReceived</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// client connects to the server &amp; returns Exchange</span>
</span><span class='line'>  <span class="n">ex</span>   <span class="k">&lt;-</span> <span class="n">nio</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Exchange is customized with clientWye</span>
</span><span class='line'>  <span class="c1">// Data are injected in it with run</span>
</span><span class='line'>  <span class="n">output</span> <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">wye</span><span class="o">(</span><span class="n">clientWye</span><span class="o">).</span><span class="n">run</span><span class="o">(</span><span class="n">data2Send</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span> <span class="k">yield</span> <span class="o">(</span><span class="n">output</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h4>Implement simple client/server business logic?</h4>

<blockquote><p>Please note, I simply reuse the basic <code>echo</code> example provided in scalaz-stream ;)</p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">clientEcho</span><span class="o">(</span><span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">,</span> <span class="n">data</span><span class="k">:</span> <span class="kt">Bytes</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the custom Wye managing business logic</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">echoLogic</span><span class="k">:</span> <span class="kt">Wye</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Byte</span> <span class="kt">\/</span> <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">def</span> <span class="n">go</span><span class="o">(</span><span class="n">collected</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">WyeW</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// Create a Wye that can receive on both sides</span>
</span><span class='line'>      <span class="n">receiveBoth</span> <span class="o">{</span>
</span><span class='line'>        <span class="c1">// Receive on left == receive from server</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">ReceiveL</span><span class="o">(</span><span class="n">rcvd</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="c1">// `emitO` outputs on `I2` branch and then...</span>
</span><span class='line'>          <span class="n">emitO</span><span class="o">(</span><span class="n">rcvd</span><span class="o">)</span> <span class="n">fby</span>
</span><span class='line'>            <span class="c1">// if we have received everything sent, halt</span>
</span><span class='line'>            <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="n">collected</span> <span class="o">+</span> <span class="n">rcvd</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">data</span><span class="o">.</span><span class="n">size</span><span class="o">)</span> <span class="n">halt</span>
</span><span class='line'>            <span class="c1">// else go on collecting</span>
</span><span class='line'>            <span class="k">else</span> <span class="n">go</span><span class="o">(</span><span class="n">collected</span> <span class="o">+</span> <span class="n">rcvd</span><span class="o">.</span><span class="n">size</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// Receive on right == receive on `W2` branch == your external data source</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">ReceiveR</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="c1">// `emitW` outputs on `W` branch == sending to server</span>
</span><span class='line'>          <span class="c1">// and loops</span>
</span><span class='line'>          <span class="n">emitW</span><span class="o">(</span><span class="n">data</span><span class="o">)</span> <span class="n">fby</span> <span class="n">go</span><span class="o">(</span><span class="n">collected</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>        <span class="c1">// When server closes</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">HaltL</span><span class="o">(</span><span class="n">rsn</span><span class="o">)</span>     <span class="k">=&gt;</span> <span class="nc">Halt</span><span class="o">(</span><span class="n">rsn</span><span class="o">)</span>
</span><span class='line'>        <span class="c1">// When client closes, we go on collecting echoes</span>
</span><span class='line'>        <span class="k">case</span> <span class="nc">HaltR</span><span class="o">(</span><span class="k">_</span><span class="o">)</span>       <span class="k">=&gt;</span> <span class="n">go</span><span class="o">(</span><span class="n">collected</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Init</span>
</span><span class='line'>    <span class="n">go</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Finally wiring all...</span>
</span><span class='line'>  <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">ex</span>   <span class="k">&lt;-</span> <span class="n">nio</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>    <span class="n">rslt</span> <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">wye</span><span class="o">(</span><span class="n">echoSent</span><span class="o">).</span><span class="n">run</span><span class="o">(</span><span class="n">emit</span><span class="o">(</span><span class="n">data</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span> <span class="k">yield</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">rslt</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>This might seem hard to catch to some people because of scalaz-stream notations and wye <code>Left/Right/Both</code> or <code>wye.emitO/emitW</code>. But actually, you&#8217;ll get used to it quite quickly as soon as you understand <code>wye</code>. Keep in mind that this code uses low-level scalaz-stream API without anything else and it remains pretty simple and straighforward.</p></blockquote>

<br/>


<h4>Run the client for its output</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// create a client that sends 1024 random bytes</span>
</span><span class='line'><span class="k">val</span> <span class="n">dataArray</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">.</span><span class="n">fill</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="mi">1024</span><span class="o">)(</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextBytes</span><span class="o">(</span><span class="n">dataArray</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientOutput</span> <span class="k">=</span> <span class="n">clientEcho</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">dataArray</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// consumes all received data... (it should contain dataArray)</span>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">clientOutput</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="s">&quot;Client received:&quot;</span><span class="o">+</span><span class="n">result</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It would give something like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Client</span> <span class="n">received</span><span class="k">:</span><span class="kt">Vector</span><span class="o">(</span><span class="kt">Bytes1:</span> <span class="kt">pos</span><span class="o">=</span><span class="err">0</span><span class="o">,</span> <span class="n">length</span><span class="k">=</span><span class="mi">1024</span><span class="o">,</span> <span class="n">src</span><span class="k">:</span> <span class="o">(</span><span class="kt">-</span><span class="err">12</span><span class="o">,</span><span class="err">28</span><span class="o">,</span><span class="mi">55</span><span class="o">,-</span><span class="mi">124</span><span class="o">,</span><span class="mi">3</span><span class="o">,-</span><span class="mi">54</span><span class="o">,-</span><span class="mi">53</span><span class="o">,</span><span class="mi">66</span><span class="o">,-</span><span class="mi">115</span><span class="o">,</span><span class="mf">17.</span><span class="o">..)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<blockquote><p>Now, you know about scalaz-stream clients, what about servers???</p></blockquote>

<br/>


<br/>


<h2>Scalaz-stream NIO Server</h2>

<p>Let&#8217;s start again :D</p>

<h3>What is a server?</h3>

<ul>
<li>Something listening for client(s) connection</li>
<li>When there is a client connected, the server can :

<ul>
<li>Receive data <code>I</code> <em>(for Input)</em> from the client</li>
<li>Send data <code>W</code> <em>(for Write)</em> to the client</li>
</ul>
</li>
<li>A server can manage multiple clients in parallel</li>
</ul>


<br/>


<h3>Server seen as <code>Process</code></h3>

<p>Remember that a client was defined above as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Client</span> <span class="o">===</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>In our NIO, non-blocking, streaming world, a server can be considered as a stream of clients right?</p>

<p>So finally, we can model a server as :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Server</span> <span class="o">===</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Client</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]]</span>
</span><span class='line'>       <span class="o">===</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">]]]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Whoooohoooo, a server is just a stream of streams!!!!</p></blockquote>

<br/>


<h3>Writing a server</h3>

<p>Scalaz-Stream now provides a helper to create a TCP binary NIO server:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// the address of the server</span>
</span><span class='line'><span class="k">val</span> <span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">&quot;xxx.yyy.zzz.ttt&quot;</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create a server</span>
</span><span class='line'><span class="k">val</span> <span class="n">server</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Exchange</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]]]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">nio</span><span class="o">.</span><span class="n">server</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">server</span> <span class="n">map</span> <span class="o">{</span> <span class="n">client</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// for each client</span>
</span><span class='line'>  <span class="n">client</span> <span class="n">flatMap</span> <span class="o">{</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">Exchange</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="c1">// read data sent by client in ex.read</span>
</span><span class='line'>    <span class="o">???</span>
</span><span class='line'>    <span class="c1">// write data to the client with ex.write</span>
</span><span class='line'>    <span class="o">???</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Don&#8217;t you find that quite elegant? ;)</p></blockquote>

<br/>


<h3>Managing client/server interaction business logic</h3>

<p>There we simply re-use the <code>Exchange</code> described above so you can use exactly the same API than the ones for client. Here is another API that can be useful:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">type</span> <span class="kt">Writes1</span><span class="o">[</span><span class="kt">W</span>, <span class="kt">I</span>, <span class="kt">I2</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span> <span class="kt">\/</span> <span class="kt">I2</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">W</span><span class="o">](</span><span class="n">read</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">],</span> <span class="n">write</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">W</span><span class="o">])</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Transforms this exchange to another exchange, that for every received `I` will consult supplied Writer1</span>
</span><span class='line'><span class="cm">   * and eventually transforms `I` to `I2` or to `W` that is sent to remote system.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">readThrough</span><span class="o">[</span><span class="kt">I2</span><span class="o">](</span><span class="n">w</span><span class="k">:</span> <span class="kt">Writer1</span><span class="o">[</span><span class="kt">W</span>, <span class="kt">I</span>, <span class="kt">I2</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Strategy</span> <span class="o">=</span> <span class="nc">Strategy</span><span class="o">.</span><span class="nc">DefaultStrategy</span><span class="o">)</span> <span class="k">:</span> <span class="kt">Exchange</span><span class="o">[</span><span class="kt">I2</span>,<span class="kt">W</span><span class="o">]</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A small schema?</span>
</span><span class='line'>            <span class="n">ex</span><span class="o">.</span><span class="n">read</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>              <span class="n">v</span>
</span><span class='line'>              <span class="n">I</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'><span class="o">|</span>    <span class="nc">Writer1</span><span class="o">[</span><span class="kt">W</span>, <span class="kt">I</span>, <span class="kt">I2</span><span class="o">]</span>      <span class="o">|</span>
</span><span class='line'> <span class="o">---------------------------</span>
</span><span class='line'>              <span class="o">|</span>
</span><span class='line'>          <span class="o">---------</span>
</span><span class='line'>          <span class="o">|</span>       <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>       <span class="n">v</span>
</span><span class='line'>          <span class="n">W</span>       <span class="n">I2</span>
</span><span class='line'>          <span class="o">|</span>
</span><span class='line'>          <span class="n">v</span>
</span><span class='line'>       <span class="n">ex</span><span class="o">.</span><span class="n">write</span>
</span><span class='line'>
</span><span class='line'><span class="o">======&gt;</span> <span class="nc">Returns</span> <span class="nc">Exchange</span><span class="o">[</span><span class="kt">I2</span>, <span class="kt">W</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>With this API, you can compute some business logic on the received data from client.</p>

<p>Let&#8217;s write the echo server corresponding to the previous client (<em>you can find this sample in scalaz-stream too</em>):</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">serverEcho</span><span class="o">(</span><span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// This is a Writer1 that echoes everything it receives to the client and emits it locally</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">echoAll</span><span class="k">:</span> <span class="kt">Writer1</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">receive1</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span> <span class="kt">\/</span> <span class="kt">Bytes</span><span class="o">]</span> <span class="o">{</span> <span class="n">i</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="c1">// echoes on left, emits on right and then loop (fby = followed by)</span>
</span><span class='line'>      <span class="n">emitSeq</span><span class="o">(</span> <span class="nc">Seq</span><span class="o">(\/-(</span><span class="n">i</span><span class="o">),</span> <span class="o">-\/(</span><span class="n">i</span><span class="o">))</span> <span class="o">)</span> <span class="n">fby</span> <span class="n">echoAll</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The server that echoes everything</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">receivedData</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">client</span> <span class="k">&lt;-</span> <span class="n">nio</span><span class="o">.</span><span class="n">server</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>      <span class="n">rcv</span>    <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">readThrough</span><span class="o">(</span><span class="n">echoAll</span><span class="o">).</span><span class="n">run</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">yield</span> <span class="n">rcv</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">receivedData</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>receivedData</code> is <code>Process[Task, Process[Task, Bytes]]</code> which is not so practical: we would prefer to gather all data received by clients in 1 single <code>Process[Task, Bytes]</code> to stream it to another module.</p>

<p>Scalaz-Stream has the solution again:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">object</span> <span class="n">merge</span> <span class="o">{</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Merges non-deterministically processes that are output of the `source` process.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">mergeN</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">source</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">A</span><span class="o">]])</span>
</span><span class='line'>    <span class="o">(</span><span class="k">implicit</span> <span class="n">S</span><span class="k">:</span> <span class="kt">Strategy</span> <span class="o">=</span> <span class="nc">Strategy</span><span class="o">.</span><span class="nc">DefaultStrategy</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">A</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note the Strategy which corresponds to the way Tasks will be executed and that can be compared to Scala <code>ExecutionContext</code>.</p></blockquote>

<p>Fantastic, let&#8217;s plug it on our server:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// The server that echoes everything</span>
</span><span class='line'><span class="k">def</span> <span class="n">serverEcho</span><span class="o">(</span><span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// This is a Writer1 that echoes everything it receives to the client and emits it locally</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">echoAll</span><span class="k">:</span> <span class="kt">Writer1</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="n">receive1</span><span class="o">[</span><span class="kt">Bytes</span>, <span class="kt">Bytes</span> <span class="kt">\/</span> <span class="kt">Bytes</span><span class="o">]</span> <span class="o">{</span> <span class="n">i</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="c1">// echoes on left, emits on right and then loop (fby = followed by)</span>
</span><span class='line'>      <span class="n">emitSeq</span><span class="o">(</span> <span class="nc">Seq</span><span class="o">(\/-(</span><span class="n">i</span><span class="o">),</span> <span class="o">-\/(</span><span class="n">i</span><span class="o">))</span> <span class="o">)</span> <span class="n">fby</span> <span class="n">echoAll</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// The server that echoes everything</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">receivedData</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]]</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">for</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">client</span> <span class="k">&lt;-</span> <span class="n">nio</span><span class="o">.</span><span class="n">server</span><span class="o">(</span><span class="n">address</span><span class="o">)</span>
</span><span class='line'>      <span class="n">rcv</span>    <span class="k">&lt;-</span> <span class="n">ex</span><span class="o">.</span><span class="n">readThrough</span><span class="o">(</span><span class="n">echoAll</span><span class="o">).</span><span class="n">run</span><span class="o">()</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">yield</span> <span class="n">rcv</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Merges all client streams</span>
</span><span class='line'>  <span class="n">merge</span><span class="o">.</span><span class="n">mergeN</span><span class="o">(</span><span class="n">receivedData</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Finally, we have a server and a client!!!!!</p>

<p>Let&#8217;s plug them all together</p></blockquote>

<h2>Run a server</h2>

<p>First of all, we need to create a server that can be stopped when required.</p>

<p>Let&#8217;s do in the scalaz-stream way using:</p>

<ul>
<li><code>wye.interrupt</code> :</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Let through the right branch as long as the left branch is `false`,</span>
</span><span class='line'><span class="cm">   * listening asynchronously for the left branch to become `true`.</span>
</span><span class='line'><span class="cm">   * This halts as soon as the right branch halts.</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">interrupt</span><span class="o">[</span><span class="kt">I</span><span class="o">]</span><span class="k">:</span> <span class="kt">Wye</span><span class="o">[</span><span class="kt">Boolean</span>, <span class="kt">I</span>, <span class="kt">I</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>async.signal</code> which is a value that can be changed asynchronously based on 2 APIs:</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Sets the value of this `Signal`. </span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">set</span><span class="o">(</span><span class="n">a</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Returns the discrete version of this signal, updated only when `value`</span>
</span><span class='line'><span class="cm">   * is changed ...</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">discrete</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">A</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without lots of imagination, we can use a <code>Signal[Boolean].discrete</code> to obtain a <code>Process[Task, Boolean]</code> and wye it with previous server process using <code>wye.interrupt</code>. Then, to stop server, you just have to call:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">signal</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the full code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// local bind address</span>
</span><span class='line'><span class="k">val</span> <span class="n">addr</span> <span class="k">=</span> <span class="n">localAddress</span><span class="o">(</span><span class="mi">12345</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The stop signal initialized to false</span>
</span><span class='line'><span class="k">val</span> <span class="n">stop</span> <span class="k">=</span> <span class="n">async</span><span class="o">.</span><span class="n">signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the server controlled by the previous signal</span>
</span><span class='line'><span class="k">val</span> <span class="n">stoppableServer</span> <span class="k">=</span> <span class="o">(</span><span class="n">stop</span><span class="o">.</span><span class="n">discrete</span> <span class="n">wye</span> <span class="n">echoServer</span><span class="o">(</span><span class="n">addr</span><span class="o">))(</span><span class="n">wye</span><span class="o">.</span><span class="n">interrupt</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run server in async without taking care of output data</span>
</span><span class='line'><span class="n">stopServer</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">())</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// DO OTHER THINGS</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stop server</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Run server &amp; client in the same code</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// local bind address</span>
</span><span class='line'><span class="k">val</span> <span class="n">addr</span> <span class="k">=</span> <span class="n">localAddress</span><span class="o">(</span><span class="mi">12345</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// the stop signal initialized to false</span>
</span><span class='line'><span class="k">val</span> <span class="n">stop</span> <span class="k">=</span> <span class="n">async</span><span class="o">.</span><span class="n">signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the server controlled by the previous signal</span>
</span><span class='line'><span class="k">val</span> <span class="n">stoppableServer</span> <span class="k">=</span> <span class="o">(</span><span class="n">stop</span><span class="o">.</span><span class="n">discrete</span> <span class="n">wye</span> <span class="n">serverEcho</span><span class="o">(</span><span class="n">addr</span><span class="o">))(</span><span class="n">wye</span><span class="o">.</span><span class="n">interrupt</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run server in async without taking care of output data</span>
</span><span class='line'><span class="n">stoppableServer</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">())</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create a client that sends 1024 random bytes</span>
</span><span class='line'><span class="k">val</span> <span class="n">dataArray</span> <span class="k">=</span> <span class="nc">Array</span><span class="o">.</span><span class="n">fill</span><span class="o">[</span><span class="kt">Byte</span><span class="o">](</span><span class="mi">1024</span><span class="o">)(</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextBytes</span><span class="o">(</span><span class="n">dataArray</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientOutput</span> <span class="k">=</span> <span class="n">clientEcho</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">dataArray</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Consume all received data in a blocking way...</span>
</span><span class='line'><span class="k">val</span> <span class="n">result</span> <span class="k">=</span> <span class="n">clientOutput</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stop server</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Naturally you rarely run the client &amp; server in the same code but this is funny to see our easily you can do that with scalaz-stream as you just manipulate <code>Process</code> run on provided <code>Strategy</code></p></blockquote>

<br/>


<blockquote><p>Finally, we can go back to our subject: <strong>feeding a <code>DStream</code> using a scalaz-stream NIO client/server</strong></p></blockquote>

<h2>Pipe server output to DStream</h2>

<p><code>clientEcho/serverEcho</code> are simple samples but not very useful.</p>

<p>Now we are going to use a custom client/server I&#8217;ve written for this article:</p>

<ul>
<li><code>NioClient.sendAndCheckSize</code> is a client streaming all emitted data of a <code>Process[Task, Bytes]</code> to the server and checking that the global size has been ack&#8217;ed by server.</li>
<li><code>NioServer.ackSize</code> is a server acknowledging all received packets by their size (as a 4-bytes Int)</li>
</ul>


<p>Now let&#8217;s write a client/server dstreamizing data to Spark:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// First create a streaming context</span>
</span><span class='line'><span class="k">val</span> <span class="n">ssc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingContext</span><span class="o">(</span><span class="n">clusterUrl</span><span class="o">,</span> <span class="s">&quot;SparkStreamStuff&quot;</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Local bind address</span>
</span><span class='line'><span class="k">val</span> <span class="n">addr</span> <span class="k">=</span> <span class="n">localAddress</span><span class="o">(</span><span class="mi">12345</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The stop signal initialized to false</span>
</span><span class='line'><span class="k">val</span> <span class="n">stop</span> <span class="k">=</span> <span class="n">async</span><span class="o">.</span><span class="n">signal</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">false</span><span class="o">).</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create the server controlled by the previous signal</span>
</span><span class='line'><span class="k">val</span> <span class="n">stoppableServer</span> <span class="k">=</span> <span class="o">(</span><span class="n">stop</span><span class="o">.</span><span class="n">discrete</span> <span class="n">wye</span> <span class="nc">NioServer</span><span class="o">.</span><span class="n">ackSize</span><span class="o">(</span><span class="n">addr</span><span class="o">))(</span><span class="n">wye</span><span class="o">.</span><span class="n">interrupt</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create a client that sends a natural integer every 50ms as a string (until reaching 100)</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientData</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Bytes</span><span class="o">]</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">50</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="nc">Bytes</span><span class="o">.</span><span class="n">of</span><span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="n">toString</span><span class="o">.</span><span class="n">getBytes</span><span class="o">))</span>
</span><span class='line'><span class="k">val</span> <span class="n">clientOutput</span> <span class="k">=</span> <span class="nc">NioClient</span><span class="o">.</span><span class="n">sendAndCheckSize</span><span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">clientData</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Dstreamize the server into the streaming context</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">dstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span><span class="n">stoppableServer</span><span class="o">,</span> <span class="n">ssc</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Prepare dstream output</span>
</span><span class='line'><span class="n">dstream</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">bytes</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">bytes</span><span class="o">.</span><span class="n">toArray</span><span class="o">)</span> <span class="o">).</span><span class="n">print</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start the streaming context</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run the server just for its effects</span>
</span><span class='line'><span class="n">consumer</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">runAsync</span><span class="o">(</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="o">()</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run the client in a blocking way</span>
</span><span class='line'><span class="n">clientOutput</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Await SSC termination a bit</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">awaitTermination</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stop server</span>
</span><span class='line'><span class="n">stop</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stop the streaming context</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>When run, it prints :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395049304000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395049305000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">0</span>
</span><span class='line'><span class="mi">1</span>
</span><span class='line'><span class="mi">2</span>
</span><span class='line'><span class="mi">3</span>
</span><span class='line'><span class="mi">4</span>
</span><span class='line'><span class="mi">5</span>
</span><span class='line'><span class="mi">6</span>
</span><span class='line'><span class="mi">7</span>
</span><span class='line'><span class="mi">8</span>
</span><span class='line'><span class="mi">9</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1395049306000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">20</span>
</span><span class='line'><span class="mi">21</span>
</span><span class='line'><span class="mi">22</span>
</span><span class='line'><span class="mi">23</span>
</span><span class='line'><span class="mi">24</span>
</span><span class='line'><span class="mi">25</span>
</span><span class='line'><span class="mi">26</span>
</span><span class='line'><span class="mi">27</span>
</span><span class='line'><span class="mi">28</span>
</span><span class='line'><span class="mi">29</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Until 100&#8230;</p>

<br/>


<br/>


<h2>Part2&#8217;s conclusion</h2>

<p>I spent this second part of my tryptic mainly explaining a few concepts of the new scalaz-stream brand new NIO API. With it, a client becomes just a stream of exchanges <code>Process[Task, Exchange[I, W]]</code> and a server becomes a stream of stream of exchanges <code>Process[Task, Process[Task, Exchange[I, W]]]</code>.</p>

<p>As soon as you manipulate <code>Process</code>, you can then use the <code>dstreamize</code> API exposed in <a href="/2014/03/08/zpark-ml-nio-1/">Part 1</a> to pipe streamed data into Spark.</p>

<p><strong>Let&#8217;s go to <a href="/2014/03/10/zpark-ml-nio-3/">Part 3</a> now in which we&#8217;re going to do some fancy Machine Learning training with these new tools.</strong></p>

<br/>


<br/>


<blockquote><p><a href="/2014/03/08/zpark-ml-nio-1/">GO TO PART1</a> &lt; &#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211;> <a href="/2014/03/10/zpark-ml-nio-3/">GO TO PART3</a></p></blockquote>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/03/08/zpark-ml-nio-1/">ZPark-Ztream II (Part 1/3): Fancy Spark Streamed Machine-Learning & New Scalaz-Stream NIO API</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-03-08T19:19:00+01:00" pubdate data-updated="true">Mar 8<span>th</span>, 2014</time>
        
         | <a href="/2014/03/08/zpark-ml-nio-1/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><br/>


<h2>Synopsis</h2>

<p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p><a href="/2014/02/13/zpark/">Zpark-Zstream I article</a> was a PoC trying to use <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> instead of DStream with <a href="https://spark.incubator.apache.org/">Spark-Streaming</a>. I had deliberately decided not to deal with fault-tolerance &amp; stream graph persistence to keep simple but without it, it was quite useless for real application&#8230;</p></blockquote>

<div class="well">
<p>Here is a tryptic of articles trying to do something <i>concrete</i> with <a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> and <a href="https://spark.incubator.apache.org/">Spark</a>.</p>
<p>So, what do I want? I wantttttttt <i>a shrewburyyyyyy</i> and to do the following:</p>
<ol>
<li><b>Plug Scalaz-Stream Process[Task, T] on Spark DStream[T] (Part 1)</b></li>
<li>Build DStream using brand new Scalaz-Stream NIO API (client/server) (Part 2)</li>
<li>Train Spark-ML <i>recommendation-like</i> model using NIO client/server (Part 3)</li>
<li>Stream data from multiple NIO clients to the previous trained ML model mixing all together (Part 3)</li>
</ol>
</div>


<h1>[Part 1/3] From Scalaz-Stream Process to Spark DStream</h1>

<br/>


<br/>


<h2>Reminders on Process[Task, T]</h2>

<p>Scalaz-stream <code>Process[Task, T]</code> is a stream of <code>T</code> elements that can interleave some <code>Task</code>s (representing an external something doing somewhat). <code>Process[Task, T]</code> is built as a state machine that you need to run to process all <code>Task</code> effects and emit a stream of <code>T</code>. This can manage both continuous or discrete, finite or infinite streams.</p>

<blockquote><p>I restricted to <code>Task</code> for the purpose of this article but it can be any <code>F[_]</code>.</p></blockquote>

<br/>


<h2>Reminders on DStream[T]</h2>

<p>Spark <code>DStream[T]</code> is a stream of <code>RDD[T]</code> built by discretizing a continuous stream of <code>T</code>. <code>RDD[T]</code> is a <em>resilient distributed dataset</em> which is the ground data-structure behind Spark for distributing in-memory batch/map/reduce operations to a cluster of nodes with fault-tolerance &amp; persistence.</p>

<p>In a summary, <code>DStream</code> <em>slices</em> a continuous stream of <code>T</code> by windows of time and gathers all <code>T</code>s in the same window into one <code>RDD[T]</code>. So it discretizes the continuous stream into a stream of <code>RDD[T]</code>. Once built, those <code>RDD[T]</code>s are distributed to Spark cluster. Spark allows to perform transform/union/map/reduce/&#8230; operations on <code>RDD[T]</code>s. Therefore <code>DStream[T]</code> takes advantage if the same operations.</p>

<p>Spark-Streaming also persists all operations &amp; relations between <code>DStream</code>s in a graph. Thus, in case of fault in a remote node while performing operations on <code>DStream</code>s, the whole transformation can be replayed (<em>it also means streamed data are also persisted</em>).</p>

<p>Finally, the resulting <code>DStream</code> obtained after map/reduce operations can be <em>output</em> to a file, a console, a DB etc&#8230;</p>

<blockquote><p>Please note that <code>DStream[T]</code> is built with respect to a <code>StreamingContext</code> which manages its distribution in Spark cluster and all operations performed on it. Moreover, <code>DStream</code> map/reduce operations &amp; output must be scheduled before starting the <code>StreamingContext</code>. It could be somewhat compared to a state machine that you build statically and run later.</p></blockquote>

<br/>


<h2>From Process[Task, T] to RDD[T]</h2>

<blockquote><p>You may ask why not simply build a <code>RDD[T]</code> from a <code>Process[Task, T]</code> ?</p></blockquote>

<p>Yes sure we can do it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Initialize Spark Context</span>
</span><span class='line'><span class="k">implicit</span> <span class="n">scc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkContext</span><span class="o">(...)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Build a process</span>
</span><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run the process using `runLog` to aggregate all results</span>
</span><span class='line'><span class="c1">// and build a RDD using spark context parallelization</span>
</span><span class='line'><span class="k">val</span> <span class="n">rdd</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">runLog</span><span class="o">.</span><span class="n">run</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>This works but what if this <code>Process[Task, T]</code> emits huge quantity of data or is infinite?
You&#8217;ll end in a <code>OutOfMemoryException</code>&#8230;</p>

<p>So yes you can do it but it&#8217;s not so interesting. <code>DStream</code> seems more natural since it can manage stream of data as long as it can discretize it over time.</p>

<br/>


<br/>


<h2>From Process[Task, T] to DStream[T]</h2>

<br/>


<h3>Pull from <code>Process[Task, T]</code>, Push to <code>DStream[T]</code> with <code>LocalInputDStream</code></h3>

<p>To build a <code>DStream[T]</code> from a <code>Process[Task, T]</code>, the idea is to:</p>

<ul>
<li>Consume/pull the <code>T</code> emitted by <code>Process[Task, O]</code>,</li>
<li>Gather emitted <code>T</code> during a window of time &amp; generate a <code>RDD[T]</code> with them,</li>
<li>Inject <code>RDD[T]</code> into the <code>DStream[T]</code>,</li>
<li>Go to next window of time&#8230;</li>
</ul>


<p>Spark-Streaming library provides different helpers to create <code>DStream</code> from different sources of data like files (local/HDFS), from sockets&#8230;</p>

<p>The helper that seemed the most appropriate is the <code>NetworkInputDStream</code>:</p>

<ul>
<li>It provides a <code>NetworkReceiver</code> based on a Akka actor to which we can push streamed data.</li>
<li><code>NetworkReceiver</code> gathers streamed data over windows of time and builds a <code>BlockRDD[T]</code> for each window.</li>
<li>Each <code>BlockRDD[T]</code> is registered to the global Spark <code>BlockManager</code> (responsible for data persistence).</li>
<li><code>BlockRDD[T]</code> is injected into the <code>DStream[T]</code>.</li>
</ul>


<p>So basically, <code>NetworkInputDStream</code> builds a stream of <code>BlockRDD[T]</code>.
It&#8217;s important to note that <code>NetworkReceiver</code> is also meant to be sent to remote workers so that data can be gathered on several nodes at the same time.</p>

<p>But in my case, the data source <code>Process[Task, T]</code> run on the Spark driver node (at least for now) so instead of <code>NetworkInputDStream</code>, a <code>LocalInputDStream</code> would be better. It would provide a <code>LocalReceiver</code> based on an actor to which we can push the data emitted by the process in an async way.</p>

<blockquote><p><code>LocalInputDStream</code> doesn&#8217;t exist in Spark-Streaming library (or I haven&#8217;t looked well) so I&#8217;ve implemented it as I needed. It does exactly the same as <code>NetworkInputDStream</code> without the remoting aspect. The current code is <a href="https://github.com/mandubian/zpark-ztream/blob/master/src/main/scala/LocalInputDStream.scala">there</a>&#8230;</p></blockquote>

<br/>


<h3><code>Process</code> vs <code>DStream</code> ?</h3>

<p>There is a common point between <code>DStream</code> and <code>Process</code>: both are built as state machines that are passive until run.</p>

<ul>
<li><p>In the case of <code>Process</code>, it is run by playing all the <code>Task</code> effects while gathering emitted values or without taking care of them, in blocking or non-blocking mode etc&#8230;</p></li>
<li><p>In the case of <code>DStream</code>, it is built and registered in the context of a <code>SparkStreamingContext</code>. Then you must also declare some outputs for the <code>DStream</code> like a simple print, an <code>HDFS</code> file output, etc&#8230; Finally you start the <code>SparkStreamingContext</code> which manages everything for you until you stop it.</p></li>
</ul>


<p>So if we want to adapt a <code>Process[Task, T]</code> to a <code>DStream[T]</code>, we must perform 4 steps  (<em>on the Spark driver node</em>):</p>

<ul>
<li>build a <code>DStream[T]</code> using <code>LocalInputDStream[T]</code> providing a <code>Receiver</code> in which we&#8217;ll be able to push asynchronously <code>T</code>.</li>
<li>build a custom scalaz-stream <code>Sink[Task, T, Unit]</code> in charge of consuming all emitted data from <code>Process[Task, T]</code> and pushing them using previous <code>Receiver</code>.</li>
<li>pipe the <code>Process[Task, T]</code> to this <code>Sink[Task, T, Unit]</code> &amp; when <code>Process[Task, T]</code> has halted, stop previous <code>DStream[T]</code>: the result of this pipe operation is a <code>Process[Task, Unit]</code> which is a pure effectful process responsible for pushing <code>T</code> into the dstream without emitting anything.</li>
<li>return previous <code>DStream[T]</code> and effectful consumer <code>Process[Task, Unit]</code>.</li>
</ul>


<h3><code>dstreamize</code> implementation</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">dstreamize</span><span class="o">[</span><span class="kt">T</span> <span class="kt">:</span> <span class="kt">ClassTag</span><span class="o">](</span>
</span><span class='line'>  <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">T</span><span class="o">],</span>
</span><span class='line'>  <span class="n">ssc</span><span class="k">:</span> <span class="kt">StreamingContext</span><span class="o">,</span>
</span><span class='line'>  <span class="n">storageLevel</span><span class="k">:</span> <span class="kt">StorageLevel</span> <span class="o">=</span> <span class="nc">StorageLevel</span><span class="o">.</span><span class="nc">MEMORY_AND_DISK_SER_2</span>
</span><span class='line'><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Unit</span><span class="o">],</span> <span class="nc">ZparkInputDStream</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Build a custom LocalInputDStream</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">dstream</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">ZparkInputDStream</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">ssc</span><span class="o">,</span> <span class="n">storageLevel</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Build a Sink pushing into dstream receiver</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sink</span> <span class="k">=</span> <span class="n">receiver2Sink</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">dstream</span><span class="o">.</span><span class="n">receiver</span><span class="o">.</span><span class="n">asInstanceOf</span><span class="o">[</span><span class="kt">ZparkReceiver</span><span class="o">[</span><span class="kt">T</span><span class="o">]])</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Finally pipe the process to the sink and when finished, closes the dstream</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">consumer</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="o">(</span><span class="n">p</span> <span class="n">to</span> <span class="n">sink</span><span class="o">)</span>
</span><span class='line'>    <span class="c1">// when finished, it closes the dstream</span>
</span><span class='line'>    <span class="o">.</span><span class="n">append</span> <span class="o">(</span> <span class="n">eval</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">{</span> <span class="n">dstream</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span> <span class="o">})</span> <span class="o">)</span>
</span><span class='line'>    <span class="c1">// when error, it closes the dstream</span>
</span><span class='line'>    <span class="o">.</span><span class="n">handle</span> <span class="o">{</span> <span class="k">case</span> <span class="n">e</span><span class="k">:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span>
</span><span class='line'>      <span class="n">println</span><span class="o">(</span><span class="s">&quot;Stopping on error &quot;</span><span class="o">+</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">)</span>
</span><span class='line'>      <span class="n">e</span><span class="o">.</span><span class="n">printStackTrace</span><span class="o">()</span>
</span><span class='line'>      <span class="n">eval</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">{</span> <span class="n">dstream</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span> <span class="o">})</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Return the effectful consumer sink and the DStream</span>
</span><span class='line'>  <span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">dstream</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please remark that this builds a <code>Process[Task, Unit]</code> and a <code>DStream[T]</code> but nothing has happened yet in terms of data consumption &amp; streaming. Both need to be run now.</p></blockquote>

<h3>Use it&#8230;</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// First create a streaming context</span>
</span><span class='line'><span class="k">val</span> <span class="n">ssc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingContext</span><span class="o">(</span><span class="n">clusterUrl</span><span class="o">,</span> <span class="s">&quot;SparkStreamStuff&quot;</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create a data source sample as a process generating a natural every 50ms </span>
</span><span class='line'><span class="c1">// (take 1000 elements)</span>
</span><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">50</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Dstreamize the process in the streaming context</span>
</span><span class='line'><span class="k">val</span> <span class="o">(</span><span class="n">consumer</span><span class="o">,</span> <span class="n">dstream</span><span class="o">)</span> <span class="k">=</span> <span class="n">dstreamize</span><span class="o">(</span><span class="n">p</span><span class="o">,</span> <span class="n">ssc</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Prepare the dstream operations (count) &amp; output (print)</span>
</span><span class='line'><span class="n">dstream</span><span class="o">.</span><span class="n">count</span><span class="o">().</span><span class="n">print</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Start the streaming context</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">start</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Run the consumer for its effects (consuming p and pushing into dstream)</span>
</span><span class='line'><span class="c1">// Note this is blocking but it could be runAsync too</span>
</span><span class='line'><span class="n">consumer</span><span class="o">.</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// await termination of stream with a timeout</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">awaitTermination</span><span class="o">(</span><span class="mi">1000</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// stops the streaming context</span>
</span><span class='line'><span class="n">ssc</span><span class="o">.</span><span class="n">stop</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that you have to:</p>

<ul>
<li>schedule your dstream operations/output before starting the streaming context.</li>
<li>start the streaming context before running the consumer.</li>
</ul>
</blockquote>

<h3>Run it&#8230;</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="mi">14</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">11</span> <span class="mi">11</span><span class="k">:</span><span class="err">32</span><span class="kt">:</span><span class="err">09</span> <span class="kt">WARN</span> <span class="kt">util.Utils:</span> <span class="kt">Your</span> <span class="kt">hostname</span><span class="o">,</span> <span class="n">localhost</span><span class="o">.</span><span class="n">paris</span><span class="o">.</span><span class="n">zenexity</span><span class="o">.</span><span class="n">com</span> <span class="n">resolves</span> <span class="n">to</span> <span class="n">a</span> <span class="n">loopback</span> <span class="n">address</span><span class="k">:</span> <span class="err">127</span><span class="kt">.</span><span class="err">0</span><span class="kt">.</span><span class="err">0</span><span class="kt">.</span><span class="err">1</span><span class="o">;</span> <span class="n">using</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">24.228</span> <span class="n">instead</span> <span class="o">(</span><span class="n">on</span> <span class="n">interface</span> <span class="n">en0</span><span class="o">)</span>
</span><span class='line'><span class="mi">14</span><span class="o">/</span><span class="mi">03</span><span class="o">/</span><span class="mi">11</span> <span class="mi">11</span><span class="k">:</span><span class="err">32</span><span class="kt">:</span><span class="err">09</span> <span class="kt">WARN</span> <span class="kt">util.Utils:</span> <span class="kt">Set</span> <span class="kt">SPARK_LOCAL_IP</span> <span class="kt">if</span> <span class="kt">you</span> <span class="kt">need</span> <span class="kt">to</span> <span class="kt">bind</span> <span class="kt">to</span> <span class="kt">another</span> <span class="kt">address</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1394533933000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">0</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1394533934000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">14</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1394533935000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">20</span>
</span><span class='line'>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="nc">Time</span><span class="k">:</span> <span class="err">1394533936000</span> <span class="kt">ms</span>
</span><span class='line'><span class="o">-------------------------------------------</span>
</span><span class='line'><span class="mi">20</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Ok cool, we can see a warmup phase at beginning and then windows of 1 sec counting 20 elements which is great since one element every 50ms gives 20 elements in 1sec.</p></blockquote>

<br/>


<br/>


<h2>Part 1&#8217;s conclusion</h2>

<p>Now we can pipe a <code>Process[Task, T]</code> into a <code>DStream[T]</code>.</p>

<p>Please not that as we run the <code>Process[Task, T]</code> on the Spark driver node, if this node fails, there is no real way to restore lost data. Yet, <code>LocalInputDStream</code> relies on <code>DStreamGraph</code> &amp; <code>BlockRDD</code>s which persist all DStream relations &amp; all received blocks. Moreover, <code>DStream</code> has exactly the same problem with respect to driver node for now.</p>

<p>That was fun but what can we do with that?</p>

<p><strong>In <a href="/2014/03/09/zpark-ml-nio-2/">part2</a>, I propose to have more fun and stream data to <code>DStream</code> using the brand new Scalaz-Stream NIO API to create cool NIO client/server streams&#8230;</strong></p>

<br/>


<br/>


<blockquote><p>&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212;-> <a href="/2014/03/09/zpark-ml-nio-2/">GO TO PART2</a></p></blockquote>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2014/02/13/zpark/">ZPark-Ztream: Driving Spark Distributed Stream With Scalaz-Stream</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2014-02-13T18:18:00+01:00" pubdate data-updated="true">Feb 13<span>th</span>, 2014</time>
        
         | <a href="/2014/02/13/zpark/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The code &amp; sample apps can be found on <a href="https://github.com/mandubian/zpark-ztream">Github</a></p>

<blockquote><p>Today I&#8217;m going to write about a Proof of Concept I&#8217;ve been working on those last weeks: I wanted to <strong>use scalaz-stream as a driver of Spark distributed data processing</strong>.
This is simply an idea and I don&#8217;t even know whether it is viable or stupid. But the idea is interesting!</p></blockquote>

<h2>Introduction</h2>

<p>2 of my preferred topics those last months are :</p>

<ul>
<li>Realtime streaming</li>
<li>Realtime clustered data processing (in-memory &amp; fault-tolerant)</li>
</ul>


<p>2 tools have kept running through my head those last months:</p>

<ul>
<li><p><a href="https://github.com/scalaz/scalaz-stream">Scalaz-Stream</a> for realtime/continuous streaming using pure functional concepts: I find it very interesting conceptually speaking &amp; very powerful, specially the deterministic &amp; non-deterministic demuxtiplexers provided out-of-the-box (Tee &amp; Wye).</p></li>
<li><p><a href="https://spark.incubator.apache.org/">Spark</a> for fast/fault-tolerant in-memory, resilient &amp; clustered data processing.</p></li>
</ul>


<p>I won&#8217;t speak much about Scalaz-Stream because I wrote a few articles about it.</p>

<br/>


<h4>Let&#8217;s focus on Spark.</h4>

<p>Spark provides tooling for cluster processing of huge datasets in the same <em>batch mode</em> way as Hadoop, the very well known <em>map/reduce</em> infrastructure. But at the difference of Hadoop which is exclusively relying on HDFS cluster file systems when distributing data through the cluster, Spark tries to cache data in memory as much as possible so that latency of access is reduced as much as possible. Hadoop can scale a lot but is known to be slow in the context of a single node.</p>

<p>Spark is aimed at scaling as much as Hadoop but running faster on each node using in-memory caching. Fault-tolerance &amp; data resilience is managed by Spark too using persistence &amp; redundancy based on any nice storage like HDFS or files or whatever you can plug on Spark. So Spark is meant to be a super fast in-memory, fault-tolerant batch processing engine.</p>

<br/>


<h4>RDD Resilient Distributed Dataset</h4>

<p>The basic concept of Spark is <em>Resilient Distributed Dataset</em> aka <code>RDD</code> which is a read-only, <strong>immutable</strong> data structure representing a collection of objects or dataset that can be distributed across a set of nodes in a cluster to perform map/reduce style algorithms.</p>

<p>The dataset represented by this <code>RDD</code> is partitioned i.e. cut into slices called <em>partitions</em> that can be distributed across the cluster of nodes.</p>

<p><code>Resilient</code> means these data can be rebuilt in case of fault on a node or data loss. To perform this, the dataset is replicated/persisted across nodes in memory or in distributed file system such as HDFS.</p>

<p>So the idea of RDD is to provide a seamless structure to manage clustered datasets with very simple API in &#8220;monadic&#8221;-style :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">sc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">SparkContext</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;local[4]&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Simple App&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;YOUR_SPARK_HOME&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="nc">List</span><span class="o">(</span><span class="s">&quot;target/scala-2.10/simple-project_2.10-1.0.jar&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">logData</span> <span class="k">=</span> <span class="n">sc</span><span class="o">.</span><span class="n">textFile</span><span class="o">(</span><span class="n">logFile</span><span class="o">,</span> <span class="mi">2</span><span class="o">).</span><span class="n">cache</span><span class="o">().</span><span class="n">filter</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">contains</span><span class="o">(</span><span class="s">&quot;a&quot;</span><span class="o">)).</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span> <span class="o">+</span> <span class="s">&quot;foo&quot;</span> <span class="o">).</span><span class="n">count</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Depending on your <code>SparkContext</code> configuration, Spark takes in charge of distributing behind the curtain your data to the cluster nodes to perform the required processing in a fully distributed way.</p>

<blockquote><p>One thing to keep in mind is that Spark distributes data to remote nodes but it also distributes the code/closures remotely. So it means your code has to be serializable which is not the case of scalaz-stream in its current implementation.</p></blockquote>

<br/>


<h4>Just a word on Spark code</h4>

<p>As usual, before using Spark in any big project, I&#8217;ve been diving in its code to know whether I can trust this project. I must say I know Spark&#8217;s code better than its API ;)</p>

<p>I find Spark Scala implementation quite clean with explicit choices of design made clearly in the purpose of performance. The need to provide a compatible Java/Python API and to distribute code across clustered nodes involves a few restrictions in terms of implementation choices. Anyway, I won&#8217;t criticize much because I wouldn&#8217;t have written it better and those people clearly know what they do!</p>

<br/>


<h2>Spark Streaming</h2>

<p>So Spark is very good to perform fast clustered batch data processing. Yet, what if your dataset is built progressively, continuously, in realtime?</p>

<p>On top of the core module, Spark provides an extension called <a href="https://spark.incubator.apache.org/docs/latest/streaming-programming-guide.html">Spark Streaming</a> aiming at manipulating live streams of data using the power of Spark.</p>

<p>Spark Streaming can ingest different continuous data feeds like Kafka, Flume, Twitter, ZeroMQ or TCP socket and perform high-level operations on it such as map/reduce/groupby/window/&#8230;</p>

<br/>


<h3>DStream</h3>

<p>The core data structure behind Spark Streams is <code>DStream</code> for <strong>Discretized Stream</strong> (and not <em>distributed</em>).</p>

<p><code>Discretized</code> means it gets a continuous stream of data and makes it discrete by slicing it across time and wrapping those sliced data into the famous <code>RDD</code> described above.</p>

<p>A <code>DStream</code> is just a temporal data partitioner that can distribute data slices across the cluster of nodes to perform some data processing using Spark capabilities.</p>

<p>Here is the illustration in official Spark Stream documentation:</p>

<p><img src="https://spark.incubator.apache.org/docs/latest/img/streaming-dstream.png" alt="streaming-dstream" /></p>

<p><code>DStream</code> also tries to leverage Spark automated persistence/caching/fault-tolerance to the domain of live streaming.</p>

<p><code>DStream</code> is cool but it&#8217;s completely based on temporal aspects. Imagine you want to slice the stream depending on other criteria, with <code>DStream</code>, it would be quite hard because the whole API is based on time. Moreover, using DStream, you can discretize a dataflow but you can&#8217;t go in the other way and make it continuous again (in my knowledge). This is something that would be cool, isn&#8217;t it?</p>

<p>If you want to know more about DStream discretization mechanism, have a look at the official <a href="https://spark.incubator.apache.org/docs/latest/streaming-programming-guide.html">doc</a>.</p>

<br/>


<blockquote><p>As usual, I&#8217;m trying to investigate the edge-cases of concepts I like. In general, this is where I can test the core design of the project and determine whether it&#8217;s worth investigating in my every-day life.</p></blockquote>

<br/>


<h2>Driving Spark Streams with Scalaz-Stream</h2>

<p>I&#8217;ve been thinking about scalaz-stream concepts quite a lot and scalaz-stream is very good at manipulating continuous streams of data. Moreover, it can very easily partition a continuous stream regrouping data into chunks based on any criteria you can imagine.</p>

<p>Scalaz-stream represents a data processing algorithm as a static state machine that you can run when you want. This is the same idea behind map/reduce Spark API: you build your chain of map/filter/window and finally reduce it. <em>Reducing a spark data processing is like running a scalaz-stream machine.</em></p>

<blockquote><p>So my idea was the following:</p>

<ul>
<li>build a continuous stream of data based on scalaz-stream <code>Process[F, O]</code></li>
<li>discretize the stream <code>Process[F, O] =&gt; Process[F, RDD[O]]</code></li>
<li>implement count/reduce/reduceBy/groupBy for <code>Process[F, RDD[O]]</code></li>
<li>provide a <code>continuize</code> method to do <code>Process[F, RDD[O]] =&gt; Process[F, O]</code></li>
</ul>
</blockquote>

<p>So I&#8217;ve been hacking between Scalaz-stream <code>Process[F, O]</code> &amp; Spark <code>RDD[O]</code> and here is the resulting API that I&#8217;ve called <code>ZPark-ZStream</code> (ZzzzzzPark-Zzzzztream).</p>

<p>Let&#8217;s play a bit with my little alpha API.</p>

<br/>


<h3>Discretization by simple slicing</h3>

<p>Let&#8217;s start with a very simple example.</p>

<p>Take a simple finite process containing integers:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Long</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="mi">5L</span><span class="o">,</span> <span class="mi">6L</span><span class="o">,</span> <span class="mi">6L</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now I want to slice this stream of integer by slices of 4 elements.</p>

<p>First we have to create the classic Spark Streaming context and make it implicit (needed by my API).</p>

<p><em>Please remark that I could plug existing StreamingContext on my code without any problem.</em></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">clusterUrl</span> <span class="k">=</span> <span class="s">&quot;local[4]&quot;</span>
</span><span class='line'><span class="k">implicit</span> <span class="n">ssc</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">StreamingContext</span><span class="o">(</span><span class="n">clusterUrl</span><span class="o">,</span> <span class="s">&quot;SparkSerial&quot;</span><span class="o">,</span> <span class="nc">Seconds</span><span class="o">(</span><span class="mi">1</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then let&#8217;s parallelize the previous process :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">prdd</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Long</span><span class="o">]]</span> <span class="k">=</span> <span class="n">p</span><span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'><span class="c1">// type is just there to show what scalac will infer</span>
</span><span class='line'><span class="c1">// Just to remind that Task is the Future equivalent in Scalaz</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok folks, now, we have a discretized stream of <code>Long</code> that can be distributed across a Spark cluster.</p>

<p><code>DStream</code> provides <code>count</code> API which count elements on each <code>RDD</code> in the stream.</p>

<p>Let&#8217;s do the same with my API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">pcount</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">prdd</span><span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>What happens here? The `count operation on each RDD in the stream is distributed across the cluster in a map/reduce-style and results are gathered.</p>

<p>Ok that&#8217;s cool but you still have a discretized stream <code>Process[Task, RDD[Int]]</code> and that&#8217;s not practical to use to see what&#8217;s inside it. So now we are going to <code>re-continuize</code> it and make it a <code>Process[Task, Int]</code> again.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">pfinal</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">pcount</span><span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Easy isn&#8217;t it?</p>

<p>All together :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217; print the result in the console</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">stdOutLines</span><span class="o">[</span><span class="kt">I</span><span class="o">]</span><span class="k">:</span> <span class="kt">Sink</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">I</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">.</span><span class="n">constant</span><span class="o">{</span> <span class="o">(</span><span class="n">s</span><span class="k">:</span> <span class="kt">I</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">Task</span><span class="o">.</span><span class="n">delay</span> <span class="o">{</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot; ----&gt; [${System.nanoTime}] *** $s&quot;</span><span class="o">)</span> <span class="o">}}</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'><span class="c1">// 1 run for the process &amp; 1 run for the Task</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418478569989000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">4</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418478593226000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">4</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Oh yes that works: in each slice of 4 elements, we actually have 4 elements! Reassuring ;)</p></blockquote>

<p>Let&#8217;s do the same with <code>countByValue</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDDByValue</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'><span class="c1">// 1 run for the process &amp; 1 run for the Task</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552751011000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552751176000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552770527000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418552770640000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see that 4 comes before 3. This is due to the fact the 2nd slice of 4 elements (3,3,4,4) is converted into a RDD which is then partitioned and distributed across the cluster to perform the map/reduce count operation. So the order of return might be different at the end.</p>

<p>An example of map/reduce ?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">1L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">2L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">3L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">,</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">parallelize</span><span class="o">(</span><span class="mi">4</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">mapRDD</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="mi">1L</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">reduceRDD</span><span class="o">(</span><span class="k">_</span> <span class="o">+</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418619885745000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">10</span> <span class="o">(</span><span class="mi">2</span><span class="o">+</span><span class="mi">2</span><span class="o">+</span><span class="mi">3</span><span class="o">+</span><span class="mi">3</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392418619905817000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">18</span> <span class="o">(</span><span class="mi">4</span><span class="o">+</span><span class="mi">4</span><span class="o">+</span><span class="mi">5</span><span class="o">+</span><span class="mi">5</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that:</p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">p</span> <span class="n">mapRDD</span> <span class="n">f</span> <span class="o">===</span> <span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">rdd</span> <span class="k">=&gt;</span> <span class="n">rdd</span> <span class="n">map</span> <span class="n">f</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Discretization by time slicing</h3>

<p>Now we could try to slice according to time in the same idea as <code>DStream</code></p>

<p>First of all, let&#8217;s define a continuous stream of positive integers:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">naturals</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">go</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span><span class="nc">Task</span><span class="o">.</span><span class="n">delay</span><span class="o">(</span><span class="n">i</span><span class="o">)){</span> <span class="n">i</span> <span class="k">=&gt;</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">++</span> <span class="n">go</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">go</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, I want integers to be emitted at a given tick for example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="n">duration</span><span class="k">:</span> <span class="kt">Duration</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="n">naturals</span> <span class="n">zipWith</span> <span class="nc">Process</span><span class="o">.</span><span class="n">awakeEvery</span><span class="o">(</span><span class="n">duration</span><span class="o">)){</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">i</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then, let&#8217;s discretize the continuous stream with <strong>ZPark-Ztream</strong> API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">RDD</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>The stream is sliced in slice of 500ms and all elements emitted during these 500ms are gathered in a Spark <code>RDD</code>.</p>

<p>On this stream of <code>RDD, we can apply</code>countRDD` as before and finally re-continuize it. All together we obtain:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">5000</span><span class="o">)</span>  <span class="c1">// takes only 5000 because an infinite stream is hard to log in an article</span>
</span><span class='line'>  <span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">countRDD</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395213389954000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">47</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395213705505000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">28</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395214191637000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">47</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395214688724000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">48</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395215189453000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">45</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395215697655000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">48</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395240677357000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395241175632000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395241674446000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395242175416000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395242675183000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395243177056000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395243676848000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395244175938000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">49</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395244676315000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395245175042000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392395245677394000</span><span class="o">]</span> <span class="o">***</span> <span class="mi">50</span>
</span><span class='line'> <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p>Approximatively we have 50 elements per slice which looks like what we expected.</p>

<p><em>Please note that there is a short period of warmup where values are less homogenous.</em></p>

<br/>


<h3>Discretization by time slicing keeping track of time</h3>

<p><code>DStream</code> keeps track of all created RDD slices of data (following Spark philosophy to cache as much as possible) and allows to do operation of windowing to redistribute RDD.</p>

<p>With ZPark API, you can write the same as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">10</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">500</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">discretizeKeepTime</span><span class="o">(</span><span class="mi">500</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">windowRDD</span><span class="o">(</span><span class="mi">1000</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="n">rdd</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="o">(</span><span class="n">time</span><span class="o">,</span> <span class="n">rdd</span><span class="o">.</span><span class="n">count</span><span class="o">())</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397573066484000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397571981061000</span><span class="o">,</span><span class="mi">68</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397574069315000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397572981063000</span><span class="o">,</span><span class="mi">85</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397575058895000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397573981072000</span><span class="o">,</span><span class="mi">87</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397576059640000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397574981078000</span><span class="o">,</span><span class="mi">89</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397577069518000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397575981086000</span><span class="o">,</span><span class="mi">89</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392397577538941000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1392397576981095000</span><span class="o">,</span><span class="mi">82</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>We can see here that final interval haven&#8217;t 100 elements as we could expect.
This is still a mystery to me and I must investigate a bit more to know where this differences comes from. I have a few ideas but need to validate.</p>

<p>Anyway, globally we get 500 elements meaning we haven&#8217;t lost anything.</p></blockquote>

<br/>


<h3>Mixing scalaz-stream IO &amp; Spark streaming</h3>

<p>Playing with naturals is funny but let&#8217;s work with a real source of data like a file.</p>

<p>It could be anything pluggable on scalaz-stream like kafka/flume/whatever as <code>DStream</code> provides&#8230;</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">io</span><span class="o">.</span><span class="n">linesR</span><span class="o">(</span><span class="s">&quot;testdata/fahrenheit.txt&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">trim</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">&quot;//&quot;</span><span class="o">))</span>
</span><span class='line'>    <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">line</span><span class="o">.</span><span class="n">toDouble</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">mapRDD</span> <span class="o">{</span> <span class="n">x</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="mi">1L</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">groupByKey</span><span class="o">()</span>
</span><span class='line'>    <span class="o">.</span><span class="n">mapRDD</span> <span class="o">{</span> <span class="k">case</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529009755000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">18.0</span><span class="o">,</span><span class="mi">23</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010064000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">19.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010301000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">78.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010501000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">55.3</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010700000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">66.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392398529010892000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mf">64.0</span><span class="o">,</span><span class="mi">22</span><span class="o">)</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Infusing tee with RDD Processes</h3>

<p>Is it possible to combine RDD Processes using scalaz-stream ?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">p0</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">50</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">p1</span> <span class="k">=</span> <span class="n">naturalsEvery</span><span class="o">(</span><span class="mi">100</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">50</span><span class="o">).</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">p</span> <span class="k">=</span>
</span><span class='line'> <span class="o">(</span><span class="n">p0</span> <span class="n">zipWith</span> <span class="n">p1</span><span class="o">){</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>   <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="nc">UnionRDD</span><span class="o">(</span><span class="n">ssc</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">,</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">))</span>
</span><span class='line'> <span class="o">}.</span><span class="n">countRDDByValue</span><span class="o">()</span>
</span><span class='line'>  <span class="o">.</span><span class="n">continuize</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="n">p</span> <span class="n">through</span> <span class="n">stdOutLines</span><span class="o">).</span><span class="n">run</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464151650000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464151819000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464230343000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">2</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464230528000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464477775000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">4</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464477921000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">5</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464478034000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">6</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464478143000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">3</span><span class="o">,</span><span class="mi">1</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464726860000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">8</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464727039000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">7</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975370000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">9</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975511000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">10</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412464975620000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">11</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412465224087000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">12</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="o">----&gt;</span> <span class="o">[</span><span class="err">1392412465224227000</span><span class="o">]</span> <span class="o">***</span> <span class="o">(</span><span class="mi">13</span><span class="o">,</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'> <span class="n">etc</span><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note that I drive Spark RDD stream with Scalaz-Stream always remains on the driver node and is never sent to a remote node as map/reduce closures are in Spark. So Scalaz-stream is used a stream driver in this case. Moreover, Scalaz Process isn&#8217;t serializable in its current implementation so it wouldn&#8217;t be possible as is.</p></blockquote>

<br/>


<br/>


<h2>What about persistence &amp; fault tolerance?</h2>

<p>After discretizing a process, you can persist each RDD :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">p</span><span class="o">.</span><span class="n">discretize</span><span class="o">(</span><span class="mi">250</span> <span class="n">milliseconds</span><span class="o">).</span><span class="n">mapRDD</span> <span class="o">{</span><span class="err"> </span><span class="k">_</span><span class="o">.</span><span class="n">persist</span><span class="o">()</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok but <code>DStream</code> does much more trying to keep in-memory every RDD that is generated and potentially persist it across the cluster. This makes things stateful &amp; mutable which is not the approach of pure functional API like scalaz-stream. So, I need to think a bit more about this persistence topic which is huge.</p>

<p>Anyway I believe I&#8217;m currently investigating another way of manipulating distributed streams than <code>DStream</code>.</p>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Spark is quite amazing and easy to use with respect to the complexity of the subject.</p>

<p>I was also surprised to be able to use it with scalaz-stream so easily.</p>

<p>I hope you liked the idea and I encourage you to think about it and if you find it cool, please tell it! And if you find it stupid, please tell it too: this is still a pure experiment ;)</p>

<p>Have a look at the code on <a href="https://github.com/mandubian/zpark-ztream">Github</a>.</p>

<p>Have distributed &amp; resilient yet continuous fun!</p>

<br/>


<br/>


<br/>


<br/>



</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li class="previous"><a href="/blog/page/2/">&larr; Older</a></li>
    
    <li><a href="/blog/archives">Blog Archives</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/2015/05/05/shapelessstream/">ShapelessStream, when Akka-Stream meets Shapeless Coproduct at compile-time</a>
      </li>
    
      <li class="post">
        <a href="/2015/04/09/freer/">FreeR - Hybrid Free Monads for Reduced Quadratic Complexity/Observability & Map-Fusion Optimization in Scala</a>
      </li>
    
      <li class="post">
        <a href="/2014/12/21/scaledn/">Scaledn: Promote EDN as a far better alternative to Json in Scala</a>
      </li>
    
      <li class="post">
        <a href="/2014/07/30/hfunctor/">Shapeless HFunctor for Heterogenous Structures (& others)</a>
      </li>
    
      <li class="post">
        <a href="/2014/07/29/hmonoid/">Shapeless HMonoid for Heterogenous Structures (& others)</a>
      </li>
    
  </ul>
</section>


<section class="well">
  <ul id="tweets" class="nav" data-user="mandubian" data-count="4" data-replies="false">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
    <a href="http://twitter.com/mandubian" class="twitter-follow-button" data-show-count="false">Follow @mandubian</a>
  
</section>



<section class="well">
  <ul id="gh_repos" data-user="mandubian" data-count="5" data-skip="true" class="nav">
	<li class="nav-header">On GitHub</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a class="github-follow" href="https://github.com/mandubian">Follow @mandubian</a>
  
</section>










  
</aside>

    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2015 - Pascal Voitot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mandubian';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
