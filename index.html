
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mandubian Blog</title>
  <meta name="author" content="Pascal Voitot">

  
  <meta name="description" content="Scalaz-Stream Plug&#8217;n&#8217;Play2 Iteratee/WS + Recursive Streaming &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.mandubian.com">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/d3d.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }

    article {
      margin-bottom: 50px;
      border-top: #DDD solid 20px;
    }
 
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mandubian Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10417377-11']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Mandubian Blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:www.mandubian.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/08/21/playztream/">Scalaz-Stream Plug&#8217;n&#8217;Play2 Iteratee/WS + Recursive Streaming</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-21T23:23:00+02:00" pubdate data-updated="true">Aug 21<span>st</span>, 2013</time>
        
         | <a href="/2013/08/21/playztream/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The code for all autosources &amp; sample apps can be found on Github <a href="https://github.com/mandubian/playzstream">here</a></p>

<blockquote><p>The aim of this article is to show how <a href="https://github.com/scalaz/scalaz-stream">scalaz-stream</a> could be plugged on existing Play Iteratee/Enumerator and used in your web projects. I also wanted to evaluate in depth the power of <a href="https://github.com/scalaz/scalaz-stream">scalaz-stream</a> <em>Processes</em> by trying to write a recursive streaming action: I mean a web endpoint streaming data and re-injecting its own streamed data in itself.</p></blockquote>

<br/>


<blockquote><p>If you want to see now how scalaz-stream is used with Play, go to <a href="#plug-n-play">this paragraph</a> directly.</p></blockquote>

<br/>


<h2>Why Scalaz-Stream when you have Play Iteratees?</h2>

<br/>


<h3>Play Iteratees are powerful &amp; cool but&#8230;</h3>

<p>I&#8217;m a fan of everything dealing with data streaming and realtime management in backends. I&#8217;ve worked a lot on <a href="http://www.playframework.org">Play Framework</a> and naturally I&#8217;ve been using the cornerstone behind Play&#8217;s reactive nature: <em>Play Iteratees</em>.</p>

<p><em>Iteratees</em> (with its counterparts, <em>Enumerators</em> and <em>Enumeratees</em>) are great to <strong>manipulate/transform linear streams of data chunks</strong> in a very <strong>reactive</strong> (non-blocking &amp; asynchronous) and purely <strong>functional</strong> way:</p>

<ul>
<li><strong>Enumerators</strong> identifies the <strong>data producer</strong> that can generate finite/infinite/procedural data streams.</li>
<li><strong>Iteratee</strong> is simply a <strong>data folder built as a state machine</strong> based on 3 states (Continue, Done, Error) which consumes data from Enumerator to compute a final result.</li>
<li><strong>Enumeratee</strong> is a kind of <strong>transducer</strong> able to adapt an Enumerator producing some type of data to an Iteratee that expects other type of data. Enumeratee can be used as both a pipe transformer and adapter.</li>
</ul>


<p>Iteratee is really powerful but I must say I&#8217;ve always found them quite picky to use, practically speaking. In Play, they are used in their best use-case and they were created for that exactly. <strong>I&#8217;ve been using Iteratees for more than one year now but I still don&#8217;t feel fluent with them</strong>. Each time I use them, I must spend some time to know how I could write what I need. It&#8217;s not because they are purely functional (piping an Enumerator into an Enumeratee into an Iteratee is quite trivial) but there is something that my brain doesn&#8217;t want to catch.</p>

<blockquote><p>If you want more details about my experience with Iteratees, go to <a href="#iteratee-details">this paragraph</a></p></blockquote>

<p>That&#8217;s why <strong>I wanted to work with other functional streaming tools to see if they suffer the same kind of usability toughness</strong> or can bring something more natural to me. There are lots of other competitors on the field such as <strong>pipes</strong>, <strong>conduits</strong> and <strong>machines</strong>. As I don&#8217;t have physical time to study all of them in depth, I&#8217;ve chosen the one that appealed me the most i.e. Machines.</p>

<blockquote><p>I&#8217;m not yet a Haskell coder even if I can mumble it so I preferred to evaluate the concept with <a href="https://github.com/scalaz/scalaz-stream">scalaz-stream</a>, a Scala implementation trying to bring machines to <em>normal</em> coders focusing on the aspect of IO streaming.</p></blockquote>

<br/>


<br/>


<h2>Scratching the concepts of Machine / Process ?</h2>

<blockquote><p>I&#8217;m not going to judge if Machines are better or not than Iteratees, this is not my aim. I&#8217;m just experimenting the concept in an objective way.</p></blockquote>

<p>I won&#8217;t explain the concept of Machines in depth because it&#8217;s huge and I don&#8217;t think I have the theoretical background to do it right now. So, let&#8217;s focus on very basic ideas at first:</p>

<ul>
<li><em>Machine</em> is a very generic concept that represents <strong>a data processing mechanism with potential multiple inputs, an output and monadic effects</strong> (typically Future input chunks, side-effects while transforming, delayed output&#8230;)</li>
<li>To simplify, let say a machine is <strong>a bit like a mechano that you construct by plugging together other more generic machines</strong> (such as source, transducer, sink, tee, wye) as simply as pipes.</li>
<li>Building a machine also means <strong>planning all the steps you will go through when managing streamed data but it doesn&#8217;t do anything until you run it</strong> (no side-effect, no resource consumption). You can re-run a machine as many times as you want.</li>
<li>A machine is a <strong>state machine</strong> (Emit/Await/Halt) as Iteratee but it manages error in a more explicit way IMHO (fallback/error)</li>
</ul>


<p>In <a href="https://github.com/scalaz/scalaz-stream">scalaz-stream</a>, you don&#8217;t manipulate machines which are too abstract for real-life use-cases but you manipulate simpler concepts:</p>

<ul>
<li><code>Process[M, O]</code> is a restricted machine outputting a stream of <code>O</code>. It can be a source if the monadic effect gets input from I/O or generates procedural data, or a sink if you don&#8217;t care about the output. <em>Please note that it doesn&#8217;t infer the type of potential input at all</em>.</li>
<li><code>Wye[L, R, O]</code> is a machine that takes 2 inputs (left <code>L</code> / right <code>R</code>) and outputs chunks of type <code>O</code> (you can read from left or right or wait for both before ouputting)</li>
<li><code>Tee[L, R, O]</code> is a Wye that can only read alternatively from left or from right but not from both at the same time.</li>
<li><code>Process1[I, O]</code> can be seen as a transducer which accepts inputs of type <code>I</code> and outputs chunks of type <code>O</code> (a bit like Enumeratee)</li>
<li><code>Channel[M, I, O]</code> is an effectul channel that accepts input of type <code>I</code> and use it in a monadic effect <code>M</code> to produce potential <code>O</code></li>
</ul>


<br/>


<h3>What I find attractive in Machines?</h3>

<ul>
<li>Machines is <strong>producer/consumer/transducer in the same place</strong> and Machines can consume/fold as Iteratee, transform as Enumeratee and emit as Enumerator at the same time and it opens lots of possibilities (even if 3 concepts in one could make it more complicated too).</li>
<li>I feel like <strong>playing with legos as you plug machines on machines</strong> and this is quite funny actually.</li>
<li>Machines manages <strong>monadic effects in its design</strong> and doesn&#8217;t infer the type of effect so you can use it with I/O, Future and whatever you can imagine that is monadic&#8230;</li>
<li>Machines provide out-of-the-box <strong>Tee/Wye to compose streams</strong>, interleave, zip them as you want without writing crazy code.</li>
<li>The early code samples I&#8217;ve seen were quite easy to read (even the implementation is not so complex). Have a look at the <code>StartHere</code> sample provided by scalaz-stream:</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">property</span><span class="o">(</span><span class="s">&quot;simple file I/O&quot;</span><span class="o">)</span> <span class="k">=</span> <span class="n">secure</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="k">val</span> <span class="n">converter</span><span class="k">:</span> <span class="kt">Task</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>      <span class="n">io</span><span class="o">.</span><span class="n">linesR</span><span class="o">(</span><span class="s">&quot;testdata/fahrenheit.txt&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">filter</span><span class="o">(</span><span class="n">s</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">trim</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">.</span><span class="n">startsWith</span><span class="o">(</span><span class="s">&quot;//&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">line</span> <span class="k">=&gt;</span> <span class="n">fahrenheitToCelsius</span><span class="o">(</span><span class="n">line</span><span class="o">.</span><span class="n">toDouble</span><span class="o">).</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;\n&quot;</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">pipe</span><span class="o">(</span><span class="n">process1</span><span class="o">.</span><span class="n">utf8Encode</span><span class="o">)</span>
</span><span class='line'>        <span class="o">.</span><span class="n">to</span><span class="o">(</span><span class="n">io</span><span class="o">.</span><span class="n">fileChunkW</span><span class="o">(</span><span class="s">&quot;testdata/celsius.txt&quot;</span><span class="o">))</span>
</span><span class='line'>        <span class="o">.</span><span class="n">run</span>
</span><span class='line'>
</span><span class='line'>    <span class="n">converter</span><span class="o">.</span><span class="n">run</span>
</span><span class='line'>    <span class="kc">true</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>But don&#8217;t think everything is so simple, machines is a complex concept with lots of theory behind it which is quite abstract. what I find very interesting is that <strong>it&#8217;s possible to vulgarize this very abstract concept with simpler concepts such as Process, Source, Sink, Tee, Wye&#8230; that you can catch quite easily</strong> as these are concepts you already manipulated when you were playing in your bathtub when you were child (or even now).</p></blockquote>

<br/>


<br/>


<h2><a name="plug-n-play">Scalaz-stream Plug&#8217;n&#8217;Play  Iteratee/Enumerator</a></h2>

<p>After these considerations, I wanted to experiment scalaz-stream with Play streaming capabilities in order to see how it behaves in a context I know.</p>

<p>Here is what I decided to study:</p>

<ul>
<li><strong>Stream data out of a controller action using a scalaz-stream <code>Process</code></strong></li>
<li><strong>Call an AsyncWebService &amp; consume the response as a stream of <code>Array[Byte]</code> using a scalaz-stream <code>Process</code></strong></li>
</ul>


<p>Here is existing Play API :</p>

<ul>
<li>Action provides <code>Ok.stream(Enumerator)</code></li>
<li>WS call consuming response as a stream of data <code>WS.get(r: ResponseHeader =&gt; Iteratee)</code></li>
</ul>


<br/>


<blockquote><p>As you can see, these API depends on Iteratee/Enumerator. As I didn&#8217;t want to hack Play too much as a beginning, I decided to try &amp; plug scalaz-stream on Play Iteratee (if possible).</p></blockquote>

<h3>Building <code>Enumerator[O]</code> from <code>Process[Task, O]</code></h3>

<p>The idea is to take a scalaz-stream Source[O] (<code>Process[M,O]</code>) and wrap it into an <code>Enumerator[O]</code> so that it can be used in Play controller actions.</p>

<p>An Enumerator is a data producer which can generate those data using monadic <code>Future</code> effects (Play Iteratee is tightly linked to <code>Future</code>).</p>

<p><code>Process[Task, O]</code> is a machine outputting a stream of <code>O</code> so it&#8217;s logically the right candidate to be adapted with a <code>Enumerator[O]</code>. <em>Let&#8217;s remind&#8217; <code>Task</code> is just a scalaz <code>Future[Either[Throwable,A]]</code> with a few helpers and it&#8217;s used in scalaz-stream</em>.</p>

<p>So I&#8217;ve implemented (at least tried) an <code>Enumerator[O]</code> that accepts a <code>Process[Task, O]</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">enumerator</span><span class="o">[</span><span class="kt">O</span><span class="o">](</span><span class="n">p</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">O</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">new</span> <span class="nc">Enumerator</span><span class="o">[</span><span class="kt">O</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>      <span class="c1">// look the code in github project</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>  <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The implementation just synchronizes the states of the <code>Iteratee[O, A]</code> consuming the <code>Enumerator</code> with the states of <code>Process[Task, O]</code> emitting data chunks of <code>O</code>. It&#8217;s quite simple actually.</p></blockquote>

<br/>


<br/>


<h3>Building <code>Process1[I, O]</code> from <code>Iteratee[I, O]</code></h3>

<p>The idea is to drive an Iteratee from a scalaz-stream Process so that it can consume an Enumerator and be used in Play WS.</p>

<p>An <code>Iteratee[I, O]</code> accepts inputs of type <code>I</code> (<em>and nothing else</em>) and will fold the input stream into a single result of type <code>O</code>.</p>

<p>A <code>Process1[I, O]</code> accepts inputs of type <code>I</code> and emits chunks of type <code>O</code> but not necessarily one single output chunk. So it&#8217;s a good candidate for our use-case but we need to choose which emitted chunk will be the result of the <code>Iteratee[I, O]</code>. here, totally arbitrarily, I&#8217;ve chosen to take the first emit as the result (<em>but the last would be as good if not better</em>).</p>

<p>So I implemented the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">iterateeFirstEmit</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">O</span><span class="o">](</span><span class="n">p</span><span class="k">:</span> <span class="kt">Process.Process1</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">O</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">ctx</span><span class="k">:</span> <span class="kt">ExecutionContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">I</span>, <span class="kt">O</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="c1">// look the code in github project</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>The implementation is really raw for experimentation as it goes through the states of the <code>Process1[I,O]</code> and generates the corresponding states of <code>Iteratee[I,O]</code> until first emitted value. Nothing more nothing less&#8230;</p></blockquote>

<br/>


<br/>


<h2>A few basic action samples</h2>

<blockquote><p>Everything done in those samples could be done with Iteratee/Enumeratee more or less simply. The subject is not there!</p></blockquote>

<br/>


<h3>Sample 1 : Generates a stream from a Simple Emitter Process</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">sample1</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">process</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emitAll</span><span class="o">(</span><span class="nc">Seq</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">)).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">process</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample1&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mi">1234</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Sample 2 : Generates a stream from a continuous emitter</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** A process generating an infinite stream of natural numbers */</span>
</span><span class='line'><span class="k">val</span> <span class="n">numerals</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">unfold</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="k">val</span> <span class="n">x</span> <span class="k">=</span> <span class="n">s</span><span class="o">+</span><span class="mi">1</span><span class="o">;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">x</span><span class="o">)</span> <span class="o">}.</span><span class="n">repeat</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// we limit the number of outputs but you don&#39;t have it can stream forever...</span>
</span><span class='line'><span class="k">def</span> <span class="n">sample2</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">numerals</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">40</span><span class="o">)))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample2&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">9</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="mi">12</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">14</span><span class="o">,</span><span class="mi">15</span><span class="o">,</span><span class="mi">16</span><span class="o">,</span><span class="mi">17</span><span class="o">,</span><span class="mi">18</span><span class="o">,</span><span class="mi">19</span><span class="o">,</span><span class="mi">20</span><span class="o">,</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Sample 3 : Generates a stream whose output frequency is controlled by a tee with numeral generator on left and ticker on right</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** ticks constant every delay milliseconds */</span>
</span><span class='line'><span class="k">def</span> <span class="n">ticker</span><span class="o">(</span><span class="n">constant</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">delay</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span>
</span><span class='line'>  <span class="n">scalaFuture2scalazTask</span><span class="o">(</span><span class="n">delayedNumber</span><span class="o">(</span><span class="n">constant</span><span class="o">,</span> <span class="n">delay</span><span class="o">))</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">).</span><span class="n">repeat</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sample3</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span>
</span><span class='line'>    <span class="c1">// creates a Tee outputting only numerals but consuming ticker // to have the delayed effect</span>
</span><span class='line'>    <span class="o">(</span><span class="n">numerals</span> <span class="n">tee</span> <span class="n">ticker</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">100</span><span class="o">))(</span><span class="n">processes</span><span class="o">.</span><span class="n">zipWith</span><span class="o">((</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">take</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>      <span class="o">.</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note :</p>

<ul>
<li><code>scalaFuture2scalazTask</code> is just a helper to convert a <code>Future</code> into <code>Task</code></li>
<li><code>ticker</code>is quite simple to understand: it awaits <code>Task[Int] and emits this</code>Int and repeats it again&#8230;</li>
<li><code>processes.zipWith((a,b) =&gt; a)</code> is a tee (2 inputs left/right) that outputs only left data but consumes right also to have the delay effect.</li>
<li><code>.map(_.toString)</code> simply converts into something writeable by <code>Ok.stream</code></li>
<li><code>.intersperse(",")</code> which simply add `&#8221;,&#8221; between each element</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample3&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mf">1.</span><span class="o">..</span> <span class="c1">// to simulate the progressive apparition of numbers on screen</span>
</span><span class='line'><span class="mi">1</span><span class="o">,...</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mf">2.</span><span class="o">..</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">9</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="mi">12</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">14</span><span class="o">,</span><span class="mi">15</span><span class="o">,</span><span class="mi">16</span><span class="o">,</span><span class="mi">17</span><span class="o">,</span><span class="mi">18</span><span class="o">,</span><span class="mi">19</span><span class="o">,</span><span class="mi">20</span><span class="o">,</span><span class="mi">21</span><span class="o">,</span><span class="mi">22</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">24</span><span class="o">,</span><span class="mi">25</span><span class="o">,</span><span class="mi">26</span><span class="o">,</span><span class="mi">27</span><span class="o">,</span><span class="mi">28</span><span class="o">,</span><span class="mi">29</span><span class="o">,</span><span class="mi">30</span><span class="o">,</span><span class="mi">31</span><span class="o">,</span><span class="mi">32</span><span class="o">,</span><span class="mi">33</span><span class="o">,</span><span class="mi">34</span><span class="o">,</span><span class="mi">35</span><span class="o">,</span><span class="mi">36</span><span class="o">,</span><span class="mi">37</span><span class="o">,</span><span class="mi">38</span><span class="o">,</span><span class="mi">39</span><span class="o">,</span><span class="mi">40</span><span class="o">,</span><span class="mi">41</span><span class="o">,</span><span class="mi">42</span><span class="o">,</span><span class="mi">43</span><span class="o">,</span><span class="mi">44</span><span class="o">,</span><span class="mi">45</span><span class="o">,</span><span class="mi">46</span><span class="o">,</span><span class="mi">47</span><span class="o">,</span><span class="mi">48</span><span class="o">,</span><span class="mi">49</span><span class="o">,</span><span class="mi">50</span><span class="o">,</span><span class="mi">51</span><span class="o">,</span><span class="mi">52</span><span class="o">,</span><span class="mi">53</span><span class="o">,</span><span class="mi">54</span><span class="o">,</span><span class="mi">55</span><span class="o">,</span><span class="mi">56</span><span class="o">,</span><span class="mi">57</span><span class="o">,</span><span class="mi">58</span><span class="o">,</span><span class="mi">59</span><span class="o">,</span><span class="mi">60</span><span class="o">,</span><span class="mi">61</span><span class="o">,</span><span class="mi">62</span><span class="o">,</span><span class="mi">63</span><span class="o">,</span><span class="mi">64</span><span class="o">,</span><span class="mi">65</span><span class="o">,</span><span class="mi">66</span><span class="o">,</span><span class="mi">67</span><span class="o">,</span><span class="mi">68</span><span class="o">,</span><span class="mi">69</span><span class="o">,</span><span class="mi">70</span><span class="o">,</span><span class="mi">71</span><span class="o">,</span><span class="mi">72</span><span class="o">,</span><span class="mi">73</span><span class="o">,</span><span class="mi">74</span><span class="o">,</span><span class="mi">75</span><span class="o">,</span><span class="mi">76</span><span class="o">,</span><span class="mi">77</span><span class="o">,</span><span class="mi">78</span><span class="o">,</span><span class="mi">79</span><span class="o">,</span><span class="mi">80</span><span class="o">,</span><span class="mi">81</span><span class="o">,</span><span class="mi">82</span><span class="o">,</span><span class="mi">83</span><span class="o">,</span><span class="mi">84</span><span class="o">,</span><span class="mi">85</span><span class="o">,</span><span class="mi">86</span><span class="o">,</span><span class="mi">87</span><span class="o">,</span><span class="mi">88</span><span class="o">,</span><span class="mi">89</span><span class="o">,</span><span class="mi">90</span><span class="o">,</span><span class="mi">91</span><span class="o">,</span><span class="mi">92</span><span class="o">,</span><span class="mi">93</span><span class="o">,</span><span class="mi">94</span><span class="o">,</span><span class="mi">95</span><span class="o">,</span><span class="mi">96</span><span class="o">,</span><span class="mi">97</span><span class="o">,</span><span class="mi">98</span><span class="o">,</span><span class="mi">99</span><span class="o">,</span><span class="mi">100</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Sample 4 : Generates a stream using side-effect to control output frequency</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Async generates this Int after delay*/</span>
</span><span class='line'><span class="k">def</span> <span class="n">delayedNumber</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">delay</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">Promise</span><span class="o">.</span><span class="n">timeout</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="n">delay</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/** Creates a process generating an infinite stream natural numbers</span>
</span><span class='line'><span class="cm">  * every `delay milliseconds</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">def</span> <span class="n">delayedNumerals</span><span class="o">(</span><span class="n">delay</span><span class="k">:</span> <span class="kt">Long</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">step</span><span class="o">(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">i</span><span class="o">).</span><span class="n">then</span><span class="o">(</span>
</span><span class='line'>      <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span><span class="n">scalaFuture2scalazTask</span><span class="o">(</span><span class="n">delayedNumber</span><span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">delay</span><span class="o">)))(</span><span class="n">step</span><span class="o">)</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">.</span><span class="n">await</span><span class="o">(</span><span class="n">scalaFuture2scalazTask</span><span class="o">(</span><span class="n">delayedNumber</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">delay</span><span class="o">)))(</span><span class="n">step</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sample4</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">delayedNumerals</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note:</p>

<ul>
<li><code>delayedNumber</code> uses an Akka scheduler to trigger our value after timeout</li>
<li><code>delayedNumerals</code> shows a simple recursive `Process[Task, Int] construction which shouldn&#8217;t be too hard to understand</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample4&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mf">0.</span><span class="o">..</span> <span class="c1">// to simulate the progressive apparition of numbers every 100ms</span>
</span><span class='line'><span class="mi">0</span><span class="o">,...</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mf">1.</span><span class="o">..</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,...</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mf">2.</span><span class="o">..</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">4</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">6</span><span class="o">,</span><span class="mi">7</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">9</span><span class="o">,</span><span class="mi">10</span><span class="o">,</span><span class="mi">11</span><span class="o">,</span><span class="mi">12</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">14</span><span class="o">,</span><span class="mi">15</span><span class="o">,</span><span class="mi">16</span><span class="o">,</span><span class="mi">17</span><span class="o">,</span><span class="mi">18</span><span class="o">,</span><span class="mi">19</span><span class="o">,</span><span class="mi">20</span><span class="o">,</span><span class="mi">21</span><span class="o">,</span><span class="mi">22</span><span class="o">,</span><span class="mi">23</span><span class="o">,</span><span class="mi">24</span><span class="o">,</span><span class="mi">25</span><span class="o">,</span><span class="mi">26</span><span class="o">,</span><span class="mi">27</span><span class="o">,</span><span class="mi">28</span><span class="o">,</span><span class="mi">29</span><span class="o">,</span><span class="mi">30</span><span class="o">,</span><span class="mi">31</span><span class="o">,</span><span class="mi">32</span><span class="o">,</span><span class="mi">33</span><span class="o">,</span><span class="mi">34</span><span class="o">,</span><span class="mi">35</span><span class="o">,</span><span class="mi">36</span><span class="o">,</span><span class="mi">37</span><span class="o">,</span><span class="mi">38</span><span class="o">,</span><span class="mi">39</span><span class="o">,</span><span class="mi">40</span><span class="o">,</span><span class="mi">41</span><span class="o">,</span><span class="mi">42</span><span class="o">,</span><span class="mi">43</span><span class="o">,</span><span class="mi">44</span><span class="o">,</span><span class="mi">45</span><span class="o">,</span><span class="mi">46</span><span class="o">,</span><span class="mi">47</span><span class="o">,</span><span class="mi">48</span><span class="o">,</span><span class="mi">49</span><span class="o">,</span><span class="mi">50</span><span class="o">,</span><span class="mi">51</span><span class="o">,</span><span class="mi">52</span><span class="o">,</span><span class="mi">53</span><span class="o">,</span><span class="mi">54</span><span class="o">,</span><span class="mi">55</span><span class="o">,</span><span class="mi">56</span><span class="o">,</span><span class="mi">57</span><span class="o">,</span><span class="mi">58</span><span class="o">,</span><span class="mi">59</span><span class="o">,</span><span class="mi">60</span><span class="o">,</span><span class="mi">61</span><span class="o">,</span><span class="mi">62</span><span class="o">,</span><span class="mi">63</span><span class="o">,</span><span class="mi">64</span><span class="o">,</span><span class="mi">65</span><span class="o">,</span><span class="mi">66</span><span class="o">,</span><span class="mi">67</span><span class="o">,</span><span class="mi">68</span><span class="o">,</span><span class="mi">69</span><span class="o">,</span><span class="mi">70</span><span class="o">,</span><span class="mi">71</span><span class="o">,</span><span class="mi">72</span><span class="o">,</span><span class="mi">73</span><span class="o">,</span><span class="mi">74</span><span class="o">,</span><span class="mi">75</span><span class="o">,</span><span class="mi">76</span><span class="o">,</span><span class="mi">77</span><span class="o">,</span><span class="mi">78</span><span class="o">,</span><span class="mi">79</span><span class="o">,</span><span class="mi">80</span><span class="o">,</span><span class="mi">81</span><span class="o">,</span><span class="mi">82</span><span class="o">,</span><span class="mi">83</span><span class="o">,</span><span class="mi">84</span><span class="o">,</span><span class="mi">85</span><span class="o">,</span><span class="mi">86</span><span class="o">,</span><span class="mi">87</span><span class="o">,</span><span class="mi">88</span><span class="o">,</span><span class="mi">89</span><span class="o">,</span><span class="mi">90</span><span class="o">,</span><span class="mi">91</span><span class="o">,</span><span class="mi">92</span><span class="o">,</span><span class="mi">93</span><span class="o">,</span><span class="mi">94</span><span class="o">,</span><span class="mi">95</span><span class="o">,</span><span class="mi">96</span><span class="o">,</span><span class="mi">97</span><span class="o">,</span><span class="mi">98</span><span class="o">,</span><span class="mi">99</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Sample 5 : Generates a stream by consuming completely another stream</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// a process folding all Array[Byte] into a big String</span>
</span><span class='line'><span class="k">val</span> <span class="n">reader</span><span class="k">:</span> <span class="kt">Process.Process1</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">processes</span><span class="o">.</span><span class="n">fold1</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]((</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">a</span> <span class="o">++</span> <span class="n">b</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="n">arr</span> <span class="k">=&gt;</span> <span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="n">arr</span><span class="o">)</span> <span class="o">}</span> <span class="o">|&gt;</span> <span class="n">processes</span><span class="o">.</span><span class="n">last</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sample5</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// the WS call with response consumer by previous Process1[Array[Byte], String] driving the Iteratee[Array[Byte], String]</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">maybeValues</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>    <span class="nc">WS</span><span class="o">.</span><span class="n">url</span><span class="o">(</span><span class="n">routes</span><span class="o">.</span><span class="nc">Application</span><span class="o">.</span><span class="n">sample2</span><span class="o">().</span><span class="n">absoluteURL</span><span class="o">())</span>
</span><span class='line'>      <span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="n">rh</span> <span class="k">=&gt;</span> <span class="n">iterateeFirstEmit</span><span class="o">(</span><span class="n">reader</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">flatMap</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">run</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span>
</span><span class='line'>    <span class="c1">// wraps the received String in a Process</span>
</span><span class='line'>    <span class="c1">// re-splits it to remove &quot;,&quot;</span>
</span><span class='line'>    <span class="c1">// emits all chunks</span>
</span><span class='line'>    <span class="nc">Process</span><span class="o">.</span><span class="n">wrap</span><span class="o">(</span><span class="n">scalaFuture2scalazTask</span><span class="o">(</span><span class="n">maybeValues</span><span class="o">))</span>
</span><span class='line'>      <span class="o">.</span><span class="n">flatMap</span><span class="o">{</span> <span class="n">values</span> <span class="k">=&gt;</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emitAll</span><span class="o">(</span><span class="n">values</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">))</span> <span class="o">}</span>
</span><span class='line'>  <span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note:</p>

<ul>
<li><code>reader</code> is a <code>Process1[Array[Byte], String] that folds all received</code>Array[Byte]<code>into a</code>String`</li>
<li><code>iterateeFirstEmit(reader)</code> simulates an <code>Iteratee[Array[Byte], String]</code> driven by the <code>reader</code> process that will fold all chunks of data received from WS call to <code>routes.Application.sample2()</code></li>
<li><code>.get(rh =&gt; iterateeFirstEmit(reader))</code> will return a <code>Future[Iteratee[Array[Byte], String]</code> that is run in <code>.flatMap(_.run)</code> to return a <code>Future[String]</code></li>
<li><code>Process.wrap(scalaFuture2scalazTask(maybeValues))</code> is a trick to wrap the folded <code>Future[String]</code> into a <code>Process[Task, String]</code></li>
<li><code>Process.emitAll(values.split(","))</code> splits the resulting string again and emits all chunks outside (stupid, just for demo)</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample5&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mi">1234567891011121314151617181920</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<blockquote><p>Still there? Let&#8217;s dive deeper and be sharper!</p></blockquote>

<br/>


<h2>Building recursive streaming action consuming itself</h2>

<br/>


<h3>Hacking WS to consume &amp; re-emit WS in realtime</h3>

<p><code>WS.executeStream(r: ResponseHeader =&gt; Iteratee[Array[Byte], A])</code> is cool API because you can build an iteratee from the ResponseHeader and then the iteratee will consume received `Array[Byte] chunks in a reactive way and will fold them. The problem is that until the iteratee has finished, you won&#8217;t have any result.</p>

<p>But I&#8217;d like to be able to receive chunks of data in realtime and re-emit them immediately so that I can inject them in realtime data flow processing. WS API doesn&#8217;t allow this so I decided to hack it a bit. I&#8217;ve written <code>WSZ</code> which provides the API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">getRealTime</span><span class="o">()</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]</span>
</span><span class='line'><span class="c1">// based on</span>
</span><span class='line'><span class="k">private</span><span class="o">[</span><span class="kt">libs</span><span class="o">]</span> <span class="k">def</span> <span class="n">realtimeStream</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Future</span>, <span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]</span>
</span></code></pre></td></tr></table></div></figure>


<p>This API outputs a realtime Stream of <code>Array[Byte]</code> whose flow is controlled by promises (<code>Future</code>) being redeemed in AsyncHttpClient <code>AsyncHandler</code>. <em>I didn&#8217;t care about ResponseHeaders for this experimentation but it should be taken account in a more serious impl.</em></p>

<p>I obtain a <code>Process[Future, Array[Byte]]</code> streaming received chunks in realtime and I can then take advantage of the power of machines to manipulate the data chunks as I want.</p>

<br/>


<h3>Sample 6 : Generates a stream by forwarding/refolding another stream in realtime</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** A Process1 splitting input strings using splitter and re-grouping chunks */</span>
</span><span class='line'><span class="k">def</span> <span class="n">splitFold</span><span class="o">(</span><span class="n">splitter</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process.Process1</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// the recursive splitter / refolder</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">go</span><span class="o">(</span><span class="n">rest</span><span class="k">:</span> <span class="kt">String</span><span class="o">)(</span><span class="n">str</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span><span class="k">:</span> <span class="kt">Process.Process1</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">splitted</span> <span class="k">=</span> <span class="n">str</span><span class="o">.</span><span class="n">split</span><span class="o">(</span><span class="n">splitter</span><span class="o">)</span>
</span><span class='line'>    <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">&quot;&quot;&quot;$str - ${splitted.mkString(&quot;,&quot;)} --&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">(</span><span class="n">splitted</span><span class="o">.</span><span class="n">length</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">0</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// string == splitter</span>
</span><span class='line'>        <span class="c1">// emit rest</span>
</span><span class='line'>        <span class="c1">// loop</span>
</span><span class='line'>        <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">rest</span><span class="o">).</span><span class="n">then</span><span class="o">(</span> <span class="nc">Process</span><span class="o">.</span><span class="n">await1</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">(</span><span class="n">go</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>      <span class="k">case</span> <span class="mi">1</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// splitter not found in string </span>
</span><span class='line'>        <span class="c1">// so waiting for next string</span>
</span><span class='line'>        <span class="c1">// loop by adding current str to rest</span>
</span><span class='line'>        <span class="c1">// but if we reach end of input, then we emit (rest+str) for last element</span>
</span><span class='line'>        <span class="nc">Process</span><span class="o">.</span><span class="n">await1</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">(</span><span class="n">go</span><span class="o">(</span><span class="n">rest</span> <span class="o">+</span> <span class="n">str</span><span class="o">)).</span><span class="n">orElse</span><span class="o">(</span><span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">rest</span><span class="o">+</span><span class="n">str</span><span class="o">))</span>
</span><span class='line'>      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// splitter found</span>
</span><span class='line'>        <span class="c1">// emit rest + splitted.head</span>
</span><span class='line'>        <span class="c1">// emit all splitted elements but last</span>
</span><span class='line'>        <span class="c1">// loops with rest = splitted last element</span>
</span><span class='line'>        <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="n">rest</span> <span class="o">+</span> <span class="n">splitted</span><span class="o">.</span><span class="n">head</span><span class="o">)</span>
</span><span class='line'>               <span class="o">.</span><span class="n">then</span><span class="o">(</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emitAll</span><span class="o">(</span><span class="n">splitted</span><span class="o">.</span><span class="n">tail</span><span class="o">.</span><span class="n">init</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>               <span class="o">.</span><span class="n">then</span><span class="o">(</span> <span class="nc">Process</span><span class="o">.</span><span class="n">await1</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">(</span><span class="n">go</span><span class="o">(</span><span class="n">splitted</span><span class="o">.</span><span class="n">last</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>    <span class="o">})</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="c1">// await1 simply means &quot;await an input string and emits it&quot;</span>
</span><span class='line'>  <span class="nc">Process</span><span class="o">.</span><span class="n">await1</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">(</span><span class="n">go</span><span class="o">(</span><span class="s">&quot;&quot;</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sample6</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">p</span> <span class="k">=</span> <span class="nc">WSZ</span><span class="o">.</span><span class="n">url</span><span class="o">(</span><span class="n">routes</span><span class="o">.</span><span class="nc">Application</span><span class="o">.</span><span class="n">sample4</span><span class="o">().</span><span class="n">absoluteURL</span><span class="o">()).</span><span class="n">getRealTime</span><span class="o">.</span><span class="n">translate</span><span class="o">(</span><span class="nc">Task2FutureNT</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">p</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="k">_</span><span class="o">))</span> <span class="o">|&gt;</span> <span class="n">splitFold</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note:</p>

<ul>
<li><code>def splitFold(splitter: String): Process.Process1[String, String]</code> is just a demo that coding a Process transducer isn&#8217;t so crazy&#8230; Look at comments in code</li>
<li><code>.translate(Task2FutureNF)</code> converts the <code>Process[Future, Array[Byte]]</code> to <code>Process[Task, Array[Byte]]</code> using Scalaz Natural Transformation.</li>
<li><code>p |&gt; splitFold(",")</code> means &#8220;pipe output of process <code>p</code> to input of <code>splitFold</code>&#8221;.</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">curl</span> <span class="s">&quot;localhost:10000/sample6&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mf">0.</span><span class="o">..</span>
</span><span class='line'><span class="mf">01.</span><span class="o">..</span>
</span><span class='line'><span class="mf">012.</span><span class="o">..</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="mi">01234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495969798</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<blockquote><p>Let&#8217;s finish our trip with a bit of puzzle and mystery.</p></blockquote>

<br/>


<h3>THE FINAL MYSTERY: recursive stream generating Fibonacci series</h3>

<p>As soon as my first experimentations of scalaz-stream with Play were operational, I&#8217;ve imagined an interesting case:</p>

<blockquote><p>Is it possible to build an action generating a stream of data fed by itself: a kind of recursive stream.</p></blockquote>

<p>With Iteratee, it&#8217;s not really possible since it can&#8217;t emit data before finishing iteration. It would certainly be possible with an Enumeratee but the API doesn&#8217;t exist and I find it much more obvious with scalaz-stream API!</p>

<p>The mystery isn&#8217;t in the answer to my question: YES it is possible!</p>

<p>The idea is simple:</p>

<ul>
<li>Create a simple action</li>
<li>Create a first process emitting a few initialization data</li>
<li>Create a second process which consumes the WS calling my own action and re-emits the received chunks in realtime</li>
<li>Append first process output and second process output</li>
<li>Stream global output as a result of the action which will back-propagated along time to the action itself&#8230;</li>
</ul>


<p>Naturally, if it consumes its own data, it will recall itself again and again and again until you reach the connections or opened file descriptors limit. As a consequence, you must limit the depth of recursion.</p>

<p>I performed different experiences to show this use-case by zipping the stream with itself, adding elements with themselves etc&#8230;
And after a few tries, I implemented the following code quite fortuitously :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** @param curDepth the current recursion depth</span>
</span><span class='line'><span class="cm">  * @param maxDepth the max recursion depth</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">def</span> <span class="n">sample7</span><span class="o">(</span><span class="n">curDepth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">maxDepth</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span> <span class="k">implicit</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// initializes serie with 2 first numerals output with a delay of 100ms</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">init</span><span class="k">:</span> <span class="kt">Process</span><span class="o">[</span><span class="kt">Task</span>, <span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">delayedNumerals</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="n">take</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Creates output Process</span>
</span><span class='line'>  <span class="c1">// If didn&#39;t reach maxDepth, creates a process consuming my own action</span>
</span><span class='line'>  <span class="c1">// If reach maxDepth, just emit 0</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">outputProcess</span> <span class="k">=</span>
</span><span class='line'>    <span class="k">if</span><span class="o">(</span><span class="n">curDepth</span> <span class="o">&lt;</span> <span class="n">maxDepth</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// calling my own action and streaming chunks using getRealTime</span>
</span><span class='line'>
</span><span class='line'>      <span class="k">val</span> <span class="n">myself</span> <span class="k">=</span> <span class="nc">WSZ</span><span class="o">.</span><span class="n">url</span><span class="o">(</span>
</span><span class='line'>        <span class="n">routes</span><span class="o">.</span><span class="nc">Application</span><span class="o">.</span><span class="n">sample7</span><span class="o">(</span><span class="n">curDepth</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">maxDepth</span><span class="o">).</span><span class="n">absoluteURL</span><span class="o">()</span>
</span><span class='line'>      <span class="o">).</span><span class="n">getRealTime</span><span class="o">.</span><span class="n">translate</span><span class="o">(</span><span class="nc">Task2FutureNT</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">new</span> <span class="nc">String</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>
</span><span class='line'>      <span class="c1">// splitFold isn&#39;t useful, just for demo</span>
</span><span class='line'>      <span class="o">|&gt;</span> <span class="n">splitFold</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// THE IMPORTANT PART BEGIN</span>
</span><span class='line'>      <span class="c1">// appends `init` output with `myself` output</span>
</span><span class='line'>      <span class="c1">// pipe it through a helper provided scalaz-stream `processes.sum[Long]`</span>
</span><span class='line'>      <span class="c1">// which sums elements and emits partial sums</span>
</span><span class='line'>      <span class="o">((</span><span class="n">init</span> <span class="n">append</span> <span class="n">myself</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toLong</span><span class="o">)</span> <span class="o">|&gt;</span> <span class="n">processes</span><span class="o">.</span><span class="n">sum</span><span class="o">[</span><span class="kt">Long</span><span class="o">])</span>
</span><span class='line'>      <span class="c1">// THE IMPORTANT PART END</span>
</span><span class='line'>      <span class="c1">// just for output format</span>
</span><span class='line'>      <span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">).</span><span class="n">intersperse</span><span class="o">(</span><span class="s">&quot;,&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>    <span class="k">else</span> <span class="nc">Process</span><span class="o">.</span><span class="n">emit</span><span class="o">(</span><span class="mi">0</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="k">_</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="nc">Ok</span><span class="o">.</span><span class="n">stream</span><span class="o">(</span><span class="n">enumerator</span><span class="o">(</span><span class="n">outputProcess</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Launch it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">curl</span> <span class="s">&quot;localhost:10000/sample7?curDepth=0&amp;maxDepth=10&quot;</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">buffer</span>
</span><span class='line'><span class="mi">0</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="o">,</span><span class="mi">5</span><span class="o">,</span><span class="mi">8</span><span class="o">,</span><span class="mi">13</span><span class="o">,</span><span class="mi">21</span><span class="o">,</span><span class="mi">34</span><span class="o">,</span><span class="mi">55</span><span class="o">,</span><span class="mi">89</span><span class="o">,</span><span class="mi">144</span><span class="o">,</span><span class="mi">233</span><span class="o">,</span><span class="mi">377</span><span class="o">,</span><span class="mi">610</span><span class="o">,</span><span class="mi">987</span><span class="o">,</span><span class="mi">1597</span><span class="o">,</span><span class="mi">2584</span><span class="o">,</span><span class="mi">4181</span><span class="o">,</span><span class="mi">6765</span>
</span></code></pre></td></tr></table></div></figure>


<p>WTF??? This is Fibonacci series?</p>

<p>Just to remind you about it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">e</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="k">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">e</span><span class="o">(</span><span class="mi">1</span><span class="o">)</span> <span class="k">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">e</span><span class="o">(</span><span class="n">n</span><span class="o">)</span> <span class="k">=</span> <span class="n">e</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">e</span><span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Here is the mystery!!!</p>

<p>How does it work???</p>

<p>I won&#8217;t tell the answer to this puzzling side-effect and let you think about it and discover why it works XD</p></blockquote>

<p>But this sample shows exactly what I wanted: <strong>Yes, it&#8217;s possible to feed an action with its own feed! Victory!</strong></p>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Ok all of that was really funky but is it useful in real projects? I don&#8217;t really know yet but it provides a great proof of the very reactive character of scalaz-stream and Play too!</p>

<p>I tend to like scalaz-stream and I feel more comfortable, more natural using Process than Iteratee right now&#8230; Maybe this is just an impression so I&#8217;ll keep cautious about my conclusions for now&#8230;</p>

<p>All of this code is just experimental so be aware about it. If you like it and see that it could be useful, tell me so that we create a real library from it!</p>

<p>Have Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,
Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,
Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,Fun,!</p>

<br/>


<br/>


<h2>PostScriptum</h2>

<h3><a name="iteratee-details">A few more details about Iteratees</a></h3>

<p>Here are a few things that bother me when I use Play Iteratee (you don&#8217;t have to agree, this is very subjective):</p>

<ul>
<li>Enumeratees are really powerful (maybe the most powerful part of the API) but they can be tricky: for ex, defining a new Enumeratee from scratch isn&#8217;t easy at first sight due to the signature of the Enumeratee itself, Enumeratee composes differently on left (with Enumerators) and on right (with Iteratees) and it can be strange at beginning&#8230;</li>
<li>Enumerators are not defined (when not using helpers) in terms of the data they produce but with respect to the way an Iteratee will consume the data they will produce. You must somewhat reverse your way of thinking which is not so natural.</li>
<li>Iteratees are great to produce one result by folding a stream of data but if you want to consume/cut/aggregate/re-emit the chunks, the code you write based on Iteratee/Enumeratee quickly becomes complex, hard to re-read and edge cases (error, end of stream) are hard to treat.</li>
<li>When you want to manipulate multiple streams together, zip/interleave them, you must write very complex code too.</li>
<li>End of iteration and Error management with Iteratees isn&#8217;t really clear IMHO and when you begin to compose Iteratees together, it becomes hard to know what will happen&#8230;</li>
<li>If you want to manipulate a stream with side-effecting, you can do it with Enumeratees but it&#8217;s not so obvious&#8230;</li>
</ul>


<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/07/11/play-autosource-datomisca/">Play AutoSource & Datomisca: Proofing the Concept on Datomic, a Schema DB</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-11T18:18:00+02:00" pubdate data-updated="true">Jul 11<span>th</span>, 2013</time>
        
         | <a href="/2013/07/11/play-autosource-datomisca/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>The code for all autosources &amp; sample apps can be found on Github <a href="https://github.com/mandubian/play-autosource/tree/master/datomisca">here</a></p>

<div class="well">
  <h3>Brand New Autosources</h3>
  Play AutoSource now have 2 more implementations : 
  <ul>
    <li><b><a href="http://www.datomic.com">Datomic</a> based on <a href="http://pellucidanalytics.github.io/datomisca/">Datomisca</a></b>, the Scala API I developed with Daniel James (<a href="https://twitter.com/dwhjames">@dwhjames</a>) sponsored by Pellucid Analytics & Zenexity which is presented in this article</li>
    <li><b><a href="http://www.couchbase.com/">CouchBase</a></b> contributed by Mathieu Ancelin <a href="https://twitter.com/TrevorReznik">@TrevorReznik</a></li>
  </ul>
</div>


<blockquote><p>One month ago, I&#8217;ve demo&#8217;ed the concept of Autosource for Play2/Scala with ReactiveMongo in <a href="http://mandubian.com/2013/06/11/play-autosource/">this article</a>. ReactiveMongo was the perfect target for this idea because it accepts Json structures almost natively for both documents manipulation and queries.</p>

<p>But how does the concept behave when applied on a DB for which data are constrained by a schema and for which queries aren&#8217;t Json.</p></blockquote>

<br/>


<h2>Using Datomisca-Autosource in your Play project</h2>

<p>Add following lines to your <code>project/Build.scala</code></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">mandubianRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;Mandubian repository snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/snapshots/&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Mandubian repository releases&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/releases/&quot;</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">appDependencies</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">main</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="nc">Project</span><span class="o">(</span><span class="n">appName</span><span class="o">,</span> <span class="n">appVersion</span><span class="o">,</span> <span class="n">appDependencies</span><span class="o">).</span><span class="n">settings</span><span class="o">(</span>
</span><span class='line'>  <span class="n">resolvers</span> <span class="o">++=</span> <span class="n">mandubianRepo</span><span class="o">,</span>
</span><span class='line'>  <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;play-autosource&quot;</span>   <span class="o">%%</span> <span class="s">&quot;datomisca&quot;</span>       <span class="o">%</span> <span class="s">&quot;0.1-SNAPSHOT&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Create your Model + Schema</h2>

<p>With ReactiveMongo Autosource, you could create a pure blob Autosource using <code>JsObject</code> without any supplementary information. But with Datomic, it&#8217;s not possible because Datomic forces to use a schema for your data.</p>

<p>We could create a schema and manipulate <code>JsObject</code> directly with Datomic and some Json validators. But I&#8217;m going to focus on the static models because this is the way people traditionally interact with a Schema-constrained DB.</p>

<p>Let&#8217;s create our model and schema.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// The Model (with characters pointing on Datomic named entities)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">characters</span><span class="k">:</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">DRef</span><span class="o">])</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The Schema written with Datomisca</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Person</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// Namespaces</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">person</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;person&quot;</span><span class="o">)</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">characters</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;person.characters&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Attributes</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span>       <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span><span class="o">,</span>       <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">)</span> <span class="o">.</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Person&#39;s name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">age</span>        <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span><span class="o">,</span>        <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span>   <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">)</span> <span class="o">.</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Person&#39;s age&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">characters</span> <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;characters&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span>    <span class="nc">Cardinality</span><span class="o">.</span><span class="n">many</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Person&#39;s characterS&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Characters named entities</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">violent</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;violent&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">weak</span>    <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;weak&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">clever</span>  <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;clever&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">dumb</span>    <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;dumb&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">stupid</span>  <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">characters</span> <span class="o">/</span> <span class="s">&quot;stupid&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Schema</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">schema</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">,</span> <span class="n">characters</span><span class="o">,</span>
</span><span class='line'>    <span class="n">violent</span><span class="o">,</span> <span class="n">weak</span><span class="o">,</span> <span class="n">clever</span><span class="o">,</span> <span class="n">dumb</span><span class="o">,</span> <span class="n">stupid</span>
</span><span class='line'>  <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Create Datomisca Autosource</h2>

<p>Now that we have our schema, let&#8217;s write the autosource.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.autosource.datomisca._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.modules.datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Implicits._</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.Play.current</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">models._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Person._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">DatomiscaAutoSourceController</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// gets the Datomic URI from application.conf</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="nc">DatomicPlugin</span><span class="o">.</span><span class="n">uri</span><span class="o">(</span><span class="s">&quot;mem&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// ugly DB initialization ONLY for test purpose</span>
</span><span class='line'>  <span class="nc">Datomic</span><span class="o">.</span><span class="n">createDatabase</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Datomic connection is required</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">implicit</span> <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'>  <span class="c1">// Datomic partition in which you store your entities</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">val</span> <span class="n">partition</span> <span class="k">=</span> <span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// more than ugly schema provisioning, ONLY for test purpose</span>
</span><span class='line'>  <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="n">schema</span><span class="o">),</span>
</span><span class='line'>    <span class="nc">Duration</span><span class="o">(</span><span class="s">&quot;10 seconds&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Implementing Json <-> Person <-> Datomic transformers</h2>

<p>If you compile previous code, you should have following error:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">could</span> <span class="n">not</span> <span class="n">find</span> <span class="k">implicit</span> <span class="n">value</span> <span class="k">for</span> <span class="n">parameter</span> <span class="n">datomicReader</span><span class="k">:</span> <span class="kt">datomisca.EntityReader</span><span class="o">[</span><span class="kt">models.Person</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually, Datomisca Autosource requires 4 elements to work:</p>

<ul>
<li><code>Json.Format[Person]</code> to convert <code>Person</code> instances from/to Json (network interface)</li>
<li><code>EntityReader[Person]</code> to convert <code>Person</code> instances from Datomic entities (Datomic interface)</li>
<li><code>PartialAddEntityWriter[Person]</code> to convert <code>Person</code> instances to Datomic entities (Datomic interface)</li>
<li><code>Reads[PartialAddEntity]</code> to convert Json to <code>PartialAddEntity</code> which is actually a simple map of fields/values to partially update an existing entity (one single field for ex).</li>
</ul>


<p>It might seem more complicated than in ReactiveMongo but there is nothing different. The autosource converts <code>Person</code> from/to Json and then converts <code>Person</code> from/to Datomic structure ie <code>PartialAddEntity</code>. In ReactiveMongo, the only difference is that it understands Json so well that static model becomes unnecessary sometimes ;)&#8230;</p>

<p>Let&#8217;s define those elements in <code>Person</code> companion object.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">Person</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'>  <span class="c1">// Classic Play2 Json Reads/Writes</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">personFormat</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">format</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Partial entity update : Json to PartialAddEntity Reads</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">partialUpdate</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">PartialAddEntity</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>    <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;name</span><span class="o">).</span><span class="n">read</span><span class="o">(</span><span class="n">readAttr</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nc">Person</span><span class="o">.</span><span class="n">name</span><span class="o">))</span> <span class="n">orElse</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">PartialAddEntity</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)))</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;age</span><span class="o">)</span> <span class="o">.</span><span class="n">read</span><span class="o">(</span><span class="n">readAttr</span><span class="o">[</span><span class="kt">Long</span><span class="o">](</span><span class="nc">Person</span><span class="o">.</span><span class="n">age</span><span class="o">))</span> <span class="n">orElse</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">PartialAddEntity</span><span class="o">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">empty</span><span class="o">)))</span>  <span class="n">and</span>
</span><span class='line'>    <span class="c1">// need to specify type because a ref/many can be a list of dref or entities so need to tell it explicitly</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;characters</span><span class="o">).</span><span class="n">read</span><span class="o">(</span> <span class="n">readAttr</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">DRef</span><span class="o">]](</span><span class="nc">Person</span><span class="o">.</span><span class="n">characters</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>    <span class="n">reduce</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Entity Reads (looks like Json combinators but it&#39;s Datomisca combinators)</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">entity2Person</span><span class="k">:</span> <span class="kt">EntityReader</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>    <span class="n">name</span>      <span class="o">.</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>   <span class="n">and</span>
</span><span class='line'>    <span class="n">age</span>       <span class="o">.</span><span class="n">read</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>     <span class="n">and</span>
</span><span class='line'>    <span class="n">characters</span><span class="o">.</span><span class="n">read</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">DRef</span><span class="o">]]</span>
</span><span class='line'>  <span class="o">)(</span><span class="nc">Person</span><span class="o">.</span><span class="n">apply</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// Entity Writes (looks like Json combinators but it&#39;s Datomisca combinators)</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">person2Entity</span><span class="k">:</span> <span class="kt">PartialAddEntityWriter</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>    <span class="n">name</span>      <span class="o">.</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>   <span class="n">and</span>
</span><span class='line'>    <span class="n">age</span>       <span class="o">.</span><span class="n">write</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>     <span class="n">and</span>
</span><span class='line'>    <span class="n">characters</span><span class="o">.</span><span class="n">write</span><span class="o">[</span><span class="kt">Set</span><span class="o">[</span><span class="kt">DRef</span><span class="o">]]</span>
</span><span class='line'>  <span class="o">)(</span><span class="nc">DatomicMapping</span><span class="o">.</span><span class="n">unlift</span><span class="o">(</span><span class="nc">Person</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now we have everything to work except a few configurations.</p>

<h3>Add AutoSource routes at beginning <code>conf/routes</code></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-&gt;</span>      <span class="o">/</span><span class="n">person</span>                     <span class="n">controllers</span><span class="o">.</span><span class="nc">Persons</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Create <code>conf/play.plugins</code> to initialize Datomisca Plugin</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="mi">400</span><span class="k">:</span><span class="kt">play.modules.datomisca.DatomicPlugin</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Append to <code>conf/application.conf</code> to initialize MongoDB connection</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">datomisca</span><span class="o">.</span><span class="n">uri</span><span class="o">.</span><span class="n">mem</span><span class="o">=</span><span class="s">&quot;datomic:mem://mem&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Insert your first 2 persons with Curl</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">25</span><span class="o">,</span> <span class="s">&quot;characters&quot;</span><span class="k">:</span> <span class="err">[&quot;</span><span class="kt">person.characters/stupid</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;person.characters/violent&quot;</span><span class="err">]</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/persons</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">21</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">17592186045423</span><span class="o">}</span> <span class="kt">-&gt;</span> <span class="kt">oh</span> <span class="kt">a</span> <span class="kt">Datomic</span> <span class="kt">ID</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">43</span><span class="o">,</span> <span class="s">&quot;characters&quot;</span><span class="k">:</span> <span class="err">[&quot;</span><span class="kt">person.characters/clever</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;person.characters/weak&quot;</span><span class="err">]</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/persons</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">21</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">17592186045425</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Querying is the biggest difference in Datomic</h3>

<p>In Datomic, you can&#8217;t do a <code>getAll</code> without providing a Datomic Query.</p>

<p>But what is a Datomic query? It&#8217;s inspired by <code>Datalog</code> which uses predicates to express the constraints on the searched entities. You can combine predicates together.</p>

<p>With Datomisca Autosource, you can directly send datalog queries in the query parameter <code>q</code> for GET or in body for POST with one restriction: your query can&#8217;t accept input parameters and must return only the entity ID. For ex:</p>

<p><code>[ :find ?e :where [ ?e :person/name "john"] ] --&gt; OK</code></p>

<p><code>[ :find ?e ?name :where [ ?e :person/name ?name] ] --&gt; KO</code></p>

<p>Let&#8217;s use it by finding all persons.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:text/plain&quot;</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">[</span><span class="kt">:find</span> <span class="kt">?e</span> <span class="kt">:where</span> <span class="o">[</span><span class="kt">?e</span> <span class="kt">:person/name</span><span class="o">]]</span><span class="sc">&#39; &#39;</span><span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/persons/find</span><span class="err">&#39;</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">231</span>
</span><span class='line'>
</span><span class='line'><span class="err">[</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span> <span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span> <span class="err">25</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;characters&quot;</span><span class="k">:</span> <span class="err">[</span>
</span><span class='line'>            <span class="err">&quot;</span><span class="kt">:person.characters/violent</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>            <span class="s">&quot;:person.characters/stupid&quot;</span>
</span><span class='line'>        <span class="err">]</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;id&quot;</span><span class="k">:</span> <span class="err">17592186045423</span>
</span><span class='line'>    <span class="o">},</span>
</span><span class='line'>    <span class="o">{</span>
</span><span class='line'>        <span class="s">&quot;name&quot;</span><span class="k">:</span> <span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;age&quot;</span><span class="k">:</span> <span class="err">43</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;characters&quot;</span><span class="k">:</span> <span class="err">[</span>
</span><span class='line'>            <span class="err">&quot;</span><span class="kt">:person.characters/clever</span><span class="err">&quot;</span><span class="o">,</span>
</span><span class='line'>            <span class="s">&quot;:person.characters/weak&quot;</span>
</span><span class='line'>        <span class="err">]</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;id&quot;</span><span class="k">:</span> <span class="err">17592186045425</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'><span class="err">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note the use of POST here instead of GET because Curl doesn&#8217;t like <code>[]</code> in URL even using <code>-g</code> option</p></blockquote>

<p>Now you can use all other routes provided by Autosource</p>

<h2>Autosource Standard Routes</h2>

<h3>Get / Find / Stream</h3>

<ul>
<li>GET /persons?&#8230;    -> Find by query</li>
<li>GET /persons/ID     -> Find by ID</li>
<li>GET /persons/stream -> Find by query &amp; stream result by page</li>
</ul>


<h3>Insert / Batch / Find</h3>

<ul>
<li>POST /persons + BODY -> Insert</li>
<li>POST /persons/find + BODY -> find by query (when query is too complex to be in a GET)</li>
<li>POST /persons/batch  + BODY -> batch insert (multiple)</li>
</ul>


<h3>Update / batch</h3>

<ul>
<li>PUT  /persons/ID   + BODY  -> Update by ID</li>
<li>PUT  /persons/ID/partial   + BODY  -> Update partially by ID</li>
<li>PUT  /persons/batch   -> batch update (multiple)</li>
</ul>


<h3>Delete / Batch</h3>

<ul>
<li>DELETE /persons/ID    -> delete by ID</li>
<li>DELETE /persons/batch + BODY -> batch delete (multiple)</li>
</ul>


<br/>


<br/>


<h2>Conclusion</h2>

<p>Play-Autosource&#8217;s ambition was to be DB agnostic (as much as possible) and showing that the concept can be applied to schemaless DB (ReactiveMongo &amp; CouchDB) and schema DB (Datomic) is a good sign it can work. Naturally, there are a few more elements to provide for Datomic than in ReactiveMongo but it&#8217;s useful anyway.</p>

<p>Thank to <a href="https://twitter.com/TrevorReznik">@TrevorReznik</a> for his contribution of CouchBase Autosource.</p>

<p>I hope to see soon one for Slick and a few more ;)</p>

<p>Have Autofun!</p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/07/04/json-interpolation-pattern-matching/">Play2 Json Interpolation & Pattern Matching</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-07-04T08:08:00+02:00" pubdate data-updated="true">Jul 4<span>th</span>, 2013</time>
        
         | <a href="/2013/07/04/json-interpolation-pattern-matching/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>EXPERIMENTAL / DRAFT</h4>

<br/>




<div class="well">
<p>Do you remember <code>JsPath</code> pattern matching presented in <a href="http://mandubian.com/2013/05/01/jspath-pattern-matching/">this article</a> ?</p>
<p>Let&#8217;s now go further with something that you should enjoy even more: <b>Json Interpolation &amp; Pattern Matching</b>.</p>

<p>I&#8217;ve had the idea of these features for some time in my mind but let&#8217;s render unto Caesar what is Caesar&#8217;s : <a href="http://rapture.io/jsonSupport">Rapture.io</a> proved that it could be done quite easily and I must say I <del>stole</del> got inspired by a few implementation details from them! (<i>specially the @inline implicit conversion for string interpolation class which is required due to a ValueClass limitation that should be removed in further Scala versions</i>)
</div>


<p>First of all, code samples as usual&#8230;</p>

<h2>Create JsValue using String interpolation</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;foo&quot; : &quot;bar&quot;, &quot;foo2&quot; : 123 }&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span> <span class="o">==</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;bar&quot;</span><span class="o">,</span> <span class="s">&quot;foo2&quot;</span> <span class="o">-&gt;</span> <span class="mi">123</span><span class="o">)</span>
</span><span class='line'><span class="n">res1</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;[ 1, true, &quot;foo&quot;, 345.234]&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">[</span><span class="err">1</span>,<span class="kt">true</span>,<span class="err">&quot;</span><span class="kt">foo</span><span class="err">&quot;</span>,<span class="err">345</span><span class="kt">.</span><span class="err">234</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span> <span class="o">==</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="mf">345.234</span><span class="o">)</span>
</span><span class='line'><span class="n">res2</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>Yes, pure Json in a string&#8230;</p>

<p>How does it work? Using <a href="http://docs.scala-lang.org/overviews/core/string-interpolation.html">String interpolation</a> introduced in Scala 2.10.0 and Jackson for the parsing&#8230;</p>

<p>In String interpolation, you can also put Scala variables directly in the interpolated string. You can do the same in Json interpolation.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">alpha</span> <span class="k">=</span> <span class="s">&quot;foo&quot;</span>
</span><span class='line'><span class="n">alpha</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">foo</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">beta</span> <span class="k">=</span> <span class="mi">123L</span>
</span><span class='line'><span class="n">beta</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="mi">123</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;alpha&quot; : &quot;$alpha&quot;, &quot;beta&quot; : $beta}&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;alpha&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">foo</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;beta&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">gamma</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'><span class="n">gamma</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsArray</span> <span class="o">=</span> <span class="o">[</span><span class="err">1</span>,<span class="err">2</span>,<span class="err">3</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">delta</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;key1&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;value1&quot;</span><span class="o">,</span> <span class="s">&quot;key2&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;value2&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">delta</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsObject</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">value1</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">value2</span><span class="err">&quot;</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">     |         {</span>
</span><span class='line'><span class="s">     |           &quot;alpha&quot; : &quot;$alpha&quot;,</span>
</span><span class='line'><span class="s">     |           &quot;beta&quot; : $beta,</span>
</span><span class='line'><span class="s">     |           &quot;gamma&quot; : $gamma,</span>
</span><span class='line'><span class="s">     |           &quot;delta&quot; : $delta,</span>
</span><span class='line'><span class="s">     |           &quot;eta&quot; : {</span>
</span><span class='line'><span class="s">     |             &quot;foo&quot; : &quot;bar&quot;,</span>
</span><span class='line'><span class="s">     |             &quot;foo2&quot; : [ &quot;bar21&quot;, 123, true, null ]</span>
</span><span class='line'><span class="s">     |           }</span>
</span><span class='line'><span class="s">     |         }</span>
</span><span class='line'><span class="s">     |       &quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;alpha&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">foo</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;beta&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;gamma&quot;</span><span class="k">:</span><span class="err">[1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="err">]</span><span class="o">,</span><span class="s">&quot;delta&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key1</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value1</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key2</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value2</span><span class="err">&quot;</span><span class="o">},</span><span class="s">&quot;eta&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">foo</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">foo2</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[</span><span class="err">&quot;</span><span class="kt">bar21</span><span class="err">&quot;</span>,<span class="err">123</span>,<span class="kt">true</span>,<span class="kt">null</span><span class="o">]}}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Please note that string variables must be put between <code>"..."</code> because without it the parser will complain.</em></p>

<p>Ok, so now it&#8217;s really trivial to write Json, isn&#8217;t it?</p>

<p>String interpolation just replaces the string you write in your code by some Scala code concatenating pieces of strings with variables as you would write yourself. Kind-of: <code>s"toto ${v1} tata" =&gt; "toto + v1 + " tata" + ...</code></p>

<p>But at compile-time, it doesn&#8217;t compile your String into Json: the Json parsing is done at runtime with string interpolation. So using Json interpolation doesn&#8217;t provide you with compile-time type safety and parsing for now.</p>

<blockquote><p>In the future, I may replace String interpolation by a real Macro which will also parse the string at compile-time. Meanwhile, if you want to rely on type-safety, go on using <code>Json.obj / Json.arr</code> API.</p></blockquote>

<br/>


<h2>Json pattern matching</h2>

<p>What is one of the first feature that you discover when learning Scala and that makes you say immediately: &#8220;Whoaa Cool feature&#8221;? <strong>Pattern Matching</strong>.</p>

<p>You can write:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">opt</span> <span class="k">=</span> <span class="nc">Option</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">opt</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">toto</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">opt</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">&quot;not empty option:$s&quot;</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">None</span>    <span class="k">=&gt;</span> <span class="s">&quot;empty option&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res2</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">not</span> <span class="n">empty</span> <span class="n">option</span><span class="k">:</span><span class="kt">toto</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// or direct variable assignement using pattern matching</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="nc">Some</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="k">=</span> <span class="n">opt</span>
</span><span class='line'><span class="n">s</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">toto</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why not doing this with Json?</p>

<p>And&#8230;. Here it is with Json pattern matching!!!</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;bar&quot;</span><span class="o">,</span> <span class="s">&quot;foo2&quot;</span> <span class="o">-&gt;</span> <span class="mi">123L</span><span class="o">)</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsObject</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;foo&quot; : $a, &quot;foo2&quot; : $b }&quot;&quot;&quot;</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">)</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res5</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[(</span><span class="kt">play.api.libs.json.JsValue</span>, <span class="kt">play.api.libs.json.JsValue</span><span class="o">)]</span> <span class="k">=</span>
</span><span class='line'><span class="nc">Some</span><span class="o">((</span><span class="s">&quot;bar&quot;</span><span class="o">,</span><span class="mi">123</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;foo&quot; : $a, &quot;foo2&quot; : $b}&quot;&quot;&quot;</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot; { &quot;foo&quot; : &quot;bar&quot;, &quot;foo2&quot; : 123 }&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">a</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="s">&quot;bar&quot;</span>
</span><span class='line'><span class="n">b</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="mi">123</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">json</span><span class="s">&quot;[ $v1, 2, $v2, 4 ]&quot;</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">,</span> <span class="mi">4</span><span class="o">)</span>
</span><span class='line'><span class="n">v1</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="mi">1</span>
</span><span class='line'><span class="n">v2</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="mi">3</span>
</span></code></pre></td></tr></table></div></figure>


<p>Magical?</p>

<p>Not at all&#8230; Just <code>unapplySeq</code> using the tool that enables this kind of Json manipulation as trees: <code>JsZipper</code>&#8230;</p>

<blockquote><p>The more I use JsZippers, the more I find fields where I can use them ;)</p></blockquote>

<br/>


<h2>More complex Json pattern matching</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{</span>
</span><span class='line'><span class="s">    &quot;key1&quot; : &quot;value1&quot;,</span>
</span><span class='line'><span class="s">    &quot;key2&quot; : [</span>
</span><span class='line'><span class="s">      &quot;alpha&quot;,</span>
</span><span class='line'><span class="s">      { &quot;foo&quot; : &quot;bar&quot;,</span>
</span><span class='line'><span class="s">        &quot;foo2&quot; : {</span>
</span><span class='line'><span class="s">          &quot;key21&quot; : &quot;value21&quot;,</span>
</span><span class='line'><span class="s">          &quot;key22&quot; : [ &quot;value221&quot;, 123, false ]</span>
</span><span class='line'><span class="s">        }</span>
</span><span class='line'><span class="s">      },</span>
</span><span class='line'><span class="s">      true,</span>
</span><span class='line'><span class="s">      123.45</span>
</span><span class='line'><span class="s">    ]</span>
</span><span class='line'><span class="s">  }&quot;&quot;&quot;</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">value1</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">alpha</span><span class="err">&quot;</span><span class="o">,{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key21</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value21</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key22</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[</span><span class="err">&quot;</span><span class="kt">value221</span><span class="err">&quot;</span>,<span class="err">123</span>,<span class="kt">false</span><span class="o">]}},</span><span class="kc">true</span><span class="o">,</span><span class="mf">123.45</span><span class="err">]</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{ &quot;key1&quot; : $v1, &quot;key2&quot; : [&quot;alpha&quot;, $v2, true, $v3] }&quot;&quot;&quot;</span> <span class="k">=</span> <span class="n">js</span>
</span><span class='line'><span class="n">v1</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="s">&quot;value1&quot;</span>
</span><span class='line'><span class="n">v2</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key21</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value21</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key22</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[</span><span class="err">&quot;</span><span class="kt">value221</span><span class="err">&quot;</span>,<span class="err">123</span>,<span class="kt">false</span><span class="o">]}}</span>
</span><span class='line'><span class="n">v3</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="mf">123.45</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{</span>
</span><span class='line'><span class="s">      &quot;key1&quot; : &quot;value1&quot;,</span>
</span><span class='line'><span class="s">      &quot;key2&quot; : [&quot;alpha&quot;, $v1, true, $v2]</span>
</span><span class='line'><span class="s">    }&quot;&quot;&quot;</span>   <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="n">res9</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[(</span><span class="kt">play.api.libs.json.JsValue</span>, <span class="kt">play.api.libs.json.JsValue</span><span class="o">)]</span> <span class="k">=</span>
</span><span class='line'><span class="nc">Some</span><span class="o">(({</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bar</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;foo2&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key21</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">value21</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key22</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[</span><span class="err">&quot;</span><span class="kt">value221</span><span class="err">&quot;</span>,<span class="err">123</span>,<span class="kt">false</span><span class="o">]}},</span><span class="mf">123.45</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// A non matching example maybe ? ;)</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span>  <span class="n">js</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">case</span> <span class="n">json</span><span class="s">&quot;&quot;&quot;{</span>
</span><span class='line'><span class="s">      &quot;key1&quot; : &quot;value1&quot;,</span>
</span><span class='line'><span class="s">      &quot;key2&quot; : [&quot;alpha&quot;, $v1, false, $v2]</span>
</span><span class='line'><span class="s">    }&quot;&quot;&quot;</span>   <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">v1</span><span class="o">,</span> <span class="n">v2</span><span class="o">)</span>
</span><span class='line'>    <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="n">res10</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[(</span><span class="kt">play.api.libs.json.JsValue</span>, <span class="kt">play.api.libs.json.JsValue</span><span class="o">)]</span> <span class="k">=</span> <span class="nc">None</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you like that, please tell it so that I know whether it&#8217;s worth pushing it to Play Framework!</p>

<br/>


<h2>Using these features right now in a Scala/SBT project</h2>

<p>These features are part of my experimental project JsZipper presented in <a href="http://mandubian.com/2013/05/01/JsZipper/">this article</a>.</p>

<p>To use it, add following lines to your SBT <code>Build.scala</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">ApplicationBuild</span> <span class="k">extends</span> <span class="nc">Build</span> <span class="o">{</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">mandubianRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;Mandubian repository snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/snapshots/&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;Mandubian repository releases&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/releases/&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">main</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="nc">Project</span><span class="o">(</span><span class="n">appName</span><span class="o">,</span> <span class="n">appVersion</span><span class="o">,</span> <span class="n">appDependencies</span><span class="o">).</span><span class="n">settings</span><span class="o">(</span>
</span><span class='line'>    <span class="n">resolvers</span> <span class="o">++=</span> <span class="n">mandubianRepo</span><span class="o">,</span>
</span><span class='line'>    <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>      <span class="s">&quot;play-json-zipper&quot;</span>  <span class="o">%%</span> <span class="s">&quot;play-json-zipper&quot;</span>    <span class="o">%</span> <span class="s">&quot;0.1-SNAPSHOT&quot;</span><span class="o">,</span>
</span><span class='line'>      <span class="o">...</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>In your Scala code, import following packages</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">syntax._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.functional.syntax._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.extensions._</span>
</span></code></pre></td></tr></table></div></figure>


<p>PatternMatch your fun!</p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/06/11/play-autosource/">Play AutoSource : 2&#8217;30 Kickstart Full REST & CRUD Datasource in Play App (Demo&#8217;ed With ReactiveMongo + AngularJS)</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-06-11T18:18:00+02:00" pubdate data-updated="true">Jun 11<span>th</span>, 2013</time>
        
         | <a href="/2013/06/11/play-autosource/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>EXPERIMENTAL / DRAFT</h4>

<p>The module code and sample app can be found on Github <a href="https://github.com/mandubian/play-autosource">here</a></p>

<br/>


<p>Here we go:</p>

<h3>0&#8217; : Create App</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">play2</span> <span class="k">new</span> <span class="n">auto</span><span class="o">-</span><span class="n">persons</span>
</span><span class='line'>       <span class="k">_</span>            <span class="k">_</span>
</span><span class='line'> <span class="k">_</span> <span class="nc">__</span> <span class="o">|</span> <span class="o">|</span> <span class="nc">__</span> <span class="k">_</span> <span class="k">_</span>  <span class="k">_</span><span class="o">|</span> <span class="o">|</span>
</span><span class='line'><span class="o">|</span> <span class="-Symbol">&#39;_</span> <span class="o">\|</span> <span class="o">|/</span> <span class="k">_</span><span class="err">&#39;</span> <span class="o">|</span> <span class="o">||</span> <span class="o">|</span><span class="k">_</span><span class="o">|</span>
</span><span class='line'><span class="o">|</span>  <span class="nc">__/|</span><span class="k">_</span><span class="o">|\</span><span class="nc">____|\__</span> <span class="o">(</span><span class="k">_</span><span class="o">)</span>
</span><span class='line'><span class="o">|</span><span class="k">_</span><span class="o">|</span>            <span class="o">|</span><span class="nc">__</span><span class="o">/</span>
</span><span class='line'>
</span><span class='line'><span class="n">play</span><span class="o">!</span> <span class="mf">2.1</span><span class="o">.</span><span class="mi">1</span> <span class="o">(</span><span class="n">using</span> <span class="nc">Java</span> <span class="mf">1.7</span><span class="o">.</span><span class="mi">0</span><span class="n">_21</span> <span class="n">and</span> <span class="nc">Scala</span> <span class="mf">2.10</span><span class="o">.</span><span class="mi">0</span><span class="o">),</span> <span class="n">http</span><span class="o">://</span><span class="n">www</span><span class="o">.</span><span class="n">playframework</span><span class="o">.</span><span class="n">org</span>
</span><span class='line'>
</span><span class='line'><span class="nc">The</span> <span class="k">new</span> <span class="n">application</span> <span class="n">will</span> <span class="n">be</span> <span class="n">created</span> <span class="n">in</span> <span class="o">/</span><span class="nc">Users</span><span class="o">/</span><span class="n">pvo</span><span class="o">/</span><span class="n">zenexity</span><span class="o">/</span><span class="n">workspaces</span><span class="o">/</span><span class="n">workspace_mandubian</span><span class="o">/</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span>
</span><span class='line'>
</span><span class='line'><span class="nc">What</span> <span class="n">is</span> <span class="n">the</span> <span class="n">application</span> <span class="n">name</span><span class="o">?</span> <span class="o">[</span><span class="kt">auto-persons</span><span class="o">]</span>
</span><span class='line'><span class="o">&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Which</span> <span class="n">template</span> <span class="k">do</span> <span class="n">you</span> <span class="n">want</span> <span class="n">to</span> <span class="n">use</span> <span class="k">for</span> <span class="k">this</span> <span class="k">new</span> <span class="n">application</span><span class="o">?</span>
</span><span class='line'>
</span><span class='line'>  <span class="mi">1</span>             <span class="o">-</span> <span class="nc">Create</span> <span class="n">a</span> <span class="n">simple</span> <span class="nc">Scala</span> <span class="n">application</span>
</span><span class='line'>  <span class="mi">2</span>             <span class="o">-</span> <span class="nc">Create</span> <span class="n">a</span> <span class="n">simple</span> <span class="nc">Java</span> <span class="n">application</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span> <span class="mi">1</span>
</span><span class='line'><span class="nc">OK</span><span class="o">,</span> <span class="n">application</span> <span class="n">auto</span><span class="o">-</span><span class="n">persons</span> <span class="n">is</span> <span class="n">created</span><span class="o">.</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Have</span> <span class="n">fun</span><span class="o">!</span>
</span></code></pre></td></tr></table></div></figure>


<h3>10&#8217; : edit project/Build.scala, add <code>play-autosource:reactivemongo</code> dependency</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">mandubianRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;Mandubian repository snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/snapshots/&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;Mandubian repository releases&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/releases/&quot;</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">appDependencies</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">()</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">main</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="nc">Project</span><span class="o">(</span><span class="n">appName</span><span class="o">,</span> <span class="n">appVersion</span><span class="o">,</span> <span class="n">appDependencies</span><span class="o">).</span><span class="n">settings</span><span class="o">(</span>
</span><span class='line'>  <span class="n">resolvers</span> <span class="o">++=</span> <span class="n">mandubianRepo</span><span class="o">,</span>
</span><span class='line'>  <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;play-autosource&quot;</span>   <span class="o">%%</span> <span class="s">&quot;reactivemongo&quot;</span>       <span class="o">%</span> <span class="s">&quot;0.1-SNAPSHOT&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;org.specs2&quot;</span>        <span class="o">%%</span> <span class="s">&quot;specs2&quot;</span>              <span class="o">%</span> <span class="s">&quot;1.13&quot;</span>        <span class="o">%</span> <span class="s">&quot;test&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;junit&quot;</span>              <span class="o">%</span> <span class="s">&quot;junit&quot;</span>               <span class="o">%</span> <span class="s">&quot;4.8&quot;</span>         <span class="o">%</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3>30&#8217; : Create new ReactiveMongo AutoSource Controller in app/Person.scala</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">package</span> <span class="nn">controllers</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.mvc._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// BORING IMPORTS</span>
</span><span class='line'><span class="c1">// Json</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.functional.syntax._</span>
</span><span class='line'><span class="c1">// Reactive JSONCollection</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.modules.reactivemongo.json.collection.JSONCollection</span>
</span><span class='line'><span class="c1">// Autosource</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.autosource.reactivemongo._</span>
</span><span class='line'><span class="c1">// AutoSource is Async so imports Scala Future implicits</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.Play.current</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// &gt;&gt;&gt; THE IMPORTANT PART &lt;&lt;&lt;</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">ReactiveMongoAutoSourceController</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>50&#8217; : Add AutoSource routes at beginning <code>conf/routes</code></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">-&gt;</span>      <span class="o">/</span><span class="n">person</span>                     <span class="n">controllers</span><span class="o">.</span><span class="nc">Persons</span>
</span></code></pre></td></tr></table></div></figure>


<h3>60&#8217; : Create <code>conf/play.plugins</code> to initialize ReactiveMongo Plugin</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="mi">400</span><span class="k">:</span><span class="kt">play.modules.reactivemongo.ReactiveMongoPlugin</span>
</span></code></pre></td></tr></table></div></figure>


<h3>70&#8217; : Append to <code>conf/application.conf</code> to initialize MongoDB connection</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">mongodb</span><span class="o">.</span><span class="n">uri</span> <span class="o">=</span><span class="s">&quot;mongodb://localhost:27017/persons&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>80&#8217; : Launch application</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span> <span class="n">play2</span> <span class="n">run</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Loading</span> <span class="n">project</span> <span class="n">definition</span> <span class="n">from</span> <span class="o">/.../</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">/</span><span class="n">project</span>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Set</span> <span class="n">current</span> <span class="n">project</span> <span class="n">to</span> <span class="n">auto</span><span class="o">-</span><span class="n">persons</span> <span class="o">(</span><span class="n">in</span> <span class="n">build</span> <span class="n">file</span><span class="o">:/.../</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">/)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Updating</span> <span class="o">{</span><span class="n">file</span><span class="o">:/.../</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">/}</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">...</span>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Done</span> <span class="n">updating</span><span class="o">.</span>
</span><span class='line'><span class="o">---</span> <span class="o">(</span><span class="nc">Running</span> <span class="n">the</span> <span class="n">application</span> <span class="n">from</span> <span class="nc">SBT</span><span class="o">,</span> <span class="n">auto</span><span class="o">-</span><span class="n">reloading</span> <span class="n">is</span> <span class="n">enabled</span><span class="o">)</span> <span class="o">---</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="n">play</span> <span class="o">-</span> <span class="nc">Listening</span> <span class="k">for</span> <span class="nc">HTTP</span> <span class="n">on</span> <span class="o">/</span><span class="mi">0</span><span class="k">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">0</span><span class="kt">:</span><span class="err">9000</span>
</span><span class='line'>
</span><span class='line'><span class="o">(</span><span class="kt">Server</span> <span class="kt">started</span><span class="o">,</span> <span class="kt">use</span> <span class="kt">Ctrl+D</span> <span class="kt">to</span> <span class="kt">stop</span> <span class="kt">and</span> <span class="kt">go</span> <span class="kt">back</span> <span class="kt">to</span> <span class="kt">the</span> <span class="kt">console...</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="nc">Compiling</span> <span class="mi">5</span> <span class="nc">Scala</span> <span class="n">sources</span> <span class="n">and</span> <span class="mi">1</span> <span class="nc">Java</span> <span class="n">source</span> <span class="n">to</span> <span class="o">/.../</span><span class="n">auto</span><span class="o">-</span><span class="n">persons</span><span class="o">/</span><span class="n">target</span><span class="o">/</span><span class="n">scala</span><span class="o">-</span><span class="mf">2.10</span><span class="o">/</span><span class="n">classes</span><span class="o">...</span>
</span><span class='line'><span class="o">[</span><span class="kt">warn</span><span class="o">]</span> <span class="n">there</span> <span class="n">were</span> <span class="mi">2</span> <span class="n">feature</span> <span class="n">warnings</span><span class="o">;</span> <span class="n">re</span><span class="o">-</span><span class="n">run</span> <span class="k">with</span> <span class="o">-</span><span class="n">feature</span> <span class="k">for</span> <span class="n">details</span>
</span><span class='line'><span class="o">[</span><span class="kt">warn</span><span class="o">]</span> <span class="n">one</span> <span class="n">warning</span> <span class="n">found</span>
</span><span class='line'><span class="o">[</span><span class="kt">success</span><span class="o">]</span> <span class="nc">Compiled</span> <span class="n">in</span> <span class="mi">6</span><span class="n">s</span>
</span></code></pre></td></tr></table></div></figure>


<h3>100&#8217; : Insert your first 2 persons with Curl</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">25</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">33</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;51</span><span class="kt">b868ef31d4002c0bac8ba4</span><span class="err">&quot;</span><span class="o">}</span> <span class="kt">-&gt;</span> <span class="kt">oh</span> <span class="kt">a</span> <span class="kt">BSONObjectId</span>
</span><span class='line'>
</span><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">43</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">33</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;51</span><span class="kt">b868fa31d4002c0bac8ba5</span><span class="err">&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>110&#8217; : Get all persons</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">118</span>
</span><span class='line'>
</span><span class='line'><span class="err">[</span>
</span><span class='line'>  <span class="o">{</span><span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">25</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;id&quot;</span><span class="k">:</span><span class="err">&quot;51</span><span class="kt">b868ef31d4002c0bac8ba4</span><span class="err">&quot;</span><span class="o">},</span>
</span><span class='line'>  <span class="o">{</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">43</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;id&quot;</span><span class="k">:</span><span class="err">&quot;51</span><span class="kt">b868fa31d4002c0bac8ba5</span><span class="err">&quot;</span><span class="o">}</span>
</span><span class='line'><span class="err">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>115&#8217; : Delete one person</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">DELETE</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/</span><span class="err">51</span><span class="kt">b868ef31d4002c0bac8ba4</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">33</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;51</span><span class="kt">b868ef31d4002c0bac8ba4</span><span class="err">&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>120&#8217; : Verify person was deleted</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">GET</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/</span><span class="err">51</span><span class="kt">b868ef31d4002c0bac8ba4</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">404</span> <span class="nc">Not</span> <span class="nc">Found</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">text/plain</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">37</span>
</span><span class='line'>
</span><span class='line'><span class="kt">ID</span> <span class="err">51</span><span class="kt">b868ef31d4002c0bac8ba4</span> <span class="kt">not</span> <span class="kt">found</span>
</span></code></pre></td></tr></table></div></figure>


<h3>125&#8217; : Update person</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">PUT</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">35</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/</span><span class="err">51</span><span class="kt">b868fa31d4002c0bac8ba5</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">33</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">id</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;51</span><span class="kt">b868fa31d4002c0bac8ba5</span><span class="err">&quot;</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>130&#8217; : Batch insert 2 persons (johnny &amp; tom) with more properties</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">[{</span> <span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">johnny</span><span class="err">&quot;</span>, <span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">15</span>, <span class="err">&quot;</span><span class="kt">address</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">city</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">Paris</span><span class="err">&quot;</span>, <span class="err">&quot;</span><span class="kt">street</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">rue</span> <span class="kt">quincampoix</span><span class="err">&quot;</span><span class="o">}</span> <span class="o">}</span>,<span class="o">{</span> <span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">tom</span><span class="err">&quot;</span>, <span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">3</span>, <span class="err">&quot;</span><span class="kt">address</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">city</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">Trifouilly</span><span class="err">&quot;</span>, <span class="err">&quot;</span><span class="kt">street</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">rue</span> <span class="kt">des</span> <span class="kt">accidents</span> <span class="kt">de</span> <span class="kt">poucettes</span><span class="err">&quot;</span><span class="o">}</span> <span class="o">}]</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/batch</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">8</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">nb</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">2</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>135&#8217; : Get all persons whose name begins by &#8220;john&#8221;</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">$regex</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">^john</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/find</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">175</span>
</span><span class='line'>
</span><span class='line'><span class="err">[</span>
</span><span class='line'>  <span class="o">{</span><span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">john</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">age</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">35</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;id&quot;</span><span class="k">:</span><span class="err">&quot;51</span><span class="kt">b868fa31d4002c0bac8ba5</span><span class="err">&quot;</span><span class="o">},</span>
</span><span class='line'>  <span class="o">{</span><span class="s">&quot;id&quot;</span><span class="k">:</span><span class="err">&quot;51</span><span class="kt">b86a1931d400bc01ac8ba8</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">johnny</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">15</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;address&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">city</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">Paris</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">street</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">rue</span> <span class="kt">quincampoix</span><span class="err">&quot;</span><span class="o">}}</span>
</span><span class='line'><span class="err">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3>140&#8217; : Delete all persons</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">DELETE</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person/batch</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">200</span> <span class="nc">OK</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">text/plain</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">7</span>
</span><span class='line'>
</span><span class='line'><span class="kt">deleted</span>
</span></code></pre></td></tr></table></div></figure>


<h3>145&#8217; : Take 5&#8217; rest</h3>

<br/>


<h3>150&#8217; : Done</h3>

<br/>


<br/>


<h2>So what was demonstrated here?</h2>

<p>With Play-Autosource, in a few lines, you obtain :</p>

<ul>
<li><strong>A backed abstract datasource (here implemented for <a href="http://www.reactivemongo.org">ReactiveMongo</a> but it could be implemented for other DBs)</strong></li>
<li><strong>All CRUD operations are exposed as pure REST services</strong></li>
<li><strong>The datasource is typesafe (here <code>JsObject</code> but we&#8217;ll show later that we can use any type)</strong></li>
</ul>


<p>It can be useful to kickstart any application in which you&#8217;re going to work iteratively on our data models in direct interaction with front-end.</p>

<p>It could also be useful to Frontend developers who need to bootstrap frontend code with Play Framework application backend. With <em>Autosource</em>, they don&#8217;t have to care about modelizing strictly a datasource on server-side and can dig into their client-side code quite quickly.</p>

<br/>


<br/>


<h2>Adding constraints &amp; validation</h2>

<blockquote><p>Now you tell me: &#8220;Hey that&#8217;s stupid, you store directly <code>JsObject</code> but my data are structured and must be validated before inserting them&#8221;</p></blockquote>

<p>Yes you&#8217;re right so let&#8217;s add some type constraints on our data:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">ReactiveMongoAutoSourceController</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// we validate the received Json as JsObject because the autosource type is JsObject</span>
</span><span class='line'>  <span class="c1">// and we add classic validations on types</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">val</span> <span class="n">reader</span> <span class="k">=</span> <span class="nc">__</span><span class="o">.</span><span class="n">read</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="n">keepAnd</span> <span class="o">(</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;age&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span><span class="nc">Reads</span><span class="o">.</span><span class="n">min</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="n">keepAnd</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">max</span><span class="o">(</span><span class="mi">117</span><span class="o">))</span>
</span><span class='line'>  <span class="o">).</span><span class="n">tupled</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Try it now:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">curl</span> <span class="o">-</span><span class="n">X</span> <span class="nc">POST</span> <span class="o">-</span><span class="n">d</span> <span class="err">&#39;</span><span class="o">{</span> <span class="s">&quot;nameXXX&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">bob</span><span class="err">&quot;</span><span class="o">,</span> <span class="s">&quot;age&quot;</span><span class="k">:</span><span class="err">25</span> <span class="o">}</span><span class="err">&#39;</span> <span class="o">--</span><span class="n">header</span> <span class="s">&quot;Content-Type:application/json&quot;</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="k">:</span><span class="err">9000</span><span class="kt">/person</span> <span class="kt">--include</span>
</span><span class='line'>
</span><span class='line'><span class="nc">HTTP</span><span class="o">/</span><span class="mf">1.1</span> <span class="mi">400</span> <span class="nc">Bad</span> <span class="nc">Request</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Type</span><span class="k">:</span> <span class="kt">application/json</span><span class="o">;</span> <span class="n">charset</span><span class="k">=</span><span class="n">utf</span><span class="o">-</span><span class="mi">8</span>
</span><span class='line'><span class="nc">Content</span><span class="o">-</span><span class="nc">Length</span><span class="k">:</span> <span class="err">62</span>
</span><span class='line'>
</span><span class='line'><span class="o">{</span><span class="err">&quot;</span><span class="kt">obj.name</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[{</span><span class="err">&quot;</span><span class="kt">msg</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">validate.error.missing-path</span><span class="err">&quot;</span>,<span class="err">&quot;</span><span class="kt">args</span><span class="err">&quot;</span><span class="kt">:</span><span class="o">[]}]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can add progressively constraints on your data in a few lines. With <code>AutoSource</code>, you don&#8217;t need to determine immediately the exact shape of your models and you can work with <code>JsObject</code> directly as long as you need. Sometimes, you&#8217;ll even discover that you don&#8217;t even need a structured model and <code>JsObject</code> will be enough. (<em>but I also advise to design a bit things before implementing ;)</em>)</p>

<blockquote><p>Keep in mind that our sample is based on an implementation for <em>ReactiveMongo</em> so using Json is natural. For other DB, other data structure might be more idiomatic&#8230;</p></blockquote>

<br/>


<br/>


<h2>Use typesafe models</h2>

<blockquote><p>Now you tell me: &#8220;Funny but but but <code>JsObject</code> is evil because it&#8217;s not strict enough. I&#8217;m a OO developer (maybe abused by ORM gurus when I was young) and my models are case-classes&#8230;&#8221;</p></blockquote>

<p>Yes you&#8217;re right, sometimes, you need more business logic or you want to separate concerns very strictly and your model will be shaped as case-classes.</p>

<p>So let&#8217;s replace our nice little <code>JsObject</code> by a more serious <code>case class</code>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// the model</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Person</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">age</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Person</span><span class="o">{</span>
</span><span class='line'>  <span class="c1">// the famous Json Macro which generates at compile-time a Reads[Person] in a one-liner</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">fmt</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">format</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The autosource... shorter than before</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">ReactiveMongoAutoSourceController</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note that I removed the validations I had introduced before because there are not useful anymore: using Json macros, I created an implicit <code>Format[Person]</code> which is used implicitly by AutoSource.</p>

<blockquote><p>So, now you can see why I consider AutoSource as a <em>typesafe datasource</em>.</p></blockquote>

<br/>


<br/>


<h2>Let&#8217;s be front-sexy with AngularJS</h2>

<p>You all know that <a href="http://www.angularjs.org/">AngularJS</a> is the new kid on the block and that you must use it if you want to be sexy nowadays.</p>

<p>I&#8217;m already sexy so I must be able to use it without understanding anything to it and that&#8217;s exactly what I&#8217;ve done: in 30mn without knowing anything about Angular (but a few concepts), I wrote a dumb CRUD front page plugged on my wonderful <code>AutoSource</code>.</p>

<br/>


<h3>Client DS in app/assets/javascripts/persons.js</h3>

<p>This is the most important part of this sample: we need to call our CRUD autosource endpoints from angularJS.</p>

<p>We are going to use <em>Angular resources</em> for it even if it&#8217;s not really the best feature of AngularJS. Anyway, in a few lines, it works pretty well in my raw case.</p>

<p><em>(thanks to Paul Dijou for reviewing this code because I repeat I don&#8217;t know angularJS at all and I wrote this in 20mn without trying to understand anything :D)</em></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='javascript'><span class='line'><span class="kd">var</span> <span class="nx">app</span> <span class="o">=</span>
</span><span class='line'>  <span class="c1">// injects ngResource</span>
</span><span class='line'>  <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span><span class="s2">&quot;app&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;ngResource&quot;</span><span class="p">])</span>
</span><span class='line'>  <span class="c1">// creates the Person factory backed by our autosource</span>
</span><span class='line'>  <span class="c1">// Please remark the url person/:id which will use transparently our CRUD AutoSource endpoints</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">factory</span><span class="p">(</span><span class="s1">&#39;Person&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;$resource&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$resource</span><span class="p">){</span>
</span><span class='line'>    <span class="k">return</span> <span class="nx">$resource</span><span class="p">(</span><span class="s1">&#39;person/:id&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="s2">&quot;id&quot;</span> <span class="o">:</span> <span class="s2">&quot;@id&quot;</span> <span class="p">});</span>
</span><span class='line'>  <span class="p">}])</span>
</span><span class='line'>  <span class="c1">// creates a controller</span>
</span><span class='line'>  <span class="p">.</span><span class="nx">controller</span><span class="p">(</span><span class="s2">&quot;PersonCtrl&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;$scope&quot;</span><span class="p">,</span> <span class="s2">&quot;Person&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">Person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">createForm</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// retrieves all persons</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// creates a person using createForm and refreshes list</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">create</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>      <span class="kd">var</span> <span class="nx">person</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Person</span><span class="p">({</span><span class="nx">name</span><span class="o">:</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">createForm</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="nx">age</span><span class="o">:</span> <span class="nx">$scope</span><span class="p">.</span><span class="nx">createForm</span><span class="p">.</span><span class="nx">age</span><span class="p">});</span>
</span><span class='line'>      <span class="nx">person</span><span class="p">.</span><span class="nx">$save</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">createForm</span> <span class="o">=</span> <span class="p">{};</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// removes a person and refreshes list</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">person</span><span class="p">.</span><span class="nx">$remove</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// updates a person and refreshes list</span>
</span><span class='line'>    <span class="nx">$scope</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">person</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>      <span class="nx">person</span><span class="p">.</span><span class="nx">$save</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
</span><span class='line'>        <span class="nx">$scope</span><span class="p">.</span><span class="nx">persons</span> <span class="o">=</span> <span class="nx">Person</span><span class="p">.</span><span class="nx">query</span><span class="p">();</span>
</span><span class='line'>      <span class="p">})</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'><span class="p">}]);</span>
</span></code></pre></td></tr></table></div></figure>


<h3>CRUD UI in index.scala.html</h3>

<p>Now let&#8217;s create our CRUD UI page using angular directives. We need to be able to:</p>

<ul>
<li>list persons</li>
<li>update/delete each person</li>
<li>create new persons</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>@(message: String)
</span><span class='line'>
</span><span class='line'>@main(&quot;Welcome to Play 2.1&quot;) {
</span><span class='line'>
</span><span class='line'>    <span class="nt">&lt;div</span> <span class="na">ng-controller=</span><span class="s">&quot;PersonCtrl&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>      <span class="c">&lt;!-- create form --&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;name&quot;</span><span class="nt">&gt;</span>name:<span class="nt">&lt;/label&gt;&lt;input</span> <span class="na">ng-model=</span><span class="s">&quot;createForm.name&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;age&quot;</span><span class="nt">&gt;</span>age:<span class="nt">&lt;/label&gt;&lt;input</span> <span class="na">ng-model=</span><span class="s">&quot;createForm.age&quot;</span> <span class="na">type=</span><span class="s">&quot;number&quot;</span><span class="nt">/&gt;</span>
</span><span class='line'>      <span class="nt">&lt;button</span> <span class="na">ng-click=</span><span class="s">&quot;create()&quot;</span><span class="nt">&gt;</span>Create new person<span class="nt">&lt;/button&gt;</span>
</span><span class='line'>      <span class="nt">&lt;hr/&gt;</span>
</span><span class='line'>      <span class="c">&lt;!-- List of persons with update/delete buttons --&gt;</span>
</span><span class='line'>      <span class="nt">&lt;table&gt;</span>
</span><span class='line'>      <span class="nt">&lt;thead&gt;&lt;th&gt;</span>name<span class="nt">&lt;/th&gt;&lt;th&gt;</span>age<span class="nt">&lt;/th&gt;&lt;td&gt;</span>actions<span class="nt">&lt;/td&gt;&lt;/thead&gt;</span>
</span><span class='line'>      <span class="nt">&lt;tbody</span> <span class="na">ng-repeat=</span><span class="s">&quot;person in persons&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;tr&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">ng-model=</span><span class="s">&quot;person.name&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;input</span> <span class="na">type=</span><span class="s">&quot;number&quot;</span> <span class="na">ng-model=</span><span class="s">&quot;person.age&quot;</span><span class="nt">/&gt;&lt;/td&gt;</span>
</span><span class='line'>          <span class="nt">&lt;td&gt;&lt;button</span> <span class="na">ng-click=</span><span class="s">&quot;update(person)&quot;</span><span class="nt">&gt;</span>Update<span class="nt">&lt;/button&gt;&lt;button</span> <span class="na">ng-click=</span><span class="s">&quot;remove(person)&quot;</span><span class="nt">&gt;</span>Delete<span class="nt">&lt;/button&gt;&lt;/td&gt;</span>
</span><span class='line'>        <span class="nt">&lt;/tr&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/tbody&gt;</span>
</span><span class='line'>      <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/div&gt;</span>
</span><span class='line'>
</span><span class='line'>}
</span></code></pre></td></tr></table></div></figure>


<h3>Import Angular in main.scala.html</h3>

<p>We need to import angularjs in our application and create angular application using <code>ng-app</code></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='html'><span class='line'>@(title: String)(content: Html)
</span><span class='line'>
</span><span class='line'><span class="cp">&lt;!DOCTYPE html&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="c">&lt;!-- please note the directive ng-app to initialize angular app--&gt;</span>
</span><span class='line'><span class="nt">&lt;html</span> <span class="na">ng-app=</span><span class="s">&quot;app&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>    <span class="nt">&lt;head&gt;</span>
</span><span class='line'>        <span class="nt">&lt;title&gt;</span>@title<span class="nt">&lt;/title&gt;</span>
</span><span class='line'>        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;stylesheet&quot;</span> <span class="na">media=</span><span class="s">&quot;screen&quot;</span> <span class="na">href=</span><span class="s">&quot;@routes.Assets.at(&quot;</span><span class="na">stylesheets</span><span class="err">/</span><span class="na">main</span><span class="err">.</span><span class="na">css</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;link</span> <span class="na">rel=</span><span class="s">&quot;shortcut icon&quot;</span> <span class="na">type=</span><span class="s">&quot;image/png&quot;</span> <span class="na">href=</span><span class="s">&quot;@routes.Assets.at(&quot;</span><span class="na">images</span><span class="err">/</span><span class="na">favicon</span><span class="err">.</span><span class="na">png</span><span class="err">&quot;)&quot;</span><span class="nt">&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;@routes.Assets.at(&quot;</span><span class="na">javascripts</span><span class="err">/</span><span class="na">jquery-1</span><span class="err">.</span><span class="na">9</span><span class="err">.</span><span class="na">0</span><span class="err">.</span><span class="na">min</span><span class="err">.</span><span class="na">js</span><span class="err">&quot;)&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;https://ajax.googleapis.com/ajax/libs/angularjs/1.1.5/angular-resource.min.js&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>
</span><span class='line'>        <span class="nt">&lt;script </span><span class="na">src=</span><span class="s">&quot;@routes.Assets.at(&quot;</span><span class="na">javascripts</span><span class="err">/</span><span class="na">person</span><span class="err">.</span><span class="na">js</span><span class="err">&quot;)&quot;</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
</span><span class='line'>    <span class="nt">&lt;/head&gt;</span>
</span><span class='line'>    <span class="nt">&lt;body&gt;</span>
</span><span class='line'>        @content
</span><span class='line'>    <span class="nt">&lt;/body&gt;</span>
</span><span class='line'><span class="nt">&lt;/html&gt;</span>
</span></code></pre></td></tr></table></div></figure>


<h2>What else??? Oh yes Security&#8230;</h2>

<blockquote><p>I know what you think: &#8220;Uhuh, the poor guy who exposes his DB directly on the network and who is able to delete everything without any security&#8221;</p></blockquote>

<p>Once again, you&#8217;re right. <em>(yes I know I love flattery)</em></p>

<p>Autosource is by default not secured in any way and actually I don&#8217;t really care about security because this is your job to secure your exposed APIs and there are so many ways to secure services that I prefer to let you choose the one you want.</p>

<p>Anyway, I&#8217;m a nice boy and I&#8217;m going to show you how you could secure the <code>DELETE</code> endpoint using the authentication action composition sample given in <a href="http://www.playframework.com/documentation/2.1.1/ScalaActionsComposition">Play Framework documentation</a>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// FAKE USER class to simulate a user extracted from DB.</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'><span class="k">object</span> <span class="nc">User</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">find</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">User</span><span class="o">(</span><span class="n">name</span><span class="o">))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Persons</span> <span class="k">extends</span> <span class="nc">ReactiveMongoAutoSourceController</span><span class="o">[</span><span class="kt">Person</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// The action composite directly copied for PlayFramework doc</span>
</span><span class='line'>  <span class="k">def</span> <span class="nc">Authenticated</span><span class="o">(</span><span class="n">action</span><span class="k">:</span> <span class="kt">User</span> <span class="o">=&gt;</span> <span class="nc">EssentialAction</span><span class="o">)</span><span class="k">:</span> <span class="kt">EssentialAction</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// Let&#39;s define a helper function to retrieve a User</span>
</span><span class='line'>    <span class="k">def</span> <span class="n">getUser</span><span class="o">(</span><span class="n">request</span><span class="k">:</span> <span class="kt">RequestHeader</span><span class="o">)</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">User</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>      <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="o">(</span><span class="s">&quot;user&quot;</span><span class="o">).</span><span class="n">flatMap</span><span class="o">(</span><span class="n">u</span> <span class="k">=&gt;</span> <span class="nc">User</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="n">u</span><span class="o">))</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>    <span class="c1">// Now let&#39;s define the new Action</span>
</span><span class='line'>    <span class="nc">EssentialAction</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="n">getUser</span><span class="o">(</span><span class="n">request</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">u</span> <span class="k">=&gt;</span> <span class="n">action</span><span class="o">(</span><span class="n">u</span><span class="o">)(</span><span class="n">request</span><span class="o">)).</span><span class="n">getOrElse</span> <span class="o">{</span>
</span><span class='line'>        <span class="nc">Done</span><span class="o">(</span><span class="nc">Unauthorized</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;persons&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// &gt;&gt;&gt; IMPORTANT PART &lt;&lt;&lt;</span>
</span><span class='line'>  <span class="c1">// We simply override the delete action</span>
</span><span class='line'>  <span class="c1">// If authenticated, we call the original action</span>
</span><span class='line'>  <span class="k">override</span> <span class="k">def</span> <span class="n">delete</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">BSONObjectID</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Authenticated</span> <span class="o">{</span> <span class="k">_</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">super</span><span class="o">.</span><span class="n">delete</span><span class="o">(</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">index</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="n">views</span><span class="o">.</span><span class="n">html</span><span class="o">.</span><span class="n">index</span><span class="o">(</span><span class="s">&quot;ok&quot;</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the login action which log any user</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">login</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="s">&quot;logged in&quot;</span><span class="o">).</span><span class="n">withSession</span><span class="o">(</span><span class="s">&quot;user&quot;</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the logout action which log out any user</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">logout</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="s">&quot;logged out&quot;</span><span class="o">).</span><span class="n">withNewSession</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing to complicated here.
If you need to add headers in your responses and params to querystring, it&#8217;s easy to wrap autosource actions. Please refer to Play Framework doc for more info&#8230;</p>

<blockquote><p>I won&#8217;t try it here, the article is already too long but it should work&#8230;</p></blockquote>

<br/>


<br/>


<h2>Play-Autosource is DB agnostic</h2>

<p><code>Play-Autosource</code> Core is independent of the DB and provides Reactive (Async/Nonblocking) APIs to fulfill PlayFramework requirements.</p>

<p>Naturally this 1st implementation uses <a href="http://www.reactivemongo.org">ReactiveMongo</a> which is one of the best sample of DB reactive driver. MongoDB fits very well in this concept too because document records are really compliant to JSON datasources.</p>

<p>But other implementations for other DB can be done and I count on you people to contribute them.</p>

<blockquote><p>DB implementation contributions are welcome (Play-Autosource is just <em>Apache2 licensed</em>) and AutoSource API are subject to evolutions if they appear to be erroneous.</p></blockquote>

<br/>


<br/>


<h2>Conclusion</h2>

<p>Play-Autosource provides a very fast &amp; lightweight way to create a REST CRUD typesafe datasource in your Play/Scala application. You can begin with blob data such as <code>JsObject</code> and then elaborate the model of your data progressively by adding constraints or types to it.</p>

<p>There would be many more things to say about <code>Play/Autosource</code>:</p>

<ul>
<li>you can also override writers to change output format</li>
<li>you have some alpha streaming API also</li>
<li>etc&#8230;</li>
</ul>


<p>There are also lots of features to improve/add because it&#8217;s still a very draft module.</p>

<p>If you like it and have ideas, don&#8217;t hesitate to discuss, to contribute, to improve etc&#8230;</p>

<p><code>curl -X POST -d "{ "coding" : "Have fun"} http://localhost:9000/developer</code></p>

<p>PS: Thanks to James Roper for his <a href="http://jazzy.id.au/default/2013/05/08/advanced_routing_in_play_framework.html">article about advanced routing in Play Framework which I copied shamefully XD</a></p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/05/01/reactive-json-crafting-jszipper-reactivemongo-webservice/">Reactive Json Crafting : JsZipper + ReactiveMongo + Multiple Async WS Calls</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-01T17:17:00+02:00" pubdate data-updated="true">May 1<span>st</span>, 2013</time>
        
         | <a href="/2013/05/01/reactive-json-crafting-jszipper-reactivemongo-webservice/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>EXPERIMENTAL / DRAFT</h4>

<p>The sample app can be found on Github <a href="https://github.com/mandubian/play-json-zipper/tree/master/samples/multiservices">here</a></p>

<br/>


<p>Hi again folks!</p>

<p>Now, you may certainly have realized I&#8217;m <a href="http://www.playframework.org">Play2.1</a> Json API advocate. But you may also have understood that I&#8217;m not interested in Json as an end in itself. What catches my attention is that it&#8217;s a versatile arborescent data structure that can be used in web server&amp;client, in DB such as <a href="http://reactivemongo.org">ReactiveMongo</a> and also when communicating between servers with WebServices.</p>

<p>So I keep exploring what can be done with Json (specially in the context of PlayFramework reactive architecture) and building the tools that are required to concretize my ideas.</p>

<div class="well">
<p>My last article introduced <a href="http://www.mandubian.com/2013/05/01/jspath-pattern-matching/">JsPath Pattern Matching</a> and I told you that I needed this tool to use it with JsZipper. It&#8217;s time to use it&#8230;</p>
<p>Here is why I want to do:</p>
<ul>
  <li><b>Build dynamically a Json structure by aggregating data obtained by calling several external WS</b> such as twitterAPI or github API or whatever API.</li>

  <li><b>Build this structure from a Json template stored in MongoDB</b> in which I will find the URL and params of WebServices to call.</li>

  <li><b>Use Play2.1/WS & ReactiveMongo reactive API</b> meaning resulting Json should be built in an asynchronous and non-blocking way.</li>

  <li><b>Use concept of JsZipper</b> introduced in my <a href="http://www.mandubian.com/2013/05/01/JsZipper/">previous article</a> to be able to modify efficiently Play2.1/Json immutable structures.</li>
</ul>
</div>


<blockquote><p>Please note that this idea and its implementation is just an exercise of style to study the idea and introduce technical concepts but naturally it might seem a bit fake. Moreover, keep in mind, JsZipper API is still draft&#8230;</p></blockquote>

<br/>


<h2>The idea of Json template</h2>

<p>Imagine I want to gather twitter user timeline and github user profile in a single Json object.</p>

<p>I also would like to:</p>

<ul>
<li>configure the URL of WS and query parameters to fetch data</li>
<li>customize the resulting Json structure</li>
</ul>


<p>Let&#8217;s use a <em>Json template</em> such as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;streams&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;twitter&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;url&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://localhost:9000/twitter/statuses/user_timeline&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;user_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;twitter_nick&quot;</span>
</span><span class='line'>    <span class="p">},</span>
</span><span class='line'>    <span class="nt">&quot;github&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>      <span class="nt">&quot;url&quot;</span> <span class="p">:</span> <span class="s2">&quot;http://localhost:9000/github/users&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="nt">&quot;user_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;github_nick&quot;</span>
</span><span class='line'>    <span class="p">}</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using the <code>url</code> and <code>user_id</code> found in <code>__\streams\twitter, I can call twitter API to fetch the stream of tweets and the same for</code>__\streams\github`. Finally I replace the content of each node as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="s">&quot;streams&quot;</span> <span class="k">:</span> <span class="o">{</span>
</span><span class='line'>    <span class="err">&quot;</span><span class="kt">twitter</span><span class="err">&quot;</span> <span class="kt">:</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// TWITTER USER TIMELINE HERE</span>
</span><span class='line'>    <span class="o">},</span>
</span><span class='line'>    <span class="s">&quot;github&quot;</span> <span class="k">:</span> <span class="o">{</span>
</span><span class='line'>      <span class="c1">// GITHUB USER PROFILE HERE</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Moreover, I&#8217;d like to store multiple templates like previous sample with multiple <code>user_id</code> to be able to retrieve multiple streams at the same time.</p>

<br/>


<h2>Creating Json template in Play/ReactiveMongo (v0.9)</h2>

<p>Recently, Stephane Godbillon has released <a href="http://reactivemongo.org">ReactiveMongo v0.9</a> with corresponding Play plugin. This version really improves and eases the way you can manipulate Json directly with Play &amp; Mongo from Scala.</p>

<p>Let&#8217;s store a few instance of previous templates using this API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// gets my mongo collection</span>
</span><span class='line'><span class="k">def</span> <span class="n">coll</span> <span class="k">=</span> <span class="n">db</span><span class="o">.</span><span class="n">collection</span><span class="o">[</span><span class="kt">JSONCollection</span><span class="o">](</span><span class="s">&quot;templates&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">provision</span> <span class="k">=</span> <span class="nc">Action</span> <span class="o">{</span> <span class="nc">Async</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">values</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>      <span class="s">&quot;streams&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>        <span class="s">&quot;twitter&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>          <span class="s">&quot;url&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;http://localhost:9000/twitter/statuses/user_timeline&quot;</span><span class="o">,</span>
</span><span class='line'>          <span class="s">&quot;user_id&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;twitter_nick1&quot;</span>
</span><span class='line'>        <span class="o">),</span>
</span><span class='line'>        <span class="s">&quot;github&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>          <span class="s">&quot;url&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;http://localhost:9000/github/users&quot;</span><span class="o">,</span>
</span><span class='line'>          <span class="s">&quot;user_id&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;github_nick1&quot;</span>
</span><span class='line'>        <span class="o">)</span>
</span><span class='line'>      <span class="o">)</span>
</span><span class='line'>    <span class="o">),</span>
</span><span class='line'>    <span class="o">...</span> <span class="n">more</span> <span class="n">templates</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">coll</span><span class="o">.</span><span class="n">bulkInsert</span><span class="o">(</span><span class="n">values</span><span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">nb</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">Ok</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;nb&quot;</span><span class="o">-&gt;</span><span class="n">nb</span><span class="o">))</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="o">}</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hard isn&#8217;t it?</p>

<p>Note that I use <code>localhost</code> URL because with real Twitter/Github API I would need OAuth2 tokens and this would be a pain for this sample :)</p>

<br/>


<br/>


<h2>Reactive Json crafting</h2>

<p>Now, let&#8217;s do the real job i.e the following steps:</p>

<ul>
<li>retrieve the template(s) from Mongo using ReactiveMongo <code>JsonCollection</code></li>
<li>call the WebServices to fetch the data using Play Async WS</li>
<li>update the Json template(s) using Monadic JsZipper <code>JsZipperM[Future]</code></li>
</ul>


<p>The interesting technical points here are that:</p>

<ul>
<li>ReactiveMongo is async so we get <code>Future[JsValue]</code></li>
<li>Play/WS is Async so we get also <code>Future[JsValue]</code></li>
<li>We need to call multiple WS so we have a <code>Seq[Future[JsValue]]</code></li>
</ul>


<p>We could use Play/Json transformers presented in a <a href="http://www.mandubian.com/2012/10/29/unveiling-play-2-dot-1-json-api-part3-json-transformers/">previous article</a> but knowing that you have to manage Futures and multiple WS calls, it would create quite complicated code.</p>

<p>Here is where Monadic JsZipper becomes interesting:</p>

<ul>
<li><p><code>JsZipper</code> allows modifying immutable JsValue which is already cool</p></li>
<li><p><code>JsZipperM[Future]</code> allows modifying <code>JsValue</code> in the future and it&#8217;s even better!</p></li>
</ul>


<p>Actually the real power of JsZipper (<em>besides being able to modify/delete/create a node in immutable Json tree</em>) is to transform a Json tree into a Stream of nodes that it can traverse in depth, in width or whatever you need.</p>

<br/>


<h3>Less code with WS sequential calls</h3>

<p>Here is the code because you&#8217;ll see how easy it is:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// a helper to call WS</span>
</span><span class='line'><span class="k">def</span> <span class="n">callWSFromTemplate</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span> <span class="k">=</span>
</span><span class='line'>  <span class="nc">WS</span><span class="o">.</span><span class="n">url</span><span class="o">((</span><span class="n">value</span> <span class="o">\</span> <span class="s">&quot;url&quot;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>
</span><span class='line'>    <span class="o">.</span><span class="n">withQueryString</span><span class="o">(</span> <span class="s">&quot;user_id&quot;</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">value</span> <span class="o">\</span> <span class="s">&quot;user_id&quot;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">)</span>
</span><span class='line'>    <span class="o">.</span><span class="n">get</span><span class="o">().</span><span class="n">map</span><span class="o">{</span> <span class="n">resp</span> <span class="k">=&gt;</span> <span class="n">resp</span><span class="o">.</span><span class="n">json</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// calling WS sequentially</span>
</span><span class='line'><span class="k">def</span> <span class="n">dataSeq</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">{</span>
</span><span class='line'>  <span class="nc">Async</span><span class="o">{</span>
</span><span class='line'>    <span class="k">for</span><span class="o">{</span>
</span><span class='line'>      <span class="n">templates</span> <span class="k">&lt;-</span> <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">()).</span><span class="n">cursor</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">].</span><span class="n">toList</span>   <span class="c1">// retrieves templates from Mongo</span>
</span><span class='line'>      <span class="n">updated</span>   <span class="k">&lt;-</span> <span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">templates</span><span class="o">).</span><span class="n">updateAllM</span><span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="o">(</span><span class="k">_</span> <span class="o">\</span> <span class="s">&quot;twitter&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">callWSFromTemplate</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="o">(</span><span class="k">_</span> <span class="o">\</span> <span class="s">&quot;github&quot;</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span>  <span class="k">=&gt;</span> <span class="n">callWSFromTemplate</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span>             <span class="k">=&gt;</span> <span class="nc">Future</span><span class="o">.</span><span class="n">successful</span><span class="o">(</span><span class="n">value</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">yield</span> <span class="nc">Ok</span><span class="o">(</span><span class="n">updated</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note:</p>

<ul>
<li><p><code>Json.toJson(templates)</code> transforms a <code>List[JsObject]</code> into <code>JsArray</code> because we want to manipulate pure <code>JsValue</code> with <code>JsZipperM[Future]</code>.</p></li>
<li><p><code>.updateAllM( (JsPath, JsValue) =&gt; Future[JsValue] )</code> is a wrapper API hiding the construction of a <code>JsZipperM[Future]</code>: once built, the `JsZipperM[Future] traverses the Json tree and for each node, it calls the provided function <em>flatMapping</em> on Futures before going to next node. This makes the calls to WS sequential and not parallel.</p></li>
<li><p><code>case (_ \ "twitter", value)</code> : yes here is the JsPath pattern matching and imagine the crazy stuff you can do mixing Json traversal and pattern matching ;)</p></li>
<li><p><code>Async</code> means the embedded code will return <code>Future[Result]</code> but remember that it DOESN&#8217;T mean the <code>Action</code> is synchronous/blocking because in Play, everything is Asynchronous/non-blocking by default.</p></li>
</ul>


<p>Then you could tell me that this is cool but the WS are not called in parallel but sequentially. Yes it&#8217;s true but imagine that it&#8217;s less than 10 lines of code and could even be reduced. Yet, here is the parallelized version&#8230;</p>

<br/>


<h3>Parallel WS calls</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">dataPar</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">{</span>
</span><span class='line'>  <span class="nc">Async</span><span class="o">{</span>
</span><span class='line'>    <span class="n">coll</span><span class="o">.</span><span class="n">find</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">()).</span><span class="n">cursor</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">].</span><span class="n">toList</span><span class="o">.</span><span class="n">flatMap</span><span class="o">{</span> <span class="n">templates</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="c1">// converts List[JsObject] into JsArray</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">jsonTemplates</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">templates</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// gathers all nodes that need to be updated</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">nodes</span> <span class="k">=</span> <span class="n">jsonTemplates</span><span class="o">.</span><span class="n">findAll</span><span class="o">{</span>
</span><span class='line'>        <span class="k">case</span> <span class="o">(</span><span class="k">_</span> <span class="o">\</span> <span class="s">&quot;twitter&quot;</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="k">_</span> <span class="o">\</span> <span class="s">&quot;github&quot;</span><span class="o">,</span> <span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">true</span>
</span><span class='line'>        <span class="k">case</span> <span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="kc">false</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>      <span class="c1">// launches WS calls in parallel and updates original JsArray</span>
</span><span class='line'>      <span class="nc">Future</span><span class="o">.</span><span class="n">traverse</span><span class="o">(</span><span class="n">nodes</span><span class="o">){</span>
</span><span class='line'>        <span class="k">case</span> <span class="o">(</span><span class="n">path</span><span class="o">@(</span><span class="k">_</span> <span class="o">\</span> <span class="s">&quot;twitter&quot;</span><span class="o">),</span> <span class="n">value</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">callWSFromTemplate</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="n">map</span><span class="o">(</span> <span class="n">resp</span> <span class="k">=&gt;</span> <span class="n">path</span> <span class="o">-&gt;</span> <span class="n">resp</span> <span class="o">)</span>
</span><span class='line'>        <span class="k">case</span> <span class="o">(</span><span class="n">path</span><span class="o">@(</span><span class="k">_</span> <span class="o">\</span> <span class="s">&quot;github&quot;</span><span class="o">),</span> <span class="n">value</span><span class="o">)</span>  <span class="k">=&gt;</span> <span class="n">callWSFromTemplate</span><span class="o">(</span><span class="n">value</span><span class="o">).</span><span class="n">map</span><span class="o">(</span> <span class="n">resp</span> <span class="k">=&gt;</span> <span class="n">path</span> <span class="o">-&gt;</span> <span class="n">resp</span> <span class="o">)</span>
</span><span class='line'>      <span class="o">}.</span><span class="n">map</span><span class="o">{</span> <span class="n">pathvalues</span> <span class="k">=&gt;</span> <span class="nc">Ok</span><span class="o">(</span><span class="n">jsonTemplates</span><span class="o">.</span><span class="n">set</span><span class="o">(</span><span class="n">pathvalues</span><span class="k">:_</span><span class="kt">*</span><span class="o">))</span> <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that:</p>

<ul>
<li><p><code>jsonTemplates.findAll( filter: (JsPath, JsValue) =&gt; Boolean )</code> traverses the Json tree and returns a <code>Stream[(JsPath, JsValue)]</code> containing the filtered nodes. This is not done with <code>Future</code> because we want to get all nodes now to be able to launch all WS calls in parallel.</p></li>
<li><p><code>Future.traverse(nodes)(T =&gt; Future[T])</code> traverses the filtered values and calls all WS in parallel.</p></li>
<li><p><code>case (path@(_ \ "twitter"), value)</code> is just JsPath pattern matching once again keeping track of full path to be able to return it with the value <code>path -&gt; resp</code> for next point.</p></li>
<li><p><code>jsonTemplates.set( (JsPath, JsValue)* )</code> finally updates all values at given path. Note how easy it is to update multiple values at multiple paths.</p></li>
</ul>


<p>A bit less elegant than the sequential case but not so much.</p>

<br/>


<br/>


<h2>Conclusion</h2>

<p>This sample is a bit stupid but you can see the potential of mixing those different tools together.</p>

<p>Alone, JsZipper and JsPath pattern matching provides very powerful ways of manipulating Json that Reads/Writes can&#8217;t do easily.</p>

<p>When you add reactive API on top of that, JsZipper becomes really interesting and elegant.</p>

<p>The sample app can be found on Github <a href="https://github.com/mandubian/play-json-zipper/tree/master/samples/multiservices">here</a></p>

<p>Have JsZipperM[fun]!</p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/05/01/jspath-pattern-matching/">Play2 Json Path Pattern Matching</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-01T17:17:00+02:00" pubdate data-updated="true">May 1<span>st</span>, 2013</time>
        
         | <a href="/2013/05/01/jspath-pattern-matching/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>EXPERIMENTAL / DRAFT</h4>

<br/>




<div class="well">
<p>While experimenting <b>Play21/Json Zipper</b> in my <a href="http://www.mandubian.com/2013/05/01/JsZipper/">previous article</a>, I needed to match patterns on <code>JsPath</code> and decided to explore a bit this topic.</p>
<p>This article just presents my experimentations on <code>JsPath</code> pattern matching so that people interested in the topic can tell me if they like it or not and what they would add or remove. So don&#8217;t hesitate to let comments about it.</p>
<p>If the result is satisfying, I&#8217;ll propose it to Play team ;)</p>
</div>


<p>Let&#8217;s go to samples as usual.</p>

<h2>Very simple pattern matching</h2>

<h3><code>match/scale</code>-style</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">__</span> <span class="o">\</span> <span class="n">key</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">key</span><span class="o">)</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res0</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="n">toto</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>val</code>-style</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="k">_</span> <span class="o">\</span> <span class="n">toto</span> <span class="k">=</span> <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span>
</span><span class='line'><span class="n">toto</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">toto</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that I don&#8217;t write <code>val __ \ toto = __ \ "toto"</code> <em>(2x Underscore)</em> as you would expect.</p>

<p>Why? Let&#8217;s write it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="nc">__</span> <span class="o">\</span> <span class="n">toto</span> <span class="k">=</span> <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">20</span><span class="k">:</span> <span class="kt">error:</span> <span class="kt">recursive</span> <span class="kt">value</span> <span class="kt">x$1</span> <span class="kt">needs</span> <span class="k">type</span>
</span><span class='line'><span class="kt">val</span> <span class="k">__</span> <span class="kt">\</span> <span class="kt">toto</span> <span class="o">=</span> <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually, 1st <code>__</code> is considered as a variable to be affected by Scala compiler. Then the variable <code>__</code> appears on left and right side which is not good.</p>

<p>So I use <code>_</code> to ignore its value because I know it&#8217;s <code>__</code>. If I absolutely wanted to match with <code>__</code>, you would have written:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="nc">JsPath</span> <span class="o">\</span> <span class="n">toto</span> <span class="k">=</span> <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span>
</span><span class='line'><span class="n">toto</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">toto</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>Pattern matching with indexed path</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="o">(</span><span class="k">_</span> <span class="o">\</span> <span class="n">toto</span><span class="o">)@@</span><span class="n">idx</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span>
</span><span class='line'><span class="n">toto</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">toto</span>
</span><span class='line'><span class="n">idx</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span><span class="o">)@@</span><span class="n">idx</span> <span class="k">=&gt;</span> <span class="nc">Some</span><span class="o">(</span><span class="n">idx</span><span class="o">)</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span>      <span class="k">=&gt;</span> <span class="nc">None</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res1</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the usage of <code>@@</code> operator that you can dislike. <em>I didn&#8217;t find anything better for now but if anyone has a better idea, please give it to me ;)</em></p>

<br/>


<h2>Pattern matching the last element of a JsPath</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="k">_</span> <span class="o">\</span> <span class="n">last</span> <span class="k">=</span> <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;alpha&quot;</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span> <span class="o">\</span> <span class="s">&quot;delta&quot;</span> <span class="o">\</span> <span class="s">&quot;gamma&quot;</span>
</span><span class='line'><span class="n">last</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gamma</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using <code>_</code>, I ignore everything before <code>gamma</code> node.</p>

<br/>


<h2>Matching only the first element and the last one</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="k">_</span> <span class="o">\</span> <span class="n">first</span> <span class="o">\?\</span> <span class="n">last</span> <span class="k">=</span> <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;alpha&quot;</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span> <span class="o">\</span> <span class="s">&quot;gamma&quot;</span> <span class="o">\</span> <span class="s">&quot;delta&quot;</span>
</span><span class='line'><span class="n">first</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">alpha</span>
</span><span class='line'><span class="n">last</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">delta</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="o">(</span><span class="k">_</span> <span class="o">\</span> <span class="n">first</span><span class="o">)@@</span><span class="n">idx</span> <span class="o">\?\</span> <span class="n">last</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;alpha&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span> <span class="o">\</span> <span class="s">&quot;gamma&quot;</span> <span class="o">\</span> <span class="s">&quot;delta&quot;</span>
</span><span class='line'><span class="n">first</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">alpha</span>
</span><span class='line'><span class="n">idx</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'><span class="n">last</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">delta</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note the <code>\?\</code> operator which is also a temporary choice: I didn&#8217;t want to choose <code>\\</code> ause <code>\?\</code> operator only works in the case where you match between the first and the last element of the path and not between anything and anything&#8230;</p>

<br/>


<h2>A few more complex cases</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="o">(</span><span class="k">_</span> <span class="o">\</span> <span class="n">alpha</span><span class="o">)@@</span><span class="n">idx</span> <span class="o">\</span> <span class="n">beta</span> <span class="o">\</span> <span class="n">gamma</span> <span class="o">\</span> <span class="n">delta</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;alpha&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span> <span class="o">\</span> <span class="s">&quot;gamma&quot;</span> <span class="o">\</span> <span class="s">&quot;delta&quot;</span>
</span><span class='line'><span class="n">alpha</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">alpha</span>
</span><span class='line'><span class="n">idx</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'><span class="n">beta</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">beta</span>
</span><span class='line'><span class="n">gamma</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gamma</span>
</span><span class='line'><span class="n">delta</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">delta</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="o">(</span><span class="k">_</span> <span class="o">\</span> <span class="n">alpha</span><span class="o">)@@</span><span class="n">idx</span> <span class="o">\</span> <span class="k">_</span> <span class="o">\</span> <span class="k">_</span> <span class="o">\</span> <span class="n">delta</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;alpha&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span> <span class="o">\</span> <span class="s">&quot;gamma&quot;</span> <span class="o">\</span> <span class="s">&quot;delta&quot;</span>
</span><span class='line'><span class="n">alpha</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">alpha</span>
</span><span class='line'><span class="n">idx</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'><span class="n">delta</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">delta</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="k">_</span><span class="o">@@</span><span class="n">idx</span> <span class="o">\?\</span> <span class="n">gamma</span> <span class="o">\</span> <span class="n">delta</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;alpha&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span> <span class="o">\</span> <span class="s">&quot;gamma&quot;</span> <span class="o">\</span> <span class="s">&quot;delta&quot;</span>
</span><span class='line'><span class="n">idx</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">2</span>
</span><span class='line'><span class="n">gamma</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">gamma</span>
</span><span class='line'><span class="n">delta</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">delta</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;alpha&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span> <span class="o">\</span> <span class="s">&quot;gamma&quot;</span> <span class="o">\</span> <span class="s">&quot;delta&quot;</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span><span class="o">@@</span><span class="mi">2</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span> <span class="o">\</span> <span class="s">&quot;gamma&quot;</span> <span class="o">\</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">true</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">false</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res4</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>And finally using regex?</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">pattern</span> <span class="k">=</span> <span class="s">&quot;&quot;&quot;al(\d)*pha&quot;&quot;&quot;</span><span class="o">.</span><span class="n">r</span>
</span><span class='line'><span class="n">pattern</span><span class="k">:</span> <span class="kt">scala.util.matching.Regex</span> <span class="o">=</span> <span class="n">al</span><span class="o">(\</span><span class="n">d</span><span class="o">)*</span><span class="n">pha</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;foo&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="o">\</span> <span class="s">&quot;al1234pha&quot;</span> <span class="o">\</span> <span class="s">&quot;bar&quot;</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;foo&quot;</span><span class="o">)@@</span><span class="n">idx</span> <span class="o">\</span> <span class="n">pattern</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">\</span> <span class="s">&quot;bar&quot;</span> <span class="k">=&gt;</span> <span class="kc">true</span>
</span><span class='line'>  <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="kc">false</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res6</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="o">=</span> <span class="kc">true</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, I think we can provide more features and now I&#8217;m going to use it with my <code>JsZipper</code> stuff in my next article ;)</p>

<p>If you like it, tell it!</p>

<p>Have fun!</p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/05/01/JsZipper/">JsZipper : Play2 Json Advanced (& Monadic) Manipulations</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-05-01T17:17:00+02:00" pubdate data-updated="true">May 1<span>st</span>, 2013</time>
        
         | <a href="/2013/05/01/JsZipper/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>EXPERIMENTAL / DRAFT</h4>

<br/>


<p>The code is available on Github project <a href="https://github.com/mandubian/play-json-zipper">play-json-zipper</a></p>

<div class="well">
<p><b><code>JsZipper</code> is a new tool allowing much more complex & powerful manipulations of Json structures for Play2/Json Scala API (not a part of Play2 core for now)</b></p>
<p><code>JsZipper</code> is inspired by the <a href="http://en.wikipedia.org/wiki/Zipper_(data_structure)">Zipper</a> concept introduced by <a href="http://en.wikipedia.org/wiki/Grard_Huet">Grard Huet</a> in 1997.</p>

<p>The Zipper allows to update immutable traversable structures in an efficient way. Json is an immutable AST so it fits well. FYI, the Zipper behaves like a loupe that walks through each node of the AST (left/right/up/down) while keeping aware of the nodes on its left, its right and its upper. The interesting idea behind the loupe is that when it targets a node, it can modify and even delete the focused node. The analogy to the pants zipper is quite good too because when it goes down the tree, it behaves as if it was <i>opening</i> the tree to be able to drive the loupe through all nodes and when it goes up, it <i>closes</i> back the tree&#8230; I won&#8217;t tell more here, it would be too long.</p>

<p><code>JsZipper</code> is a specific interpretation of Zipper concept for Play/Json API based on :
<ul><li>Scala Streams to go through / update / construct Json AST nodes in a lazy way</li>
<li>Monadic aspects to provide <i>funnier</i> ways of manipulating the Json AST (plz see below)</li>
</ul>
</p>
<br/>
<p><i>Please note, <code>JsZipper</code> is not an end in itself but a tool useful to provide new API to manipulate Json.</i></p>
</div>


<p>Let&#8217;s go to samples because it explains everything.</p>

<p>We&#8217;ll use following Json Object.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;key1&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;key11&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;TO_FIND&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;key12&quot;</span> <span class="o">-&gt;</span> <span class="mi">123L</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;key13&quot;</span> <span class="o">-&gt;</span> <span class="nc">JsNull</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;key2&quot;</span> <span class="o">-&gt;</span> <span class="mi">123</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key3&quot;</span> <span class="o">-&gt;</span> <span class="kc">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key4&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="s">&quot;TO_FIND&quot;</span><span class="o">,</span> <span class="mf">345.6</span><span class="o">,</span> <span class="s">&quot;test&quot;</span><span class="o">,</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;key411&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;key4111&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;TO_FIND&quot;</span><span class="o">)))</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsObject</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key11</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key12</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key13&quot;</span><span class="k">:</span><span class="kt">null</span><span class="o">},</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key3&quot;</span><span class="k">:</span><span class="kt">true</span><span class="o">,</span><span class="s">&quot;key4&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="mf">345.6</span><span class="o">,</span><span class="s">&quot;test&quot;</span><span class="o">,{</span><span class="s">&quot;key411&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key4111</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">]</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h1>Basic manipulations</h1>

<h2>Setting multiple paths/values</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span><span class="o">.</span><span class="n">set</span><span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key4&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">JsNumber</span><span class="o">(</span><span class="mf">765.23</span><span class="o">),</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span> <span class="o">\</span> <span class="s">&quot;key12&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">res1</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key11</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key12</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">toto</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;key13&quot;</span><span class="k">:</span><span class="kt">null</span><span class="o">},</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key3&quot;</span><span class="k">:</span><span class="kt">true</span><span class="o">,</span><span class="s">&quot;key4&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="mf">345.6</span><span class="o">,</span><span class="mf">765.23</span><span class="o">,{</span><span class="s">&quot;key411&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key4111</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">]</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Deleting multiple paths/values</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span><span class="o">.</span><span class="n">delete</span><span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key4&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">),</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span> <span class="o">\</span> <span class="s">&quot;key12&quot;</span><span class="o">),</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span> <span class="o">\</span> <span class="s">&quot;key13&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">res2</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key11</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">},</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key3&quot;</span><span class="k">:</span><span class="kt">true</span><span class="o">,</span><span class="s">&quot;key4&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="mf">345.6</span><span class="o">,{</span><span class="s">&quot;key411&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key4111</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">]</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Finding paths/values according to a filter</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span><span class="o">.</span><span class="n">findAll</span><span class="o">(</span> <span class="k">_</span> <span class="o">==</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;TO_FIND&quot;</span><span class="o">)</span> <span class="o">).</span><span class="n">toList</span>
</span><span class='line'><span class="n">res5</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">play.api.libs.json.JsPath</span>, <span class="kt">play.api.libs.json.JsValue</span><span class="o">)]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span>
</span><span class='line'>  <span class="o">(/</span><span class="n">key1</span><span class="o">/</span><span class="n">key11</span><span class="o">,</span><span class="s">&quot;TO_FIND&quot;</span><span class="o">),</span>
</span><span class='line'>  <span class="o">(/</span><span class="n">key4</span><span class="o">(</span><span class="mi">0</span><span class="o">),</span><span class="s">&quot;TO_FIND&quot;</span><span class="o">),</span>
</span><span class='line'>  <span class="o">(/</span><span class="n">key4</span><span class="o">(</span><span class="mi">3</span><span class="o">)/</span><span class="n">key411</span><span class="o">/</span><span class="n">key4111</span><span class="o">,</span><span class="s">&quot;TO_FIND&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Updating values according to a filter based on value</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span><span class="o">.</span><span class="n">updateAll</span><span class="o">(</span> <span class="o">(</span><span class="k">_:</span><span class="kt">JsValue</span><span class="o">)</span> <span class="o">==</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;TO_FIND&quot;</span><span class="o">)</span> <span class="o">){</span> <span class="n">js</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">JsString</span><span class="o">(</span><span class="n">str</span><span class="o">)</span> <span class="k">=</span> <span class="n">js</span>
</span><span class='line'>  <span class="nc">JsString</span><span class="o">(</span><span class="n">str</span> <span class="o">+</span> <span class="s">&quot;2&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res6</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key11</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND2</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key12</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key13&quot;</span><span class="k">:</span><span class="kt">null</span><span class="o">},</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key3&quot;</span><span class="k">:</span><span class="kt">true</span><span class="o">,</span><span class="s">&quot;key4&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">TO_FIND2</span><span class="err">&quot;</span><span class="o">,</span><span class="mf">345.6</span><span class="o">,</span><span class="s">&quot;test&quot;</span><span class="o">,{</span><span class="s">&quot;key411&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key4111</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND2</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">]</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Updating values according to a filter based on path+value</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span><span class="o">.</span><span class="n">updateAll</span><span class="o">{</span> <span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">js</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="nc">JsPathExtension</span><span class="o">.</span><span class="n">hasKey</span><span class="o">(</span><span class="n">path</span><span class="o">)</span> <span class="o">==</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;key4111&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">}{</span> <span class="o">(</span><span class="n">path</span><span class="o">,</span> <span class="n">js</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">JsString</span><span class="o">(</span><span class="n">str</span><span class="o">)</span> <span class="k">=</span> <span class="n">js</span>
</span><span class='line'>  <span class="nc">JsString</span><span class="o">(</span><span class="n">str</span> <span class="o">+</span> <span class="n">path</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">last</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">res1</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key11</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key12</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key13&quot;</span><span class="k">:</span><span class="kt">null</span><span class="o">},</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key3&quot;</span><span class="k">:</span><span class="kt">true</span><span class="o">,</span><span class="s">&quot;key4&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="mf">345.6</span><span class="o">,</span><span class="s">&quot;test&quot;</span><span class="o">,{</span><span class="s">&quot;key411&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key4111</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND/key4111</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">]</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating an object from scratch</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">build</span> <span class="k">=</span> <span class="nc">JsExtensions</span><span class="o">.</span><span class="n">buildJsObject</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span> <span class="o">\</span> <span class="s">&quot;key11&quot;</span> <span class="o">-&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span> <span class="o">\</span> <span class="s">&quot;key12&quot;</span> <span class="o">-&gt;</span> <span class="nc">JsNumber</span><span class="o">(</span><span class="mi">123L</span><span class="o">),</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key2&quot;</span><span class="o">)(</span><span class="mi">0</span><span class="o">)</span>      <span class="o">-&gt;</span> <span class="nc">JsBoolean</span><span class="o">(</span><span class="kc">true</span><span class="o">),</span>
</span><span class='line'>  <span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key3&quot;</span>           <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">2</span><span class="o">,</span> <span class="mi">3</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">build</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key11</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">toto</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key12</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">123</span><span class="o">},</span><span class="s">&quot;key3&quot;</span><span class="k">:</span><span class="err">[1</span><span class="o">,</span><span class="mi">2</span><span class="o">,</span><span class="mi">3</span><span class="err">]</span><span class="o">,</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">[</span><span class="kt">true</span><span class="err">]</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h1>Let&#8217;s be funnier with Monads now</h1>

<blockquote><p>Let&#8217;s use <code>Future</code> as our Monad because it&#8217;s&#8230; coooool to do things in the future ;)</p></blockquote>

<p>Imagine you call several services returning <code>Future[JsValue]</code> and you want to build/update a <code>JsObject</code> from it.
Until now, if you wanted to do that with Play2/Json, it was quite tricky and required some code.</p>

<p>Here is what you can do now.</p>

<h2>Updating multiple <em>FUTURE</em> values at given paths</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">maybeJs</span> <span class="k">=</span> <span class="n">js</span><span class="o">.</span><span class="n">setM</span><span class="o">[</span><span class="kt">Future</span><span class="o">](</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key4&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span>        <span class="o">-&gt;</span> <span class="n">future</span><span class="o">{</span> <span class="nc">JsNumber</span><span class="o">(</span><span class="mf">765.23</span><span class="o">)</span> <span class="o">},</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span> <span class="o">\</span> <span class="s">&quot;key12&quot;</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">future</span><span class="o">{</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">maybeJs</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">play.api.libs.json.JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="k">@</span><span class="mi">6</span><span class="n">beb722d</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">maybeJs</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">(</span><span class="s">&quot;2 seconds&quot;</span><span class="o">))</span>
</span><span class='line'><span class="n">res4</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key11</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key12</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">toto</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;key13&quot;</span><span class="k">:</span><span class="kt">null</span><span class="o">},</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key3&quot;</span><span class="k">:</span><span class="kt">true</span><span class="o">,</span><span class="s">&quot;key4&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">,</span><span class="mf">345.6</span><span class="o">,</span><span class="mf">765.23</span><span class="o">,{</span><span class="s">&quot;key411&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key4111</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">]</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Update multiple <em>FUTURE</em> values according to a filter</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">maybeJs</span> <span class="k">=</span> <span class="n">js</span><span class="o">.</span><span class="n">updateAllM</span><span class="o">[</span><span class="kt">Future</span><span class="o">](</span> <span class="o">(</span><span class="k">_:</span><span class="kt">JsValue</span><span class="o">)</span> <span class="o">==</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;TO_FIND&quot;</span><span class="o">)</span> <span class="o">){</span> <span class="n">js</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">future</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="nc">JsString</span><span class="o">(</span><span class="n">str</span><span class="o">)</span> <span class="k">=</span> <span class="n">js</span>
</span><span class='line'>    <span class="nc">JsString</span><span class="o">(</span><span class="n">str</span> <span class="o">+</span> <span class="s">&quot;2&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">maybeJs</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">play.api.libs.json.JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="k">@</span><span class="mi">35</span><span class="n">a4bb1a</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">maybeJs</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">(</span><span class="s">&quot;2 seconds&quot;</span><span class="o">))</span>
</span><span class='line'><span class="n">res6</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;key1&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key11</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND2</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">key12</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key13&quot;</span><span class="k">:</span><span class="kt">null</span><span class="o">},</span><span class="s">&quot;key2&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">,</span><span class="s">&quot;key3&quot;</span><span class="k">:</span><span class="kt">true</span><span class="o">,</span><span class="s">&quot;key4&quot;</span><span class="k">:</span><span class="err">[&quot;</span><span class="kt">TO_FIND2</span><span class="err">&quot;</span><span class="o">,</span><span class="mf">345.6</span><span class="o">,</span><span class="s">&quot;test&quot;</span><span class="o">,{</span><span class="s">&quot;key411&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">key4111</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">TO_FIND2</span><span class="err">&quot;</span><span class="o">}}</span><span class="err">]</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Creating a <em>FUTURE</em> JsArray from scratch</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">maybeArr</span> <span class="k">=</span> <span class="nc">JsExtensions</span><span class="o">.</span><span class="n">buildJsArrayM</span><span class="o">[</span><span class="kt">Future</span><span class="o">](</span>
</span><span class='line'>  <span class="n">future</span> <span class="o">{</span> <span class="nc">JsNumber</span><span class="o">(</span><span class="mf">123.45</span><span class="o">)</span> <span class="o">},</span>
</span><span class='line'>  <span class="n">future</span> <span class="o">{</span> <span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">maybeArr</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">play.api.libs.json.JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="k">@</span><span class="mi">220</span><span class="n">d48e4</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">maybeArr</span><span class="o">,</span> <span class="nc">Duration</span><span class="o">(</span><span class="s">&quot;2 seconds&quot;</span><span class="o">))</span>
</span><span class='line'><span class="n">res0</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">[</span><span class="err">123</span><span class="kt">.</span><span class="err">45</span>,<span class="err">&quot;</span><span class="kt">toto</span><span class="err">&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s still draft so it can be improved but if you like it, don&#8217;t hesitate to comment and if people like it, it could become a part of Play Framework itself</p>

<p>Have fun!</p>

<br/>


<br/>


<br/>


<br/>

</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/04/13/FP-survey/">Quick Survey About Most Basic Concept in Functional Programming</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-13T14:14:00+02:00" pubdate data-updated="true">Apr 13<span>th</span>, 2013</time>
        
         | <a href="/2013/04/13/FP-survey/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>The question</h4>

<div class="well">
<h3>What&#8217;s the first word coming in your mind when I say:</h3>
<h3><i>&#8220;Most basic concept of functional programming?&#8221;</i></h3>
</div>








<script src="http://d3js.org/d3.v3.js"></script>




<script>
var width = 800,
    height = 600;

var cluster = d3.layout.cluster()
    .size([height, width - 560]);

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });

var content = document.getElementsByClassName("entry-content")[0];

var svg = d3.select(content).append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(50,0)");

d3.json("/javascripts/survey1-results.json", function(error, json) {
  if (error) return console.warn(error);
  console.log(json);

  var nodes = cluster.nodes(json),
      links = cluster.links(nodes);

  var link = svg.selectAll(".link")
      .data(links)
      .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);

  var node = svg.selectAll(".node")
      .data(nodes)
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })

  node.append("circle")
      .attr("r", 4.5);

  node.append("text")
      .attr("dx", function(d) { return d.children ? -8 : 8; })
      .attr("dy", 3)
      .style("text-anchor", function(d) { return d.children ? "end" : "start"; })
      .text(function(d) { return d.name; });
});

d3.select(self.frameElement).style("height", height + "px");

</script>


<blockquote><p>For info, this dendrograph was pre-computed using Play2.1 app sucking Tweets &amp; filtering/grouping the results in a very manual-o-matic way</p></blockquote>

<p>Have Fun(ctional)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/03/12/datomisca-shapeless-hlist/">Shapeless HList Schema-Type-Safe Conversion to Datomisca/Datomic Entities</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-12T12:12:00+01:00" pubdate data-updated="true">Mar 12<span>th</span>, 2013</time>
        
         | <a href="/2013/03/12/datomisca-shapeless-hlist/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>The code is on github project <a href="https://github.com/mandubian/shapotomic">shapotomic</a></p></blockquote>

<h4>Datomisca is a Scala API for Datomic DB</h4>

<p>If you want to know more about Datomisca/Datomic schema go to my <a href="http://mandubian.com/2013/03/04/datomisca-schema/">recent article</a>. What&#8217;s interesting with Datomisca schema is that they are statically typed allowing some compiler validations and type inference.</p>

<h4><a href="https://github.com/milessabin/shapeless">Shapeless HList</a> are heterogenous polymorphic lists</h4>

<p>HList are able to contain different types of data and able to keep tracks of these types.</p>

<br/>


<div class="well">
<b><p>This project is an experience trying to :</p>

<ul>
  <li>convert HList to/from Datomic Entities</li>
  <li>check HList types against schema at compile-time</li>
</ul></b>
</div>


<p>This uses :</p>

<ul>
<li>Datomisca type-safe schema</li>
<li>Shapeless HList</li>
<li>Shapeless polymorphic functions</li>
</ul>


<p>Please note that we don&#8217;t provide any <code>Iso[From, To]</code> since there is no isomorphism here.
Actually, there are 2 monomorphisms (injective):</p>

<ul>
<li><code>HList   =&gt; AddEntity</code> to provision an entity</li>
<li><code>DEntity =&gt; HList</code> when retrieving entity</li>
</ul>


<p>We would need to implement <code>Mono[From, To]</code> certainly for our case&#8230;</p>

<h2>Code sample</h2>

<h3>Create schema based on <code>HList</code></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Koala Schema</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Koala</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">object</span> <span class="nc">ns</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">koala</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;koala&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// schema attributes</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span>        <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">age</span>         <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s age&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">trees</span>       <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;trees&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">many</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s trees&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the schema in HList form</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">schema</span> <span class="k">=</span> <span class="n">name</span> <span class="o">::</span> <span class="n">age</span> <span class="o">::</span> <span class="n">trees</span> <span class="o">::</span> <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the datomic facts corresponding to schema </span>
</span><span class='line'>  <span class="c1">// (need specifying upper type for shapeless conversion to list)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">txData</span> <span class="k">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toList</span><span class="o">[</span><span class="kt">Operation</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Provision schema</span>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">txData</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span> <span class="o">...</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Validate <code>HList</code> against Schema</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// creates a Temporary ID &amp; keeps it for resolving entity after insertion</span>
</span><span class='line'><span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span><span class='line'><span class="c1">// creates an HList entity </span>
</span><span class='line'><span class="k">val</span> <span class="n">hListEntity</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">id</span> <span class="o">::</span> <span class="s">&quot;kaylee&quot;</span> <span class="o">::</span> <span class="mi">3L</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">Set</span><span class="o">(</span> <span class="s">&quot;manna_gum&quot;</span><span class="o">,</span> <span class="s">&quot;tallowwood&quot;</span> <span class="o">)</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// validates and converts at compile-time this HList against schema</span>
</span><span class='line'><span class="n">hListEntity</span><span class="o">.</span><span class="n">toAddEntity</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">schema</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// If you remove a field from HList and try again, the compiler fails</span>
</span><span class='line'><span class="k">val</span> <span class="n">badHListEntity</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">id</span> <span class="o">::</span> <span class="s">&quot;kaylee&quot;</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">Set</span><span class="o">(</span> <span class="s">&quot;manna_gum&quot;</span><span class="o">,</span> <span class="s">&quot;tallowwood&quot;</span> <span class="o">)</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">badHListEntity</span><span class="o">.</span><span class="n">toAddEntity</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">schema</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">23</span><span class="k">:</span> <span class="kt">error:</span> <span class="kt">could</span> <span class="kt">not</span> <span class="kt">find</span> <span class="kt">implicit</span> <span class="kt">value</span> <span class="kt">for</span> <span class="kt">parameter</span> <span class="kt">pull:</span>
</span><span class='line'>  <span class="n">shapotomic</span><span class="o">.</span><span class="nc">SchemaCheckerFromHList</span><span class="o">.</span><span class="nc">Pullback2</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">datomisca.TempId</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">scala.collection.immutable.Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span>,
</span><span class='line'>  <span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">datomisca.RawAttribute</span><span class="o">[</span><span class="kt">datomisca.DString</span>,<span class="kt">datomisca.CardinalityOne.</span><span class="k">type</span><span class="o">]</span>,
</span><span class='line'>  <span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">datomisca.RawAttribute</span><span class="o">[</span><span class="kt">datomisca.DLong</span>,<span class="kt">datomisca.CardinalityOne.</span><span class="k">type</span><span class="o">]</span>,
</span><span class='line'>  <span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">datomisca.RawAttribute</span><span class="o">[</span><span class="kt">datomisca.DString</span>,<span class="kt">datomisca.CardinalityMany.</span><span class="k">type</span><span class="o">]</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span>,<span class="kt">datomisca.AddEntity</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>The compiler error is a bit weird at first but if you take a few seconds to read it, you&#8217;ll see that there is nothing hard about it, it just says:</em></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">I</span> <span class="n">can</span><span class="-Symbol">&#39;t</span> <span class="n">convert</span>
</span><span class='line'><span class="o">(</span><span class="nc">TempId</span> <span class="o">::)</span> <span class="nc">String</span>             <span class="o">::</span> <span class="nc">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>      <span class="o">::</span> <span class="nc">HNil</span> <span class="k">=&gt;</span>
</span><span class='line'>            <span class="nc">Attr</span><span class="o">[</span><span class="kt">DString</span>, <span class="kt">one</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Attr</span><span class="o">[</span><span class="kt">DLong</span>, <span class="kt">one</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Attr</span><span class="o">[</span><span class="kt">DString</span>, <span class="kt">many</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Convert <code>DEntity</code> to static-typed <code>HList</code> based on schema</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">e</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">resolveEntity</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// rebuilds HList entity from DEntity statically typed by schema</span>
</span><span class='line'><span class="k">val</span> <span class="n">postHListEntity</span> <span class="k">=</span> <span class="n">e</span><span class="o">.</span><span class="n">toHList</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">schema</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Explicitly typing the value to show that the compiler builds the right typed HList from schema</span>
</span><span class='line'><span class="k">val</span> <span class="n">validateHListEntityType</span><span class="k">:</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span> <span class="k">=</span> <span class="n">postHListEntity</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Using <code>HList</code> with compile-time schema validation is quite interesting because it provides a very basic and versatile data structure to manipulate Datomic entities in a type-safe style.</p>

<p>Moreover, as Datomic pushes atomic data manipulation (simple facts instead of full entities), it&#8217;s really cool to use <code>HList</code> instead of rigid static structure such as case-class.</p>

<p>For ex:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">simplerOp</span> <span class="k">=</span> <span class="o">(</span><span class="n">id</span> <span class="o">::</span> <span class="s">&quot;kaylee&quot;</span> <span class="o">::</span> <span class="mi">5L</span><span class="o">).</span><span class="n">toAddEntity</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">name</span> <span class="o">::</span> <span class="nc">Koala</span><span class="o">.</span><span class="n">age</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Have TypedFun</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/03/04/datomisca-schema/">Datomisca Delicatessen - Emulsion of Scala Type-safety in Datomic Schema</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-04T00:00:00+01:00" pubdate data-updated="true">Mar 4<span>th</span>, 2013</time>
        
         | <a href="/2013/03/04/datomisca-schema/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One more step in our progressive unveiling of <a href="http://pellucidanalytics.github.com/datomisca/index.html">Datomisca</a>, our opensource Scala API (sponsored by <a href="http://www.pellucidanalytics.com">Pellucid</a> &amp; <a href="http://www.zenexity.com">Zenexity</a>) trying to enhance <a href="http://www.datomic.com">Datomic</a> experience for Scala developers&#8230;</p>

<p>After evoking <a href="./2013-02-10-datomisca-query.html">queries compiled by Scala macros in previous article</a> and then <a href="./2013-02-18-datomisca-fact-operations.html">reactive transaction &amp; fact operation API</a>, let&#8217;s explain <strong>how <em>Datomisca</em> manages Datomic schema attributes</strong>.</p>

<br/>


<h1>Datomic Schema Reminders</h1>

<p>As explained in previous articles, Datomic stores lots of atomic facts called <code>datoms</code> which are constituted of <code>entity-id</code>, <code>attribute</code>, <code>value</code> and <code>transaction-id</code>.</p>

<p>An attribute is just a namespaced keyword <code>:&lt;namespace&gt;.&lt;nested-namespace&gt;/&lt;name&gt; such as</code>:person.address/street`:</p>

<ul>
<li><code>person.address</code> is just a hierarchical namespace <code>person</code> -> <code>address</code></li>
<li><code>street</code> is the name of the attribute</li>
</ul>


<p>It&#8217;s cool to provision all thoses atomic pieces of information but what if we provision non existing attribute with bad format, type, &#8230;? Is there a way to control the format of data in Datomic?</p>

<blockquote><p>In a less strict way than SQL, Datomic provides schema facility allowing to constrain the accepted attributes and their type values.</p></blockquote>

<h2>Schema attribute definition</h2>

<p>Datomic schema just defines the accepted attributes and some constraints on those attributes. Each schema attribute can be defined by following fields:</p>

<h3>value type</h3>

<ul>
<li><strong>basic types</strong> : <code>string</code>, <code>long</code>, <code>float</code>, <code>bigint</code>, <code>bigdec</code>, <code>boolean</code>, <code>instant</code>, <code>uuid</code>, <code>uri</code>, <code>bytes</code> (yes NO <code>int</code>).</li>
<li><strong>reference</strong> : in Datomic you can reference other entities (these are lazy relations not as strict as the ones in RDBMS)</li>
</ul>


<h3>cardinality</h3>

<ul>
<li><strong>one</strong> : one-to-one relation if you want an analogy with RDBMS</li>
<li><strong>many</strong> : one-to-many relation</li>
</ul>


<blockquote><p>Please note that in Datomic, all relations are bidirectional even for one-to-many.</p></blockquote>

<h3>optional constraints:</h3>

<ul>
<li>unicity</li>
<li>index creation</li>
<li>fulltext indexation</li>
<li>a few more exotic ones that you&#8217;ll find in <a href="http://docs.datomic.com/schema.html">Datomic doc about schema</a></li>
</ul>


<h2>Schema attributes are entities</h2>

<p>The schema validation is applied at fact insertion and allows to prevent from inserting unknown attributes or bad value types. But how are schema attributes defined?</p>

<p><strong>Actually, schema attributes are themselves entities. </strong></p>

<p>Remember, in previous article, I had introduced entities as being just loose aggregation of datoms just identified by the same entity ID (the first attribute of a datom).</p>

<p>So a schema attribute is just an entity stored in a special partition <code>:db.part/db</code> and defined by a few specific fields corresponding to the ones in previous paragraph. Here are the fields used to define a Datomic schema attribute technically speaking:</p>

<h3>mandatory fields</h3>

<ul>
<li><code>:db/ident</code> : specifies unique name of the attribute</li>
<li><code>:db/valueType</code> : specifies one the previous types - <em>Please note that even those types are not hard-coded in Datomic and in the future, adding new types could be a new feature.</em></li>
<li><code>:db/cardinality</code> : specifies the cardinality <code>one</code> or <code>many</code> of the attribute - a many attribute is just a set of values and type <code>Set</code> is important because Datomic only manages sets of unique values as it won&#8217;t return multiple times the same value when querying.</li>
</ul>


<h3>optional fields</h3>

<ul>
<li><code>:db/unique</code></li>
<li><code>:db/doc</code> (<em>useful to document your schema</em>)</li>
<li><code>:db/index</code></li>
<li><code>:db/fulltext</code></li>
<li><code>:db/isComponent</code></li>
<li><code>:db/noHistory</code></li>
</ul>


<p>Here is an example of schema attribute declaration written in Clojure:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:person/name</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/string</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A person&#39;s name&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>As you can see, creating schema attributes just means creating new entities in the right partition. So, to add new attributes to Datomic, you just have to add new facts.</p></blockquote>

<br/>


<h1>Schema sample</h1>

<p>Let&#8217;s create a schema defining a Koala living in an eucalyptus.</p>

<div class="well">
  <p>Yes I&#8217;m a super-Koala fan! Don&#8217;t ask me why, this is a long story not linked at all to Australia :D&#8230; But saving Koalas is important to me so I put this little banner for them&#8230;<span style="float: right"><a href="http://www.savethekoala.com"><img src="/images/mandubian/buttondonate.gif" /></a></span>
  </p>
</div>


<p>Let&#8217;s define a koala by following attributes:</p>

<ul>
<li>a name <code>String</code></li>
<li>an age <code>Long</code></li>
<li>a sex which can be <code>male</code> or `female</li>
<li><p>a few eucalyptus trees in which to feed defined by:</p>

<ul>
<li>a species being a <code>reference</code> to one of the possible species of eucalyptus trees</li>
<li>a row <code>Long</code> (<em>let&#8217;s imagine those trees are planted in rows/columns</em>)</li>
<li>a column <code>Long</code></li>
</ul>
</li>
</ul>


<p>Here is the Datomic schema for this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:koala/name</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/string</span>
</span><span class='line'> <span class="ss">:db/unique</span> <span class="ss">:db.unique/value</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A koala&#39;s name&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:koala/age</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/long</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A koala&#39;s age&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:koala/sex</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/ref</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A koala&#39;s sex&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:koala/eucalyptus</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/ref</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/many</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A koala&#39;s eucalyptus trees&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus/species</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/ref</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A eucalyptus specie&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus/row</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/long</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A eucalyptus row&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus/col</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/long</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A eucalyptus column&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; koala sexes as keywords</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:sex/male</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:sex/female</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; eucalyptus species</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/manna_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/tasmanian_blue_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/swamp_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/grey_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/river_red_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/tallowwood</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this sample, you can see that we have defined 4 namespaces:</p>

<ul>
<li><code>koala</code> used to logically regroup koala entity fields</li>
<li><code>eucalyptus</code> used to logically regroup eucalyptus entity fields</li>
<li><code>sex</code> used to identify koala sex male or female as unique keywords</li>
<li><code>eucalyptus.species</code> to identify eucalyptus species as unique keywords</li>
</ul>


<p>Remark also:</p>

<ul>
<li><code>:koala/name</code> field is uniquely valued meaning no koala can have the same name</li>
<li><code>:koala/eucalyptus</code> field is a <em>one-to-many</em> reference to eucalyptus entities</li>
</ul>


<br/>


<h1>Datomisca way of declaring schema</h1>

<h2>First of all, initialize your Datomic DB</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;datomic:mem://koala-db&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">createDatabase</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The NOT-preferred way</h2>

<p>Now, you must know it but Datomisca intensively uses Scala 2.10 macros to provide compile-time parsing and validation of Datomic queries or operations written in Clojure.</p>

<p>Previous Schema attributes definition is just a set of classic operations so you can ask Datomisca to parse them at compile-time as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">ops</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[</span>
</span><span class='line'><span class="s">{:db/id #db/id[:db.part/db]</span>
</span><span class='line'><span class="s"> :db/ident :koala/name</span>
</span><span class='line'><span class="s"> :db/valueType :db.type/string</span>
</span><span class='line'><span class="s"> :db/unique :db.unique/value</span>
</span><span class='line'><span class="s"> :db/cardinality :db.cardinality/one</span>
</span><span class='line'><span class="s"> :db/doc &quot;A koala&#39;s name&quot;}</span>
</span><span class='line'><span class="s">...</span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you can provision the schema into Datomic using:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="n">ops</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="c1">// do something</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The preferred way</h2>

<p>Ok the previous is cool as you can validate and provision a clojure schema using Datomisca.
But Datomisca provides a programmatic way of writing schema in Scala. This brings :</p>

<ul>
<li><strong>scala idiomatic</strong> way of manipulating schema</li>
<li><strong>Type-safety</strong> to Datomic schema attributes.</li>
</ul>


<p>Let&#8217;s see the code directly:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Sex Schema</span>
</span><span class='line'><span class="k">object</span> <span class="nc">SexSchema</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// First create your namespace</span>
</span><span class='line'>  <span class="k">object</span> <span class="nc">ns</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">sex</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;sex&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// enumerated values</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">FEMALE</span>  <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">sex</span> <span class="o">/</span> <span class="s">&quot;female&quot;</span><span class="o">)</span> <span class="c1">// :sex/female</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">MALE</span>    <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">sex</span> <span class="o">/</span> <span class="s">&quot;male&quot;</span><span class="o">)</span>   <span class="c1">// :sex/male</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// facts representing the schema to be provisioned</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">txData</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="nc">FEMALE</span><span class="o">,</span> <span class="nc">MALE</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Eucalyptus Schema</span>
</span><span class='line'><span class="k">object</span> <span class="nc">EucalyptusSchema</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">object</span> <span class="nc">ns</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">eucalyptus</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;eucalyptus&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// new is just here to allow structural construction</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">species</span>   <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;species&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// different species</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">MANNA_GUM</span>           <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;manna_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">TASMANIAN_BLUE_GUM</span>  <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;tasmanian_blue_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">SWAMP_GUM</span>           <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;swamp_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">GRY_GUM</span>             <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;grey_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">RIVER_RED_GUM</span>       <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;river_red_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">TALLOWWOOD</span>          <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;tallowwood&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// schema attributes</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">species</span>  <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span> <span class="o">/</span> <span class="s">&quot;species&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Eucalyptus&#39;s species&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">row</span>      <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span> <span class="o">/</span> <span class="s">&quot;row&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Eucalyptus&#39;s row&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">col</span>      <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span> <span class="o">/</span> <span class="s">&quot;col&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Eucalyptus&#39;s column&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// facts representing the schema to be provisioned</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">txData</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="n">species</span><span class="o">,</span> <span class="n">row</span><span class="o">,</span> <span class="n">col</span><span class="o">,</span>
</span><span class='line'>    <span class="nc">MANNA_GUM</span><span class="o">,</span> <span class="nc">TASMANIAN_BLUE_GUM</span><span class="o">,</span> <span class="nc">SWAMP_GUM</span><span class="o">,</span>
</span><span class='line'>    <span class="nc">GRY_GUM</span><span class="o">,</span> <span class="nc">RIVER_RED_GUM</span><span class="o">,</span> <span class="nc">TALLOWWOOD</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Koala Schema</span>
</span><span class='line'><span class="k">object</span> <span class="nc">KoalaSchema</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">object</span> <span class="nc">ns</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">koala</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;koala&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// schema attributes</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span>         <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s name&quot;</span><span class="o">).</span><span class="n">withUnique</span><span class="o">(</span><span class="nc">Unique</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">age</span>          <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s age&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sex</span>          <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;sex&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s sex&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">eucalyptus</span>   <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;eucalyptus&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">many</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s trees&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// facts representing the schema to be provisioned</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">txData</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">,</span> <span class="n">sex</span><span class="o">,</span> <span class="n">eucalyptus</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Provision Schema by just accumulating all txData</span>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">SexSchema</span><span class="o">.</span><span class="n">txData</span> <span class="o">++</span>
</span><span class='line'>  <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">txData</span> <span class="o">++</span>
</span><span class='line'>  <span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">txData</span>
</span><span class='line'><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing complicated, isn&#8217;t it?</p>

<p>Exactly the same as writing Clojure schema but in Scala&#8230;</p>

<br/>


<h1>Datomisca type-safe schema</h1>

<p>Datomisca takes advantage of Scala type-safety to enhance Datomic schema attribute and make them static-typed. Have a look at Datomisca <code>Attribute</code> definition:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">DD</span> <span class="k">&lt;:</span> <span class="kt">DatomicData</span>, <span class="kt">Card</span> <span class="k">&lt;:</span> <span class="kt">Cardinality</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So an <code>Attribute</code> is typed by 2 parameters:</p>

<ul>
<li>a <code>DatomicData</code> type</li>
<li>a <code>Cardinality</code> type</li>
</ul>


<p>So when you define a schema attribute using <em>Datomisca</em> API, the compiler also infers those types.</p>

<p>Take this example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">name</span>  <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s name&quot;</span><span class="o">).</span><span class="n">withUnique</span><span class="o">(</span><span class="nc">Unique</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>SchemaType.string</code> implies this is a <code>Attribute[DString, _]</code></li>
<li><code>Cardinality.one</code> implies this is a `Attribute[_, Cardinality.one]</li>
</ul>


<p>So <code>name</code> is a <code>Attribute[DString, Cardinality.one]</code></p>

<p>In the same way:</p>

<ul>
<li><code>age</code> is <code>Attribute[DLong, Cardinality.one]</code></li>
<li><code>sex</code> is <code>Attribute[DRef, Cardinality.one]</code></li>
<li><code>eucalyptus</code> is <code>Attribute[DRef, Cardinality.many]</code></li>
</ul>


<blockquote><p>As you can imagine, using this type-safe schema attributes, Datomisca can ensure consistency between the Datomic schema and the types manipulated in Scala.</p></blockquote>

<br/>


<h2>Taking advantage of type-safe schema</h2>

<h3>Checking types when creating facts</h3>

<blockquote><p>Based on the typed attribute, the compiler can help us a lot to validate that we give the right type for the right attribute.</p></blockquote>

<p>Schema facilities are extensions of basic Datomisca so you must import following to use them:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">DatomicMapping._</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is a code sample:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// correct tree with right types</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">tree58</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">SWAMP_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">row</span>     <span class="o">-&gt;</span> <span class="mi">5L</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">col</span>     <span class="o">-&gt;</span> <span class="mi">8L</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">tree58</span><span class="k">:</span> <span class="kt">datomisca.AddEntity</span> <span class="o">=</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/species</span> <span class="kt">:species/swamp_gum</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/row</span> <span class="err">5</span>
</span><span class='line'>  <span class="kt">:eucalyptus/col</span> <span class="err">8</span>
</span><span class='line'>  <span class="kt">:db/id</span> <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000000</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// incorrect tree with a string instead of a long for row</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">tree58</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">SWAMP_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">row</span>     <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">col</span>     <span class="o">-&gt;</span> <span class="mi">8L</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">18</span><span class="k">:</span> <span class="kt">error:</span> <span class="kt">could</span> <span class="kt">not</span> <span class="kt">find</span> <span class="kt">implicit</span> <span class="kt">value</span> <span class="kt">for</span> <span class="kt">parameter</span> <span class="kt">attrC:</span>
</span><span class='line'>  <span class="n">datomisca</span><span class="o">.</span><span class="nc">Attribute2PartialAddEntityWriter</span><span class="o">[</span><span class="kt">datomisca.DLong</span>,<span class="kt">datomisca.CardinalityOne.</span><span class="k">type</span>,<span class="kt">String</span><span class="o">]</span>
</span><span class='line'>         <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">SWAMP_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span></code></pre></td></tr></table></div></figure>


<p>In second case, compiling fails because <code>DLong =&gt; String</code> doesn&#8217;t exist.</p>

<p>In first case, it works because <code>DLong =&gt; Long</code> is valid.</p>

<br/>


<h3>Checking types when getting fields from Datomic entities</h3>

<p>First of all, let&#8217;s create our first little Koala named <em>Rose</em> which loves feeding from 2 eucalyptus trees.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">tree58</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">SWAMP_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">row</span>     <span class="o">-&gt;</span> <span class="mi">5L</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">col</span>     <span class="o">-&gt;</span> <span class="mi">8L</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">tree74</span><span class="k">:</span> <span class="kt">datomisca.AddEntity</span> <span class="o">=</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/species</span> <span class="kt">:species/swamp_gum</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/row</span> <span class="err">5</span>
</span><span class='line'>  <span class="kt">:eucalyptus/col</span> <span class="err">8</span>
</span><span class='line'>  <span class="kt">:db/id</span> <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000002</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">tree74</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">RIVER_RED_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">row</span>     <span class="o">-&gt;</span> <span class="mi">7L</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">col</span>     <span class="o">-&gt;</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">tree74</span><span class="k">:</span> <span class="kt">datomisca.AddEntity</span> <span class="o">=</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/species</span> <span class="kt">:species/river_red_gum</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/row</span> <span class="err">7</span>
</span><span class='line'>  <span class="kt">:eucalyptus/col</span> <span class="err">4</span>
</span><span class='line'>  <span class="kt">:db/id</span> <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000004</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">rose</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">name</span>        <span class="o">-&gt;</span> <span class="s">&quot;rose&quot;</span> <span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">age</span>         <span class="o">-&gt;</span> <span class="mi">3L</span> <span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">sex</span>         <span class="o">-&gt;</span> <span class="nc">SexSchema</span><span class="o">.</span><span class="nc">FEMALE</span><span class="o">.</span><span class="n">ref</span> <span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">eucalyptus</span>  <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="nc">DRef</span><span class="o">(</span><span class="n">tree58</span><span class="o">.</span><span class="n">id</span><span class="o">),</span> <span class="nc">DRef</span><span class="o">(</span><span class="n">tree74</span><span class="o">.</span><span class="n">id</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">rose</span><span class="k">:</span> <span class="kt">datomisca.AddEntity</span> <span class="o">=</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">koala/eucalyptus</span> <span class="o">[</span><span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000001</span><span class="o">]</span>, <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000002</span><span class="o">]]</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">koala/name</span> <span class="err">&quot;</span><span class="kt">rose</span><span class="err">&quot;</span>
</span><span class='line'>  <span class="kt">:db/id</span> <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000003</span><span class="o">]</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">koala/sex</span> <span class="kt">:sex/female</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">koala/age</span> <span class="err">3</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&#8217;s provision those koala &amp; trees into Datomic and retrieve real entity corresponding to our little Rose kitty.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="n">tree58</span><span class="o">,</span> <span class="n">tree74</span><span class="o">,</span> <span class="n">rose</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">realRose</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">resolveEntity</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">rose</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally let&#8217;s take advantage of typed schema attribute to access safely to fiels of the entity:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">maybeRose</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="n">tree58</span><span class="o">,</span> <span class="n">tree74</span><span class="o">,</span> <span class="n">rose</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">realRose</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">resolveEntity</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">rose</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">realRose</span><span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">age</span> <span class="k">=</span> <span class="n">realRose</span><span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">age</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sex</span> <span class="k">=</span> <span class="n">realRose</span><span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">sex</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">eucalyptus</span> <span class="k">=</span> <span class="n">realRose</span><span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">,</span> <span class="n">sex</span><span class="o">,</span> <span class="n">eucalyptus</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">maybeRose</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Long</span>, <span class="kt">Long</span>, <span class="kt">Set</span><span class="o">[</span><span class="kt">Long</span><span class="o">])]</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="k">@</span><span class="mi">49</span><span class="n">f454d6</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&#8217;s important here is that you get a <code>(String, Long, Long, Set[Long])</code> which means the compiler was able to infer the right types from the Schema Attribute&#8230;</p>

<p>Greattt!!!</p>

<p>Ok that&#8217;s all for today!</p>

<p>Next article about an extension Datomisca provides for convenience : mapping Datomic entities to Scala structures such as case-classes or tuples. We don&#8217;t believe this is really the philosophy of Datomic in which atomic operations are much more interesting. But sometimes it&#8217;s convenient when you want to have data abstraction layer&#8230;</p>

<p>Have KoalaFun!</p>
</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li class="previous"><a href="/blog/page/2/">&larr; Older</a></li>
    
    <li><a href="/blog/archives">Blog Archives</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/2013/08/21/playztream/">Scalaz-Stream Plug&#8217;n&#8217;Play2 Iteratee/WS + Recursive streaming</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/11/play-autosource-datomisca/">Play AutoSource & Datomisca: Proofing the concept on Datomic, a Schema DB</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/04/json-interpolation-pattern-matching/">Play2 Json Interpolation & Pattern Matching</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/11/play-autosource/">Play AutoSource : 2&#8217;30 Kickstart Full REST & CRUD Datasource in Play App (demo&#8217;ed with ReactiveMongo + AngularJS)</a>
      </li>
    
      <li class="post">
        <a href="/2013/05/01/reactive-json-crafting-jszipper-reactivemongo-webservice/">Reactive Json Crafting : JsZipper + ReactiveMongo + multiple Async WS calls</a>
      </li>
    
  </ul>
</section>


<section class="well">
  <ul id="tweets" class="nav" data-user="mandubian" data-count="4" data-replies="false">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
    <a href="http://twitter.com/mandubian" class="twitter-follow-button" data-show-count="false">Follow @mandubian</a>
  
</section>



<section class="well">
  <ul id="gh_repos" data-user="mandubian" data-count="5" data-skip="true" class="nav">
	<li class="nav-header">On GitHub</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a class="github-follow" href="https://github.com/mandubian">Follow @mandubian</a>
  
</section>










  
</aside>

    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2013 - Pascal Voitot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mandubian';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
