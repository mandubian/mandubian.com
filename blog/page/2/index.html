
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mandubian Blog</title>
  <meta name="author" content="Pascal Voitot">

  
  <meta name="description" content="Quick Survey About Most Basic Concept in Functional Programming
    
    
      
        








  


Apr 13th, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.mandubian.com/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/d3d.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }

    article {
      margin-bottom: 50px;
      border-top: #DDD solid 20px;
    }
 
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mandubian Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10417377-11']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Mandubian Blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:www.mandubian.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/04/13/FP-survey/">Quick Survey About Most Basic Concept in Functional Programming</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-04-13T14:14:00+02:00" pubdate data-updated="true">Apr 13<span>th</span>, 2013</time>
        
         | <a href="/2013/04/13/FP-survey/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h4>The question</h4>

<div class="well">
<h3>What&#8217;s the first word coming in your mind when I say:</h3>
<h3><i>&#8220;Most basic concept of functional programming?&#8221;</i></h3>
</div>








<script src="http://d3js.org/d3.v3.js"></script>




<script>
var width = 800,
    height = 600;

var cluster = d3.layout.cluster()
    .size([height, width - 560]);

var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [d.y, d.x]; });

var content = document.getElementsByClassName("entry-content")[0];

var svg = d3.select(content).append("svg")
    .attr("width", width)
    .attr("height", height)
    .append("g")
    .attr("transform", "translate(50,0)");

d3.json("/javascripts/survey1-results.json", function(error, json) {
  if (error) return console.warn(error);
  console.log(json);

  var nodes = cluster.nodes(json),
      links = cluster.links(nodes);

  var link = svg.selectAll(".link")
      .data(links)
      .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);

  var node = svg.selectAll(".node")
      .data(nodes)
      .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + d.y + "," + d.x + ")"; })

  node.append("circle")
      .attr("r", 4.5);

  node.append("text")
      .attr("dx", function(d) { return d.children ? -8 : 8; })
      .attr("dy", 3)
      .style("text-anchor", function(d) { return d.children ? "end" : "start"; })
      .text(function(d) { return d.name; });
});

d3.select(self.frameElement).style("height", height + "px");

</script>


<blockquote><p>For info, this dendrograph was pre-computed using Play2.1 app sucking Tweets &amp; filtering/grouping the results in a very manual-o-matic wayâ€¦</p></blockquote>

<p>Have Fun(ctional)</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/03/12/datomisca-shapeless-hlist/">Shapeless HList Schema-Type-Safe Conversion to Datomisca/Datomic Entities</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-12T12:12:00+01:00" pubdate data-updated="true">Mar 12<span>th</span>, 2013</time>
        
         | <a href="/2013/03/12/datomisca-shapeless-hlist/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>The code is on github project <a href="https://github.com/mandubian/shapotomic">shapotomic</a></p></blockquote>

<h4>Datomisca is a Scala API for Datomic DB</h4>

<p>If you want to know more about Datomisca/Datomic schema go to my <a href="http://mandubian.com/2013/03/04/datomisca-schema/">recent article</a>. What&#8217;s interesting with Datomisca schema is that they are statically typed allowing some compiler validations and type inference.</p>

<h4><a href="https://github.com/milessabin/shapeless">Shapeless HList</a> are heterogenous polymorphic lists</h4>

<p>HList are able to contain different types of data and able to keep tracks of these types.</p>

<br/>


<div class="well">
<b><p>This project is an experience trying to :</p>

<ul>
  <li>convert HList to/from Datomic Entities</li>
  <li>check HList types against schema at compile-time</li>
</ul></b>
</div>


<p>This uses :</p>

<ul>
<li>Datomisca type-safe schema</li>
<li>Shapeless HList</li>
<li>Shapeless polymorphic functions</li>
</ul>


<p>Please note that we don&#8217;t provide any <code>Iso[From, To]</code> since there is no isomorphism here.
Actually, there are 2 monomorphisms (injective):</p>

<ul>
<li><code>HList   =&gt; AddEntity</code> to provision an entity</li>
<li><code>DEntity =&gt; HList</code> when retrieving entity</li>
</ul>


<p>We would need to implement <code>Mono[From, To]</code> certainly for our case&#8230;</p>

<h2>Code sample</h2>

<h3>Create schema based on <code>HList</code></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Koala Schema</span>
</span><span class='line'><span class="k">object</span> <span class="nc">Koala</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">object</span> <span class="nc">ns</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">koala</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;koala&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// schema attributes</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span>        <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s name&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">age</span>         <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s age&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">trees</span>       <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;trees&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">many</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s trees&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the schema in HList form</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">schema</span> <span class="k">=</span> <span class="n">name</span> <span class="o">::</span> <span class="n">age</span> <span class="o">::</span> <span class="n">trees</span> <span class="o">::</span> <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the datomic facts corresponding to schema </span>
</span><span class='line'>  <span class="c1">// (need specifying upper type for shapeless conversion to list)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">txData</span> <span class="k">=</span> <span class="n">schema</span><span class="o">.</span><span class="n">toList</span><span class="o">[</span><span class="kt">Operation</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Provision schema</span>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">txData</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span> <span class="o">...</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Validate <code>HList</code> against Schema</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// creates a Temporary ID &amp; keeps it for resolving entity after insertion</span>
</span><span class='line'><span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span><span class='line'><span class="c1">// creates an HList entity </span>
</span><span class='line'><span class="k">val</span> <span class="n">hListEntity</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">id</span> <span class="o">::</span> <span class="s">&quot;kaylee&quot;</span> <span class="o">::</span> <span class="mi">3L</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">Set</span><span class="o">(</span> <span class="s">&quot;manna_gum&quot;</span><span class="o">,</span> <span class="s">&quot;tallowwood&quot;</span> <span class="o">)</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// validates and converts at compile-time this HList against schema</span>
</span><span class='line'><span class="n">hListEntity</span><span class="o">.</span><span class="n">toAddEntity</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">schema</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// If you remove a field from HList and try again, the compiler fails</span>
</span><span class='line'><span class="k">val</span> <span class="n">badHListEntity</span> <span class="k">=</span>
</span><span class='line'>  <span class="n">id</span> <span class="o">::</span> <span class="s">&quot;kaylee&quot;</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">Set</span><span class="o">(</span> <span class="s">&quot;manna_gum&quot;</span><span class="o">,</span> <span class="s">&quot;tallowwood&quot;</span> <span class="o">)</span> <span class="o">::</span>
</span><span class='line'>  <span class="nc">HNil</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">badHListEntity</span><span class="o">.</span><span class="n">toAddEntity</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">schema</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">23</span><span class="k">:</span> <span class="kt">error:</span> <span class="kt">could</span> <span class="kt">not</span> <span class="kt">find</span> <span class="kt">implicit</span> <span class="kt">value</span> <span class="kt">for</span> <span class="kt">parameter</span> <span class="kt">pull:</span>
</span><span class='line'>  <span class="n">shapotomic</span><span class="o">.</span><span class="nc">SchemaCheckerFromHList</span><span class="o">.</span><span class="nc">Pullback2</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">datomisca.TempId</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">scala.collection.immutable.Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span>,
</span><span class='line'>  <span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">datomisca.RawAttribute</span><span class="o">[</span><span class="kt">datomisca.DString</span>,<span class="kt">datomisca.CardinalityOne.</span><span class="k">type</span><span class="o">]</span>,
</span><span class='line'>  <span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">datomisca.RawAttribute</span><span class="o">[</span><span class="kt">datomisca.DLong</span>,<span class="kt">datomisca.CardinalityOne.</span><span class="k">type</span><span class="o">]</span>,
</span><span class='line'>  <span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">datomisca.RawAttribute</span><span class="o">[</span><span class="kt">datomisca.DString</span>,<span class="kt">datomisca.CardinalityMany.</span><span class="k">type</span><span class="o">]</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span>,<span class="kt">datomisca.AddEntity</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>The compiler error is a bit weird at first but if you take a few seconds to read it, you&#8217;ll see that there is nothing hard about it, it just says:</em></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">I</span> <span class="n">can</span><span class="-Symbol">&#39;t</span> <span class="n">convert</span>
</span><span class='line'><span class="o">(</span><span class="nc">TempId</span> <span class="o">::)</span> <span class="nc">String</span>             <span class="o">::</span> <span class="nc">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>      <span class="o">::</span> <span class="nc">HNil</span> <span class="k">=&gt;</span>
</span><span class='line'>            <span class="nc">Attr</span><span class="o">[</span><span class="kt">DString</span>, <span class="kt">one</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Attr</span><span class="o">[</span><span class="kt">DLong</span>, <span class="kt">one</span><span class="o">]</span> <span class="o">::</span> <span class="nc">Attr</span><span class="o">[</span><span class="kt">DString</span>, <span class="kt">many</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Convert <code>DEntity</code> to static-typed <code>HList</code> based on schema</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">e</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">resolveEntity</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">id</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// rebuilds HList entity from DEntity statically typed by schema</span>
</span><span class='line'><span class="k">val</span> <span class="n">postHListEntity</span> <span class="k">=</span> <span class="n">e</span><span class="o">.</span><span class="n">toHList</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">schema</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Explicitly typing the value to show that the compiler builds the right typed HList from schema</span>
</span><span class='line'><span class="k">val</span> <span class="n">validateHListEntityType</span><span class="k">:</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">Set</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">::</span> <span class="nc">HNil</span> <span class="k">=</span> <span class="n">postHListEntity</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p>Using <code>HList</code> with compile-time schema validation is quite interesting because it provides a very basic and versatile data structure to manipulate Datomic entities in a type-safe style.</p>

<p>Moreover, as Datomic pushes atomic data manipulation (simple facts instead of full entities), it&#8217;s really cool to use <code>HList</code> instead of rigid static structure such as case-class.</p>

<p>For ex:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">simplerOp</span> <span class="k">=</span> <span class="o">(</span><span class="n">id</span> <span class="o">::</span> <span class="s">&quot;kaylee&quot;</span> <span class="o">::</span> <span class="mi">5L</span><span class="o">).</span><span class="n">toAddEntity</span><span class="o">(</span><span class="nc">Koala</span><span class="o">.</span><span class="n">name</span> <span class="o">::</span> <span class="nc">Koala</span><span class="o">.</span><span class="n">age</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Have TypedFun</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/03/04/datomisca-schema/">Datomisca Delicatessen - Emulsion of Scala Type-safety in Datomic Schema</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-03-04T00:00:00+01:00" pubdate data-updated="true">Mar 4<span>th</span>, 2013</time>
        
         | <a href="/2013/03/04/datomisca-schema/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>One more step in our progressive unveiling of <a href="http://pellucidanalytics.github.com/datomisca/index.html">Datomisca</a>, our opensource Scala API (sponsored by <a href="http://www.pellucidanalytics.com">Pellucid</a> &amp; <a href="http://www.zenexity.com">Zenexity</a>) trying to enhance <a href="http://www.datomic.com">Datomic</a> experience for Scala developers&#8230;</p>

<p>After evoking <a href="./2013-02-10-datomisca-query.html">queries compiled by Scala macros in previous article</a> and then <a href="./2013-02-18-datomisca-fact-operations.html">reactive transaction &amp; fact operation API</a>, let&#8217;s explain <strong>how <em>Datomisca</em> manages Datomic schema attributes</strong>.</p>

<br/>


<h1>Datomic Schema Reminders</h1>

<p>As explained in previous articles, Datomic stores lots of atomic facts called <code>datoms</code> which are constituted of <code>entity-id</code>, <code>attribute</code>, <code>value</code> and <code>transaction-id</code>.</p>

<p>An attribute is just a namespaced keyword <code>:&lt;namespace&gt;.&lt;nested-namespace&gt;/&lt;name&gt; such as</code>:person.address/street`:</p>

<ul>
<li><code>person.address</code> is just a hierarchical namespace <code>person</code> -> <code>address</code></li>
<li><code>street</code> is the name of the attribute</li>
</ul>


<p>It&#8217;s cool to provision all thoses atomic pieces of information but what if we provision non existing attribute with bad format, type, &#8230;? Is there a way to control the format of data in Datomic?</p>

<blockquote><p>In a less strict way than SQL, Datomic provides schema facility allowing to constrain the accepted attributes and their type values.</p></blockquote>

<h2>Schema attribute definition</h2>

<p>Datomic schema just defines the accepted attributes and some constraints on those attributes. Each schema attribute can be defined by following fields:</p>

<h3>value type</h3>

<ul>
<li><strong>basic types</strong> : <code>string</code>, <code>long</code>, <code>float</code>, <code>bigint</code>, <code>bigdec</code>, <code>boolean</code>, <code>instant</code>, <code>uuid</code>, <code>uri</code>, <code>bytes</code> (yes NO <code>int</code>).</li>
<li><strong>reference</strong> : in Datomic you can reference other entities (these are lazy relations not as strict as the ones in RDBMS)</li>
</ul>


<h3>cardinality</h3>

<ul>
<li><strong>one</strong> : one-to-one relation if you want an analogy with RDBMS</li>
<li><strong>many</strong> : one-to-many relation</li>
</ul>


<blockquote><p>Please note that in Datomic, all relations are bidirectional even for one-to-many.</p></blockquote>

<h3>optional constraints:</h3>

<ul>
<li>unicity</li>
<li>index creation</li>
<li>fulltext indexation</li>
<li>a few more exotic ones that you&#8217;ll find in <a href="http://docs.datomic.com/schema.html">Datomic doc about schema</a></li>
</ul>


<h2>Schema attributes are entities</h2>

<p>The schema validation is applied at fact insertion and allows to prevent from inserting unknown attributes or bad value types. But how are schema attributes defined?</p>

<p><strong>Actually, schema attributes are themselves entities. </strong></p>

<p>Remember, in previous article, I had introduced entities as being just loose aggregation of datoms just identified by the same entity ID (the first attribute of a datom).</p>

<p>So a schema attribute is just an entity stored in a special partition <code>:db.part/db</code> and defined by a few specific fields corresponding to the ones in previous paragraph. Here are the fields used to define a Datomic schema attribute technically speaking:</p>

<h3>mandatory fields</h3>

<ul>
<li><code>:db/ident</code> : specifies unique name of the attribute</li>
<li><code>:db/valueType</code> : specifies one the previous types - <em>Please note that even those types are not hard-coded in Datomic and in the future, adding new types could be a new feature.</em></li>
<li><code>:db/cardinality</code> : specifies the cardinality <code>one</code> or <code>many</code> of the attribute - a many attribute is just a set of values and type <code>Set</code> is important because Datomic only manages sets of unique values as it won&#8217;t return multiple times the same value when querying.</li>
</ul>


<h3>optional fields</h3>

<ul>
<li><code>:db/unique</code></li>
<li><code>:db/doc</code> (<em>useful to document your schema</em>)</li>
<li><code>:db/index</code></li>
<li><code>:db/fulltext</code></li>
<li><code>:db/isComponent</code></li>
<li><code>:db/noHistory</code></li>
</ul>


<p>Here is an example of schema attribute declaration written in Clojure:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:person/name</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/string</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A person&#39;s name&quot;</span><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>As you can see, creating schema attributes just means creating new entities in the right partition. So, to add new attributes to Datomic, you just have to add new facts.</p></blockquote>

<br/>


<h1>Schema sample</h1>

<p>Let&#8217;s create a schema defining a Koala living in an eucalyptus.</p>

<div class="well">
  <p>Yes I&#8217;m a super-Koala fan! Don&#8217;t ask me why, this is a long story not linked at all to Australia :D&#8230; But saving Koalas is important to me so I put this little banner for them&#8230;<span style="float: right"><a href="http://www.savethekoala.com"><img src="/images/mandubian/buttondonate.gif" /></a></span>
  </p>
</div>


<p>Let&#8217;s define a koala by following attributes:</p>

<ul>
<li>a name <code>String</code></li>
<li>an age <code>Long</code></li>
<li>a sex which can be <code>male</code> or `female</li>
<li><p>a few eucalyptus trees in which to feed defined by:</p>

<ul>
<li>a species being a <code>reference</code> to one of the possible species of eucalyptus trees</li>
<li>a row <code>Long</code> (<em>let&#8217;s imagine those trees are planted in rows/columns</em>)</li>
<li>a column <code>Long</code></li>
</ul>
</li>
</ul>


<p>Here is the Datomic schema for this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:koala/name</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/string</span>
</span><span class='line'> <span class="ss">:db/unique</span> <span class="ss">:db.unique/value</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A koala&#39;s name&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:koala/age</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/long</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A koala&#39;s age&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:koala/sex</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/ref</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A koala&#39;s sex&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:koala/eucalyptus</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/ref</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/many</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A koala&#39;s eucalyptus trees&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus/species</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/ref</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A eucalyptus specie&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus/row</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/long</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A eucalyptus row&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/db</span><span class="p">]</span>
</span><span class='line'> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus/col</span>
</span><span class='line'> <span class="ss">:db/valueType</span> <span class="ss">:db.type/long</span>
</span><span class='line'> <span class="ss">:db/cardinality</span> <span class="ss">:db.cardinality/one</span>
</span><span class='line'> <span class="ss">:db/doc</span> <span class="s">&quot;A eucalyptus column&quot;</span><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; koala sexes as keywords</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:sex/male</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:sex/female</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">;; eucalyptus species</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/manna_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/tasmanian_blue_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/swamp_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/grey_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/river_red_gum</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:eucalyptus.species/tallowwood</span><span class="p">]</span>
</span><span class='line'>
</span><span class='line'><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this sample, you can see that we have defined 4 namespaces:</p>

<ul>
<li><code>koala</code> used to logically regroup koala entity fields</li>
<li><code>eucalyptus</code> used to logically regroup eucalyptus entity fields</li>
<li><code>sex</code> used to identify koala sex male or female as unique keywords</li>
<li><code>eucalyptus.species</code> to identify eucalyptus species as unique keywords</li>
</ul>


<p>Remark also:</p>

<ul>
<li><code>:koala/name</code> field is uniquely valued meaning no koala can have the same name</li>
<li><code>:koala/eucalyptus</code> field is a <em>one-to-many</em> reference to eucalyptus entities</li>
</ul>


<br/>


<h1>Datomisca way of declaring schema</h1>

<h2>First of all, initialize your Datomic DB</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;datomic:mem://koala-db&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">createDatabase</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The NOT-preferred way</h2>

<p>Now, you must know it but Datomisca intensively uses Scala 2.10 macros to provide compile-time parsing and validation of Datomic queries or operations written in Clojure.</p>

<p>Previous Schema attributes definition is just a set of classic operations so you can ask Datomisca to parse them at compile-time as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">ops</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[</span>
</span><span class='line'><span class="s">{:db/id #db/id[:db.part/db]</span>
</span><span class='line'><span class="s"> :db/ident :koala/name</span>
</span><span class='line'><span class="s"> :db/valueType :db.type/string</span>
</span><span class='line'><span class="s"> :db/unique :db.unique/value</span>
</span><span class='line'><span class="s"> :db/cardinality :db.cardinality/one</span>
</span><span class='line'><span class="s"> :db/doc &quot;A koala&#39;s name&quot;}</span>
</span><span class='line'><span class="s">...</span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you can provision the schema into Datomic using:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="n">ops</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="c1">// do something</span>
</span><span class='line'>  <span class="c1">//</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>The preferred way</h2>

<p>Ok the previous is cool as you can validate and provision a clojure schema using Datomisca.
But Datomisca provides a programmatic way of writing schema in Scala. This brings :</p>

<ul>
<li><strong>scala idiomatic</strong> way of manipulating schema</li>
<li><strong>Type-safety</strong> to Datomic schema attributes.</li>
</ul>


<p>Let&#8217;s see the code directly:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
<span class='line-number'>54</span>
<span class='line-number'>55</span>
<span class='line-number'>56</span>
<span class='line-number'>57</span>
<span class='line-number'>58</span>
<span class='line-number'>59</span>
<span class='line-number'>60</span>
<span class='line-number'>61</span>
<span class='line-number'>62</span>
<span class='line-number'>63</span>
<span class='line-number'>64</span>
<span class='line-number'>65</span>
<span class='line-number'>66</span>
<span class='line-number'>67</span>
<span class='line-number'>68</span>
<span class='line-number'>69</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Sex Schema</span>
</span><span class='line'><span class="k">object</span> <span class="nc">SexSchema</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// First create your namespace</span>
</span><span class='line'>  <span class="k">object</span> <span class="nc">ns</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">sex</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;sex&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// enumerated values</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">FEMALE</span>  <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">sex</span> <span class="o">/</span> <span class="s">&quot;female&quot;</span><span class="o">)</span> <span class="c1">// :sex/female</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">MALE</span>    <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">sex</span> <span class="o">/</span> <span class="s">&quot;male&quot;</span><span class="o">)</span>   <span class="c1">// :sex/male</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// facts representing the schema to be provisioned</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">txData</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="nc">FEMALE</span><span class="o">,</span> <span class="nc">MALE</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Eucalyptus Schema</span>
</span><span class='line'><span class="k">object</span> <span class="nc">EucalyptusSchema</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">object</span> <span class="nc">ns</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">eucalyptus</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;eucalyptus&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="c1">// new is just here to allow structural construction</span>
</span><span class='line'>      <span class="k">val</span> <span class="n">species</span>   <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;species&quot;</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// different species</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">MANNA_GUM</span>           <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;manna_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">TASMANIAN_BLUE_GUM</span>  <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;tasmanian_blue_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">SWAMP_GUM</span>           <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;swamp_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">GRY_GUM</span>             <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;grey_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">RIVER_RED_GUM</span>       <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;river_red_gum&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">TALLOWWOOD</span>          <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">.</span><span class="n">species</span> <span class="o">/</span> <span class="s">&quot;tallowwood&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// schema attributes</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">species</span>  <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span> <span class="o">/</span> <span class="s">&quot;species&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Eucalyptus&#39;s species&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">row</span>      <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span> <span class="o">/</span> <span class="s">&quot;row&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Eucalyptus&#39;s row&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">col</span>      <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">eucalyptus</span> <span class="o">/</span> <span class="s">&quot;col&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Eucalyptus&#39;s column&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// facts representing the schema to be provisioned</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">txData</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="n">species</span><span class="o">,</span> <span class="n">row</span><span class="o">,</span> <span class="n">col</span><span class="o">,</span>
</span><span class='line'>    <span class="nc">MANNA_GUM</span><span class="o">,</span> <span class="nc">TASMANIAN_BLUE_GUM</span><span class="o">,</span> <span class="nc">SWAMP_GUM</span><span class="o">,</span>
</span><span class='line'>    <span class="nc">GRY_GUM</span><span class="o">,</span> <span class="nc">RIVER_RED_GUM</span><span class="o">,</span> <span class="nc">TALLOWWOOD</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Koala Schema</span>
</span><span class='line'><span class="k">object</span> <span class="nc">KoalaSchema</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">object</span> <span class="nc">ns</span> <span class="o">{</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">koala</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;koala&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// schema attributes</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span>         <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s name&quot;</span><span class="o">).</span><span class="n">withUnique</span><span class="o">(</span><span class="nc">Unique</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">age</span>          <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">long</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s age&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sex</span>          <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;sex&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s sex&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">eucalyptus</span>   <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span><span class="o">.</span><span class="n">koala</span> <span class="o">/</span> <span class="s">&quot;eucalyptus&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">many</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s trees&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// facts representing the schema to be provisioned</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">txData</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">,</span> <span class="n">sex</span><span class="o">,</span> <span class="n">eucalyptus</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>
</span><span class='line'><span class="c1">// Provision Schema by just accumulating all txData</span>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">SexSchema</span><span class="o">.</span><span class="n">txData</span> <span class="o">++</span>
</span><span class='line'>  <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">txData</span> <span class="o">++</span>
</span><span class='line'>  <span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">txData</span>
</span><span class='line'><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing complicated, isn&#8217;t it?</p>

<p>Exactly the same as writing Clojure schema but in Scala&#8230;</p>

<br/>


<h1>Datomisca type-safe schema</h1>

<p>Datomisca takes advantage of Scala type-safety to enhance Datomic schema attribute and make them static-typed. Have a look at Datomisca <code>Attribute</code> definition:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Attribute</span><span class="o">[</span><span class="kt">DD</span> <span class="k">&lt;:</span> <span class="kt">DatomicData</span>, <span class="kt">Card</span> <span class="k">&lt;:</span> <span class="kt">Cardinality</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So an <code>Attribute</code> is typed by 2 parameters:</p>

<ul>
<li>a <code>DatomicData</code> type</li>
<li>a <code>Cardinality</code> type</li>
</ul>


<p>So when you define a schema attribute using <em>Datomisca</em> API, the compiler also infers those types.</p>

<p>Take this example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">name</span>  <span class="k">=</span> <span class="nc">Attribute</span><span class="o">(</span><span class="n">ns</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="nc">SchemaType</span><span class="o">.</span><span class="n">string</span><span class="o">,</span> <span class="nc">Cardinality</span><span class="o">.</span><span class="n">one</span><span class="o">).</span><span class="n">withDoc</span><span class="o">(</span><span class="s">&quot;Koala&#39;s name&quot;</span><span class="o">).</span><span class="n">withUnique</span><span class="o">(</span><span class="nc">Unique</span><span class="o">.</span><span class="n">value</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><code>SchemaType.string</code> implies this is a <code>Attribute[DString, _]</code></li>
<li><code>Cardinality.one</code> implies this is a `Attribute[_, Cardinality.one]</li>
</ul>


<p>So <code>name</code> is a <code>Attribute[DString, Cardinality.one]</code></p>

<p>In the same way:</p>

<ul>
<li><code>age</code> is <code>Attribute[DLong, Cardinality.one]</code></li>
<li><code>sex</code> is <code>Attribute[DRef, Cardinality.one]</code></li>
<li><code>eucalyptus</code> is <code>Attribute[DRef, Cardinality.many]</code></li>
</ul>


<blockquote><p>As you can imagine, using this type-safe schema attributes, Datomisca can ensure consistency between the Datomic schema and the types manipulated in Scala.</p></blockquote>

<br/>


<h2>Taking advantage of type-safe schema</h2>

<h3>Checking types when creating facts</h3>

<blockquote><p>Based on the typed attribute, the compiler can help us a lot to validate that we give the right type for the right attribute.</p></blockquote>

<p>Schema facilities are extensions of basic Datomisca so you must import following to use them:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">DatomicMapping._</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is a code sample:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">//////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// correct tree with right types</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">tree58</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">SWAMP_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">row</span>     <span class="o">-&gt;</span> <span class="mi">5L</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">col</span>     <span class="o">-&gt;</span> <span class="mi">8L</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">tree58</span><span class="k">:</span> <span class="kt">datomisca.AddEntity</span> <span class="o">=</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/species</span> <span class="kt">:species/swamp_gum</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/row</span> <span class="err">5</span>
</span><span class='line'>  <span class="kt">:eucalyptus/col</span> <span class="err">8</span>
</span><span class='line'>  <span class="kt">:db/id</span> <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000000</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//////////////////////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// incorrect tree with a string instead of a long for row</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">tree58</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">SWAMP_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">row</span>     <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">col</span>     <span class="o">-&gt;</span> <span class="mi">8L</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">18</span><span class="k">:</span> <span class="kt">error:</span> <span class="kt">could</span> <span class="kt">not</span> <span class="kt">find</span> <span class="kt">implicit</span> <span class="kt">value</span> <span class="kt">for</span> <span class="kt">parameter</span> <span class="kt">attrC:</span>
</span><span class='line'>  <span class="n">datomisca</span><span class="o">.</span><span class="nc">Attribute2PartialAddEntityWriter</span><span class="o">[</span><span class="kt">datomisca.DLong</span>,<span class="kt">datomisca.CardinalityOne.</span><span class="k">type</span>,<span class="kt">String</span><span class="o">]</span>
</span><span class='line'>         <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">SWAMP_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span></code></pre></td></tr></table></div></figure>


<p>In second case, compiling fails because <code>DLong =&gt; String</code> doesn&#8217;t exist.</p>

<p>In first case, it works because <code>DLong =&gt; Long</code> is valid.</p>

<br/>


<h3>Checking types when getting fields from Datomic entities</h3>

<p>First of all, let&#8217;s create our first little Koala named <em>Rose</em> which loves feeding from 2 eucalyptus trees.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">tree58</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">SWAMP_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">row</span>     <span class="o">-&gt;</span> <span class="mi">5L</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">col</span>     <span class="o">-&gt;</span> <span class="mi">8L</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">tree74</span><span class="k">:</span> <span class="kt">datomisca.AddEntity</span> <span class="o">=</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/species</span> <span class="kt">:species/swamp_gum</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/row</span> <span class="err">5</span>
</span><span class='line'>  <span class="kt">:eucalyptus/col</span> <span class="err">8</span>
</span><span class='line'>  <span class="kt">:db/id</span> <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000002</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">tree74</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">species</span> <span class="o">-&gt;</span> <span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="nc">RIVER_RED_GUM</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">row</span>     <span class="o">-&gt;</span> <span class="mi">7L</span><span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">EucalyptusSchema</span><span class="o">.</span><span class="n">col</span>     <span class="o">-&gt;</span> <span class="mi">4L</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">tree74</span><span class="k">:</span> <span class="kt">datomisca.AddEntity</span> <span class="o">=</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/species</span> <span class="kt">:species/river_red_gum</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">eucalyptus/row</span> <span class="err">7</span>
</span><span class='line'>  <span class="kt">:eucalyptus/col</span> <span class="err">4</span>
</span><span class='line'>  <span class="kt">:db/id</span> <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000004</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">rose</span> <span class="k">=</span> <span class="nc">SchemaEntity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="nc">Props</span><span class="o">()</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">name</span>        <span class="o">-&gt;</span> <span class="s">&quot;rose&quot;</span> <span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">age</span>         <span class="o">-&gt;</span> <span class="mi">3L</span> <span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">sex</span>         <span class="o">-&gt;</span> <span class="nc">SexSchema</span><span class="o">.</span><span class="nc">FEMALE</span><span class="o">.</span><span class="n">ref</span> <span class="o">)</span> <span class="o">+</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">eucalyptus</span>  <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="nc">DRef</span><span class="o">(</span><span class="n">tree58</span><span class="o">.</span><span class="n">id</span><span class="o">),</span> <span class="nc">DRef</span><span class="o">(</span><span class="n">tree74</span><span class="o">.</span><span class="n">id</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'><span class="n">rose</span><span class="k">:</span> <span class="kt">datomisca.AddEntity</span> <span class="o">=</span>
</span><span class='line'><span class="o">{</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">koala/eucalyptus</span> <span class="o">[</span><span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000001</span><span class="o">]</span>, <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000002</span><span class="o">]]</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">koala/name</span> <span class="err">&quot;</span><span class="kt">rose</span><span class="err">&quot;</span>
</span><span class='line'>  <span class="kt">:db/id</span> <span class="k">#</span><span class="kt">db/id</span><span class="o">[</span><span class="kt">:db.part/user</span> <span class="kt">-</span><span class="err">1000003</span><span class="o">]</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">koala/sex</span> <span class="kt">:sex/female</span>
</span><span class='line'>  <span class="k">:</span><span class="kt">koala/age</span> <span class="err">3</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now let&#8217;s provision those koala &amp; trees into Datomic and retrieve real entity corresponding to our little Rose kitty.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="n">tree58</span><span class="o">,</span> <span class="n">tree74</span><span class="o">,</span> <span class="n">rose</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">realRose</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">resolveEntity</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">rose</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally let&#8217;s take advantage of typed schema attribute to access safely to fiels of the entity:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">maybeRose</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="n">tree58</span><span class="o">,</span> <span class="n">tree74</span><span class="o">,</span> <span class="n">rose</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">realRose</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">resolveEntity</span><span class="o">(</span><span class="n">tx</span><span class="o">,</span> <span class="n">rose</span><span class="o">.</span><span class="n">id</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">name</span> <span class="k">=</span> <span class="n">realRose</span><span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">age</span> <span class="k">=</span> <span class="n">realRose</span><span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">age</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">sex</span> <span class="k">=</span> <span class="n">realRose</span><span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">sex</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">eucalyptus</span> <span class="k">=</span> <span class="n">realRose</span><span class="o">(</span><span class="nc">KoalaSchema</span><span class="o">.</span><span class="n">eucalyptus</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">age</span><span class="o">,</span> <span class="n">sex</span><span class="o">,</span> <span class="n">eucalyptus</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="n">maybeRose</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Long</span>, <span class="kt">Long</span>, <span class="kt">Set</span><span class="o">[</span><span class="kt">Long</span><span class="o">])]</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="k">@</span><span class="mi">49</span><span class="n">f454d6</span>
</span></code></pre></td></tr></table></div></figure>


<p>What&#8217;s important here is that you get a <code>(String, Long, Long, Set[Long])</code> which means the compiler was able to infer the right types from the Schema Attribute&#8230;</p>

<p>Greattt!!!</p>

<p>Ok that&#8217;s all for today!</p>

<p>Next article about an extension Datomisca provides for convenience : mapping Datomic entities to Scala structures such as case-classes or tuples. We don&#8217;t believe this is really the philosophy of Datomic in which atomic operations are much more interesting. But sometimes it&#8217;s convenient when you want to have data abstraction layer&#8230;</p>

<p>Have KoalaFun!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/02/27/shapelaysson/">Shapelaysson = Shapeless + Play-Json</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-27T00:00:00+01:00" pubdate data-updated="true">Feb 27<span>th</span>, 2013</time>
        
         | <a href="/2013/02/27/shapelaysson/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Do you like <a href="https://github.com/milessabin/shapeless">Shapeless</a>, this great API developed by Miles Sabin studying generic/polytypic programming in Scala?</p>

<p>Do you like <a href="https://github.com/mandubian/play-json-alone">Play-json</a>, the Play Json 2.1 Json API developed for Play 2.1 framework and now usable as stand-alone module providing functional &amp; typesafe Json validation and Scala conversion?</p>

<br/>


<h4>Here is <strong>Shapelaysson</strong> an API interleaving Play-Json with Shapeless to be able to <strong>manipulate Json from/to Shapeless HList</strong></h4>

<p><em>HList are heterogenous polymorphic lists able to contain different types of data and able to keep tracks of these types</em></p>

<br/>


<blockquote><p><a href="https://github.com/mandubian/shapelaysson/">Shapelaysson</a> is a Github project with test/samples</p></blockquote>

<br/>


<blockquote><p><code>Shapelaysson</code> takes part in my reflexions around manipulating pure data structures from/to JSON.</p></blockquote>

<h2>A few pure Json from/to HList samples</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">shapeless._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">HList._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Tuples._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">shapelaysson._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// validates + converts a JsArray into HList</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="mi">123L</span><span class="o">).</span><span class="n">validate</span><span class="o">[</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">HNil</span> <span class="o">]</span>
</span><span class='line'><span class="n">res1</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span> <span class="k">=</span>
</span><span class='line'><span class="nc">JsSuccess</span><span class="o">(</span><span class="n">foo</span> <span class="o">::</span> <span class="mi">123</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">,)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// validates + converts a JsObject into HList</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span> <span class="o">-&gt;</span> <span class="mi">123L</span><span class="o">).</span><span class="n">validate</span><span class="o">[</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">HNil</span> <span class="o">]</span>
</span><span class='line'><span class="n">res3</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span> <span class="k">=</span>
</span><span class='line'><span class="nc">JsSuccess</span><span class="o">(</span><span class="n">toto</span> <span class="o">::</span> <span class="mi">123</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">,)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// validates + converts imbricated JsObject into HList</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>     <span class="o">|</span>   <span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span>
</span><span class='line'>     <span class="o">|</span>   <span class="s">&quot;foofoo&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;barbar1&quot;</span> <span class="o">-&gt;</span> <span class="mf">123.45</span><span class="o">,</span> <span class="s">&quot;barbar2&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;tutu&quot;</span><span class="o">),</span>
</span><span class='line'>     <span class="o">|</span>      <span class="s">&quot;bar&quot;</span> <span class="o">-&gt;</span> <span class="mi">123L</span><span class="o">,</span>
</span><span class='line'>     <span class="o">|</span>      <span class="s">&quot;barbar&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="s">&quot;blabla&quot;</span><span class="o">)</span>
</span><span class='line'>     <span class="o">|</span>   <span class="o">).</span><span class="n">validate</span><span class="o">[</span> <span class="kt">String</span> <span class="kt">::</span> <span class="o">(</span><span class="kt">Float</span> <span class="kt">::</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">)</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="o">(</span><span class="kt">Int</span> <span class="kt">::</span> <span class="kt">Boolean</span> <span class="kt">::</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">HNil</span><span class="o">)</span> <span class="kt">::</span> <span class="kt">HNil</span> <span class="o">]</span>
</span><span class='line'><span class="n">res4</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Float</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.HNil</span><span class="o">]]</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Int</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Boolean</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]]]</span> <span class="k">=</span>
</span><span class='line'><span class="nc">JsSuccess</span><span class="o">(</span><span class="n">toto</span> <span class="o">::</span> <span class="mf">123.45</span> <span class="o">::</span> <span class="n">tutu</span> <span class="o">::</span> <span class="nc">HNil</span> <span class="o">::</span> <span class="mi">123</span> <span class="o">::</span> <span class="mi">123</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="n">blabla</span> <span class="o">::</span> <span class="nc">HNil</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">,)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// validates with ERROR JsArray into HList</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="mi">123L</span><span class="o">).</span><span class="n">validate</span><span class="o">[</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">HNil</span> <span class="o">]</span> <span class="n">must</span> <span class="n">beEqualTo</span><span class="o">(</span> <span class="nc">JsError</span><span class="o">(</span><span class="s">&quot;validate.error.expected.jsnumber&quot;</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">23</span><span class="k">:</span> <span class="kt">error:</span> <span class="kt">value</span> <span class="kt">must</span> <span class="kt">is</span> <span class="kt">not</span> <span class="kt">a</span> <span class="kt">member</span> <span class="kt">of</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span>
</span><span class='line'>                    <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">,</span> <span class="mi">123L</span><span class="o">).</span><span class="n">validate</span><span class="o">[</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">HNil</span> <span class="o">]</span> <span class="n">must</span> <span class="n">beEqualTo</span><span class="o">(</span> <span class="nc">JsError</span><span class="o">(</span><span class="s">&quot;validate.error.expected.jsnumber&quot;</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// converts HList to JsValue</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="mf">123.45F</span> <span class="o">::</span> <span class="s">&quot;tutu&quot;</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span>
</span><span class='line'><span class="n">res6</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">[</span><span class="err">123</span><span class="kt">.</span><span class="err">44999694824219</span>,<span class="err">&quot;</span><span class="kt">tutu</span><span class="err">&quot;</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h2>A few Json Reads/Writes[HList] samples</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.functional.syntax._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a Reads[ String :: Long :: (String :: Boolean :: HNil) :: HNil]</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="nc">HListReads2</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>     <span class="o">|</span>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;foo&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>     <span class="o">|</span>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;bar&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>     <span class="o">|</span>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;toto&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span>
</span><span class='line'>     <span class="o">|</span>      <span class="o">(</span>
</span><span class='line'>     <span class="o">|</span>        <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;alpha&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>     <span class="o">|</span>        <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;beta&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span>
</span><span class='line'>     <span class="o">|</span>      <span class="o">).</span><span class="n">tupled</span><span class="o">.</span><span class="n">hlisted</span>
</span><span class='line'>     <span class="o">|</span>    <span class="o">)</span>
</span><span class='line'>     <span class="o">|</span> <span class="o">).</span><span class="n">tupled</span><span class="o">.</span><span class="n">hlisted</span>
</span><span class='line'><span class="nc">HListReads2</span><span class="k">:</span> <span class="kt">play.api.libs.json.Reads</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Boolean</span>,<span class="kt">shapeless.HNil</span><span class="o">]]</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]]</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="nc">Reads$$anon$8</span><span class="k">@</span><span class="mi">7</span><span class="n">e4a09ee</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// validates/converts JsObject to HList</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>     <span class="o">|</span>   <span class="s">&quot;foo&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span>
</span><span class='line'>     <span class="o">|</span>   <span class="s">&quot;bar&quot;</span> <span class="o">-&gt;</span> <span class="mi">123L</span><span class="o">,</span>
</span><span class='line'>     <span class="o">|</span>   <span class="s">&quot;toto&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>     <span class="o">|</span>      <span class="s">&quot;alpha&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;chboing&quot;</span><span class="o">,</span>
</span><span class='line'>     <span class="o">|</span>      <span class="s">&quot;beta&quot;</span> <span class="o">-&gt;</span> <span class="kc">true</span>
</span><span class='line'>     <span class="o">|</span>   <span class="o">)</span>
</span><span class='line'>     <span class="o">|</span> <span class="o">).</span><span class="n">validate</span><span class="o">(</span><span class="nc">HListReads2</span><span class="o">)</span>
</span><span class='line'><span class="n">res7</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Boolean</span>,<span class="kt">shapeless.HNil</span><span class="o">]]</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]]</span> <span class="k">=</span>
</span><span class='line'><span class="nc">JsSuccess</span><span class="o">(</span><span class="n">toto</span> <span class="o">::</span> <span class="mi">123</span> <span class="o">::</span> <span class="n">chboing</span> <span class="o">::</span> <span class="kc">true</span> <span class="o">::</span> <span class="nc">HNil</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">,)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create a Writes[String :: Long :: HNil]</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">implicit</span> <span class="k">val</span> <span class="nc">HListWrites</span><span class="k">:</span> <span class="kt">Writes</span><span class="o">[</span> <span class="kt">String</span> <span class="kt">::</span> <span class="kt">Long</span> <span class="kt">::</span> <span class="kt">HNil</span> <span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>     <span class="o">|</span>         <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;foo&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>     <span class="o">|</span>         <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;bar&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>
</span><span class='line'>     <span class="o">|</span>       <span class="o">).</span><span class="n">tupled</span><span class="o">.</span><span class="n">hlisted</span>
</span><span class='line'><span class="nc">HListWrites</span><span class="k">:</span> <span class="kt">play.api.libs.json.Writes</span><span class="o">[</span><span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">String</span>,<span class="kt">shapeless.::</span><span class="o">[</span><span class="kt">Long</span>,<span class="kt">shapeless.HNil</span><span class="o">]]]</span> <span class="k">=</span> <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="nc">Writes$$anon$5</span><span class="k">@</span><span class="mi">7</span><span class="n">c9d07e2</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// writes a HList to JsValue</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="s">&quot;toto&quot;</span> <span class="o">::</span> <span class="mi">123L</span> <span class="o">::</span> <span class="nc">HNil</span><span class="o">)</span>
</span><span class='line'><span class="n">res8</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;foo&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">toto</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;bar&quot;</span><span class="k">:</span><span class="err">123</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Adding shapelaysson in your dependencies</h2>

<p>In your <code>Build.scala</code>, add:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">sbt._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Keys._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">ApplicationBuild</span> <span class="k">extends</span> <span class="nc">Build</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">mandubianRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;Mandubian repository snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/snapshots/&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;Mandubian repository releases&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/releases/&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">sonatypeRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;Sonatype OSS Releases&quot;</span> <span class="n">at</span> <span class="s">&quot;http://oss.sonatype.org/content/repositories/releases/&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;Sonatype OSS Snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;http://oss.sonatype.org/content/repositories/snapshots/&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">lazy</span> <span class="k">val</span> <span class="n">playJsonAlone</span> <span class="k">=</span> <span class="nc">Project</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">BuildSettings</span><span class="o">.</span><span class="n">buildName</span><span class="o">,</span> <span class="n">file</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">),</span>
</span><span class='line'>    <span class="n">settings</span> <span class="k">=</span> <span class="nc">BuildSettings</span><span class="o">.</span><span class="n">buildSettings</span> <span class="o">++</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>      <span class="n">resolvers</span> <span class="o">++=</span> <span class="n">mandubianRepo</span> <span class="o">++</span> <span class="n">sonatypeRepo</span><span class="o">,</span>
</span><span class='line'>      <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>        <span class="s">&quot;org.mandubian&quot;</span>  <span class="o">%%</span> <span class="s">&quot;shapelaysson&quot;</span>  <span class="o">%</span> <span class="s">&quot;0.1-SNAPSHOT&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;org.specs2&quot;</span>     <span class="o">%%</span> <span class="s">&quot;specs2&quot;</span>        <span class="o">%</span> <span class="s">&quot;1.13&quot;</span> <span class="o">%</span> <span class="s">&quot;test&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;junit&quot;</span>           <span class="o">%</span> <span class="s">&quot;junit&quot;</span>         <span class="o">%</span> <span class="s">&quot;4.8&quot;</span> <span class="o">%</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>      <span class="o">)</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>More to come maybe in this draft project&#8230;
Suggestions are welcome too</p>

<p>Have Fun :: HNil!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/02/22/scala-future-fatal-exception/">Being Aware Scala 2.10.0 Futures Conceal Fatal Exceptions</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-22T14:14:00+01:00" pubdate data-updated="true">Feb 22<span>nd</span>, 2013</time>
        
         | <a href="/2013/02/22/scala-future-fatal-exception/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>A short article to talk about <strong>an interesting issue concerning Scala 2.10.0 Future that might interest you</strong>.</p>

<div class="well">
<h3>Summary</h3><br/>
<p>When a <code>Fatal</code> exception is thrown in your <code>Future</code> callback, it&#8217;s not caught by the <code>Future</code> and is thrown to the provided <code>ExecutionContext</code>.</p>
<p><i>But the current default Scala global <code>ExecutionContext</code> doesn&#8217;t register an <code>UncaughtExceptionHandler</code> for these fatal exceptions and your <code>Future</code> just hangs forever without notifying anything to anybody.</i></p>
</div>


<blockquote><p>This issue is well <a href="https://issues.scala-lang.org/browse/SI-7029">known</a> and a solution to the problem has already been <a href="https://github.com/scala/scala/pull/2044">merged</a> into branch 2.10.x. But this issue is present in Scala 2.10.0 so it&#8217;s interesting to keep this issue in mind IMHO. Let&#8217;s explain clearly about it.</p></blockquote>

<h2>Exceptions can be contained by Future</h2>

<p>Let&#8217;s write some stupid code with Futures.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">scala.concurrent._</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Take default Scala global ExecutionContext which is a ForkJoin Thread Pool</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">ec</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">ExecutionContext</span><span class="o">.</span><span class="n">global</span>
</span><span class='line'><span class="n">ec</span><span class="k">:</span> <span class="kt">scala.concurrent.ExecutionContextExecutor</span> <span class="o">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">ExecutionContextImpl</span><span class="k">@</span><span class="mi">15</span><span class="n">f445b7</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create an immediately redeemed Future with a simple RuntimeException</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">f</span> <span class="k">=</span> <span class="n">future</span><span class="o">(</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">RuntimeException</span><span class="o">(</span><span class="s">&quot;foo&quot;</span><span class="o">)</span> <span class="o">)(</span><span class="n">ec</span><span class="o">)</span>
</span><span class='line'><span class="n">f</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="k">@</span><span class="mi">27380357</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Access brutally the value to show that the Future contains my RuntimeException</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span>
</span><span class='line'><span class="n">res22</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">scala.util.Try</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">Failure</span><span class="o">(</span><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="nc">RuntimeException</span><span class="k">:</span> <span class="kt">foo</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Use blocking await to get Future result</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="mi">2</span> <span class="n">seconds</span><span class="o">)</span>
</span><span class='line'><span class="n">warning</span><span class="k">:</span> <span class="kt">there</span> <span class="kt">were</span> <span class="err">1</span> <span class="kt">feature</span> <span class="kt">warnings</span><span class="o">;</span> <span class="n">re</span><span class="o">-</span><span class="n">run</span> <span class="k">with</span> <span class="o">-</span><span class="n">feature</span> <span class="k">for</span> <span class="n">details</span>
</span><span class='line'><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="nc">RuntimeException</span><span class="k">:</span> <span class="kt">foo</span>
</span><span class='line'>  <span class="n">at</span> <span class="nc">$anonfun$1</span><span class="o">.</span><span class="n">apply</span><span class="o">(&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">14</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="nc">$anonfun$1</span><span class="o">.</span><span class="n">apply</span><span class="o">(&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">14</span><span class="o">)</span>
</span><span class='line'>  <span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>You can see that a <code>Future</code> can contain an <code>Exception</code> (or more generally <code>Throwable</code>).</p></blockquote>

<br/>


<h2>Fatal Exceptions can&#8217;t be contained by Future</h2>

<p>If you look in <a href="https://github.com/scala/scala/blob/v2.10.0/src/library/scala/concurrent/Future.scala#L53">Scala 2.10.0 Future.scala</a>, in the scaladoc, you can find:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>* The following throwable objects are not contained in the future:
</span><span class='line'>* - `Error` - errors are not contained within futures
</span><span class='line'>* - `InterruptedException` - not contained within futures
</span><span class='line'>* - all `scala.util.control.ControlThrowable` except `NonLocalReturnControl` - not contained within futures</span></code></pre></td></tr></table></div></figure>


<p>and in the code, in several places, in <code>map</code> or <code>flatMap</code> for example, you can read:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'><span class="o">...</span>
</span><span class='line'><span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="nc">NonFatal</span><span class="o">(</span><span class="n">t</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">p</span> <span class="n">failure</span> <span class="n">t</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>This means that every <code>Throwable</code> that is Fatal can&#8217;t be contained in the <code>Future.Failure</code>.</p></blockquote>

<br/>


<h2>What&#8217;s a <em>Fatal</em> Throwable?</h2>

<p>To define what&#8217;s fatal, let&#8217;s see what&#8217;s declared as non-fatal in <a href="http://www.scala-lang.org/archives/downloads/distrib/files/nightly/docs/library/index.html#scala.util.control.NonFatal$">NonFatal ScalaDoc</a>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>* Extractor of non-fatal Throwables.  
</span><span class='line'>* Will not match fatal errors like VirtualMachineError  
</span><span class='line'>* (for example, OutOfMemoryError, a subclass of VirtualMachineError),  
</span><span class='line'>* ThreadDeath, LinkageError, InterruptedException, ControlThrowable, or NotImplementedError. 
</span><span class='line'>*
</span><span class='line'>* Note that [[scala.util.control.ControlThrowable]], an internal Throwable, is not matched by
</span><span class='line'>* `NonFatal` (and would therefore be thrown).</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Let&#8217;s consider Fatal exceptions are just critical errors that can&#8217;t be recovered in general.</p></blockquote>

<h2>So what&#8217;s the problem?</h2>

<p>It seems right not to catch fatal errors in the `Future, isn&#8217;t it?</p>

<p>But, look at following code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Let&#39;s throw a simple Fatal exception</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">f</span> <span class="k">=</span> <span class="n">future</span><span class="o">(</span> <span class="k">throw</span> <span class="k">new</span> <span class="nc">NotImplementedError</span><span class="o">()</span> <span class="o">)(</span><span class="n">ec</span><span class="o">)</span>
</span><span class='line'><span class="n">f</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="k">@</span><span class="mi">59747</span><span class="n">b17</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">f</span><span class="o">.</span><span class="n">value</span>
</span><span class='line'><span class="n">res0</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">scala.util.Try</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">None</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok, the <code>Future</code> doesn&#8217;t contain the Fatal Exception as expected.</p>

<p><strong>But where is my Fatal Exception if it&#8217;s not caught??? No crash, notification or whatever?</strong></p>

<p>There should be an `UncaughtExceptionHandler at least notifying it!</p>

<br/>


<h2>The problem is in the default Scala <code>ExecutionContext</code>.</h2>

<p>As explained in this <a href="https://issues.scala-lang.org/browse/SI-7029">issue</a>, the exception is lost due to the implementation of the default global <code>ExecutionContext</code> provided in Scala.</p>

<p>This is a simple ForkJoin pool of threads but it has no <code>UncaughtExceptionHandler</code>. Have a look at code in <a href="https://github.com/scala/scala/blob/v2.10.0/src/library/scala/concurrent/impl/ExecutionContextImpl.scala#L72">Scala 2.10.0 ExecutionContextImpl.scala</a></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">try</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">new</span> <span class="nc">ForkJoinPool</span><span class="o">(</span>
</span><span class='line'>        <span class="n">desiredParallelism</span><span class="o">,</span>
</span><span class='line'>        <span class="n">threadFactory</span><span class="o">,</span>
</span><span class='line'>        <span class="kc">null</span><span class="o">,</span> <span class="c1">//FIXME we should have an UncaughtExceptionHandler, see what Akka does</span>
</span><span class='line'>        <span class="kc">true</span><span class="o">)</span> <span class="c1">// Async all the way baby</span>
</span><span class='line'>    <span class="o">}</span> <span class="k">catch</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">NonFatal</span><span class="o">(</span><span class="n">t</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="o">...</span>
</span><span class='line'>    <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Here it&#8217;s quite clear: there is no registered `UncaughtExceptionHandler.</p>

<p>What&#8217;s the consequence?</p></blockquote>

<h2>Your Future hangs forever</h2>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">Await</span><span class="o">.</span><span class="n">result</span><span class="o">(</span><span class="n">f</span><span class="o">,</span> <span class="mi">30</span> <span class="n">seconds</span><span class="o">)</span>
</span><span class='line'><span class="n">warning</span><span class="k">:</span> <span class="kt">there</span> <span class="kt">were</span> <span class="err">1</span> <span class="kt">feature</span> <span class="kt">warnings</span><span class="o">;</span> <span class="n">re</span><span class="o">-</span><span class="n">run</span> <span class="k">with</span> <span class="o">-</span><span class="n">feature</span> <span class="k">for</span> <span class="n">details</span>
</span><span class='line'><span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">TimeoutException</span><span class="k">:</span> <span class="kt">Futures</span> <span class="kt">timed</span> <span class="kt">out</span> <span class="kt">after</span> <span class="o">[</span><span class="err">30</span> <span class="kt">seconds</span><span class="o">]</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="o">.</span><span class="n">ready</span><span class="o">(</span><span class="nc">Promise</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">96</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, you can wait as long as you want, the Future is never redeemed properly, it just hangs forever and you don&#8217;t even know that a Fatal Exception has been thrown.</p>

<p>As explained in the issue, please note, if you use a custom <code>ExecutionContext</code> based on <code>SingleThreadExecutor</code>, this issue doesn&#8217;t appear!</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">es</span> <span class="k">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">Executors</span><span class="o">.</span><span class="n">newSingleThreadExecutor</span>
</span><span class='line'><span class="n">es</span><span class="k">:</span> <span class="kt">java.util.concurrent.ExecutorService</span> <span class="o">=</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">Executors$FinalizableDelegatedExecutorService</span><span class="k">@</span><span class="mi">1</span><span class="n">e336f59</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">ec</span> <span class="k">=</span> <span class="nc">ExecutionContext</span><span class="o">.</span><span class="n">fromExecutorService</span><span class="o">(</span><span class="n">es</span><span class="o">)</span>
</span><span class='line'><span class="n">ec</span><span class="k">:</span> <span class="kt">scala.concurrent.ExecutionContextExecutorService</span> <span class="o">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">ExecutionContextImpl$$anon$1</span><span class="k">@</span><span class="mi">34</span><span class="n">f43dac</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span>  <span class="k">val</span> <span class="n">f</span> <span class="k">=</span> <span class="nc">Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">](</span><span class="k">throw</span> <span class="k">new</span> <span class="nc">NotImplementedError</span><span class="o">())(</span><span class="n">ec</span><span class="o">)</span>
</span><span class='line'><span class="nc">Exception</span> <span class="n">in</span> <span class="n">thread</span> <span class="s">&quot;pool-1-thread-1&quot;</span> <span class="n">f</span><span class="k">:</span> <span class="kt">scala.concurrent.Future</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="nc">Promise$DefaultPromise</span><span class="k">@</span><span class="mi">7</span><span class="n">d01f935</span>
</span><span class='line'><span class="n">scala</span><span class="o">.</span><span class="nc">NotImplementedError</span><span class="k">:</span> <span class="kt">an</span> <span class="kt">implementation</span> <span class="kt">is</span> <span class="kt">missing</span>
</span><span class='line'>  <span class="n">at</span> <span class="nc">$line41</span><span class="o">.</span><span class="nc">$read$$iw$$iw$$iw$$iw$$iw$$iw$$anonfun$1</span><span class="o">.</span><span class="n">apply</span><span class="o">(&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">15</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="nc">$line41</span><span class="o">.</span><span class="nc">$read$$iw$$iw$$iw$$iw$$iw$$iw$$anonfun$1</span><span class="o">.</span><span class="n">apply</span><span class="o">(&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">15</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Conclusion</h2>

<p><strong>In Scala 2.10.0, if you have a Fatal Exception in a Future callback, your Future just trashes the Fatal Exception and hangs forever without notifying anything.</strong></p>

<p>Hopefully, due to this <a href="https://github.com/scala/scala/pull/2044">already merged PR</a>, in a future delivery of Scala 2.10.x, this problem should be corrected.</p>

<p>To finish, in the same old good <a href="https://issues.scala-lang.org/browse/SI-7029">issue</a>, Viktor Klang also raised the question of what should be considered as fatal or not:</p>

<blockquote><p>there&#8217;s a bigger topic at hand here, the one whether NotImplementedError, InterruptedException and ControlThrowable are to be considered fatal or not.</p></blockquote>

<p>Meanwhile, be aware and take care ;)</p>

<p>Have <code>Promise[NonFatal]</code>!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/02/21/play-json-stand-alone/">Playing With Play2 SCALA JSON API Stand-alone</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-21T14:14:00+01:00" pubdate data-updated="true">Feb 21<span>st</span>, 2013</time>
        
         | <a href="/2013/02/21/play-json-stand-alone/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>In a very recent <a href="https://github.com/playframework/Play20/pull/754">Pull Request</a>, `play-json has been made a stand-alone module in <a href="https://github.com/playframework/Play20">Play2.2-SNAPSHOT master</a> as play-iteratees.</p>

<p>It means:</p>

<ul>
<li>You can take Play2 Scala Json API as a stand-alone library and keep using Json philosophy promoted by <a href="http://www.playframework.org">Play Framework</a> anywhere.</li>
<li><code>play-json</code> module is stand-alone in terms of dependencies but is a part &amp; parcel of Play2.2 so it will evolve and follow Play2.x releases (and following versions) always ensuring full compatibility with play ecosystem.</li>
<li><code>play-json</code> module has 3 ultra lightweight dependencies:

<ul>
<li> <code>play-functional</code></li>
<li> <code>play-datacommons</code></li>
<li> <code>play-iteratees</code></li>
</ul>
</li>
</ul>


<p>These are pure Scala generic pieces of code from Play framework so no Netty or whatever dependencies in it.<br/>
You can then import <code>play-json</code> in your project without any fear of bringing unwanted deps.</p>

<p><code>play-json</code> will be released with future Play2.2 certainly so meanwhile, I provide:</p>

<ul>
<li>a build published in my <a href="https://github.com/mandubian/mandubian-mvn/">Maven Github repository</a></li>
<li>a sample project called <a href="https://github.com/mandubian/play-json-alone">play-json-alone</a></li>
</ul>


<br/>


<blockquote><p>Even if the version is <em>2.2-SNAPSHOT</em>, be aware that this is the same code as the one released in Play 2.1.0. This API has reached a good stability level. Enhancements and bug corrections will be brought to it but it&#8217;s production-ready right now.</p></blockquote>

<h2>Adding play-json 2.2-SNAPSHOT in your dependencies</h2>

<p>In your <code>Build.scala</code>, add:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">sbt._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Keys._</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">ApplicationBuild</span> <span class="k">extends</span> <span class="nc">Build</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">val</span> <span class="n">mandubianRepo</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;Mandubian repository snapshots&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/snapshots/&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;Mandubian repository releases&quot;</span> <span class="n">at</span> <span class="s">&quot;https://github.com/mandubian/mandubian-mvn/raw/master/releases/&quot;</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">lazy</span> <span class="k">val</span> <span class="n">playJsonAlone</span> <span class="k">=</span> <span class="nc">Project</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">BuildSettings</span><span class="o">.</span><span class="n">buildName</span><span class="o">,</span> <span class="n">file</span><span class="o">(</span><span class="s">&quot;.&quot;</span><span class="o">),</span>
</span><span class='line'>    <span class="n">settings</span> <span class="k">=</span> <span class="nc">BuildSettings</span><span class="o">.</span><span class="n">buildSettings</span> <span class="o">++</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>      <span class="n">resolvers</span> <span class="o">++=</span> <span class="n">mandubianRepo</span><span class="o">,</span>
</span><span class='line'>      <span class="n">libraryDependencies</span> <span class="o">++=</span> <span class="nc">Seq</span><span class="o">(</span>
</span><span class='line'>        <span class="s">&quot;play&quot;</span>        <span class="o">%%</span> <span class="s">&quot;play-json&quot;</span> <span class="o">%</span> <span class="s">&quot;2.2-SNAPSHOT&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;org.specs2&quot;</span>  <span class="o">%%</span> <span class="s">&quot;specs2&quot;</span> <span class="o">%</span> <span class="s">&quot;1.13&quot;</span> <span class="o">%</span> <span class="s">&quot;test&quot;</span><span class="o">,</span>
</span><span class='line'>        <span class="s">&quot;junit&quot;</span>        <span class="o">%</span> <span class="s">&quot;junit&quot;</span> <span class="o">%</span> <span class="s">&quot;4.8&quot;</span> <span class="o">%</span> <span class="s">&quot;test&quot;</span>
</span><span class='line'>      <span class="o">)</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2>Using play-json 2.2-SNAPSHOT in your code:</h2>

<p>Just import the following and get everything from Play2.1 Json API:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.functional._</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">EucalyptusTree</span><span class="o">(</span><span class="n">col</span><span class="k">:</span><span class="kt">Int</span><span class="o">,</span> <span class="n">row</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">EucalyptusTree</span><span class="o">{</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">fmt</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">format</span><span class="o">[</span><span class="kt">EucalyptusTree</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Koala</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">home</span><span class="k">:</span> <span class="kt">EucalyptusTree</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">object</span> <span class="nc">Koala</span><span class="o">{</span>
</span><span class='line'>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">fmt</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">format</span><span class="o">[</span><span class="kt">Koala</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">kaylee</span> <span class="k">=</span> <span class="nc">Koala</span><span class="o">(</span><span class="s">&quot;kaylee&quot;</span><span class="o">,</span> <span class="nc">EucalyptusTree</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">23</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">println</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">prettyPrint</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">kaylee</span><span class="o">)))</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Json</span><span class="o">.</span><span class="n">fromJson</span><span class="o">[</span><span class="kt">Koala</span><span class="o">](</span>
</span><span class='line'>  <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;kaylee&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;home&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>      <span class="s">&quot;col&quot;</span> <span class="o">-&gt;</span> <span class="mi">10</span><span class="o">,</span>
</span><span class='line'>      <span class="s">&quot;row&quot;</span> <span class="o">-&gt;</span> <span class="mi">23</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Using <code>play-json</code>, you can get some bits of <a href="http://www.playframework.org">Play Framework</a> pure Web philosophy.<br/>
Naturally, to unleash its full power, don&#8217;t hesitate to dive into <a href="http://www.playframework.org">Play Framework</a> and discover 100% full Web Reactive Stack ;)</p></blockquote>

<p>Thanks a lot to Play Framework team for promoting play-json as stand-alone module!<br/>
Lots of interesting features incoming soon ;)</p>

<p>Have fun!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/02/18/datomisca-fact-operations/">Datomisca Delicatessen - the Scala Reactive Cherry on the Datomic Cake of Facts</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-18T14:14:00+01:00" pubdate data-updated="true">Feb 18<span>th</span>, 2013</time>
        
         | <a href="/2013/02/18/datomisca-fact-operations/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Let&#8217;s go on unveiling <a href="http://pellucidanalytics.github.com/datomisca/index.html">Datomisca</a> a bit more.</p>

<p>Remember Datomisca is an opensource Scala API (sponsored by <a href="http://www.pellucidanalytics.com">Pellucid</a> and <a href="http://www.zenexity.com">Zenexity</a>) trying to enhance <a href="http://www.datomic.com">Datomic</a> experience for Scala developers.</p>

<p>After evoking <a href="./2013-02-10-datomisca-query.html">queries compiled by Scala macros in previous article</a>, I&#8217;m going to describe how <em>Datomisca</em> allows to create Datomic fact operations in a programmatic way and sending them to Datomic transactor using asynchronous/non-blocking API based on <em>Scala 2.10 Future/ExecutionContext</em>.</p>

<br/>


<h1><a name="datomic-facts">Facts about Datomic</a></h1>

<p>First, let&#8217;s remind a few facts about Datomic:</p>

<blockquote><p>Datomic is a <a href="http://docs.datomic.com/query.html">immutable fact-oriented distributed schema-constrained database</a></p></blockquote>

<p>It means:</p>

<h4>Datomic stores very small units of data called <em>facts</em></h4>

<p>Yes no tables, documents or even columns in Datomic. Everything stored in it is a very small fact.</p>

<br/>


<h4><em>Fact</em> is the atomic unit of data</h4>

<p>Facts are represented by the following tuple called <strong>Datom</strong></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">datom</span> <span class="nb">= </span><span class="p">[</span><span class="nv">entity</span> <span class="nv">attribute</span> <span class="nv">value</span> <span class="nv">tx</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><em>entity</em> is an ID and several facts can share the same ID making them facts of the same entity. <strong>Here you can see that an entity is very loose concept in Datomic.</strong></li>
<li><em>attribute</em> is just a namespaced keyword : <code>:person/name</code> which is generally constrained by a typed schema attribute. <strong>The namespace can be used to logically identify an entity like <em>&#8220;person&#8221;</em> by regrouping several attributes in the same namespace.</strong></li>
<li><em>value</em> is the value of this attribute for this entity at this instant</li>
<li><em>tx</em> uniquely identifies the <a href="http://docs.datomic.com/glossary.html#sec-35">transaction</a> in which this fact was inserted. Naturally a transaction is associated with a time.</li>
</ul>


<br/>


<h4><em>Facts</em> are immutable &amp; temporal</h4>

<p>It means that:</p>

<ul>
<li><strong>You can&#8217;t change the past</strong><br/>
Facts are immutable ie you can&#8217;t mutate a fact as other databases generally do: Datomic always creates a new version of the fact with a new value.</li>
<li><strong>Datomic always grows</strong><br/>
If you add more facts, nothing is deleted so the DB grows. Naturally you can truncate a DB, export it and rebuild a new smaller one.</li>
<li><strong>You can foresee a possible future</strong><br/>
From your present, you can temporarily add facts to Datomic without committing them on central storage thus simulating a possible future.</li>
</ul>


<br/>


<h4>Reads/writes are distributed across different components</h4>

<ul>
<li><strong>One Storage service</strong> storing physically the data (Dynamo DB/Infinispan/Postgres/Riak/&#8230;)</li>
<li><strong>Multiple Peers</strong> (generally local to your app instances) behaving like high-speed synchronized cache obfuscating all the local data storage and synchro mechanism and providing the <em>Datalog</em> queries.</li>
<li><strong>One (or several) transactor(s)</strong> centralizing the write mechanism allowing ACID transactions and notifying peers about those evolutions.</li>
</ul>


<p>For more info about architecture, go to <a href="http://docs.datomic.com/architecture.html">this page</a></p>

<br/>


<h4>Immutability means known DB state is always consistent</h4>

<p>You might not be up-to-date with central data storage as Datomic is distributed, you can even lose connection with it but the data you know are always consistent because nothing can be mutated.</p>

<blockquote><p>This immutability concept is one of the most important to understand in Datomic.</p></blockquote>

<br/>


<h4>Schema contrains entity attributes</h4>

<p>Datomic allows to define that a given attribute must :</p>

<ul>
<li>be of <strong>given type</strong> : <code>String</code> or <code>Long</code> or <code>Instant</code> etcâ€¦</li>
<li>have <strong>cardinality</strong> (<code>one</code> or <code>many</code>)</li>
<li>be <strong>unique</strong> or not</li>
<li>be <strong>fullsearchable</strong> or not</li>
<li>be <strong>documented</strong></li>
<li>â€¦</li>
</ul>


<p>It means that if you try to insert a fact with an attribute and a value of the wrong type, Datomic will refuse it.</p>

<p>Datomic entity can also reference other entities in Datomic providing relations in Datomic (even if Datomic is not RDBMS). One interesting thing to know is that <strong>all relations in Datomic are bidirectional.</strong></p>

<blockquote><p>I hope you immediately see the link between these typed schema attributes and potential Scala type-safe featuresâ€¦</p></blockquote>

<br/>


<blockquote><p><strong>Author&#8217;s note : Datomic is more about <em>evolution</em> than mutation</strong><br/>
<em>I&#8217;ll let you meditate this sentence linked to theory of evolution ;)</em></p></blockquote>

<br/>


<h1><a name="datomic-ops">Datomic operations</a></h1>

<p>When you want to create a new fact in Datomic, you send a write operation request to the <code>Transactor</code>.</p>

<h2><a name="datomic-ops-basic">Basic operations</a></h2>

<p>There are 2 basic operations:</p>

<h4>Add a Fact</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="nv">entity-id</span> <span class="nv">attribute</span> <span class="nv">value</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding a fact for the same entity will <em>NOT update</em> existing fact but create a new fact with same <em>entity-id</em> and a new <em>tx</em>.</p>

<h4>Retract a Fact</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="ss">:db/retract</span> <span class="nv">entity-id</span> <span class="nv">attribute</span> <span class="nv">value</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Retracting a fact doesn&#8217;t erase any fact but just tells: <em>&#8220;for this entity-id, from now, there is no more this attribute&#8221;</em></p>

<p>You might wonder why providing the value when you want to remove a fact? This is because an attribute can have a <em>MANY</em> cardinality in which case you want to remove just a value from the set of values.</p>

<h2><a name="datomic-ops-entity">Entity operations</a></h2>

<p>In Datomic, you often manipulate groups of facts identifying an entity. An entity has no physical existence in Datomic but is just a group of facts having the same <em>entity-id</em>. Generally, the attributes constituting an entity are logically grouped under the same namespace (<code>:person/name</code>, <code>:person/age</code>â€¦) but this is not mandatory at all.</p>

<p>Datomic provides 2 operations to manipulate entities directly</p>

<h4>Add Entity</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span> <span class="mi">-1</span><span class="p">]</span>
</span><span class='line'>  <span class="ss">:person/name</span> <span class="s">&quot;Bob&quot;</span>
</span><span class='line'>  <span class="ss">:person/spouse</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span> <span class="mi">-2</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually this is equivalent to 2 <em>Add-Fact</em> operations:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span> <span class="mi">-1</span><span class="p">])</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="nv">id</span> <span class="ss">:person/name</span> <span class="s">&quot;Bob&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="nv">id</span> <span class="ss">:person/age</span> <span class="mi">30</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Retract Entity</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="ss">:db.fn/retractEntity</span> <span class="nv">entity-id</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2><a name="datomic-ops-ident">Special case of identified values</a></h2>

<p>In Datomic, there are special entities built using the special attribute <code>:db/ident</code> of type <code>Keyword</code> which are said to be <em>identified by the given keyword</em>.</p>

<p>There are created as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:person.characters/clever</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:person.characters/dumb</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you use <code>:person.characters/clever</code> or <code>:person.characters/dumb</code>, it references directly one of those 2 entities without using their ID.</p>

<p>You can see those identified entities as enumerated values also.</p>

<p>Now that you know how it works in Datomic, let&#8217;s go to <em>Datomisca</em>!</p>

<br/>


<h1><a name="datomisca-ops">Datomisca programmatic operations</a></h1>

<p>Datomisca&#8217;s preferred way to build Fact/Entity operations is programmatic because it provides more flexibility to Scala developers.
Here are the translation of previous operations in Scala:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a Namespace</span>
</span><span class='line'><span class="k">val</span> <span class="n">person</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;person&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a add-fact operation </span>
</span><span class='line'><span class="c1">// It creates the datom (id keyword value _) from</span>
</span><span class='line'><span class="c1">//   - a temporary id (or a final long ID)</span>
</span><span class='line'><span class="c1">//   - the couple `(keyword, value)`</span>
</span><span class='line'><span class="k">val</span> <span class="n">addFact</span> <span class="k">=</span> <span class="nc">Fact</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;Bob&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a retract-fact operation</span>
</span><span class='line'><span class="k">val</span> <span class="n">retractFact</span> <span class="k">=</span> <span class="nc">Fact</span><span class="o">.</span><span class="n">retract</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span> <span class="o">-&gt;</span> <span class="mi">123L</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates identified values</span>
</span><span class='line'><span class="k">val</span> <span class="n">violent</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">character</span> <span class="o">/</span> <span class="s">&quot;violent&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">dumb</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">character</span> <span class="o">/</span> <span class="s">&quot;dumb&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a add-entity operation</span>
</span><span class='line'><span class="k">val</span> <span class="n">addEntity</span> <span class="k">=</span> <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;Bob&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span> <span class="o">-&gt;</span> <span class="mi">30L</span><span class="o">,</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;characters&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">violent</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">dumb</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a retract-entity operation from real Long ID of the entity</span>
</span><span class='line'><span class="k">val</span> <span class="n">retractEntity</span> <span class="k">=</span> <span class="nc">Entity</span><span class="o">.</span><span class="n">retract</span><span class="o">(</span><span class="mi">3L</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">addFact</span><span class="o">,</span> <span class="n">retractFact</span><span class="o">,</span> <span class="n">addEntity</span><span class="o">,</span> <span class="n">retractEntity</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that:</p>

<ul>
<li><code>person / "name"</code> creates the keyword <code>:person/name</code> from namespace <code>person</code></li>
<li><code>DId(Partition.USER)</code> generates a temporary Datomic Id in Partition <code>USER</code>. <em>Please note that you can create your own partition too</em>.</li>
<li><code>violent.ref</code> is used to access the keyword reference of the <em>identified entity</em>.</li>
<li><code>ops = Seq(â€¦)</code> represents a collection of operations to be sent to <em>transactor</em>.</li>
</ul>


<br/>


<h1><a name="datomisca-macro-ops">Datomisca Macro operations</a></h1>

<p>Remember the way Datomisca dealt with query by parsing/validating Datalog/Clojure queries at compile-time using Scala macros?</p>

<p>You can do the same in Datomisca with operations:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">weak</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span> <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span><span class="o">,</span> <span class="s">&quot;weak&quot;</span><span class="o">))</span>
</span><span class='line'><span class="k">val</span> <span class="n">dumb</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span> <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span><span class="o">,</span> <span class="s">&quot;dumb&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">ops</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[</span>
</span><span class='line'><span class="s">   [:db/add #db/id[:db.part/user] :db/ident :region/n]</span>
</span><span class='line'><span class="s">   [:db/add \${DId(Partition.USER)} :db/ident :region/n]</span>
</span><span class='line'><span class="s">   [:db/retract #db/id[:db.part/user] :db/ident :region/n]</span>
</span><span class='line'><span class="s">   [:db/retractEntity 1234]</span>
</span><span class='line'><span class="s">   {</span>
</span><span class='line'><span class="s">      :db/id \${id}</span>
</span><span class='line'><span class="s">      :person/name &quot;toto&quot;</span>
</span><span class='line'><span class="s">      :person/age 30</span>
</span><span class='line'><span class="s">      :person/characters [ \$weak \$dumb ]</span>
</span><span class='line'><span class="s">   }</span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It compiles what&#8217;s between <code>"""â€¦"""</code> at compile-time and tells you if there are errors and then it builds Scala corresponding operations.</p>

<p>Ok it&#8217;s cool but if you look better, you&#8217;ll see there is some sugar in this Clojure code:</p>

<ul>
<li><code>\${DId(Partition.USER)}</code></li>
<li><code>\$weak</code></li>
<li><code>\$dumb</code></li>
</ul>


<p><strong>You can use Scala variables and inject them into Clojure operations at compile-time as you do for Scala string interpolation</strong></p>

<blockquote><p>For Datomic queries, the compiled way is really natural but we tend to prefer programmatic way to build operations because it feels to be much more &#8220;scala-like&#8221; after experiencing both methods.</p></blockquote>

<h2><a name="datomisca-parse-ops">Datomisca runtime parsing</a></h2>

<p>There is a last way to create operations by parsing at runtime a String and throwing an exception if the syntax is not valid.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">parseOps</span><span class="o">(</span><span class="s">&quot;&quot;&quot; â€¦ &quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>It&#8217;s very useful if you have existing Datomic Clojure files (containing schema or bootstrap data) that you want to load into Datomic.</p></blockquote>

<br/>


<h1><a name="datomisca-transact">Datomisca reactive transactions</a></h1>

<p>Last but not the least, let&#8217;s send those operations to Datomic Transactor.</p>

<p>In its Java API, Datomic Connection provides a <code>transact</code> asynchronous API based on a <code>ListenableFuture</code>. This API can be enhanced in Scala because Scala provides much more evolved asynchronous/non-blocking facilities than Java based on Scala 2.10 <code>Future</code>/<code>ExecutionContext</code>.</p>

<p><code>Future</code> allows to implement your asynchronous call using continuation style based on Scala classic <code>map/flatMap</code> methods.
<code>ExecutionContext</code> is a great tool allowing to specify in which pool of threads your asynchronous call will be executed making it non-blocking with respect to your current execution context (or thread).</p>

<blockquote><p>This new feature is really important when you work with reactive API such as Datomisca or Play too so don&#8217;t hesitate to study it further.</p></blockquote>

<p>Let&#8217;s look at code directly to show how it works in <em>Datomisca</em>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// don&#39;t forget to bring an ExecutionContext in your scopeâ€¦ </span>
</span><span class='line'><span class="c1">// Here is default Scala ExecutionContext which is a simple pool of threads with one thread per core by default</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates an URI</span>
</span><span class='line'><span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;datomic:mem://mydatomicdn&quot;</span>
</span><span class='line'><span class="c1">// creates implicit connection</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// a few operations</span>
</span><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">addFact</span><span class="o">,</span> <span class="n">retractFact</span><span class="o">,</span> <span class="n">addEntity</span><span class="o">,</span> <span class="n">retractEntity</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="n">ops</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">:</span> <span class="kt">TxReport</span> <span class="o">=&gt;</span>
</span><span class='line'>   <span class="c1">// do something</span>
</span><span class='line'>   <span class="err">â€¦</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// return a value of type R (anything you want)</span>
</span><span class='line'>   <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="err">â€¦</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">res</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Another example by building ops directly in the transact call and using flatMap</span>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">id</span><span class="o">)(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">30L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">weak</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">dumb</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;tutu&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">54L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">violent</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">clever</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;tata&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">23L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">weak</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">clever</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="n">flatMap</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// do something</span>
</span><span class='line'>  <span class="err">â€¦</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="err">â€¦</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">res</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note the <code>tx: TxReport</code> which is a structure returned by Datomic transactor containing information about last transaction.</p></blockquote>

<h1><a name="datomisca-resolve">Datomisca resolving Real ID</a></h1>

<p>In all samples, we create operations based on temporary ID built by Datomic in a given partition.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But once you have inserted a fact or an entity into Datomic, you need to resolve the real final ID to use it further because the temporary ID is no more meaningful.</p>

<p>The final ID is resolved from the <code>TxReport</code> send back by Datomic transactor. This <code>TxReport</code> contains a map between temporary ID and final ID. Here is how you can use it in Datomisca:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">id1</span> <span class="k">=</span> <span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">id2</span> <span class="k">=</span> <span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">id1</span><span class="o">)(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">30L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">weak</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">dumb</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">id2</span><span class="o">)(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;tutu&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">54L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">violent</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">clever</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">finalId1</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">resolve</span><span class="o">(</span><span class="n">id1</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">finalId2</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">resolve</span><span class="o">(</span><span class="n">id2</span><span class="o">)</span>
</span><span class='line'>  <span class="c1">// or</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">List</span><span class="o">(</span><span class="n">finalId1</span><span class="o">,</span> <span class="n">finalId2</span><span class="o">)</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">id1</span><span class="o">,</span> <span class="n">id2</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span><span class="o">.</span><span class="n">resolve</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<div class="well">That&#8217;s all for nowâ€¦ Next articles about writing programmatic Datomic schema with Datomisca.</div>


<p>Have Promise[Fun]!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/02/10/datomisca-query/">Datomisca Delicatessen - Datomic Queries Coated in a Thin Layer of Scala</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-10T13:13:00+01:00" pubdate data-updated="true">Feb 10<span>th</span>, 2013</time>
        
         | <a href="/2013/02/10/datomisca-query/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Last week, we have launched <a href="http://pellucidanalytics.github.com/datomisca/index.html">Datomisca</a>, our opensource Scala API trying to enhance <a href="http://www.datomic.com">Datomic</a> experience for Scala developers.</p>

<p>Datomic is great in Clojure because it is was made for it. Yet, we believe Scala can provide a very good platform for Datomic too because the functional concepts found in Clojure are also in Scala except that Scala is a compiled and statically typed language whereas Clojure is dynamic. Scala could also bring a few features on top of Clojure based on its features such as static typing, typeclasses, macrosâ€¦</p>

<p>This article is the first of a serie of articles aiming at describing as shortly as possible specific features provided by Datomisca.
Today, let&#8217;s present how Datomisca enhances Datomic queries.</p>

<br/>


<h1><a name="datomic-query">Query in Datomic?</a></h1>

<p>Let&#8217;s take the same old example of a Person having :</p>

<ul>
<li>a name <code>String</code></li>
<li>a age <code>Long</code></li>
<li>a birth <code>Date</code></li>
</ul>


<p>So, how do you write a query in Datomic searching a person by its name?
Like thatâ€¦</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">(</span><span class="k">def</span> <span class="n">q</span> <span class="o">[</span> <span class="kt">:find</span> <span class="kt">?e</span>
</span><span class='line'>  <span class="kt">:in</span> <span class="kt">$</span> <span class="kt">?name</span>
</span><span class='line'>  <span class="kt">:where</span> <span class="o">[</span> <span class="kt">?e</span> <span class="kt">:person/name</span> <span class="kt">?name</span> <span class="o">]</span>
</span><span class='line'><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, this is Clojure using Datalog rules.</p>

<p>In a summary, this query:</p>

<ul>
<li>accepts 2 inputs parameters:

<ul>
<li>a datasource <code>$</code></li>
<li>a name parameter <code>?name</code></li>
</ul>
</li>
<li>searches facts respecting datalog rule <code>[ ?e :person/name ?name ]</code>: a fact having attribute <code>:person/name</code> with value <code>?name</code></li>
<li>returns the ID of the found facts <code>?e</code></li>
</ul>


<br/>


<h2><a name="datomic-query-reminders">Reminders about Datomic queries</a></h2>

<h3>Query is a static data structure</h3>

<p>An important aspect of queries to understand in Datomic is that a query is purely a static data structure and not something functional. We could compare it to a prepared statement in SQL: build it once and reuse it as much as you need.</p>

<h3>Query has input/ouput parameters</h3>

<p>In previous example:</p>

<ul>
<li><code>:in</code> enumerates input parameters</li>
<li><code>:find</code> enumerates output parameters</li>
</ul>


<p>When executing this query, you must provide the right number of input parameters and you will retrieve the given number of output parameters.</p>

<br/>


<h1><a name="datomisca-query">Query in Datomisca?</a></h1>

<p>So now, how do you write the same query in Datomisca?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">q</span>  <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">[ :find ?e</span>
</span><span class='line'><span class="s">  :in $ ?name</span>
</span><span class='line'><span class="s">  :where [ ?e :person/name ?name ] </span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>I see you&#8217;re a bit disappointed: a query as a string whereas in Clojure, it&#8217;s a real data structureâ€¦</p>

<p>This is actually the way the Java API sends query for now. Moreover, using strings like implies potential bad practices such as building queries by concatenating strings which are often the origin of risks of code injection in SQL for exampleâ€¦</p>

<p>But in Scala we can do a bit better using new Scala 2.10 features : Scala macros.</p>

<p><strong>So, using Datomisca, when you write this code, in fact, the query string is parsed by a Scala macro:</strong></p>

<ul>
<li><strong>If there are any error, the compilation breaks showing where the error was detected.</strong></li>
<li><strong>If the query seems valid (with respect to our parser), the String is actually replaced by a AST representing this query as a data structure.</strong></li>
<li><strong>The input/output parameters are infered to determine their numbers.</strong></li>
</ul>


<blockquote><p>Please note that the compiled query is a simple immutable AST which could be manipulated as a Clojure query and re-used as many times as you want.</p></blockquote>

<h3>Example OK with single output</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">q</span>  <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">     [ :find ?e</span>
</span><span class='line'><span class="s">       :in $ ?name</span>
</span><span class='line'><span class="s">       :where [ ?e :person/name ?name ] </span>
</span><span class='line'><span class="s">     ]&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">q</span><span class="k">:</span> <span class="kt">datomisca.TypedQueryAuto2</span><span class="o">[</span><span class="kt">datomisca.DatomicData</span>,<span class="kt">datomisca.DatomicData</span>,<span class="kt">datomisca.DatomicData</span><span class="o">]</span> <span class="k">=</span> <span class="o">[</span> <span class="kt">:find</span> <span class="kt">?e</span> <span class="kt">:in</span> <span class="kt">$</span> <span class="kt">?name</span> <span class="kt">:where</span> <span class="o">[</span><span class="kt">?e</span> <span class="kt">:person/name</span> <span class="kt">?name</span><span class="o">]</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without going in deep details, here you can see that the compiled version of <code>q</code> isn&#8217;t a <code>Query[String]</code> but a <code>TypedQueryAuto2[DatomicData, DatomicData, DatomicData]</code> being an AST representing the query.</p>

<p><code>TypedQueryAuto2[DatomicData, DatomicData, DatomicData]</code> means you have:</p>

<ul>
<li>2 input parameters <code>$ ?name</code> of type <code>DatomicData</code> and <code>DatomicData</code></li>
<li>Last type parameter represents output parameter <code>?e</code> of type <code>DatomicData</code></li>
</ul>


<p><em>Note : <code>DatomicData</code> is explained in next paragraph.</em></p>

<br/>


<h3>Example OK with several outputs</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">q</span>  <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">     [ :find ?e ?age</span>
</span><span class='line'><span class="s">       :in $ ?name</span>
</span><span class='line'><span class="s">       :where [ ?e :person/name ?name ] </span>
</span><span class='line'><span class="s">              [ ?e :person/age ?age ]  </span>
</span><span class='line'><span class="s">     ]&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'><span class="n">q</span><span class="k">:</span> <span class="kt">datomisca.TypedQueryAuto2</span><span class="o">[</span><span class="kt">datomisca.DatomicData</span>,<span class="kt">datomisca.DatomicData</span>,<span class="o">(</span><span class="kt">datomisca.DatomicData</span>, <span class="kt">datomisca.DatomicData</span><span class="o">)]</span> <span class="k">=</span> <span class="o">[</span> <span class="kt">:find</span> <span class="kt">?e</span> <span class="kt">?age</span> <span class="kt">:in</span> <span class="kt">$</span> <span class="kt">?name</span> <span class="kt">:where</span> <span class="o">[</span><span class="kt">?e</span> <span class="kt">:person/name</span> <span class="kt">?name</span><span class="o">]</span> <span class="o">[</span><span class="kt">?e</span> <span class="kt">:person/age</span> <span class="kt">?age</span><span class="o">]</span> <span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>TypedQueryAuto2[DatomicData,DatomicData,(DatomicData, DatomicData)]</code> means you have:</p>

<ul>
<li>2 input parameters <code>$ ?name</code> of type <code>DatomicData</code></li>
<li>last tupled type parameter represents the 2 output parameters <code>?e ?age</code> of type <code>DatomicData</code></li>
</ul>


<br/>


<h3>Examples with syntax-error</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">q</span>  <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">     [ :find ?e</span>
</span><span class='line'><span class="s">       :in $ ?name</span>
</span><span class='line'><span class="s">       :where [ ?e :person/name ?name </span>
</span><span class='line'><span class="s">     ]&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">&lt;</span><span class="n">console</span><span class="k">&gt;:</span><span class="mi">14</span><span class="k">:</span> <span class="kt">error:</span> <span class="kt">`]&#39; expected but end of source found</span>
</span><span class='line'><span class="kt">     ]&quot;&quot;&quot;)</span>
</span><span class='line'><span class="kt">      ^</span>
</span><span class='line'>
</span><span class='line'><span class="kt">scala&gt; val q  = Query(&quot;&quot;&quot;</span>
</span><span class='line'><span class="kt">     [ :find ?e</span>
</span><span class='line'><span class="kt">       :in $ ?name</span>
</span><span class='line'><span class="kt">       :where [ ?e person/name ?name ]</span>
</span><span class='line'><span class="kt">     ]&quot;&quot;&quot;)</span>
</span><span class='line'><span class="kt">&lt;console&gt;:13: error: `</span><span class="err">]&#39;</span> <span class="kt">expected</span> <span class="kt">but</span> <span class="err">`</span><span class="kt">p</span><span class="err">&#39;</span> <span class="kt">found</span>
</span><span class='line'>       <span class="k">:</span><span class="kt">where</span> <span class="o">[</span> <span class="kt">?e</span> <span class="kt">person/name</span> <span class="kt">?name</span> <span class="o">]</span>
</span><span class='line'>                   <span class="o">^</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is see that the compiler will tell you where it detects syntax errors.</p>

<p><em>The query compiler is not yet complete so don&#8217;t hesitate to report us when you discover issues.</em></p>

<br/>


<h2><a name="datomicdata">What&#8217;s <code>DatomicData</code> ?</a></h2>

<p>Datomisca wraps completely Datomic API and types. So Datomisca doesn&#8217;t let any Datomic/Clojure types perspirating into its domain and wraps them all in the so-called <code>DatomicData</code> which is the abstract parent trait of all Datomic types seen from Datomisca. For each Datomic type, you have the corresponding specific <code>DatomicData</code>:</p>

<ul>
<li>DString for String</li>
<li>DLong for Long</li>
<li>DatomicFloat for Float</li>
<li>DSet for Set</li>
<li>DInstant for Instant</li>
<li>&#8230;</li>
</ul>


<h3>Why not using Pure Scala types directly?</h3>

<p>Firstly, because type correspondence is not exact between Datomic types and Scala. The best sample is <code>Instant</code>: is it a <code>java.util.Date</code> or a <code>jodatime.DateTime</code>?</p>

<p>Secondly, we wanted to keep the possibility of converting Datomic types into different Scala types depending on our needs so we have abstracted those types.</p>

<p>This abstraction also isolates us and we can decide exactly how we want to map Datomic types to Scala. The trade-off is naturally that, if new types appear in Datomic, we must wrap them.</p>

<br/>


<h3>Keep in mind that Datomisca queries accept and return <code>DatomicData</code></h3>

<p>All query data used as input and output paremeters shall be <code>DatomicData</code>. When getting results, you can convert those generic <code>DatomicData</code> into one of the previous specific types (<code>DString</code>, <code>DLong</code>, â€¦ ).</p>

<p>From <code>DatomicData</code>, you can also convert to Scala pure types based on implicit typeclasses:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">DatomicData</span><span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="k">implicit</span> <span class="n">rd</span><span class="k">:</span> <span class="kt">DDReader</span><span class="o">[</span><span class="kt">DatomicData</span>, <span class="kt">T</span><span class="o">])</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">DString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</span><span class='line'><span class="n">res0</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="n">toto</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="nc">DString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>
</span><span class='line'><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="nc">ClassCastException</span><span class="k">:</span> <span class="kt">datomisca.DString</span> <span class="kt">cannot</span> <span class="kt">be</span> <span class="kt">cast</span> <span class="kt">to</span> <span class="kt">datomisca.DLong</span>
</span><span class='line'><span class="o">...</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note 1 : that current Scala query compiler is a bit restricted to the specific domain of Datomic queries and doesn&#8217;t support all Clojure syntax which might create a few limitations when calling Clojure functions in queries. Anyway, a full Clojure syntax Scala compiler is in the TODO list so these limitations will disappear once it&#8217;s implementedâ€¦</em></p>

<br/>


<p><em>Note 2 : Current macro just infers the number of input/output parameters but, using Schema typed attributes that we will present in a future article, we will provide some deeper features such as parameter type inference.</em></p>

<br/>


<h1><a name="execute">Execute the query</a></h1>

<p>You can create queries independently of any connection to Datomic.
But you need an implicit <code>DatomicConnection</code> in your scope to execute it.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Creates an implicit connection</span>
</span><span class='line'><span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;â€¦&quot;</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">lazy</span> <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Creates the query</span>
</span><span class='line'><span class="k">val</span> <span class="n">queryFindByName</span> <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">[ :find ?e ?birth</span>
</span><span class='line'><span class="s">  :in $ ?name</span>
</span><span class='line'><span class="s">  :where [ ?e :person/name ?name ]</span>
</span><span class='line'><span class="s">         [ ?e :person/birth ?birth ]        </span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Executes the query     </span>
</span><span class='line'><span class="k">val</span> <span class="n">results</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">DatomicData</span>, <span class="kt">DatomicData</span><span class="o">]</span> <span class="kt">=</span> <span class="kt">Datomic.q</span><span class="o">(</span><span class="kt">queryFindByName</span>, <span class="kt">database</span>, <span class="kt">DString</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">John</span><span class="err">&quot;</span><span class="o">))</span>
</span><span class='line'><span class="kt">//</span> <span class="kt">Results</span> <span class="k">type</span> <span class="kt">is</span> <span class="kt">precised</span> <span class="kt">for</span> <span class="kt">the</span> <span class="kt">example</span> <span class="kt">but</span> <span class="kt">not</span> <span class="kt">required</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Please note we made the <code>database</code> input parameter mandatory even if it&#8217;s implicit in when importing <code>Datomic._</code> because in Clojure, it&#8217;s also required and we wanted to stick to it.</em></p>

<h3>Compile-error if wrong number of inputs</h3>

<p>If you don&#8217;t provide 2 input parameters, you will get a compile error because the query expects 2 input parameters.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Following would not compile because query expects 2 input parameters</span>
</span><span class='line'><span class="k">val</span> <span class="n">results</span><span class="k">:</span> <span class="kt">List</span><span class="o">[(</span><span class="kt">DatomicData</span>, <span class="kt">DatomicData</span><span class="o">]</span> <span class="kt">=</span> <span class="kt">Datomic.q</span><span class="o">(</span><span class="kt">queryFindByName</span>, <span class="kt">DString</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">John</span><span class="err">&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span><span class="kt">info</span><span class="o">]</span> <span class="kt">Compiling</span> <span class="err">1</span> <span class="kt">Scala</span> <span class="kt">source</span> <span class="kt">to</span> <span class="kt">/Users/pvo/zenexity/workspaces/workspace_pellucid/datomisca/samples/getting-started/target/scala-</span><span class="err">2</span><span class="kt">.</span><span class="err">10</span><span class="kt">/classes...</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span> <span class="kt">/Users/pvo/zenexity/workspaces/workspace_pellucid/datomisca/samples/getting-started/src/main/scala/GettingStarted.scala:</span><span class="err">87</span><span class="kt">:</span> <span class="kt">overloaded</span> <span class="kt">method</span> <span class="kt">value</span> <span class="kt">q</span> <span class="kt">with</span> <span class="kt">alternatives:</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">A</span>, <span class="kt">R</span><span class="o">(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)](</span><span class="kt">query:</span> <span class="kt">datomisca.TypedQueryAuto1</span><span class="o">[</span><span class="kt">A</span>,<span class="kt">R</span><span class="o">(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)]</span>, <span class="kt">a:</span> <span class="kt">A</span><span class="o">)(</span><span class="kt">implicit</span> <span class="kt">db:</span> <span class="kt">datomisca.DDatabase</span>, <span class="kt">implicit</span> <span class="kt">ddwa:</span> <span class="kt">datomisca.DD2Writer</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>, <span class="kt">implicit</span> <span class="kt">outConv:</span> <span class="kt">datomisca.DatomicDataToArgs</span><span class="o">[</span><span class="kt">R</span><span class="o">(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)])</span><span class="kt">List</span><span class="o">[</span><span class="kt">R</span><span class="o">(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)]</span> <span class="kt">&lt;and&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">R</span><span class="o">(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)](</span><span class="kt">query:</span> <span class="kt">datomisca.TypedQueryAuto0</span><span class="o">[</span><span class="kt">R</span><span class="o">(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)]</span>, <span class="kt">db:</span> <span class="kt">datomisca.DDatabase</span><span class="o">)(</span><span class="kt">implicit</span> <span class="kt">outConv:</span> <span class="kt">datomisca.DatomicDataToArgs</span><span class="o">[</span><span class="kt">R</span><span class="o">(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)])</span><span class="kt">List</span><span class="o">[</span><span class="kt">R</span><span class="o">(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)(</span><span class="kt">in</span> <span class="kt">method</span> <span class="kt">q</span><span class="o">)]</span> <span class="kt">&lt;and&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">OutArgs</span> <span class="k">&lt;:</span> <span class="kt">datomisca.Args</span>, <span class="kt">T</span><span class="o">](</span><span class="kt">q:</span> <span class="kt">datomisca.TypedQueryInOut</span><span class="o">[</span><span class="kt">datomisca.Args1</span>,<span class="kt">OutArgs</span><span class="o">]</span>, <span class="kt">d1:</span> <span class="kt">datomisca.DatomicData</span><span class="o">)(</span><span class="kt">implicit</span> <span class="kt">db:</span> <span class="kt">datomisca.DDatabase</span>, <span class="kt">implicit</span> <span class="kt">outConv:</span> <span class="kt">datomisca.DatomicDataToArgs</span><span class="o">[</span><span class="kt">OutArgs</span><span class="o">]</span>, <span class="kt">implicit</span> <span class="kt">ott:</span> <span class="kt">datomisca.ArgsToTuple</span><span class="o">[</span><span class="kt">OutArgs</span>,<span class="kt">T</span><span class="o">])</span><span class="kt">List</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="kt">&lt;and&gt;</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>   <span class="o">[</span><span class="kt">InArgs</span> <span class="k">&lt;:</span> <span class="kt">datomisca.Args</span><span class="o">](</span><span class="kt">query:</span> <span class="kt">datomisca.PureQuery</span>, <span class="kt">in:</span> <span class="kt">InArgs</span><span class="o">)(</span><span class="kt">implicit</span> <span class="kt">db:</span> <span class="kt">datomisca.DDatabase</span><span class="o">)</span><span class="kt">List</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">datomisca.DatomicData</span><span class="o">]]</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>  <span class="kt">cannot</span> <span class="kt">be</span> <span class="kt">applied</span> <span class="kt">to</span> <span class="o">(</span><span class="kt">datomisca.TypedQueryAuto2</span><span class="o">[</span><span class="kt">datomisca.DatomicData</span>,<span class="kt">datomisca.DatomicData</span>,<span class="o">(</span><span class="kt">datomisca.DatomicData</span>, <span class="kt">datomisca.DatomicData</span><span class="o">)]</span>, <span class="kt">datomisca.DString</span><span class="o">)</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>         <span class="kt">val</span> <span class="kt">results</span> <span class="kt">=</span> <span class="kt">Datomic.q</span><span class="o">(</span><span class="kt">queryFindByName</span>, <span class="kt">DString</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">John</span><span class="err">&quot;</span><span class="o">))</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span>                               <span class="kt">^</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span> <span class="kt">one</span> <span class="kt">error</span> <span class="kt">found</span>
</span><span class='line'><span class="o">[</span><span class="kt">error</span><span class="o">]</span> <span class="o">(</span><span class="kt">compile:compile</span><span class="o">)</span> <span class="kt">Compilation</span> <span class="kt">failed</span>
</span></code></pre></td></tr></table></div></figure>


<p>The compile error seems a bit long as the compiler tries a few different version of <code>Datomic.q</code> but just remind that when you see <code>cannot be applied to (datomisca.TypedQueryAuto2[â€¦</code>, it means you provided the wrong number of input parameters.</p>

<br/>


<h3>Use query results</h3>

<p>Query results are <code>List[DatomicDataâ€¦]</code> depending on the output parameters inferred by the Scala macros.</p>

<p>In our case, we have 2 output parameters so we expect a <code>List[(DatomicData, DatomicData)]</code>.
Using <code>List.map</code> (or <code>headOption</code> to get the first one only), you can then use pattern matching to specialize your <code>(DatomicData, DatomicData)</code> to <code>(DLong, DInstant)</code> as you expect.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">results</span> <span class="n">map</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">case</span> <span class="o">(</span><span class="n">e</span><span class="k">:</span> <span class="kt">DLong</span><span class="o">,</span> <span class="n">birth</span><span class="k">:</span> <span class="kt">DInstant</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="c1">// converts into Scala types</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">eAsLong</span> <span class="k">=</span> <span class="n">e</span><span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">Long</span><span class="o">]</span>
</span><span class='line'>    <span class="k">val</span> <span class="n">birthAsDate</span> <span class="k">=</span> <span class="n">birth</span><span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">java.util.Date</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note 1: that when you want to convert your <code>DatomicData</code>, you can use our converters based on implicit typeclasses as following</em></p>

<p><em>Note 2: The Scala macro has not way just based on query to infer the real types of output parameters but ther is a TODO in the roadmap: using typed schema attributes presented in a future article, we will be able to do better certainlyâ€¦ Be patient ;)</em></p>

<br/>


<h1><a name="complex">More complex queries</a></h1>

<p>As Datomisca parses the queries, you may wonder what is the level of completeness of the query parser for now?</p>

<p>Here are a few examples showing what can be executed already:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
<span class='line-number'>53</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// using variable number of inputs</span>
</span><span class='line'><span class="k">val</span> <span class="n">q</span> <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[</span>
</span><span class='line'><span class="s"> :find ?e</span>
</span><span class='line'><span class="s"> :in $ [?names ...] </span>
</span><span class='line'><span class="s"> :where [?e :person/name ?names]</span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">q</span><span class="o">(</span><span class="n">q</span><span class="o">,</span> <span class="n">database</span><span class="o">,</span> <span class="nc">DSet</span><span class="o">(</span><span class="nc">DString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">),</span> <span class="nc">DString</span><span class="o">(</span><span class="s">&quot;tata&quot;</span><span class="o">)))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// using tuple inputs</span>
</span><span class='line'><span class="k">val</span> <span class="n">q</span> <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[</span>
</span><span class='line'><span class="s">  :find ?e ?name ?age</span>
</span><span class='line'><span class="s">  :in $ [[?name ?age]]</span>
</span><span class='line'><span class="s">  :where [?e :person/name ?name]</span>
</span><span class='line'><span class="s">         [?e :person/age ?age]</span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">q</span><span class="o">(</span><span class="n">q</span><span class="o">,</span>
</span><span class='line'>  <span class="n">database</span><span class="o">,</span>
</span><span class='line'>  <span class="nc">DSet</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">DSet</span><span class="o">(</span><span class="nc">DString</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">),</span> <span class="nc">DLong</span><span class="o">(</span><span class="mi">30L</span><span class="o">)),</span>
</span><span class='line'>    <span class="nc">DSet</span><span class="o">(</span><span class="nc">DString</span><span class="o">(</span><span class="s">&quot;tutu&quot;</span><span class="o">),</span> <span class="nc">DLong</span><span class="o">(</span><span class="mi">54L</span><span class="o">))</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// using function such as fulltext search</span>
</span><span class='line'><span class="k">val</span> <span class="n">q</span> <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[</span>
</span><span class='line'><span class="s">  :find ?e ?n</span>
</span><span class='line'><span class="s">  :where [(fulltext $ :person/name &quot;toto&quot;) [[ ?e ?n ]]]</span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// using rules</span>
</span><span class='line'><span class="k">val</span> <span class="n">totoRule</span> <span class="k">=</span> <span class="nc">Query</span><span class="o">.</span><span class="n">rules</span><span class="o">(</span><span class="s">&quot;&quot;&quot;</span>
</span><span class='line'><span class="s">[ [ [toto ?e]</span>
</span><span class='line'><span class="s">    [?e :person/name &quot;toto&quot;]</span>
</span><span class='line'><span class="s">] ]</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">q</span> <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[</span>
</span><span class='line'><span class="s"> :find ?e ?age</span>
</span><span class='line'><span class="s"> :in $ %</span>
</span><span class='line'><span class="s"> :where [?e :person/age ?age]</span>
</span><span class='line'><span class="s">        (toto ?e)</span>
</span><span class='line'><span class="s">]</span>
</span><span class='line'><span class="s">&quot;&quot;&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">////////////////////////////////////////////////////</span>
</span><span class='line'><span class="c1">// using query specifying just the field in fact to be searched</span>
</span><span class='line'><span class="k">val</span> <span class="n">q</span> <span class="k">=</span> <span class="nc">Query</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[:find ?e :where [?e :person/name]]&quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Note that currently Datomisca reserializes queries to string when executing because Java API requires it but once Datomic Java API accepts that we pass List[List[Object]] instead of strings for query, the interaction will be more directâ€¦</em></p>

<div class="well">Next articles about Datomic operations to insert/retract facts or entities in Datomic using Datomisca.</div>


<p>Have datomiscafun!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/01/30/maquereau-patamorphism/">Playing the Fool With Scala Macros - Implementing PataMorphism</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-30T13:13:00+01:00" pubdate data-updated="true">Jan 30<span>th</span>, 2013</time>
        
         | <a href="/2013/01/30/maquereau-patamorphism/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><div class="well">
You can find the code on my Github code <a href="http://github.com/mandubian/maquereau">Maquereau</a> 
</div>


<h1><a name="maquereau">Maquereau <em>[Scomber Scombrus]</em></a></h1>

<div style="float: right"><img src="/images/mandubian/maquereau_white.jpg" /></div>


<blockquote><p><em>[/makÊ€o/] in french phonetics</em></p></blockquote>

<p>Since I discovered Scala Macros with Scala 2.10, I&#8217;ve been really impressed by their power. But great power means great responsibility as you know. Nevertheless, I don&#8217;t care about responsability as I&#8217;m just experimenting. As if mad scientists couldn&#8217;t experiment freely!</p>

<p>Besides being a very tasty pelagic fish from scombroid family, <a href="http://github.com/mandubian/maquereau">Maquereau</a> is my new sandbox project to experiment eccentric ideas with Scala Macros.</p>

<p>Here is my first experiment which aims at studying the concepts of pataphysics applied to Scala Macros.</p>

<br/>


<br/>


<h1><a name="pataphysics">Pataphysics applied to Macros</a></h1>

<h3>Programming is math</h3>

<blockquote><p>I&#8217;ve heard people saying that programming is not math.<br/>
This is really wrong, programming is math.</p></blockquote>

<p>And let&#8217;s be serious, how would you seek attention in urbane cocktails without
 those cute little words such as functors, monoids, contravariance, monads?</p>

<blockquote><p>She/He> What do you do?<br/>
You> I&#8217;m coding a list fold.<br/>
She/He> Ah ok, bye.<br/>
You> Hey waitâ€¦</p></blockquote>

<br/>


<blockquote><p>She/He> What do you do?<br/>
You> I&#8217;m deconstructing my list with a catamorphism based on a F-algebra as underlying functor.<br/>
She/He> Whahhh this is so exciting! Actually you&#8217;re really sexy!!!<br/>
You> Yes I known insignificant creature!</p></blockquote>

<br/>


<h3>Programming is also a bit of Physics</h3>

<p>Code is static meanwhile your program is launched in a runtime environment which is dynamic and you must take these dynamic aspects into account in your code too (memory, synchronization, blocking calls, resource consumptionâ€¦). For the purpose of the demo, let&#8217;s accept programming also implies some concepts of physics when dealing with dynamic aspects of a program.</p>

<br/>


<h3>Compiling is Programming Metaphysics</h3>

<p>Between code and runtime, there is a weird realm, the compiler runtime which is in charge of converting static code to dynamic program:</p>

<ul>
<li>The compiler knows things you can&#8217;t imagine.</li>
<li>The compiler is aware of the fundamental nature of math &amp; physics of programming.</li>
<li>The compiler is beyond these rules of math &amp; physics, it&#8217;s metaphysics.</li>
</ul>


<br/>


<h3>Macro is Pataphysics</h3>

<div style="float: right"><img src="/images/mandubian/ubu.png"/></div>


<p>Now we have Scala Macros which are able:</p>

<ul>
<li>to intercept the compiling process for a given piece of code</li>
<li>to analyze the compiler AST code and do some computation on it</li>
<li>to generate another AST and inject it back into the compile-chain</li>
</ul>


<p>When you write a Macro in your own code, you write code which runs in the compiler runtime. Moreover a macro can go even further by asking for compilation from within the compiler: <code>c.universe.reify{ some code }</code>â€¦ Isn&#8217;t it great to imagine those recursive compilers?</p>

<p>So Scala macro knows the fundamental rules of the compiler. Given compiler is metaphysics, Scala macro lies beyond metaphysics and the science studying this topic is called pataphysics.</p>

<p>This science provides very interesting concepts and this article is about applying them to the domain of Scala Macros.</p>

<p>I&#8217;ll let you discover pataphysics by yourself on <a href="http://en.wikipedia.org/wiki/'Pataphysics">wikipedia</a></p>

<br/>


<blockquote><p>Let&#8217;s explore the realm of pataphysics applied to Scala macro development by implementing the great concept of patamorphism, well-known among pataphysicians.</p></blockquote>

<br/>


<br/>


<h1><a name="defining-patamorphism">Defining Patamorphism</a></h1>

<p>In 1976, the great pataphysician, Ernst Von Schmurtz defined patamorphism as following:</p>

<blockquote><p>A patamorphism is a patatoid in the category of endopatafunctorsâ€¦</p></blockquote>

<p>Explaining the theory would be too long with lots of weird formulas. Let&#8217;s just  skip that and go directly to the conclusions.</p>

<h4>First of all, we can consider the realm of pataphysics is the context of Scala Macros.</h4>

<br/>


<p>Now, let&#8217;s take point by point and see if Scala Macro can implement a patamorphism.</p>

<h4>A patamorphism should be callable from outside the realm of pataphysics</h4>

<p>A Scala macro is called from your code which is out of the realm of Scala macro.</p>

<h4>A patamorphism can&#8217;t have effect outside the realm of pataphysics after execution</h4>

<p>This means we must implement a Scala Macro that :</p>

<ul>
<li>has effect only at compile-time</li>
<li>has NO effect at run-time</li>
</ul>


<p>From outside the compiler, a patamorphism is an identity morphism that could be translated in Scala as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">pataMorph</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">t</span><span class="k">:</span> <span class="kt">T</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span>
</span></code></pre></td></tr></table></div></figure>


<h4>A patamorphism can change the nature of things while being computed</h4>

<p>Even if it has no effect once applied, meanwhile it is computed, it can :</p>

<ul>
<li>have side-effects on anything</li>
<li>be blocking</li>
<li>be mutable</li>
</ul>


<p>Concerning these points, nothing prevents a Scala Macro from respecting those points.</p>

<h4>A patamorphism is a patatoid</h4>

<p>You may know it but patatoid principles require that the morphism should be customisable by a custom abstract seed. In Scala samples, patatoid are generally described as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Patatoid</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// Seed is specific to a Patatoid and is used to configure the sprout mechanism  </span>
</span><span class='line'>  <span class="k">type</span> <span class="kt">Seed</span>
</span><span class='line'>  <span class="c1">// sprout is the classic name</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">sprout</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">t</span><span class="k">:</span> <span class="kt">T</span><span class="o">)(</span><span class="n">seed</span><span class="k">:</span> <span class="kt">Seed</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>So a patamorphism could be implemented as :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">PataMorphism</span> <span class="k">extends</span> <span class="nc">Patatoid</span>
</span></code></pre></td></tr></table></div></figure>


<p>A custom patamorphism implemented as a Scala Macro would be written as :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">object</span> <span class="nc">MyPataMorphism</span> <span class="k">extends</span> <span class="nc">PataMorphism</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">type</span> <span class="kt">Seed</span> <span class="o">=</span> <span class="nc">MyCustomSeed</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">sprout</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">t</span><span class="k">:</span> <span class="kt">T</span><span class="o">)(</span><span class="n">seed</span><span class="k">:</span> <span class="kt">Seed</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">sproutImpl</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// here is the corresponding macro implementation</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">sproutImpl</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c1.WeakTypeTag</span><span class="o">](</span><span class="n">c1</span><span class="k">:</span> <span class="kt">Context</span><span class="o">)(</span><span class="n">t</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="n">seed</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">Seed</span><span class="o">])</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span> <span class="err">â€¦</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>But in current Scala Macro API, this is not possible for a Scala Macro to override an abstract function so we can&#8217;t write it like that and we need to trick a bit. Here is how we can do simply :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Patatoid</span><span class="o">{</span>
</span><span class='line'>  <span class="c1">// Seed is specific to a Patatoid and is used to configure the sprout mechanism  </span>
</span><span class='line'>  <span class="k">type</span> <span class="kt">Seed</span>
</span><span class='line'>  <span class="c1">// we put the signature of the macro implementation in the abstract trait</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">sproutMacro</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c1.WeakTypeTag</span><span class="o">](</span><span class="n">c1</span><span class="k">:</span> <span class="kt">Context</span><span class="o">)(</span><span class="n">t</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="n">seed</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">Seed</span><span class="o">])</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="cm">/**</span>
</span><span class='line'><span class="cm">  * PataMorphism </span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">trait</span> <span class="nc">PataMorphism</span> <span class="k">extends</span> <span class="nc">Patatoid</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Custom patamorphism</span>
</span><span class='line'><span class="k">object</span> <span class="nc">MyPataMorphism</span> <span class="k">extends</span> <span class="nc">PataMorphism</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">type</span> <span class="kt">Seed</span> <span class="o">=</span> <span class="nc">MyCustomSeed</span>
</span><span class='line'>  <span class="c1">// the real sprout function expected for patatoid</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">sprout</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">t</span><span class="k">:</span> <span class="kt">T</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">seed</span><span class="k">:</span> <span class="kt">Seed</span><span class="o">)</span><span class="k">:</span> <span class="kt">T</span> <span class="o">=</span> <span class="n">macro</span> <span class="n">sproutMacro</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// the real implementation of the macro and of the patatoid abstract operation</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">sproutMacro</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c1.WeakTypeTag</span><span class="o">](</span><span class="n">c1</span><span class="k">:</span> <span class="kt">Context</span><span class="o">)(</span><span class="n">t</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="n">seed</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">Seed</span><span class="o">])</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="err">â€¦</span>
</span><span class='line'>    <span class="c1">// Your implementation here</span>
</span><span class='line'>    <span class="err">â€¦</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<div class="well">
<h3>Conclusion</h3>
<p>We have shown that we could implement a patamorphism using a Scala Macro.</p>
<p>But the most important is the implementation of the macro which shall:
<ul>
<li>have effect only at compile-time (with potential side-effect, sync, blocking)</li>
<li>have NO effect at runtime</li>
</ul>
<p>Please note that pataphysics is the science of exceptions so all previous rules are true as long as there are no exception to them.</p>
</div>


<p><strong>Let&#8217;s implement a 1st sample of patamorphism called <code>VerySeriousCompiler</code>.</strong></p>

<br/>


<br/>


<h1><a name="veryseriouscompiler">Sample #1: VerySeriousCompiler</a></h1>

<h2>What is it?</h2>

<p><code>VerySeriousCompiler</code> is a pure patamorphism which allows to change compiler behavior by :</p>

<ul>
<li>Choosing how long you want the compilation to last</li>
<li>Displaying great messages at a given speed while compiling</li>
<li>Returning the exact same code tree given in input</li>
</ul>


<p><strong><code>VerySeriousCompiler</code> is an identity morphism returning your exact code without leaving any trace in AST after macro execution.</strong></p>

<p><code>VerySeriousCompiler</code> is implemented exactly using previous patamorphic pattern and the compiling phase can be configured using custom Seed:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Seed builder </span>
</span><span class='line'><span class="cm">  * @param duration the duration of compiling in ms</span>
</span><span class='line'><span class="cm">  * @param speed the speed between each message display in ms</span>
</span><span class='line'><span class="cm">  * @param messages the messages to display</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">def</span> <span class="n">seed</span><span class="o">(</span><span class="n">duration</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">speed</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="n">messages</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2>When to use it?</h2>

<p>VerySeriousCompiler is a useful tool when you want to have a coffee or discuss quietly at work with colleagues and fool your boss making him/her believe you&#8217;re waiting for the end of a very long compiling process.</p>

<p>To use it, you just have to modify your code using :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">VerySeriousCompiler</span><span class="o">.</span><span class="n">sprout</span><span class="o">{</span>
</span><span class='line'>  <span class="err">â€¦</span><span class="n">some</span> <span class="n">code</span><span class="err">â€¦</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">//or even </span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">xxx</span> <span class="k">=</span> <span class="nc">VerySeriousCompiler</span><span class="o">.</span><span class="n">sprout</span><span class="o">{</span>
</span><span class='line'>  <span class="err">â€¦</span><span class="n">some</span> <span class="n">code</span> <span class="n">returning</span> <span class="n">something</span><span class="err">â€¦</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Then you launch compilation for the duration you want, displaying meaningful messages in case your boss looks at your screen. Then, you have an excuse if your boss is not happy about your long pause, tell him/her: &#8220;Look, it&#8217;s compiling&#8221;.</p>

<p>Remember that this PataMorphism doesn&#8217;t pollute your code at runtime at all, it has only effects at compile-time and doesn&#8217;t inject any other code in the AST.</p>

<br/>


<br/>


<h2>Usage</h2>

<h3>With default seed (5s compiling with msgs each 400ms)</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">VerySeriousCompiler._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Create a class for ex</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Toto</span><span class="o">(</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// using default seed</span>
</span><span class='line'><span class="n">sprout</span><span class="o">(</span><span class="nc">Toto</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">))</span> <span class="n">must</span> <span class="n">beEqualTo</span><span class="o">(</span><span class="nc">Toto</span><span class="o">(</span><span class="s">&quot;toto&quot;</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you compile:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>[info] Compiling 1 Scala source to /workspace_mandubian/maquereau/target/scala-2.11/classes...
</span><span class='line'>[info] Compiling 1 Scala source to /workspace_mandubian/maquereau/target/scala-2.11/test-classes...
</span><span class='line'>Finding ring kernel that rules them all...................
</span><span class='line'>computing fast fourier transform code optimization....................
</span><span class='line'>asking why Obiwan Kenobi...................
</span><span class='line'>resolving implicit typeclass from scope....................
</span><span class='line'>constructing costate comonad....................
</span><span class='line'>Do you like gladiator movies?....................
</span><span class='line'>generating language systemic metafunction....................
</span><span class='line'>verifying isomorphic behavior....................
</span><span class='line'>inflating into applicative functor...................
</span><span class='line'>verifying isomorphic behavior...................
</span><span class='line'>invoking Nyarlathotep to prevent crawling chaos....................
</span><span class='line'>Hear me carefully, your eyelids are very heavy, you're a koalaaaaa....................
</span><span class='line'>resolving implicit typeclass from scope...................
</span><span class='line'>[info] PataMorphismSpec
</span><span class='line'>[info] 
</span><span class='line'>[info] VerySeriousCompiler should
</span><span class='line'>[info] + sprout with default seed
</span><span class='line'>[info] Total for specification PataMorphismSpec
</span><span class='line'>[info] Finished in xx ms
</span><span class='line'>[info] 1 example, 0 failure, 0 error
</span><span class='line'>[info] 
</span><span class='line'>[info] Passed: : Total 1, Failed 0, Errors 0, Passed 1, Skipped 0
</span><span class='line'>[success] Total time: xx s, completed 3 f?vr. 2013 01:25:42</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>With custom seed (1s compiling with msgs each 200ms)</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// using custom seed</span>
</span><span class='line'><span class="n">sprout</span><span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">a</span> <span class="k">=</span> <span class="s">&quot;this is&quot;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">b</span> <span class="k">=</span> <span class="s">&quot;some code&quot;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="mi">123L</span>
</span><span class='line'>  <span class="n">s</span><span class="s">&quot;msg $a $b $c&quot;</span>
</span><span class='line'><span class="o">}(</span>
</span><span class='line'>  <span class="nc">VerySeriousCompiler</span><span class="o">.</span><span class="n">seed</span><span class="o">(</span>
</span><span class='line'>    <span class="mi">1000L</span><span class="o">,</span>     <span class="c1">// duration of compiling in ms</span>
</span><span class='line'>    <span class="mi">200L</span><span class="o">,</span>       <span class="c1">// speed between each message display in ms</span>
</span><span class='line'>    <span class="nc">Seq</span><span class="o">(</span>        <span class="c1">// the message to display randomly </span>
</span><span class='line'>      <span class="s">&quot;very interesting message&quot;</span><span class="o">,</span>
</span><span class='line'>      <span class="s">&quot;cool message&quot;</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="n">must</span> <span class="n">beEqualTo</span><span class="o">(</span> <span class="s">&quot;msg this is some code 123&quot;</span> <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you compile:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>[info] Compiling 1 Scala source to /workspace_mandubian/maquereau/target/scala-2.11/classes...
</span><span class='line'>[info] Compiling 1 Scala source to /workspace_mandubian/maquereau/target/scala-2.11/test-classes...
</span><span class='line'>toto..........
</span><span class='line'>coucou..........
</span><span class='line'>toto..........
</span><span class='line'>coucou..........
</span><span class='line'>[info] PataMorphismSpec
</span><span class='line'>[info] 
</span><span class='line'>[info] VerySeriousCompiler should
</span><span class='line'>[info] + sprout with custom seed
</span><span class='line'>[info] Total for specification PataMorphismSpec
</span><span class='line'>[info] Finished in xx ms
</span><span class='line'>[info] 1 example, 0 failure, 0 error
</span><span class='line'>[info] 
</span><span class='line'>[info] Passed: : Total 1, Failed 0, Errors 0, Passed 1, Skipped 0
</span><span class='line'>[success] Total time: xx s, completed 3 f?vr. 2013 01:25:42</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h2>Macro implementation details</h2>

<p>The code can be found on Github <a href="http://github.com/mandubian/maquereau">Maquereau</a>.</p>

<p>Here are the interesting points of the macro implementation.</p>

<h4>Modular macro building</h4>

<p>We use the method described on <a href="http://docs.scala-lang.org/overviews/macros/overview.html#writing_bigger_macros">scalamacros.org/writing bigger macros</a></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">abstract</span> <span class="k">class</span> <span class="nc">VerySeriousCompilerHelper</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">c</span><span class="k">:</span> <span class="kt">Context</span>
</span><span class='line'>  <span class="err">â€¦</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">sproutMacro</span><span class="o">[</span><span class="kt">T:</span> <span class="kt">c1.WeakTypeTag</span><span class="o">](</span><span class="n">c1</span><span class="k">:</span> <span class="kt">Context</span><span class="o">)(</span><span class="n">t</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">])(</span><span class="n">seed</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">Seed</span><span class="o">])</span><span class="k">:</span> <span class="kt">c1.Expr</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">helper</span> <span class="k">=</span> <span class="k">new</span> <span class="o">{</span> <span class="k">val</span> <span class="n">c</span><span class="k">:</span> <span class="kt">c1.</span><span class="k">type</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">}</span> <span class="k">with</span> <span class="nc">VerySeriousCompilerHelper</span>
</span><span class='line'>  <span class="n">helper</span><span class="o">.</span><span class="n">sprout</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">seed</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h4>input code evaluation in macro</h4>

<p>The Seed passed to the macro doesn&#8217;t belong to the realm of Scala Macro but to your code. In the macro, we don&#8217;t get the Seed type but the expression Expr[Seed]. So in order to use the seed value in the macro, we must evaluate the expression passed to the macro:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">speed</span> <span class="k">=</span> <span class="n">c</span><span class="o">.</span><span class="n">eval</span><span class="o">(</span><span class="n">c</span><span class="o">.</span><span class="nc">Expr</span><span class="o">[</span><span class="kt">Long</span><span class="o">](</span><span class="n">c</span><span class="o">.</span><span class="n">resetAllAttrs</span><span class="o">(</span><span class="n">speedTree</span><span class="o">.</span><span class="n">duplicate</span><span class="o">)))</span>
</span></code></pre></td></tr></table></div></figure>


<p><em>Please note that this code is a work-around because in Scala 2.10, you can&#8217;t evaluate any code as you want due to some compiler limitations when evaluating
an already typechecked tree in a macro. This is explained in this <a href="https://issues.scala-lang.org/browse/SI-5464">Scala issue</a></em></p>

<br/>


<h4>input code re-compiling before returning from macro</h4>

<p>We don&#8217;t return directly the input tree in the macro even if it would be valid with respect to patamorphism contract.
But to test Macro a bit further, I decided to &#8221;<em>re-compile</em>&#8221; the input code from within the macro. You can do that using following code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">reify</span><span class="o">(</span><span class="n">a</span><span class="o">.</span><span class="n">splice</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Using macro paradise</h4>

<p>The <code>maquereau</code> project is based on <a href="http://docs.scala-lang.org/overviews/macros/paradise.html">Macro Paradise</a> which is the experimental branch of Scala Macros.
This implementation of patamorphism doesn&#8217;t use any experimental feature from Macro Paradise but future samples will certainly.</p>

<br/>


<br/>


<h1><a name="conclusion">Conclusion</a></h1>

<p>This article shows that applying the concepts of pataphysics to Scala Macro is possible and can help creating really useful tools.</p>

<p>The sample is still a bit basic but it shows that a patamorphism can be implemented relatively simply.</p>

<p>I&#8217;ll create other samples and hope you&#8217;ll like them!</p>

<p>Have patafun!</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2013/01/13/JSON-Coast-to-Coast/">From Data-Centric Approach to JSON Coast-to-Coast Design With Play-2.1 & ReactiveMongo</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-01-13T12:12:00+01:00" pubdate data-updated="true">Jan 13<span>th</span>, 2013</time>
        
         | <a href="/2013/01/13/JSON-Coast-to-Coast/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><p>Today, let&#8217;s talk a bit more about the <strong>JSON <em>coast-to-coast</em> design</strong> I had introduced as a buzz word in a previous article about <a href="http://mandubian.com/2012/09/08/unveiling-play-2-dot-1-json-api-part1-jspath-reads-combinators/">Play2.1 Json combinators</a>.</p>

<p><em>Sorry this is a very long article with tens of >140-chars strings: I wanted to put a few ideas on paper to present my approach before writing any line of codeâ€¦</em></p>

<div class="well">
<h3>Direct access</h3>
<ul>
<li><a href="#philosophy">Philosophical Considerations</a></li>
<li><a href="#sample">Json Coast-to-Coast</a></li>
<li><a href="#code">Json Coast-to-Coast sample on Github</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul>
</div>


<blockquote><h3>Original idea</h3>

<p><strong>1) Manipulate pure data structure (JSON) from client to DB without any <em>static model</em></strong><br/>
<strong>2) Focus on the idea of pure data manipulation and data-flow management</strong><br/>
<br/>
The underlying idea is more global than just questioning the fact that we generally serialize JSON data to static OO models. I really want to discuss how we manipulate data  between frontend/backend(s). I&#8217;d also like to reconsider the whole data flow from a pure functional point of view and not through the lens of technical constraints such as &#8220;OO languages implies static OO models&#8221;.</p></blockquote>

<p>In the <a href="#code">code sample</a>, we&#8217;ll use <a href="http://www.reactivemongo.org">ReactiveMongo</a> and <a href="http://www.playframework.org">Play2.1-RC2</a> and explain why those frameworks fit our demonstation.</p>

<br/>


<br/>


<h1><a name="philosophy">Philosophical Considerations</a></h1>

<h2><a name="data-centric">Data-centric approach</a></h2>

<p>Recent evolutions in backend architecture tend to push (again) UI to the frontend (the client side). As a consequence, <strong>backends concentrate more and more on data serving</strong>, manipulation, transformation, aggregation, distribution and naturally some business logic. I must admit that I&#8217;ve always considered <strong>backend are very good data provider and not so good UI provider</strong>. So I won&#8217;t say it&#8217;s a bad thing.</p>

<p>From this point of view, the backend focuses on:</p>

<ul>
<li>getting/serving data from/to clients</li>
<li>retrieving/distributing data from/to other backends</li>
<li>storing data in DB/cache/files/whatever locally/remotely</li>
<li>doing some business logic (outside data manipulation)â€¦ sometimes but not so often.</li>
</ul>


<p>I consider data management is the reason of being of backend and also the finality of it.</p>

<blockquote><p>The word <em>&#8220;data&#8221;</em> is everywhere and that&#8217;s why I use the term <strong>&#8220;data-centric approach&#8221;</strong> (even if I would prefer that we speak about <em>&#8220;information&#8221;</em> more than data but this is another discussionâ€¦)</p></blockquote>

<br/>


<br/>


<h2><a name="chain-link">Backend system is a chain-link in global data-flow</a></h2>

<p><strong>Data-centric doesn&#8217;t mean <em>centralized data</em></strong></p>

<ul>
<li>With Internet and global mobility, data tend to be gathered, re-distributed, scattered and re-shared logically and geographically</li>
<li>When you develop your server, you can receive data from many different sources and you can exchange data with many actors.</li>
</ul>


<p>In this context, <strong>backend is often just a chain link participating to a whole data flow</strong>. So you must consider the relations existing with other actors of this system.</p>

<p><img src="/images/mandubian/backend_flow.png" alt="Data flow" /></p>

<p>Besides the simple <em>&#8220;what does my backend receive, transmit or answer?&#8221;</em>, it has become <strong>more important to consider the relative role of the backend in the whole data flow</strong> and not only locally. Basically, knowing your exact role in the data flow really impacts your technical design:</p>

<ul>
<li>if your server must aggregate data from one backend which can respond immediately and another one which will respond tomorrow, do you use a runtime stateful framework without persistence for that?</li>
<li>if your server is just there to validate data before sending it to a DB for storage, do you need to build a full generic &amp; static model for that?</li>
<li>if your server is responsible for streaming data in realtime to hundreds of clients, do you want to use a blocking framework ?</li>
<li>if your server takes part to a high-speed realtime transactional system, is it reasonable to choose ultra heavyweight frameworks ?</li>
<li>&#8230;</li>
</ul>


<br/>


<br/>


<h2><a name="temporal-polymorphic-data-flow">Rise of temporal &amp; polymorphic data flows</a></h2>

<p>In the past, we often used to model our data to be used by a single backend or a restricted system. Data model weren&#8217;t evolving too much for a few years. So you could choose a very strict data model using normalization in RDBMS for ex.</p>

<p>But since a few years, nature of data and their usage has changed a lot:</p>

<ul>
<li>same data are shared with lots of different solutions,</li>
<li>same data are used in very different application domains,</li>
<li>unstructured data storage have increased</li>
<li>formats of data evolve much faster than before</li>
<li>global quantity of data has increased exponentially</li>
<li>â€¦</li>
</ul>


<p>The temporal nature of data has changed drastically also with:</p>

<ul>
<li>realtime data streaming</li>
<li>on fhe fly distributed data updates</li>
<li>very long-time persistence</li>
<li>immutable data keeping all updates without losing anything</li>
<li>â€¦</li>
</ul>


<br/>


<div class="well"><blockquote>
<p>Nothing tremendous until now, isn&#8217;t it?</p>  
<p>This is exactly what you already know or do every dayâ€¦</p>
<p>I wanted to remind that a backend system is often only an element of a more global system and a chain link in a more global data flow.</p><br/>
<p>Now let&#8217;s try to consider the data flow through a backend system taking all those modern aspects into account!</p><br/>
<p><b>In the rest of this article, I&#8217;ll focus on a specific domain: the very classic case of backend-to-DB interaction</b>.</p><br/>
<p>For last 10 years, in all widespread enterprise platforms based on OO languages, we have all used those well-known ORM frameworks to manage our data from/to RDBMS. We have discovered their advantages and also their drawbacks. Let&#8217;s consider a bit how those ORM have changed our way of manipulating data.</p>
</blockquote></div>




<br/>


<br/>


<h2><a name="orm-prism-distortion">The ORM prism of distortion</a></h2>

<p>After coding with a few different backend platforms, I tend to think we have been kind-of <strong>mesmerized into thinking it&#8217;s non-sense to talk to a DB from an OO language without going through a static language structure</strong> such as a class. ORM frameworks are the best witnesses of this tendency.</p>

<p>ORM frameworks lead us to:</p>

<ul>
<li>Get some data (from client for ex) in a pure data format such as JSON <em>(this format will be used in all samples because it&#8217;s very representative)</em></li>
<li>Convert JSON to OO structure such as class instance</li>
<li>Transmit class instance to ORM framework that translates/transmits it to the DB mystery limbo.</li>
</ul>


<p><img src="/images/mandubian/all-model.png" alt="All-Model Approach" /></p>

<h3>Pros</h3>

<h4>Classes are OO natural structure</h4>

<p>Classes are the native structures in OO languages so it seems quite natural to use them</p>

<h4>Classes imply structural validations</h4>

<p>Conversion into classes also implies type constraint validations (and more specific constraints with annotations or config) in order to verify data do not corrupt the DB</p>

<h4>Boundaries isolation</h4>

<p>By performing the conversion in OO, the client format is completely decorrelated from DB format making them separated layers. Moreover, by manipulating OO structure in code, the DB can be abstracted almost completely and one can imagine changing DB later. This seems a good manner in theory.</p>

<h4>Business logic compliant</h4>

<p>Once converted, class instances can be manipulated in business logic without taking care about the DB.</p>

<br/>


<h3>Cons</h3>

<h4>Requirement for Business Logic is not the most frequent case</h4>

<p>In many cases (CRUD being the 1st of all), once you get class instance, business logic is simply non-existing. You just pass the class to the ORM, that&#8217;s all. So you simply serialize to a class instance to be able to speak to ORM which is a pity.</p>

<h4>ORM forces to speak OO because they can&#8217;t speak anything else</h4>

<p>In many cases, the only needed thing is data validation with precise (and potentially complex) constraints. A class is just a type validator but it doesn&#8217;t validate anything else. If the String should be an email, your class sees it as a String. So, frameworks have provided constraint validators based on annotations or external configurations.</p>

<h4>Classes are not made to manipulate/validate dynamic forms of data</h4>

<p>Classes are static structure which can&#8217;t evolve so easily because the whole code depends on those classes and modifying a model class can imply lots of code refactoring. If data format is not clear and can evolve, classes are not very good. If data are polymorphic and can be seen using different views, it generally ends into multiplying the number of classes making your code hard to maintain.</p>

<h4>Hiding DB more than abstracting it</h4>

<p>ORM approach is just a pure OO view of relational data. It states that outside OO, nothing exists and no data can be modelled with something else than an OO structure.<br/>
So ORMs haven&#8217;t tried bringing DB structures to OO language but <em>kind-of</em> pushing OO to the DB and abstracting the DB data structure almost completely. So you don&#8217;t manipulate DB data anymore but you manipulate OO &#8220;mimicing&#8221; more or less DB structures.</p>

<h4>Was OO really a so good choice against relational approach???</h4>

<p>It seemed a good idea to map DB data to OO structures. But we all know the problems brought by ORM to our solutions:</p>

<ul>
<li>How DB structures are mapped to OO?</li>
<li>How relations are managed by ORM?</li>
<li>How updates are managed in time? (the famous cache issues)</li>
<li>How transactions are delimited in a OO world?</li>
<li>How full compatibility between all RDBMS can be ensured?</li>
<li>etc&#8230;</li>
</ul>


<br/>


<blockquote><p>I think ORM just moved the problems:</p>

<p>Before ORM, you had problems of SQL<br/>
After ORM, you had problems of ORM</p></blockquote>

<p>Now the difference is that issues appear on the abstraction layer (ie the ORM) which you don&#8217;t control at all and not anymore at the lower-level DB layer. SQL is a bit painful sometimes but it is the DB native language so when you have an error, it&#8217;s generally far easier to find why and how to work around.</p>

<blockquote><p>My aim here is not to tell ORM are bad (and there aren&#8217;t so bad in a few cases).<br/>
<strong>I just want to point the OO deviation introduced by ORM in our way of modelling our data.</strong><br/>
I&#8217;ll let you discover the subject by yourself and make your own mind and you don&#8217;t have to agree with me. As a very beginning, you can go to wikipedia <a href="http://en.wikipedia.org/wiki/Object-relational_impedance_mismatch#Data_type_differences">there</a>.</p></blockquote>

<br/>


<br/>


<h2><a name="all-model-world">The All-Model world</a></h2>

<p>What interests me more is the fact that ORM brought a very systematic way of manipulating the data flowing through backend systems. ORM dictates that whatever data you manipulate, you must convert it to a OO structure before doing anything else for more or less good reasons. OO are very useful when you absolutely want to manipulate static typed structures. But in other cases, isn&#8217;t it better to use a List or a Map or more versatile pure data structure such as Json tree?</p>

<blockquote><p>Let&#8217;s call it the <strong>All-Model Approach : no data can be manipulated without a static model and underlying abstraction/serialization mechanism</strong>.</p></blockquote>

<p>The first move into the <strong>All-Model</strong> direction was quite logical in reaction to the difficulty of SQL integration with OO languages. Hibernate idea, for ex, was to abstract completely the relational DB models with OO structures so that people don&#8217;t care anymore with SQL.</p>

<p>As we all know, in software industry, when an idea becomes a standard of fact, as became ORMs, balance is rarely reached between 2 positions. As a consequence, lots of people decided to completely trash SQL in favor of ORM. That&#8217;s why we have seen this litany of ORM frameworks around hibernate, JPA, Toplink and almost nobody could escape from this global move.</p>

<br/>


<br/>


<h2><a name="changing-world">Living in a changing world</a></h2>

<p>After a few years of suffering more or less with ORM, some people have begun to re-consider this position seeing the difficulty they had to use ORM. <strong>The real change of mind was linked to the evolution of the whole data ecosystem</strong> linked to internet, distribution of data and mobility of clients also.</p>

<h4><a name="nosql-emergence">NoSQL emergence</a></h4>

<p>First, the move concerned the underlying layer: the DB.<br/>
RDBMS are really good to model very consistent data and provide robust transactions but not so good for managing high scalability, data distribution, massive updates, data streaming and very huge amount of data. That&#8217;s why we have seen these NoSQL <em>new kids on the block</em> initiated by Internet companies mainly.</p>

<p>Once again, the balance was upsetted: after the <em>&#8220;SQL is evil&#8221;</em> movement, there have been a funny <em>&#8220;RDBMS is evil&#8221;</em> movement. Extremist positions are not worth globally, what&#8217;s interesting is the result of NoSQL initiative. It allowed to re-consider the way we modelled our data: 100% normalized schema with full ACID transactions were no more the only possibility. NoSQL broke the rules: why not model your data as key/values, documents, graphs using redundancy, without full consistency if it fits better your needs?</p>

<blockquote><p>I really think NoSQL breaking the holy RDBMS rule brought the important subject on the front stage: <strong>we care about the data, the way we manipulate them</strong>. We don&#8217;t need a single DB ruling them all but DB that answer to our requirements and not the other wayâ€¦ Data-Centric as I said beforeâ€¦</p></blockquote>

<h4><a name="why-orm-nosql">Why ORM again for NoQSL?</a></h4>

<p>NoSQL DBs bring their own native API in general providing data representation fitting their own DB model. For ex, MongoDB is document oriented and a record is stored as a binary treemap.</p>

<p>But once again, we have seen ORM-kind API appear on top of those low-level API, as if we couldn&#8217;t think anymore in terms of pure data and not in terms of OO structures.</p>

<p>But the holy rule had been broken and next change would necessarily target ORM. So people rediscovered SQL could be used from modern languages (even OO) using simple mapping mechanism, simpler data structure (tuples, list, map, trees) and query facilities. Microsoft LINQ was a really interesting initiativeâ€¦ Modern languages such as Scala also bring interesting API based on the functional power of the language (cf Slick, Squeryl, Anorm etcâ€¦).</p>

<p>I know some people will tell replacing Class models by HashMaps makes the code harder to maintain and the lack of contract imposed by static typed classes results in code mess. I could answer I&#8217;ve seen exactly the same in projects having tens of classes to model all data views and it was also a mess impossible to maintain.</p>

<blockquote><p><strong>The question is not to forget static models but to use them only when required</strong> and keep simple and dynamic structures as much as possible.<br/>
ORM are still used widely but we can at least openly question their usefulness. Dictatorship is over and diversity is always better!</p></blockquote>

<h4><a name="layer-genericity-talisman">Layered genericity as a talisman</a></h4>

<p>I want to question another fact in the way we model data:</p>

<ul>
<li>we write generic OO model to have very strong static model and be independent of the DB.</li>
<li>we interact with those models using DAO providing all sorts of access functions.</li>
<li>we encapsulate all of that in abstract DB service layers to completely isolate from the DB.</li>
</ul>


<p>Why?<br/>
<em>&#8220;Maybe I&#8217;ll change the DB and I&#8217;ll be able to do itâ€¦&#8221; <br/>
&#8220;Maybe I&#8217;ll need to re-use those DAO somewhere elseâ€¦&#8221;<br/>
&#8220;Maybe Maybe Maybeâ€¦&#8221;</em></p>

<p>It works almost like superstition, as if making everything generic with strict isolated layers was the only way to protect us against failure and that it will make it work and be reused foreverâ€¦</p>

<p><em>Do you change DB very often without re-considering the whole model to fit DB specific features?<br/>
Do you reuse code so often without re-considering the whole design?</em></p>

<blockquote><p>I don&#8217;t say layered design and boundaries isolation is bad once again. I just say it has a cost and consequences that we don&#8217;t really consider anymore.</p></blockquote>

<p><strong>By trying to hide the DB completely, we don&#8217;t use the real power that DB can provide</strong> to us and we forget their specific capacities. There are so many DB types (sql, nosql, key/value, transactional, graph, column etcâ€¦) on the market and choosing the right one according to your data requirements is really importantâ€¦</p>

<blockquote><p><strong>DB diversity gives us more control on our data so why hiding them behind too generic layers?</strong></p></blockquote>

<br/>


<br/>


<h2><a name="no-model-approach">The Data-Centric or No-Model approach</a></h2>

<blockquote><p>Let&#8217;s go back to our data-centric approach and try to manipulate data flow going through our backend system to the DB without OO (de)serialization in the majority of cases.</p></blockquote>

<p>What I really need when I manipulate the data flow is:</p>

<ul>
<li>being able to manipulate data directly</li>
<li>validating the data structure and format according to different constraints</li>
<li>transforming/aggregating data coming from different sources</li>
</ul>


<blockquote><p>I call it the <strong>Data-centric or No-Model approach</strong>. It doesn&#8217;t mean my data aren&#8217;t structured but that I manipulate the data as directly as possible without going through an OO model when I don&#8217;t need it.</p></blockquote>

<p><img src="/images/mandubian/no-model.png" alt="No-Model Approach" /></p>

<br/>


<br/>


<h2><a name="trash-all-model">Should I trash the all-model approach?</a></h2>

<blockquote><p>Answer : NOâ€¦ You must find the right balance.</p></blockquote>

<p>As explained before, using the same design for everything seems a good idea because homogeneity and standardization is a good principle in general.</p>

<p><strong>But &#8220;in general&#8221; is not &#8220;always&#8221; and we often confound homogeneity with uniformity in its bad meaning i.e. diversity loss.</strong></p>

<p>That&#8217;s why I prefer speaking about &#8220;Data-Centric approach&#8221; than &#8220;No-Model&#8221;: the important is to ponder your requirements with respect to your data flow and to choose the right tool:</p>

<ul>
<li>If you need to perform business logic with your data, it&#8217;s often better to work with static OO structures so using a model might be better</li>
<li>If you just need to validate and transform your data, then why going through a model which is completely artificial.</li>
<li>If you just need to manipulate a real-time data flow, then manipulate the flow directly and forget models.</li>
</ul>


<blockquote><p>Now stop philosophizing and go to practice with a very basic sample as a beginning : let&#8217;s manipulate a flow of JSON data in very simple case of CRUD.<br/>
Hey this is the famous &#8220;Json coast-to-coast&#8221; approach ;)</p></blockquote>

<br/>


<br/>


<h1><a name="sample">Json Coast-to-Coast sample</a></h1>

<p>To illustrate this data-centric approach manipulating a pure data flow without OO serialization, let&#8217;s focus on a pure CRUD sample based on JSON. I won&#8217;t speak about the client side to make it shorter but don&#8217;t forget the JSON data flow doesn&#8217;t begin or end at backend boundaries.</p>

<p>I also don&#8217;t focus on real-time flow here because this is worth another discussion. Play2.1 provides us with one of the best platform for real-time web applications. First get accustomed with data-centric design and then consider real-time data managementâ€¦</p>

<p>The CRUD case is a very good one for our subject:</p>

<ul>
<li><p><strong>CRUD implies no backend business logic at all</strong><br/>
Backend receives data corresponding to entity, validates their format and directly transmit the data to the DB to be stored.</p></li>
<li><p><strong>CRUD targets pure data resources and JSON is good to represent pure data in Web world.</strong></p></li>
<li><p><strong>CRUD is compliant to REST approach</strong><br/>
REST is very interesting because it implies that every resource is reachable through a single URL and a HTTP verb from the Web. This is also another discussion about how we access or link dataâ€¦</p></li>
</ul>


<br/>


<br/>


<h2><a name="data-flow-input-output">Thinking data flow in terms of Input/Output</a></h2>

<p>The CRUD sample is not really the right example to consider the impact of relative place in data flow on design. In CRUD, there are no temporal or dynamic requirements. But let&#8217;s stay simple for a beginning.</p>

<p>As there is no business logic in the CRUD caser, we can focus on backend boundaries:</p>

<ul>
<li>Backend/Client</li>
<li>Backend/DB</li>
</ul>


<p>We can just consider the data received at previous boundaries:</p>

<ul>
<li>What Input data is received from client or DB?</li>
<li>What Output data should be sent to DB or client?</li>
</ul>


<p>In a summary, we can really consider the data-flow just in terms of inputs/outputs:</p>

<ul>
<li>Backend/Client input/output</li>
<li>Backend/DB input/output</li>
</ul>


<p><img src="/images/mandubian/inputoutput.png" alt="No-Model Approach" /></p>

<br/>


<br/>


<h2><a name="reactivemongo">Why ReactiveMongo enables Json flow manipulation?</a></h2>

<p>MongoDB provides a very versatile document-oriented data storage platform. MongoDB is not meant to model relational data but data structured as trees. So when you retrieve a document from Mongo, you also get all related data at once. In Mongo, normalized model is not really the main target and redundancy is not necessarily bad as long as you know what you do.<br/>
Mongo document are stored using BSON <em>Binary JSON</em> format which is simply inspired by JSON and optimized for binary storage.</p>

<blockquote><p>Imagine you could get JSON (after validation) directly to or from Mongo without going through any superficial structure, wouldn&#8217;t it be really practical?<br/>
Please remark that serializing a JSON tree to a case-class and from a case class to a BSON document is just useless if you don&#8217;t have any business logic to fulfill with the case-class.</p></blockquote>

<p>Play2.1 provides a very good JSON transformation API from/to any data structure. Converting JSON to BSON is not really an issue.
But now remember that we also want to be able to manage realtime data flow, to stream data from or to the DB (using Mongo capped collections for ex). Play2.x has been designed to be fully asynchronous/non-blocking. but unfortunately, default Java Mongo driver and its Scala counterpart (<a href="https://github.com/mongodb/casbah">Casbah</a>), despite their qualities, provide synchronous and blocking API.</p>

<p>But we are lucky since <a href="http://www.twitter.com/sgodbillong">Stephane Godbillon</a> decided to develop <a href="http://www.reactivemongo.org">ReactiveMongo</a> a full async/non-blocking Scala driver based on Akka and Play Iteratees (but independent of Play framework) and we worked together to develop a Play2.1/ReactiveMongo module providing all the tooling we need for JSON/BSON conversions in the context of Play2.1/Scala.</p>

<p><strong>With Play/ReactiveMongo, you can simply send/receive JSON to/from Mongo and it&#8217;s transparently translated into BSON and vis versa.</strong></p>

<br/>


<br/>


<h2><a name="data-format">Sample Data format</A></h2>

<p>Let&#8217;s try to manipulate a flow of data containing the following representation of a Person in JSON (or BSON)â€¦</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">_id:</span> <span class="err">PERSON_ID,</span>
</span><span class='line'>  <span class="err">name:</span> <span class="nt">&quot;Mike Dirolf&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">pw:</span> <span class="nt">&quot;Some Hashed Password&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">addresses:</span> <span class="err">[</span><span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span> <span class="nt">&quot;mike@dirolf.com&quot;</span><span class="p">,</span> <span class="err">...],</span>
</span><span class='line'>  <span class="err">memberships:</span> <span class="err">[{</span>
</span><span class='line'>    <span class="err">address:</span> <span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group_name:</span> <span class="nt">&quot;family&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group:</span> <span class="err">GROUP_ID</span>
</span><span class='line'>  <span class="p">}</span><span class="err">,</span> <span class="err">...],</span>
</span><span class='line'>  <span class="err">created:</span> <span class="mi">123456789</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>A person consists in:</p>

<ul>
<li>a unique technical ID</li>
<li>a name</li>
<li>a hashed password which shouldn&#8217;t be transmitted outside anyway</li>
<li>zero or more email addresses</li>
<li>zero or more group memberships</li>
<li>a creation date</li>
</ul>


<p>A group membership consists in:</p>

<ul>
<li>the group email</li>
<li>the group name</li>
<li>the group ID</li>
</ul>


<br/>


<br/>


<h2><a name="data-flow-desc">Data flow description</A></h2>

<p>We will consider the following 4 CRUD actions:</p>

<ul>
<li> Create</li>
<li> Get</li>
<li> Delete</li>
<li> Full/Restricted Update (Full document at once or a part of it)</li>
</ul>


<h3><a name="create">CREATE</a></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>PUT http://xxx/person/ID</span></code></pre></td></tr></table></div></figure>


<h4><a name="create-input">Input</a></h4>

<p>Backend receives the whole Person minus <code>_id</code> and <code>created</code> which is not yet known till insertion in DB.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">name:</span> <span class="nt">&quot;Mike Dirolf&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">pw:</span> <span class="nt">&quot;password&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">addresses:</span> <span class="err">[</span><span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span> <span class="nt">&quot;mike@dirolf.com&quot;</span><span class="p">,</span> <span class="err">...],</span>
</span><span class='line'>  <span class="err">memberships:</span> <span class="err">[{</span>
</span><span class='line'>    <span class="err">address:</span> <span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group_name:</span> <span class="nt">&quot;family&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group:</span> <span class="err">GROUP_ID</span>
</span><span class='line'>  <span class="p">}</span><span class="err">,</span> <span class="err">...]</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a name="create-output">output</a></h4>

<p>Backend sends the generated ID in a JSON object for ex.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">_id:</span> <span class="nt">&quot;123456789123456789&quot;</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h3><a name="get">GET</a></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>GET http://xxx/person/ID</span></code></pre></td></tr></table></div></figure>


<h4><a name="get-input">Input</a></h4>

<p>Backend just receives the ID in the URL:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>http://xxx/person/ID</span></code></pre></td></tr></table></div></figure>


<h4><a name="get-output">Output</a></h4>

<p>The whole person plus ID is sent back in JSON but for the demo, let&#8217;s remove a few fields we don&#8217;t want to send back:</p>

<ul>
<li><code>_id</code> which is not needed as the client knows it</li>
<li><code>pw</code> because this is a password even if hashed and we want it to stay in the server</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">name:</span> <span class="nt">&quot;Mike Dirolf&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">addresses:</span> <span class="err">[</span><span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span> <span class="nt">&quot;mike@dirolf.com&quot;</span><span class="p">,</span> <span class="err">...],</span>
</span><span class='line'>  <span class="err">memberships:</span> <span class="err">[{</span>
</span><span class='line'>    <span class="err">address:</span> <span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group_name:</span> <span class="nt">&quot;family&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group:</span> <span class="err">GROUP_ID</span>
</span><span class='line'>  <span class="p">}</span><span class="err">,</span> <span class="err">â€¦],</span>
</span><span class='line'>  <span class="err">created:</span> <span class="mi">123456789</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h3><a name="delete">DELETE</a></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>DELETE http://xxx/person/ID</span></code></pre></td></tr></table></div></figure>


<h4><a name="delete-inptu">Input</a></h4>

<p>Backend just receives the ID in the URL:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>http://xxx/ID</span></code></pre></td></tr></table></div></figure>


<h4><a name="delete-output">Output</a></h4>

<p>Nothing very interesting. Use a &#8220;200 OK&#8221; to stay simple</p>

<br/>


<br/>


<h3><a name="update">Full UPDATE</a></h3>

<p>Macro update is meant to update a whole person document.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>POST http://xxx/person/ID</span></code></pre></td></tr></table></div></figure>


<h4><a name="update-input">Input</a></h4>

<p>Backend just receives the ID in the URL:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>http://xxx/ID</span></code></pre></td></tr></table></div></figure>


<p>Updated person document is in the Post body:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">name:</span> <span class="nt">&quot;Mike Dirolf&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">pw:</span> <span class="nt">&quot;new_password&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">addresses:</span> <span class="err">[</span><span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span> <span class="nt">&quot;mike@dirolf.com&quot;</span><span class="p">,</span> <span class="err">...],</span>
</span><span class='line'>  <span class="err">memberships:</span> <span class="err">[{</span>
</span><span class='line'>    <span class="err">address:</span> <span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group_name:</span> <span class="nt">&quot;family&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group:</span> <span class="err">GROUP_ID</span>
</span><span class='line'>  <span class="p">}</span><span class="err">,</span> <span class="err">...]</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a name="update-output">Output</a></h4>

<p>Nothing very interesting. Use a &#8220;200 OK&#8221; to stay simple</p>

<br/>


<br/>


<h3><a name="update-restricted">Restricted UPDATE</a></h3>

<p>Restricted update is meant to update just a part of a person document.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>POST http://xxx/person/ID/spec</span></code></pre></td></tr></table></div></figure>


<h4><a name="update-restricted-input">Input</a></h4>

<p>Backend just receives the ID in the URL:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='plain'><span class='line'>http://xxx/ID/spec</span></code></pre></td></tr></table></div></figure>


<p>Updated person document is in the Post body:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">addresses:</span> <span class="err">[</span><span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span> <span class="nt">&quot;mike@dirolf.com&quot;</span><span class="p">,</span> <span class="err">...],</span>
</span><span class='line'>  <span class="err">memberships:</span> <span class="err">[{</span>
</span><span class='line'>    <span class="err">address:</span> <span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group_name:</span> <span class="nt">&quot;family&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group:</span> <span class="err">GROUP_ID</span>
</span><span class='line'>  <span class="p">}</span><span class="err">,</span> <span class="err">...]</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">memberships:</span> <span class="err">[{</span>
</span><span class='line'>    <span class="err">address:</span> <span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group_name:</span> <span class="nt">&quot;family&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group:</span> <span class="err">GROUP_ID</span>
</span><span class='line'>  <span class="p">}</span><span class="err">,</span> <span class="err">...]</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>or</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">addresses:</span> <span class="err">[</span><span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span> <span class="nt">&quot;mike@dirolf.com&quot;</span><span class="p">,</span> <span class="err">...],</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a name="update-restricted-output">Output</a></h4>

<p>Nothing very interesting. Use a &#8220;200 OK&#8221; to stay simple</p>

<br/>


<br/>


<h2><a name="client">Backend/Client boundary</A></h2>

<p>Now that we know input/output data on our boundaries, we can describe how to validate these data and transform them within our backend system.</p>

<h3><a name="client-input">Input data from client (CREATE/ UPDATE)</A></h3>

<h4><a name="client-input-person-full">Full person validation</A></h4>

<p>When receiving JSON from client for <code>Create</code> and <code>Update</code> actions, we must be able to validate the Person structure without ID which will be generated at insertion:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="err">name:</span> <span class="nt">&quot;Mike Dirolf&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">pw:</span> <span class="nt">&quot;password&quot;</span><span class="p">,</span>
</span><span class='line'>  <span class="err">addresses:</span> <span class="err">[</span><span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span> <span class="nt">&quot;mike@dirolf.com&quot;</span><span class="p">,</span> <span class="err">...],</span>
</span><span class='line'>  <span class="err">memberships:</span> <span class="err">[{</span>
</span><span class='line'>    <span class="err">address:</span> <span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group_name:</span> <span class="nt">&quot;family&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">group:</span> <span class="err">GROUP_ID</span>
</span><span class='line'>  <span class="p">}</span><span class="err">,</span> <span class="err">...]</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Using Play2.1 JSON transformers (see my other article about it), you would validate this structure as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Full Person validator */</span>
</span><span class='line'><span class="k">val</span> <span class="n">validatePerson</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;name</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;pw</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;addresses</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">copyFrom</span><span class="o">(</span><span class="n">addressesOrEmptyArray</span><span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;memberships</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">copyFrom</span><span class="o">(</span><span class="n">membershipsOrEmptyArray</span><span class="o">)</span>
</span><span class='line'><span class="o">).</span><span class="n">reduce</span>
</span></code></pre></td></tr></table></div></figure>


<h5><code>addressesOrEmptyArray</code></h5>

<p>It&#8217;s a transformer validating an array of email strings and if not found it returns an empty array.<br/>
Here is how you can write this:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Addresses validators */</span>
</span><span class='line'><span class="c1">// if array is not empty, it validates each element as an email string</span>
</span><span class='line'><span class="k">val</span> <span class="n">validateAddresses</span> <span class="k">=</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">verifyingIf</span><span class="o">(</span> <span class="o">(</span><span class="n">arr</span><span class="k">:</span> <span class="kt">JsArray</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="n">arr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">)(</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">list</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="nc">Reads</span><span class="o">.</span><span class="n">email</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'><span class="c1">// extracts &quot;addresses&quot; field or returns an empty array and then validates all addresses</span>
</span><span class='line'><span class="k">val</span> <span class="n">addressesOrEmptyArray</span> <span class="k">=</span> <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;addresses</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pick</span><span class="o">[</span><span class="kt">JsArray</span><span class="o">]</span> <span class="n">orElse</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">()))</span> <span class="n">andThen</span> <span class="n">validateAddresses</span>
</span></code></pre></td></tr></table></div></figure>


<h5><code>membershipsOrEmptyArray</code></h5>

<p>It is a transformer validating an array of memberships and if not found it returns an empty array.<br/>
First, let&#8217;s write a <code>Membership</code> validator searching for <code>address</code> which must be an email, <code>group_name</code> and a <code>group_id</code>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">membership</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;address</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span><span class="o">(</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">of</span><span class="o">[</span><span class="kt">JsString</span><span class="o">]</span> <span class="n">keepAnd</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">email</span> <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;group_name</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;group</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span>
</span><span class='line'><span class="o">).</span><span class="n">reduce</span>  <span class="c1">// reduce merges all branches in a single JsObject</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now, use it to validate the membership list.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// if array is not empty, it validates each element as a membership</span>
</span><span class='line'><span class="k">val</span> <span class="n">validateMemberships</span> <span class="k">=</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">verifyingIf</span><span class="o">(</span> <span class="o">(</span><span class="n">arr</span><span class="k">:</span> <span class="kt">JsArray</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">!</span><span class="n">arr</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">isEmpty</span> <span class="o">)(</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">list</span><span class="o">(</span><span class="n">membership</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'><span class="c1">// extracts &quot;memberchips&quot; field or returns an empty array and then validates all memberships</span>
</span><span class='line'><span class="k">val</span> <span class="n">membershipsOrEmptyArray</span> <span class="k">=</span> <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;memberships</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pick</span><span class="o">[</span><span class="kt">JsArray</span><span class="o">]</span> <span class="n">orElse</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">()))</span> <span class="n">andThen</span> <span class="n">validateMemberships</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a name="client-input-person-restricted">Restricted person validation</A></h4>

<p>For restricted update, the client sends just the part that should be updated in the document and not all the document.
Yet the validator must accept only authorized fields.</p>

<p>Here is how you can write it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Person validator for restricted update */</span>
</span><span class='line'><span class="c1">// creates an empty JsObject whatever Json is provided</span>
</span><span class='line'><span class="k">val</span> <span class="n">emptyObj</span> <span class="k">=</span> <span class="nc">__</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">())</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// for each field, if not found, it simply writes an empty JsObject</span>
</span><span class='line'><span class="k">val</span> <span class="n">validatePerson4RestrictedUpdate</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;name</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span> <span class="n">or</span> <span class="n">emptyObj</span><span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;pw</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span> <span class="n">or</span> <span class="n">emptyObj</span><span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;addresses</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">copyFrom</span><span class="o">(</span><span class="n">addresses</span><span class="o">)</span> <span class="n">or</span> <span class="n">emptyObj</span><span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;memberships</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">copyFrom</span><span class="o">(</span><span class="n">memberships</span><span class="o">)</span> <span class="n">or</span> <span class="n">emptyObj</span><span class="o">)</span>
</span><span class='line'><span class="o">).</span><span class="n">reduce</span> <span class="c1">// merges all results</span>
</span></code></pre></td></tr></table></div></figure>


<h5><code>addresses</code></h5>

<p>This is the same as <code>addressesOrEmptyArray</code> but it doesn&#8217;t return an empty array if <code>addresses</code> are not found.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">addresses</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;addresses</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pick</span><span class="o">[</span><span class="kt">JsArray</span><span class="o">]</span> <span class="n">andThen</span> <span class="n">validateAddresses</span>
</span></code></pre></td></tr></table></div></figure>


<h5><code>memberships</code></h5>

<p>This is the same as <code>membershipsOrEmptyArray</code> but it doesn&#8217;t return an empty array if <code>memberships</code> are not found.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">memberships</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;memberships</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pick</span><span class="o">[</span><span class="kt">JsArray</span><span class="o">]</span> <span class="n">andThen</span> <span class="n">validateMemberships</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a name="client-output">Output data to Client (GET/DELETE)</A></h3>

<p>When a person document is retrieved from DB, this is the whole document and you may need to transform it before sending it to the output. In our case, let&#8217;s modify it as following:</p>

<ul>
<li>prune the password (even if hashed)</li>
<li>prune the _id (because client already knows it if it requested it)</li>
</ul>


<p>This can be done with the following JSON transformer:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** prunes _id </span>
</span><span class='line'><span class="cm">  * and then prunes pw</span>
</span><span class='line'><span class="cm">  */</span>
</span><span class='line'><span class="k">val</span> <span class="n">outputPerson</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;_id</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">prune</span> <span class="n">andThen</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;pw</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">prune</span>
</span></code></pre></td></tr></table></div></figure>


<p>Please note we don&#8217;t write it as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">outputPerson</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;_id</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">prune</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;pw</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">prune</span>
</span><span class='line'><span class="o">).</span><span class="n">reduce</span>
</span></code></pre></td></tr></table></div></figure>


<p>Why? Because <code>reduce</code> merges results of both Reads[JsObject] so:</p>

<ul>
<li><code>(__ \ '_id).json.prune</code> removes <code>_id</code> field but keeps <code>pw</code></li>
<li><code>(__ \ 'pw).json.prune</code> removes <code>pw</code> field but keeps <code>_id</code></li>
</ul>


<p>When <code>reduce</code> merges both results, it would return a Json with both <code>_id</code> and <code>pw</code> which is not exactly what we expect.</p>

<br/>


<br/>


<h2><a name="mongo">Backend/MongoDB boundary</a></h2>

<h3><a name="mong-output">Output to MongoDB</a></h3>

<p>Now we can validate a received JSON as a Person structure.<br/>
But we need to write it to Mongo and Mongo has a few specificities.</p>

<h4><a name="mongo-output-id">ID in Mongo is a <code>BsonObjectID</code></a></h4>

<p>Instead of waiting for Mongo to generate the ID, you can generate it using ReactiveMongo API <code>BSONObjectID.generate</code> before inserting it into Mongo.<br/>
So before sending JSON to Mongo, let&#8217;s add field <code>"_id" : "GENERATED_ID"</code> to validated JSON.<br/>
Here is the JSON transformer generating an ID:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">generateId</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;_id</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span> <span class="nc">BSONObjectID</span><span class="o">.</span><span class="n">generate</span><span class="o">.</span><span class="n">stringify</span> <span class="o">)</span> <span class="c1">// this generates a new ID and adds it to your JSON</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h4><a name="mongo-output-id-ext"><code>BsonObjectID</code> using JSON extended notation</a></h4>

<p>In JSON, <code>BsonObjectID</code> is represented as a String but to inform Mongo that it&#8217;s an ID and not a simple String, we use the following extended JSON notation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="s2">&quot;123456789123456789&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">//</span> <span class="err">becomes</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;_id&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="nt">&quot;$oid&quot;</span> <span class="p">:</span> <span class="s2">&quot;123456789123456789&quot;</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the JSON transformer to generate an ID using extended JSON notation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">generateId</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;_id</span> <span class="o">\</span> <span class="-Symbol">&#39;$oid</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span> <span class="nc">BSONObjectID</span><span class="o">.</span><span class="n">generate</span><span class="o">.</span><span class="n">stringify</span> <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h4><a name="mongo-output-date"><code>Date</code> Extended JSON</A></h4>

<p><code>created</code> field is a <code>Date</code> represented as a <code>JsNumber</code> (a long) in JSON. When passing it to Mongo, we use the following extended JSON notation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;creation&quot;</span> <span class="p">:</span> <span class="mi">123456789123456789</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'><span class="err">//</span> <span class="err">becomes</span>
</span><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;creation&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>     <span class="nt">&quot;$date&quot;</span> <span class="p">:</span> <span class="mi">123456789123456789</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the final JSON transformer to generate a date using extended JSON notation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">generateCreated</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;created</span> <span class="o">\</span> <span class="-Symbol">&#39;$date</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Date</span> <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3><a name="mongo-input">Input from Mongo</A></h3>

<p>As explained, using Play/ReactiveMongo, you don&#8217;t have to care about BSON because it deals with BSON/JSON conversion behind the curtain.<br/>
We could transform data received from Mongo in case we don&#8217;t really trust them.<br/>
But in my case, I trust Mongo as all inserted data are mine so no use to transform those input data from Mongo.</p>

<p>We just need to remove all JSON extended notation for <code>_id</code> or <code>created</code> when sending to the output.<br/>
The <code>_id</code> is pruned so no need to convert it.
So we just have to convert Json extended notation for <code>created</code> field. Here is the transformer:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// update duplicates full JSON and replaces &quot;created&quot; field by removing &quot;$date&quot; level</span>
</span><span class='line'><span class="k">val</span> <span class="n">fromCreated</span> <span class="k">=</span> <span class="nc">__</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">update</span><span class="o">((</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;created</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">copyFrom</span><span class="o">(</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;created</span> <span class="o">\</span> <span class="-Symbol">&#39;$date</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pick</span> <span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h2><a name="controller">Play2.1 controller as pipe plug</a></h2>

<p>Now, we can:</p>

<ul>
<li>validate input JSON received from client,</li>
<li>transform into Mongo format</li>
<li>transform from Mongo format to output</li>
</ul>


<p>Let&#8217;s plug the pipes all together:</p>

<ul>
<li>client inputs to Mongo outputs</li>
<li>Mongo inputs to client outputs</li>
</ul>


<p>Play controller is the place to do that and we can write one action per REST action.</p>

<blockquote><p>Please note that the whole code is in a single Controller in the sample to make it compact. But a good manner would be to put transformers outside the controller to be able to share them between controllers.</p></blockquote>

<p>In the following samples, please notice the way we compose all Json transformers described previously as if we were piping them.</p>

<h3><a name="action-insert">Insert Person</a></h3>

<p>When a Person document is created, there are 2 steps:</p>

<ul>
<li>validate the JSON using <code>validatePerson</code></li>
<li>transform JSON to fit Mongo format by:

<ul>
<li>adding a generated <code>BSONObjectID</code> field using <code>generateId</code></li>
<li>adding a generated <code>created</code> date field using <code>generateCreated</code></li>
</ul>
</li>
</ul>


<p>Here is the JSON transformer to transform into Mongo format:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Updates Json by adding both ID and date */</span>
</span><span class='line'><span class="k">val</span> <span class="n">addMongoIdAndDate</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">JsObject</span><span class="o">]</span> <span class="k">=</span> <span class="nc">__</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">update</span><span class="o">(</span> <span class="o">(</span><span class="n">generateId</span> <span class="n">and</span> <span class="n">generateCreated</span><span class="o">).</span><span class="n">reduce</span> <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally the insert action could be coded as:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">insertPerson</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">(</span><span class="n">parse</span><span class="o">.</span><span class="n">json</span><span class="o">){</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">validatePerson</span> <span class="n">andThen</span> <span class="n">addMongoIdAndDate</span><span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">jsobj</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">Async</span><span class="o">{</span>
</span><span class='line'>      <span class="n">persons</span><span class="o">.</span><span class="n">insert</span><span class="o">(</span><span class="n">jsobj</span><span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">p</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="c1">// removes extended JSON to ouput generated _id</span>
</span><span class='line'>        <span class="nc">Ok</span><span class="o">(</span> <span class="n">resOK</span><span class="o">(</span><span class="n">jsobj</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">fromObjectId</span><span class="o">).</span><span class="n">get</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="o">}.</span><span class="n">recover</span><span class="o">{</span> <span class="k">case</span> <span class="n">e</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="nc">InternalServerError</span><span class="o">(</span> <span class="n">resKO</span><span class="o">(</span><span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;exception %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">getMessage</span><span class="o">)))</span> <span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">recoverTotal</span><span class="o">{</span> <span class="n">err</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">BadRequest</span><span class="o">(</span> <span class="n">resKO</span><span class="o">(</span><span class="nc">JsError</span><span class="o">.</span><span class="n">toFlatJson</span><span class="o">(</span><span class="n">err</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>resOK</code> and <code>resKO</code> are just function building JSON result with response status. Have a look at code for more info.</p>

<br/>


<br/>


<h3><a name="action-get">Get Person</a></h3>

<p>The action receives the ID of the person as a String and we only need to generate the right Mongo JSON format to retrieve the document.
Here is the Json <code>Writes[String]</code> that creates the extended JSON notation from ID:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">toObjectId</span> <span class="k">=</span> <span class="nc">OWrites</span><span class="o">[</span><span class="kt">String</span><span class="o">]{</span> <span class="n">s</span> <span class="k">=&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;_id&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;$oid&quot;</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">))</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now the <code>getPerson</code> action code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">getPerson</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">{</span>
</span><span class='line'>  <span class="c1">// builds a query from ID</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">q</span> <span class="k">=</span> <span class="nc">QueryBuilder</span><span class="o">().</span><span class="n">query</span><span class="o">(</span><span class="n">toObjectId</span><span class="o">.</span><span class="n">writes</span><span class="o">(</span><span class="n">id</span><span class="o">))</span>
</span><span class='line'>  <span class="nc">Async</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">persons</span><span class="o">.</span><span class="n">find</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span><span class="n">q</span><span class="o">).</span><span class="n">headOption</span><span class="o">.</span><span class="n">map</span><span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">None</span> <span class="k">=&gt;</span> <span class="nc">NotFound</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;res&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;KO&quot;</span><span class="o">,</span> <span class="s">&quot;error&quot;</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="s">&quot;person with ID $id not found&quot;</span><span class="o">))</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">Some</span><span class="o">(</span><span class="n">p</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="n">p</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">outputPerson</span><span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">jsonp</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="nc">Ok</span><span class="o">(</span> <span class="n">resOK</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;person&quot;</span> <span class="o">-&gt;</span> <span class="n">jsonp</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>        <span class="o">}.</span><span class="n">recoverTotal</span><span class="o">{</span> <span class="n">e</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="nc">BadRequest</span><span class="o">(</span> <span class="n">resKO</span><span class="o">(</span><span class="nc">JsError</span><span class="o">.</span><span class="n">toFlatJson</span><span class="o">(</span><span class="n">e</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h3><a name="action-delete">Delete Person</a></h3>

<p><code>Delete</code> is exactly the same as <code>Get</code> in terms of input and it doesn&#8217;t require any output except to inform about success or failure.<br/>
So let&#8217;s give directly the <code>deletePerson</code>code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">deletePerson</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">{</span>
</span><span class='line'>  <span class="nc">Async</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">persons</span><span class="o">.</span><span class="n">remove</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">](</span><span class="n">toObjectId</span><span class="o">.</span><span class="n">writes</span><span class="o">(</span><span class="n">id</span><span class="o">)).</span><span class="n">map</span><span class="o">{</span> <span class="n">lastError</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="k">if</span><span class="o">(</span><span class="n">lastError</span><span class="o">.</span><span class="n">ok</span><span class="o">)</span>
</span><span class='line'>        <span class="nc">Ok</span><span class="o">(</span> <span class="n">resOK</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;msg&quot;</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="s">&quot;person $id deleted&quot;</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>      <span class="k">else</span>
</span><span class='line'>        <span class="nc">InternalServerError</span><span class="o">(</span> <span class="n">resKO</span><span class="o">(</span><span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;error %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">lastError</span><span class="o">.</span><span class="n">stringify</span><span class="o">)))</span> <span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h3><a name="action-update">Update Full Person</a></h3>

<p>When updating a full person:</p>

<ul>
<li>we receive the ID in the URL</li>
<li>we receive the new Json representing the person in the body</li>
<li>we need to update the corresponding document in DB.</li>
</ul>


<p>So we must do the following:</p>

<ul>
<li>validate input JSON using <code>validatePerson</code></li>
<li>transform the ID into MongoID JSON extended notation using <code>toObjectId</code> described previously</li>
<li>transform json into Update Json extended notation:</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='json'><span class='line'><span class="p">{</span>
</span><span class='line'>  <span class="nt">&quot;$set&quot;</span> <span class="p">:</span> <span class="p">{</span>
</span><span class='line'>    <span class="err">name:</span> <span class="nt">&quot;Mike Dirolf&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">pw:</span> <span class="nt">&quot;password&quot;</span><span class="p">,</span>
</span><span class='line'>    <span class="err">addresses:</span> <span class="err">[</span><span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span> <span class="nt">&quot;mike@dirolf.com&quot;</span><span class="p">,</span> <span class="err">...],</span>
</span><span class='line'>    <span class="err">memberships:</span> <span class="err">[{</span>
</span><span class='line'>      <span class="err">address:</span> <span class="nt">&quot;mike@corp.fiesta.cc&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="err">group_name:</span> <span class="nt">&quot;family&quot;</span><span class="p">,</span>
</span><span class='line'>      <span class="err">group:</span> <span class="err">GROUP_ID</span>
</span><span class='line'>    <span class="p">},</span> <span class="err">...]</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="err">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is the JSON transformer for update notation:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="cm">/** Converts JSON into Mongo update selector by just copying whole object in $set field */</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">toMongoUpdate</span> <span class="k">=</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;$set</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">copyFrom</span><span class="o">(</span> <span class="nc">__</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="n">pick</span> <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Finally here is the corresponding <code>updatePerson</code> action code</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">updatePerson</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">(</span><span class="n">parse</span><span class="o">.</span><span class="n">json</span><span class="o">){</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">validatePerson</span><span class="o">).</span><span class="n">flatMap</span><span class="o">{</span> <span class="n">jsobj</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="n">jsobj</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">toMongoUpdate</span><span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">updateSelector</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="nc">Async</span><span class="o">{</span>
</span><span class='line'>        <span class="n">persons</span><span class="o">.</span><span class="n">update</span><span class="o">(</span>
</span><span class='line'>          <span class="n">toObjectId</span><span class="o">.</span><span class="n">writes</span><span class="o">(</span><span class="n">id</span><span class="o">),</span>
</span><span class='line'>          <span class="n">updateSelector</span>
</span><span class='line'>        <span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">lastError</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="k">if</span><span class="o">(</span><span class="n">lastError</span><span class="o">.</span><span class="n">ok</span><span class="o">)</span>
</span><span class='line'>            <span class="nc">Ok</span><span class="o">(</span> <span class="n">resOK</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;msg&quot;</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="s">&quot;person $id updated&quot;</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>            <span class="nc">InternalServerError</span><span class="o">(</span> <span class="n">resKO</span><span class="o">(</span><span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;error %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">lastError</span><span class="o">.</span><span class="n">stringify</span><span class="o">)))</span> <span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">recoverTotal</span><span class="o">{</span> <span class="n">e</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">BadRequest</span><span class="o">(</span> <span class="n">resKO</span><span class="o">(</span><span class="nc">JsError</span><span class="o">.</span><span class="n">toFlatJson</span><span class="o">(</span><span class="n">e</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3><a name="action-update-restricted">Update Restricted Person</a></h3>

<p>Restricted update is exactly the same as Full update except it validates the input JSON using <code>validatePerson4RestrictedUpdate</code> instead of <code>validatePerson</code></p>

<p>So here is the <code>updatePersonRestricted</code> action code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">updatePersonRestricted</span><span class="o">(</span><span class="n">id</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">(</span><span class="n">parse</span><span class="o">.</span><span class="n">json</span><span class="o">){</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="n">request</span><span class="o">.</span><span class="n">body</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">validatePerson4RestrictedUpdate</span><span class="o">).</span><span class="n">flatMap</span><span class="o">{</span> <span class="n">jsobj</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="n">jsobj</span><span class="o">.</span><span class="n">transform</span><span class="o">(</span><span class="n">toMongoUpdate</span><span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">updateSelector</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="nc">Async</span><span class="o">{</span>
</span><span class='line'>        <span class="n">persons</span><span class="o">.</span><span class="n">update</span><span class="o">(</span>
</span><span class='line'>          <span class="n">toObjectId</span><span class="o">.</span><span class="n">writes</span><span class="o">(</span><span class="n">id</span><span class="o">),</span>
</span><span class='line'>         <span class="n">updateSelector</span>
</span><span class='line'>        <span class="o">).</span><span class="n">map</span><span class="o">{</span> <span class="n">lastError</span> <span class="k">=&gt;</span>
</span><span class='line'>          <span class="k">if</span><span class="o">(</span><span class="n">lastError</span><span class="o">.</span><span class="n">ok</span><span class="o">)</span>
</span><span class='line'>            <span class="nc">Ok</span><span class="o">(</span> <span class="n">resOK</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;msg&quot;</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="s">&quot;person $id updated&quot;</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>          <span class="k">else</span>
</span><span class='line'>            <span class="nc">InternalServerError</span><span class="o">(</span> <span class="n">resKO</span><span class="o">(</span><span class="nc">JsString</span><span class="o">(</span><span class="s">&quot;error %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">(</span><span class="n">lastError</span><span class="o">.</span><span class="n">stringify</span><span class="o">)))</span> <span class="o">)</span>
</span><span class='line'>        <span class="o">}</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}.</span><span class="n">recoverTotal</span><span class="o">{</span> <span class="n">e</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="nc">BadRequest</span><span class="o">(</span> <span class="n">resKO</span><span class="o">(</span><span class="nc">JsError</span><span class="o">.</span><span class="n">toFlatJson</span><span class="o">(</span><span class="n">e</span><span class="o">))</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h1><a name="code">Full Code</a></h1>

<blockquote><p>The whole sample can be found on Github <a href="https://github.com/mandubian/play2-json-demo/tree/master/json-coast-to-coast">json-coast-to-coast sample</a>
To test it, use a Rest client such as Postman or whatever.</p></blockquote>

<br/>


<br/>


<h1><a name="conclusion">Conclusion</a></h1>

<p>Many things in this articleâ€¦ Maybe too manyâ€¦<br/>
Anyway, the subject is huge and deserves it.</p>

<p>This sample demonstrates it&#8217;s possible to transmit a JSON data-flow from client to DB without going through any static model. That&#8217;s why I speak about <em>JSON coast-to-coast</em> and I find it&#8217;s a very good pattern in many cases in our <em>every-day-as-backend-designer</em> life.</p>

<p>Just remind 3 things maybe:</p>

<ul>
<li>data flow direct manipulation is possible, practical and useful.</li>
<li>pure data manipulation doesn&#8217;t lessen type-safety or data structuring as you control everything at the boundaries of your backend system.</li>
<li>static model is useful sometimes but not always so before writing generic classes, DAO everywhere, think about your real needs.</li>
</ul>


<p>In the code sample, I don&#8217;t take into account the temporal behavior of data and the dynamic requirements of interactions with other elements of the data flow. But don&#8217;t forget this aspect in your backend design.</p>

<blockquote><p>Finally, as you could see, <strong>ReactiveMongo</strong> mixed with <strong>Play2.1 JSON API</strong> provides us with a really good toolbox for data-centric approach. It also allows to deal with realtime data flow to design so-called reactive applications (which is also the reason of being of Play2 framework).</p></blockquote>

<p>Have flowfun!</p>
</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li class="previous"><a href="/blog/page/3/">&larr; Older</a></li>
    
    <li><a href="/blog/archives">Blog Archives</a></li>
    
    <li class="next"><a href="/">Newer &rarr;</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/2014/02/13/zpark/">ZPark-Ztream: Driving Spark distributed stream with Scalaz-Stream</a>
      </li>
    
      <li class="post">
        <a href="/2014/01/31/play-rules-shapeless/">New Play 2.3 Validation API : breaking the 22 limits with Shapeless</a>
      </li>
    
      <li class="post">
        <a href="/2013/09/22/play-actor-room/">Play 2.2 Actor Room: websocket (&more) room manager only with actors</a>
      </li>
    
      <li class="post">
        <a href="/2013/08/21/playztream/">Scalaz-Stream Plug&#8217;n&#8217;Play2 Iteratee/WS + Recursive streaming</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/11/play-autosource-datomisca/">Play AutoSource & Datomisca: Proofing the concept on Datomic, a Schema DB</a>
      </li>
    
  </ul>
</section>


<section class="well">
  <ul id="tweets" class="nav" data-user="mandubian" data-count="4" data-replies="false">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
    <a href="http://twitter.com/mandubian" class="twitter-follow-button" data-show-count="false">Follow @mandubian</a>
  
</section>



<section class="well">
  <ul id="gh_repos" data-user="mandubian" data-count="5" data-skip="true" class="nav">
	<li class="nav-header">On GitHub</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a class="github-follow" href="https://github.com/mandubian">Follow @mandubian</a>
  
</section>










  
</aside>

    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2014 - Pascal Voitot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mandubian';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
