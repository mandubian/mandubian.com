
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Mandubian Blog</title>
  <meta name="author" content="Pascal Voitot">

  
  <meta name="description" content="Unveiling Play 2.1 Json API - Part 2 : Writes/Format Combinators
    
    
      
        








  


Oct 1st, &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.mandubian.com/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }

    article {
      margin-bottom: 50px;
      border-top: #DDD solid 20px;
    }
 
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mandubian Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10417377-11']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Mandubian Blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:www.mandubian.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      <div class="span9">
  
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2012/10/01/unveiling-play-2-dot-1-json-api-part2-writes-format-combinators/">Unveiling Play 2.1 Json API - Part 2 : Writes/Format Combinators</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-10-01T11:10:00+02:00" pubdate data-updated="true">Oct 1<span>st</span>, 2012</time>
        
         | <a href="/2012/10/01/unveiling-play-2-dot-1-json-api-part2-writes-format-combinators/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>In <a href="/2012/09/08/unveiling-play-2-dot-1-json-api-part1-jspath-reads-combinators/">Part 1 article</a>, we gave a quick overview of new Play2.1 JSON API features around JsPath and Reads combinators. It&#8217;s funny to be able to read JSON to Scala structures but it&#8217;s better to be able to <strong>write Scala structures to JSON (<code>Writes[T]</code>)</strong> and it&#8217;s even better to <strong>mix Reads and Writes (<code>Format[T]</code>)</strong> sometimes.</p></blockquote>

<p><strong>Now let&#8217;s focus on Writes and Format in the details ;)</strong></p>

<br/>


<br/>


<h1><a name="writes">Writes[T] hasn&#8217;t changed (except combinators)</a></h1>

<h2><a name="writes-2_0">Writes in Play2.0.x</a></h2>

<p>Do you remember how you had to write a Json <code>Writes[T]</code> in <code>Play2.0.x</code> ?<br/>
You had to override the <code>writes</code> function.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Writes</span><span class="o">[</span><span class="kt">-A</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">self</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Convert the object into a JsValue</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">o</span><span class="k">:</span> <span class="kt">A</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsValue</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Take the same simple case class we used in Part 1:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Creature</span><span class="o">(</span>
</span><span class='line'>  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>  <span class="n">isDead</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
</span><span class='line'>  <span class="n">weight</span><span class="k">:</span> <span class="kt">Float</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In <code>Play2.0.x</code>, you would write your <code>Writes[Creature]</code> as following (using new Json syntax to re-show it even if it didn&#8217;t exist in Play2.0.x ;) ):</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureWrites</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Writes</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">writes</span><span class="o">(</span><span class="n">c</span><span class="k">:</span> <span class="kt">Creature</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsValue</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>      <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="o">,</span>
</span><span class='line'>      <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">isDead</span><span class="o">,</span>
</span><span class='line'>      <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">.</span><span class="n">weight</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">gizmo</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mf">1.0F</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">gizmojs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">gizmo</span><span class="o">)</span>
</span><span class='line'><span class="n">gizmojs</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">gremlins</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;isDead&quot;</span><span class="k">:</span><span class="kt">false</span><span class="o">,</span><span class="s">&quot;weight&quot;</span><span class="k">:</span><span class="err">1</span><span class="kt">.</span><span class="err">0</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h2><a name="writes-2_1">Writes in Play2.1.x</a></h2>

<p>No suspense to be kept: <strong>in Play2.1, you write Writes exactly in the same way</strong> :D</p>

<p>So what&#8217;s the difference?<br/>
As presented in Part 1, <code>Reads</code> could be combined using simple logical operators.<br/>
Using functional Scala power, we were able to <strong>provide combinators for <code>Writes[T]</code></strong>.</p>

<blockquote><p>If you want more theoretical aspects about the way it was implemented based on generic functional structures adapted to our needs, you can read this post <a href="http://sadache.tumblr.com/post/30955704987/applicatives-are-too-restrictive-breaking-applicativesfrom">&#8220;Applicatives are too restrictive, breaking Applicatives and introducing Functional Builders&#8221;</a> written by <a href="http://www.github.com/sadache">@sadache</a></p></blockquote>

<h2><a name="writes-combined">Writes main change: <em>combinators</em></a></h2>

<p>Once again, code first: re-writing previous <code>Writes[T]</code> using combinators.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// IMPORTANT import this to have the required tools in your scope</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="c1">// imports required functional generic structures</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.util._</span>
</span><span class='line'><span class="c1">// imports implicit structure for Writes only (always try to import only what you need)</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Writes._</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureWrites</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="n">unlift</span><span class="o">(</span><span class="nc">Creature</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// or using the operators inspired by Scala parser combinators for those who know them</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureWrites</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">~</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">~</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="n">unlift</span><span class="o">(</span><span class="nc">Creature</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mf">1.0F</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">c</span><span class="o">)</span>
</span><span class='line'><span class="n">js</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">gremlins</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;isDead&quot;</span><span class="k">:</span><span class="kt">false</span><span class="o">,</span><span class="s">&quot;weight&quot;</span><span class="k">:</span><span class="err">1</span><span class="kt">.</span><span class="err">0</span><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It looks exactly like <code>Reads[T]</code> except a few things, isn&#8217;t it?<br/>
Let&#8217;s explain a bit (by copying Reads article changing just a few things… I&#8217;m lazy ;)):</p>

<h5><code>import play.api.libs.json.Writes._</code></h5>

<p>It imports only the required stuff for <code>Writes[T]</code> without interfering with other imports.</p>

<br/>


<h5><code>(__ \ "name").write[String]</code></h5>

<p>You apply <code>write[String]</code> on this JsPath (exactly the same as <code>Reads</code>)</p>

<br/>


<h5><code>and</code> is just an operator meaning <code>Writes[A] and Writes[B] =&gt; Builder[Writes[A ~ B]]</code></h5>

<ul>
<li><code>A ~ B</code> just means <code>Combine A and B</code> but it doesn&#8217;t suppose the way it is combined (can be a tuple, an object, whatever…)</li>
<li><code>Builder</code> is not a real type but I introduce it just to tell that the operator <code>and</code> doesn&#8217;t create directly a <code>Writes[A ~ B]</code> but an intermediate structure that is able to build a <code>Writes[A ~ B]</code> or to combine with another <code>Writes[C]</code></li>
</ul>


<br/>   


<h5><code>(…)(unlift(Creature.unapply))</code> builds a <code>Writes[Creature]</code></h5>

<ul>
<li><code>(__ \ "name").write[String] and (__ \ "isDead").write[Boolean] and (__ \ "weight").write[Float]</code> builds a <code>Builder[Writes[String ~ Boolean ~ Float])]</code> but you want a <code>Writes[Creature]</code>.</li>
<li>So you apply the <code>Builder[Writes[String ~ Boolean ~ String])]</code> to a function <code>Creature =&gt; (String, Boolean, Float)</code> to finally obtain a <code>Writes[Creature]</code>. Please note that it may seem a bit strange to provide <code>Creature =&gt; (String, Boolean, Float)</code> to obtain a <code>Writes[Creature]</code> from a <code>Builder[Writes[String ~ Boolean ~ String])]</code> but it&#8217;s due to the contravariant nature of <code>Writes[-T]</code>.</li>
<li>We have <code>Creature.unapply</code> but its signature is <code>Creature =&gt; Option[(String, Boolean, Float)]</code> so we <code>unlift</code> it to obtain <code>Creature =&gt; (String, Boolean, Float)</code>.</li>
</ul>


<br/>


<blockquote><p>The only thing you have to keep in mind is this <code>unlift</code> call which might not be natural at first sight!</p></blockquote>

<p>As you can deduce by yourself, the <code>Writes[T]</code> is far easier than the <code>Reads[T]</code> case because when writing, it doesn&#8217;t try to validate so there is no error management at all.</p>

<p>Moreover, due to this, you have to keep in mind that operators provided for <code>Writes[T]</code> are not as rich as for <code>Reads[T]</code>. Do you remind <code>keepAnd</code> and <code>andKeep</code> operators?  They don&#8217;t have any meaning for <code>Writes[T]</code>. When writing <code>A~B</code>, you write <code>A and B</code> but not <code>only A or only B</code>. So <code>and</code> is the only operators provided for <code>Writes[T]</code>.</p>

<h3>Complexifying the case</h3>

<p>Let&#8217;s go back to our more complex sample used in end of Part1.
Remember that we had imagined that our creature was modelled as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Creature</span><span class="o">(</span>
</span><span class='line'>  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>  <span class="n">isDead</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
</span><span class='line'>  <span class="n">weight</span><span class="k">:</span> <span class="kt">Float</span><span class="o">,</span>
</span><span class='line'>  <span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="c1">// email format and minLength(5)</span>
</span><span class='line'>  <span class="n">favorites</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Int</span><span class="o">),</span> <span class="c1">// the stupid favorites</span>
</span><span class='line'>  <span class="n">friends</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">,</span> <span class="c1">// yes by default it has no friend</span>
</span><span class='line'>  <span class="n">social</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span> <span class="c1">// by default, it&#39;s not social</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s write corresponding <code>Writes[Creature]</code></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// IMPORTANT import this to have the required tools in your scope</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="c1">// imports required functional generic structures</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.util._</span>
</span><span class='line'><span class="c1">// imports implicit structure for Writes only (always try to import only what you need)</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Writes._</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureWrites</span><span class="k">:</span> <span class="kt">Writes</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;email&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;favorites&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">(</span>
</span><span class='line'>      <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;string&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>      <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;number&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
</span><span class='line'>      <span class="n">tupled</span>
</span><span class='line'>  <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;friends&quot;</span><span class="o">).</span><span class="n">lazyWrite</span><span class="o">(</span><span class="nc">Writes</span><span class="o">.</span><span class="n">traversableWrites</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="n">creatureWrites</span><span class="o">))</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;social&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span>
</span><span class='line'><span class="o">)(</span><span class="n">unlift</span><span class="o">(</span><span class="nc">Creature</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">gizmo</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mf">1.0F</span><span class="o">,</span> <span class="s">&quot;gizmo@midnight.com&quot;</span><span class="o">,</span> <span class="o">(</span><span class="s">&quot;alpha&quot;</span><span class="o">,</span> <span class="mi">85</span><span class="o">),</span> <span class="nc">List</span><span class="o">(),</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;@gizmo&quot;</span><span class="o">))</span>
</span><span class='line'><span class="k">val</span> <span class="n">gizmojs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">gizmo</span><span class="o">)</span>
</span><span class='line'><span class="n">gizmojs</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">gremlins</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;isDead&quot;</span><span class="k">:</span><span class="kt">false</span><span class="o">,</span><span class="s">&quot;weight&quot;</span><span class="k">:</span><span class="err">1</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;email&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">gizmo@midnight.com</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;favorites&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">string</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">alpha</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">number</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">85</span><span class="o">},</span><span class="s">&quot;friends&quot;</span><span class="k">:</span><span class="err">[]</span><span class="o">,</span><span class="s">&quot;social&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">@gizmo</span><span class="err">&quot;</span><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">zombie</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;zombie&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mf">100.0F</span><span class="o">,</span> <span class="s">&quot;shaun@dead.com&quot;</span><span class="o">,</span> <span class="o">(</span><span class="s">&quot;ain&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span> <span class="nc">List</span><span class="o">(</span><span class="n">gizmo</span><span class="o">),</span> <span class="nc">None</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">zombiejs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">zombie</span><span class="o">)</span>
</span><span class='line'><span class="n">zombiejs</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsValue</span> <span class="o">=</span> <span class="o">{</span><span class="s">&quot;name&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">zombie</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;isDead&quot;</span><span class="k">:</span><span class="kt">true</span><span class="o">,</span><span class="s">&quot;weight&quot;</span><span class="k">:</span><span class="err">100</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;email&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">shaun@dead.com</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;favorites&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">string</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">ain</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">number</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">2</span><span class="o">},</span><span class="s">&quot;friends&quot;</span><span class="k">:</span><span class="err">[</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">name</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">gremlins</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">isDead</span><span class="err">&quot;</span><span class="kt">:false</span><span class="o">,</span><span class="s">&quot;weight&quot;</span><span class="k">:</span><span class="err">1</span><span class="kt">.</span><span class="err">0</span><span class="o">,</span><span class="s">&quot;email&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">gizmo@midnight.com</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;favorites&quot;</span><span class="k">:</span><span class="o">{</span><span class="err">&quot;</span><span class="kt">string</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">&quot;</span><span class="kt">alpha</span><span class="err">&quot;</span><span class="o">,</span><span class="err">&quot;</span><span class="kt">number</span><span class="err">&quot;</span><span class="kt">:</span><span class="err">85</span><span class="o">},</span><span class="s">&quot;friends&quot;</span><span class="k">:</span><span class="err">[]</span><span class="o">,</span><span class="s">&quot;social&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">@gizmo</span><span class="err">&quot;</span><span class="o">}</span><span class="err">]</span><span class="o">,</span><span class="s">&quot;social&quot;</span><span class="k">:</span><span class="kt">null</span>
</span></code></pre></td></tr></table></div></figure>


<p>You can see that it&#8217;s quite straightforward. it&#8217;s far easier than <code>Reads[T]</code> as there are no special operator.
Here are the few things to explain:</p>

<h5><code>(__ \ "favorites").write(…)</code></h5>

<pre><code>(__ \ "string").write[String] and
(__ \ "number").write[Int]
tupled
</code></pre>

<ul>
<li>Remember that <code>(__ \ "string").write[String](…) and (__ \ "number").write[Int](…) =&gt; Builder[Writes[String ~ Int]]</code></li>
<li>What means <code>tupled</code> ? as for <code>Reads[T]</code>, it <em>&#8220;tuplizes&#8221;</em> your Builder: <code>Builder[Writes[A ~ B]].tupled =&gt; Writes[(A, B)]</code></li>
</ul>


<br/>


<h5><code>(__ \ "friend").lazyWrite(Writes.traversableWrites[Creature](creatureWrites))</code></h5>

<p>It&#8217;s the symmetric code for <code>lazyRead</code> to treat recursive field on <code>Creature</code> class itself:</p>

<ul>
<li><code>Writes.traversableWrites[Creature](creatureWrites)</code> creates a <code>Writes[Traversable[Creature]]</code> passing the <code>Writes[Creature]</code> itself for recursion (please note that a <code>list[Creature]</code>should appear very soon ;))</li>
<li><code>(__ \ "friends").lazyWrite[A](r: =&gt; Writes[A]))</code> : <code>lazyWrite</code> expects a <code>Writes[A]</code> value <em>passed by name</em> to allow the type recursive construction. This is the only refinement that you must keep in mind in this very special recursive case.</li>
</ul>


<blockquote><p>FYI, you may wonder why <code>Writes.traversableWrites[Creature]: Writes[Traversable[Creature]]</code> can replace <code>Writes[List[Creature]]</code>?<br/>
This is because <code>Writes[-T]</code> is contravariant meaning: if you can write a <code>Traversable[Creature]</code>, you can write a <code>List[Creature]</code> as <code>List</code> inherits <code>Traversable</code> (relation of inheritance is reverted by contravariance).</p></blockquote>

<h2><a name="format">What about combinators for Format?</a></h2>

<p>Remember in Play2.1, there was a feature called <code>Format[T] extends Reads[T] with Writes[T]</code>.<br/>
It mixed <code>Reads[T]</code> and <code>Writes[T]</code> together to provide serialization/deserialization at the same place.</p>

<p>Play2.1 provide combinators for <code>Reads[T]</code> and <code>Writes[T]</code>. What about combinators for <code>Format[T]</code> ?</p>

<p>Let&#8217;s go back to our very simple sample:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Creature</span><span class="o">(</span>
</span><span class='line'>  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>  <span class="n">isDead</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
</span><span class='line'>  <span class="n">weight</span><span class="k">:</span> <span class="kt">Float</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here is how you write the <code>Reads[Creature]</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.util._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Reads._</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">creatureReads</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Creature</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please remark that I didn&#8217;t use <code>implicit</code> so that there is no implicit <code>Reads[Creature]</code> in the context when I&#8217;ll define <code>Format[T]</code></p></blockquote>

<p>Here is how you write the <code>Writes[Creature]</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.util._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Writes._</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">creatureWrites</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="n">unlift</span><span class="o">(</span><span class="nc">Creature</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<h3>How to gather both Reads/Writes to create a <code>Format[Creature]</code>?</h3>

<h4><a name="format-1">1st way = create from existing reads/writes</a></h4>

<p>You can reuse existing <code>Reads[T]</code> and <code>Writes[T]</code> to create a <code>Format[T]</code> as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureFormat</span> <span class="k">=</span> <span class="nc">Format</span><span class="o">(</span><span class="n">creatureReads</span><span class="o">,</span> <span class="n">creatureWrites</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">gizmojs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0F</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">gizmo</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mf">1.0F</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">assert</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">fromJson</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="n">gizmojs</span><span class="o">).</span><span class="n">get</span> <span class="o">==</span> <span class="n">gizmo</span><span class="o">)</span>
</span><span class='line'><span class="n">assert</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">gizmo</span><span class="o">)</span> <span class="o">==</span> <span class="n">gizmojs</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4><a name="format-2">2nd way = create using combinators</a></h4>

<p>We have Reads and Writes combinators, isn&#8217;t it?<br/>
Play2.1 also provides <strong>Format Combinators</strong> due to the magic of functional programming (actually it&#8217;s not magic, it&#8217;s just pure functional programming;) )</p>

<p>As usual, code 1st:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.util._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Format._</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureFormat</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">format</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">format</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">format</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Creature</span><span class="o">.</span><span class="n">apply</span><span class="o">,</span> <span class="n">unlift</span><span class="o">(</span><span class="nc">Creature</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">gizmojs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0F</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">gizmo</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mf">1.0F</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">assert</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">fromJson</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="n">gizmojs</span><span class="o">).</span><span class="n">get</span> <span class="o">==</span> <span class="n">gizmo</span><span class="o">)</span>
</span><span class='line'><span class="n">assert</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">gizmo</span><span class="o">)</span> <span class="o">==</span> <span class="n">gizmojs</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Nothing too strange…</p>

<h5><code>(__ \ "name").format[String]</code></h5>

<p>It creates a format[String] reading/writing at the given <code>JsPath</code></p>

<br/>


<h5><code>( )(Creature.apply, unlift(Creature.unapply))</code></h5>

<p>To map to a Scala structure:</p>

<ul>
<li><code>Reads[Creature]</code> requires a function <code>(String, Boolean, Float) =&gt; Creature</code></li>
<li><code>Writes[Creature]</code> requires a function <code>Creature =&gt; (String, Boolean, Float)</code></li>
</ul>


<p>So as <code>Format[Creature] extends Reads[Creature] with Writes[Creature]</code> we provide <code>Creature.apply</code> and <code>unlift(Creature.unapply)</code> and that&#8217;s all folks&#8230;</p>

<h2><a name="format">More complex case</a></h2>

<p>The previous sample is a bit dumb because the structure is really simple and because reading/writing is symmetric. We have:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Json</span><span class="o">.</span><span class="n">fromJson</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">creature</span><span class="o">))</span> <span class="o">==</span> <span class="n">creature</span>
</span></code></pre></td></tr></table></div></figure>


<p>In this case, you read what you write and vis versa. So you can use the very simple <code>JsPath.format[T]</code> functions which build both <code>Reads[T]</code> and <code>Writes[T]</code> together.</p>

<p>But if we take our usual more complicated case class, how to write the <code>Format[T]</code>?</p>

<p>Remind the code:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
<span class='line-number'>50</span>
<span class='line-number'>51</span>
<span class='line-number'>52</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.util._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// The case class</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Creature</span><span class="o">(</span>
</span><span class='line'>  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>  <span class="n">isDead</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
</span><span class='line'>  <span class="n">weight</span><span class="k">:</span> <span class="kt">Float</span><span class="o">,</span>
</span><span class='line'>  <span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="c1">// email format and minLength(5)</span>
</span><span class='line'>  <span class="n">favorites</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Int</span><span class="o">),</span> <span class="c1">// the stupid favorites</span>
</span><span class='line'>  <span class="n">friends</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">,</span> <span class="c1">// yes by default it has no friend</span>
</span><span class='line'>  <span class="n">social</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span> <span class="c1">// by default, it&#39;s not social</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.data.validation.ValidationError</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Reads._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// defines a custom reads to be reused</span>
</span><span class='line'><span class="c1">// a reads that verifies your value is not equal to a give value</span>
</span><span class='line'><span class="k">def</span> <span class="n">notEqualReads</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">v</span><span class="k">:</span> <span class="kt">T</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">r</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">filterNot</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="s">&quot;validate.error.unexpected.value&quot;</span><span class="o">,</span> <span class="n">v</span><span class="o">))(</span> <span class="k">_</span> <span class="o">==</span> <span class="n">v</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">skipReads</span><span class="o">(</span><span class="k">implicit</span> <span class="n">r</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">r</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">creatureReads</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;email&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span><span class="n">email</span> <span class="n">keepAnd</span> <span class="n">minLength</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="mi">5</span><span class="o">))</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;favorites&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span>
</span><span class='line'>      <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;string&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span> <span class="n">notEqualReads</span><span class="o">(</span><span class="s">&quot;ni&quot;</span><span class="o">)</span> <span class="n">andKeep</span> <span class="n">skipReads</span> <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>      <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;number&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span> <span class="n">max</span><span class="o">(</span><span class="mi">86</span><span class="o">)</span> <span class="n">or</span> <span class="n">min</span><span class="o">(</span><span class="mi">875</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="n">tupled</span>
</span><span class='line'>  <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;friends&quot;</span><span class="o">).</span><span class="n">lazyRead</span><span class="o">(</span> <span class="n">list</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="n">creatureReads</span><span class="o">)</span> <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;social&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span><span class="n">optional</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Creature</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Writes._</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">creatureWrites</span><span class="k">:</span> <span class="kt">Writes</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;email&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;favorites&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">(</span>
</span><span class='line'>      <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;string&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>      <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;number&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
</span><span class='line'>      <span class="n">tupled</span>
</span><span class='line'>  <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;friends&quot;</span><span class="o">).</span><span class="n">lazyWrite</span><span class="o">(</span><span class="nc">Writes</span><span class="o">.</span><span class="n">traversableWrites</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="n">creatureWrites</span><span class="o">))</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;social&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span>
</span><span class='line'><span class="o">)(</span><span class="n">unlift</span><span class="o">(</span><span class="nc">Creature</span><span class="o">.</span><span class="n">unapply</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, <code>creatureReads</code> and <code>creatureWrites</code> are not exactly symmetric and couldn&#8217;t be merged in one single <code>Format[Creature]</code> as done previously.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Json</span><span class="o">.</span><span class="n">fromJson</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">creature</span><span class="o">))</span> <span class="o">!=</span> <span class="n">creature</span>
</span></code></pre></td></tr></table></div></figure>


<p>Hopefully, as done previously, we can build a <code>Format[T]</code> from a <code>Reads[T]</code> and a <code>Writes[T]</code>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureFormat</span><span class="k">:</span> <span class="kt">Format</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Format</span><span class="o">(</span><span class="n">creatureReads</span><span class="o">,</span> <span class="n">creatureWrites</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Testing Serialization of Creature to Json</span>
</span><span class='line'><span class="k">val</span> <span class="n">gizmo</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mf">1.0F</span><span class="o">,</span> <span class="s">&quot;gizmo@midnight.com&quot;</span><span class="o">,</span> <span class="o">(</span><span class="s">&quot;alpha&quot;</span><span class="o">,</span> <span class="mi">85</span><span class="o">),</span> <span class="nc">List</span><span class="o">(),</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;@gizmo&quot;</span><span class="o">))</span>
</span><span class='line'><span class="k">val</span> <span class="n">zombie</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;zombie&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mf">100.0F</span><span class="o">,</span> <span class="s">&quot;shaun@dead.com&quot;</span><span class="o">,</span> <span class="o">(</span><span class="s">&quot;ain&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span> <span class="nc">List</span><span class="o">(</span><span class="n">gizmo</span><span class="o">),</span> <span class="nc">None</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">zombiejs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;zombie&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">100.0</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;email&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;shaun@dead.com&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;favorites&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>      <span class="s">&quot;string&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;ain&quot;</span><span class="o">,</span>
</span><span class='line'>      <span class="s">&quot;number&quot;</span> <span class="o">-&gt;</span> <span class="mi">2</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;friends&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span>
</span><span class='line'>      <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>          <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span>
</span><span class='line'>          <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">false</span><span class="o">,</span>
</span><span class='line'>          <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0</span><span class="o">,</span>
</span><span class='line'>          <span class="s">&quot;email&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gizmo@midnight.com&quot;</span><span class="o">,</span>
</span><span class='line'>          <span class="s">&quot;favorites&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>              <span class="s">&quot;string&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;alpha&quot;</span><span class="o">,</span>
</span><span class='line'>              <span class="s">&quot;number&quot;</span> <span class="o">-&gt;</span> <span class="mi">85</span>
</span><span class='line'>          <span class="o">),</span>
</span><span class='line'>          <span class="s">&quot;friends&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(),</span>
</span><span class='line'>          <span class="s">&quot;social&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;@gizmo&quot;</span>
</span><span class='line'>      <span class="o">)</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;social&quot;</span> <span class="o">-&gt;</span> <span class="nc">JsNull</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">assert</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">toJson</span><span class="o">(</span><span class="n">zombie</span><span class="o">)</span> <span class="o">==</span> <span class="n">zombiejs</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Testing Deserialization of JSON to Creature (note the dissymetric reading)</span>
</span><span class='line'><span class="k">val</span> <span class="n">gizmo2</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mf">1.0F</span><span class="o">,</span> <span class="s">&quot;gizmo@midnight.com&quot;</span><span class="o">,</span> <span class="o">(</span><span class="s">&quot;pha&quot;</span><span class="o">,</span> <span class="mi">85</span><span class="o">),</span> <span class="nc">List</span><span class="o">(),</span> <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;@gizmo&quot;</span><span class="o">))</span>
</span><span class='line'><span class="k">val</span> <span class="n">zombie2</span> <span class="k">=</span> <span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;zombie&quot;</span><span class="o">,</span> <span class="kc">true</span><span class="o">,</span> <span class="mf">100.0F</span><span class="o">,</span> <span class="s">&quot;shaun@dead.com&quot;</span><span class="o">,</span> <span class="o">(</span><span class="s">&quot;n&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">),</span> <span class="nc">List</span><span class="o">(</span><span class="n">gizmo2</span><span class="o">),</span> <span class="nc">None</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">assert</span><span class="o">(</span><span class="nc">Json</span><span class="o">.</span><span class="n">fromJson</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="n">zombiejs</span><span class="o">).</span><span class="n">get</span> <span class="o">==</span> <span class="n">zombie2</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h2><a name="conclusion">Conclusion &amp; much more…</a></h2>

<p>So here is the end of this 2nd part.</p>

<blockquote><p>Json combinator is cool!<br/>
Now what about transforming Json into Json???<br/>
Why would you need this?<br/>
Hmmm: why not receive JSON, validate/transform it, send it to a managing Json (Mongo for ex or others), read it again from the DB, modify it a bit and send it out…<br/>
Json &#8220;coast to coast&#8221; without any model class…</p></blockquote>

<p>Let&#8217;s tease a bit:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">jsonTransform</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key2&quot;</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pickBranch</span><span class="o">(</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key22&quot;</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key22&quot;</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pick</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">js</span> <span class="k">=&gt;</span> <span class="n">js</span> <span class="o">\</span> <span class="s">&quot;key221&quot;</span> <span class="o">)</span> <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key23&quot;</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">put</span><span class="o">(</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key23&quot;</span><span class="o">).</span><span class="n">json</span><span class="o">.</span><span class="n">pick</span><span class="o">.</span><span class="n">map</span><span class="o">{</span> <span class="k">case</span> <span class="nc">JsString</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="nc">JsString</span><span class="o">(</span><span class="n">s</span> <span class="o">+</span> <span class="s">&quot;123&quot;</span><span class="o">)</span> <span class="o">}</span> <span class="o">)</span>
</span><span class='line'>    <span class="n">reduce</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="n">reduce</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;key1&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;alpha&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key2&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;key22&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;key221&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;beta&quot;</span><span class="o">),</span> <span class="s">&quot;key23&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gamma&quot;</span><span class="o">),</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">assert</span><span class="o">(</span><span class="n">js</span><span class="o">.</span><span class="n">validate</span><span class="o">(</span><span class="n">jsonTransform</span><span class="o">),</span> <span class="nc">JsSuccess</span><span class="o">(</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;key1&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;alpha&quot;</span><span class="o">,</span> <span class="s">&quot;key2&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span> <span class="s">&quot;key22&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;beta&quot;</span><span class="o">,</span> <span class="s">&quot;key23&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gamma123&quot;</span> <span class="o">)</span> <span class="o">)</span> <span class="o">)</span> <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Next parts about Json generators/transformers ;)</p></blockquote>

<p>Have fun&#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2012/09/08/unveiling-play-2-dot-1-json-api-part1-jspath-reads-combinators/">Unveiling Play 2.1 Json API - Part 1 : JsPath & Reads Combinators</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-09-08T11:10:00+02:00" pubdate data-updated="true">Sep 8<span>th</span>, 2012</time>
        
         | <a href="/2012/09/08/unveiling-play-2-dot-1-json-api-part1-jspath-reads-combinators/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p><strong>Addendum: recent API refactoring (modified in the articled)</strong></p>

<ul>
<li><code>Reads[A] provided Reads[B]</code> has been renamed to <code>Reads[A] keepAnd Reads[B]</code></li>
<li><code>Reads[A] andThen Reads[B]</code> has been renamed to <code>Reads[A] andKeep Reads[B]</code></li>
</ul>
</blockquote>

<p>In incoming <code>Play2.1</code> version, a huge <strong>re-thinking</strong> has been done about <strong><code>JSON API</code> provided by <code>Play2.0.x</code></strong> which provides some great features but is clearly just the tip of the iceberg…<br/>
Here is a first presentation of those evolutions aimed at <strong>unleashing your JSON usage in Play2</strong> and <strong>revealing new forms of manipulation of web dataflows from/to external data systems</strong>. <br/>
A usecase of this is manipulating DB structures directly using Json without any class models for document oriented structures such as <a href="http://www.mongodb.org">MongoDB</a></p>

<blockquote><p>BTW Don&#8217;t forget the recent release of new MongoDB async/non-blocking driver <a href="http://reactivemongo.org">ReactiveMongo</a> ;-)</p></blockquote>

<div class="well">
<h3><a name="summary">Summary of main new features added in <code>Play2.1</code></a></h3>
<ul>
    <li><b>Simplified Json Objects/Arrays syntax</b> 
<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;key&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;value&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key2&quot;</span> <span class="o">-&gt;</span> <span class="mi">123</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key3&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="s">&quot;alpha&quot;</span><span class="o">,</span> <span class="mf">143.55</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
</li>
    <li><b><code>JsPath</code> for manipulating JSON in <code>XmlPath</code>-style</b> 
<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key&quot;</span> <span class="o">\</span> <span class="s">&quot;key2&quot;</span> <span class="o">\\</span> <span class="s">&quot;key3&quot;</span><span class="o">)(</span><span class="mi">3</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
</li>
    <li><b><code>Reads[T]</code> / <code>Writes[T]</code> / <code>Format[T]</code> combinators</b> based on JsPath and simple logic operators</b>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">customReads</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Float</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])]</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="n">email</span> <span class="n">keepAnd</span> <span class="n">minLength</span><span class="o">(</span><span class="mi">5</span><span class="o">))</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">JsPath</span><span class="err"> </span><span class="o">\</span> <span class="s">&quot;key2&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">](</span><span class="n">min</span><span class="o">(</span><span class="mi">45</span><span class="o">))</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">JsPath</span><span class="err"> </span><span class="o">\</span> <span class="s">&quot;key3&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span>
</span><span class='line'>  <span class="n">tupled</span>
</span></code></pre></td></tr></table></div></figure>

    </li>
    <li><b><code>Reads[T]</code> API now validates JSON</b> by returning a monadic <code>JsResult[T]</code> being a <code>JsSuccess[T]</code> or a <code>JsError</code> aggregating all validation errors 
<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;key1&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;alpha&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key2&quot;</span> <span class="o">-&gt;</span> <span class="mf">123.345F</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key3&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="s">&quot;alpha&quot;</span><span class="o">,</span> <span class="s">&quot;beta&quot;</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">customReads</span><span class="o">.</span><span class="n">reads</span><span class="o">(</span><span class="n">js</span><span class="o">)</span>
</span><span class='line'><span class="n">res5</span><span class="k">:</span> <span class="kt">JsSuccess</span><span class="o">((</span><span class="err">&quot;</span><span class="kt">alpha</span><span class="err">&quot;</span><span class="o">,</span> <span class="err">123</span><span class="kt">.</span><span class="err">345</span><span class="kt">F</span><span class="o">,</span> <span class="kt">List</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">alpha</span><span class="err">&quot;</span><span class="o">,</span> <span class="err">&quot;</span><span class="kt">beta</span><span class="err">&quot;</span><span class="o">)))</span>
</span><span class='line'>
</span><span class='line'><span class="n">customReads</span><span class="o">.</span><span class="n">reads</span><span class="o">(</span><span class="n">js</span><span class="o">).</span><span class="n">fold</span><span class="o">(</span>
</span><span class='line'>  <span class="n">valid</span> <span class="k">=</span> <span class="o">{</span> <span class="n">res</span> <span class="k">=&gt;</span>
</span><span class='line'>    <span class="k">val</span> <span class="o">(</span><span class="n">s</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">l</span><span class="o">)</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Float</span><span class="o">,</span> <span class="nc">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span> <span class="k">=</span> <span class="n">res</span>
</span><span class='line'>    <span class="o">...</span>
</span><span class='line'>  <span class="o">},</span>
</span><span class='line'>  <span class="n">invalid</span> <span class="k">=</span> <span class="o">{</span> <span class="n">errors</span> <span class="k">=&gt;</span> <span class="o">...</span> <span class="o">}</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>
    
    </li>
</ul>
</div>


<p><strong>Now let&#8217;s go in the details ;)</strong></p>

<br/>


<br/>


<h1><a name="quick-json-syntax">Very Quick Json syntax</a></h1>

<p>Concerning the new Json syntax, I won&#8217;t spend time on this, it&#8217;s quite explicit and you can try it very easily by yourself.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;key1&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;value1&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key2&quot;</span> <span class="o">-&gt;</span> <span class="mi">234</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;key3&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>    <span class="s">&quot;key31&quot;</span> <span class="o">-&gt;</span> <span class="kc">true</span><span class="o">,</span>
</span><span class='line'>    <span class="s">&quot;key32&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span><span class="s">&quot;alpha&quot;</span><span class="o">,</span> <span class="s">&quot;beta&quot;</span><span class="o">,</span> <span class="mf">234.13</span><span class="o">),</span>
</span><span class='line'>    <span class="s">&quot;key33&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;key1&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;value2&quot;</span><span class="o">,</span> <span class="s">&quot;key34&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;value34&quot;</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h1><a name="quick-jspath">Quick JsPath</a></h1>

<p>You certainly know <code>XMLPath</code> in which you can access a node of an XML AST using a simple syntax based on path.<br/>
JSON is already an AST and we can apply the same kind of syntax to it and logically we called it <code>JsPath</code>.</p>

<p>All following examples use JSON defined in previous paragraph.</p>

<h3>Building JsPath</h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Simple path</span>
</span><span class='line'><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2-levels path</span>
</span><span class='line'><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key3&quot;</span> <span class="o">\</span> <span class="s">&quot;key33&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// indexed path</span>
</span><span class='line'><span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key3&quot;</span> <span class="o">\</span> <span class="s">&quot;key32&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="c1">// 2nd element in a JsArray</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// multiple paths</span>
</span><span class='line'><span class="nc">JsPath</span> <span class="o">\\</span> <span class="s">&quot;key1&quot;</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Alternative syntax</h3>

<p><code>JsPath</code> is quite cool but we found this syntax could be made even clearer to highlight <code>Reads[T]</code> combinators in the code.<br/>
That&#8217;s why we provide an alias for <code>JsPath</code>: <code>__</code> (2 underscores).<br/>
<em>You can use it or not. This is just a visual facility because with it, you immediately find your JsPath in the code…</em></p>

<p>You can write:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Simple path</span>
</span><span class='line'><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2-levels path</span>
</span><span class='line'><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key3&quot;</span> <span class="o">\</span> <span class="s">&quot;key33&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// indexed path</span>
</span><span class='line'><span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key3&quot;</span> <span class="o">\</span> <span class="s">&quot;key32&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)</span> <span class="c1">// 2nd element in a JsArray</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// multiple paths</span>
</span><span class='line'><span class="nc">__</span> <span class="o">\\</span> <span class="s">&quot;key1&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// a sample on Reads[T] combinators to show the difference with both syntax</span>
</span><span class='line'><span class="c1">// DON&#39;T TRY TO UNDERSTAND THIS CODE RIGHT NOW… It&#39;s explained in next paragraphs</span>
</span><span class='line'><span class="k">val</span> <span class="n">customReads</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key11&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key11&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key11&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</span><span class='line'>    <span class="n">tupled</span>
</span><span class='line'>  <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">JsPath</span><span class="err"> </span><span class="o">\</span> <span class="s">&quot;key2&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">](</span><span class="n">min</span><span class="o">(</span><span class="mi">45</span><span class="o">))</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">JsPath</span><span class="err"> </span><span class="o">\</span> <span class="s">&quot;key3&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key31&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key32&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">JsPath</span> <span class="o">\</span> <span class="s">&quot;key33&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</span><span class='line'>    <span class="n">tupled</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>  <span class="n">tupled</span>
</span><span class='line'>  
</span><span class='line'><span class="c1">// with __</span>
</span><span class='line'><span class="k">val</span> <span class="n">customReads</span> <span class="k">=</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key11&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key11&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key11&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</span><span class='line'>    <span class="n">tupled</span>
</span><span class='line'>  <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span><span class="err"> </span><span class="o">\</span> <span class="s">&quot;key2&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">](</span><span class="n">min</span><span class="o">(</span><span class="mi">45</span><span class="o">))</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span><span class="err"> </span><span class="o">\</span> <span class="s">&quot;key3&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="o">(</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key31&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key32&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>    <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key33&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</span><span class='line'>    <span class="n">tupled</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'>  <span class="n">tupled</span>
</span><span class='line'>  
</span><span class='line'><span class="c1">// You can immediately see the structure of the JSON tree</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Accessing value of JsPath</h3>

<p>The important function to retrieve the value at a given JsPath in a JsValue is the following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">sealed</span> <span class="k">trait</span> <span class="nc">PathNode</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">apply</span><span class="o">(</span><span class="n">json</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">JsValue</span><span class="o">]</span>
</span><span class='line'>  <span class="err">…</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>As you can see, this function retrieves a <code>List[JsValue]</code></p>

<p>You can simply use it like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// build a JsPath</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key1&quot;</span><span class="o">)(</span><span class="n">js</span><span class="o">)</span>
</span><span class='line'><span class="n">res12</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">play.api.libs.json.JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;value1&quot;</span><span class="o">)</span>  <span class="c1">// actually this is JsString(&quot;value1&quot;)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// 2-levels path</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key3&quot;</span> <span class="o">\</span> <span class="s">&quot;key33&quot;</span><span class="o">)(</span><span class="n">js</span><span class="o">)</span>
</span><span class='line'><span class="n">res13</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">play.api.libs.json.JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">({</span><span class="s">&quot;key&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">value2</span><span class="err">&quot;</span><span class="o">,</span><span class="s">&quot;key34&quot;</span><span class="k">:</span><span class="err">&quot;</span><span class="kt">value34</span><span class="err">&quot;</span><span class="o">})</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// indexed path</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;key3&quot;</span> <span class="o">\</span> <span class="s">&quot;key32&quot;</span><span class="o">)(</span><span class="mi">2</span><span class="o">)(</span><span class="n">js</span><span class="o">)</span>
</span><span class='line'><span class="n">res14</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">play.api.libs.json.JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mf">234.13</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// multiple paths</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="o">(</span><span class="nc">__</span> <span class="o">\\</span> <span class="s">&quot;key1&quot;</span><span class="o">)(</span><span class="n">js</span><span class="o">)</span>
</span><span class='line'><span class="n">res17</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">play.api.libs.json.JsValue</span><span class="o">]</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="s">&quot;value1&quot;</span><span class="o">,</span> <span class="s">&quot;value2&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h1><a name="reads">Reads[T] is now a validator</a></h1>

<h2><a name="reads-2_0">Reads in Play2.0.x</a></h2>

<p>Do you remember how you had to write a Json <code>Reads[T]</code> in <code>Play2.0.x</code> ?<br/>
You had to override the <code>reads</code> function.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Reads</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">self</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Convert the JsValue into a A</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">json</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">A</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Take the following simple case class that you want to map on JSON structure:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Creature</span><span class="o">(</span>
</span><span class='line'>  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>  <span class="n">isDead</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
</span><span class='line'>  <span class="n">weight</span><span class="k">:</span> <span class="kt">Float</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>In <code>Play2.0.x</code>, you would write your reader as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureReads</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Reads</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">js</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">Creature</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="nc">Creature</span><span class="o">(</span>
</span><span class='line'>      <span class="o">(</span><span class="n">js</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">String</span><span class="o">],</span>
</span><span class='line'>      <span class="o">(</span><span class="n">js</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">],</span>
</span><span class='line'>      <span class="o">(</span><span class="n">js</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">as</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'>    <span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">false</span><span class="o">,</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0F</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">c</span> <span class="k">=</span> <span class="n">js</span><span class="o">.</span><span class="n">as</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span><span class='line'><span class="n">c</span><span class="k">:</span> <span class="kt">Creature</span><span class="o">(</span><span class="err">&quot;</span><span class="kt">gremlins</span><span class="err">&quot;</span><span class="o">,</span> <span class="kt">false</span><span class="o">,</span> <span class="mf">1.0F</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Easy isn&#8217;t it ?
So what&#8217;s the problem if it&#8217;s so easy?</p>

<p>Imagine, you pass the following JSON with a missing field:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0F</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>What happens?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">java</span><span class="o">.</span><span class="n">lang</span><span class="o">.</span><span class="nc">RuntimeException</span><span class="k">:</span> <span class="kt">Boolean</span> <span class="kt">expected</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="nc">DefaultReads$BooleanReads</span><span class="n">$</span><span class="o">.</span><span class="n">reads</span><span class="o">(</span><span class="nc">Reads</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">98</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="nc">DefaultReads$BooleanReads</span><span class="n">$</span><span class="o">.</span><span class="n">reads</span><span class="o">(</span><span class="nc">Reads</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">95</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="nc">JsValue$class</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="nc">JsValue</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">56</span><span class="o">)</span>
</span><span class='line'>  <span class="n">at</span> <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">json</span><span class="o">.</span><span class="nc">JsUndefined</span><span class="o">.</span><span class="n">as</span><span class="o">(</span><span class="nc">JsValue</span><span class="o">.</span><span class="n">scala</span><span class="k">:</span><span class="err">70</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>WHATTTTTTT????</strong>
Yes ugly RuntimeException (not even subtyped) but you can work around it using <code>JsValue.asOpt[T]</code> :)</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">c</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="n">js</span><span class="o">.</span><span class="n">asOpt</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span><span class='line'><span class="n">c</span><span class="k">:</span> <span class="kt">None</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Cool but you only know that the deserialization <code>Json =&gt; Creature</code> failed but not where or on which field(s)?</strong></p>

<br/>


<br/>


<h2><a name="reads-2_1">Reads in Play2.1</a></h2>

<p>We couldn&#8217;t keep this imperfect API as is and in <code>Play2.1</code>, the <code>Reads[T]</code> API has changed into :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Reads</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">self</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="cm">/**</span>
</span><span class='line'><span class="cm">   * Convert the JsValue into a A</span>
</span><span class='line'><span class="cm">   */</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">json</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsResult</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Yes you have to refactor all your existing custom Reads but you&#8217;ll see you&#8217;ll get lots of new interesting features…</p></blockquote>

<p>So you remark immediately <code>JsResult[A]</code> which is a very simple structure looking a bit like an Either applied to our specific problem.</p>

<p><strong><code>JsResult[A]</code> can be of 2 types</strong>:</p>

<ul>
<li><strong><code>JsSuccess[A]</code> when <code>reads</code>succeeds</strong></li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">JsSuccess</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span>
</span><span class='line'>  <span class="n">value</span><span class="k">:</span> <span class="kt">T</span><span class="o">,</span> <span class="c1">// the value retrieved when deserialization JsValue =&gt; A worked</span>
</span><span class='line'>  <span class="n">path</span><span class="k">:</span> <span class="kt">JsPath</span> <span class="o">=</span> <span class="nc">JsPath</span><span class="o">()</span> <span class="c1">// the root JsPath where this A was read in the JsValue (by default, it&#39;s the root of the JsValue)</span>
</span><span class='line'><span class="o">)</span> <span class="k">extends</span> <span class="nc">JsResult</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// To create a JsSuccess from a value, simply do:</span>
</span><span class='line'><span class="k">val</span> <span class="n">success</span> <span class="k">=</span> <span class="nc">JsSuccess</span><span class="o">(</span><span class="nc">Creature</span><span class="o">(</span><span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="kc">false</span><span class="o">,</span> <span class="mf">1.0</span><span class="o">))</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><strong><code>JsError[A]</code> when <code>reads</code> fails</strong></li>
</ul>


<blockquote><p>Please note the greatest advantage of JsError is that it&#8217;s a cumulative error which can store several errors discovered in the Json at different JsPath</p></blockquote>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">JsError</span><span class="o">(</span>
</span><span class='line'>  <span class="n">errors</span><span class="k">:</span> <span class="kt">Seq</span><span class="o">[(</span><span class="kt">JsPath</span>, <span class="kt">Seq</span><span class="o">[</span><span class="kt">ValidationError</span><span class="o">])]</span>
</span><span class='line'>  <span class="c1">// the errors is a sequence of JsPath locating the path </span>
</span><span class='line'>  <span class="c1">// where there was an error in the JsValue and validation </span>
</span><span class='line'>  <span class="c1">// errors for this path</span>
</span><span class='line'><span class="o">)</span> <span class="k">extends</span> <span class="nc">JsResult</span><span class="o">[</span><span class="kt">Nothing</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// ValidationError is a simple message with arguments (which can be mapped on localized messages)</span>
</span><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">ValidationError</span><span class="o">(</span><span class="n">message</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">args</span><span class="k">:</span> <span class="kt">Any*</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// To create a JsError, there are a few helpers and for ex:</span>
</span><span class='line'><span class="k">val</span> <span class="n">errors1</span> <span class="k">=</span> <span class="nc">JsError</span><span class="o">(</span> <span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;isDead</span><span class="o">,</span> <span class="nc">ValidationError</span><span class="o">(</span><span class="s">&quot;validate.error.missing&quot;</span><span class="o">,</span> <span class="s">&quot;isDead&quot;</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">errors2</span> <span class="k">=</span> <span class="nc">JsError</span><span class="o">(</span> <span class="nc">__</span> <span class="o">\</span> <span class="-Symbol">&#39;name</span><span class="o">,</span> <span class="nc">ValidationError</span><span class="o">(</span><span class="s">&quot;validate.error.missing&quot;</span><span class="o">,</span> <span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Errors are cumulative which is really interesting</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">errors</span> <span class="k">=</span> <span class="n">errors1</span> <span class="o">++</span> <span class="n">errors2</span>
</span><span class='line'><span class="n">errors</span><span class="k">:</span> <span class="kt">JsError</span><span class="o">(</span><span class="kt">List</span><span class="o">((</span><span class="kt">/isDead</span><span class="o">,</span><span class="kt">List</span><span class="o">(</span><span class="kt">ValidationError</span><span class="o">(</span><span class="kt">validate.error.missing</span><span class="o">,</span><span class="kt">WrappedArray</span><span class="o">(</span><span class="kt">isDead</span><span class="o">)))),</span> <span class="o">(/</span><span class="n">name</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">validate</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">missing</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="n">name</span><span class="o">))))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>So what&#8217;s interesting there is that <code>JsResult[A]</code> is a monadic structure and can be used with classic functions of such structures:</p>

<ul>
<li><code>flatMap[X](f: A =&gt; JsResult[X]): JsResult[X]</code></li>
<li><code>fold[X](invalid: Seq[(JsPath, Seq[ValidationError])] =&gt; X, valid: A =&gt; X)</code></li>
<li><code>map[X](f: A =&gt; X): JsResult[X]</code></li>
<li><code>filter(p: A =&gt; Boolean)</code></li>
<li><code>collect[B](otherwise:ValidationError)(p:PartialFunction[A,B]): JsResult[B]</code></li>
<li><code>get: A</code></li>
</ul>


<p>And some sugar such :</p>

<ul>
<li><code>asOpt</code></li>
<li><code>asEither</code></li>
<li>…</li>
</ul>


<h3>Reads[A] has become a validator</h3>

<p>As you may understand, using the new <code>Reads[A]</code>, you don&#8217;t only deserialize a JsValue into another structure but you really <strong>validate</strong> the JsValue and retrieve all the validation errors.<br/>
BTW, in <code>JsValue</code>, a new function called <code>validate</code> has appeared:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">JsValue</span> <span class="o">{</span>
</span><span class='line'><span class="err">…</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">validate</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="k">implicit</span> <span class="nc">_reads</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">JsResult</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="nc">_reads</span><span class="o">.</span><span class="n">reads</span><span class="o">(</span><span class="k">this</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// same behavior but it throws a specific RuntimeException JsResultException now</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">as</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="k">implicit</span> <span class="n">fjs</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">T</span>
</span><span class='line'>  <span class="c1">// exactly the same behavior has before</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">asOpt</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="k">implicit</span> <span class="n">fjs</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span>
</span><span class='line'><span class="err">…</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// You can now write if you got the right implicit in your scope</span>
</span><span class='line'><span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">JsResult</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="n">js</span><span class="o">.</span><span class="n">validate</span><span class="o">[</span><span class="kt">Creature</span><span class="o">])</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h3>Manipulating a JsResult[A]</h3>

<p>So when manipulating a <code>JsResult</code>, you don&#8217;t access the value directly and it&#8217;s preferable to use <code>map/flatmap/fold</code> to modify the value.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">JsResult</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="n">js</span><span class="o">.</span><span class="n">validate</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// managing the success/error and potentially return something</span>
</span><span class='line'><span class="n">res</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span>
</span><span class='line'>  <span class="n">valid</span> <span class="k">=</span> <span class="o">{</span> <span class="n">c</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span> <span class="n">c</span> <span class="o">);</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">},</span>
</span><span class='line'>  <span class="n">invalid</span> <span class="k">=</span> <span class="o">{</span> <span class="n">e</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span> <span class="n">e</span> <span class="o">);</span> <span class="n">e</span> <span class="o">}</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// getting the name directly (using the get can throw a NoSuchElementException if it&#39;s a JsError)</span>
</span><span class='line'><span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">JsSuccess</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">res</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="n">creature</span> <span class="k">=&gt;</span> <span class="n">creature</span><span class="o">.</span><span class="n">name</span> <span class="o">).</span><span class="n">get</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// filtering the result</span>
</span><span class='line'><span class="k">val</span> <span class="n">name</span><span class="k">:</span> <span class="kt">JsSuccess</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">res</span><span class="o">.</span><span class="n">filter</span><span class="o">(</span> <span class="n">creature</span> <span class="k">=&gt;</span> <span class="n">creature</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">&quot;gremlins&quot;</span> <span class="o">).</span><span class="n">get</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// a classic Play action</span>
</span><span class='line'><span class="k">def</span> <span class="n">getNameOnly</span> <span class="k">=</span> <span class="nc">Action</span><span class="o">(</span><span class="n">parse</span><span class="o">.</span><span class="n">json</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">json</span> <span class="k">=</span> <span class="n">request</span><span class="o">.</span><span class="n">body</span>
</span><span class='line'>  <span class="n">json</span><span class="o">.</span><span class="n">validate</span><span class="o">[</span><span class="kt">Creature</span><span class="o">].</span><span class="n">fold</span><span class="o">(</span>
</span><span class='line'>    <span class="n">valid</span> <span class="k">=</span> <span class="o">(</span> <span class="n">res</span> <span class="k">=&gt;</span> <span class="nc">Ok</span><span class="o">(</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="o">)</span> <span class="o">),</span>
</span><span class='line'>    <span class="n">invalid</span> <span class="k">=</span> <span class="o">(</span> <span class="n">e</span> <span class="k">=&gt;</span> <span class="nc">BadRequest</span><span class="o">(</span><span class="n">e</span><span class="o">.</span><span class="n">toString</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h3>Rewriting the Reads[T] with JsResult[A]</h3>

<p>The <code>Reads[A]</code> API returning a JsResult, you can&#8217;t write your <code>Reads[A]</code> as before as you must return a JsResult gathering all found errors.<br/>
You could imagine simply compose Reads[T] with flatMap :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// DO NOT USE, WRONG CODE</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureReads</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Reads</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">reads</span><span class="o">(</span><span class="n">js</span><span class="k">:</span> <span class="kt">JsValue</span><span class="o">)</span><span class="k">:</span> <span class="kt">JsResult</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="o">(</span><span class="n">js</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">validate</span><span class="o">[</span><span class="kt">String</span><span class="o">].</span><span class="n">flatMap</span><span class="o">{</span> <span class="n">name</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="o">(</span><span class="n">js</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">validate</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">].</span><span class="n">flatMap</span> <span class="o">{</span> <span class="n">isDead</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="o">(</span><span class="n">js</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">validate</span><span class="o">[</span><span class="kt">Float</span><span class="o">].</span><span class="n">map</span> <span class="o">{</span> <span class="n">weight</span> <span class="k">=&gt;</span>
</span><span class='line'>        <span class="nc">Creature</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">isDead</span><span class="o">,</span> <span class="n">weight</span><span class="o">)</span>
</span><span class='line'>      <span class="o">}</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Remember the main purpose of <code>JsResult</code> is to gather all found errors while validating the JsValue.</p></blockquote>

<p><code>JsResult.flatMap</code> is pure monadic function (if you don&#8217;t know what it is, don&#8217;t care about it, you can understand without it) implying that the function that you pass to <code>flatMap()</code> is called only if the result is a <code>JsSuccess</code> else it just returns the <code>JsError</code>.<br/>
This means the previous code won&#8217;t aggregate all errors found during validation and will stop at first error which is exactly what we don&#8217;t want.</p>

<p>Actually, Monad pattern is not good in our case because we are not just composing Reads but we expect combining them following the schema:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Reads</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="nc">AND</span> <span class="nc">Reads</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="nc">AND</span> <span class="nc">Reads</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'>  <span class="k">=&gt;</span> <span class="nc">Reads</span><span class="o">[(</span><span class="kt">String</span>, <span class="kt">Boolean</span>, <span class="kt">Float</span><span class="o">)]</span>
</span><span class='line'>     <span class="k">=&gt;</span> <span class="nc">Reads</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>So we need something else to be able to combine our Reads and this is the greatest new feature that <code>Play2.1</code> brings for JSON :<br/>
<strong>THE READS combinators with JsPath</strong></p></blockquote>

<br/>


<blockquote><p>If you want more theoretical aspects about the way it was implemented based on generic functional structures adapted to our needs, you can read this post <a href="http://sadache.tumblr.com/post/30955704987/applicatives-are-too-restrictive-breaking-applicativesfrom">&#8220;Applicatives are too restrictive, breaking Applicatives and introducing Functional Builders&#8221;</a> written by <a href="http://www.github.com/sadache">@sadache</a></p></blockquote>

<h3>Rewriting the Reads[T] with combinators</h3>

<p>Go directly to the example as practice is often the best :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// IMPORTANT import this to have the required tools in your scope</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.util._</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureReads</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Creature</span><span class="o">.</span><span class="n">apply</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// or in a simpler way as case class has a companion object with an apply function</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureReads</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Creature</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// or using the operators inspired by Scala parser combinators for those who know them</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureReads</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="o">~</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="o">~</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Creature</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>So there is nothing quite complicated, isn&#8217;t it?</p>

<h5><code>(__ \ "name")</code> is the <code>JsPath</code> where you gonna apply <code>read[String]</code></h5>

<br/>


<h5><code>and</code> is just an operator meaning <code>Reads[A] and Reads[B] =&gt; Builder[Reads[A ~ B]]</code></h5>

<ul>
<li><code>A ~ B</code> just means <code>Combine A and B</code> but it doesn&#8217;t suppose the way it is combined (can be a tuple, an object, whatever…)</li>
<li><code>Builder</code> is not a real type but I introduce it just to tell that the operator <code>and</code> doesn&#8217;t create directly a <code>Reads[A ~ B]</code> but an intermediate structure that is able to build a <code>Reads[A ~ B]</code> or to combine with another <code>Reads[C]</code></li>
</ul>


<br/>   


<h5><code>(…)(Creature)</code> builds a <code>Reads[Creature]</code></h5>

<ul>
<li><code>(__ \ "name").read[String] and (__ \ "isDead").read[Boolean] and (__ \ "weight").read[Float]</code> builds a <code>Builder[Reads[String ~ Boolean ~ Float])]</code> but you want a <code>Reads[Creature]</code>.</li>
<li>So you apply the <code>Builder[Reads[String ~ Boolean ~ String])]</code> to the function <code>Creature.apply = (String, Boolean, Float) =&gt; Creature</code> constructor to finally obtain a <code>Reads[Creature]</code></li>
</ul>


<p>Try it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">false</span><span class="o">,</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0F</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span><span class="o">.</span><span class="n">validate</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span><span class='line'><span class="n">res1</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">JsSuccess</span><span class="o">(</span><span class="nc">Creature</span><span class="o">(</span><span class="n">gremlins</span><span class="o">,</span><span class="kc">false</span><span class="o">,</span><span class="mf">1.0</span><span class="o">),)</span> <span class="c1">// nothing after last comma because the JsPath is ROOT by default</span>
</span></code></pre></td></tr></table></div></figure>


<p>Now what happens if you have an error now?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">js</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span> <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0F</span><span class="o">)</span>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">js</span><span class="o">.</span><span class="n">validate</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span><span class='line'><span class="n">res2</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">JsError</span><span class="o">(</span><span class="nc">List</span><span class="o">((/</span><span class="n">isDead</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">validate</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">missing</span><span class="o">-</span><span class="n">path</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">())))))</span>
</span></code></pre></td></tr></table></div></figure>


<p>Explicit, isn&#8217;t it?</p>

<h3>Complexifying the case</h3>

<p>Ok, I see what you think : what about more complex cases where you have several constraints on a field and embedded Json in Json and recursive classes and whatever…</p>

<p>Let&#8217;s imagine our creature:</p>

<ul>
<li>is a relatively modern creature having an email and hating email addresses having less than 5 characters for a reason only known by the creature itself.</li>
<li>may have 2 favorites data:

<ul>
<li>1 String (called &#8220;string&#8221; in JSON) which shall not be &#8220;ni&#8221; (because it loves Monty Python too much to accept this) and then to skip the first 2 chars</li>
<li>1 Int (called &#8220;number&#8221; in JSON) which can be less than 86 or more than 875 (don&#8217;t ask why, this is creature with a different logic than ours)</li>
</ul>
</li>
<li>may have friend creatures</li>
<li>may have an optional social account because many creatures are not very social so this is quite mandatory</li>
</ul>


<p>Now the class looks like:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">case</span> <span class="k">class</span> <span class="nc">Creature</span><span class="o">(</span>
</span><span class='line'>  <span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
</span><span class='line'>  <span class="n">isDead</span><span class="k">:</span> <span class="kt">Boolean</span><span class="o">,</span>
</span><span class='line'>  <span class="n">weight</span><span class="k">:</span> <span class="kt">Float</span><span class="o">,</span>
</span><span class='line'>  <span class="n">email</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="c1">// email format and minLength(5)</span>
</span><span class='line'>  <span class="n">favorites</span><span class="k">:</span> <span class="o">(</span><span class="kt">String</span><span class="o">,</span> <span class="kt">Int</span><span class="o">),</span> <span class="c1">// the stupid favorites</span>
</span><span class='line'>  <span class="n">friends</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Nil</span><span class="o">,</span> <span class="c1">// yes by default it has no friend</span>
</span><span class='line'>  <span class="n">social</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">None</span> <span class="c1">// by default, it&#39;s not social</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p><code>Play2.1</code> provide lots of generic Reads helpers:</p>

<ul>
<li><code>JsPath.read[A](implicit reads:Reads[A])</code> can be passed a custom <code>Reads[A]</code> which is applied to the JSON content at this JsPath. So with this property, you can compose hierarchically <code>Reads[T]</code> which corresponds to JSON tree structure.</li>
<li><code>JsPath.readOpt</code> allows <code>Reads[Option[T]]</code></li>
<li><code>Reads.email</code> which validates the String has email format</li>
<li><code>Reads.minLength(nb)</code> validates the minimum length of a String</li>
<li><code>Reads[A] or Reads[A] =&gt; Reads[A]</code> operator is a classic <code>OR</code> logic operator</li>
<li><code>Reads[A] keepAnd Reads[B] =&gt; Reads[A]</code> is an operator that tries <code>Reads[A]</code> and <code>Reads[B]</code> but only keeps the result of <code>Reads[A]</code> (For those who know Scala parser combinators <code>keepAnd == &lt;~</code> )</li>
<li><code>Reads[A] andKeep Reads[B] =&gt; Reads[B]</code> is an operator that tries <code>Reads[A]</code> and <code>Reads[B]</code> but only keeps the result of <code>Reads[B]</code> (For those who know Scala parser combinators <code>andKeep == ~&gt;</code> )</li>
</ul>


<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// import just Reads helpers in scope</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.util._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.libs.json.Reads._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">play.api.data.validation.ValidationError</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// defines a custom reads to be reused</span>
</span><span class='line'><span class="c1">// a reads that verifies your value is not equal to a give value</span>
</span><span class='line'><span class="k">def</span> <span class="n">notEqualReads</span><span class="o">[</span><span class="kt">T</span><span class="o">](</span><span class="n">v</span><span class="k">:</span> <span class="kt">T</span><span class="o">)(</span><span class="k">implicit</span> <span class="n">r</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">T</span><span class="o">])</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">T</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Reads</span><span class="o">.</span><span class="n">filterNot</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="s">&quot;validate.error.unexpected.value&quot;</span><span class="o">,</span> <span class="n">v</span><span class="o">))(</span> <span class="k">_</span> <span class="o">==</span> <span class="n">v</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">def</span> <span class="n">skipReads</span><span class="o">(</span><span class="k">implicit</span> <span class="n">r</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">r</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">substring</span><span class="o">(</span><span class="mi">2</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureReads</span><span class="k">:</span> <span class="kt">Reads</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;email&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span><span class="n">email</span> <span class="n">keepAnd</span> <span class="n">minLength</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span><span class="mi">5</span><span class="o">))</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;favorites&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">(</span>
</span><span class='line'>      <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;string&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">String</span><span class="o">](</span> <span class="n">notEqualReads</span><span class="o">(</span><span class="s">&quot;ni&quot;</span><span class="o">)</span> <span class="n">andKeep</span> <span class="n">skipReads</span> <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>      <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;number&quot;</span><span class="o">).</span><span class="n">read</span><span class="o">[</span><span class="kt">Int</span><span class="o">](</span> <span class="n">max</span><span class="o">(</span><span class="mi">86</span><span class="o">)</span> <span class="n">or</span> <span class="n">min</span><span class="o">(</span><span class="mi">875</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'>      <span class="n">tupled</span>
</span><span class='line'>  <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;friends&quot;</span><span class="o">).</span><span class="n">lazyRead</span><span class="o">(</span> <span class="n">list</span><span class="o">[</span><span class="kt">Creature</span><span class="o">](</span><span class="n">creatureReads</span><span class="o">)</span> <span class="o">)</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;social&quot;</span><span class="o">).</span><span class="n">readOpt</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Creature</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Many things above can be understood very logically but let&#8217;s explain a bit:</p>

<h5><code>(__ \ "email").read(email keepAnd minLength[String](5))</code></h5>

<ul>
<li>As explained previously, <code>(__ \ "email").read(…)</code> applies the <code>Reads[T]</code> passed in parameter to function <code>read</code> at the given JsPath <code>(__ \ "email")</code></li>
<li><code>email keepAnd minLength[String](5) =&gt; Reads[String]</code> is a Js validator that verifies JsValue:

<ol>
<li>is a String : <code>email: Reads[String]</code> so no need to specify type here</li>
<li>has email format</li>
<li>has min length of 5 (we precise the type here because minLength is a generic <code>Reads[T]</code>)</li>
</ol>
</li>
<li>Why not <code>email and minLength[String](5)</code>? because, as explained previously, it would generate a <code>Builder[Reads[(String, String)]]</code> whereas you expect a <code>Reads[String]</code>. The <code>keepAnd</code> operator (aka <code>&lt;~</code>) does what we expect: it validates both sides but if succeeded, it keeps only the result on left side.</li>
</ul>


<br/>


<h5><code>notEqualReads("ni") andKeep skipReads</code></h5>

<ul>
<li>No need to write <code>notEqualReads[String]("ni")</code> because <code>String</code> type is inferred from <code>(__ \ "knight").read[String]</code> (the power of Scala typing engine)</li>
<li><code>skipReads</code> is a customReads that skips the first 2 chars</li>
<li><code>andKeep</code> operator (aka <code>~&gt;</code>) is simple to undestand : it validates the left and right side and if both succeeds, only keeps the result on right side. In our case, only the result of <code>skipReads</code> is kept and not the result of <code>notEqualReads</code>.</li>
</ul>


<br/>


<h5><code>max(86) or min(875)</code></h5>

<ul>
<li>Nothing to explain there, isn&#8217;t it ? <code>or</code> is the classic <code>OR</code>logic operator, nothing else</li>
</ul>


<br/>


<h5><code>(__ \ "favorites").read(…)</code></h5>

<pre><code>(__ \ "string").read[String]( notEqualReads("ni") andKeep notEqualReads("swallow") ) and
(__ \ "number").read[Int]( max(86) or min(875) )
tupled
</code></pre>

<ul>
<li>Remember that <code>(__ \ "string").read[String](…) and (__ \ "number").read[Int](…) =&gt; Builder[Reads[(String, Int)]]</code></li>
<li>What means <code>tupled</code> ?
<code>Builder[Reads[(String, Int)]]</code> can be used with a case class <code>apply</code> function to build the <code>Reads[Creature]</code> for ex. But it provides also <code>tupled</code> which is quite easy to understand : it <em>&#8220;tuplizes&#8221;</em> your Builder: <code>Builder[Reads[(A, B)]].tupled =&gt; Reads[(A, B)]</code></li>
<li>Finally <code>(__ \ "favorites").read(Reads[(String, Int)]</code> will validate a <code>(String, Int)</code> which is the expected type for field <code>favorites</code></li>
</ul>


<br/>


<h5><code>(__ \ "friend").lazyRead( list[Creature](creatureReads) )</code></h5>

<p>This is the most complicated line in this code. But you can understand why: the <code>friend</code> field is recursive on the <code>Creature</code> class itself so it requires a special treatment.</p>

<ul>
<li><code>list[Creature](…)</code> creates a <code>Reads[List[Creature]]</code></li>
<li><code>list[Creature](creatureReads)</code> passes explicitly <code>creatureReads</code> as an argument because it&#8217;s recursive and Scala requires that to resolve it. Nothing too complicated…</li>
<li><code>(__ \ "friend").lazyRead[A](r: =&gt; Reads[A]))</code> : <code>lazyRead</code> expects a <code>Reads[A]</code> value <em>passed by name</em> to allow the type recursive construction. This is the only refinement that you must keep in mind in this very special recursive case.</li>
</ul>


<br/>


<h5><code>(__ \ "social").readOpt[String]</code></h5>

<p>Nothing quite complicated to understand: we need to read an option and <code>readOpt</code> helps in doing this.</p>

<p>Now we can use this <code>Reads[Creature]</code></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">gizmojs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0F</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;email&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gizmo@midnight.com&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;favorites&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;string&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;alpha&quot;</span><span class="o">,</span> <span class="s">&quot;number&quot;</span> <span class="o">-&gt;</span> <span class="mi">85</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;friends&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(),</span>
</span><span class='line'>  <span class="s">&quot;social&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;@gizmo&quot;</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">gizmo</span> <span class="k">=</span> <span class="n">gizmojs</span><span class="o">.</span><span class="n">validate</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span><span class='line'><span class="n">gizmo</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">JsSuccess</span><span class="o">(</span><span class="nc">Creature</span><span class="o">(</span><span class="n">gremlins</span><span class="o">,</span><span class="kc">false</span><span class="o">,</span><span class="mf">1.0</span><span class="o">,</span><span class="n">gizmo</span><span class="nd">@midnight</span><span class="o">.</span><span class="n">com</span><span class="o">,(</span><span class="n">pha</span><span class="o">,</span><span class="mi">85</span><span class="o">),</span><span class="nc">List</span><span class="o">(),</span><span class="nc">Some</span><span class="o">(</span><span class="nd">@gizmo</span><span class="o">)),)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">shaunjs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;zombie&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">true</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">100.0F</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;email&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;shaun@dead.com&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;favorites&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;string&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;brain&quot;</span><span class="o">,</span> <span class="s">&quot;number&quot;</span> <span class="o">-&gt;</span> <span class="mi">2</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;friends&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">(</span> <span class="n">gizmojs</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="k">val</span> <span class="n">shaun</span> <span class="k">=</span> <span class="n">shaunjs</span><span class="o">.</span><span class="n">validate</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span><span class='line'><span class="n">shaun</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">JsSuccess</span><span class="o">(</span><span class="nc">Creature</span><span class="o">(</span><span class="n">zombie</span><span class="o">,</span><span class="kc">true</span><span class="o">,</span><span class="mf">100.0</span><span class="o">,</span><span class="n">shaun</span><span class="nd">@dead</span><span class="o">.</span><span class="n">com</span><span class="o">,(</span><span class="n">ain</span><span class="o">,</span><span class="mi">2</span><span class="o">),</span><span class="nc">List</span><span class="o">(</span><span class="nc">Creature</span><span class="o">(</span><span class="n">gremlins</span><span class="o">,</span><span class="kc">false</span><span class="o">,</span><span class="mf">1.0</span><span class="o">,</span><span class="n">gizmo</span><span class="nd">@midnight</span><span class="o">.</span><span class="n">com</span><span class="o">,(</span><span class="n">alpha</span><span class="o">,</span><span class="mi">85</span><span class="o">),</span><span class="nc">List</span><span class="o">(),</span><span class="nc">Some</span><span class="o">(</span><span class="nd">@gizmo</span><span class="o">))),</span><span class="nc">None</span><span class="o">),)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">errorjs</span> <span class="k">=</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span>
</span><span class='line'>  <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;gremlins&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;isDead&quot;</span> <span class="o">-&gt;</span> <span class="kc">false</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;weight&quot;</span> <span class="o">-&gt;</span> <span class="mf">1.0F</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;email&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;rrhh&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="s">&quot;favorites&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">obj</span><span class="o">(</span><span class="s">&quot;string&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;ni&quot;</span><span class="o">,</span> <span class="s">&quot;number&quot;</span> <span class="o">-&gt;</span> <span class="mi">500</span><span class="o">),</span>
</span><span class='line'>  <span class="s">&quot;friends&quot;</span> <span class="o">-&gt;</span> <span class="nc">Json</span><span class="o">.</span><span class="n">arr</span><span class="o">()</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="n">scala</span><span class="o">&gt;</span> <span class="n">errorjs</span><span class="o">.</span><span class="n">validate</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span>
</span><span class='line'><span class="n">res0</span><span class="k">:</span> <span class="kt">play.api.libs.json.JsResult</span><span class="o">[</span><span class="kt">Creature</span><span class="o">]</span> <span class="k">=</span> <span class="nc">JsError</span><span class="o">(</span><span class="nc">List</span><span class="o">((/</span><span class="n">favorites</span><span class="o">/</span><span class="n">string</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">validate</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">unexpected</span><span class="o">.</span><span class="n">value</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="n">ni</span><span class="o">)))),</span> <span class="o">(/</span><span class="n">email</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">validate</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">email</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">()),</span> <span class="nc">ValidationError</span><span class="o">(</span><span class="n">validate</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">minlength</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="mi">5</span><span class="o">)))),</span> <span class="o">(/</span><span class="n">favorites</span><span class="o">/</span><span class="n">number</span><span class="o">,</span><span class="nc">List</span><span class="o">(</span><span class="nc">ValidationError</span><span class="o">(</span><span class="n">validate</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">max</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="mi">86</span><span class="o">)),</span> <span class="nc">ValidationError</span><span class="o">(</span><span class="n">validate</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">min</span><span class="o">,</span><span class="nc">WrappedArray</span><span class="o">(</span><span class="mi">875</span><span class="o">))))))</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<br/>


<h2><a name="conclusion">Conclusion &amp; much more…</a></h2>

<p>So here is the end of this 1st part not to make a too long article.
But there are so many other features to explain and demonstrate and there will other parts very soon!!!</p>

<blockquote><p><code>Reads[T]</code> combinators are cool but you know what? <code>Writes[T]</code> &amp; <code>Format[T]</code> can be combined too!</p></blockquote>

<p>Let&#8217;s tease a bit:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">creatureWrites</span> <span class="k">=</span> <span class="o">(</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;name&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;isDead&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Boolean</span><span class="o">]</span> <span class="n">and</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">__</span> <span class="o">\</span> <span class="s">&quot;weight&quot;</span><span class="o">).</span><span class="n">write</span><span class="o">[</span><span class="kt">Float</span><span class="o">]</span>
</span><span class='line'><span class="o">)(</span><span class="nc">Creature</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Next parts about <code>Writes[T]</code> combinators and another intriguing feature that I&#8217;ll name <code>Json Generators</code> ;)</p></blockquote>

<p>Have fun&#8230;</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2012/08/27/understanding-play2-iteratees-for-normal-humans/">Understanding Play2 Iteratees for Normal Humans</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-08-27T11:17:00+02:00" pubdate data-updated="true">Aug 27<span>th</span>, 2012</time>
        
         | <a href="/2012/08/27/understanding-play2-iteratees-for-normal-humans/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><blockquote><p>Thanks to <a href="http://www.twitter.com/loic_d">@loic_d</a>, we have a French translation of this article <a href="https://gist.github.com/3727850#file_iteratees_humains.md">there</a></p></blockquote>

<h4>You may have remarked that <a href="http://www.playframework.org">Play2</a> provides an intriguing feature called <em><code>Iteratee</code></em> (and its counterparts <em><code>Enumerator</code></em> and <em><code>Enumeratee</code></em>).</h4>

<h4>The main aim of this article is <strong><em>(to try)</em> to make the <code>Iteratee</code> concept understandable for most of us</strong> with reasonably simple arguments and without functional/math theory.</h4>

<br/>


<blockquote><p>This article is not meant to explain everything about <code>Iteratee</code> / <code>Enumerator</code> / <code>Enumeratee</code> but just the ideas behind it.<br/>
I&#8217;ll try to write another article to show practical samples of coding with Iteratee/Enumerator/Enumeratee.</p></blockquote>

<h1><a name="intro">Introduction</a></h1>

<blockquote><p><strong>In <a href="http://www.playframework.org/documentation/2.0.2/Iteratees">Play2 doc</a>, <code>Iteratees</code> are presented as a great tool to handle data streams reactively in a non-blocking, generic &amp; composable way for modern web programming in distributed environments.</strong></p>

<p><em>Seems great, isn&#8217;t it?<br/>
But what is an <code>Iteratee</code> exactly?<br/>
What is the difference between the <code>Iteratee</code> and the classic <code>Iterator</code> you certainly know?<br/>
Why use it? In which cases?<br/>
A bit obscure and complex, isn&#8217;t it?</em></p></blockquote>

<div class = "well">
<h3>If you are lazy and want to know just a few things</h3>
<ul>
  <li><code>Iteratee</code> is an <b>abstraction of iteration over chunks of data in a non-blocking and asynchronous way</b></li>
  <li><code>Iteratee</code> is able to <b>consume chunks of data of a given type from a producer</b> generating data chunks of the same type called <code>Enumerator</code>
  <li><code>Iteratee</code> can <b>compute a progressive result from data chunks over steps of iteration</b> (an incremented total for ex)
  <li><code>Iteratee</code> is a <b>thread-safe and immutable object that can be re-used over several `Enumerators`</b></li>
</ul>
</div>


<h3>1st advice: DO NOT SEARCH ABOUT ITERATEES ON GOOGLE</h3>

<p>When you search on Google for <code>Iteratee</code>, you find very obscure explanations based on pure functional approach or even mathematical theories. Even the documentation on Play Framework (<a href="http://www.playframework.org/documentation/2.0.2/Iteratees">there</a>) explains <code>Iteratee</code> with a fairly <em>low-level</em> approach which might be hard for beginners&#8230;</p>

<p>As a beginner in Play2, it might seem a bit tough to handle <code>Iteratee</code> concept presented in a really abstract way of manipulating data chunks.<br/>
It might seem so complicated that you will occult it and won&#8217;t use it.<br/>
It would be a shame because Iteratees are so powerful and provide a really interesting and new way to manipulate your data flows in a web app.</p>

<p>So, let&#8217;s try to explain things in a simple way. I don&#8217;t pretend to be a theoretical expert on those functional concepts and I may even say wrong things but I want to write an article that reflects what <code>Iteratee</code> means for me. Hope this could be useful to somebody&#8230;</p>

<blockquote><p>This article uses <strong>Scala</strong> for code samples but the code should be understandable by anyone having a few notions of coding and I promise not to use any weird operator (<em>but in last paragraph</em>) <strong>>&lt;> >&lt;> >&lt;> >&lt;></strong></p>

<p>The code samples are based on incoming <strong>Play2.1 master</strong> code which greatly simplifies and rationalizes the code of <code>Iteratee</code>. So don&#8217;t be surprised if API doesn&#8217;t look like Play2.0.x sometimes</p></blockquote>

<h1><a name="reminders">Reminders about iteration</a></h1>

<p>Before diving into deep <code>Iteratee</code> sea, I want to clarify what I call <strong>iteration</strong> and to try to go progressively from the concept of <code>Iterator</code> to <code>Iteratee</code>.</p>

<h4>You may know the <code>Iterator</code> concept you can find in Java. An <code>Iterator</code> allows to run over a collection of elements and then do something at each step of iteration. Let&#8217;s begin with a very simple iteration in <em>Java classic</em> way that sums all the integers of a <code>List[Int]</code></h4>

<br/>


<h3><a name="reminders-1">The first very naive implementation with <em>Java-like</em> <code>Iterator</code></a></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">l</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">var</span> <span class="n">total</span> <span class="k">=</span> <span class="mi">0</span> <span class="c1">// will contain the final total</span>
</span><span class='line'><span class="k">var</span> <span class="n">it</span> <span class="k">=</span> <span class="n">l</span><span class="o">.</span><span class="n">iterator</span>
</span><span class='line'><span class="k">while</span><span class="o">(</span> <span class="n">it</span><span class="o">.</span><span class="n">hasNext</span> <span class="o">)</span> <span class="o">{</span>
</span><span class='line'>  <span class="n">total</span> <span class="o">+=</span> <span class="n">it</span><span class="o">.</span><span class="n">next</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">total</span>
</span><span class='line'><span class="k">=&gt;</span> <span class="n">resXXX</span> <span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="mi">1677</span>
</span></code></pre></td></tr></table></div></figure>


<p>Without any surprise, <em>iterating over a collection</em> means :</p>

<ul>
<li>Get an iterator from the collection,</li>
<li>Get an element from the iterator (if there are any),</li>
<li>Do something : <em>here add the element value to the total</em>,</li>
<li>If there are other elements, go to the next element,</li>
<li>Do it again,</li>
<li>Etc&#8230; till there are no more element to consume in the iterator</li>
</ul>


<div class="well">
While iterating over a collection, we manipulate:
<ul>
  <li><strong>A state of iteration</strong> (is iteration finished ? This is naturally linked to the fact that there are more elements or not in the iterator?)</li>
  <li><strong>A context</strong> updated from one step to the next (the total)</li>
  <li><strong>An action</strong> updating the context</li>
</ul>
</div>


<h3><a name="reminders-2">Rewrite that using Scala <em>for-comprehension</em></a></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">for</span><span class="o">(</span> <span class="n">item</span> <span class="k">&lt;-</span> <span class="n">l</span> <span class="o">)</span> <span class="o">{</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">item</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>It&#8217;s a bit better because you don&#8217;t have to use the iterator.</p>

<h3><a name="reminders-3">Rewrite it in a more functional way</a></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">l</span><span class="o">.</span><span class="n">foreach</span><span class="o">{</span> <span class="n">item</span> <span class="k">=&gt;</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">item</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Here we introduce <code>List.foreach</code> function accepting an anonymous function <code>(Int =&gt; Unit)</code> as a parameter and iterating over the list: for each element in the list, it calls the function which can update the context (<em>here the total</em>).</p>

<p>The anonymous function contains the action executed at each loop while iterating over the collection.</p>

<h3><a name="reminders-3">Rewrite in a more generic way</a></h3>

<p>The anonymous function could be stored in a variable so that it can be reused in different places.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">l</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">l2</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="mi">134</span><span class="o">,</span> <span class="mi">664</span><span class="o">,</span> <span class="mi">987</span><span class="o">,</span> <span class="mi">456</span><span class="o">)</span>
</span><span class='line'><span class="k">var</span> <span class="n">total</span> <span class="k">=</span> <span class="mi">0</span>
</span><span class='line'><span class="k">def</span> <span class="n">step</span><span class="o">(</span><span class="n">item</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="n">total</span> <span class="o">+=</span> <span class="n">item</span>
</span><span class='line'><span class="n">l</span> <span class="n">foreach</span> <span class="n">step</span>
</span><span class='line'>
</span><span class='line'><span class="n">total</span> <span class="k">=</span> <span class="mi">0</span>
</span><span class='line'><span class="n">l2</span> <span class="n">foreach</span> <span class="n">step</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>You should then say to me: <em>&#8220;This is ugly design, your function has side-effects and uses a variable which is not a nice design at all and you even have to reset total to 0 at second call!&#8221;</em></p></blockquote>

<p>That&#8217;s completely true:</p>

<blockquote><p><strong>Side-effect functions are quite dangerous</strong> because they change the state of something that is external to the function. This state is not exclusive to the function and can be changed by other entities, potentially in other threads. Function with side-effects are not recommended to have clean and robust designs and functional languages such as Scala tend to reduce side-effects functions to the strict necessary (IO operations for ex).</p>

<p><strong>Mutable variables are also risky</strong> because if your code is run over several threads, if 2 threads try to change the value of the variable, who wins? In this case, you need synchronization which means blocking threads while writing the variable which means breaking one of the reason of being of Play2 (non-blocking web apps)&#8230;</p></blockquote>

<h3><a name="reminders-4">Rewrite the code in an immutable way without side-effects</a></h3>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">foreach</span><span class="o">(</span><span class="n">l</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">step</span><span class="o">(</span><span class="n">l</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">],</span> <span class="n">total</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=</span> <span class="o">{</span>
</span><span class='line'>    <span class="n">l</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">List</span><span class="o">()</span> <span class="k">=&gt;</span> <span class="n">total</span>
</span><span class='line'>      <span class="k">case</span> <span class="nc">List</span><span class="o">(</span><span class="n">elt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">total</span> <span class="o">+</span> <span class="n">elt</span>
</span><span class='line'>      <span class="k">case</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="k">=&gt;</span> <span class="n">step</span><span class="o">(</span><span class="n">tail</span><span class="o">,</span> <span class="n">total</span> <span class="o">+</span> <span class="n">head</span><span class="o">)</span>
</span><span class='line'>    <span class="o">}</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">step</span><span class="o">(</span><span class="n">l</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="n">foreach</span><span class="o">(</span><span class="n">l</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>A bit more code, isn&#8217;t it ?</h4>

<h4>But please notice at least:</h4>

<ul>
<li><code>var total</code> disappeared.</li>
<li><code>step</code> function is the action executed at each step of iteration but it does something more than before: <code>step</code> also manages the state of the iteration. It executes as following:

<ul>
<li>If the list is empty, return current <code>total</code></li>
<li>If the list has 1 element, return <code>total + elt</code></li>
<li>If the list has more than 1 element, calls <code>step</code> with the tail elements and the new total <code>total + head</code></li>
</ul>
</li>
</ul>


<p>So at each step of iteration, depending on the result of previous iteration, <code>step</code> can choose between 2 states:</p>

<ul>
<li>Continue iteration because it has more elements</li>
<li>Stop iteration because it reached end of list or no element at all</li>
</ul>


<h4>Notice also that :</h4>

<ul>
<li><strong><code>step</code> is a <em>tail-recursive</em> function</strong> (doesn&#8217;t unfold the full call stack at the end of recursion and returns immediately) preventing from stack overflow and behaving almost like the previous code with <code>Iterator</code></li>
<li><strong><code>step</code> transmits the remaining elements of the list &amp; the new total</strong> to the next step</li>
<li><strong><code>step</code> returns the total without any side-effects</strong> at all</li>
</ul>


<blockquote><p>So, yes, this code consumes a bit more memory because it re-copies some parts of the list at each step (only the references to the elements) but it has no side-effect and uses only immutable data structures.
This makes it very robust and distributable without any problem.</p></blockquote>

<p>Notice you can write the code in a very shorter way using the wonderful functions provided by Scala collections:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="n">l</span><span class="o">.</span><span class="n">foldLeft</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span> <span class="o">(</span><span class="n">total</span><span class="o">,</span> <span class="n">elt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">total</span> <span class="o">+</span> <span class="n">elt</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<div class="well">
<h3><a name="reminders-milestone">Milestone</a></h3>
<br/>
In this article, I consider iteration based on immutable structures propagated over steps.
From this point of view, iterating involves:
<ul>
<li>receiving information from the previous step: context & state</li>
<li>getting current/remaining element(s)</li>
<li>computing a new state & context from remaining elements</li>
<li>propagating the new state & context to next step</li>
</ul>

</div>


<hr />

<h1><a name="step-by-step">Step by Step to <em>Iterator</em> &amp; <em>Iteratees</em></a></h1>

<p>Now that we are clear about iteration, let&#8217;s go back to our <code>Iteratee</code>!!!</p>

<h4>Imagine you want to generalize the previous iteration mechanism and be able to write something like:</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">sumElements</span><span class="o">(...)</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="k">def</span> <span class="n">prodElements</span><span class="o">(...)</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="k">def</span> <span class="n">printElements</span><span class="o">(...)</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="n">l</span><span class="o">.</span><span class="n">iterate</span><span class="o">(</span><span class="n">sumElements</span><span class="o">)</span>
</span><span class='line'><span class="n">l</span><span class="o">.</span><span class="n">iterate</span><span class="o">(</span><span class="n">prodElements</span><span class="o">)</span>
</span><span class='line'><span class="n">l</span><span class="o">.</span><span class="n">iterate</span><span class="o">(</span><span class="n">printElements</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Yes I know, with Scala collection APIs, you can do many things :)</p></blockquote>

<h4>Imagine you want to compose a first iteration with another one:</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">def</span> <span class="n">groupElements</span><span class="o">(...)</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="k">def</span> <span class="n">printElements</span><span class="o">(...)</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="n">l</span><span class="o">.</span><span class="n">iterate</span><span class="o">(</span><span class="n">groupElements</span><span class="o">).</span><span class="n">iterate</span><span class="o">(</span><span class="n">printElements</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Imagine you want to apply this iteration on something else than a collection:</h4>

<ul>
<li>a stream of data produced progressively by a file, a network connection, a database connection,</li>
<li>a data flow generated by an algorithm,</li>
<li>a data flow from an asynchronous data producer such as a scheduler or an actor.</li>
</ul>


<p><strong>Iteratees are exactly meant for this&#8230;</strong></p>

<p>Just to tease, here is how you would write the previous sum iteration with an <code>Iteratee</code>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">enumerator</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'><span class="n">enumerator</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="nc">Iteratee</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span> <span class="o">(</span><span class="n">total</span><span class="o">,</span> <span class="n">elt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">total</span> <span class="o">+</span> <span class="n">elt</span> <span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Ok, it looks like the previous code and doesn&#8217;t seem to do much more&#8230;<br/>
Not false but trust me, it can do much more.<br/>
At least, it doesn&#8217;t seem so complicated?</p>

<p>But, as you can see, <code>Iteratee</code> is used with <code>Enumerator</code> and both concepts are tightly related.</p>

<p><strong>Now let&#8217;s dive into those concepts on a step by step approach.</strong></p>

<br/>


<h2><a name="step-by-step-enumerator">>&lt;> About Enumerator >&lt;></a></h2>

<h3><code>Enumerator</code> is a more generic concept than collections or arrays</h3>

<p>Till now, we have used collections in our iterations. But as explained before, we could iterate over something more generic, simply being able to produce simple chunks of data available immediately or asynchronously in the future.</p>

<p><code>Enumerator</code> is designed for this purpose.</p>

<p>A few examples of simple Enumerators:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// an enumerator of Strings</span>
</span><span class='line'><span class="k">val</span> <span class="n">stringEnumerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Enumerate</span><span class="o">(</span><span class="s">&quot;alpha&quot;</span><span class="o">,</span> <span class="s">&quot;beta&quot;</span><span class="o">,</span> <span class="s">&quot;gamma&quot;</span><span class="o">)</span>
</span><span class='line'><span class="c1">// an enumerator of Integers</span>
</span><span class='line'><span class="k">val</span> <span class="n">integerEnumerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Enumerate</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">456</span><span class="o">,</span> <span class="mi">789</span><span class="o">)</span>
</span><span class='line'><span class="c1">// an enumerator of Doubles</span>
</span><span class='line'><span class="k">val</span> <span class="n">doubleEnumerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">Double</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Enumerate</span><span class="o">(</span><span class="mf">123.345</span><span class="o">,</span> <span class="mf">456.543</span><span class="o">,</span> <span class="mf">789.123</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// an Enumerator from a file</span>
</span><span class='line'><span class="k">val</span> <span class="n">fileEnumerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">Array</span><span class="o">[</span><span class="kt">Byte</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">.</span><span class="n">fromFile</span><span class="o">(</span><span class="s">&quot;myfile.txt&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// an Enumerator generated by a callback</span>
</span><span class='line'><span class="c1">// it generates a string containing current time every 500 milliseconds</span>
</span><span class='line'><span class="c1">// notice (and forget for the time being) the Promise.timeout which allows non-blocking mechanism</span>
</span><span class='line'><span class="k">val</span> <span class="n">dateGenerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">.</span><span class="n">generateM</span><span class="o">(</span>
</span><span class='line'>  <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">Promise</span><span class="o">.</span><span class="n">timeout</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;current time %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">((</span><span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Date</span><span class="o">()))),</span>
</span><span class='line'>    <span class="mi">500</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>Enumerator</code> is a <em>PRODUCER</em> of statically typed chunks of data.</h3>

<p><code>Enumerator[E]</code> produces chunks of data of type <code>E</code> and can be of the 3 following kinds:</p>

<ul>
<li><code>Input[E]</code> is a chunk of data of type E : <em>for ex, Input[Pizza] is a chunk of Pizza</em>.</li>
<li><code>Input.Empty</code> means the enumerator is empty : <em>for ex, an Enumerator streaming an empty file</em>.</li>
<li><code>Input.EOF</code> means the enumerator has reached its end : <em>for ex, Enumerator streaming a file and reaching the end of file</em>.</li>
</ul>


<p><em>You can draw a parallel between the kinds of chunks and the states presented above (has more/no/no more elements).</em></p>

<p>Actually, <code>Enumerator[E]</code> contains <code>Input[E]</code> so you can put an <code>Input[E]</code> in it:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// create an enumerator containing one chunk of pizza</span>
</span><span class='line'><span class="k">val</span> <span class="n">pizza</span> <span class="k">=</span> <span class="nc">Pizza</span><span class="o">(</span><span class="s">&quot;napolitana&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">enumerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">Pizza</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">.</span><span class="n">enumInput</span><span class="o">(</span><span class="nc">Input</span><span class="o">.</span><span class="n">el</span><span class="o">(</span><span class="n">pizza</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// create an enumerator containing no pizza</span>
</span><span class='line'><span class="k">val</span> <span class="n">enumerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">Pizza</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">.</span><span class="n">enumInput</span><span class="o">(</span><span class="nc">Input</span><span class="o">.</span><span class="nc">Empty</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>Enumerator</code> is a non-blocking producer</h3>

<p>The idea behind Play2 is, as you may know, to be fully non-blocking and asynchronous. Thus, <code>Enumerator</code>/<code>Iteratee</code> reflects this philosophy.
The <code>Enumerator</code> produces chunks in a completely asynchronous and non-blocking way. This means the concept of <code>Enumerator</code> is not by default related to an active process or a background task generating chunks of data.</p>

<p>Remember the code snippet above with <code>dateGenerator</code> which reflects exactly the asynchronous and non-blocking nature of <code>Enumerator</code>/<code>Iteratee</code>?</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// an Enumerator generated by a callback</span>
</span><span class='line'><span class="c1">// it generates a string containing current time every 500 milliseconds</span>
</span><span class='line'><span class="c1">// notice the Promise.timeout which provide a non-blocking mechanism</span>
</span><span class='line'><span class="k">val</span> <span class="n">dateGenerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">.</span><span class="n">generateM</span><span class="o">(</span>
</span><span class='line'>  <span class="n">play</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">libs</span><span class="o">.</span><span class="n">concurrent</span><span class="o">.</span><span class="nc">Promise</span><span class="o">.</span><span class="n">timeout</span><span class="o">(</span>
</span><span class='line'>    <span class="nc">Some</span><span class="o">(</span><span class="s">&quot;current time %s&quot;</span><span class="o">.</span><span class="n">format</span><span class="o">((</span><span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Date</span><span class="o">()))),</span>
</span><span class='line'>    <span class="mi">500</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>What&#8217;s a Promise?</strong></p>

<p>It would require a whole article but let&#8217;s say the name corresponds exactly to what it does.<br/>
A <code>Promise[String]</code> means : &#8221;<em>It will provide a String in the future (or an error)</em>&#8221;, that&#8217;s all. Meanwhile, it doesn&#8217;t block current thread and just releases it.</p></blockquote>

<h3><code>Enumerator</code> requires a consumer to produce</h3>

<p>Due to its non-blocking nature, if nobody consumes those chunks, the <code>Enumerator</code> doesn&#8217;t block anything and doesn&#8217;t consume any hidden runtime resources.<br/>
So, <strong><code>Enumerator</code> <em>MAY</em> produce chunks of data only if there is someone to consume them</strong>.</p>

<br/>




<div class="well">
So what consumes the chunks of data produced by <code>Enumerator</code>?<br/>
You have deduced it yourself: the <code>Iteratee</code>
</div>


<p></p>

<br/>


<br/>


<h2><a name="step-by-step-iteratee">>&lt;> About Iteratee >&lt;></a></h2>

<h3><code>Iteratee</code> is a generic <em>&#8220;stuff&#8221;</em> that can iterate over an <code>Enumerator</code></h3>

<p>Let&#8217;s be windy for one sentence:</p>

<blockquote><p><code>Iteratee</code> is the generic translation of the concept of iteration in pure functional programming.<br/>
While <code>Iterator</code> is built from the collection over which it will iterate, <code>Iteratee</code> is a generic entity that waits for an <code>Enumerator</code> to be iterated over.</p></blockquote>

<p>Do you see the difference between <code>Iterator</code> and <code>Iteratee</code>? No? Not a problem… Just remember that:</p>

<ul>
<li>an <code>Iteratee</code> is a generic entity that can <em>iterate</em> over the chunks of data produced by an <code>Enumerator</code> (or something else)</li>
<li>an <code>Iteratee</code> is created independently of the <code>Enumerator</code> over which it will iterate and the <code>Enumerator</code> is provided to it</li>
<li>an <code>Iteratee</code> is immutable, stateless and fully reusable for different enumerators</li>
</ul>


<p>That&#8217;s why we say:</p>

<blockquote><p>An <code>Iteratee</code> is applied on an <code>Enumerator</code> or run over an <code>Enumerator</code>.</p></blockquote>

<p>Do you remember the example above computing the total of all elements of an Enumerator[Int] ?<br/>
Here is the same code showing that an <code>Iteratee</code> can be created once and reused several times on different Enumerators.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">iterator</span> <span class="k">=</span> <span class="nc">Iteratee</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span> <span class="o">(</span><span class="n">total</span><span class="o">,</span> <span class="n">elt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">total</span> <span class="o">+</span> <span class="n">elt</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">e1</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">e2</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">345</span><span class="o">,</span> <span class="mi">123</span><span class="o">,</span> <span class="mi">476</span><span class="o">,</span> <span class="mi">187687</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// we apply the iterator on the enumerator</span>
</span><span class='line'><span class="n">e1</span><span class="o">(</span><span class="n">iterator</span><span class="o">)</span>      <span class="c1">// or e1.apply(iterator)</span>
</span><span class='line'><span class="n">e2</span><span class="o">(</span><span class="n">iterator</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// we run the iterator over the enumerator to get a result</span>
</span><span class='line'><span class="k">val</span> <span class="n">result1</span> <span class="k">=</span> <span class="n">e1</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">iterator</span><span class="o">)</span> <span class="c1">// or e1 run iterator</span>
</span><span class='line'><span class="k">val</span> <span class="n">result2</span> <span class="k">=</span> <span class="n">e2</span><span class="o">.</span><span class="n">run</span><span class="o">(</span><span class="n">iterator</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><em><code>Enumerator.apply</code> and <code>Enumerator.run</code> are slightly different functions and we will explain that later.</em></p></blockquote>

<h3><code>Iteratee</code> is an active consumer of chunks of data</h3>

<p>By default, the <code>Iteratee</code> awaits a first chunk of data and immediately after, it launches the iteration mechanism.
The <code>Iteratee</code> goes on consuming data until it considers it has finished its computation.<br/>
Once initiated, the <code>Iteratee</code> is fully responsible for the full iteration process and decides when it stops.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// creates the iteratee</span>
</span><span class='line'><span class="k">val</span> <span class="n">iterator</span> <span class="k">=</span> <span class="nc">Iteratee</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span> <span class="o">(</span><span class="n">total</span><span class="o">,</span> <span class="n">elt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">total</span> <span class="o">+</span> <span class="n">elt</span> <span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates an enumerator</span>
</span><span class='line'><span class="k">val</span> <span class="n">e</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// this injects the enumerator into the iteratee </span>
</span><span class='line'><span class="c1">// = pushes the first chunk of data into the iteratee</span>
</span><span class='line'><span class="n">enumerator</span><span class="o">(</span><span class="n">iterator</span><span class="o">)</span>
</span><span class='line'><span class="c1">// the iteratee then consumes as many chunks as it requires</span>
</span><span class='line'><span class="c1">// don&#39;t bother about the result of this, we will explain later</span>
</span></code></pre></td></tr></table></div></figure>


<p>As explained above, the <code>Enumerator</code> is a producer of chunks of data and it expects a consumer to consume those chunks of data.<br/>
To be consumed/iterated, the <code>Enumerator</code> has to be injected/plugged into an <code>Iteratee</code> or more precisely the first chunk of data has to be
injected/pushed into the <code>Iteratee</code>.<br/>
Naturally the <code>Iteratee</code> is dependent on speed of production of <code>Enumerator</code>: if it&#8217;s slow, the <code>Iteratee</code> is also slow.</p>

<blockquote><p>Notice the relation Iteratee/Enumerator can be considered with respect to inversion of control and dependency injection pattern.</p></blockquote>

<h3><code>Iteratee</code> is a &#8221;<em>1-chunk-loop</em>&#8221; function</h3>

<p>The <code>Iteratee</code> consumes chunks one by one until it considers it has ended iteration.<br/>
Actually, the real scope of an <code>Iteratee</code> is limited to the treatment of one chunk.
That&#8217;s why it can be defined as a function being able to consume one chunk of data.</p>

<h3><code>Iteratee</code> accepts static typed chunks and computes a static typed result</h3>

<p>Whereas an <code>Iterator</code> iterates over chunks of data coming from the collection that created it, an <code>Iteratee</code> is a bit more ambitious : it can
compute something meanwhile it consumes chunks of data.</p>

<p>That&#8217;s why the signature of Iteratee is :</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Iteratee</span><span class="o">[</span><span class="kt">E</span>, <span class="kt">+A</span><span class="o">]</span>
</span><span class='line'><span class="c1">// E is the type of data contained in chunks. So it can only be applied on a Enumerator[E]</span>
</span><span class='line'><span class="c1">// A is the result of the iteration</span>
</span></code></pre></td></tr></table></div></figure>


<p>Let&#8217;s go back to our first sample : compute the total of all integers produced by an <code>Enumerator[Int]</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// creates the iteratee</span>
</span><span class='line'><span class="k">val</span> <span class="n">iterator</span> <span class="k">=</span> <span class="nc">Iteratee</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span> <span class="o">(</span><span class="n">total</span><span class="o">,</span> <span class="n">elt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">total</span> <span class="o">+</span> <span class="n">elt</span> <span class="o">}</span>
</span><span class='line'><span class="k">val</span> <span class="n">e</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// runs the iteratee over the enumerator and retrieve the result</span>
</span><span class='line'><span class="k">val</span> <span class="n">total</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">enumerator</span> <span class="n">run</span> <span class="n">iterator</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Notice the usage of <code>run</code>: You can see that the result is not the total itself but a <code>Promise[Int]</code> of the total because we are in an asynchronous world.<br/>
To retrieve the real total, you could use scala concurrent blocking <code>Await._</code> functions. But this is NOT good because it&#8217;s a blocking API. As Play2 is fully async/non-blocking, the best practice is to
propagate the promise using <code>Promise.map/flatMap</code>.</p></blockquote>

<p>But a result is not mandatory. For ex, let&#8217;s just println all consumed chunks:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// creates the iteratee</span>
</span><span class='line'><span class="k">val</span> <span class="n">e</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'><span class="n">e</span><span class="o">(</span><span class="nc">Iteratee</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span> <span class="n">println</span> <span class="k">_</span> <span class="o">))</span>
</span><span class='line'><span class="c1">// or</span>
</span><span class='line'><span class="n">e</span><span class="o">.</span><span class="n">apply</span><span class="o">(</span><span class="nc">Iteratee</span><span class="o">.</span><span class="n">foreach</span><span class="o">(</span> <span class="n">println</span> <span class="k">_</span> <span class="o">))</span>
</span><span class='line'><span class="c1">// yes here the usage of _ is so trivial that you shall use it</span>
</span></code></pre></td></tr></table></div></figure>


<p>The result is not necessarily a primitive type, it can just be the concatenation of all chunks into a List for ex:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">enumerator</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">list</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">List</span><span class="o">[</span><span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">enumerator</span> <span class="n">run</span> <span class="nc">Iteratee</span><span class="o">.</span><span class="n">getChunks</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>Iteratee</code> can propagate the immutable context &amp; state over iterations</h3>

<p>To be able to compute final total, the <code>Iteratee</code> needs to propagate the partial totals along iteration steps.<br/>
This means the <code>Iteratee</code> is able to receive a context (<em>the previous total for ex</em>) from the previous step, then compute the new context with current chunk of data
(<em>new total = previous total + current element</em>) and can finally propagate this context to the next step (if there need to be a next step).</p>

<h3><code>Iteratee</code> is simply a state machine</h3>

<p>Ok this is cool but how does the <code>Iteratee</code> know it has to stop iterating?<br/>
What happens if there were an error/ EOF or it has reached the end of <code>Enumerator</code>?<br/>
Therefore, in addition to the context, the <code>Iteratee</code> should also receive previous state, decides what to do and potentially computes the new state to be sent to next step.</p>

<p>Now, remember the classic iteration states described above. For <code>Iteratee</code>, there are almost the same 2 possible states of iteration:</p>

<ul>
<li>State <code>Cont</code> : the iteration can continue with next chunk and potentially compute new context</li>
<li>State <code>Done</code> : it signals it has reached the end of its process and can return the resulting context value</li>
</ul>


<p>and a 3rd one which seems quite logical:</p>

<ul>
<li>State <code>Error</code> : it signals there was an Error during current step and stops iterating</li>
</ul>


<blockquote><p><strong>From this point of view, we can consider the <code>Iteratee</code> is just a state machine in charge of looping over state <code>Cont</code> until it detects conditions to switch to terminal states <code>Done</code> or <code>Error</code>.</strong></p></blockquote>

<h3><code>Iteratee</code> states <code>Done/Error/Cont</code> are also <code>Iteratee</code></h3>

<p>Remember, the <code>Iteratee</code> is defined as a 1-chunk-loop function and it&#8217;s main purpose is to change from one state to another one.
Let&#8217;s consider those states are also <code>Iteratee</code>.</p>

<p>We have 3 &#8221;<em>State</em>&#8221; Iteratees:</p>

<p><code>Done[E, A](a: A, remaining: Input[E])</code></p>

<ul>
<li><code>a:A</code> the context received from previous step</li>
<li><code>remaining: Input[E]</code> representing the next chunk</li>
</ul>


<br/>


<p><code>Error[E](msg: String, input: Input[E])</code></p>

<p>Very simple to understand also: an error message and the input on which it failed.</p>

<br/>


<p><code>Cont[E, A](k: Input[E] =&gt; Iteratee[E, A])</code></p>

<p>This is the most complicated State as it&#8217;s built from a function taking an <code>Input[E]</code> and returning another <code>Iteratee[E,A]</code>.
Without going too deep in the theory, you can easily understand that <code>Input[E] =&gt; Iteratee[E, A]</code> is simply a good way to consume one input and return a new state/iteratee
which can consume another input and return another state/iteratee etc… till reaching state Done or Error.<br/>
This construction ensures feeding the iteration mechanism (in a typical functional way).</p>

<p>Ok lots of information, isn&#8217;t it?
You certainly wonder why I explain of all of that?
This is just because if you understand that, you will understand how to create an custom <code>Iteratee</code>.</p>

<p>Let&#8217;s write an <code>Iteratee</code> computing the total of the 2 first elements in an <code>Enumerator[Int]</code> to show an example.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// Defines the Iteratee[Int, Int]</span>
</span><span class='line'><span class="k">def</span> <span class="n">total2Chunks</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
</span><span class='line'>  <span class="c1">// `step` function is the consuming function receiving previous context (idx, total) and current chunk</span>
</span><span class='line'>  <span class="c1">// context : (idx, total) idx is the index to count loops</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">step</span><span class="o">(</span><span class="n">idx</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">total</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)(</span><span class="n">i</span><span class="k">:</span> <span class="kt">Input</span><span class="o">[</span><span class="kt">Int</span><span class="o">])</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">i</span> <span class="k">match</span> <span class="o">{</span>
</span><span class='line'>    <span class="c1">// chunk is EOF or Empty =&gt; simply stops iteration by triggering state Done with current total</span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Input</span><span class="o">.</span><span class="nc">EOF</span> <span class="o">|</span> <span class="nc">Input</span><span class="o">.</span><span class="nc">Empty</span> <span class="k">=&gt;</span> <span class="nc">Done</span><span class="o">(</span><span class="n">total</span><span class="o">,</span> <span class="nc">Input</span><span class="o">.</span><span class="nc">EOF</span><span class="o">)</span>
</span><span class='line'>    <span class="c1">// found one chunk </span>
</span><span class='line'>    <span class="k">case</span> <span class="nc">Input</span><span class="o">.</span><span class="nc">El</span><span class="o">(</span><span class="n">e</span><span class="o">)</span> <span class="k">=&gt;</span>
</span><span class='line'>      <span class="c1">// if first or 2nd chunk, call `step` again by incrementing idx and computing new total</span>
</span><span class='line'>      <span class="k">if</span><span class="o">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">)</span> <span class="nc">Cont</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">](</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">step</span><span class="o">(</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="o">,</span> <span class="n">total</span> <span class="o">+</span> <span class="n">e</span><span class="o">)(</span><span class="n">i</span><span class="o">))</span>
</span><span class='line'>      <span class="c1">// if reached 2nd chunk, stop iterating</span>
</span><span class='line'>      <span class="k">else</span> <span class="nc">Done</span><span class="o">(</span><span class="n">total</span><span class="o">,</span> <span class="nc">Input</span><span class="o">.</span><span class="nc">EOF</span><span class="o">)</span>
</span><span class='line'>  <span class="o">}</span>
</span><span class='line'>
</span><span class='line'>  <span class="c1">// initiates iteration by initialize context and first state (Cont) and launching iteration</span>
</span><span class='line'>  <span class="o">(</span><span class="nc">Cont</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">](</span><span class="n">i</span> <span class="k">=&gt;</span> <span class="n">step</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)(</span><span class="n">i</span><span class="o">)))</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Using it</span>
</span><span class='line'><span class="k">val</span> <span class="n">promiseTotal</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">10</span><span class="o">,</span> <span class="mi">20</span><span class="o">,</span> <span class="mi">5</span><span class="o">)</span> <span class="n">run</span> <span class="n">total2Chunks</span>
</span><span class='line'><span class="n">promiseTotal</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">println</span> <span class="k">_</span><span class="o">)</span>
</span><span class='line'><span class="k">=&gt;</span> <span class="n">prints</span> <span class="mi">30</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p><strong>With this example, you can understand that writing an Iteratee is not much different than choosing what to do at each step depending on the type of Chunk you received
 and returning the new <code>State/Iteratee</code>.</strong></p></blockquote>

<br/>


<br/>


<h2><a name="candies">A few candy for those who did not drown yet</a></h2>

<h3><code>Enumerator</code> is just a helper to deal with <code>Iteratee</code></h3>

<p>As you could see, in <code>Iteratee</code> API, there is nowhere any mention about <code>Enumerator</code>.<br/>
This is just because <code>Enumerator</code> is just a helper to interact with <code>Iteratee</code>: it can plug itself to <code>Iteratee</code> and injects the first chunk of data into it.<br/>
But you don&#8217;t need <code>Enumerator</code> to use <code>Iteratee</code> even if this is really easier and well integrated everywhere in Play2.</p>

<br/>


<h3>Difference between <code>Enumerator.apply(Iteratee)</code> and <code>Enumerator.run(Iteratee)</code></h3>

<p>Let&#8217;s go back to this point evoked earlier.
Have a look at the signature of main APIs in <code>Enumerator</code>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">trait</span> <span class="nc">Enumerator</span><span class="o">[</span><span class="kt">E</span><span class="o">]</span> <span class="o">{</span>
</span><span class='line'>
</span><span class='line'>  <span class="k">def</span> <span class="n">apply</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">i</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">E</span>, <span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">Iteratee</span><span class="o">[</span><span class="kt">E</span>, <span class="kt">A</span><span class="o">]]</span>
</span><span class='line'>  <span class="o">...</span>
</span><span class='line'>  <span class="k">def</span> <span class="n">run</span><span class="o">[</span><span class="kt">A</span><span class="o">](</span><span class="n">i</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">E</span>, <span class="kt">A</span><span class="o">])</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="o">|&gt;&gt;&gt;(</span><span class="n">i</span><span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<h4><code>apply</code> returns last Iteratee/State</h4>

<p>The <code>apply</code> function injects the <code>Enumerator</code> into the <code>Iteratee</code> which consumes the chunks, does its job and returns a Promise of <code>Iteratee</code>.
From previous explanation, you may deduce by yourself that the returned <code>Iteratee</code> might simply be the last state after it has finished consuming the chunks it required from <code>Enumerator</code>.</p>

<h4><code>run</code> returns a Promise[Result]</h4>

<p><code>run</code> has 3 steps:</p>

<ol>
<li>Call previous <code>apply</code> function</li>
<li>Inject <code>Input.EOF</code> into <code>Iteratee</code> to be sure it has ended</li>
<li>Get the last context from <code>Iteratee</code> as a promise.</li>
</ol>


<p>Here is an example:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// creates the iteratee</span>
</span><span class='line'><span class="k">val</span> <span class="n">iterator</span> <span class="k">=</span> <span class="nc">Iteratee</span><span class="o">.</span><span class="n">fold</span><span class="o">(</span><span class="mi">0</span><span class="o">){</span> <span class="o">(</span><span class="n">total</span><span class="o">,</span> <span class="n">elt</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">total</span> <span class="o">+</span> <span class="n">elt</span> <span class="o">}</span>
</span><span class='line'><span class="k">val</span> <span class="n">e</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="mi">234</span><span class="o">,</span> <span class="mi">455</span><span class="o">,</span> <span class="mi">987</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// just lets the iterator consume all chunks but doesn&#39;t require result right now</span>
</span><span class='line'><span class="k">val</span> <span class="n">totalIteratee</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">Iteratee</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">Int</span><span class="o">]]</span> <span class="k">=</span> <span class="n">enumerator</span> <span class="n">apply</span> <span class="n">iterator</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// runs the iteratee over the enumerator and retrieves the result as a promise</span>
</span><span class='line'><span class="k">val</span> <span class="n">total</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">Int</span><span class="o">]</span> <span class="k">=</span> <span class="n">enumerator</span> <span class="n">run</span> <span class="n">iterator</span>
</span></code></pre></td></tr></table></div></figure>




<div class="well">
<h3>To Remember</h3>
<h4>When you need the result of <code>Iteratee</code>, you shall use <code>run</code></h4>
<h4>When you need to apply an <code>Iteratee</code> over an <code>Enumerator</code> without retrieving the result, you shall use <code>apply</code></h4>
</div>




<br/>


<h3><code>Iteratee</code> is a Promise[Iteratee] (<em>IMPORTANT TO KNOW</em>)</h3>

<p>One more thing to know about an Iteratee is that <strong>Iteratee is a Promise[Iteratee]</strong> by definition.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="c1">// converts a Promise[Iteratee] to Iteratee</span>
</span><span class='line'><span class="k">val</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">Iteratee</span><span class="o">[</span><span class="kt">E</span>, <span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="o">...</span>
</span><span class='line'><span class="k">val</span> <span class="n">it</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">E</span>, <span class="kt">A</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Iteratee</span><span class="o">.</span><span class="n">flatten</span><span class="o">(</span><span class="n">p</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// converts an Iteratee to a Promise[Iteratee]</span>
</span><span class='line'><span class="c1">// pure promise</span>
</span><span class='line'><span class="k">val</span> <span class="n">p1</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">Iteratee</span><span class="o">[</span><span class="kt">E</span>, <span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Promise</span><span class="o">.</span><span class="n">pure</span><span class="o">(</span><span class="n">it</span><span class="o">)</span>
</span><span class='line'><span class="c1">// using unflatten</span>
</span><span class='line'><span class="k">val</span> <span class="n">p2</span><span class="k">:</span> <span class="kt">Promise</span><span class="o">[</span><span class="kt">Iteratee</span><span class="o">[</span><span class="kt">E</span>, <span class="kt">A</span><span class="o">]]</span> <span class="k">=</span> <span class="n">it</span><span class="o">.</span><span class="n">unflatten</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">it</span> <span class="o">)</span>
</span><span class='line'><span class="c1">// unflatten returns a technical structure called Step wrapping the Iteratee in _.it</span>
</span></code></pre></td></tr></table></div></figure>




<div class="well">
<h3><code>Iteratee</code> <=> <code>Promise[Iteratee]</code></h3>
<h4>This means that you can build your code around Iteratee in a very lazy way : with Iteratee, you can switch to Promise and back as you want.</h4>
</div>




<br/>


<hr />

<h2><a name="enumeratee">Final words about <em>Enumeratee</em></a></h2>

<blockquote><p>You discovered <code>Iteratee</code>, then <code>Enumerator</code>…<br/>
And now you come across this…  <code>Enumeratee</code>???<br/>
What is that new stuff in <code>XXXtee</code> ?????</p></blockquote>

<h3>2nd advice : DON&#8217;T PANIC NOW… <code>Enumeratee</code> concept is really simple to understand</h3>

<div class="well">
<h3><code>Enumeratee</code> is just a <i>pipe adapter</i> between <code>Enumerator</code> and <code>Iteratee</code></h3>
</div>


<br/>


<p>Imagine you have an <code>Enumerator[Int]</code> and an <code>Iteratee[String, Lis[String]]</code>.<br/>
You can transform an <code>Int</code> into a <code>String</code>, isn&#8217;t it?<br/>
So you should be able to transform the chunks of <code>Int</code> into chunks of <code>String</code> and then inject them into the Iteratee.</p>

<p>Enumeratee is there to save you.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">enumerator</span> <span class="k">=</span> <span class="nc">Enumerator</span><span class="o">(</span><span class="mi">123</span><span class="o">,</span> <span class="mi">345</span><span class="o">,</span> <span class="mi">456</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">iteratee</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="err">…</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">list</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">enumerator</span> <span class="n">through</span> <span class="nc">Enumeratee</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">toString</span> <span class="o">)</span> <span class="n">run</span> <span class="n">iteratee</span>
</span></code></pre></td></tr></table></div></figure>


<p>What happened there?</p>

<p><strong>You just piped <code>Enumerator[Int]</code> through and <code>Enumeratee[Int, String]</code> into <code>Iteratee[String, List[String]]</code></strong></p>

<p>In 2 steps:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">stringEnumerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">enumerator</span> <span class="n">through</span> <span class="nc">Enumeratee</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">toString</span> <span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">list</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">stringEnumerator</span> <span class="n">run</span> <span class="n">iteratee</span>
</span></code></pre></td></tr></table></div></figure>


<p>So, you may understand that <code>Enumeratee</code> is a very useful tool to convert your custom <code>Enumerator</code> to be used with generic <code>Iteratee</code> provided by Play2 API.<br/>
You&#8217;ll see that this is certainly the tool you will use the most while coding with <code>Enumerator</code> / <code>Iteratee</code>.</p>

<h3><code>Enumeratee</code> can be applied to an <code>Enumerator</code> without <code>Iteratee</code></h3>

<p>This is a very useful feature of <code>Enumeratee</code>.
You can transform Enumerate[From] into Enumerator[To] with an Enumeratee[From, To]</p>

<p>Signature of <code>Enumeratee</code> is quite explicit:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">Enumeratee</span><span class="o">[</span><span class="kt">From</span>, <span class="kt">To</span><span class="o">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>So you can use it as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">stringEnumerator</span><span class="k">:</span> <span class="kt">Enumerator</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span> <span class="n">enumerator</span> <span class="n">through</span> <span class="nc">Enumeratee</span><span class="o">.</span><span class="n">map</span><span class="o">(</span> <span class="k">_</span><span class="o">.</span><span class="n">toString</span> <span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>Enumeratee</code> can transform an <code>Iteratee</code></h3>

<p>This is a bit stranger feature because you can transform an <code>Iteratee[To, A]</code> to an <code>Iteratee[From, A]</code> with <code>Enumeratee[From, To]</code></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">stringIteratee</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">String</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="err">…</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">intIteratee</span><span class="k">:</span> <span class="kt">Iteratee</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">]]</span> <span class="k">=</span> <span class="nc">Enumeratee</span><span class="o">.</span><span class="n">map</span><span class="o">[</span><span class="kt">Int</span>, <span class="kt">String</span><span class="o">](</span> <span class="k">_</span><span class="o">.</span><span class="n">toString</span> <span class="o">)</span> <span class="n">transform</span> <span class="n">stringIteratee</span>
</span></code></pre></td></tr></table></div></figure>


<h3><code>Enumeratee</code> can be composed with an <code>Enumeratee</code></h3>

<p>Yes, this is the final very useful feature of <code>Enumeratee</code>.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">enumeratee1</span><span class="k">:</span> <span class="kt">Enumeratee</span><span class="o">[</span><span class="kt">Type1</span>, <span class="kt">Type2</span><span class="o">]</span> <span class="k">=</span> <span class="err">…</span>
</span><span class='line'><span class="k">val</span> <span class="n">enumeratee2</span><span class="k">:</span> <span class="kt">Enumeratee</span><span class="o">[</span><span class="kt">Type2</span>, <span class="kt">Type3</span><span class="o">]</span> <span class="k">=</span> <span class="err">…</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">enumeratee3</span><span class="k">:</span> <span class="kt">Enumeratee</span><span class="o">[</span><span class="kt">Type1</span>, <span class="kt">Type3</span><span class="o">]</span> <span class="k">=</span> <span class="n">enumeratee1</span> <span class="n">compose</span> <span class="n">enumeratee2</span>
</span></code></pre></td></tr></table></div></figure>


<p>So once again, very easy to see that you can create your generic <code>Enumeratees</code> and then compose them into the custom <code>Enumeratee</code> you need for your custom <code>Enumerator</code> / <code>Iteratee</code>.</p>

<hr />

<h2>Conclusion</h2>

<p>Now I hope you have a bit more information and are not lost anymore.<br/>
Next step is to use <code>Iteratee</code> / <code>Enumerator</code> / <code>Enumeratee</code> all together.<br/>
I&#8217;ll write other articles presenting more specific and practical ideas and concepts and samples…<br/>
There are a lot of interesting features that are worth precise explanations.<br/>
Understanding clearly what&#8217;s an <code>Iteratee</code> is important because it helps writing new <code>Iteratees</code> but you can also stay superficial and use the many helpers provided by Play2 Iteratee API.</p>

<p><em>Ok, documentation is not yet as complete as it should but we are working on this!!!</em></p>

<div class="well">
<h3>Anyway, why should I use <code>Iteratee</code> / <code>Enumerator</code> / <code>Enumeratee</code> ?</h3>
<p>I want to tell you that <code>Iteratee</code> / <code>Enumerator</code> / <code>Enumeratee</code> is not a funny tool for people found of functional constructions.  
They are useful in many domains and once you will understand how they work, I can promise you that you will begin to use it more and more.</p>
<p>Modern web applications are not only dynamically generated pages anymore. Now you manipulate flows of data coming from different sources, in different formats, with different availability timing.
You may have to serve huge amount of data to huge number of clients and to work in distributed environments.</p>
<p><code>Iteratee</code> are made for those cases because there are safe, immutable and very good to deal with data flows in realtime.
Let&#8217;s tell the buzzword you can see more & more <i>&#8220;Realtime WebApp&#8221;</i> and <code>Iteratee</code> is associated to that ;)</p>
</div>


<blockquote><h4>Note on weird operators</h4>

<p>You will certainly see lots of those operators in code based on <code>Iteratee</code> / <code>Enumerator</code> / <code>Enumeratee</code> such as <code>&amp;&gt;</code>, <code>|&gt;&gt;</code>, <code>|&gt;&gt;&gt;</code> and the famous fish operator <code>&gt;&lt;&gt;</code>.
Don&#8217;t focus on those operators right now, there are just aliases of real explicit words such as <code>through</code>, <code>apply</code>, <code>applyOn</code> or <code>compose</code>.
I&#8217;ll try to write an article about those operators to demystify them. With practice, some people will find the code with operators clearer and more compact, some people will prefer words.</p></blockquote>

<p>Have fun</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header class="page-header">
    
      <h1 class="entry-title"><a href="/2012/07/14/xmlsoap-ersatz/">Xmlsoap-ersatz</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2012-07-14T00:59:00+02:00" pubdate data-updated="true">Jul 14<span>th</span>, 2012</time>
        
         | <a href="/2012/07/14/xmlsoap-ersatz/#disqus_thread">Comments</a>
        
      </p>
    
  </header>


  <div class="entry-content"><h1>XML/SOAP to/from scala structures with <em>xmlsoap-ersatz</em></h1>

<blockquote><p><a href="https://github.com/mandubian/scala-xmlsoap-ersatz">xmlsoap-ersatz</a> is a toolset to help people serialize/deserialize XML/SOAP with Scala. It doesn&#8217;t try to respect any standard but it allows to interprete and generate any XML format with any standard you require.</p></blockquote>

<p>It was developed to be used with <a href="http://www.playframework.org">Play2/Scala</a> but it can work standalone as it doesn&#8217;t depend on any other library.</p>

<p>xmlsoap-ersatz uses the same design as Play2 Json serialization/deserialization based on <strong>implicit typeclasses</strong>. This mechanism is very clean, robust and generic. Please note that implicits are NOT used as implicit CONVERSIONS which are often tricky and sometimes dangerous!</p>

<p><em>xmlsoap-ersatz is still draft library so if you discover anything wrong, don&#8217;t hesitate to tell it</em></p>

<blockquote><p>xmlsoap-ersatz is an <a href="https://github.com/mandubian/scala-xmlsoap-ersatz">opensource public github</a> so don&#8217;t hesitate to contribute and give ideas :)</p>

<p>Full doc is in <a href="https://github.com/mandubian/scala-xmlsoap-ersatz/wiki">Github Wiki</a></p></blockquote>

<br/>


<h1>XML Scala serialization/deserialization</h1>

<h3>Imagine you want to map this XML to a case class</h3>

<pre><code>val fooXml = &lt;foo&gt;
    &lt;id&gt;1234&lt;/id&gt;
    &lt;name&gt;brutus&lt;/name&gt;
    &lt;age&gt;23&lt;/age&gt;
&lt;/foo&gt;
</code></pre>

<br/>


<h3>You want to map it to:</h3>

<pre><code>case class Foo(id: Long, name: String, age: Option[Int])
Foo(id=1234L, name="brutus", age=Some(23))
</code></pre>

<ul>
<li>case class is a sample but the mechanism also works with any structure in Scala such as tuples</li>
<li><code>age</code> field is <code>Option[Int]</code> meaning it might not appear in the XML (<code>None</code> in this case)</li>
</ul>


<br/>


<h3>So how would you write that with <em>xmlsoap ersatz</em>?</h3>

<pre><code>import play2.tools.xml._
import play2.tools.xml.DefaultImplicits._
[...]
val foo = EXML.fromXML[Foo](fooXml)
assert(foo == Foo(1234L, "brutus", Some(23)))

val fooXml2 = EXML.toXML(foo)
assert(fooXml2 == fooXml)
</code></pre>

<p>As you may imagine, this is not so simple as <code>fromXML</code>/<code>toXML</code> signatures are the following:</p>

<pre><code>object EXML {
    def toXML[T](t: T, base: xml.NodeSeq = xml.NodeSeq.Empty)(implicit w: XMLWriter[T]): xml.NodeSeq
    def fromXML[T](x: xml.NodeSeq)(implicit r: XMLReader[T]): Option[T] 
}
</code></pre>

<p>You can see the <strong>implicit typeclasses <code>XMLReader</code>/<code>XMLWriter</code></strong> which define the mapper to/from XML to your case class.
So in order <code>EXML.fromXML</code>/<code>EXML.toXML</code> to work properly, you should define an implicit XML reader/writer for your specific structure in your scope.
It can be done at once by extending <code>XMLFormatter[T]</code>:</p>

<pre><code>trait XMLFormatter[T] extends XMLReader[T] with XMLWriter[T] {
    def read(x: xml.NodeSeq): Option[T]
    def write(f: T, base: xml.NodeSeq): xml.NodeSeq
}
</code></pre>

<br/>


<h3>Defining the implicit  for your case class</h3>

<pre><code>implicit object FooXMLF extends XMLFormatter[Foo] {
  def read(x: xml.NodeSeq): Option[Foo] = {
    for( 
      id &lt;- EXML.fromXML[Long](x \ "id");
      name &lt;- EXML.fromXML[String](x \ "name");
      age &lt;- EXML.fromXML[Option[Int]](x \ "age")
    ) yield(Foo(id, name, age))
  }

  def write(f: Foo, base: xml.NodeSeq): xml.NodeSeq = {
    &lt;foo&gt;
      &lt;id&gt;{ f.id }&lt;/id&gt;
      &lt;name&gt;{ f.name }&lt;/name&gt;
      { EXML.toXML(f.age, &lt;age/&gt;) }
    &lt;/foo&gt;
  }
}
</code></pre>

<p>You may think this is a bit tedious to write but this is quite easy after a few tries and the most important:</p>

<blockquote><p>This mechanism provides a very precise and simple control on what you want to do.</p></blockquote>

<p>Please note:</p>

<ul>
<li>the <code>write</code> function uses Scala XML literals simply.</li>
<li>the <code>implicit</code> is important: you can declare it once in your scope and that&#8217;s all.</li>
<li><p>the <code>age</code> field in <code>write</code> requires a special syntax:</p>

<p>  <code>{ EXML.toXML(f.age, &lt;age/&gt;) }</code> means: <code>&lt;age/&gt;</code> is used as the base node and will generate following XML:</p>

<ul>
<li>if age is <code>Some(23)</code>: <code>&lt;age&gt;23&lt;/age&gt;</code></li>
<li>if age is <code>None</code>: <code>&lt;age xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:nil="true" /&gt;</code> (<em>standards defines this but you can redefine it as you want</em>)</li>
</ul>
</li>
<li><p>the <code>base</code> field in <code>write</code> function can be used to pass a parent context node to the writer. It is helpful in case you need to add attributes to parent node for ex as in the case of <code>age: Option[Int]</code> field.</p>

<blockquote><p>But don&#8217;t forget that Scala XML nodes are immutable and that you can just copy the nodes you pass to a function.</p></blockquote></li>
<li><p>the <em>for-comprehension</em> is just a shortcut but you could write it using flatMap/map also:</p></li>
</ul>


<p>For ex:</p>

<pre><code>def read(x: xml.NodeSeq): Option[Foo] = {
  EXML.fromXML[Long](x \ "id").flatMap{ id =&gt;
    EXML.fromXML[String](x \ "name").flatMap { name =&gt;
      EXML.fromXML[Int](x \ "age").map{ age =&gt;
        Foo(id, name, age)
      }
    }
  }
}
</code></pre>

<br/>


<h3>The complete code</h3>

<pre><code>import play2.tools.xml._
import play2.tools.xml.DefaultImplicits._

implicit object FooXMLF extends XMLFormatter[Foo] {
  def read(x: xml.NodeSeq): Option[Foo] = {
    for( 
      id &lt;- EXML.fromXML[Long](x \ "id");
      name &lt;- EXML.fromXML[String](x \ "name");
      age &lt;- EXML.fromXML[Option[Int]](x \ "age");
    ) yield(Foo(id, name, age))
  }

  def write(f: Foo, base: xml.NodeSeq): xml.NodeSeq = {
    &lt;foo&gt;
      &lt;id&gt;{ f.id }&lt;/id&gt;
      &lt;name&gt;{ f.name }&lt;/name&gt;
      { EXML.toXML(f.age, &lt;age/&gt;) }
    &lt;/foo&gt;
  }
}

val foo = EXML.fromXML[Foo](fooXml)
assert(foo == Foo(1234L, "albert", 23)

val fooXml = EXML.toXML(foo)
assert(fooXml == fooXml)
</code></pre>

<h1>Integrate with Play2/Scala</h1>

<h2>Add xmlsoap-ersatz to your configuration (ersatz is deployed as a maven repo on github)</h2>

<pre><code>object ApplicationBuild extends Build {

  val appName         = "play2-xmlsoap"
  val appVersion      = "1.0-SNAPSHOT"

  val appDependencies = Seq(
    "play2.tools.xml" %% "xmlsoap-ersatz" % "0.1-SNAPSHOT"
  )  

  val main = PlayProject(appName, appVersion, appDependencies, mainLang = SCALA).settings(
    resolvers += ("mandubian-mvn snapshots" at "https://github.com/mandubian/mandubian-mvn/raw/master/snapshots")
  )
}
</code></pre>

<h2>Use xmlsoap-ersatz in your controller</h2>

<pre><code>package controllers

import play.api._
import play.api.mvc._
import play2.tools.xml._
import play2.tools.xml.DefaultImplicits._

object Application extends Controller {
   case class Foo(id: Long, name: String, age: Option[Int])

   implicit object FooXMLF extends XMLFormatter[Foo] {
      def read(x: xml.NodeSeq): Option[Foo] = {
      for( 
          id &lt;- EXML.fromXML[Long](x \ "id");
          name &lt;- EXML.fromXML[String](x \ "name");
          age &lt;- EXML.fromXML[Option[Int]](x \ "age")
        ) yield(Foo(id, name, age))
      }

      def write(f: Foo, base: xml.NodeSeq): xml.NodeSeq = {
        &lt;foo&gt;
          &lt;id&gt;{ f.id }&lt;/id&gt;
          &lt;name&gt;{ f.name }&lt;/name&gt;
          { EXML.toXML(f.age, &lt;age/&gt;) }
        &lt;/foo&gt;
     }
  }  

  def foo = Action(parse.xml) { request =&gt;
    EXML.fromXML[Foo](request.body).map { foo =&gt;
      Ok(EXML.toXML(foo))
    }.getOrElse{
      BadRequest("Expecting Foo XML data")
    }
  }

}
</code></pre>

<h2>Finally the route in <code>conf/routes</code></h2>

<pre><code>POST    /foo    controllers.Application.foo
</code></pre>

<p>Have fun and don&#8217;t hesitate to contribute</p>
</div>
  
  


    </article>
  
  <ul class="pager">
    
    <li><a href="/blog/archives">Blog Archives</a></li>
    
    <li class="next"><a href="/">Newer &rarr;</a></li>
    
  </ul>
</div>
<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/2013/03/04/datomisca-schema/">Datomisca Delicatessen -  Emulsion of Scala type-safety in Datomic Schema</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/27/shapelaysson/">Shapelaysson = Shapeless + Play-Json </a>
      </li>
    
      <li class="post">
        <a href="/2013/02/22/scala-future-fatal-exception/">Being aware Scala 2.10.0 Futures conceal Fatal exceptions</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/21/play-json-stand-alone/">Playing with Play2 SCALA JSON API Stand-alone</a>
      </li>
    
      <li class="post">
        <a href="/2013/02/18/datomisca-fact-operations/">Datomisca Delicatessen - The Scala Reactive Cherry on the Datomic Cake of Facts</a>
      </li>
    
  </ul>
</section>


<section class="well">
  <ul id="tweets" class="nav" data-user="mandubian" data-count="4" data-replies="false">
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
    <a href="http://twitter.com/mandubian" class="twitter-follow-button" data-show-count="false">Follow @mandubian</a>
  
</section>



<section class="well">
  <ul id="gh_repos" data-user="mandubian" data-count="5" data-skip="true" class="nav">
	<li class="nav-header">On GitHub</li>
    <li class="loading">Status updating&#8230;</li>
  </ul>
  
  <a class="github-follow" href="https://github.com/mandubian">Follow @mandubian</a>
  
</section>










  
</aside>

    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2013 - Pascal Voitot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mandubian';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
