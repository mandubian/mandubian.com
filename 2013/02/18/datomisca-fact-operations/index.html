
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Datomisca Delicatessen - The Scala Reactive Cherry on the Datomic Cake of Facts - Mandubian Blog</title>
  <meta name="author" content="Pascal Voitot">

  
  <meta name="description" content="Datomisca Delicatessen - the Scala Reactive Cherry on the Datomic Cake of Facts
    
    
      
        








  


Feb 18th, &hellip;">
  <meta name="keywords" content="datomic,datomisca,datalog,datom,scala,reactive,asynchronous,non-blocking,future,execution context">

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://www.mandubian.com/2013/02/18/datomisca-fact-operations">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/bootstrap/bootstrap.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/bootstrap/responsive.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/syntax/syntax.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/stylesheets/d3d.css" media="screen, projection" rel="stylesheet" type="text/css">
  <style type="text/css">
    body {
      padding-bottom: 40px;
    }
    h1 {
      margin-bottom: 15px;
    }
    img {
      max-width: 100%;
    }
    .sharing, .meta, .pager {
      margin: 20px 0px 20px 0px;
    }
    .page-footer p {
      text-align: center;
    }

    article {
      margin-bottom: 50px;
      border-top: #DDD solid 20px;
    }
 
  </style>
  <script src="/javascripts/libs/jquery.js"></script>
  <script src="/javascripts/libs/modernizr-2.0.js"></script>
  <script src="/javascripts/libs/bootstrap.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Mandubian Blog" type="application/atom+xml">
  
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-10417377-11']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <nav role="navigation"><div class="navbar">
  <div class="navbar-inner">
    <div class="container">
      <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>

      <a class="brand" href="/">Mandubian Blog</a>

      <div class="nav-collapse">
        <ul class="nav">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>


        <ul class="nav pull-right" data-subscription="rss">
          <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
          
        </ul>

        
          <form class="pull-right navbar-search" action="http://google.com/search" method="get">
            <fieldset role="search">
              <input type="hidden" name="q" value="site:www.mandubian.com" />
              <input class="search-query" type="text" name="q" results="0" placeholder="Search"/>
            </fieldset>
          </form>
        
      </div>
    </div>
  </div>
</div>
</nav>
  <div class="container">
    <div class="row-fluid">
      
<article class="hentry span9" role="article">

  
  <header class="page-header">
    
      <h1 class="entry-title">Datomisca Delicatessen - the Scala Reactive Cherry on the Datomic Cake of Facts</h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-02-18T14:14:00+01:00" pubdate data-updated="true">Feb 18<span>th</span>, 2013</time>
        
         | <a href="#disqus_thread">Comments</a>
        
      </p>
    
  </header>


<div class="entry-content"><p>Let&#8217;s go on unveiling <a href="http://pellucidanalytics.github.com/datomisca/index.html">Datomisca</a> a bit more.</p>

<p>Remember Datomisca is an opensource Scala API (sponsored by <a href="http://www.pellucidanalytics.com">Pellucid</a> and <a href="http://www.zenexity.com">Zenexity</a>) trying to enhance <a href="http://www.datomic.com">Datomic</a> experience for Scala developers.</p>

<p>After evoking <a href="./2013-02-10-datomisca-query.html">queries compiled by Scala macros in previous article</a>, I&#8217;m going to describe how <em>Datomisca</em> allows to create Datomic fact operations in a programmatic way and sending them to Datomic transactor using asynchronous/non-blocking API based on <em>Scala 2.10 Future/ExecutionContext</em>.</p>

<br/>


<h1><a name="datomic-facts">Facts about Datomic</a></h1>

<p>First, let&#8217;s remind a few facts about Datomic:</p>

<blockquote><p>Datomic is a <a href="http://docs.datomic.com/query.html">immutable fact-oriented distributed schema-constrained database</a></p></blockquote>

<p>It means:</p>

<h4>Datomic stores very small units of data called <em>facts</em></h4>

<p>Yes no tables, documents or even columns in Datomic. Everything stored in it is a very small fact.</p>

<br/>


<h4><em>Fact</em> is the atomic unit of data</h4>

<p>Facts are represented by the following tuple called <strong>Datom</strong></p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="nv">datom</span> <span class="nb">= </span><span class="p">[</span><span class="nv">entity</span> <span class="nv">attribute</span> <span class="nv">value</span> <span class="nv">tx</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<ul>
<li><em>entity</em> is an ID and several facts can share the same ID making them facts of the same entity. <strong>Here you can see that an entity is very loose concept in Datomic.</strong></li>
<li><em>attribute</em> is just a namespaced keyword : <code>:person/name</code> which is generally constrained by a typed schema attribute. <strong>The namespace can be used to logically identify an entity like <em>&#8220;person&#8221;</em> by regrouping several attributes in the same namespace.</strong></li>
<li><em>value</em> is the value of this attribute for this entity at this instant</li>
<li><em>tx</em> uniquely identifies the <a href="http://docs.datomic.com/glossary.html#sec-35">transaction</a> in which this fact was inserted. Naturally a transaction is associated with a time.</li>
</ul>


<br/>


<h4><em>Facts</em> are immutable &amp; temporal</h4>

<p>It means that:</p>

<ul>
<li><strong>You can&#8217;t change the past</strong><br/>
Facts are immutable ie you can&#8217;t mutate a fact as other databases generally do: Datomic always creates a new version of the fact with a new value.</li>
<li><strong>Datomic always grows</strong><br/>
If you add more facts, nothing is deleted so the DB grows. Naturally you can truncate a DB, export it and rebuild a new smaller one.</li>
<li><strong>You can foresee a possible future</strong><br/>
From your present, you can temporarily add facts to Datomic without committing them on central storage thus simulating a possible future.</li>
</ul>


<br/>


<h4>Reads/writes are distributed across different components</h4>

<ul>
<li><strong>One Storage service</strong> storing physically the data (Dynamo DB/Infinispan/Postgres/Riak/&#8230;)</li>
<li><strong>Multiple Peers</strong> (generally local to your app instances) behaving like high-speed synchronized cache obfuscating all the local data storage and synchro mechanism and providing the <em>Datalog</em> queries.</li>
<li><strong>One (or several) transactor(s)</strong> centralizing the write mechanism allowing ACID transactions and notifying peers about those evolutions.</li>
</ul>


<p>For more info about architecture, go to <a href="http://docs.datomic.com/architecture.html">this page</a></p>

<br/>


<h4>Immutability means known DB state is always consistent</h4>

<p>You might not be up-to-date with central data storage as Datomic is distributed, you can even lose connection with it but the data you know are always consistent because nothing can be mutated.</p>

<blockquote><p>This immutability concept is one of the most important to understand in Datomic.</p></blockquote>

<br/>


<h4>Schema contrains entity attributes</h4>

<p>Datomic allows to define that a given attribute must :</p>

<ul>
<li>be of <strong>given type</strong> : <code>String</code> or <code>Long</code> or <code>Instant</code> etc…</li>
<li>have <strong>cardinality</strong> (<code>one</code> or <code>many</code>)</li>
<li>be <strong>unique</strong> or not</li>
<li>be <strong>fullsearchable</strong> or not</li>
<li>be <strong>documented</strong></li>
<li>…</li>
</ul>


<p>It means that if you try to insert a fact with an attribute and a value of the wrong type, Datomic will refuse it.</p>

<p>Datomic entity can also reference other entities in Datomic providing relations in Datomic (even if Datomic is not RDBMS). One interesting thing to know is that <strong>all relations in Datomic are bidirectional.</strong></p>

<blockquote><p>I hope you immediately see the link between these typed schema attributes and potential Scala type-safe features…</p></blockquote>

<br/>


<blockquote><p><strong>Author&#8217;s note : Datomic is more about <em>evolution</em> than mutation</strong><br/>
<em>I&#8217;ll let you meditate this sentence linked to theory of evolution ;)</em></p></blockquote>

<br/>


<h1><a name="datomic-ops">Datomic operations</a></h1>

<p>When you want to create a new fact in Datomic, you send a write operation request to the <code>Transactor</code>.</p>

<h2><a name="datomic-ops-basic">Basic operations</a></h2>

<p>There are 2 basic operations:</p>

<h4>Add a Fact</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="nv">entity-id</span> <span class="nv">attribute</span> <span class="nv">value</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Adding a fact for the same entity will <em>NOT update</em> existing fact but create a new fact with same <em>entity-id</em> and a new <em>tx</em>.</p>

<h4>Retract a Fact</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="ss">:db/retract</span> <span class="nv">entity-id</span> <span class="nv">attribute</span> <span class="nv">value</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>Retracting a fact doesn&#8217;t erase any fact but just tells: <em>&#8220;for this entity-id, from now, there is no more this attribute&#8221;</em></p>

<p>You might wonder why providing the value when you want to remove a fact? This is because an attribute can have a <em>MANY</em> cardinality in which case you want to remove just a value from the set of values.</p>

<h2><a name="datomic-ops-entity">Entity operations</a></h2>

<p>In Datomic, you often manipulate groups of facts identifying an entity. An entity has no physical existence in Datomic but is just a group of facts having the same <em>entity-id</em>. Generally, the attributes constituting an entity are logically grouped under the same namespace (<code>:person/name</code>, <code>:person/age</code>…) but this is not mandatory at all.</p>

<p>Datomic provides 2 operations to manipulate entities directly</p>

<h4>Add Entity</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">{</span><span class="ss">:db/id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span> <span class="mi">-1</span><span class="p">]</span>
</span><span class='line'>  <span class="ss">:person/name</span> <span class="s">&quot;Bob&quot;</span>
</span><span class='line'>  <span class="ss">:person/spouse</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span> <span class="mi">-2</span><span class="p">]}</span>
</span></code></pre></td></tr></table></div></figure>


<p>Actually this is equivalent to 2 <em>Add-Fact</em> operations:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">(</span><span class="k">def </span><span class="nv">id</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span> <span class="mi">-1</span><span class="p">])</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="nv">id</span> <span class="ss">:person/name</span> <span class="s">&quot;Bob&quot;</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="nv">id</span> <span class="ss">:person/age</span> <span class="mi">30</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<h4>Retract Entity</h4>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="ss">:db.fn/retractEntity</span> <span class="nv">entity-id</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>




<br/>


<h2><a name="datomic-ops-ident">Special case of identified values</a></h2>

<p>In Datomic, there are special entities built using the special attribute <code>:db/ident</code> of type <code>Keyword</code> which are said to be <em>identified by the given keyword</em>.</p>

<p>There are created as following:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='clojure'><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:person.characters/clever</span><span class="p">]</span>
</span><span class='line'><span class="p">[</span><span class="ss">:db/add</span> <span class="o">#</span><span class="nv">db/id</span><span class="p">[</span><span class="ss">:db.part/user</span><span class="p">]</span> <span class="ss">:db/ident</span> <span class="ss">:person.characters/dumb</span><span class="p">]</span>
</span></code></pre></td></tr></table></div></figure>


<p>If you use <code>:person.characters/clever</code> or <code>:person.characters/dumb</code>, it references directly one of those 2 entities without using their ID.</p>

<p>You can see those identified entities as enumerated values also.</p>

<p>Now that you know how it works in Datomic, let&#8217;s go to <em>Datomisca</em>!</p>

<br/>


<h1><a name="datomisca-ops">Datomisca programmatic operations</a></h1>

<p>Datomisca&#8217;s preferred way to build Fact/Entity operations is programmatic because it provides more flexibility to Scala developers.
Here are the translation of previous operations in Scala:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a Namespace</span>
</span><span class='line'><span class="k">val</span> <span class="n">person</span> <span class="k">=</span> <span class="nc">Namespace</span><span class="o">(</span><span class="s">&quot;person&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a add-fact operation </span>
</span><span class='line'><span class="c1">// It creates the datom (id keyword value _) from</span>
</span><span class='line'><span class="c1">//   - a temporary id (or a final long ID)</span>
</span><span class='line'><span class="c1">//   - the couple `(keyword, value)`</span>
</span><span class='line'><span class="k">val</span> <span class="n">addFact</span> <span class="k">=</span> <span class="nc">Fact</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;Bob&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a retract-fact operation</span>
</span><span class='line'><span class="k">val</span> <span class="n">retractFact</span> <span class="k">=</span> <span class="nc">Fact</span><span class="o">.</span><span class="n">retract</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span><span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span> <span class="o">-&gt;</span> <span class="mi">123L</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates identified values</span>
</span><span class='line'><span class="k">val</span> <span class="n">violent</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">character</span> <span class="o">/</span> <span class="s">&quot;violent&quot;</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">dumb</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span><span class="n">person</span><span class="o">.</span><span class="n">character</span> <span class="o">/</span> <span class="s">&quot;dumb&quot;</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a add-entity operation</span>
</span><span class='line'><span class="k">val</span> <span class="n">addEntity</span> <span class="k">=</span> <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span> <span class="o">-&gt;</span> <span class="s">&quot;Bob&quot;</span><span class="o">,</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span> <span class="o">-&gt;</span> <span class="mi">30L</span><span class="o">,</span>
</span><span class='line'>  <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;characters&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">violent</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">dumb</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates a retract-entity operation from real Long ID of the entity</span>
</span><span class='line'><span class="k">val</span> <span class="n">retractEntity</span> <span class="k">=</span> <span class="nc">Entity</span><span class="o">.</span><span class="n">retract</span><span class="o">(</span><span class="mi">3L</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">addFact</span><span class="o">,</span> <span class="n">retractFact</span><span class="o">,</span> <span class="n">addEntity</span><span class="o">,</span> <span class="n">retractEntity</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>Note that:</p>

<ul>
<li><code>person / "name"</code> creates the keyword <code>:person/name</code> from namespace <code>person</code></li>
<li><code>DId(Partition.USER)</code> generates a temporary Datomic Id in Partition <code>USER</code>. <em>Please note that you can create your own partition too</em>.</li>
<li><code>violent.ref</code> is used to access the keyword reference of the <em>identified entity</em>.</li>
<li><code>ops = Seq(…)</code> represents a collection of operations to be sent to <em>transactor</em>.</li>
</ul>


<br/>


<h1><a name="datomisca-macro-ops">Datomisca Macro operations</a></h1>

<p>Remember the way Datomisca dealt with query by parsing/validating Datalog/Clojure queries at compile-time using Scala macros?</p>

<p>You can do the same in Datomisca with operations:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">id</span> <span class="k">=</span> <span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">weak</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span> <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span><span class="o">,</span> <span class="s">&quot;weak&quot;</span><span class="o">))</span>
</span><span class='line'><span class="k">val</span> <span class="n">dumb</span> <span class="k">=</span> <span class="nc">AddIdent</span><span class="o">(</span> <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span><span class="o">,</span> <span class="s">&quot;dumb&quot;</span><span class="o">))</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">ops</span><span class="o">(</span><span class="s">&quot;&quot;&quot;[</span>
</span><span class='line'><span class="s">   [:db/add #db/id[:db.part/user] :db/ident :region/n]</span>
</span><span class='line'><span class="s">   [:db/add \${DId(Partition.USER)} :db/ident :region/n]</span>
</span><span class='line'><span class="s">   [:db/retract #db/id[:db.part/user] :db/ident :region/n]</span>
</span><span class='line'><span class="s">   [:db/retractEntity 1234]</span>
</span><span class='line'><span class="s">   {</span>
</span><span class='line'><span class="s">      :db/id \${id}</span>
</span><span class='line'><span class="s">      :person/name &quot;toto&quot;</span>
</span><span class='line'><span class="s">      :person/age 30</span>
</span><span class='line'><span class="s">      :person/characters [ \$weak \$dumb ]</span>
</span><span class='line'><span class="s">   }</span>
</span><span class='line'><span class="s">]&quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>It compiles what&#8217;s between <code>"""…"""</code> at compile-time and tells you if there are errors and then it builds Scala corresponding operations.</p>

<p>Ok it&#8217;s cool but if you look better, you&#8217;ll see there is some sugar in this Clojure code:</p>

<ul>
<li><code>\${DId(Partition.USER)}</code></li>
<li><code>\$weak</code></li>
<li><code>\$dumb</code></li>
</ul>


<p><strong>You can use Scala variables and inject them into Clojure operations at compile-time as you do for Scala string interpolation</strong></p>

<blockquote><p>For Datomic queries, the compiled way is really natural but we tend to prefer programmatic way to build operations because it feels to be much more &#8220;scala-like&#8221; after experiencing both methods.</p></blockquote>

<h2><a name="datomisca-parse-ops">Datomisca runtime parsing</a></h2>

<p>There is a last way to create operations by parsing at runtime a String and throwing an exception if the syntax is not valid.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">parseOps</span><span class="o">(</span><span class="s">&quot;&quot;&quot; … &quot;&quot;&quot;</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>It&#8217;s very useful if you have existing Datomic Clojure files (containing schema or bootstrap data) that you want to load into Datomic.</p></blockquote>

<br/>


<h1><a name="datomisca-transact">Datomisca reactive transactions</a></h1>

<p>Last but not the least, let&#8217;s send those operations to Datomic Transactor.</p>

<p>In its Java API, Datomic Connection provides a <code>transact</code> asynchronous API based on a <code>ListenableFuture</code>. This API can be enhanced in Scala because Scala provides much more evolved asynchronous/non-blocking facilities than Java based on Scala 2.10 <code>Future</code>/<code>ExecutionContext</code>.</p>

<p><code>Future</code> allows to implement your asynchronous call using continuation style based on Scala classic <code>map/flatMap</code> methods.
<code>ExecutionContext</code> is a great tool allowing to specify in which pool of threads your asynchronous call will be executed making it non-blocking with respect to your current execution context (or thread).</p>

<blockquote><p>This new feature is really important when you work with reactive API such as Datomisca or Play too so don&#8217;t hesitate to study it further.</p></blockquote>

<p>Let&#8217;s look at code directly to show how it works in <em>Datomisca</em>:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
<span class='line-number'>32</span>
<span class='line-number'>33</span>
<span class='line-number'>34</span>
<span class='line-number'>35</span>
<span class='line-number'>36</span>
<span class='line-number'>37</span>
<span class='line-number'>38</span>
<span class='line-number'>39</span>
<span class='line-number'>40</span>
<span class='line-number'>41</span>
<span class='line-number'>42</span>
<span class='line-number'>43</span>
<span class='line-number'>44</span>
<span class='line-number'>45</span>
<span class='line-number'>46</span>
<span class='line-number'>47</span>
<span class='line-number'>48</span>
<span class='line-number'>49</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">import</span> <span class="nn">datomisca._</span>
</span><span class='line'><span class="k">import</span> <span class="nn">Datomic._</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// don&#39;t forget to bring an ExecutionContext in your scope… </span>
</span><span class='line'><span class="c1">// Here is default Scala ExecutionContext which is a simple pool of threads with one thread per core by default</span>
</span><span class='line'><span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// creates an URI</span>
</span><span class='line'><span class="k">val</span> <span class="n">uri</span> <span class="k">=</span> <span class="s">&quot;datomic:mem://mydatomicdn&quot;</span>
</span><span class='line'><span class="c1">// creates implicit connection</span>
</span><span class='line'><span class="k">implicit</span> <span class="k">val</span> <span class="n">conn</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">connect</span><span class="o">(</span><span class="n">uri</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// a few operations</span>
</span><span class='line'><span class="k">val</span> <span class="n">ops</span> <span class="k">=</span> <span class="nc">Seq</span><span class="o">(</span><span class="n">addFact</span><span class="o">,</span> <span class="n">retractFact</span><span class="o">,</span> <span class="n">addEntity</span><span class="o">,</span> <span class="n">retractEntity</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span><span class="n">ops</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">:</span> <span class="kt">TxReport</span> <span class="o">=&gt;</span>
</span><span class='line'>   <span class="c1">// do something</span>
</span><span class='line'>   <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>   <span class="c1">// return a value of type R (anything you want)</span>
</span><span class='line'>   <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">R</span> <span class="o">=</span> <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>   <span class="n">res</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1">// Another example by building ops directly in the transact call and using flatMap</span>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">id</span><span class="o">)(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">30L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">weak</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">dumb</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;tutu&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">54L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">violent</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">clever</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">))(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;tata&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">23L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">weak</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">clever</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="n">flatMap</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="c1">// do something</span>
</span><span class='line'>  <span class="err">…</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">res</span><span class="k">:</span> <span class="kt">Future</span><span class="o">[</span><span class="kt">R</span><span class="o">]</span> <span class="k">=</span> <span class="err">…</span>
</span><span class='line'>
</span><span class='line'>  <span class="n">res</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>


<blockquote><p>Please note the <code>tx: TxReport</code> which is a structure returned by Datomic transactor containing information about last transaction.</p></blockquote>

<h1><a name="datomisca-resolve">Datomisca resolving Real ID</a></h1>

<p>In all samples, we create operations based on temporary ID built by Datomic in a given partition.</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span></code></pre></td></tr></table></div></figure>


<p>But once you have inserted a fact or an entity into Datomic, you need to resolve the real final ID to use it further because the temporary ID is no more meaningful.</p>

<p>The final ID is resolved from the <code>TxReport</code> send back by Datomic transactor. This <code>TxReport</code> contains a map between temporary ID and final ID. Here is how you can use it in Datomisca:</p>

<figure class='code'><div class='highlight'><table><td class='gutter'><pre class='line-numbers'><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
</pre></td><td class='code'><pre><code class='scala'><span class='line'><span class="k">val</span> <span class="n">id1</span> <span class="k">=</span> <span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span><span class='line'><span class="k">val</span> <span class="n">id2</span> <span class="k">=</span> <span class="nc">DId</span><span class="o">(</span><span class="nc">Partition</span><span class="o">.</span><span class="nc">USER</span><span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="nc">Datomic</span><span class="o">.</span><span class="n">transact</span><span class="o">(</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">id1</span><span class="o">)(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;toto&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">30L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">weak</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">dumb</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">),</span>
</span><span class='line'>  <span class="nc">Entity</span><span class="o">.</span><span class="n">add</span><span class="o">(</span><span class="n">id2</span><span class="o">)(</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;name&quot;</span>      <span class="o">-&gt;</span> <span class="s">&quot;tutu&quot;</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;age&quot;</span>       <span class="o">-&gt;</span> <span class="mi">54L</span><span class="o">,</span>
</span><span class='line'>    <span class="n">person</span> <span class="o">/</span> <span class="s">&quot;character&quot;</span> <span class="o">-&gt;</span> <span class="nc">Set</span><span class="o">(</span><span class="n">violent</span><span class="o">.</span><span class="n">ref</span><span class="o">,</span> <span class="n">clever</span><span class="o">.</span><span class="n">ref</span><span class="o">)</span>
</span><span class='line'>  <span class="o">)</span>
</span><span class='line'><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span> <span class="k">=&gt;</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">finalId1</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">resolve</span><span class="o">(</span><span class="n">id1</span><span class="o">)</span>
</span><span class='line'>  <span class="k">val</span> <span class="n">finalId2</span><span class="k">:</span> <span class="kt">Long</span> <span class="o">=</span> <span class="n">tx</span><span class="o">.</span><span class="n">resolve</span><span class="o">(</span><span class="n">id2</span><span class="o">)</span>
</span><span class='line'>  <span class="c1">// or</span>
</span><span class='line'>  <span class="k">val</span> <span class="nc">List</span><span class="o">(</span><span class="n">finalId1</span><span class="o">,</span> <span class="n">finalId2</span><span class="o">)</span> <span class="k">=</span> <span class="nc">List</span><span class="o">(</span><span class="n">id1</span><span class="o">,</span> <span class="n">id2</span><span class="o">)</span> <span class="n">map</span> <span class="o">{</span> <span class="n">tx</span><span class="o">.</span><span class="n">resolve</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="o">}</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></td></tr></table></div></figure>




<div class="well">That&#8217;s all for now… Next articles about writing programmatic Datomic schema with Datomisca.</div>


<p>Have Promise[Fun]!</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">Pascal Voitot</span></span>

      








  


<time datetime="2013-02-18T14:14:00+01:00" pubdate data-updated="true">Feb 18<span>th</span>, 2013</time>
      

<span class="categories">
  
    <a class='category' href='/blog/categories/asynchronous/'>asynchronous</a>, <a class='category' href='/blog/categories/database/'>database</a>, <a class='category' href='/blog/categories/datalog/'>datalog</a>, <a class='category' href='/blog/categories/datom/'>datom</a>, <a class='category' href='/blog/categories/datomic/'>datomic</a>, <a class='category' href='/blog/categories/datomisca/'>datomisca</a>, <a class='category' href='/blog/categories/execution-context/'>execution context</a>, <a class='category' href='/blog/categories/future/'>future</a>, <a class='category' href='/blog/categories/non-blocking/'>non-blocking</a>, <a class='category' href='/blog/categories/reactive/'>reactive</a>, <a class='category' href='/blog/categories/scala/'>scala</a>
  
</span>


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.mandubian.com/2013/02/18/datomisca-fact-operations/" data-via="mandubian" data-counturl="http://www.mandubian.com/2013/02/18/datomisca-fact-operations/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
</div>

    
    
    <section>
      <h1>Comments</h1>
      <div id="disqus_thread" aria-live="polite"><noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>
    </section>
    
    <ul class="pager">
      
      <li class="previous"><a class="basic-alignment left"
        href="/2013/02/10/datomisca-query/" title="Previous Post:
        Datomisca Delicatessen - Datomic queries coated in a thin layer of Scala">&laquo; Datomisca Delicatessen - Datomic queries coated in a thin layer of Scala</a></li>
      
      <li><a href="/blog/archives">Blog Archives</a></li>
      
      <li class="next"><a class="basic-alignment right" href="/2013/02/21/play-json-stand-alone/"
        title="Next Post: Playing with Play2 SCALA JSON API Stand-alone">Playing with Play2 SCALA JSON API Stand-alone
        &raquo;</a></li>
      
    </ul>
  </footer>
</article>

<aside class="sidebar-nav span3">
  
    <section class="well">
  <ul id="recent_posts" class="nav nav-list">
    <li class="nav-header">Recent Posts</li>
    
      <li class="post">
        <a href="/2013/09/22/play-actor-room/">Play 2.2 Actor Room: websocket (&more) room manager only with actors</a>
      </li>
    
      <li class="post">
        <a href="/2013/08/21/playztream/">Scalaz-Stream Plug'n'Play2 Iteratee/WS + Recursive streaming</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/11/play-autosource-datomisca/">Play AutoSource & Datomisca: Proofing the concept on Datomic, a Schema DB</a>
      </li>
    
      <li class="post">
        <a href="/2013/07/04/json-interpolation-pattern-matching/">Play2 Json Interpolation & Pattern Matching</a>
      </li>
    
      <li class="post">
        <a href="/2013/06/11/play-autosource/">Play AutoSource : 2'30 Kickstart Full REST & CRUD Datasource in Play App (demo'ed with ReactiveMongo + AngularJS)</a>
      </li>
    
  </ul>
</section>


<section class="well">
  <ul id="gh_repos" data-user="mandubian" data-count="5" data-skip="true" class="nav">
	<li class="nav-header">On GitHub</li>
    <li class="loading">Status updating...</li>
  </ul>
  
  <a class="github-follow" href="https://github.com/mandubian">Follow @mandubian</a>
  
</section>



<section class="well">
  <ul id="tweets" class="nav" data-user="mandubian" data-count="4" data-replies="false">
    <li class="loading">Status updating...</li>
  </ul>
  
    <a href="http://twitter.com/mandubian" class="twitter-follow-button" data-show-count="false">Follow @mandubian</a>
  
</section>










  
</aside>


    </div>
  </div>
  <footer role="contentinfo" class="page-footer"><hr>
<p>
  Copyright &copy; 2013 - Pascal Voitot -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'mandubian';
      
        
        // var disqus_developer = 1;
        var disqus_identifier = 'http://www.mandubian.com/2013/02/18/datomisca-fact-operations/';
        var disqus_url = 'http://www.mandubian.com/2013/02/18/datomisca-fact-operations/';
        var disqus_script = 'embed.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>





  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>





</body>
</html>
